2025-11-24 11:33:48,394 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': platform.app.local:5173
2025-11-24 11:33:48,397 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-11-24 11:33:48,397 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 11:33:48,397 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-11-24 11:33:48,397 - app.middleware.tenant_middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: 1
2025-11-24 11:33:48,397 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-11-24 11:33:48,398 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=1, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/auth/refresh/
2025-11-24 11:33:48,405 - app.services.refresh_token_service - WARNING - [VALIDATE-TOKEN] Token no encontrado, revocado o expirado - Cliente 1
2025-11-24 11:33:48,405 - app.core.auth - WARNING - [REFRESH] Token JWT válido, pero inactivo/revocado en BD. Usuario: admin_tech
2025-11-24 11:33:48,406 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/refresh/ 401 12.2ms
2025-11-24 11:34:02,689 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/auth/login/
2025-11-24 11:34:02,689 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/auth/login/ 200 0.4ms
2025-11-24 11:34:02,692 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/login/
2025-11-24 11:34:02,692 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 11:34:02,692 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': platform.app.local:5173
2025-11-24 11:34:02,692 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-11-24 11:34:02,692 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 11:34:02,692 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-11-24 11:34:02,693 - app.middleware.tenant_middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: 1
2025-11-24 11:34:02,693 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-11-24 11:34:02,693 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=1, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/auth/login/
2025-11-24 11:34:02,698 - app.api.v1.endpoints.auth - INFO - Cliente 1 resuelto y validado para login.
2025-11-24 11:34:02,698 - app.core.auth - INFO - [AUTH] Intento de login: username='superadmin', cliente_id_destino=1
2025-11-24 11:34:02,698 - app.core.auth - INFO - [AUTH] SUPERADMIN detectado. Buscando en BD ADMIN (cliente_id=1), accediendo a cliente_id=1
2025-11-24 11:34:02,952 - app.core.auth - INFO - Niveles calculados - Usuario 1: level=5, super_admin=True, type=super_admin
2025-11-24 11:34:02,952 - app.core.auth - INFO - [AUTH] Login exitoso: username='superadmin', usuario_id=1, cliente_origen=1, cliente_destino=1, access_level=5, user_type=super_admin
2025-11-24 11:34:02,953 - app.api.v1.endpoints.auth - INFO - [LOGIN] Superadmin accediendo a cliente_id=1
2025-11-24 11:34:02,953 - app.core.auth - INFO - Niveles calculados - Usuario 1: level=5, super_admin=True, type=super_admin
2025-11-24 11:34:02,957 - app.db.queries - INFO - Inserción exitosa, filas afectadas: -1
2025-11-24 11:34:02,957 - app.services.refresh_token_service - INFO - [STORE-TOKEN] Token insertado exitosamente - Cliente 1, Usuario 1, Tipo: web, Token ID: 11336, Rotación: False
2025-11-24 11:34:02,957 - app.api.v1.endpoints.auth - INFO - [LOGIN-WEB] Token almacenado - ID: 11336
2025-11-24 11:34:02,957 - app.api.v1.endpoints.auth - INFO - Usuario superadmin autenticado exitosamente (WEB) para cliente 1
2025-11-24 11:34:02,958 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/login/ 200 266.6ms
2025-11-24 11:34:02,978 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/menus/getmenu/
2025-11-24 11:34:02,979 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/menus/getmenu/
2025-11-24 11:34:02,979 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/menus/getmenu/ 200 1.4ms
2025-11-24 11:34:02,980 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/menus/getmenu/ 200 1.4ms
2025-11-24 11:34:02,982 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/menus/getmenu/
2025-11-24 11:34:02,982 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 11:34:02,982 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': platform.app.local:5173
2025-11-24 11:34:02,983 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-11-24 11:34:02,983 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 11:34:02,983 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-11-24 11:34:02,983 - app.middleware.tenant_middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: 1
2025-11-24 11:34:02,983 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-11-24 11:34:02,983 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=1, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/menus/getmenu/
2025-11-24 11:34:03,000 - app.api.v1.endpoints.menus - INFO - Solicitud GET /menus/getmenu/ recibida para usuario ID: 1 del cliente 1
2025-11-24 11:34:03,001 - app.services.menu_service - INFO - Obteniendo menú filtrado para usuario_id: 1
2025-11-24 11:34:03,037 - app.services.menu_service - INFO - No se encontraron menús permitidos para el usuario ID: 1.
2025-11-24 11:34:03,038 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/menus/getmenu/ 200 56.3ms
2025-11-24 11:34:03,040 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/menus/getmenu/
2025-11-24 11:34:03,040 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 11:34:03,040 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': platform.app.local:5173
2025-11-24 11:34:03,040 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-11-24 11:34:03,041 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 11:34:03,041 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-11-24 11:34:03,041 - app.middleware.tenant_middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: 1
2025-11-24 11:34:03,041 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-11-24 11:34:03,041 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=1, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/menus/getmenu/
2025-11-24 11:34:03,045 - app.api.v1.endpoints.menus - INFO - Solicitud GET /menus/getmenu/ recibida para usuario ID: 1 del cliente 1
2025-11-24 11:34:03,045 - app.services.menu_service - INFO - Obteniendo menú filtrado para usuario_id: 1
2025-11-24 11:34:03,046 - app.services.menu_service - INFO - No se encontraron menús permitidos para el usuario ID: 1.
2025-11-24 11:34:03,047 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/menus/getmenu/ 200 6.8ms
2025-11-24 11:34:10,545 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /docs
2025-11-24 11:34:10,545 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host '127.0.0.1:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 11:34:10,545 - app.middleware.tenant_middleware - WARNING - [HOST_DETECTION] No se pudo extraer tenant real de origin/referer, usando cliente por defecto (SYSTEM)
2025-11-24 11:34:10,546 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: '127.0.0.1'
2025-11-24 11:34:10,546 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 11:34:10,546 - app.middleware.tenant_middleware - WARNING - [SUBDOMAIN] No se detectó subdominio válido en: '127.0.0.1'. Verifica BASE_DOMAIN='app.local'
2025-11-24 11:34:10,546 - app.middleware.tenant_middleware - WARNING - [TENANT] Sin subdominio en Host: 127.0.0.1:8000. Usando Cliente ID por defecto: 1 (SYSTEM)
2025-11-24 11:34:10,546 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-11-24 11:34:10,546 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=1, db_type=single, bd=bd_hybrid_sistema_central, path=/docs
2025-11-24 11:34:10,547 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /docs 200 2.0ms
2025-11-24 11:34:10,616 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /openapi.json
2025-11-24 11:34:10,617 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host '127.0.0.1:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 11:34:10,617 - app.middleware.tenant_middleware - WARNING - [HOST_DETECTION] No se pudo extraer tenant real de origin/referer, usando cliente por defecto (SYSTEM)
2025-11-24 11:34:10,617 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: '127.0.0.1'
2025-11-24 11:34:10,617 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 11:34:10,617 - app.middleware.tenant_middleware - WARNING - [SUBDOMAIN] No se detectó subdominio válido en: '127.0.0.1'. Verifica BASE_DOMAIN='app.local'
2025-11-24 11:34:10,618 - app.middleware.tenant_middleware - WARNING - [TENANT] Sin subdominio en Host: 127.0.0.1:8000. Usando Cliente ID por defecto: 1 (SYSTEM)
2025-11-24 11:34:10,618 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-11-24 11:34:10,618 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=1, db_type=single, bd=bd_hybrid_sistema_central, path=/openapi.json
2025-11-24 11:34:10,786 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /openapi.json 200 169.7ms
2025-11-24 11:34:18,387 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/login/
2025-11-24 11:34:18,387 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host '127.0.0.1:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 11:34:18,387 - app.middleware.tenant_middleware - WARNING - [HOST_DETECTION] No se pudo extraer tenant real de origin/referer, usando cliente por defecto (SYSTEM)
2025-11-24 11:34:18,388 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: '127.0.0.1'
2025-11-24 11:34:18,388 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 11:34:18,388 - app.middleware.tenant_middleware - WARNING - [SUBDOMAIN] No se detectó subdominio válido en: '127.0.0.1'. Verifica BASE_DOMAIN='app.local'
2025-11-24 11:34:18,388 - app.middleware.tenant_middleware - WARNING - [TENANT] Sin subdominio en Host: 127.0.0.1:8000. Usando Cliente ID por defecto: 1 (SYSTEM)
2025-11-24 11:34:18,388 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-11-24 11:34:18,388 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=1, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/auth/login/
2025-11-24 11:34:18,391 - app.api.v1.endpoints.auth - INFO - Cliente 1 resuelto y validado para login.
2025-11-24 11:34:18,391 - app.core.auth - INFO - [AUTH] Intento de login: username='superadmin', cliente_id_destino=1
2025-11-24 11:34:18,391 - app.core.auth - INFO - [AUTH] SUPERADMIN detectado. Buscando en BD ADMIN (cliente_id=1), accediendo a cliente_id=1
2025-11-24 11:34:18,604 - app.core.auth - INFO - Niveles calculados - Usuario 1: level=5, super_admin=True, type=super_admin
2025-11-24 11:34:18,604 - app.core.auth - INFO - [AUTH] Login exitoso: username='superadmin', usuario_id=1, cliente_origen=1, cliente_destino=1, access_level=5, user_type=super_admin
2025-11-24 11:34:18,604 - app.api.v1.endpoints.auth - INFO - [LOGIN] Superadmin accediendo a cliente_id=1
2025-11-24 11:34:18,605 - app.core.auth - INFO - Niveles calculados - Usuario 1: level=5, super_admin=True, type=super_admin
2025-11-24 11:34:18,606 - app.db.queries - INFO - Inserción exitosa, filas afectadas: -1
2025-11-24 11:34:18,606 - app.services.refresh_token_service - INFO - [STORE-TOKEN] Token insertado exitosamente - Cliente 1, Usuario 1, Tipo: web, Token ID: 11337, Rotación: False
2025-11-24 11:34:18,606 - app.api.v1.endpoints.auth - INFO - [LOGIN-WEB] Token almacenado - ID: 11337
2025-11-24 11:34:18,606 - app.api.v1.endpoints.auth - INFO - Usuario superadmin autenticado exitosamente (WEB) para cliente 1
2025-11-24 11:34:18,607 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/login/ 200 220.1ms
2025-11-24 11:41:44,171 - app.middleware.tenant_middleware - INFO - [TENANT_MW] Inicializado - BASE_DOMAIN=app.local, SYSTEM_ID=1, EXCLUDED_SUBDOMAINS={'assets', 'www', 'static', 'cdn', 'api', 'backend', 'admin'}
2025-11-24 11:45:11,618 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/auth/logout/
2025-11-24 11:45:11,619 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/auth/logout/ 200 1.1ms
2025-11-24 11:45:11,621 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/logout/
2025-11-24 11:45:11,622 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 11:45:11,622 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': platform.app.local:5173
2025-11-24 11:45:11,622 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-11-24 11:45:11,622 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 11:45:11,622 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-11-24 11:45:11,622 - app.middleware.tenant_middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: 1
2025-11-24 11:45:11,622 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-11-24 11:45:11,622 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=1, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/auth/logout/
2025-11-24 11:45:11,664 - app.db.queries - INFO - Actualización exitosa, filas afectadas: -1
2025-11-24 11:45:11,664 - app.services.refresh_token_service - WARNING - [REVOKE-TOKEN] Token no encontrado o ya revocado - Cliente 1, Usuario 1
2025-11-24 11:45:11,664 - app.api.v1.endpoints.auth - WARNING - [LOGOUT-WEB] Token no encontrado en BD - Cliente: 1, Usuario: 1 (superadmin)
2025-11-24 11:45:11,665 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/logout/ 200 43.6ms
2025-11-24 11:45:13,198 - app.middleware.tenant_middleware - INFO - [TENANT_MW] Inicializado - BASE_DOMAIN=app.local, SYSTEM_ID=1, EXCLUDED_SUBDOMAINS={'backend', 'cdn', 'assets', 'www', 'api', 'static', 'admin'}
2025-11-24 11:45:45,527 - app.middleware.tenant_middleware - INFO - [TENANT_MW] Inicializado - BASE_DOMAIN=app.local, SYSTEM_ID=1, EXCLUDED_SUBDOMAINS={'api', 'www', 'backend', 'admin', 'assets', 'static', 'cdn'}
2025-11-24 11:45:54,472 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/auth/login/
2025-11-24 11:45:54,472 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/auth/login/ 200 0.6ms
2025-11-24 11:45:54,474 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/login/
2025-11-24 11:45:54,474 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 11:45:54,475 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': platform.app.local:5173
2025-11-24 11:45:54,475 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-11-24 11:45:54,475 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 11:45:54,475 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-11-24 11:45:54,475 - app.middleware.tenant_middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: 1
2025-11-24 11:45:54,475 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-11-24 11:45:54,475 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=1, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/auth/login/
2025-11-24 11:45:54,514 - app.api.v1.endpoints.auth - INFO - Cliente 1 resuelto y validado para login.
2025-11-24 11:45:54,515 - app.core.auth - INFO - [AUTH] Intento de login: username='superadmin', cliente_id_destino=1
2025-11-24 11:45:54,515 - app.core.auth - INFO - [AUTH] SUPERADMIN detectado. Buscando en BD ADMIN (cliente_id=1), accediendo a cliente_id=1
2025-11-24 11:45:54,766 - app.core.auth - INFO - Niveles calculados - Usuario 1: level=5, super_admin=True, type=super_admin
2025-11-24 11:45:54,766 - app.core.auth - INFO - [AUTH] Login exitoso: username='superadmin', usuario_id=1, cliente_origen=1, cliente_destino=1, access_level=5, user_type=super_admin
2025-11-24 11:45:54,766 - app.api.v1.endpoints.auth - INFO - [LOGIN] Superadmin accediendo a cliente_id=1
2025-11-24 11:45:54,773 - app.core.auth - INFO - Niveles calculados - Usuario 1: level=5, super_admin=True, type=super_admin
2025-11-24 11:45:54,782 - app.db.queries - INFO - Inserción exitosa, filas afectadas: -1
2025-11-24 11:45:54,782 - app.services.refresh_token_service - INFO - [STORE-TOKEN] Token insertado exitosamente - Cliente 1, Usuario 1, Tipo: web, Token ID: 11338, Rotación: False
2025-11-24 11:45:54,783 - app.api.v1.endpoints.auth - INFO - [LOGIN-WEB] Token almacenado - ID: 11338
2025-11-24 11:45:54,783 - app.api.v1.endpoints.auth - INFO - Usuario superadmin autenticado exitosamente (WEB) para cliente 1
2025-11-24 11:45:54,784 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/login/ 200 309.6ms
2025-11-24 11:45:54,806 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/menus/getmenu/
2025-11-24 11:45:54,807 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/menus/getmenu/ 200 0.7ms
2025-11-24 11:45:54,811 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/menus/getmenu/
2025-11-24 11:45:54,811 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/menus/getmenu/ 200 1.0ms
2025-11-24 11:45:54,812 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/menus/getmenu/
2025-11-24 11:45:54,813 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 11:45:54,813 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': platform.app.local:5173
2025-11-24 11:45:54,813 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-11-24 11:45:54,813 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 11:45:54,814 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-11-24 11:45:54,814 - app.middleware.tenant_middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: 1
2025-11-24 11:45:54,814 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-11-24 11:45:54,814 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=1, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/menus/getmenu/
2025-11-24 11:45:54,842 - app.api.v1.endpoints.menus - INFO - Solicitud GET /menus/getmenu/ recibida para usuario ID: 1 del cliente 1
2025-11-24 11:45:54,843 - app.services.menu_service - INFO - Obteniendo menú filtrado para usuario_id: 1
2025-11-24 11:45:54,885 - app.services.menu_service - INFO - No se encontraron menús permitidos para el usuario ID: 1.
2025-11-24 11:45:54,886 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/menus/getmenu/ 200 74.2ms
2025-11-24 11:45:54,888 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/menus/getmenu/
2025-11-24 11:45:54,888 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 11:45:54,889 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': platform.app.local:5173
2025-11-24 11:45:54,889 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-11-24 11:45:54,889 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 11:45:54,889 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-11-24 11:45:54,889 - app.middleware.tenant_middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: 1
2025-11-24 11:45:54,890 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-11-24 11:45:54,890 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=1, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/menus/getmenu/
2025-11-24 11:45:54,898 - app.api.v1.endpoints.menus - INFO - Solicitud GET /menus/getmenu/ recibida para usuario ID: 1 del cliente 1
2025-11-24 11:45:54,898 - app.services.menu_service - INFO - Obteniendo menú filtrado para usuario_id: 1
2025-11-24 11:45:54,899 - app.services.menu_service - INFO - No se encontraron menús permitidos para el usuario ID: 1.
2025-11-24 11:45:54,900 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/menus/getmenu/ 200 12.0ms
2025-11-24 11:46:00,570 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/auth/logout/
2025-11-24 11:46:00,570 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/auth/logout/ 200 0.5ms
2025-11-24 11:46:00,572 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/logout/
2025-11-24 11:46:00,573 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 11:46:00,573 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': techcorp.app.local:5173
2025-11-24 11:46:00,573 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'techcorp.app.local'
2025-11-24 11:46:00,573 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 11:46:00,573 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'techcorp'
2025-11-24 11:46:00,577 - app.middleware.tenant_middleware - INFO - [TENANT] Cliente resuelto: Subdominio='techcorp', Código='TECH003', ID=4
2025-11-24 11:46:00,580 - app.core.encryption - ERROR - Token de encriptación inválido. Posibles causas: clave incorrecta o datos corruptos
2025-11-24 11:46:00,580 - app.core.multi_db - ERROR - [METADATA] Error al desencriptar credenciales para cliente 4: Credencial corrupta o clave de encriptación incorrecta
2025-11-24 11:46:00,581 - app.core.multi_db - WARNING - [METADATA] No se encontró configuración para cliente 4, usando Single-DB como fallback
2025-11-24 11:46:00,581 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-11-24 11:46:00,581 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=4, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/auth/logout/
2025-11-24 11:46:00,588 - app.db.queries - INFO - Actualización exitosa, filas afectadas: 0
2025-11-24 11:46:00,588 - app.services.refresh_token_service - WARNING - [REVOKE-TOKEN] Token no encontrado o ya revocado - Cliente 4, Usuario 2
2025-11-24 11:46:00,589 - app.api.v1.endpoints.auth - WARNING - [LOGOUT-WEB] Token no encontrado en BD - Cliente: 4, Usuario: 2 (admin_tech)
2025-11-24 11:46:00,589 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/logout/ 200 17.0ms
2025-11-24 11:46:08,435 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/auth/login/
2025-11-24 11:46:08,435 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/auth/login/ 200 0.6ms
2025-11-24 11:46:08,437 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/login/
2025-11-24 11:46:08,438 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 11:46:08,438 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': techcorp.app.local:5173
2025-11-24 11:46:08,438 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'techcorp.app.local'
2025-11-24 11:46:08,438 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 11:46:08,438 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'techcorp'
2025-11-24 11:46:08,439 - app.middleware.tenant_middleware - INFO - [TENANT] Cliente resuelto: Subdominio='techcorp', Código='TECH003', ID=4
2025-11-24 11:46:08,439 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-11-24 11:46:08,440 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=4, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/auth/login/
2025-11-24 11:46:08,443 - app.api.v1.endpoints.auth - INFO - Cliente 4 resuelto y validado para login.
2025-11-24 11:46:08,443 - app.core.auth - INFO - [AUTH] Intento de login: username='admin_tech', cliente_id_destino=4
2025-11-24 11:46:08,443 - app.core.auth - INFO - [AUTH] Usuario regular. Buscando en BD del cliente_id=4
2025-11-24 11:46:08,665 - app.core.auth - INFO - Niveles calculados - Usuario 2: level=4, super_admin=False, type=tenant_admin
2025-11-24 11:46:08,665 - app.core.auth - INFO - [AUTH] Login exitoso: username='admin_tech', usuario_id=2, cliente_origen=4, cliente_destino=N/A, access_level=4, user_type=tenant_admin
2025-11-24 11:46:08,670 - app.core.auth - INFO - Niveles calculados - Usuario 2: level=4, super_admin=False, type=tenant_admin
2025-11-24 11:46:08,673 - app.db.queries - INFO - Inserción exitosa, filas afectadas: -1
2025-11-24 11:46:08,674 - app.services.refresh_token_service - INFO - [STORE-TOKEN] Token insertado exitosamente - Cliente 4, Usuario 2, Tipo: web, Token ID: 11339, Rotación: False
2025-11-24 11:46:08,674 - app.api.v1.endpoints.auth - INFO - [LOGIN-WEB] Token almacenado - ID: 11339
2025-11-24 11:46:08,674 - app.api.v1.endpoints.auth - INFO - Usuario admin_tech autenticado exitosamente (WEB) para cliente 4
2025-11-24 11:46:08,675 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/login/ 200 237.6ms
2025-11-24 11:46:08,689 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/menus/getmenu/
2025-11-24 11:46:08,691 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/menus/getmenu/ 200 1.2ms
2025-11-24 11:46:08,692 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/areas/list/
2025-11-24 11:46:08,693 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/menus/getmenu/
2025-11-24 11:46:08,694 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/areas/list/ 200 1.6ms
2025-11-24 11:46:08,694 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/areas/list/
2025-11-24 11:46:08,695 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/menus/getmenu/
2025-11-24 11:46:08,695 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/menus/getmenu/ 200 2.2ms
2025-11-24 11:46:08,696 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 11:46:08,696 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': techcorp.app.local:5173
2025-11-24 11:46:08,696 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'techcorp.app.local'
2025-11-24 11:46:08,696 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 11:46:08,697 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'techcorp'
2025-11-24 11:46:08,698 - app.middleware.tenant_middleware - INFO - [TENANT] Cliente resuelto: Subdominio='techcorp', Código='TECH003', ID=4
2025-11-24 11:46:08,698 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-11-24 11:46:08,698 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=4, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/menus/getmenu/
2025-11-24 11:46:08,699 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/areas/list/ 200 4.8ms
2025-11-24 11:46:08,715 - app.api.v1.endpoints.menus - INFO - Solicitud GET /menus/getmenu/ recibida para usuario ID: 2 del cliente 4
2025-11-24 11:46:08,716 - app.services.menu_service - INFO - Obteniendo menú filtrado para usuario_id: 2
2025-11-24 11:46:08,756 - app.services.menu_service - INFO - No se encontraron menús permitidos para el usuario ID: 2.
2025-11-24 11:46:08,758 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/areas/list/
2025-11-24 11:46:08,758 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/menus/getmenu/ 200 63.3ms
2025-11-24 11:46:08,758 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 11:46:08,759 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': techcorp.app.local:5173
2025-11-24 11:46:08,759 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'techcorp.app.local'
2025-11-24 11:46:08,759 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 11:46:08,759 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'techcorp'
2025-11-24 11:46:08,760 - app.middleware.tenant_middleware - INFO - [TENANT] Cliente resuelto: Subdominio='techcorp', Código='TECH003', ID=4
2025-11-24 11:46:08,760 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-11-24 11:46:08,760 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=4, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/areas/list/
2025-11-24 11:46:08,768 - app.api.v1.endpoints.areas - INFO - Solicitud GET /areas/list/ recibida por usuario 2 del cliente 4 para lista simple
2025-11-24 11:46:08,768 - app.services.area_service - INFO - Obteniendo lista simple de áreas activas para cliente 4
2025-11-24 11:46:08,770 - app.services.area_service - INFO - No se encontraron áreas activas para el cliente 4 en la lista simple
2025-11-24 11:46:08,770 - app.api.v1.endpoints.areas - INFO - Lista simple de áreas recuperada para cliente 4 - Total: 0 áreas activas
2025-11-24 11:46:08,772 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/areas/list/ 200 14.0ms
2025-11-24 11:46:08,772 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/menus/getmenu/
2025-11-24 11:46:08,773 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 11:46:08,773 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': techcorp.app.local:5173
2025-11-24 11:46:08,773 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'techcorp.app.local'
2025-11-24 11:46:08,773 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 11:46:08,773 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'techcorp'
2025-11-24 11:46:08,774 - app.middleware.tenant_middleware - INFO - [TENANT] Cliente resuelto: Subdominio='techcorp', Código='TECH003', ID=4
2025-11-24 11:46:08,775 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-11-24 11:46:08,775 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=4, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/menus/getmenu/
2025-11-24 11:46:08,779 - app.api.v1.endpoints.menus - INFO - Solicitud GET /menus/getmenu/ recibida para usuario ID: 2 del cliente 4
2025-11-24 11:46:08,779 - app.services.menu_service - INFO - Obteniendo menú filtrado para usuario_id: 2
2025-11-24 11:46:08,780 - app.services.menu_service - INFO - No se encontraron menús permitidos para el usuario ID: 2.
2025-11-24 11:46:08,781 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/areas/list/
2025-11-24 11:46:08,781 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 11:46:08,782 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': techcorp.app.local:5173
2025-11-24 11:46:08,782 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'techcorp.app.local'
2025-11-24 11:46:08,782 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 11:46:08,782 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'techcorp'
2025-11-24 11:46:08,783 - app.middleware.tenant_middleware - INFO - [TENANT] Cliente resuelto: Subdominio='techcorp', Código='TECH003', ID=4
2025-11-24 11:46:08,783 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-11-24 11:46:08,784 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=4, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/areas/list/
2025-11-24 11:46:08,791 - app.api.v1.endpoints.areas - INFO - Solicitud GET /areas/list/ recibida por usuario 2 del cliente 4 para lista simple
2025-11-24 11:46:08,791 - app.services.area_service - INFO - Obteniendo lista simple de áreas activas para cliente 4
2025-11-24 11:46:08,792 - app.services.area_service - INFO - No se encontraron áreas activas para el cliente 4 en la lista simple
2025-11-24 11:46:08,792 - app.api.v1.endpoints.areas - INFO - Lista simple de áreas recuperada para cliente 4 - Total: 0 áreas activas
2025-11-24 11:46:08,793 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/menus/getmenu/ 200 20.7ms
2025-11-24 11:46:08,793 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/areas/list/ 200 12.6ms
2025-11-24 11:46:11,428 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/usuarios/
2025-11-24 11:46:11,428 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/usuarios/ 200 0.6ms
2025-11-24 11:46:11,430 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/usuarios/
2025-11-24 11:46:11,431 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 11:46:11,431 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': techcorp.app.local:5173
2025-11-24 11:46:11,431 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'techcorp.app.local'
2025-11-24 11:46:11,431 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 11:46:11,431 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'techcorp'
2025-11-24 11:46:11,433 - app.middleware.tenant_middleware - INFO - [TENANT] Cliente resuelto: Subdominio='techcorp', Código='TECH003', ID=4
2025-11-24 11:46:11,433 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-11-24 11:46:11,433 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=4, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/usuarios/
2025-11-24 11:46:11,441 - app.api.v1.endpoints.usuarios - INFO - Solicitud GET /usuarios/ recibida por usuario 2 del cliente 4 - Paginación: page=1, limit=10, Búsqueda: 'None'
2025-11-24 11:46:11,441 - app.services.usuario_service - INFO - Obteniendo usuarios paginados para cliente 4: page=1, limit=10, search='None'
2025-11-24 11:46:11,453 - app.services.usuario_service - INFO - Obtención paginada de usuarios completada exitosamente
2025-11-24 11:46:11,453 - app.api.v1.endpoints.usuarios - INFO - Lista paginada de usuarios recuperada para cliente 4 - Total: 2, Página: 1
2025-11-24 11:46:11,455 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/roles/all-active/
2025-11-24 11:46:11,455 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/roles/all-active/
2025-11-24 11:46:11,456 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/roles/all-active/ 200 1.2ms
2025-11-24 11:46:11,456 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/roles/all-active/ 200 0.9ms
2025-11-24 11:46:11,456 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/usuarios/ 200 26.2ms
2025-11-24 11:46:11,458 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/roles/all-active/
2025-11-24 11:46:11,459 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 11:46:11,459 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': techcorp.app.local:5173
2025-11-24 11:46:11,460 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'techcorp.app.local'
2025-11-24 11:46:11,460 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 11:46:11,460 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'techcorp'
2025-11-24 11:46:11,461 - app.middleware.tenant_middleware - INFO - [TENANT] Cliente resuelto: Subdominio='techcorp', Código='TECH003', ID=4
2025-11-24 11:46:11,461 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-11-24 11:46:11,461 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=4, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/roles/all-active/
2025-11-24 11:46:11,465 - app.api.v1.endpoints.roles - INFO - Solicitud GET /roles/all-active/ recibida por usuario 2 del cliente 4 para lista simple
2025-11-24 11:46:11,468 - app.services.rol_service - INFO - Se encontraron 0 roles activos para cliente 4
2025-11-24 11:46:11,468 - app.api.v1.endpoints.roles - INFO - Lista simple de roles activos recuperada para cliente 4 - Total: 0
2025-11-24 11:46:11,468 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/usuarios/
2025-11-24 11:46:11,468 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 11:46:11,469 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': techcorp.app.local:5173
2025-11-24 11:46:11,469 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'techcorp.app.local'
2025-11-24 11:46:11,469 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 11:46:11,469 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'techcorp'
2025-11-24 11:46:11,470 - app.middleware.tenant_middleware - INFO - [TENANT] Cliente resuelto: Subdominio='techcorp', Código='TECH003', ID=4
2025-11-24 11:46:11,470 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-11-24 11:46:11,470 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=4, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/usuarios/
2025-11-24 11:46:11,475 - app.api.v1.endpoints.usuarios - INFO - Solicitud GET /usuarios/ recibida por usuario 2 del cliente 4 - Paginación: page=1, limit=10, Búsqueda: 'None'
2025-11-24 11:46:11,475 - app.services.usuario_service - INFO - Obteniendo usuarios paginados para cliente 4: page=1, limit=10, search='None'
2025-11-24 11:46:11,479 - app.services.usuario_service - INFO - Obtención paginada de usuarios completada exitosamente
2025-11-24 11:46:11,479 - app.api.v1.endpoints.usuarios - INFO - Lista paginada de usuarios recuperada para cliente 4 - Total: 2, Página: 1
2025-11-24 11:46:11,480 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/roles/all-active/ 200 21.4ms
2025-11-24 11:46:11,481 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/usuarios/ 200 12.5ms
2025-11-24 11:46:11,482 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/roles/all-active/
2025-11-24 11:46:11,483 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 11:46:11,483 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': techcorp.app.local:5173
2025-11-24 11:46:11,483 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'techcorp.app.local'
2025-11-24 11:46:11,483 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 11:46:11,483 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'techcorp'
2025-11-24 11:46:11,484 - app.middleware.tenant_middleware - INFO - [TENANT] Cliente resuelto: Subdominio='techcorp', Código='TECH003', ID=4
2025-11-24 11:46:11,484 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-11-24 11:46:11,485 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=4, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/roles/all-active/
2025-11-24 11:46:11,490 - app.api.v1.endpoints.roles - INFO - Solicitud GET /roles/all-active/ recibida por usuario 2 del cliente 4 para lista simple
2025-11-24 11:46:11,491 - app.services.rol_service - INFO - Se encontraron 0 roles activos para cliente 4
2025-11-24 11:46:11,491 - app.api.v1.endpoints.roles - INFO - Lista simple de roles activos recuperada para cliente 4 - Total: 0
2025-11-24 11:46:11,492 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/roles/all-active/ 200 9.4ms
2025-11-24 11:46:14,288 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/roles/
2025-11-24 11:46:14,289 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/roles/ 200 1.1ms
2025-11-24 11:46:14,289 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/roles/
2025-11-24 11:46:14,290 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/roles/ 200 0.9ms
2025-11-24 11:46:14,291 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/roles/
2025-11-24 11:46:14,292 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 11:46:14,292 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': techcorp.app.local:5173
2025-11-24 11:46:14,292 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'techcorp.app.local'
2025-11-24 11:46:14,292 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 11:46:14,293 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'techcorp'
2025-11-24 11:46:14,294 - app.middleware.tenant_middleware - INFO - [TENANT] Cliente resuelto: Subdominio='techcorp', Código='TECH003', ID=4
2025-11-24 11:46:14,294 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-11-24 11:46:14,294 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=4, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/roles/
2025-11-24 11:46:14,301 - app.api.v1.endpoints.roles - INFO - Solicitud GET /roles/ recibida por usuario 2 del cliente 4 - Paginación: page=1, limit=10, Búsqueda: 'None'
2025-11-24 11:46:14,302 - app.services.rol_service - INFO - Obteniendo roles paginados para cliente 4: page=1, limit=10, search='None'
2025-11-24 11:46:14,311 - app.services.rol_service - INFO - Obtención paginada de roles para cliente 4 completada exitosamente
2025-11-24 11:46:14,312 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/roles/ 200 20.3ms
2025-11-24 11:46:14,314 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/roles/
2025-11-24 11:46:14,314 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 11:46:14,314 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': techcorp.app.local:5173
2025-11-24 11:46:14,315 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'techcorp.app.local'
2025-11-24 11:46:14,315 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 11:46:14,315 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'techcorp'
2025-11-24 11:46:14,316 - app.middleware.tenant_middleware - INFO - [TENANT] Cliente resuelto: Subdominio='techcorp', Código='TECH003', ID=4
2025-11-24 11:46:14,316 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-11-24 11:46:14,316 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=4, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/roles/
2025-11-24 11:46:14,320 - app.api.v1.endpoints.roles - INFO - Solicitud GET /roles/ recibida por usuario 2 del cliente 4 - Paginación: page=1, limit=10, Búsqueda: 'None'
2025-11-24 11:46:14,321 - app.services.rol_service - INFO - Obteniendo roles paginados para cliente 4: page=1, limit=10, search='None'
2025-11-24 11:46:14,325 - app.services.rol_service - INFO - Obtención paginada de roles para cliente 4 completada exitosamente
2025-11-24 11:46:14,325 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/roles/ 200 11.7ms
2025-11-24 11:46:18,750 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/auth/login/
2025-11-24 11:46:18,751 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/auth/login/ 200 0.7ms
2025-11-24 11:46:18,753 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/login/
2025-11-24 11:46:18,753 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 11:46:18,753 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': acme.app.local:5173
2025-11-24 11:46:18,753 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-11-24 11:46:18,754 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 11:46:18,754 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-11-24 11:46:18,756 - app.middleware.tenant_middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=2
2025-11-24 11:46:18,756 - app.core.encryption - ERROR - Token de encriptación inválido. Posibles causas: clave incorrecta o datos corruptos
2025-11-24 11:46:18,756 - app.core.multi_db - ERROR - [METADATA] Error al desencriptar credenciales para cliente 2: Credencial corrupta o clave de encriptación incorrecta
2025-11-24 11:46:18,757 - app.core.multi_db - WARNING - [METADATA] No se encontró configuración para cliente 2, usando Single-DB como fallback
2025-11-24 11:46:18,757 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-11-24 11:46:18,757 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=2, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/auth/login/
2025-11-24 11:46:18,760 - app.api.v1.endpoints.auth - INFO - Cliente 2 resuelto y validado para login.
2025-11-24 11:46:18,760 - app.core.auth - INFO - [AUTH] Intento de login: username='admin_acme', cliente_id_destino=2
2025-11-24 11:46:18,761 - app.core.auth - INFO - [AUTH] Usuario regular. Buscando en BD del cliente_id=2
2025-11-24 11:46:18,762 - app.core.auth - WARNING - [AUTH] Usuario NO ENCONTRADO: username='admin_acme', cliente_id_buscado=2
2025-11-24 11:46:18,762 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/login/ 401 9.7ms
2025-11-24 11:46:22,755 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/auth/refresh/
2025-11-24 11:46:22,755 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/auth/refresh/ 200 0.5ms
2025-11-24 11:46:22,757 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/refresh/
2025-11-24 11:46:22,758 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 11:46:22,758 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': acme.app.local:5173
2025-11-24 11:46:22,758 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-11-24 11:46:22,758 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 11:46:22,758 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-11-24 11:46:22,760 - app.middleware.tenant_middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=2
2025-11-24 11:46:22,760 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-11-24 11:46:22,760 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=2, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/auth/refresh/
2025-11-24 11:46:22,769 - app.services.refresh_token_service - WARNING - [VALIDATE-TOKEN] Token no encontrado, revocado o expirado - Cliente 2
2025-11-24 11:46:22,770 - app.core.auth - WARNING - [REFRESH] Token JWT válido, pero inactivo/revocado en BD. Usuario: admin_tech
2025-11-24 11:46:22,770 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/refresh/ 401 13.2ms
2025-11-24 11:46:30,658 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/login/
2025-11-24 11:46:30,658 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 11:46:30,659 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': acme.app.local:5173
2025-11-24 11:46:30,659 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-11-24 11:46:30,659 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 11:46:30,659 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-11-24 11:46:30,660 - app.middleware.tenant_middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=2
2025-11-24 11:46:30,660 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-11-24 11:46:30,660 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=2, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/auth/login/
2025-11-24 11:46:30,662 - app.api.v1.endpoints.auth - INFO - Cliente 2 resuelto y validado para login.
2025-11-24 11:46:30,662 - app.core.auth - INFO - [AUTH] Intento de login: username='admin_acme', cliente_id_destino=2
2025-11-24 11:46:30,663 - app.core.auth - INFO - [AUTH] Usuario regular. Buscando en BD del cliente_id=2
2025-11-24 11:46:30,663 - app.core.auth - WARNING - [AUTH] Usuario NO ENCONTRADO: username='admin_acme', cliente_id_buscado=2
2025-11-24 11:46:30,664 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/login/ 401 6.3ms
2025-11-24 11:47:07,668 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/clientes/
2025-11-24 11:47:07,669 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/clientes/ 200 1.1ms
2025-11-24 11:47:07,670 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/clientes/
2025-11-24 11:47:07,671 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/clientes/ 200 0.6ms
2025-11-24 11:47:07,673 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/clientes/
2025-11-24 11:47:07,673 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 11:47:07,674 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': platform.app.local:5173
2025-11-24 11:47:07,674 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-11-24 11:47:07,674 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 11:47:07,674 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-11-24 11:47:07,674 - app.middleware.tenant_middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: 1
2025-11-24 11:47:07,674 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-11-24 11:47:07,675 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=1, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/clientes/
2025-11-24 11:47:07,693 - app.api.v1.endpoints.clientes - INFO - Solicitud GET /clientes/ recibida - skip: 0, limit: 10, solo_activos: True, buscar: None por usuario: superadmin
2025-11-24 11:47:07,693 - app.services.cliente_service - INFO - Listando clientes - skip: 0, limit: 10, solo_activos: True, buscar: None
2025-11-24 11:47:07,698 - app.services.cliente_service - INFO - Listados 6 clientes de 6 totales
2025-11-24 11:47:07,699 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/clientes/ 200 26.2ms
2025-11-24 11:47:07,701 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/clientes/
2025-11-24 11:47:07,701 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 11:47:07,701 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': platform.app.local:5173
2025-11-24 11:47:07,702 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-11-24 11:47:07,702 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 11:47:07,702 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-11-24 11:47:07,702 - app.middleware.tenant_middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: 1
2025-11-24 11:47:07,702 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-11-24 11:47:07,702 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=1, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/clientes/
2025-11-24 11:47:07,705 - app.api.v1.endpoints.clientes - INFO - Solicitud GET /clientes/ recibida - skip: 0, limit: 10, solo_activos: True, buscar: None por usuario: superadmin
2025-11-24 11:47:07,706 - app.services.cliente_service - INFO - Listando clientes - skip: 0, limit: 10, solo_activos: True, buscar: None
2025-11-24 11:47:07,708 - app.services.cliente_service - INFO - Listados 6 clientes de 6 totales
2025-11-24 11:47:07,709 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/clientes/ 200 8.0ms
2025-11-24 11:47:08,423 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/modulos/
2025-11-24 11:47:08,424 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/modulos/ 200 0.8ms
2025-11-24 11:47:08,425 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/modulos/
2025-11-24 11:47:08,426 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/modulos/ 200 0.7ms
2025-11-24 11:47:08,426 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/modulos/
2025-11-24 11:47:08,427 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 11:47:08,427 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': platform.app.local:5173
2025-11-24 11:47:08,427 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-11-24 11:47:08,428 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 11:47:08,428 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-11-24 11:47:08,428 - app.middleware.tenant_middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: 1
2025-11-24 11:47:08,428 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-11-24 11:47:08,428 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=1, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/modulos/
2025-11-24 11:47:08,434 - app.api.v1.endpoints.modulos - INFO - Solicitud GET /modulos/ recibida - skip: 0, limit: 20, solo_activos: True
2025-11-24 11:47:08,434 - app.services.modulo_service - INFO - Obteniendo catálogo de módulos - skip: 0, limit: 20
2025-11-24 11:47:08,438 - app.services.modulo_service - INFO - Contando total de módulos en el sistema
2025-11-24 11:47:08,439 - app.api.v1.endpoints.modulos - INFO - Catálogo de módulos recuperado: 5 módulos de 5 totales
2025-11-24 11:47:08,440 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/modulos/ 200 14.0ms
2025-11-24 11:47:08,442 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/modulos/
2025-11-24 11:47:08,443 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 11:47:08,443 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': platform.app.local:5173
2025-11-24 11:47:08,443 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-11-24 11:47:08,444 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 11:47:08,444 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-11-24 11:47:08,444 - app.middleware.tenant_middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: 1
2025-11-24 11:47:08,444 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-11-24 11:47:08,444 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=1, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/modulos/
2025-11-24 11:47:08,448 - app.api.v1.endpoints.modulos - INFO - Solicitud GET /modulos/ recibida - skip: 0, limit: 20, solo_activos: True
2025-11-24 11:47:08,448 - app.services.modulo_service - INFO - Obteniendo catálogo de módulos - skip: 0, limit: 20
2025-11-24 11:47:08,449 - app.services.modulo_service - INFO - Contando total de módulos en el sistema
2025-11-24 11:47:08,450 - app.api.v1.endpoints.modulos - INFO - Catálogo de módulos recuperado: 5 módulos de 5 totales
2025-11-24 11:47:08,450 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/modulos/ 200 7.8ms
2025-11-24 11:47:21,359 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/clientes/
2025-11-24 11:47:21,359 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 11:47:21,359 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': platform.app.local:5173
2025-11-24 11:47:21,360 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-11-24 11:47:21,360 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 11:47:21,360 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-11-24 11:47:21,360 - app.middleware.tenant_middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: 1
2025-11-24 11:47:21,360 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-11-24 11:47:21,361 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=1, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/clientes/
2025-11-24 11:47:21,365 - app.api.v1.endpoints.clientes - INFO - Solicitud GET /clientes/ recibida - skip: 0, limit: 10, solo_activos: True, buscar: None por usuario: superadmin
2025-11-24 11:47:21,366 - app.services.cliente_service - INFO - Listando clientes - skip: 0, limit: 10, solo_activos: True, buscar: None
2025-11-24 11:47:21,368 - app.services.cliente_service - INFO - Listados 6 clientes de 6 totales
2025-11-24 11:47:21,369 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/clientes/ 200 10.6ms
2025-11-24 11:47:21,372 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/clientes/
2025-11-24 11:47:21,373 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 11:47:21,373 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': platform.app.local:5173
2025-11-24 11:47:21,373 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-11-24 11:47:21,373 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 11:47:21,374 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-11-24 11:47:21,374 - app.middleware.tenant_middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: 1
2025-11-24 11:47:21,374 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-11-24 11:47:21,374 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=1, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/clientes/
2025-11-24 11:47:21,378 - app.api.v1.endpoints.clientes - INFO - Solicitud GET /clientes/ recibida - skip: 0, limit: 10, solo_activos: True, buscar: None por usuario: superadmin
2025-11-24 11:47:21,378 - app.services.cliente_service - INFO - Listando clientes - skip: 0, limit: 10, solo_activos: True, buscar: None
2025-11-24 11:47:21,380 - app.services.cliente_service - INFO - Listados 6 clientes de 6 totales
2025-11-24 11:47:21,381 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/clientes/ 200 8.8ms
2025-11-24 11:47:54,731 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/clientes/2/
2025-11-24 11:47:54,732 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/clientes/2/ 200 0.5ms
2025-11-24 11:47:54,733 - app.main - INFO - [SYSTEM] 127.0.0.1 -> PUT /api/v1/clientes/2/
2025-11-24 11:47:54,734 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 11:47:54,734 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': platform.app.local:5173
2025-11-24 11:47:54,734 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-11-24 11:47:54,735 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 11:47:54,735 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-11-24 11:47:54,735 - app.middleware.tenant_middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: 1
2025-11-24 11:47:54,735 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-11-24 11:47:54,735 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=1, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/clientes/2/
2025-11-24 11:47:54,771 - app.api.v1.endpoints.clientes - INFO - Solicitud PUT /clientes/2 recibida para actualizar por usuario: superadmin
2025-11-24 11:47:54,771 - app.services.cliente_service - INFO - Actualizando cliente ID: 2
2025-11-24 11:47:54,785 - app.db.queries - INFO - Actualización exitosa, filas afectadas: -1
2025-11-24 11:47:54,786 - app.services.cliente_service - INFO - Cliente ID 2 actualizado exitosamente.
2025-11-24 11:47:54,786 - app.api.v1.endpoints.clientes - INFO - Cliente 2 actualizado exitosamente
2025-11-24 11:47:54,787 - app.main - INFO - [SYSTEM] 127.0.0.1 <- PUT /api/v1/clientes/2/ 200 53.1ms
2025-11-24 11:47:54,792 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/clientes/
2025-11-24 11:47:54,792 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 11:47:54,792 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': platform.app.local:5173
2025-11-24 11:47:54,793 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-11-24 11:47:54,793 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 11:47:54,793 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-11-24 11:47:54,793 - app.middleware.tenant_middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: 1
2025-11-24 11:47:54,793 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-11-24 11:47:54,793 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=1, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/clientes/
2025-11-24 11:47:54,798 - app.api.v1.endpoints.clientes - INFO - Solicitud GET /clientes/ recibida - skip: 0, limit: 10, solo_activos: True, buscar: None por usuario: superadmin
2025-11-24 11:47:54,798 - app.services.cliente_service - INFO - Listando clientes - skip: 0, limit: 10, solo_activos: True, buscar: None
2025-11-24 11:47:54,803 - app.services.cliente_service - INFO - Listados 6 clientes de 6 totales
2025-11-24 11:47:54,804 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/clientes/ 200 12.7ms
2025-11-24 11:48:03,392 - app.main - INFO - [SYSTEM] 127.0.0.1 -> PUT /api/v1/clientes/2/
2025-11-24 11:48:03,392 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 11:48:03,393 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': platform.app.local:5173
2025-11-24 11:48:03,393 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-11-24 11:48:03,393 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 11:48:03,393 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-11-24 11:48:03,393 - app.middleware.tenant_middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: 1
2025-11-24 11:48:03,394 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-11-24 11:48:03,394 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=1, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/clientes/2/
2025-11-24 11:48:03,398 - app.api.v1.endpoints.clientes - INFO - Solicitud PUT /clientes/2 recibida para actualizar por usuario: superadmin
2025-11-24 11:48:03,398 - app.services.cliente_service - INFO - Actualizando cliente ID: 2
2025-11-24 11:48:03,406 - app.db.queries - INFO - Actualización exitosa, filas afectadas: -1
2025-11-24 11:48:03,407 - app.services.cliente_service - INFO - Cliente ID 2 actualizado exitosamente.
2025-11-24 11:48:03,407 - app.api.v1.endpoints.clientes - INFO - Cliente 2 actualizado exitosamente
2025-11-24 11:48:03,408 - app.main - INFO - [SYSTEM] 127.0.0.1 <- PUT /api/v1/clientes/2/ 200 15.9ms
2025-11-24 11:48:03,412 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/clientes/
2025-11-24 11:48:03,412 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 11:48:03,413 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': platform.app.local:5173
2025-11-24 11:48:03,413 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-11-24 11:48:03,413 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 11:48:03,413 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-11-24 11:48:03,413 - app.middleware.tenant_middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: 1
2025-11-24 11:48:03,413 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-11-24 11:48:03,413 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=1, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/clientes/
2025-11-24 11:48:03,417 - app.api.v1.endpoints.clientes - INFO - Solicitud GET /clientes/ recibida - skip: 0, limit: 10, solo_activos: True, buscar: None por usuario: superadmin
2025-11-24 11:48:03,417 - app.services.cliente_service - INFO - Listando clientes - skip: 0, limit: 10, solo_activos: True, buscar: None
2025-11-24 11:48:03,419 - app.services.cliente_service - INFO - Listados 6 clientes de 6 totales
2025-11-24 11:48:03,419 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/clientes/ 200 7.6ms
2025-11-24 11:50:43,782 - app.middleware.tenant_middleware - INFO - [TENANT_MW] Inicializado - BASE_DOMAIN=app.local, SYSTEM_ID=1, EXCLUDED_SUBDOMAINS={'backend', 'www', 'admin', 'cdn', 'assets', 'api', 'static'}
2025-11-24 11:50:47,527 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/logout/
2025-11-24 11:50:47,527 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 11:50:47,528 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': platform.app.local:5173
2025-11-24 11:50:47,528 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-11-24 11:50:47,528 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 11:50:47,528 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-11-24 11:50:47,528 - app.middleware.tenant_middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: 1
2025-11-24 11:50:47,528 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-11-24 11:50:47,528 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=1, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/auth/logout/
2025-11-24 11:50:47,579 - app.db.queries - INFO - Actualización exitosa, filas afectadas: 0
2025-11-24 11:50:47,579 - app.services.refresh_token_service - WARNING - [REVOKE-TOKEN] Token no encontrado o ya revocado - Cliente 1, Usuario 1
2025-11-24 11:50:47,580 - app.api.v1.endpoints.auth - WARNING - [LOGOUT-WEB] Token no encontrado en BD - Cliente: 1, Usuario: 1 (superadmin)
2025-11-24 11:50:47,581 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/logout/ 200 53.9ms
2025-11-24 11:50:56,188 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/login/
2025-11-24 11:50:56,189 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 11:50:56,189 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': platform.app.local:5173
2025-11-24 11:50:56,189 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-11-24 11:50:56,189 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 11:50:56,189 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-11-24 11:50:56,190 - app.middleware.tenant_middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: 1
2025-11-24 11:50:56,190 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-11-24 11:50:56,190 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=1, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/auth/login/
2025-11-24 11:50:56,199 - app.api.v1.endpoints.auth - INFO - Cliente 1 resuelto y validado para login.
2025-11-24 11:50:56,199 - app.core.auth - INFO - [AUTH] Intento de login: username='superadmin', cliente_id_destino=1
2025-11-24 11:50:56,199 - app.core.auth - INFO - [AUTH] SUPERADMIN detectado. Buscando en BD ADMIN (cliente_id=1), accediendo a cliente_id=1
2025-11-24 11:50:56,442 - app.core.auth - INFO - Niveles calculados - Usuario 1: level=5, super_admin=True, type=super_admin
2025-11-24 11:50:56,442 - app.core.auth - INFO - [AUTH] Login exitoso: username='superadmin', usuario_id=1, cliente_origen=1, cliente_destino=1, access_level=5, user_type=super_admin
2025-11-24 11:50:56,443 - app.api.v1.endpoints.auth - INFO - [LOGIN] Superadmin accediendo a cliente_id=1
2025-11-24 11:50:56,443 - app.core.auth - INFO - Niveles calculados - Usuario 1: level=5, super_admin=True, type=super_admin
2025-11-24 11:50:56,446 - app.db.queries - INFO - Inserción exitosa, filas afectadas: -1
2025-11-24 11:50:56,447 - app.services.refresh_token_service - INFO - [STORE-TOKEN] Token insertado exitosamente - Cliente 1, Usuario 1, Tipo: web, Token ID: 11340, Rotación: False
2025-11-24 11:50:56,447 - app.api.v1.endpoints.auth - INFO - [LOGIN-WEB] Token almacenado - ID: 11340
2025-11-24 11:50:56,447 - app.api.v1.endpoints.auth - INFO - Usuario superadmin autenticado exitosamente (WEB) para cliente 1
2025-11-24 11:50:56,448 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/login/ 200 259.9ms
2025-11-24 11:50:56,465 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/menus/getmenu/
2025-11-24 11:50:56,466 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 11:50:56,466 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': platform.app.local:5173
2025-11-24 11:50:56,466 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-11-24 11:50:56,467 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 11:50:56,467 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-11-24 11:50:56,467 - app.middleware.tenant_middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: 1
2025-11-24 11:50:56,467 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-11-24 11:50:56,467 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=1, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/menus/getmenu/
2025-11-24 11:50:56,484 - app.api.v1.endpoints.menus - INFO - Solicitud GET /menus/getmenu/ recibida para usuario ID: 1 del cliente 1
2025-11-24 11:50:56,484 - app.services.menu_service - INFO - Obteniendo menú filtrado para usuario_id: 1
2025-11-24 11:50:56,521 - app.services.menu_service - INFO - No se encontraron menús permitidos para el usuario ID: 1.
2025-11-24 11:50:56,522 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/menus/getmenu/ 200 56.8ms
2025-11-24 11:50:56,524 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/menus/getmenu/
2025-11-24 11:50:56,525 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 11:50:56,525 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': platform.app.local:5173
2025-11-24 11:50:56,525 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-11-24 11:50:56,525 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 11:50:56,525 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-11-24 11:50:56,526 - app.middleware.tenant_middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: 1
2025-11-24 11:50:56,526 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-11-24 11:50:56,526 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=1, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/menus/getmenu/
2025-11-24 11:50:56,529 - app.api.v1.endpoints.menus - INFO - Solicitud GET /menus/getmenu/ recibida para usuario ID: 1 del cliente 1
2025-11-24 11:50:56,529 - app.services.menu_service - INFO - Obteniendo menú filtrado para usuario_id: 1
2025-11-24 11:50:56,530 - app.services.menu_service - INFO - No se encontraron menús permitidos para el usuario ID: 1.
2025-11-24 11:50:56,530 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/menus/getmenu/ 200 6.2ms
2025-11-24 11:56:11,867 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/clientes/
2025-11-24 11:56:11,868 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 11:56:11,868 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': platform.app.local:5173
2025-11-24 11:56:11,868 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-11-24 11:56:11,868 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 11:56:11,869 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-11-24 11:56:11,869 - app.middleware.tenant_middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: 1
2025-11-24 11:56:11,869 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-11-24 11:56:11,869 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=1, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/clientes/
2025-11-24 11:56:11,902 - app.api.v1.endpoints.clientes - INFO - Solicitud GET /clientes/ recibida - skip: 0, limit: 10, solo_activos: True, buscar: None por usuario: superadmin
2025-11-24 11:56:11,902 - app.services.cliente_service - INFO - Listando clientes - skip: 0, limit: 10, solo_activos: True, buscar: None
2025-11-24 11:56:11,908 - app.services.cliente_service - INFO - Listados 6 clientes de 6 totales
2025-11-24 11:56:11,909 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/clientes/ 200 42.0ms
2025-11-24 11:56:11,911 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/clientes/
2025-11-24 11:56:11,912 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 11:56:11,912 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': platform.app.local:5173
2025-11-24 11:56:11,912 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-11-24 11:56:11,912 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 11:56:11,912 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-11-24 11:56:11,912 - app.middleware.tenant_middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: 1
2025-11-24 11:56:11,913 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-11-24 11:56:11,913 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=1, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/clientes/
2025-11-24 11:56:11,916 - app.api.v1.endpoints.clientes - INFO - Solicitud GET /clientes/ recibida - skip: 0, limit: 10, solo_activos: True, buscar: None por usuario: superadmin
2025-11-24 11:56:11,916 - app.services.cliente_service - INFO - Listando clientes - skip: 0, limit: 10, solo_activos: True, buscar: None
2025-11-24 11:56:11,918 - app.services.cliente_service - INFO - Listados 6 clientes de 6 totales
2025-11-24 11:56:11,919 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/clientes/ 200 7.6ms
2025-11-24 11:56:12,904 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/clientes/2/
2025-11-24 11:56:12,905 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 11:56:12,905 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': platform.app.local:5173
2025-11-24 11:56:12,905 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-11-24 11:56:12,905 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 11:56:12,905 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-11-24 11:56:12,905 - app.middleware.tenant_middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: 1
2025-11-24 11:56:12,906 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-11-24 11:56:12,906 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=1, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/clientes/2/
2025-11-24 11:56:12,911 - app.api.v1.endpoints.clientes - INFO - Solicitud GET /clientes/2 recibida por usuario: superadmin
2025-11-24 11:56:12,916 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/clientes/2/estadisticas/
2025-11-24 11:56:12,916 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/clientes/2/estadisticas/
2025-11-24 11:56:12,917 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/clientes/2/ 200 13.0ms
2025-11-24 11:56:12,918 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/clientes/2/estadisticas/ 200 1.9ms
2025-11-24 11:56:12,918 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/clientes/2/estadisticas/ 200 1.8ms
2025-11-24 11:56:12,921 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/clientes/2/
2025-11-24 11:56:12,922 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/clientes/2/estadisticas/
2025-11-24 11:56:12,923 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 11:56:12,923 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': platform.app.local:5173
2025-11-24 11:56:12,923 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-11-24 11:56:12,924 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 11:56:12,924 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-11-24 11:56:12,924 - app.middleware.tenant_middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: 1
2025-11-24 11:56:12,924 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-11-24 11:56:12,924 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=1, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/clientes/2/
2025-11-24 11:56:12,925 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 11:56:12,925 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': platform.app.local:5173
2025-11-24 11:56:12,925 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-11-24 11:56:12,925 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 11:56:12,925 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-11-24 11:56:12,926 - app.middleware.tenant_middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: 1
2025-11-24 11:56:12,926 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-11-24 11:56:12,926 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=1, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/clientes/2/estadisticas/
2025-11-24 11:56:12,930 - app.api.v1.endpoints.clientes - INFO - Solicitud GET /clientes/2 recibida por usuario: superadmin
2025-11-24 11:56:12,934 - app.api.v1.endpoints.clientes - INFO - Solicitud GET /clientes/2/estadisticas recibida por usuario: superadmin
2025-11-24 11:56:12,934 - app.services.cliente_service - INFO - Obteniendo estadísticas para cliente ID: 2
2025-11-24 11:56:12,943 - app.services.cliente_service - INFO - Estadísticas obtenidas para cliente 2
2025-11-24 11:56:12,944 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/clientes/2/ 200 22.3ms
2025-11-24 11:56:12,944 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/clientes/2/estadisticas/ 200 21.9ms
2025-11-24 11:56:12,947 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/clientes/2/estadisticas/
2025-11-24 11:56:12,947 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 11:56:12,947 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': platform.app.local:5173
2025-11-24 11:56:12,947 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-11-24 11:56:12,948 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 11:56:12,948 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-11-24 11:56:12,948 - app.middleware.tenant_middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: 1
2025-11-24 11:56:12,948 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-11-24 11:56:12,948 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=1, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/clientes/2/estadisticas/
2025-11-24 11:56:12,953 - app.api.v1.endpoints.clientes - INFO - Solicitud GET /clientes/2/estadisticas recibida por usuario: superadmin
2025-11-24 11:56:12,953 - app.services.cliente_service - INFO - Obteniendo estadísticas para cliente ID: 2
2025-11-24 11:56:12,956 - app.services.cliente_service - INFO - Estadísticas obtenidas para cliente 2
2025-11-24 11:56:12,957 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/clientes/2/estadisticas/ 200 10.0ms
2025-11-24 11:56:14,300 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/conexiones/clientes/2/
2025-11-24 11:56:14,302 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/conexiones/clientes/2/ 200 1.9ms
2025-11-24 11:56:14,302 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/modulos/
2025-11-24 11:56:14,303 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/conexiones/clientes/2/
2025-11-24 11:56:14,304 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/modulos/
2025-11-24 11:56:14,304 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/modulos/ 200 2.1ms
2025-11-24 11:56:14,306 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/conexiones/clientes/2/ 200 2.2ms
2025-11-24 11:56:14,306 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/modulos/ 200 2.1ms
2025-11-24 11:56:14,308 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/conexiones/clientes/2/
2025-11-24 11:56:14,309 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 11:56:14,309 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': platform.app.local:5173
2025-11-24 11:56:14,309 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-11-24 11:56:14,309 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 11:56:14,310 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-11-24 11:56:14,310 - app.middleware.tenant_middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: 1
2025-11-24 11:56:14,310 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-11-24 11:56:14,310 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=1, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/conexiones/clientes/2/
2025-11-24 11:56:14,310 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/modulos/
2025-11-24 11:56:14,314 - app.api.v1.endpoints.conexiones - INFO - Solicitud GET /conexiones/clientes/2 recibida
2025-11-24 11:56:14,315 - app.services.conexion_service - INFO - Obteniendo conexiones para cliente ID: 2
2025-11-24 11:56:14,317 - app.api.v1.endpoints.conexiones - INFO - Conexiones recuperadas para cliente 2: 2 conexiones
2025-11-24 11:56:14,318 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 11:56:14,318 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': platform.app.local:5173
2025-11-24 11:56:14,318 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-11-24 11:56:14,318 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 11:56:14,319 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-11-24 11:56:14,319 - app.middleware.tenant_middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: 1
2025-11-24 11:56:14,319 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-11-24 11:56:14,319 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=1, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/modulos/
2025-11-24 11:56:14,322 - app.api.v1.endpoints.modulos - INFO - Solicitud GET /modulos/ recibida - skip: 0, limit: 100, solo_activos: True
2025-11-24 11:56:14,323 - app.services.modulo_service - INFO - Obteniendo catálogo de módulos - skip: 0, limit: 100
2025-11-24 11:56:14,325 - app.services.modulo_service - INFO - Contando total de módulos en el sistema
2025-11-24 11:56:14,327 - app.api.v1.endpoints.modulos - INFO - Catálogo de módulos recuperado: 5 módulos de 5 totales
2025-11-24 11:56:14,328 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/conexiones/clientes/2/ 200 19.8ms
2025-11-24 11:56:14,328 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/modulos/ 200 17.7ms
2025-11-24 11:56:14,330 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/conexiones/clientes/2/
2025-11-24 11:56:14,330 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 11:56:14,330 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': platform.app.local:5173
2025-11-24 11:56:14,331 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-11-24 11:56:14,331 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 11:56:14,331 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-11-24 11:56:14,331 - app.middleware.tenant_middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: 1
2025-11-24 11:56:14,331 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-11-24 11:56:14,331 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=1, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/conexiones/clientes/2/
2025-11-24 11:56:14,332 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/modulos/
2025-11-24 11:56:14,335 - app.api.v1.endpoints.conexiones - INFO - Solicitud GET /conexiones/clientes/2 recibida
2025-11-24 11:56:14,335 - app.services.conexion_service - INFO - Obteniendo conexiones para cliente ID: 2
2025-11-24 11:56:14,336 - app.api.v1.endpoints.conexiones - INFO - Conexiones recuperadas para cliente 2: 2 conexiones
2025-11-24 11:56:14,337 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 11:56:14,337 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': platform.app.local:5173
2025-11-24 11:56:14,337 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-11-24 11:56:14,338 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 11:56:14,338 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-11-24 11:56:14,338 - app.middleware.tenant_middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: 1
2025-11-24 11:56:14,338 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-11-24 11:56:14,338 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=1, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/modulos/
2025-11-24 11:56:14,342 - app.api.v1.endpoints.modulos - INFO - Solicitud GET /modulos/ recibida - skip: 0, limit: 100, solo_activos: True
2025-11-24 11:56:14,342 - app.services.modulo_service - INFO - Obteniendo catálogo de módulos - skip: 0, limit: 100
2025-11-24 11:56:14,343 - app.services.modulo_service - INFO - Contando total de módulos en el sistema
2025-11-24 11:56:14,344 - app.api.v1.endpoints.modulos - INFO - Catálogo de módulos recuperado: 5 módulos de 5 totales
2025-11-24 11:56:14,345 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/conexiones/clientes/2/ 200 15.2ms
2025-11-24 11:56:14,345 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/modulos/ 200 13.8ms
2025-11-24 11:56:25,774 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/conexiones/test
2025-11-24 11:56:25,775 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/conexiones/test 200 0.7ms
2025-11-24 11:56:25,777 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/conexiones/test
2025-11-24 11:56:25,777 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 11:56:25,777 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': platform.app.local:5173
2025-11-24 11:56:25,777 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-11-24 11:56:25,777 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 11:56:25,778 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-11-24 11:56:25,778 - app.middleware.tenant_middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: 1
2025-11-24 11:56:25,778 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-11-24 11:56:25,778 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=1, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/conexiones/test
2025-11-24 11:56:25,788 - app.api.v1.endpoints.conexiones - INFO - Solicitud POST /conexiones/test recibida para servidor: localhost
2025-11-24 11:56:25,788 - app.services.conexion_service - INFO - Testeando conexión para servidor: localhost
2025-11-24 11:56:25,789 - app.services.conexion_service - INFO - Test de conexión exitoso para localhost
2025-11-24 11:56:25,789 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/conexiones/test 200 12.6ms
2025-11-24 11:56:27,250 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/conexiones/2/
2025-11-24 11:56:27,251 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/conexiones/2/ 200 0.6ms
2025-11-24 11:56:27,252 - app.main - INFO - [SYSTEM] 127.0.0.1 -> PUT /api/v1/conexiones/2/
2025-11-24 11:56:27,252 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 11:56:27,253 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': platform.app.local:5173
2025-11-24 11:56:27,253 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-11-24 11:56:27,253 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 11:56:27,253 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-11-24 11:56:27,253 - app.middleware.tenant_middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: 1
2025-11-24 11:56:27,253 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-11-24 11:56:27,254 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=1, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/conexiones/2/
2025-11-24 11:56:27,262 - app.api.v1.endpoints.conexiones - INFO - Solicitud PUT /conexiones/2 recibida
2025-11-24 11:56:27,263 - app.services.conexion_service - INFO - Actualizando conexión ID: 2
2025-11-24 11:56:27,273 - app.db.queries - INFO - Actualización exitosa, filas afectadas: -1
2025-11-24 11:56:27,273 - app.services.conexion_service - INFO - Conexión ID 2 actualizada exitosamente.
2025-11-24 11:56:27,273 - app.api.v1.endpoints.conexiones - INFO - Conexión 2 actualizada exitosamente
2025-11-24 11:56:27,274 - app.main - INFO - [SYSTEM] 127.0.0.1 <- PUT /api/v1/conexiones/2/ 200 22.1ms
2025-11-24 11:56:27,282 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/conexiones/clientes/2/
2025-11-24 11:56:27,282 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 11:56:27,283 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': platform.app.local:5173
2025-11-24 11:56:27,283 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-11-24 11:56:27,283 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 11:56:27,283 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-11-24 11:56:27,284 - app.middleware.tenant_middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: 1
2025-11-24 11:56:27,284 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-11-24 11:56:27,284 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=1, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/conexiones/clientes/2/
2025-11-24 11:56:27,297 - app.api.v1.endpoints.conexiones - INFO - Solicitud GET /conexiones/clientes/2 recibida
2025-11-24 11:56:27,297 - app.services.conexion_service - INFO - Obteniendo conexiones para cliente ID: 2
2025-11-24 11:56:27,298 - app.api.v1.endpoints.conexiones - INFO - Conexiones recuperadas para cliente 2: 2 conexiones
2025-11-24 11:56:27,299 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/conexiones/clientes/2/ 200 17.4ms
2025-11-24 11:56:41,968 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/auth/refresh/
2025-11-24 11:56:41,968 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/auth/refresh/ 200 0.6ms
2025-11-24 11:56:41,971 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/refresh/
2025-11-24 11:56:41,971 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 11:56:41,971 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': acme.app.local:5173
2025-11-24 11:56:41,972 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-11-24 11:56:41,972 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 11:56:41,972 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-11-24 11:56:41,976 - app.middleware.tenant_middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=2
2025-11-24 11:56:41,981 - app.core.multi_db - INFO - [METADATA] Metadata cargada para cliente 2: multi - bd_cliente_acme
2025-11-24 11:56:41,981 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=multi, bd=bd_cliente_acme, servidor=localhost
2025-11-24 11:56:41,981 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=2, db_type=multi, bd=bd_cliente_acme, path=/api/v1/auth/refresh/
2025-11-24 11:56:41,983 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:56:42,012 - app.services.refresh_token_service - WARNING - [VALIDATE-TOKEN] Token no encontrado, revocado o expirado - Cliente 2
2025-11-24 11:56:42,013 - app.core.auth - WARNING - [REFRESH] Token JWT válido, pero inactivo/revocado en BD. Usuario: superadmin
2025-11-24 11:56:42,013 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/refresh/ 401 42.7ms
2025-11-24 11:56:52,236 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/auth/login/
2025-11-24 11:56:52,237 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/auth/login/ 200 0.6ms
2025-11-24 11:56:52,238 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/login/
2025-11-24 11:56:52,239 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 11:56:52,239 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': acme.app.local:5173
2025-11-24 11:56:52,239 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-11-24 11:56:52,239 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 11:56:52,239 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-11-24 11:56:52,240 - app.middleware.tenant_middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=2
2025-11-24 11:56:52,240 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=multi, bd=bd_cliente_acme, servidor=localhost
2025-11-24 11:56:52,241 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=2, db_type=multi, bd=bd_cliente_acme, path=/api/v1/auth/login/
2025-11-24 11:56:52,244 - app.api.v1.endpoints.auth - INFO - Cliente 2 resuelto y validado para login.
2025-11-24 11:56:52,245 - app.core.auth - INFO - [AUTH] Intento de login: username='admin_acme', cliente_id_destino=2
2025-11-24 11:56:52,245 - app.core.auth - INFO - [AUTH] Usuario regular. Buscando en BD del cliente_id=2
2025-11-24 11:56:52,245 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:56:52,469 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:56:52,472 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:56:52,488 - app.core.auth - INFO - Niveles calculados - Usuario 1: level=4, super_admin=False, type=tenant_admin
2025-11-24 11:56:52,488 - app.core.auth - INFO - [AUTH] Login exitoso: username='admin_acme', usuario_id=1, cliente_origen=2, cliente_destino=N/A, access_level=4, user_type=tenant_admin
2025-11-24 11:56:52,488 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:56:52,492 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:56:52,493 - app.core.auth - INFO - Niveles calculados - Usuario 1: level=4, super_admin=False, type=tenant_admin
2025-11-24 11:56:52,494 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:56:52,497 - app.db.queries - INFO - Inserción exitosa, filas afectadas: -1
2025-11-24 11:56:52,498 - app.services.refresh_token_service - INFO - [STORE-TOKEN] Token insertado exitosamente - Cliente 2, Usuario 1, Tipo: web, Token ID: 1, Rotación: False
2025-11-24 11:56:52,498 - app.api.v1.endpoints.auth - INFO - [LOGIN-WEB] Token almacenado - ID: 1
2025-11-24 11:56:52,498 - app.api.v1.endpoints.auth - INFO - Usuario admin_acme autenticado exitosamente (WEB) para cliente 2
2025-11-24 11:56:52,499 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/login/ 200 260.3ms
2025-11-24 11:56:52,541 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/menus/getmenu/
2025-11-24 11:56:52,541 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/menus/getmenu/ 200 0.8ms
2025-11-24 11:56:52,543 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/menus/getmenu/
2025-11-24 11:56:52,544 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/menus/getmenu/ 200 0.8ms
2025-11-24 11:56:52,544 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/menus/getmenu/
2025-11-24 11:56:52,545 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 11:56:52,545 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': acme.app.local:5173
2025-11-24 11:56:52,546 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-11-24 11:56:52,546 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 11:56:52,546 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-11-24 11:56:52,547 - app.middleware.tenant_middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=2
2025-11-24 11:56:52,547 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=multi, bd=bd_cliente_acme, servidor=localhost
2025-11-24 11:56:52,547 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=2, db_type=multi, bd=bd_cliente_acme, path=/api/v1/menus/getmenu/
2025-11-24 11:56:52,548 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:56:52,550 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:56:52,553 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:56:52,557 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:56:52,563 - app.api.v1.endpoints.menus - INFO - Solicitud GET /menus/getmenu/ recibida para usuario ID: 1 del cliente 2
2025-11-24 11:56:52,564 - app.services.menu_service - INFO - Obteniendo menú filtrado para usuario_id: 1
2025-11-24 11:56:52,564 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:56:52,573 - app.db.queries - ERROR - Error en execute_procedure_params: ('42000', "[42000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Could not find stored procedure 'sp_GetMenuForUser'. (2812) (SQLExecDirectW)")
2025-11-24 11:56:52,574 - app.db.connection - ERROR - Error general en la gestión de conexión: Error en el procedimiento: ('42000', "[42000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Could not find stored procedure 'sp_GetMenuForUser'. (2812) (SQLExecDirectW)")
Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\db\queries.py", line 175, in execute_procedure_params
    cursor.execute(query, tuple(params.values()))
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
pyodbc.ProgrammingError: ('42000', "[42000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Could not find stored procedure 'sp_GetMenuForUser'. (2812) (SQLExecDirectW)")

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\db\connection.py", line 63, in get_db_connection
    yield conn
  File "D:\base_multi_tenant_fastapi\app\db\queries.py", line 187, in execute_procedure_params
    raise DatabaseError(
    ...<2 lines>...
    )
app.core.exceptions.DatabaseError: Error en el procedimiento: ('42000', "[42000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Could not find stored procedure 'sp_GetMenuForUser'. (2812) (SQLExecDirectW)")
2025-11-24 11:56:52,576 - app.services.menu_service - ERROR - Error de BD al obtener menú para usuario 1: Error en el procedimiento: ('42000', "[42000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Could not find stored procedure 'sp_GetMenuForUser'. (2812) (SQLExecDirectW)")
2025-11-24 11:56:52,576 - app.api.v1.endpoints.menus - ERROR - Error de servicio en GET /getmenu/ para usuario 1: Error de base de datos al obtener menú del usuario
2025-11-24 11:56:52,577 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/menus/getmenu/ 500 33.0ms
2025-11-24 11:56:52,580 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/menus/getmenu/
2025-11-24 11:56:52,580 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 11:56:52,581 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': acme.app.local:5173
2025-11-24 11:56:52,581 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-11-24 11:56:52,581 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 11:56:52,581 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-11-24 11:56:52,582 - app.middleware.tenant_middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=2
2025-11-24 11:56:52,583 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=multi, bd=bd_cliente_acme, servidor=localhost
2025-11-24 11:56:52,583 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=2, db_type=multi, bd=bd_cliente_acme, path=/api/v1/menus/getmenu/
2025-11-24 11:56:52,584 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:56:52,585 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:56:52,586 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:56:52,587 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:56:52,587 - app.api.v1.endpoints.menus - INFO - Solicitud GET /menus/getmenu/ recibida para usuario ID: 1 del cliente 2
2025-11-24 11:56:52,587 - app.services.menu_service - INFO - Obteniendo menú filtrado para usuario_id: 1
2025-11-24 11:56:52,588 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:56:52,588 - app.db.queries - ERROR - Error en execute_procedure_params: ('42000', "[42000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Could not find stored procedure 'sp_GetMenuForUser'. (2812) (SQLExecDirectW)")
2025-11-24 11:56:52,589 - app.db.connection - ERROR - Error general en la gestión de conexión: Error en el procedimiento: ('42000', "[42000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Could not find stored procedure 'sp_GetMenuForUser'. (2812) (SQLExecDirectW)")
Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\db\queries.py", line 175, in execute_procedure_params
    cursor.execute(query, tuple(params.values()))
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
pyodbc.ProgrammingError: ('42000', "[42000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Could not find stored procedure 'sp_GetMenuForUser'. (2812) (SQLExecDirectW)")

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\db\connection.py", line 63, in get_db_connection
    yield conn
  File "D:\base_multi_tenant_fastapi\app\db\queries.py", line 187, in execute_procedure_params
    raise DatabaseError(
    ...<2 lines>...
    )
app.core.exceptions.DatabaseError: Error en el procedimiento: ('42000', "[42000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Could not find stored procedure 'sp_GetMenuForUser'. (2812) (SQLExecDirectW)")
2025-11-24 11:56:52,590 - app.services.menu_service - ERROR - Error de BD al obtener menú para usuario 1: Error en el procedimiento: ('42000', "[42000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Could not find stored procedure 'sp_GetMenuForUser'. (2812) (SQLExecDirectW)")
2025-11-24 11:56:52,590 - app.api.v1.endpoints.menus - ERROR - Error de servicio en GET /getmenu/ para usuario 1: Error de base de datos al obtener menú del usuario
2025-11-24 11:56:52,591 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/menus/getmenu/ 500 10.9ms
2025-11-24 11:57:01,378 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/menus/getmenu/
2025-11-24 11:57:01,379 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 11:57:01,379 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': acme.app.local:5173
2025-11-24 11:57:01,379 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-11-24 11:57:01,380 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 11:57:01,380 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-11-24 11:57:01,381 - app.middleware.tenant_middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=2
2025-11-24 11:57:01,382 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=multi, bd=bd_cliente_acme, servidor=localhost
2025-11-24 11:57:01,382 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=2, db_type=multi, bd=bd_cliente_acme, path=/api/v1/menus/getmenu/
2025-11-24 11:57:01,383 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:57:01,384 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:57:01,386 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:57:01,387 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:57:01,388 - app.api.v1.endpoints.menus - INFO - Solicitud GET /menus/getmenu/ recibida para usuario ID: 1 del cliente 2
2025-11-24 11:57:01,388 - app.services.menu_service - INFO - Obteniendo menú filtrado para usuario_id: 1
2025-11-24 11:57:01,388 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:57:01,389 - app.db.queries - ERROR - Error en execute_procedure_params: ('42000', "[42000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Could not find stored procedure 'sp_GetMenuForUser'. (2812) (SQLExecDirectW)")
2025-11-24 11:57:01,390 - app.db.connection - ERROR - Error general en la gestión de conexión: Error en el procedimiento: ('42000', "[42000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Could not find stored procedure 'sp_GetMenuForUser'. (2812) (SQLExecDirectW)")
Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\db\queries.py", line 175, in execute_procedure_params
    cursor.execute(query, tuple(params.values()))
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
pyodbc.ProgrammingError: ('42000', "[42000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Could not find stored procedure 'sp_GetMenuForUser'. (2812) (SQLExecDirectW)")

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\db\connection.py", line 63, in get_db_connection
    yield conn
  File "D:\base_multi_tenant_fastapi\app\db\queries.py", line 187, in execute_procedure_params
    raise DatabaseError(
    ...<2 lines>...
    )
app.core.exceptions.DatabaseError: Error en el procedimiento: ('42000', "[42000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Could not find stored procedure 'sp_GetMenuForUser'. (2812) (SQLExecDirectW)")
2025-11-24 11:57:01,391 - app.services.menu_service - ERROR - Error de BD al obtener menú para usuario 1: Error en el procedimiento: ('42000', "[42000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Could not find stored procedure 'sp_GetMenuForUser'. (2812) (SQLExecDirectW)")
2025-11-24 11:57:01,391 - app.api.v1.endpoints.menus - ERROR - Error de servicio en GET /getmenu/ para usuario 1: Error de base de datos al obtener menú del usuario
2025-11-24 11:57:01,392 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/usuarios/
2025-11-24 11:57:01,393 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/roles/all-active/
2025-11-24 11:57:01,393 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/usuarios/ 200 1.7ms
2025-11-24 11:57:01,394 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/usuarios/
2025-11-24 11:57:01,394 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/roles/all-active/
2025-11-24 11:57:01,394 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/menus/getmenu/ 500 16.1ms
2025-11-24 11:57:01,395 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/roles/all-active/ 200 2.2ms
2025-11-24 11:57:01,396 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/usuarios/ 200 2.2ms
2025-11-24 11:57:01,396 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/roles/all-active/ 200 2.2ms
2025-11-24 11:57:01,399 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/usuarios/
2025-11-24 11:57:01,399 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/menus/getmenu/
2025-11-24 11:57:01,400 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 11:57:01,400 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': acme.app.local:5173
2025-11-24 11:57:01,400 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-11-24 11:57:01,400 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 11:57:01,401 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-11-24 11:57:01,402 - app.middleware.tenant_middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=2
2025-11-24 11:57:01,402 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=multi, bd=bd_cliente_acme, servidor=localhost
2025-11-24 11:57:01,403 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=2, db_type=multi, bd=bd_cliente_acme, path=/api/v1/usuarios/
2025-11-24 11:57:01,403 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 11:57:01,403 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': acme.app.local:5173
2025-11-24 11:57:01,404 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-11-24 11:57:01,404 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 11:57:01,404 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-11-24 11:57:01,406 - app.middleware.tenant_middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=2
2025-11-24 11:57:01,406 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=multi, bd=bd_cliente_acme, servidor=localhost
2025-11-24 11:57:01,406 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=2, db_type=multi, bd=bd_cliente_acme, path=/api/v1/menus/getmenu/
2025-11-24 11:57:01,406 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/roles/all-active/
2025-11-24 11:57:01,407 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:57:01,408 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:57:01,409 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:57:01,410 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:57:01,411 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:57:01,415 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:57:01,416 - app.api.v1.endpoints.usuarios - INFO - Solicitud GET /usuarios/ recibida por usuario 1 del cliente 2 - Paginación: page=1, limit=10, Búsqueda: 'None'
2025-11-24 11:57:01,416 - app.services.usuario_service - INFO - Obteniendo usuarios paginados para cliente 2: page=1, limit=10, search='None'
2025-11-24 11:57:01,416 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:57:01,421 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:57:01,427 - app.services.usuario_service - INFO - Obtención paginada de usuarios completada exitosamente
2025-11-24 11:57:01,427 - app.api.v1.endpoints.usuarios - INFO - Lista paginada de usuarios recuperada para cliente 2 - Total: 3, Página: 1
2025-11-24 11:57:01,428 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:57:01,429 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:57:01,430 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:57:01,431 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:57:01,432 - app.api.v1.endpoints.menus - INFO - Solicitud GET /menus/getmenu/ recibida para usuario ID: 1 del cliente 2
2025-11-24 11:57:01,432 - app.services.menu_service - INFO - Obteniendo menú filtrado para usuario_id: 1
2025-11-24 11:57:01,432 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:57:01,433 - app.db.queries - ERROR - Error en execute_procedure_params: ('42000', "[42000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Could not find stored procedure 'sp_GetMenuForUser'. (2812) (SQLExecDirectW)")
2025-11-24 11:57:01,433 - app.db.connection - ERROR - Error general en la gestión de conexión: Error en el procedimiento: ('42000', "[42000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Could not find stored procedure 'sp_GetMenuForUser'. (2812) (SQLExecDirectW)")
Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\db\queries.py", line 175, in execute_procedure_params
    cursor.execute(query, tuple(params.values()))
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
pyodbc.ProgrammingError: ('42000', "[42000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Could not find stored procedure 'sp_GetMenuForUser'. (2812) (SQLExecDirectW)")

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\db\connection.py", line 63, in get_db_connection
    yield conn
  File "D:\base_multi_tenant_fastapi\app\db\queries.py", line 187, in execute_procedure_params
    raise DatabaseError(
    ...<2 lines>...
    )
app.core.exceptions.DatabaseError: Error en el procedimiento: ('42000', "[42000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Could not find stored procedure 'sp_GetMenuForUser'. (2812) (SQLExecDirectW)")
2025-11-24 11:57:01,434 - app.services.menu_service - ERROR - Error de BD al obtener menú para usuario 1: Error en el procedimiento: ('42000', "[42000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Could not find stored procedure 'sp_GetMenuForUser'. (2812) (SQLExecDirectW)")
2025-11-24 11:57:01,434 - app.api.v1.endpoints.menus - ERROR - Error de servicio en GET /getmenu/ para usuario 1: Error de base de datos al obtener menú del usuario
2025-11-24 11:57:01,435 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 11:57:01,435 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': acme.app.local:5173
2025-11-24 11:57:01,435 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-11-24 11:57:01,435 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 11:57:01,435 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-11-24 11:57:01,436 - app.middleware.tenant_middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=2
2025-11-24 11:57:01,436 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=multi, bd=bd_cliente_acme, servidor=localhost
2025-11-24 11:57:01,437 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=2, db_type=multi, bd=bd_cliente_acme, path=/api/v1/roles/all-active/
2025-11-24 11:57:01,438 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:57:01,439 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:57:01,440 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:57:01,441 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:57:01,441 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:57:01,442 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:57:01,443 - app.api.v1.endpoints.roles - INFO - Solicitud GET /roles/all-active/ recibida por usuario 1 del cliente 2 para lista simple
2025-11-24 11:57:01,443 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:57:01,445 - app.services.rol_service - INFO - Se encontraron 3 roles activos para cliente 2
2025-11-24 11:57:01,445 - app.api.v1.endpoints.roles - INFO - Lista simple de roles activos recuperada para cliente 2 - Total: 3
2025-11-24 11:57:01,446 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/usuarios/ 200 47.0ms
2025-11-24 11:57:01,446 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/menus/getmenu/ 500 47.0ms
2025-11-24 11:57:01,447 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/roles/all-active/ 200 41.0ms
2025-11-24 11:57:01,449 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/usuarios/
2025-11-24 11:57:01,450 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 11:57:01,450 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': acme.app.local:5173
2025-11-24 11:57:01,450 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-11-24 11:57:01,450 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 11:57:01,450 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-11-24 11:57:01,452 - app.middleware.tenant_middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=2
2025-11-24 11:57:01,452 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=multi, bd=bd_cliente_acme, servidor=localhost
2025-11-24 11:57:01,452 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=2, db_type=multi, bd=bd_cliente_acme, path=/api/v1/usuarios/
2025-11-24 11:57:01,453 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:57:01,455 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:57:01,456 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:57:01,456 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:57:01,458 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:57:01,458 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:57:01,459 - app.api.v1.endpoints.usuarios - INFO - Solicitud GET /usuarios/ recibida por usuario 1 del cliente 2 - Paginación: page=1, limit=10, Búsqueda: 'None'
2025-11-24 11:57:01,460 - app.services.usuario_service - INFO - Obteniendo usuarios paginados para cliente 2: page=1, limit=10, search='None'
2025-11-24 11:57:01,460 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:57:01,462 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:57:01,464 - app.services.usuario_service - INFO - Obtención paginada de usuarios completada exitosamente
2025-11-24 11:57:01,464 - app.api.v1.endpoints.usuarios - INFO - Lista paginada de usuarios recuperada para cliente 2 - Total: 3, Página: 1
2025-11-24 11:57:01,464 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/roles/all-active/
2025-11-24 11:57:01,465 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 11:57:01,465 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': acme.app.local:5173
2025-11-24 11:57:01,465 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-11-24 11:57:01,465 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 11:57:01,466 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-11-24 11:57:01,466 - app.middleware.tenant_middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=2
2025-11-24 11:57:01,467 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=multi, bd=bd_cliente_acme, servidor=localhost
2025-11-24 11:57:01,467 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=2, db_type=multi, bd=bd_cliente_acme, path=/api/v1/roles/all-active/
2025-11-24 11:57:01,468 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:57:01,468 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:57:01,470 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:57:01,471 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:57:01,472 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:57:01,473 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:57:01,473 - app.api.v1.endpoints.roles - INFO - Solicitud GET /roles/all-active/ recibida por usuario 1 del cliente 2 para lista simple
2025-11-24 11:57:01,474 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:57:01,474 - app.services.rol_service - INFO - Se encontraron 3 roles activos para cliente 2
2025-11-24 11:57:01,474 - app.api.v1.endpoints.roles - INFO - Lista simple de roles activos recuperada para cliente 2 - Total: 3
2025-11-24 11:57:01,475 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/usuarios/ 200 26.3ms
2025-11-24 11:57:01,476 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/roles/all-active/ 200 11.6ms
2025-11-24 11:57:02,130 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/roles/
2025-11-24 11:57:02,131 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/roles/
2025-11-24 11:57:02,132 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/roles/ 200 1.1ms
2025-11-24 11:57:02,132 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/roles/ 200 1.0ms
2025-11-24 11:57:02,134 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/roles/
2025-11-24 11:57:02,134 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 11:57:02,134 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': acme.app.local:5173
2025-11-24 11:57:02,135 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-11-24 11:57:02,135 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 11:57:02,135 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-11-24 11:57:02,136 - app.middleware.tenant_middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=2
2025-11-24 11:57:02,137 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=multi, bd=bd_cliente_acme, servidor=localhost
2025-11-24 11:57:02,137 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=2, db_type=multi, bd=bd_cliente_acme, path=/api/v1/roles/
2025-11-24 11:57:02,138 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:57:02,140 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:57:02,141 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:57:02,143 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:57:02,144 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:57:02,145 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:57:02,146 - app.api.v1.endpoints.roles - INFO - Solicitud GET /roles/ recibida por usuario 1 del cliente 2 - Paginación: page=1, limit=10, Búsqueda: 'None'
2025-11-24 11:57:02,146 - app.services.rol_service - INFO - Obteniendo roles paginados para cliente 2: page=1, limit=10, search='None'
2025-11-24 11:57:02,146 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:57:02,150 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:57:02,154 - app.services.rol_service - INFO - Obtención paginada de roles para cliente 2 completada exitosamente
2025-11-24 11:57:02,158 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/roles/ N/A 24.6ms
2025-11-24 11:57:02,159 - app.core.exceptions - ERROR - Error no manejado: 3 validation errors:
  {'type': 'value_error', 'loc': ('response', 'roles', 0), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 1, 'nombre': 'Administrador', 'descripcion': 'Administrador con acceso completo', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'ADMIN'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
  {'type': 'value_error', 'loc': ('response', 'roles', 1), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 2, 'nombre': 'Supervisor', 'descripcion': 'Supervisor de departamento', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'SUPERVISOR'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
  {'type': 'value_error', 'loc': ('response', 'roles', 2), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 3, 'nombre': 'Usuario', 'descripcion': 'Usuario estándar', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'USER'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
  + Exception Group Traceback (most recent call last):
  |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 76, in collapse_excgroups
  |     yield
  |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 186, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ~~~~~~~~~~~~~~~~~~~~~~~^^
  |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\anyio\_backends\_asyncio.py", line 815, in __aexit__
  |     raise BaseExceptionGroup(
  |         "unhandled errors in a TaskGroup", self._exceptions
  |     )
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\errors.py", line 165, in __call__
    |     await self.app(scope, receive, _send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    |     with collapse_excgroups():
    |          ~~~~~~~~~~~~~~~~~~^^
    |   File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\app\main.py", line 190, in security_headers
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    |     raise app_exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    |     with collapse_excgroups():
    |          ~~~~~~~~~~~~~~~~~~^^
    |   File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\app\main.py", line 181, in log_requests
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    |     raise app_exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    |     with collapse_excgroups():
    |          ~~~~~~~~~~~~~~~~~~^^
    |   File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\app\main.py", line 158, in cors_middleware
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    |     raise app_exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    |     with collapse_excgroups():
    |          ~~~~~~~~~~~~~~~~~~^^
    |   File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\app\middleware\tenant_middleware.py", line 293, in dispatch
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    |     raise app_exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\exceptions.py", line 62, in __call__
    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 715, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 735, in app
    |     await route.handle(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 288, in handle
    |     await self.app(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 76, in app
    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 73, in app
    |     response = await f(request)
    |                ^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\fastapi\routing.py", line 327, in app
    |     content = await serialize_response(
    |               ^^^^^^^^^^^^^^^^^^^^^^^^^
    |     ...<9 lines>...
    |     )
    |     ^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\fastapi\routing.py", line 176, in serialize_response
    |     raise ResponseValidationError(
    |         errors=_normalize_errors(errors), body=response_content
    |     )
    | fastapi.exceptions.ResponseValidationError: 3 validation errors:
    |   {'type': 'value_error', 'loc': ('response', 'roles', 0), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 1, 'nombre': 'Administrador', 'descripcion': 'Administrador con acceso completo', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'ADMIN'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
    |   {'type': 'value_error', 'loc': ('response', 'roles', 1), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 2, 'nombre': 'Supervisor', 'descripcion': 'Supervisor de departamento', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'SUPERVISOR'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
    |   {'type': 'value_error', 'loc': ('response', 'roles', 2), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 3, 'nombre': 'Usuario', 'descripcion': 'Usuario estándar', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'USER'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
    | 
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\errors.py", line 165, in __call__
    await self.app(scope, receive, _send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    with collapse_excgroups():
         ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\main.py", line 190, in security_headers
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    raise app_exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    with collapse_excgroups():
         ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\main.py", line 181, in log_requests
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    raise app_exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    with collapse_excgroups():
         ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\main.py", line 158, in cors_middleware
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    raise app_exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    with collapse_excgroups():
         ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\middleware\tenant_middleware.py", line 293, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    raise app_exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 715, in __call__
    await self.middleware_stack(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 735, in app
    await route.handle(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 288, in handle
    await self.app(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 76, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 73, in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\fastapi\routing.py", line 327, in app
    content = await serialize_response(
              ^^^^^^^^^^^^^^^^^^^^^^^^^
    ...<9 lines>...
    )
    ^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\fastapi\routing.py", line 176, in serialize_response
    raise ResponseValidationError(
        errors=_normalize_errors(errors), body=response_content
    )
fastapi.exceptions.ResponseValidationError: 3 validation errors:
  {'type': 'value_error', 'loc': ('response', 'roles', 0), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 1, 'nombre': 'Administrador', 'descripcion': 'Administrador con acceso completo', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'ADMIN'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
  {'type': 'value_error', 'loc': ('response', 'roles', 1), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 2, 'nombre': 'Supervisor', 'descripcion': 'Supervisor de departamento', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'SUPERVISOR'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
  {'type': 'value_error', 'loc': ('response', 'roles', 2), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 3, 'nombre': 'Usuario', 'descripcion': 'Usuario estándar', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'USER'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}

2025-11-24 11:57:02,317 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/roles/
2025-11-24 11:57:02,317 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 11:57:02,317 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': acme.app.local:5173
2025-11-24 11:57:02,317 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-11-24 11:57:02,318 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 11:57:02,318 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-11-24 11:57:02,319 - app.middleware.tenant_middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=2
2025-11-24 11:57:02,319 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=multi, bd=bd_cliente_acme, servidor=localhost
2025-11-24 11:57:02,319 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=2, db_type=multi, bd=bd_cliente_acme, path=/api/v1/roles/
2025-11-24 11:57:02,320 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:57:02,321 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:57:02,323 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:57:02,324 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:57:02,325 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:57:02,325 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:57:02,326 - app.api.v1.endpoints.roles - INFO - Solicitud GET /roles/ recibida por usuario 1 del cliente 2 - Paginación: page=1, limit=10, Búsqueda: 'None'
2025-11-24 11:57:02,326 - app.services.rol_service - INFO - Obteniendo roles paginados para cliente 2: page=1, limit=10, search='None'
2025-11-24 11:57:02,327 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:57:02,328 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:57:02,330 - app.services.rol_service - INFO - Obtención paginada de roles para cliente 2 completada exitosamente
2025-11-24 11:57:02,330 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/roles/ N/A 13.6ms
2025-11-24 11:57:02,331 - app.core.exceptions - ERROR - Error no manejado: 3 validation errors:
  {'type': 'value_error', 'loc': ('response', 'roles', 0), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 1, 'nombre': 'Administrador', 'descripcion': 'Administrador con acceso completo', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'ADMIN'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
  {'type': 'value_error', 'loc': ('response', 'roles', 1), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 2, 'nombre': 'Supervisor', 'descripcion': 'Supervisor de departamento', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'SUPERVISOR'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
  {'type': 'value_error', 'loc': ('response', 'roles', 2), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 3, 'nombre': 'Usuario', 'descripcion': 'Usuario estándar', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'USER'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
  + Exception Group Traceback (most recent call last):
  |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 76, in collapse_excgroups
  |     yield
  |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 186, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ~~~~~~~~~~~~~~~~~~~~~~~^^
  |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\anyio\_backends\_asyncio.py", line 815, in __aexit__
  |     raise BaseExceptionGroup(
  |         "unhandled errors in a TaskGroup", self._exceptions
  |     )
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\errors.py", line 165, in __call__
    |     await self.app(scope, receive, _send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    |     with collapse_excgroups():
    |          ~~~~~~~~~~~~~~~~~~^^
    |   File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\app\main.py", line 190, in security_headers
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    |     raise app_exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    |     with collapse_excgroups():
    |          ~~~~~~~~~~~~~~~~~~^^
    |   File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\app\main.py", line 181, in log_requests
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    |     raise app_exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    |     with collapse_excgroups():
    |          ~~~~~~~~~~~~~~~~~~^^
    |   File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\app\main.py", line 158, in cors_middleware
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    |     raise app_exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    |     with collapse_excgroups():
    |          ~~~~~~~~~~~~~~~~~~^^
    |   File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\app\middleware\tenant_middleware.py", line 293, in dispatch
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    |     raise app_exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\exceptions.py", line 62, in __call__
    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 715, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 735, in app
    |     await route.handle(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 288, in handle
    |     await self.app(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 76, in app
    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 73, in app
    |     response = await f(request)
    |                ^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\fastapi\routing.py", line 327, in app
    |     content = await serialize_response(
    |               ^^^^^^^^^^^^^^^^^^^^^^^^^
    |     ...<9 lines>...
    |     )
    |     ^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\fastapi\routing.py", line 176, in serialize_response
    |     raise ResponseValidationError(
    |         errors=_normalize_errors(errors), body=response_content
    |     )
    | fastapi.exceptions.ResponseValidationError: 3 validation errors:
    |   {'type': 'value_error', 'loc': ('response', 'roles', 0), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 1, 'nombre': 'Administrador', 'descripcion': 'Administrador con acceso completo', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'ADMIN'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
    |   {'type': 'value_error', 'loc': ('response', 'roles', 1), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 2, 'nombre': 'Supervisor', 'descripcion': 'Supervisor de departamento', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'SUPERVISOR'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
    |   {'type': 'value_error', 'loc': ('response', 'roles', 2), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 3, 'nombre': 'Usuario', 'descripcion': 'Usuario estándar', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'USER'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
    | 
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\errors.py", line 165, in __call__
    await self.app(scope, receive, _send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    with collapse_excgroups():
         ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\main.py", line 190, in security_headers
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    raise app_exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    with collapse_excgroups():
         ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\main.py", line 181, in log_requests
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    raise app_exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    with collapse_excgroups():
         ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\main.py", line 158, in cors_middleware
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    raise app_exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    with collapse_excgroups():
         ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\middleware\tenant_middleware.py", line 293, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    raise app_exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 715, in __call__
    await self.middleware_stack(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 735, in app
    await route.handle(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 288, in handle
    await self.app(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 76, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 73, in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\fastapi\routing.py", line 327, in app
    content = await serialize_response(
              ^^^^^^^^^^^^^^^^^^^^^^^^^
    ...<9 lines>...
    )
    ^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\fastapi\routing.py", line 176, in serialize_response
    raise ResponseValidationError(
        errors=_normalize_errors(errors), body=response_content
    )
fastapi.exceptions.ResponseValidationError: 3 validation errors:
  {'type': 'value_error', 'loc': ('response', 'roles', 0), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 1, 'nombre': 'Administrador', 'descripcion': 'Administrador con acceso completo', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'ADMIN'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
  {'type': 'value_error', 'loc': ('response', 'roles', 1), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 2, 'nombre': 'Supervisor', 'descripcion': 'Supervisor de departamento', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'SUPERVISOR'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
  {'type': 'value_error', 'loc': ('response', 'roles', 2), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 3, 'nombre': 'Usuario', 'descripcion': 'Usuario estándar', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'USER'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}

2025-11-24 11:57:07,088 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/areas/
2025-11-24 11:57:07,088 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/areas/
2025-11-24 11:57:07,090 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/areas/ 200 2.4ms
2025-11-24 11:57:07,090 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/areas/ 200 2.1ms
2025-11-24 11:57:07,093 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/areas/
2025-11-24 11:57:07,093 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 11:57:07,094 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': acme.app.local:5173
2025-11-24 11:57:07,094 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-11-24 11:57:07,094 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 11:57:07,094 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-11-24 11:57:07,095 - app.middleware.tenant_middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=2
2025-11-24 11:57:07,096 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=multi, bd=bd_cliente_acme, servidor=localhost
2025-11-24 11:57:07,096 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=2, db_type=multi, bd=bd_cliente_acme, path=/api/v1/areas/
2025-11-24 11:57:07,097 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:57:07,098 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:57:07,100 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:57:07,101 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:57:07,102 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:57:07,102 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:57:07,103 - app.api.v1.endpoints.areas - INFO - Solicitud GET /areas/ recibida por usuario 1 del cliente 2 - Paginación: skip=0, limit=10, Búsqueda: 'None'
2025-11-24 11:57:07,103 - app.services.area_service - INFO - Obteniendo áreas paginadas para cliente 2: skip=0, limit=10, search='None'
2025-11-24 11:57:07,103 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:57:07,109 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:57:07,113 - app.services.area_service - INFO - Paginación completada para cliente 2: 2 áreas de 2 totales
2025-11-24 11:57:07,114 - app.api.v1.endpoints.areas - INFO - Lista paginada de áreas recuperada para cliente 2 - Total: 2, Página: 1
2025-11-24 11:57:07,114 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/areas/ 200 21.1ms
2025-11-24 11:57:07,116 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/areas/
2025-11-24 11:57:07,116 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 11:57:07,116 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': acme.app.local:5173
2025-11-24 11:57:07,116 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-11-24 11:57:07,116 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 11:57:07,116 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-11-24 11:57:07,117 - app.middleware.tenant_middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=2
2025-11-24 11:57:07,117 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=multi, bd=bd_cliente_acme, servidor=localhost
2025-11-24 11:57:07,118 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=2, db_type=multi, bd=bd_cliente_acme, path=/api/v1/areas/
2025-11-24 11:57:07,118 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:57:07,119 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:57:07,120 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:57:07,120 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:57:07,121 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:57:07,122 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:57:07,122 - app.api.v1.endpoints.areas - INFO - Solicitud GET /areas/ recibida por usuario 1 del cliente 2 - Paginación: skip=0, limit=10, Búsqueda: 'None'
2025-11-24 11:57:07,123 - app.services.area_service - INFO - Obteniendo áreas paginadas para cliente 2: skip=0, limit=10, search='None'
2025-11-24 11:57:07,123 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:57:07,124 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:57:07,126 - app.services.area_service - INFO - Paginación completada para cliente 2: 2 áreas de 2 totales
2025-11-24 11:57:07,127 - app.api.v1.endpoints.areas - INFO - Lista paginada de áreas recuperada para cliente 2 - Total: 2, Página: 1
2025-11-24 11:57:07,127 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/areas/ 200 11.7ms
2025-11-24 11:57:10,696 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/roles/
2025-11-24 11:57:10,697 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 11:57:10,697 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': acme.app.local:5173
2025-11-24 11:57:10,697 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-11-24 11:57:10,697 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 11:57:10,697 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-11-24 11:57:10,699 - app.middleware.tenant_middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=2
2025-11-24 11:57:10,699 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=multi, bd=bd_cliente_acme, servidor=localhost
2025-11-24 11:57:10,699 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=2, db_type=multi, bd=bd_cliente_acme, path=/api/v1/roles/
2025-11-24 11:57:10,700 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:57:10,701 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:57:10,703 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:57:10,704 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:57:10,706 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:57:10,707 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:57:10,708 - app.api.v1.endpoints.roles - INFO - Solicitud GET /roles/ recibida por usuario 1 del cliente 2 - Paginación: page=1, limit=10, Búsqueda: 'None'
2025-11-24 11:57:10,708 - app.services.rol_service - INFO - Obteniendo roles paginados para cliente 2: page=1, limit=10, search='None'
2025-11-24 11:57:10,709 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:57:10,711 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:57:10,713 - app.services.rol_service - INFO - Obtención paginada de roles para cliente 2 completada exitosamente
2025-11-24 11:57:10,714 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/roles/ N/A 18.1ms
2025-11-24 11:57:10,715 - app.core.exceptions - ERROR - Error no manejado: 3 validation errors:
  {'type': 'value_error', 'loc': ('response', 'roles', 0), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 1, 'nombre': 'Administrador', 'descripcion': 'Administrador con acceso completo', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'ADMIN'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
  {'type': 'value_error', 'loc': ('response', 'roles', 1), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 2, 'nombre': 'Supervisor', 'descripcion': 'Supervisor de departamento', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'SUPERVISOR'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
  {'type': 'value_error', 'loc': ('response', 'roles', 2), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 3, 'nombre': 'Usuario', 'descripcion': 'Usuario estándar', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'USER'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
  + Exception Group Traceback (most recent call last):
  |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 76, in collapse_excgroups
  |     yield
  |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 186, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ~~~~~~~~~~~~~~~~~~~~~~~^^
  |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\anyio\_backends\_asyncio.py", line 815, in __aexit__
  |     raise BaseExceptionGroup(
  |         "unhandled errors in a TaskGroup", self._exceptions
  |     )
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\errors.py", line 165, in __call__
    |     await self.app(scope, receive, _send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    |     with collapse_excgroups():
    |          ~~~~~~~~~~~~~~~~~~^^
    |   File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\app\main.py", line 190, in security_headers
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    |     raise app_exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    |     with collapse_excgroups():
    |          ~~~~~~~~~~~~~~~~~~^^
    |   File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\app\main.py", line 181, in log_requests
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    |     raise app_exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    |     with collapse_excgroups():
    |          ~~~~~~~~~~~~~~~~~~^^
    |   File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\app\main.py", line 158, in cors_middleware
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    |     raise app_exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    |     with collapse_excgroups():
    |          ~~~~~~~~~~~~~~~~~~^^
    |   File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\app\middleware\tenant_middleware.py", line 293, in dispatch
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    |     raise app_exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\exceptions.py", line 62, in __call__
    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 715, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 735, in app
    |     await route.handle(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 288, in handle
    |     await self.app(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 76, in app
    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 73, in app
    |     response = await f(request)
    |                ^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\fastapi\routing.py", line 327, in app
    |     content = await serialize_response(
    |               ^^^^^^^^^^^^^^^^^^^^^^^^^
    |     ...<9 lines>...
    |     )
    |     ^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\fastapi\routing.py", line 176, in serialize_response
    |     raise ResponseValidationError(
    |         errors=_normalize_errors(errors), body=response_content
    |     )
    | fastapi.exceptions.ResponseValidationError: 3 validation errors:
    |   {'type': 'value_error', 'loc': ('response', 'roles', 0), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 1, 'nombre': 'Administrador', 'descripcion': 'Administrador con acceso completo', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'ADMIN'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
    |   {'type': 'value_error', 'loc': ('response', 'roles', 1), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 2, 'nombre': 'Supervisor', 'descripcion': 'Supervisor de departamento', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'SUPERVISOR'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
    |   {'type': 'value_error', 'loc': ('response', 'roles', 2), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 3, 'nombre': 'Usuario', 'descripcion': 'Usuario estándar', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'USER'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
    | 
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\errors.py", line 165, in __call__
    await self.app(scope, receive, _send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    with collapse_excgroups():
         ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\main.py", line 190, in security_headers
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    raise app_exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    with collapse_excgroups():
         ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\main.py", line 181, in log_requests
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    raise app_exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    with collapse_excgroups():
         ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\main.py", line 158, in cors_middleware
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    raise app_exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    with collapse_excgroups():
         ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\middleware\tenant_middleware.py", line 293, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    raise app_exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 715, in __call__
    await self.middleware_stack(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 735, in app
    await route.handle(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 288, in handle
    await self.app(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 76, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 73, in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\fastapi\routing.py", line 327, in app
    content = await serialize_response(
              ^^^^^^^^^^^^^^^^^^^^^^^^^
    ...<9 lines>...
    )
    ^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\fastapi\routing.py", line 176, in serialize_response
    raise ResponseValidationError(
        errors=_normalize_errors(errors), body=response_content
    )
fastapi.exceptions.ResponseValidationError: 3 validation errors:
  {'type': 'value_error', 'loc': ('response', 'roles', 0), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 1, 'nombre': 'Administrador', 'descripcion': 'Administrador con acceso completo', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'ADMIN'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
  {'type': 'value_error', 'loc': ('response', 'roles', 1), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 2, 'nombre': 'Supervisor', 'descripcion': 'Supervisor de departamento', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'SUPERVISOR'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
  {'type': 'value_error', 'loc': ('response', 'roles', 2), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 3, 'nombre': 'Usuario', 'descripcion': 'Usuario estándar', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'USER'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}

2025-11-24 11:57:10,739 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/roles/
2025-11-24 11:57:10,740 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 11:57:10,740 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': acme.app.local:5173
2025-11-24 11:57:10,740 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-11-24 11:57:10,740 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 11:57:10,740 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-11-24 11:57:10,742 - app.middleware.tenant_middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=2
2025-11-24 11:57:10,742 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=multi, bd=bd_cliente_acme, servidor=localhost
2025-11-24 11:57:10,742 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=2, db_type=multi, bd=bd_cliente_acme, path=/api/v1/roles/
2025-11-24 11:57:10,743 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:57:10,744 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:57:10,745 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:57:10,746 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:57:10,748 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:57:10,749 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:57:10,750 - app.api.v1.endpoints.roles - INFO - Solicitud GET /roles/ recibida por usuario 1 del cliente 2 - Paginación: page=1, limit=10, Búsqueda: 'None'
2025-11-24 11:57:10,750 - app.services.rol_service - INFO - Obteniendo roles paginados para cliente 2: page=1, limit=10, search='None'
2025-11-24 11:57:10,750 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:57:10,752 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:57:10,754 - app.services.rol_service - INFO - Obtención paginada de roles para cliente 2 completada exitosamente
2025-11-24 11:57:10,755 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/roles/ N/A 15.6ms
2025-11-24 11:57:10,756 - app.core.exceptions - ERROR - Error no manejado: 3 validation errors:
  {'type': 'value_error', 'loc': ('response', 'roles', 0), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 1, 'nombre': 'Administrador', 'descripcion': 'Administrador con acceso completo', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'ADMIN'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
  {'type': 'value_error', 'loc': ('response', 'roles', 1), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 2, 'nombre': 'Supervisor', 'descripcion': 'Supervisor de departamento', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'SUPERVISOR'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
  {'type': 'value_error', 'loc': ('response', 'roles', 2), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 3, 'nombre': 'Usuario', 'descripcion': 'Usuario estándar', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'USER'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
  + Exception Group Traceback (most recent call last):
  |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 76, in collapse_excgroups
  |     yield
  |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 186, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ~~~~~~~~~~~~~~~~~~~~~~~^^
  |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\anyio\_backends\_asyncio.py", line 815, in __aexit__
  |     raise BaseExceptionGroup(
  |         "unhandled errors in a TaskGroup", self._exceptions
  |     )
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\errors.py", line 165, in __call__
    |     await self.app(scope, receive, _send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    |     with collapse_excgroups():
    |          ~~~~~~~~~~~~~~~~~~^^
    |   File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\app\main.py", line 190, in security_headers
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    |     raise app_exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    |     with collapse_excgroups():
    |          ~~~~~~~~~~~~~~~~~~^^
    |   File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\app\main.py", line 181, in log_requests
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    |     raise app_exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    |     with collapse_excgroups():
    |          ~~~~~~~~~~~~~~~~~~^^
    |   File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\app\main.py", line 158, in cors_middleware
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    |     raise app_exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    |     with collapse_excgroups():
    |          ~~~~~~~~~~~~~~~~~~^^
    |   File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\app\middleware\tenant_middleware.py", line 293, in dispatch
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    |     raise app_exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\exceptions.py", line 62, in __call__
    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 715, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 735, in app
    |     await route.handle(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 288, in handle
    |     await self.app(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 76, in app
    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 73, in app
    |     response = await f(request)
    |                ^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\fastapi\routing.py", line 327, in app
    |     content = await serialize_response(
    |               ^^^^^^^^^^^^^^^^^^^^^^^^^
    |     ...<9 lines>...
    |     )
    |     ^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\fastapi\routing.py", line 176, in serialize_response
    |     raise ResponseValidationError(
    |         errors=_normalize_errors(errors), body=response_content
    |     )
    | fastapi.exceptions.ResponseValidationError: 3 validation errors:
    |   {'type': 'value_error', 'loc': ('response', 'roles', 0), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 1, 'nombre': 'Administrador', 'descripcion': 'Administrador con acceso completo', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'ADMIN'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
    |   {'type': 'value_error', 'loc': ('response', 'roles', 1), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 2, 'nombre': 'Supervisor', 'descripcion': 'Supervisor de departamento', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'SUPERVISOR'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
    |   {'type': 'value_error', 'loc': ('response', 'roles', 2), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 3, 'nombre': 'Usuario', 'descripcion': 'Usuario estándar', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'USER'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
    | 
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\errors.py", line 165, in __call__
    await self.app(scope, receive, _send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    with collapse_excgroups():
         ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\main.py", line 190, in security_headers
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    raise app_exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    with collapse_excgroups():
         ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\main.py", line 181, in log_requests
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    raise app_exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    with collapse_excgroups():
         ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\main.py", line 158, in cors_middleware
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    raise app_exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    with collapse_excgroups():
         ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\middleware\tenant_middleware.py", line 293, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    raise app_exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 715, in __call__
    await self.middleware_stack(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 735, in app
    await route.handle(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 288, in handle
    await self.app(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 76, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 73, in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\fastapi\routing.py", line 327, in app
    content = await serialize_response(
              ^^^^^^^^^^^^^^^^^^^^^^^^^
    ...<9 lines>...
    )
    ^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\fastapi\routing.py", line 176, in serialize_response
    raise ResponseValidationError(
        errors=_normalize_errors(errors), body=response_content
    )
fastapi.exceptions.ResponseValidationError: 3 validation errors:
  {'type': 'value_error', 'loc': ('response', 'roles', 0), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 1, 'nombre': 'Administrador', 'descripcion': 'Administrador con acceso completo', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'ADMIN'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
  {'type': 'value_error', 'loc': ('response', 'roles', 1), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 2, 'nombre': 'Supervisor', 'descripcion': 'Supervisor de departamento', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'SUPERVISOR'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
  {'type': 'value_error', 'loc': ('response', 'roles', 2), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 3, 'nombre': 'Usuario', 'descripcion': 'Usuario estándar', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'USER'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}

2025-11-24 11:57:13,287 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/roles/all-active/
2025-11-24 11:57:13,287 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/usuarios/
2025-11-24 11:57:13,288 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 11:57:13,288 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': acme.app.local:5173
2025-11-24 11:57:13,288 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-11-24 11:57:13,288 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 11:57:13,289 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-11-24 11:57:13,290 - app.middleware.tenant_middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=2
2025-11-24 11:57:13,290 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=multi, bd=bd_cliente_acme, servidor=localhost
2025-11-24 11:57:13,290 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=2, db_type=multi, bd=bd_cliente_acme, path=/api/v1/roles/all-active/
2025-11-24 11:57:13,291 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 11:57:13,291 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': acme.app.local:5173
2025-11-24 11:57:13,291 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-11-24 11:57:13,291 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 11:57:13,291 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-11-24 11:57:13,292 - app.middleware.tenant_middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=2
2025-11-24 11:57:13,293 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=multi, bd=bd_cliente_acme, servidor=localhost
2025-11-24 11:57:13,293 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=2, db_type=multi, bd=bd_cliente_acme, path=/api/v1/usuarios/
2025-11-24 11:57:13,293 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:57:13,295 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:57:13,297 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:57:13,298 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:57:13,300 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:57:13,301 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:57:13,302 - app.api.v1.endpoints.roles - INFO - Solicitud GET /roles/all-active/ recibida por usuario 1 del cliente 2 para lista simple
2025-11-24 11:57:13,302 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:57:13,303 - app.services.rol_service - INFO - Se encontraron 3 roles activos para cliente 2
2025-11-24 11:57:13,303 - app.api.v1.endpoints.roles - INFO - Lista simple de roles activos recuperada para cliente 2 - Total: 3
2025-11-24 11:57:13,304 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:57:13,305 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:57:13,306 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:57:13,307 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:57:13,308 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:57:13,309 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:57:13,310 - app.api.v1.endpoints.usuarios - INFO - Solicitud GET /usuarios/ recibida por usuario 1 del cliente 2 - Paginación: page=1, limit=10, Búsqueda: 'None'
2025-11-24 11:57:13,310 - app.services.usuario_service - INFO - Obteniendo usuarios paginados para cliente 2: page=1, limit=10, search='None'
2025-11-24 11:57:13,310 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:57:13,312 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:57:13,314 - app.services.usuario_service - INFO - Obtención paginada de usuarios completada exitosamente
2025-11-24 11:57:13,314 - app.api.v1.endpoints.usuarios - INFO - Lista paginada de usuarios recuperada para cliente 2 - Total: 3, Página: 1
2025-11-24 11:57:13,315 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/roles/all-active/ 200 27.8ms
2025-11-24 11:57:13,315 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/usuarios/ 200 27.6ms
2025-11-24 11:57:13,318 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/roles/all-active/
2025-11-24 11:57:13,318 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/usuarios/
2025-11-24 11:57:13,319 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 11:57:13,319 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': acme.app.local:5173
2025-11-24 11:57:13,319 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-11-24 11:57:13,319 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 11:57:13,319 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-11-24 11:57:13,320 - app.middleware.tenant_middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=2
2025-11-24 11:57:13,321 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=multi, bd=bd_cliente_acme, servidor=localhost
2025-11-24 11:57:13,321 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=2, db_type=multi, bd=bd_cliente_acme, path=/api/v1/roles/all-active/
2025-11-24 11:57:13,321 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:57:13,322 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:57:13,323 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:57:13,324 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:57:13,325 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:57:13,325 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:57:13,326 - app.api.v1.endpoints.roles - INFO - Solicitud GET /roles/all-active/ recibida por usuario 1 del cliente 2 para lista simple
2025-11-24 11:57:13,326 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:57:13,327 - app.services.rol_service - INFO - Se encontraron 3 roles activos para cliente 2
2025-11-24 11:57:13,327 - app.api.v1.endpoints.roles - INFO - Lista simple de roles activos recuperada para cliente 2 - Total: 3
2025-11-24 11:57:13,328 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 11:57:13,328 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': acme.app.local:5173
2025-11-24 11:57:13,328 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-11-24 11:57:13,328 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 11:57:13,329 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-11-24 11:57:13,329 - app.middleware.tenant_middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=2
2025-11-24 11:57:13,329 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=multi, bd=bd_cliente_acme, servidor=localhost
2025-11-24 11:57:13,329 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=2, db_type=multi, bd=bd_cliente_acme, path=/api/v1/usuarios/
2025-11-24 11:57:13,330 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:57:13,332 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:57:13,333 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:57:13,334 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:57:13,335 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:57:13,336 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:57:13,337 - app.api.v1.endpoints.usuarios - INFO - Solicitud GET /usuarios/ recibida por usuario 1 del cliente 2 - Paginación: page=1, limit=10, Búsqueda: 'None'
2025-11-24 11:57:13,337 - app.services.usuario_service - INFO - Obteniendo usuarios paginados para cliente 2: page=1, limit=10, search='None'
2025-11-24 11:57:13,337 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:57:13,338 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:57:13,340 - app.services.usuario_service - INFO - Obtención paginada de usuarios completada exitosamente
2025-11-24 11:57:13,340 - app.api.v1.endpoints.usuarios - INFO - Lista paginada de usuarios recuperada para cliente 2 - Total: 3, Página: 1
2025-11-24 11:57:13,341 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/roles/all-active/ 200 23.3ms
2025-11-24 11:57:13,341 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/usuarios/ 200 23.0ms
2025-11-24 11:57:14,553 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/areas/list/
2025-11-24 11:57:14,554 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/areas/list/ 200 0.9ms
2025-11-24 11:57:14,554 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/areas/list/
2025-11-24 11:57:14,555 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/areas/list/ 200 0.8ms
2025-11-24 11:57:14,556 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/areas/list/
2025-11-24 11:57:14,556 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 11:57:14,556 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': acme.app.local:5173
2025-11-24 11:57:14,557 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-11-24 11:57:14,557 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 11:57:14,557 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-11-24 11:57:14,558 - app.middleware.tenant_middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=2
2025-11-24 11:57:14,559 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=multi, bd=bd_cliente_acme, servidor=localhost
2025-11-24 11:57:14,559 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=2, db_type=multi, bd=bd_cliente_acme, path=/api/v1/areas/list/
2025-11-24 11:57:14,560 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:57:14,561 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:57:14,563 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:57:14,564 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:57:14,565 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:57:14,567 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:57:14,568 - app.api.v1.endpoints.areas - INFO - Solicitud GET /areas/list/ recibida por usuario 1 del cliente 2 para lista simple
2025-11-24 11:57:14,568 - app.services.area_service - INFO - Obteniendo lista simple de áreas activas para cliente 2
2025-11-24 11:57:14,568 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:57:14,571 - app.services.area_service - INFO - Lista simple obtenida para cliente 2: 2 áreas activas
2025-11-24 11:57:14,572 - app.api.v1.endpoints.areas - INFO - Lista simple de áreas recuperada para cliente 2 - Total: 2 áreas activas
2025-11-24 11:57:14,572 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/areas/list/ 200 16.5ms
2025-11-24 11:57:14,574 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/areas/list/
2025-11-24 11:57:14,574 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 11:57:14,575 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': acme.app.local:5173
2025-11-24 11:57:14,575 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-11-24 11:57:14,575 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 11:57:14,575 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-11-24 11:57:14,576 - app.middleware.tenant_middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=2
2025-11-24 11:57:14,576 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=multi, bd=bd_cliente_acme, servidor=localhost
2025-11-24 11:57:14,577 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=2, db_type=multi, bd=bd_cliente_acme, path=/api/v1/areas/list/
2025-11-24 11:57:14,577 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:57:14,578 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:57:14,579 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:57:14,580 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:57:14,581 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:57:14,582 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:57:14,583 - app.api.v1.endpoints.areas - INFO - Solicitud GET /areas/list/ recibida por usuario 1 del cliente 2 para lista simple
2025-11-24 11:57:14,583 - app.services.area_service - INFO - Obteniendo lista simple de áreas activas para cliente 2
2025-11-24 11:57:14,583 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:57:14,585 - app.services.area_service - INFO - Lista simple obtenida para cliente 2: 2 áreas activas
2025-11-24 11:57:14,585 - app.api.v1.endpoints.areas - INFO - Lista simple de áreas recuperada para cliente 2 - Total: 2 áreas activas
2025-11-24 11:57:14,585 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/areas/list/ 200 11.2ms
2025-11-24 11:57:24,685 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/clientes/
2025-11-24 11:57:24,686 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/clientes/ 200 1.1ms
2025-11-24 11:57:24,687 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/clientes/
2025-11-24 11:57:24,688 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/clientes/ 200 0.9ms
2025-11-24 11:57:24,689 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/clientes/
2025-11-24 11:57:24,690 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 11:57:24,690 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': platform.app.local:5173
2025-11-24 11:57:24,690 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-11-24 11:57:24,690 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 11:57:24,690 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-11-24 11:57:24,690 - app.middleware.tenant_middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: 1
2025-11-24 11:57:24,691 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-11-24 11:57:24,691 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=1, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/clientes/
2025-11-24 11:57:24,712 - app.api.v1.endpoints.clientes - INFO - Solicitud GET /clientes/ recibida - skip: 0, limit: 10, solo_activos: True, buscar: None por usuario: superadmin
2025-11-24 11:57:24,712 - app.services.cliente_service - INFO - Listando clientes - skip: 0, limit: 10, solo_activos: True, buscar: None
2025-11-24 11:57:24,716 - app.services.cliente_service - INFO - Listados 6 clientes de 6 totales
2025-11-24 11:57:24,717 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/clientes/ 200 27.7ms
2025-11-24 11:57:24,719 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/clientes/
2025-11-24 11:57:24,719 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 11:57:24,719 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': platform.app.local:5173
2025-11-24 11:57:24,719 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-11-24 11:57:24,719 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 11:57:24,719 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-11-24 11:57:24,720 - app.middleware.tenant_middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: 1
2025-11-24 11:57:24,720 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-11-24 11:57:24,720 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=1, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/clientes/
2025-11-24 11:57:24,723 - app.api.v1.endpoints.clientes - INFO - Solicitud GET /clientes/ recibida - skip: 0, limit: 10, solo_activos: True, buscar: None por usuario: superadmin
2025-11-24 11:57:24,723 - app.services.cliente_service - INFO - Listando clientes - skip: 0, limit: 10, solo_activos: True, buscar: None
2025-11-24 11:57:24,726 - app.services.cliente_service - INFO - Listados 6 clientes de 6 totales
2025-11-24 11:57:24,727 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/clientes/ 200 8.3ms
2025-11-24 11:57:31,086 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/clientes/3/
2025-11-24 11:57:31,087 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/clientes/3/ 200 0.7ms
2025-11-24 11:57:31,088 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/clientes/3/estadisticas/
2025-11-24 11:57:31,088 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/clientes/3/
2025-11-24 11:57:31,089 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/clientes/3/estadisticas/ 200 1.1ms
2025-11-24 11:57:31,089 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/clientes/3/ 200 1.0ms
2025-11-24 11:57:31,089 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/clientes/3/estadisticas/
2025-11-24 11:57:31,091 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/clientes/3/estadisticas/ 200 1.7ms
2025-11-24 11:57:31,091 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/clientes/3/
2025-11-24 11:57:31,093 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 11:57:31,093 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': platform.app.local:5173
2025-11-24 11:57:31,094 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-11-24 11:57:31,094 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 11:57:31,094 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-11-24 11:57:31,094 - app.middleware.tenant_middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: 1
2025-11-24 11:57:31,094 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-11-24 11:57:31,095 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=1, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/clientes/3/
2025-11-24 11:57:31,102 - app.api.v1.endpoints.clientes - INFO - Solicitud GET /clientes/3 recibida por usuario: superadmin
2025-11-24 11:57:31,104 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/clientes/3/estadisticas/
2025-11-24 11:57:31,105 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 11:57:31,105 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': platform.app.local:5173
2025-11-24 11:57:31,105 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-11-24 11:57:31,106 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 11:57:31,106 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-11-24 11:57:31,106 - app.middleware.tenant_middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: 1
2025-11-24 11:57:31,106 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-11-24 11:57:31,106 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=1, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/clientes/3/estadisticas/
2025-11-24 11:57:31,107 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/clientes/3/ 200 15.1ms
2025-11-24 11:57:31,110 - app.api.v1.endpoints.clientes - INFO - Solicitud GET /clientes/3/estadisticas recibida por usuario: superadmin
2025-11-24 11:57:31,110 - app.services.cliente_service - INFO - Obteniendo estadísticas para cliente ID: 3
2025-11-24 11:57:31,119 - app.services.cliente_service - INFO - Estadísticas obtenidas para cliente 3
2025-11-24 11:57:31,120 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/clientes/3/estadisticas/ 200 15.6ms
2025-11-24 11:57:31,121 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/clientes/3/
2025-11-24 11:57:31,122 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 11:57:31,122 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': platform.app.local:5173
2025-11-24 11:57:31,122 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-11-24 11:57:31,122 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 11:57:31,122 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-11-24 11:57:31,122 - app.middleware.tenant_middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: 1
2025-11-24 11:57:31,122 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-11-24 11:57:31,123 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=1, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/clientes/3/
2025-11-24 11:57:31,126 - app.api.v1.endpoints.clientes - INFO - Solicitud GET /clientes/3 recibida por usuario: superadmin
2025-11-24 11:57:31,128 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/clientes/3/estadisticas/
2025-11-24 11:57:31,128 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 11:57:31,128 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': platform.app.local:5173
2025-11-24 11:57:31,129 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-11-24 11:57:31,129 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 11:57:31,129 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-11-24 11:57:31,129 - app.middleware.tenant_middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: 1
2025-11-24 11:57:31,129 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-11-24 11:57:31,129 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=1, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/clientes/3/estadisticas/
2025-11-24 11:57:31,130 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/clientes/3/ 200 8.7ms
2025-11-24 11:57:31,134 - app.api.v1.endpoints.clientes - INFO - Solicitud GET /clientes/3/estadisticas recibida por usuario: superadmin
2025-11-24 11:57:31,134 - app.services.cliente_service - INFO - Obteniendo estadísticas para cliente ID: 3
2025-11-24 11:57:31,137 - app.services.cliente_service - INFO - Estadísticas obtenidas para cliente 3
2025-11-24 11:57:31,138 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/clientes/3/estadisticas/ 200 10.6ms
2025-11-24 11:57:31,968 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/conexiones/clientes/3/
2025-11-24 11:57:31,969 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/conexiones/clientes/3/
2025-11-24 11:57:31,969 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/conexiones/clientes/3/ 200 1.5ms
2025-11-24 11:57:31,969 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/modulos/
2025-11-24 11:57:31,970 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/conexiones/clientes/3/ 200 1.5ms
2025-11-24 11:57:31,970 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 11:57:31,971 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': platform.app.local:5173
2025-11-24 11:57:31,971 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-11-24 11:57:31,971 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 11:57:31,971 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-11-24 11:57:31,971 - app.middleware.tenant_middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: 1
2025-11-24 11:57:31,971 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-11-24 11:57:31,972 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=1, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/modulos/
2025-11-24 11:57:31,975 - app.api.v1.endpoints.modulos - INFO - Solicitud GET /modulos/ recibida - skip: 0, limit: 100, solo_activos: True
2025-11-24 11:57:31,976 - app.services.modulo_service - INFO - Obteniendo catálogo de módulos - skip: 0, limit: 100
2025-11-24 11:57:31,978 - app.services.modulo_service - INFO - Contando total de módulos en el sistema
2025-11-24 11:57:31,980 - app.api.v1.endpoints.modulos - INFO - Catálogo de módulos recuperado: 5 módulos de 5 totales
2025-11-24 11:57:31,981 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/conexiones/clientes/3/
2025-11-24 11:57:31,982 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 11:57:31,983 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': platform.app.local:5173
2025-11-24 11:57:31,983 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-11-24 11:57:31,983 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 11:57:31,983 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-11-24 11:57:31,983 - app.middleware.tenant_middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: 1
2025-11-24 11:57:31,983 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-11-24 11:57:31,984 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=1, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/conexiones/clientes/3/
2025-11-24 11:57:31,988 - app.api.v1.endpoints.conexiones - INFO - Solicitud GET /conexiones/clientes/3 recibida
2025-11-24 11:57:31,988 - app.services.conexion_service - INFO - Obteniendo conexiones para cliente ID: 3
2025-11-24 11:57:31,991 - app.api.v1.endpoints.conexiones - INFO - Conexiones recuperadas para cliente 3: 1 conexiones
2025-11-24 11:57:31,991 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/modulos/ 200 21.9ms
2025-11-24 11:57:31,992 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/conexiones/clientes/3/ 200 10.8ms
2025-11-24 11:57:31,994 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/modulos/
2025-11-24 11:57:31,995 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 11:57:31,995 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': platform.app.local:5173
2025-11-24 11:57:31,995 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-11-24 11:57:31,995 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 11:57:31,995 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-11-24 11:57:31,995 - app.middleware.tenant_middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: 1
2025-11-24 11:57:31,996 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-11-24 11:57:31,996 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=1, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/modulos/
2025-11-24 11:57:31,996 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/conexiones/clientes/3/
2025-11-24 11:57:32,002 - app.api.v1.endpoints.modulos - INFO - Solicitud GET /modulos/ recibida - skip: 0, limit: 100, solo_activos: True
2025-11-24 11:57:32,002 - app.services.modulo_service - INFO - Obteniendo catálogo de módulos - skip: 0, limit: 100
2025-11-24 11:57:32,003 - app.services.modulo_service - INFO - Contando total de módulos en el sistema
2025-11-24 11:57:32,004 - app.api.v1.endpoints.modulos - INFO - Catálogo de módulos recuperado: 5 módulos de 5 totales
2025-11-24 11:57:32,005 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 11:57:32,005 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': platform.app.local:5173
2025-11-24 11:57:32,006 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-11-24 11:57:32,006 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 11:57:32,006 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-11-24 11:57:32,006 - app.middleware.tenant_middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: 1
2025-11-24 11:57:32,006 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-11-24 11:57:32,006 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=1, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/conexiones/clientes/3/
2025-11-24 11:57:32,010 - app.api.v1.endpoints.conexiones - INFO - Solicitud GET /conexiones/clientes/3 recibida
2025-11-24 11:57:32,011 - app.services.conexion_service - INFO - Obteniendo conexiones para cliente ID: 3
2025-11-24 11:57:32,012 - app.api.v1.endpoints.conexiones - INFO - Conexiones recuperadas para cliente 3: 1 conexiones
2025-11-24 11:57:32,012 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/modulos/ 200 18.6ms
2025-11-24 11:57:32,013 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/conexiones/clientes/3/ 200 17.1ms
2025-11-24 11:57:39,898 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/conexiones/test
2025-11-24 11:57:39,898 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 11:57:39,899 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': platform.app.local:5173
2025-11-24 11:57:39,899 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-11-24 11:57:39,899 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 11:57:39,899 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-11-24 11:57:39,899 - app.middleware.tenant_middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: 1
2025-11-24 11:57:39,899 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-11-24 11:57:39,900 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=1, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/conexiones/test
2025-11-24 11:57:39,916 - app.api.v1.endpoints.conexiones - INFO - Solicitud POST /conexiones/test recibida para servidor: localhost
2025-11-24 11:57:39,917 - app.services.conexion_service - INFO - Testeando conexión para servidor: localhost
2025-11-24 11:57:39,917 - app.services.conexion_service - INFO - Test de conexión exitoso para localhost
2025-11-24 11:57:39,917 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/conexiones/test 200 19.3ms
2025-11-24 11:57:42,671 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/conexiones/3/
2025-11-24 11:57:42,672 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/conexiones/3/ 200 0.7ms
2025-11-24 11:57:42,674 - app.main - INFO - [SYSTEM] 127.0.0.1 -> PUT /api/v1/conexiones/3/
2025-11-24 11:57:42,674 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 11:57:42,674 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': platform.app.local:5173
2025-11-24 11:57:42,674 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-11-24 11:57:42,675 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 11:57:42,675 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-11-24 11:57:42,675 - app.middleware.tenant_middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: 1
2025-11-24 11:57:42,675 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-11-24 11:57:42,675 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=1, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/conexiones/3/
2025-11-24 11:57:42,702 - app.api.v1.endpoints.conexiones - INFO - Solicitud PUT /conexiones/3 recibida
2025-11-24 11:57:42,703 - app.services.conexion_service - INFO - Actualizando conexión ID: 3
2025-11-24 11:57:42,714 - app.db.queries - INFO - Actualización exitosa, filas afectadas: -1
2025-11-24 11:57:42,715 - app.services.conexion_service - INFO - Conexión ID 3 actualizada exitosamente.
2025-11-24 11:57:42,715 - app.api.v1.endpoints.conexiones - INFO - Conexión 3 actualizada exitosamente
2025-11-24 11:57:42,715 - app.main - INFO - [SYSTEM] 127.0.0.1 <- PUT /api/v1/conexiones/3/ 200 41.9ms
2025-11-24 11:57:42,720 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/conexiones/clientes/3/
2025-11-24 11:57:42,721 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 11:57:42,721 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': platform.app.local:5173
2025-11-24 11:57:42,721 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-11-24 11:57:42,722 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 11:57:42,722 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-11-24 11:57:42,722 - app.middleware.tenant_middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: 1
2025-11-24 11:57:42,722 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-11-24 11:57:42,722 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=1, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/conexiones/clientes/3/
2025-11-24 11:57:42,727 - app.api.v1.endpoints.conexiones - INFO - Solicitud GET /conexiones/clientes/3 recibida
2025-11-24 11:57:42,728 - app.services.conexion_service - INFO - Obteniendo conexiones para cliente ID: 3
2025-11-24 11:57:42,731 - app.api.v1.endpoints.conexiones - INFO - Conexiones recuperadas para cliente 3: 1 conexiones
2025-11-24 11:57:42,732 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/conexiones/clientes/3/ 200 11.5ms
2025-11-24 11:57:53,558 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/clientes/
2025-11-24 11:57:53,559 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 11:57:53,559 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': platform.app.local:5173
2025-11-24 11:57:53,559 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-11-24 11:57:53,559 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 11:57:53,559 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-11-24 11:57:53,560 - app.middleware.tenant_middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: 1
2025-11-24 11:57:53,560 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-11-24 11:57:53,560 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=1, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/clientes/
2025-11-24 11:57:53,565 - app.api.v1.endpoints.clientes - INFO - Solicitud GET /clientes/ recibida - skip: 0, limit: 10, solo_activos: True, buscar: None por usuario: superadmin
2025-11-24 11:57:53,565 - app.services.cliente_service - INFO - Listando clientes - skip: 0, limit: 10, solo_activos: True, buscar: None
2025-11-24 11:57:53,572 - app.services.cliente_service - INFO - Listados 6 clientes de 6 totales
2025-11-24 11:57:53,573 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/clientes/ 200 15.3ms
2025-11-24 11:57:53,575 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/clientes/
2025-11-24 11:57:53,575 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 11:57:53,576 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': platform.app.local:5173
2025-11-24 11:57:53,576 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-11-24 11:57:53,576 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 11:57:53,576 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-11-24 11:57:53,576 - app.middleware.tenant_middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: 1
2025-11-24 11:57:53,576 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-11-24 11:57:53,577 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=1, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/clientes/
2025-11-24 11:57:53,580 - app.api.v1.endpoints.clientes - INFO - Solicitud GET /clientes/ recibida - skip: 0, limit: 10, solo_activos: True, buscar: None por usuario: superadmin
2025-11-24 11:57:53,580 - app.services.cliente_service - INFO - Listando clientes - skip: 0, limit: 10, solo_activos: True, buscar: None
2025-11-24 11:57:53,582 - app.services.cliente_service - INFO - Listados 6 clientes de 6 totales
2025-11-24 11:57:53,582 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/clientes/ 200 7.6ms
2025-11-24 11:58:02,171 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/clientes/5/
2025-11-24 11:58:02,172 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/clientes/5/ 200 1.1ms
2025-11-24 11:58:02,174 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/clientes/5/estadisticas/
2025-11-24 11:58:02,174 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/clientes/5/
2025-11-24 11:58:02,174 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/clientes/5/estadisticas/
2025-11-24 11:58:02,175 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/clientes/5/estadisticas/ 200 1.2ms
2025-11-24 11:58:02,175 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/clientes/5/ 200 1.1ms
2025-11-24 11:58:02,175 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/clientes/5/estadisticas/ 200 1.1ms
2025-11-24 11:58:02,178 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/clientes/5/
2025-11-24 11:58:02,179 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 11:58:02,180 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': platform.app.local:5173
2025-11-24 11:58:02,180 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-11-24 11:58:02,180 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 11:58:02,180 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-11-24 11:58:02,180 - app.middleware.tenant_middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: 1
2025-11-24 11:58:02,181 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-11-24 11:58:02,181 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=1, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/clientes/5/
2025-11-24 11:58:02,186 - app.api.v1.endpoints.clientes - INFO - Solicitud GET /clientes/5 recibida por usuario: superadmin
2025-11-24 11:58:02,189 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/clientes/5/estadisticas/
2025-11-24 11:58:02,189 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 11:58:02,189 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': platform.app.local:5173
2025-11-24 11:58:02,189 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-11-24 11:58:02,189 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 11:58:02,190 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-11-24 11:58:02,190 - app.middleware.tenant_middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: 1
2025-11-24 11:58:02,190 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-11-24 11:58:02,190 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=1, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/clientes/5/estadisticas/
2025-11-24 11:58:02,194 - app.api.v1.endpoints.clientes - INFO - Solicitud GET /clientes/5/estadisticas recibida por usuario: superadmin
2025-11-24 11:58:02,194 - app.services.cliente_service - INFO - Obteniendo estadísticas para cliente ID: 5
2025-11-24 11:58:02,202 - app.services.cliente_service - INFO - Estadísticas obtenidas para cliente 5
2025-11-24 11:58:02,202 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/clientes/5/ 200 24.2ms
2025-11-24 11:58:02,203 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/clientes/5/estadisticas/ 200 14.6ms
2025-11-24 11:58:02,205 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/clientes/5/
2025-11-24 11:58:02,205 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 11:58:02,205 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': platform.app.local:5173
2025-11-24 11:58:02,205 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-11-24 11:58:02,206 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 11:58:02,206 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-11-24 11:58:02,206 - app.middleware.tenant_middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: 1
2025-11-24 11:58:02,206 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-11-24 11:58:02,206 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=1, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/clientes/5/
2025-11-24 11:58:02,210 - app.api.v1.endpoints.clientes - INFO - Solicitud GET /clientes/5 recibida por usuario: superadmin
2025-11-24 11:58:02,212 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/clientes/5/estadisticas/
2025-11-24 11:58:02,212 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 11:58:02,212 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': platform.app.local:5173
2025-11-24 11:58:02,212 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-11-24 11:58:02,213 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 11:58:02,213 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-11-24 11:58:02,213 - app.middleware.tenant_middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: 1
2025-11-24 11:58:02,213 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-11-24 11:58:02,213 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=1, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/clientes/5/estadisticas/
2025-11-24 11:58:02,216 - app.api.v1.endpoints.clientes - INFO - Solicitud GET /clientes/5/estadisticas recibida por usuario: superadmin
2025-11-24 11:58:02,217 - app.services.cliente_service - INFO - Obteniendo estadísticas para cliente ID: 5
2025-11-24 11:58:02,219 - app.services.cliente_service - INFO - Estadísticas obtenidas para cliente 5
2025-11-24 11:58:02,220 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/clientes/5/ 200 15.1ms
2025-11-24 11:58:02,221 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/clientes/5/estadisticas/ 200 9.0ms
2025-11-24 11:58:04,163 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/conexiones/clientes/5/
2025-11-24 11:58:04,164 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/conexiones/clientes/5/ 200 0.8ms
2025-11-24 11:58:04,164 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/modulos/
2025-11-24 11:58:04,164 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/conexiones/clientes/5/
2025-11-24 11:58:04,165 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 11:58:04,165 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': platform.app.local:5173
2025-11-24 11:58:04,165 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-11-24 11:58:04,165 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 11:58:04,166 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-11-24 11:58:04,166 - app.middleware.tenant_middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: 1
2025-11-24 11:58:04,166 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-11-24 11:58:04,166 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=1, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/modulos/
2025-11-24 11:58:04,169 - app.api.v1.endpoints.modulos - INFO - Solicitud GET /modulos/ recibida - skip: 0, limit: 100, solo_activos: True
2025-11-24 11:58:04,169 - app.services.modulo_service - INFO - Obteniendo catálogo de módulos - skip: 0, limit: 100
2025-11-24 11:58:04,171 - app.services.modulo_service - INFO - Contando total de módulos en el sistema
2025-11-24 11:58:04,173 - app.api.v1.endpoints.modulos - INFO - Catálogo de módulos recuperado: 5 módulos de 5 totales
2025-11-24 11:58:04,173 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/conexiones/clientes/5/ 200 9.0ms
2025-11-24 11:58:04,174 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/conexiones/clientes/5/
2025-11-24 11:58:04,175 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 11:58:04,175 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': platform.app.local:5173
2025-11-24 11:58:04,176 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-11-24 11:58:04,176 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 11:58:04,176 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-11-24 11:58:04,176 - app.middleware.tenant_middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: 1
2025-11-24 11:58:04,176 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-11-24 11:58:04,176 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=1, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/conexiones/clientes/5/
2025-11-24 11:58:04,180 - app.api.v1.endpoints.conexiones - INFO - Solicitud GET /conexiones/clientes/5 recibida
2025-11-24 11:58:04,180 - app.services.conexion_service - INFO - Obteniendo conexiones para cliente ID: 5
2025-11-24 11:58:04,181 - app.api.v1.endpoints.conexiones - INFO - Conexiones recuperadas para cliente 5: 1 conexiones
2025-11-24 11:58:04,182 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/modulos/ 200 18.0ms
2025-11-24 11:58:04,183 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/conexiones/clientes/5/ 200 8.6ms
2025-11-24 11:58:04,184 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/modulos/
2025-11-24 11:58:04,185 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/conexiones/clientes/5/
2025-11-24 11:58:04,185 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 11:58:04,185 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': platform.app.local:5173
2025-11-24 11:58:04,186 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-11-24 11:58:04,186 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 11:58:04,186 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-11-24 11:58:04,186 - app.middleware.tenant_middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: 1
2025-11-24 11:58:04,186 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-11-24 11:58:04,186 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=1, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/modulos/
2025-11-24 11:58:04,190 - app.api.v1.endpoints.modulos - INFO - Solicitud GET /modulos/ recibida - skip: 0, limit: 100, solo_activos: True
2025-11-24 11:58:04,190 - app.services.modulo_service - INFO - Obteniendo catálogo de módulos - skip: 0, limit: 100
2025-11-24 11:58:04,191 - app.services.modulo_service - INFO - Contando total de módulos en el sistema
2025-11-24 11:58:04,192 - app.api.v1.endpoints.modulos - INFO - Catálogo de módulos recuperado: 5 módulos de 5 totales
2025-11-24 11:58:04,192 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 11:58:04,192 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': platform.app.local:5173
2025-11-24 11:58:04,192 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-11-24 11:58:04,192 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 11:58:04,193 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-11-24 11:58:04,193 - app.middleware.tenant_middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: 1
2025-11-24 11:58:04,193 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-11-24 11:58:04,193 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=1, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/conexiones/clientes/5/
2025-11-24 11:58:04,196 - app.api.v1.endpoints.conexiones - INFO - Solicitud GET /conexiones/clientes/5 recibida
2025-11-24 11:58:04,196 - app.services.conexion_service - INFO - Obteniendo conexiones para cliente ID: 5
2025-11-24 11:58:04,198 - app.api.v1.endpoints.conexiones - INFO - Conexiones recuperadas para cliente 5: 1 conexiones
2025-11-24 11:58:04,199 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/modulos/ 200 14.5ms
2025-11-24 11:58:04,199 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/conexiones/clientes/5/ 200 14.3ms
2025-11-24 11:58:11,231 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/conexiones/test
2025-11-24 11:58:11,232 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 11:58:11,232 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': platform.app.local:5173
2025-11-24 11:58:11,232 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-11-24 11:58:11,232 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 11:58:11,232 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-11-24 11:58:11,232 - app.middleware.tenant_middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: 1
2025-11-24 11:58:11,232 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-11-24 11:58:11,232 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=1, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/conexiones/test
2025-11-24 11:58:11,237 - app.api.v1.endpoints.conexiones - INFO - Solicitud POST /conexiones/test recibida para servidor: localhost
2025-11-24 11:58:11,237 - app.services.conexion_service - INFO - Testeando conexión para servidor: localhost
2025-11-24 11:58:11,237 - app.services.conexion_service - INFO - Test de conexión exitoso para localhost
2025-11-24 11:58:11,238 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/conexiones/test 200 6.9ms
2025-11-24 11:58:12,422 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/conexiones/6/
2025-11-24 11:58:12,422 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/conexiones/6/ 200 0.6ms
2025-11-24 11:58:12,424 - app.main - INFO - [SYSTEM] 127.0.0.1 -> PUT /api/v1/conexiones/6/
2025-11-24 11:58:12,425 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 11:58:12,425 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': platform.app.local:5173
2025-11-24 11:58:12,425 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-11-24 11:58:12,425 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 11:58:12,425 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-11-24 11:58:12,425 - app.middleware.tenant_middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: 1
2025-11-24 11:58:12,425 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-11-24 11:58:12,426 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=1, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/conexiones/6/
2025-11-24 11:58:12,429 - app.api.v1.endpoints.conexiones - INFO - Solicitud PUT /conexiones/6 recibida
2025-11-24 11:58:12,429 - app.services.conexion_service - INFO - Actualizando conexión ID: 6
2025-11-24 11:58:12,434 - app.db.queries - INFO - Actualización exitosa, filas afectadas: -1
2025-11-24 11:58:12,435 - app.services.conexion_service - INFO - Conexión ID 6 actualizada exitosamente.
2025-11-24 11:58:12,435 - app.api.v1.endpoints.conexiones - INFO - Conexión 6 actualizada exitosamente
2025-11-24 11:58:12,436 - app.main - INFO - [SYSTEM] 127.0.0.1 <- PUT /api/v1/conexiones/6/ 200 11.5ms
2025-11-24 11:58:12,440 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/conexiones/clientes/5/
2025-11-24 11:58:12,440 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 11:58:12,440 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': platform.app.local:5173
2025-11-24 11:58:12,440 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-11-24 11:58:12,441 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 11:58:12,441 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-11-24 11:58:12,441 - app.middleware.tenant_middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: 1
2025-11-24 11:58:12,441 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-11-24 11:58:12,441 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=1, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/conexiones/clientes/5/
2025-11-24 11:58:12,444 - app.api.v1.endpoints.conexiones - INFO - Solicitud GET /conexiones/clientes/5 recibida
2025-11-24 11:58:12,444 - app.services.conexion_service - INFO - Obteniendo conexiones para cliente ID: 5
2025-11-24 11:58:12,446 - app.api.v1.endpoints.conexiones - INFO - Conexiones recuperadas para cliente 5: 1 conexiones
2025-11-24 11:58:12,446 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/conexiones/clientes/5/ 200 6.5ms
2025-11-24 11:58:18,228 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/clientes/
2025-11-24 11:58:18,228 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 11:58:18,229 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': platform.app.local:5173
2025-11-24 11:58:18,229 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-11-24 11:58:18,229 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 11:58:18,229 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-11-24 11:58:18,229 - app.middleware.tenant_middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: 1
2025-11-24 11:58:18,230 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-11-24 11:58:18,230 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=1, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/clientes/
2025-11-24 11:58:18,235 - app.api.v1.endpoints.clientes - INFO - Solicitud GET /clientes/ recibida - skip: 0, limit: 10, solo_activos: True, buscar: None por usuario: superadmin
2025-11-24 11:58:18,235 - app.services.cliente_service - INFO - Listando clientes - skip: 0, limit: 10, solo_activos: True, buscar: None
2025-11-24 11:58:18,237 - app.services.cliente_service - INFO - Listados 6 clientes de 6 totales
2025-11-24 11:58:18,238 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/clientes/ 200 10.2ms
2025-11-24 11:58:18,240 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/clientes/
2025-11-24 11:58:18,240 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 11:58:18,241 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': platform.app.local:5173
2025-11-24 11:58:18,241 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-11-24 11:58:18,241 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 11:58:18,241 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-11-24 11:58:18,242 - app.middleware.tenant_middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: 1
2025-11-24 11:58:18,242 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-11-24 11:58:18,242 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=1, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/clientes/
2025-11-24 11:58:18,247 - app.api.v1.endpoints.clientes - INFO - Solicitud GET /clientes/ recibida - skip: 0, limit: 10, solo_activos: True, buscar: None por usuario: superadmin
2025-11-24 11:58:18,247 - app.services.cliente_service - INFO - Listando clientes - skip: 0, limit: 10, solo_activos: True, buscar: None
2025-11-24 11:58:18,249 - app.services.cliente_service - INFO - Listados 6 clientes de 6 totales
2025-11-24 11:58:18,250 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/clientes/ 200 9.7ms
2025-11-24 11:58:20,513 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/clientes/4/
2025-11-24 11:58:20,513 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/clientes/4/ 200 0.9ms
2025-11-24 11:58:20,515 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/clientes/4/estadisticas/
2025-11-24 11:58:20,516 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/clientes/4/estadisticas/ 200 1.1ms
2025-11-24 11:58:20,516 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/clientes/4/
2025-11-24 11:58:20,516 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/clientes/4/estadisticas/
2025-11-24 11:58:20,516 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/clientes/4/
2025-11-24 11:58:20,517 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 11:58:20,517 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': platform.app.local:5173
2025-11-24 11:58:20,518 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-11-24 11:58:20,518 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 11:58:20,518 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-11-24 11:58:20,518 - app.middleware.tenant_middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: 1
2025-11-24 11:58:20,518 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-11-24 11:58:20,519 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=1, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/clientes/4/
2025-11-24 11:58:20,519 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/clientes/4/ 200 3.1ms
2025-11-24 11:58:20,520 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/clientes/4/estadisticas/ 200 3.8ms
2025-11-24 11:58:20,525 - app.api.v1.endpoints.clientes - INFO - Solicitud GET /clientes/4 recibida por usuario: superadmin
2025-11-24 11:58:20,529 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/clientes/4/estadisticas/
2025-11-24 11:58:20,530 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/clientes/4/ 200 13.5ms
2025-11-24 11:58:20,531 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 11:58:20,531 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': platform.app.local:5173
2025-11-24 11:58:20,531 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-11-24 11:58:20,531 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 11:58:20,531 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-11-24 11:58:20,531 - app.middleware.tenant_middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: 1
2025-11-24 11:58:20,532 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-11-24 11:58:20,532 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=1, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/clientes/4/estadisticas/
2025-11-24 11:58:20,536 - app.api.v1.endpoints.clientes - INFO - Solicitud GET /clientes/4/estadisticas recibida por usuario: superadmin
2025-11-24 11:58:20,536 - app.services.cliente_service - INFO - Obteniendo estadísticas para cliente ID: 4
2025-11-24 11:58:20,539 - app.services.cliente_service - INFO - Estadísticas obtenidas para cliente 4
2025-11-24 11:58:20,541 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/clientes/4/estadisticas/ 200 11.7ms
2025-11-24 11:58:20,541 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/clientes/4/
2025-11-24 11:58:20,542 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 11:58:20,542 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': platform.app.local:5173
2025-11-24 11:58:20,542 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-11-24 11:58:20,542 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 11:58:20,542 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-11-24 11:58:20,542 - app.middleware.tenant_middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: 1
2025-11-24 11:58:20,543 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-11-24 11:58:20,543 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=1, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/clientes/4/
2025-11-24 11:58:20,547 - app.api.v1.endpoints.clientes - INFO - Solicitud GET /clientes/4 recibida por usuario: superadmin
2025-11-24 11:58:20,549 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/clientes/4/estadisticas/
2025-11-24 11:58:20,550 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 11:58:20,550 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': platform.app.local:5173
2025-11-24 11:58:20,550 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-11-24 11:58:20,550 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 11:58:20,551 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-11-24 11:58:20,551 - app.middleware.tenant_middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: 1
2025-11-24 11:58:20,551 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-11-24 11:58:20,551 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=1, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/clientes/4/estadisticas/
2025-11-24 11:58:20,555 - app.api.v1.endpoints.clientes - INFO - Solicitud GET /clientes/4/estadisticas recibida por usuario: superadmin
2025-11-24 11:58:20,555 - app.services.cliente_service - INFO - Obteniendo estadísticas para cliente ID: 4
2025-11-24 11:58:20,558 - app.services.cliente_service - INFO - Estadísticas obtenidas para cliente 4
2025-11-24 11:58:20,558 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/clientes/4/ 200 17.5ms
2025-11-24 11:58:20,560 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/clientes/4/estadisticas/ 200 10.4ms
2025-11-24 11:58:21,561 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/conexiones/clientes/4/
2025-11-24 11:58:21,562 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/conexiones/clientes/4/
2025-11-24 11:58:21,562 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/conexiones/clientes/4/ 200 1.5ms
2025-11-24 11:58:21,563 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/modulos/
2025-11-24 11:58:21,563 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/conexiones/clientes/4/ 200 1.8ms
2025-11-24 11:58:21,564 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 11:58:21,564 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': platform.app.local:5173
2025-11-24 11:58:21,564 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-11-24 11:58:21,564 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 11:58:21,564 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-11-24 11:58:21,564 - app.middleware.tenant_middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: 1
2025-11-24 11:58:21,565 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-11-24 11:58:21,565 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=1, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/modulos/
2025-11-24 11:58:21,568 - app.api.v1.endpoints.modulos - INFO - Solicitud GET /modulos/ recibida - skip: 0, limit: 100, solo_activos: True
2025-11-24 11:58:21,569 - app.services.modulo_service - INFO - Obteniendo catálogo de módulos - skip: 0, limit: 100
2025-11-24 11:58:21,570 - app.services.modulo_service - INFO - Contando total de módulos en el sistema
2025-11-24 11:58:21,570 - app.api.v1.endpoints.modulos - INFO - Catálogo de módulos recuperado: 5 módulos de 5 totales
2025-11-24 11:58:21,571 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/conexiones/clientes/4/
2025-11-24 11:58:21,572 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 11:58:21,572 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': platform.app.local:5173
2025-11-24 11:58:21,572 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-11-24 11:58:21,572 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 11:58:21,572 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-11-24 11:58:21,573 - app.middleware.tenant_middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: 1
2025-11-24 11:58:21,573 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-11-24 11:58:21,573 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=1, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/conexiones/clientes/4/
2025-11-24 11:58:21,576 - app.api.v1.endpoints.conexiones - INFO - Solicitud GET /conexiones/clientes/4 recibida
2025-11-24 11:58:21,577 - app.services.conexion_service - INFO - Obteniendo conexiones para cliente ID: 4
2025-11-24 11:58:21,578 - app.api.v1.endpoints.conexiones - INFO - Conexiones recuperadas para cliente 4: 2 conexiones
2025-11-24 11:58:21,578 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/modulos/ 200 15.7ms
2025-11-24 11:58:21,580 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/conexiones/clientes/4/ 200 8.3ms
2025-11-24 11:58:21,582 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/modulos/
2025-11-24 11:58:21,583 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 11:58:21,583 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': platform.app.local:5173
2025-11-24 11:58:21,583 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-11-24 11:58:21,584 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 11:58:21,584 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-11-24 11:58:21,584 - app.middleware.tenant_middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: 1
2025-11-24 11:58:21,584 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-11-24 11:58:21,584 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=1, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/modulos/
2025-11-24 11:58:21,585 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/conexiones/clientes/4/
2025-11-24 11:58:21,588 - app.api.v1.endpoints.modulos - INFO - Solicitud GET /modulos/ recibida - skip: 0, limit: 100, solo_activos: True
2025-11-24 11:58:21,588 - app.services.modulo_service - INFO - Obteniendo catálogo de módulos - skip: 0, limit: 100
2025-11-24 11:58:21,589 - app.services.modulo_service - INFO - Contando total de módulos en el sistema
2025-11-24 11:58:21,590 - app.api.v1.endpoints.modulos - INFO - Catálogo de módulos recuperado: 5 módulos de 5 totales
2025-11-24 11:58:21,591 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 11:58:21,591 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': platform.app.local:5173
2025-11-24 11:58:21,591 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-11-24 11:58:21,591 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 11:58:21,591 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-11-24 11:58:21,591 - app.middleware.tenant_middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: 1
2025-11-24 11:58:21,591 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-11-24 11:58:21,592 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=1, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/conexiones/clientes/4/
2025-11-24 11:58:21,595 - app.api.v1.endpoints.conexiones - INFO - Solicitud GET /conexiones/clientes/4 recibida
2025-11-24 11:58:21,595 - app.services.conexion_service - INFO - Obteniendo conexiones para cliente ID: 4
2025-11-24 11:58:21,596 - app.api.v1.endpoints.conexiones - INFO - Conexiones recuperadas para cliente 4: 2 conexiones
2025-11-24 11:58:21,597 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/modulos/ 200 14.7ms
2025-11-24 11:58:21,598 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/conexiones/clientes/4/ 200 13.4ms
2025-11-24 11:58:28,420 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/conexiones/test
2025-11-24 11:58:28,420 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 11:58:28,420 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': platform.app.local:5173
2025-11-24 11:58:28,421 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-11-24 11:58:28,421 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 11:58:28,421 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-11-24 11:58:28,421 - app.middleware.tenant_middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: 1
2025-11-24 11:58:28,421 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-11-24 11:58:28,421 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=1, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/conexiones/test
2025-11-24 11:58:28,426 - app.api.v1.endpoints.conexiones - INFO - Solicitud POST /conexiones/test recibida para servidor: localhost
2025-11-24 11:58:28,426 - app.services.conexion_service - INFO - Testeando conexión para servidor: localhost
2025-11-24 11:58:28,426 - app.services.conexion_service - WARNING - Test de conexión fallido para localhost
2025-11-24 11:58:28,427 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/conexiones/test 200 7.2ms
2025-11-24 11:58:29,024 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/conexiones/4/
2025-11-24 11:58:29,024 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/conexiones/4/ 200 0.4ms
2025-11-24 11:58:29,026 - app.main - INFO - [SYSTEM] 127.0.0.1 -> PUT /api/v1/conexiones/4/
2025-11-24 11:58:29,027 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 11:58:29,027 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': platform.app.local:5173
2025-11-24 11:58:29,027 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-11-24 11:58:29,027 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 11:58:29,027 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-11-24 11:58:29,027 - app.middleware.tenant_middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: 1
2025-11-24 11:58:29,028 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-11-24 11:58:29,028 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=1, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/conexiones/4/
2025-11-24 11:58:29,032 - app.api.v1.endpoints.conexiones - INFO - Solicitud PUT /conexiones/4 recibida
2025-11-24 11:58:29,032 - app.services.conexion_service - INFO - Actualizando conexión ID: 4
2025-11-24 11:58:29,034 - app.db.queries - INFO - Actualización exitosa, filas afectadas: -1
2025-11-24 11:58:29,035 - app.services.conexion_service - INFO - Conexión ID 4 actualizada exitosamente.
2025-11-24 11:58:29,035 - app.api.v1.endpoints.conexiones - INFO - Conexión 4 actualizada exitosamente
2025-11-24 11:58:29,036 - app.main - INFO - [SYSTEM] 127.0.0.1 <- PUT /api/v1/conexiones/4/ 200 9.5ms
2025-11-24 11:58:29,040 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/conexiones/clientes/4/
2025-11-24 11:58:29,041 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 11:58:29,041 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': platform.app.local:5173
2025-11-24 11:58:29,041 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-11-24 11:58:29,041 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 11:58:29,041 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-11-24 11:58:29,041 - app.middleware.tenant_middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: 1
2025-11-24 11:58:29,042 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-11-24 11:58:29,042 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=1, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/conexiones/clientes/4/
2025-11-24 11:58:29,045 - app.api.v1.endpoints.conexiones - INFO - Solicitud GET /conexiones/clientes/4 recibida
2025-11-24 11:58:29,046 - app.services.conexion_service - INFO - Obteniendo conexiones para cliente ID: 4
2025-11-24 11:58:29,047 - app.api.v1.endpoints.conexiones - INFO - Conexiones recuperadas para cliente 4: 2 conexiones
2025-11-24 11:58:29,047 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/conexiones/clientes/4/ 200 7.4ms
2025-11-24 11:58:36,701 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/conexiones/test
2025-11-24 11:58:36,702 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 11:58:36,702 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': platform.app.local:5173
2025-11-24 11:58:36,702 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-11-24 11:58:36,702 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 11:58:36,703 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-11-24 11:58:36,703 - app.middleware.tenant_middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: 1
2025-11-24 11:58:36,703 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-11-24 11:58:36,703 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=1, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/conexiones/test
2025-11-24 11:58:36,708 - app.api.v1.endpoints.conexiones - INFO - Solicitud POST /conexiones/test recibida para servidor: localhost
2025-11-24 11:58:36,708 - app.services.conexion_service - INFO - Testeando conexión para servidor: localhost
2025-11-24 11:58:36,708 - app.services.conexion_service - INFO - Test de conexión exitoso para localhost
2025-11-24 11:58:36,709 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/conexiones/test 200 7.7ms
2025-11-24 11:58:38,301 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/conexiones/5/
2025-11-24 11:58:38,302 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/conexiones/5/ 200 0.7ms
2025-11-24 11:58:38,303 - app.main - INFO - [SYSTEM] 127.0.0.1 -> PUT /api/v1/conexiones/5/
2025-11-24 11:58:38,304 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 11:58:38,304 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': platform.app.local:5173
2025-11-24 11:58:38,304 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-11-24 11:58:38,304 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 11:58:38,304 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-11-24 11:58:38,304 - app.middleware.tenant_middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: 1
2025-11-24 11:58:38,305 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-11-24 11:58:38,305 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=1, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/conexiones/5/
2025-11-24 11:58:38,309 - app.api.v1.endpoints.conexiones - INFO - Solicitud PUT /conexiones/5 recibida
2025-11-24 11:58:38,309 - app.services.conexion_service - INFO - Actualizando conexión ID: 5
2025-11-24 11:58:38,312 - app.db.queries - INFO - Actualización exitosa, filas afectadas: -1
2025-11-24 11:58:38,313 - app.services.conexion_service - INFO - Conexión ID 5 actualizada exitosamente.
2025-11-24 11:58:38,313 - app.api.v1.endpoints.conexiones - INFO - Conexión 5 actualizada exitosamente
2025-11-24 11:58:38,314 - app.main - INFO - [SYSTEM] 127.0.0.1 <- PUT /api/v1/conexiones/5/ 200 10.4ms
2025-11-24 11:58:38,317 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/conexiones/clientes/4/
2025-11-24 11:58:38,318 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 11:58:38,318 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': platform.app.local:5173
2025-11-24 11:58:38,318 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-11-24 11:58:38,319 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 11:58:38,319 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-11-24 11:58:38,319 - app.middleware.tenant_middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: 1
2025-11-24 11:58:38,319 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-11-24 11:58:38,319 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=1, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/conexiones/clientes/4/
2025-11-24 11:58:38,323 - app.api.v1.endpoints.conexiones - INFO - Solicitud GET /conexiones/clientes/4 recibida
2025-11-24 11:58:38,324 - app.services.conexion_service - INFO - Obteniendo conexiones para cliente ID: 4
2025-11-24 11:58:38,325 - app.api.v1.endpoints.conexiones - INFO - Conexiones recuperadas para cliente 4: 2 conexiones
2025-11-24 11:58:38,326 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/conexiones/clientes/4/ 200 8.5ms
2025-11-24 11:58:55,940 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/usuarios/
2025-11-24 11:58:55,941 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 11:58:55,941 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': acme.app.local:5173
2025-11-24 11:58:55,942 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-11-24 11:58:55,942 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 11:58:55,942 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-11-24 11:58:55,946 - app.middleware.tenant_middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=2
2025-11-24 11:58:55,946 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=multi, bd=bd_cliente_acme, servidor=localhost
2025-11-24 11:58:55,947 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=2, db_type=multi, bd=bd_cliente_acme, path=/api/v1/usuarios/
2025-11-24 11:58:55,948 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:58:55,954 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:58:55,959 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:58:55,964 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:58:55,968 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:58:55,970 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:58:55,971 - app.api.v1.endpoints.usuarios - INFO - Solicitud GET /usuarios/ recibida por usuario 1 del cliente 2 - Paginación: page=1, limit=10, Búsqueda: 'None'
2025-11-24 11:58:55,971 - app.services.usuario_service - INFO - Obteniendo usuarios paginados para cliente 2: page=1, limit=10, search='None'
2025-11-24 11:58:55,972 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:58:55,975 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:58:55,981 - app.services.usuario_service - INFO - Obtención paginada de usuarios completada exitosamente
2025-11-24 11:58:55,982 - app.api.v1.endpoints.usuarios - INFO - Lista paginada de usuarios recuperada para cliente 2 - Total: 3, Página: 1
2025-11-24 11:58:55,983 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/roles/all-active/
2025-11-24 11:58:55,983 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 11:58:55,983 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': acme.app.local:5173
2025-11-24 11:58:55,983 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-11-24 11:58:55,983 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 11:58:55,984 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-11-24 11:58:55,985 - app.middleware.tenant_middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=2
2025-11-24 11:58:55,985 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=multi, bd=bd_cliente_acme, servidor=localhost
2025-11-24 11:58:55,985 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=2, db_type=multi, bd=bd_cliente_acme, path=/api/v1/roles/all-active/
2025-11-24 11:58:55,985 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/usuarios/ 200 45.0ms
2025-11-24 11:58:55,986 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:58:55,986 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:58:55,987 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:58:55,988 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:58:55,989 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:58:55,990 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:58:55,990 - app.api.v1.endpoints.roles - INFO - Solicitud GET /roles/all-active/ recibida por usuario 1 del cliente 2 para lista simple
2025-11-24 11:58:55,991 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:58:55,993 - app.services.rol_service - INFO - Se encontraron 3 roles activos para cliente 2
2025-11-24 11:58:55,993 - app.api.v1.endpoints.roles - INFO - Lista simple de roles activos recuperada para cliente 2 - Total: 3
2025-11-24 11:58:55,994 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/roles/all-active/ 200 11.4ms
2025-11-24 11:58:55,996 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/usuarios/
2025-11-24 11:58:55,997 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 11:58:55,997 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': acme.app.local:5173
2025-11-24 11:58:55,997 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-11-24 11:58:55,997 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 11:58:55,998 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-11-24 11:58:55,999 - app.middleware.tenant_middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=2
2025-11-24 11:58:55,999 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=multi, bd=bd_cliente_acme, servidor=localhost
2025-11-24 11:58:55,999 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=2, db_type=multi, bd=bd_cliente_acme, path=/api/v1/usuarios/
2025-11-24 11:58:56,000 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:58:56,001 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:58:56,002 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:58:56,003 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:58:56,004 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:58:56,004 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:58:56,005 - app.api.v1.endpoints.usuarios - INFO - Solicitud GET /usuarios/ recibida por usuario 1 del cliente 2 - Paginación: page=1, limit=10, Búsqueda: 'None'
2025-11-24 11:58:56,005 - app.services.usuario_service - INFO - Obteniendo usuarios paginados para cliente 2: page=1, limit=10, search='None'
2025-11-24 11:58:56,006 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:58:56,007 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:58:56,009 - app.services.usuario_service - INFO - Obtención paginada de usuarios completada exitosamente
2025-11-24 11:58:56,009 - app.api.v1.endpoints.usuarios - INFO - Lista paginada de usuarios recuperada para cliente 2 - Total: 3, Página: 1
2025-11-24 11:58:56,010 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/roles/all-active/
2025-11-24 11:58:56,011 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 11:58:56,011 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': acme.app.local:5173
2025-11-24 11:58:56,011 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-11-24 11:58:56,011 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 11:58:56,011 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-11-24 11:58:56,013 - app.middleware.tenant_middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=2
2025-11-24 11:58:56,013 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=multi, bd=bd_cliente_acme, servidor=localhost
2025-11-24 11:58:56,013 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=2, db_type=multi, bd=bd_cliente_acme, path=/api/v1/roles/all-active/
2025-11-24 11:58:56,014 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:58:56,015 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:58:56,016 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:58:56,017 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:58:56,018 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:58:56,018 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:58:56,019 - app.api.v1.endpoints.roles - INFO - Solicitud GET /roles/all-active/ recibida por usuario 1 del cliente 2 para lista simple
2025-11-24 11:58:56,019 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:58:56,020 - app.services.rol_service - INFO - Se encontraron 3 roles activos para cliente 2
2025-11-24 11:58:56,020 - app.api.v1.endpoints.roles - INFO - Lista simple de roles activos recuperada para cliente 2 - Total: 3
2025-11-24 11:58:56,021 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/usuarios/ 200 25.2ms
2025-11-24 11:58:56,022 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/roles/all-active/ 200 11.5ms
2025-11-24 11:58:58,108 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/roles/
2025-11-24 11:58:58,109 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 11:58:58,109 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': acme.app.local:5173
2025-11-24 11:58:58,109 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-11-24 11:58:58,109 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 11:58:58,109 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-11-24 11:58:58,110 - app.middleware.tenant_middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=2
2025-11-24 11:58:58,111 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=multi, bd=bd_cliente_acme, servidor=localhost
2025-11-24 11:58:58,111 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=2, db_type=multi, bd=bd_cliente_acme, path=/api/v1/roles/
2025-11-24 11:58:58,112 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:58:58,113 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:58:58,115 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:58:58,116 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:58:58,118 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:58:58,119 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:58:58,121 - app.api.v1.endpoints.roles - INFO - Solicitud GET /roles/ recibida por usuario 1 del cliente 2 - Paginación: page=1, limit=10, Búsqueda: 'None'
2025-11-24 11:58:58,121 - app.services.rol_service - INFO - Obteniendo roles paginados para cliente 2: page=1, limit=10, search='None'
2025-11-24 11:58:58,121 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:58:58,126 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:58:58,131 - app.services.rol_service - INFO - Obtención paginada de roles para cliente 2 completada exitosamente
2025-11-24 11:58:58,132 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/roles/ N/A 23.8ms
2025-11-24 11:58:58,132 - app.core.exceptions - ERROR - Error no manejado: 3 validation errors:
  {'type': 'value_error', 'loc': ('response', 'roles', 0), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 1, 'nombre': 'Administrador', 'descripcion': 'Administrador con acceso completo', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'ADMIN'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
  {'type': 'value_error', 'loc': ('response', 'roles', 1), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 2, 'nombre': 'Supervisor', 'descripcion': 'Supervisor de departamento', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'SUPERVISOR'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
  {'type': 'value_error', 'loc': ('response', 'roles', 2), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 3, 'nombre': 'Usuario', 'descripcion': 'Usuario estándar', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'USER'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
  + Exception Group Traceback (most recent call last):
  |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 76, in collapse_excgroups
  |     yield
  |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 186, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ~~~~~~~~~~~~~~~~~~~~~~~^^
  |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\anyio\_backends\_asyncio.py", line 815, in __aexit__
  |     raise BaseExceptionGroup(
  |         "unhandled errors in a TaskGroup", self._exceptions
  |     )
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\errors.py", line 165, in __call__
    |     await self.app(scope, receive, _send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    |     with collapse_excgroups():
    |          ~~~~~~~~~~~~~~~~~~^^
    |   File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\app\main.py", line 190, in security_headers
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    |     raise app_exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    |     with collapse_excgroups():
    |          ~~~~~~~~~~~~~~~~~~^^
    |   File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\app\main.py", line 181, in log_requests
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    |     raise app_exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    |     with collapse_excgroups():
    |          ~~~~~~~~~~~~~~~~~~^^
    |   File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\app\main.py", line 158, in cors_middleware
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    |     raise app_exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    |     with collapse_excgroups():
    |          ~~~~~~~~~~~~~~~~~~^^
    |   File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\app\middleware\tenant_middleware.py", line 293, in dispatch
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    |     raise app_exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\exceptions.py", line 62, in __call__
    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 715, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 735, in app
    |     await route.handle(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 288, in handle
    |     await self.app(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 76, in app
    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 73, in app
    |     response = await f(request)
    |                ^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\fastapi\routing.py", line 327, in app
    |     content = await serialize_response(
    |               ^^^^^^^^^^^^^^^^^^^^^^^^^
    |     ...<9 lines>...
    |     )
    |     ^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\fastapi\routing.py", line 176, in serialize_response
    |     raise ResponseValidationError(
    |         errors=_normalize_errors(errors), body=response_content
    |     )
    | fastapi.exceptions.ResponseValidationError: 3 validation errors:
    |   {'type': 'value_error', 'loc': ('response', 'roles', 0), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 1, 'nombre': 'Administrador', 'descripcion': 'Administrador con acceso completo', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'ADMIN'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
    |   {'type': 'value_error', 'loc': ('response', 'roles', 1), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 2, 'nombre': 'Supervisor', 'descripcion': 'Supervisor de departamento', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'SUPERVISOR'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
    |   {'type': 'value_error', 'loc': ('response', 'roles', 2), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 3, 'nombre': 'Usuario', 'descripcion': 'Usuario estándar', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'USER'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
    | 
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\errors.py", line 165, in __call__
    await self.app(scope, receive, _send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    with collapse_excgroups():
         ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\main.py", line 190, in security_headers
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    raise app_exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    with collapse_excgroups():
         ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\main.py", line 181, in log_requests
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    raise app_exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    with collapse_excgroups():
         ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\main.py", line 158, in cors_middleware
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    raise app_exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    with collapse_excgroups():
         ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\middleware\tenant_middleware.py", line 293, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    raise app_exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 715, in __call__
    await self.middleware_stack(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 735, in app
    await route.handle(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 288, in handle
    await self.app(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 76, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 73, in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\fastapi\routing.py", line 327, in app
    content = await serialize_response(
              ^^^^^^^^^^^^^^^^^^^^^^^^^
    ...<9 lines>...
    )
    ^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\fastapi\routing.py", line 176, in serialize_response
    raise ResponseValidationError(
        errors=_normalize_errors(errors), body=response_content
    )
fastapi.exceptions.ResponseValidationError: 3 validation errors:
  {'type': 'value_error', 'loc': ('response', 'roles', 0), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 1, 'nombre': 'Administrador', 'descripcion': 'Administrador con acceso completo', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'ADMIN'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
  {'type': 'value_error', 'loc': ('response', 'roles', 1), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 2, 'nombre': 'Supervisor', 'descripcion': 'Supervisor de departamento', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'SUPERVISOR'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
  {'type': 'value_error', 'loc': ('response', 'roles', 2), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 3, 'nombre': 'Usuario', 'descripcion': 'Usuario estándar', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'USER'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}

2025-11-24 11:58:58,157 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/roles/
2025-11-24 11:58:58,158 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 11:58:58,158 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': acme.app.local:5173
2025-11-24 11:58:58,158 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-11-24 11:58:58,158 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 11:58:58,158 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-11-24 11:58:58,159 - app.middleware.tenant_middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=2
2025-11-24 11:58:58,160 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=multi, bd=bd_cliente_acme, servidor=localhost
2025-11-24 11:58:58,160 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=2, db_type=multi, bd=bd_cliente_acme, path=/api/v1/roles/
2025-11-24 11:58:58,160 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:58:58,161 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:58:58,162 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:58:58,163 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:58:58,164 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:58:58,165 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:58:58,166 - app.api.v1.endpoints.roles - INFO - Solicitud GET /roles/ recibida por usuario 1 del cliente 2 - Paginación: page=1, limit=10, Búsqueda: 'None'
2025-11-24 11:58:58,166 - app.services.rol_service - INFO - Obteniendo roles paginados para cliente 2: page=1, limit=10, search='None'
2025-11-24 11:58:58,166 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:58:58,168 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:58:58,170 - app.services.rol_service - INFO - Obtención paginada de roles para cliente 2 completada exitosamente
2025-11-24 11:58:58,171 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/roles/ N/A 13.2ms
2025-11-24 11:58:58,171 - app.core.exceptions - ERROR - Error no manejado: 3 validation errors:
  {'type': 'value_error', 'loc': ('response', 'roles', 0), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 1, 'nombre': 'Administrador', 'descripcion': 'Administrador con acceso completo', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'ADMIN'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
  {'type': 'value_error', 'loc': ('response', 'roles', 1), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 2, 'nombre': 'Supervisor', 'descripcion': 'Supervisor de departamento', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'SUPERVISOR'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
  {'type': 'value_error', 'loc': ('response', 'roles', 2), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 3, 'nombre': 'Usuario', 'descripcion': 'Usuario estándar', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'USER'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
  + Exception Group Traceback (most recent call last):
  |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 76, in collapse_excgroups
  |     yield
  |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 186, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ~~~~~~~~~~~~~~~~~~~~~~~^^
  |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\anyio\_backends\_asyncio.py", line 815, in __aexit__
  |     raise BaseExceptionGroup(
  |         "unhandled errors in a TaskGroup", self._exceptions
  |     )
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\errors.py", line 165, in __call__
    |     await self.app(scope, receive, _send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    |     with collapse_excgroups():
    |          ~~~~~~~~~~~~~~~~~~^^
    |   File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\app\main.py", line 190, in security_headers
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    |     raise app_exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    |     with collapse_excgroups():
    |          ~~~~~~~~~~~~~~~~~~^^
    |   File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\app\main.py", line 181, in log_requests
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    |     raise app_exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    |     with collapse_excgroups():
    |          ~~~~~~~~~~~~~~~~~~^^
    |   File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\app\main.py", line 158, in cors_middleware
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    |     raise app_exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    |     with collapse_excgroups():
    |          ~~~~~~~~~~~~~~~~~~^^
    |   File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\app\middleware\tenant_middleware.py", line 293, in dispatch
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    |     raise app_exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\exceptions.py", line 62, in __call__
    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 715, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 735, in app
    |     await route.handle(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 288, in handle
    |     await self.app(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 76, in app
    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 73, in app
    |     response = await f(request)
    |                ^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\fastapi\routing.py", line 327, in app
    |     content = await serialize_response(
    |               ^^^^^^^^^^^^^^^^^^^^^^^^^
    |     ...<9 lines>...
    |     )
    |     ^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\fastapi\routing.py", line 176, in serialize_response
    |     raise ResponseValidationError(
    |         errors=_normalize_errors(errors), body=response_content
    |     )
    | fastapi.exceptions.ResponseValidationError: 3 validation errors:
    |   {'type': 'value_error', 'loc': ('response', 'roles', 0), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 1, 'nombre': 'Administrador', 'descripcion': 'Administrador con acceso completo', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'ADMIN'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
    |   {'type': 'value_error', 'loc': ('response', 'roles', 1), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 2, 'nombre': 'Supervisor', 'descripcion': 'Supervisor de departamento', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'SUPERVISOR'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
    |   {'type': 'value_error', 'loc': ('response', 'roles', 2), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 3, 'nombre': 'Usuario', 'descripcion': 'Usuario estándar', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'USER'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
    | 
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\errors.py", line 165, in __call__
    await self.app(scope, receive, _send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    with collapse_excgroups():
         ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\main.py", line 190, in security_headers
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    raise app_exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    with collapse_excgroups():
         ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\main.py", line 181, in log_requests
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    raise app_exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    with collapse_excgroups():
         ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\main.py", line 158, in cors_middleware
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    raise app_exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    with collapse_excgroups():
         ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\middleware\tenant_middleware.py", line 293, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    raise app_exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 715, in __call__
    await self.middleware_stack(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 735, in app
    await route.handle(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 288, in handle
    await self.app(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 76, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 73, in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\fastapi\routing.py", line 327, in app
    content = await serialize_response(
              ^^^^^^^^^^^^^^^^^^^^^^^^^
    ...<9 lines>...
    )
    ^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\fastapi\routing.py", line 176, in serialize_response
    raise ResponseValidationError(
        errors=_normalize_errors(errors), body=response_content
    )
fastapi.exceptions.ResponseValidationError: 3 validation errors:
  {'type': 'value_error', 'loc': ('response', 'roles', 0), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 1, 'nombre': 'Administrador', 'descripcion': 'Administrador con acceso completo', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'ADMIN'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
  {'type': 'value_error', 'loc': ('response', 'roles', 1), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 2, 'nombre': 'Supervisor', 'descripcion': 'Supervisor de departamento', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'SUPERVISOR'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
  {'type': 'value_error', 'loc': ('response', 'roles', 2), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 3, 'nombre': 'Usuario', 'descripcion': 'Usuario estándar', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'USER'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}

2025-11-24 11:59:16,269 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/usuarios/
2025-11-24 11:59:16,270 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 11:59:16,270 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': acme.app.local:5173
2025-11-24 11:59:16,270 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-11-24 11:59:16,270 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 11:59:16,270 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-11-24 11:59:16,272 - app.middleware.tenant_middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=2
2025-11-24 11:59:16,272 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=multi, bd=bd_cliente_acme, servidor=localhost
2025-11-24 11:59:16,272 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=2, db_type=multi, bd=bd_cliente_acme, path=/api/v1/usuarios/
2025-11-24 11:59:16,273 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:59:16,275 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:59:16,276 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:59:16,277 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:59:16,278 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:59:16,279 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:59:16,281 - app.api.v1.endpoints.usuarios - INFO - Solicitud GET /usuarios/ recibida por usuario 1 del cliente 2 - Paginación: page=1, limit=10, Búsqueda: 'None'
2025-11-24 11:59:16,281 - app.services.usuario_service - INFO - Obteniendo usuarios paginados para cliente 2: page=1, limit=10, search='None'
2025-11-24 11:59:16,281 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:59:16,284 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:59:16,287 - app.services.usuario_service - INFO - Obtención paginada de usuarios completada exitosamente
2025-11-24 11:59:16,287 - app.api.v1.endpoints.usuarios - INFO - Lista paginada de usuarios recuperada para cliente 2 - Total: 3, Página: 1
2025-11-24 11:59:16,288 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/roles/all-active/
2025-11-24 11:59:16,288 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 11:59:16,288 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': acme.app.local:5173
2025-11-24 11:59:16,289 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-11-24 11:59:16,289 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 11:59:16,289 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-11-24 11:59:16,290 - app.middleware.tenant_middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=2
2025-11-24 11:59:16,290 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=multi, bd=bd_cliente_acme, servidor=localhost
2025-11-24 11:59:16,290 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=2, db_type=multi, bd=bd_cliente_acme, path=/api/v1/roles/all-active/
2025-11-24 11:59:16,291 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/usuarios/ 200 21.9ms
2025-11-24 11:59:16,291 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:59:16,292 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:59:16,293 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:59:16,294 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:59:16,294 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:59:16,295 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:59:16,296 - app.api.v1.endpoints.roles - INFO - Solicitud GET /roles/all-active/ recibida por usuario 1 del cliente 2 para lista simple
2025-11-24 11:59:16,296 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:59:16,297 - app.services.rol_service - INFO - Se encontraron 3 roles activos para cliente 2
2025-11-24 11:59:16,297 - app.api.v1.endpoints.roles - INFO - Lista simple de roles activos recuperada para cliente 2 - Total: 3
2025-11-24 11:59:16,299 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/roles/all-active/ 200 11.1ms
2025-11-24 11:59:16,301 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/usuarios/
2025-11-24 11:59:16,301 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 11:59:16,302 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': acme.app.local:5173
2025-11-24 11:59:16,302 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-11-24 11:59:16,302 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 11:59:16,302 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-11-24 11:59:16,303 - app.middleware.tenant_middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=2
2025-11-24 11:59:16,303 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=multi, bd=bd_cliente_acme, servidor=localhost
2025-11-24 11:59:16,303 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=2, db_type=multi, bd=bd_cliente_acme, path=/api/v1/usuarios/
2025-11-24 11:59:16,304 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:59:16,305 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:59:16,306 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:59:16,310 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:59:16,311 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:59:16,312 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:59:16,313 - app.api.v1.endpoints.usuarios - INFO - Solicitud GET /usuarios/ recibida por usuario 1 del cliente 2 - Paginación: page=1, limit=10, Búsqueda: 'None'
2025-11-24 11:59:16,313 - app.services.usuario_service - INFO - Obteniendo usuarios paginados para cliente 2: page=1, limit=10, search='None'
2025-11-24 11:59:16,313 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:59:16,315 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:59:16,318 - app.services.usuario_service - INFO - Obtención paginada de usuarios completada exitosamente
2025-11-24 11:59:16,318 - app.api.v1.endpoints.usuarios - INFO - Lista paginada de usuarios recuperada para cliente 2 - Total: 3, Página: 1
2025-11-24 11:59:16,319 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/roles/all-active/
2025-11-24 11:59:16,320 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 11:59:16,320 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': acme.app.local:5173
2025-11-24 11:59:16,320 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-11-24 11:59:16,320 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 11:59:16,320 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-11-24 11:59:16,321 - app.middleware.tenant_middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=2
2025-11-24 11:59:16,321 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=multi, bd=bd_cliente_acme, servidor=localhost
2025-11-24 11:59:16,321 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=2, db_type=multi, bd=bd_cliente_acme, path=/api/v1/roles/all-active/
2025-11-24 11:59:16,322 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/usuarios/ 200 21.1ms
2025-11-24 11:59:16,322 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:59:16,323 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:59:16,325 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:59:16,326 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:59:16,327 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:59:16,328 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:59:16,328 - app.api.v1.endpoints.roles - INFO - Solicitud GET /roles/all-active/ recibida por usuario 1 del cliente 2 para lista simple
2025-11-24 11:59:16,328 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:59:16,329 - app.services.rol_service - INFO - Se encontraron 3 roles activos para cliente 2
2025-11-24 11:59:16,329 - app.api.v1.endpoints.roles - INFO - Lista simple de roles activos recuperada para cliente 2 - Total: 3
2025-11-24 11:59:16,331 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/roles/all-active/ 200 12.0ms
2025-11-24 11:59:26,821 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/roles/
2025-11-24 11:59:26,821 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 11:59:26,822 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': acme.app.local:5173
2025-11-24 11:59:26,822 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-11-24 11:59:26,822 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 11:59:26,822 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-11-24 11:59:26,825 - app.middleware.tenant_middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=2
2025-11-24 11:59:26,825 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=multi, bd=bd_cliente_acme, servidor=localhost
2025-11-24 11:59:26,826 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=2, db_type=multi, bd=bd_cliente_acme, path=/api/v1/roles/
2025-11-24 11:59:26,826 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:59:26,828 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:59:26,829 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:59:26,831 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:59:26,832 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:59:26,832 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:59:26,834 - app.api.v1.endpoints.roles - INFO - Solicitud GET /roles/ recibida por usuario 1 del cliente 2 - Paginación: page=1, limit=10, Búsqueda: 'None'
2025-11-24 11:59:26,834 - app.services.rol_service - INFO - Obteniendo roles paginados para cliente 2: page=1, limit=10, search='None'
2025-11-24 11:59:26,834 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:59:26,836 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:59:26,838 - app.services.rol_service - INFO - Obtención paginada de roles para cliente 2 completada exitosamente
2025-11-24 11:59:26,838 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/roles/ N/A 17.6ms
2025-11-24 11:59:26,839 - app.core.exceptions - ERROR - Error no manejado: 3 validation errors:
  {'type': 'value_error', 'loc': ('response', 'roles', 0), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 1, 'nombre': 'Administrador', 'descripcion': 'Administrador con acceso completo', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'ADMIN'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
  {'type': 'value_error', 'loc': ('response', 'roles', 1), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 2, 'nombre': 'Supervisor', 'descripcion': 'Supervisor de departamento', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'SUPERVISOR'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
  {'type': 'value_error', 'loc': ('response', 'roles', 2), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 3, 'nombre': 'Usuario', 'descripcion': 'Usuario estándar', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'USER'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
  + Exception Group Traceback (most recent call last):
  |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 76, in collapse_excgroups
  |     yield
  |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 186, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ~~~~~~~~~~~~~~~~~~~~~~~^^
  |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\anyio\_backends\_asyncio.py", line 815, in __aexit__
  |     raise BaseExceptionGroup(
  |         "unhandled errors in a TaskGroup", self._exceptions
  |     )
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\errors.py", line 165, in __call__
    |     await self.app(scope, receive, _send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    |     with collapse_excgroups():
    |          ~~~~~~~~~~~~~~~~~~^^
    |   File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\app\main.py", line 190, in security_headers
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    |     raise app_exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    |     with collapse_excgroups():
    |          ~~~~~~~~~~~~~~~~~~^^
    |   File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\app\main.py", line 181, in log_requests
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    |     raise app_exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    |     with collapse_excgroups():
    |          ~~~~~~~~~~~~~~~~~~^^
    |   File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\app\main.py", line 158, in cors_middleware
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    |     raise app_exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    |     with collapse_excgroups():
    |          ~~~~~~~~~~~~~~~~~~^^
    |   File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\app\middleware\tenant_middleware.py", line 293, in dispatch
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    |     raise app_exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\exceptions.py", line 62, in __call__
    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 715, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 735, in app
    |     await route.handle(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 288, in handle
    |     await self.app(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 76, in app
    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 73, in app
    |     response = await f(request)
    |                ^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\fastapi\routing.py", line 327, in app
    |     content = await serialize_response(
    |               ^^^^^^^^^^^^^^^^^^^^^^^^^
    |     ...<9 lines>...
    |     )
    |     ^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\fastapi\routing.py", line 176, in serialize_response
    |     raise ResponseValidationError(
    |         errors=_normalize_errors(errors), body=response_content
    |     )
    | fastapi.exceptions.ResponseValidationError: 3 validation errors:
    |   {'type': 'value_error', 'loc': ('response', 'roles', 0), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 1, 'nombre': 'Administrador', 'descripcion': 'Administrador con acceso completo', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'ADMIN'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
    |   {'type': 'value_error', 'loc': ('response', 'roles', 1), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 2, 'nombre': 'Supervisor', 'descripcion': 'Supervisor de departamento', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'SUPERVISOR'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
    |   {'type': 'value_error', 'loc': ('response', 'roles', 2), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 3, 'nombre': 'Usuario', 'descripcion': 'Usuario estándar', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'USER'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
    | 
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\errors.py", line 165, in __call__
    await self.app(scope, receive, _send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    with collapse_excgroups():
         ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\main.py", line 190, in security_headers
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    raise app_exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    with collapse_excgroups():
         ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\main.py", line 181, in log_requests
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    raise app_exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    with collapse_excgroups():
         ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\main.py", line 158, in cors_middleware
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    raise app_exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    with collapse_excgroups():
         ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\middleware\tenant_middleware.py", line 293, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    raise app_exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 715, in __call__
    await self.middleware_stack(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 735, in app
    await route.handle(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 288, in handle
    await self.app(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 76, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 73, in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\fastapi\routing.py", line 327, in app
    content = await serialize_response(
              ^^^^^^^^^^^^^^^^^^^^^^^^^
    ...<9 lines>...
    )
    ^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\fastapi\routing.py", line 176, in serialize_response
    raise ResponseValidationError(
        errors=_normalize_errors(errors), body=response_content
    )
fastapi.exceptions.ResponseValidationError: 3 validation errors:
  {'type': 'value_error', 'loc': ('response', 'roles', 0), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 1, 'nombre': 'Administrador', 'descripcion': 'Administrador con acceso completo', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'ADMIN'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
  {'type': 'value_error', 'loc': ('response', 'roles', 1), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 2, 'nombre': 'Supervisor', 'descripcion': 'Supervisor de departamento', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'SUPERVISOR'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
  {'type': 'value_error', 'loc': ('response', 'roles', 2), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 3, 'nombre': 'Usuario', 'descripcion': 'Usuario estándar', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'USER'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}

2025-11-24 11:59:26,864 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/roles/
2025-11-24 11:59:26,864 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 11:59:26,864 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': acme.app.local:5173
2025-11-24 11:59:26,864 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-11-24 11:59:26,865 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 11:59:26,865 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-11-24 11:59:26,866 - app.middleware.tenant_middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=2
2025-11-24 11:59:26,866 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=multi, bd=bd_cliente_acme, servidor=localhost
2025-11-24 11:59:26,866 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=2, db_type=multi, bd=bd_cliente_acme, path=/api/v1/roles/
2025-11-24 11:59:26,867 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:59:26,868 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:59:26,869 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:59:26,870 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:59:26,871 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:59:26,872 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:59:26,872 - app.api.v1.endpoints.roles - INFO - Solicitud GET /roles/ recibida por usuario 1 del cliente 2 - Paginación: page=1, limit=10, Búsqueda: 'None'
2025-11-24 11:59:26,873 - app.services.rol_service - INFO - Obteniendo roles paginados para cliente 2: page=1, limit=10, search='None'
2025-11-24 11:59:26,873 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:59:26,875 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 11:59:26,877 - app.services.rol_service - INFO - Obtención paginada de roles para cliente 2 completada exitosamente
2025-11-24 11:59:26,878 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/roles/ N/A 14.3ms
2025-11-24 11:59:26,878 - app.core.exceptions - ERROR - Error no manejado: 3 validation errors:
  {'type': 'value_error', 'loc': ('response', 'roles', 0), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 1, 'nombre': 'Administrador', 'descripcion': 'Administrador con acceso completo', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'ADMIN'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
  {'type': 'value_error', 'loc': ('response', 'roles', 1), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 2, 'nombre': 'Supervisor', 'descripcion': 'Supervisor de departamento', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'SUPERVISOR'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
  {'type': 'value_error', 'loc': ('response', 'roles', 2), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 3, 'nombre': 'Usuario', 'descripcion': 'Usuario estándar', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'USER'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
  + Exception Group Traceback (most recent call last):
  |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 76, in collapse_excgroups
  |     yield
  |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 186, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ~~~~~~~~~~~~~~~~~~~~~~~^^
  |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\anyio\_backends\_asyncio.py", line 815, in __aexit__
  |     raise BaseExceptionGroup(
  |         "unhandled errors in a TaskGroup", self._exceptions
  |     )
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\errors.py", line 165, in __call__
    |     await self.app(scope, receive, _send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    |     with collapse_excgroups():
    |          ~~~~~~~~~~~~~~~~~~^^
    |   File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\app\main.py", line 190, in security_headers
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    |     raise app_exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    |     with collapse_excgroups():
    |          ~~~~~~~~~~~~~~~~~~^^
    |   File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\app\main.py", line 181, in log_requests
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    |     raise app_exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    |     with collapse_excgroups():
    |          ~~~~~~~~~~~~~~~~~~^^
    |   File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\app\main.py", line 158, in cors_middleware
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    |     raise app_exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    |     with collapse_excgroups():
    |          ~~~~~~~~~~~~~~~~~~^^
    |   File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\app\middleware\tenant_middleware.py", line 293, in dispatch
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    |     raise app_exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\exceptions.py", line 62, in __call__
    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 715, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 735, in app
    |     await route.handle(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 288, in handle
    |     await self.app(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 76, in app
    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 73, in app
    |     response = await f(request)
    |                ^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\fastapi\routing.py", line 327, in app
    |     content = await serialize_response(
    |               ^^^^^^^^^^^^^^^^^^^^^^^^^
    |     ...<9 lines>...
    |     )
    |     ^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\fastapi\routing.py", line 176, in serialize_response
    |     raise ResponseValidationError(
    |         errors=_normalize_errors(errors), body=response_content
    |     )
    | fastapi.exceptions.ResponseValidationError: 3 validation errors:
    |   {'type': 'value_error', 'loc': ('response', 'roles', 0), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 1, 'nombre': 'Administrador', 'descripcion': 'Administrador con acceso completo', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'ADMIN'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
    |   {'type': 'value_error', 'loc': ('response', 'roles', 1), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 2, 'nombre': 'Supervisor', 'descripcion': 'Supervisor de departamento', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'SUPERVISOR'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
    |   {'type': 'value_error', 'loc': ('response', 'roles', 2), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 3, 'nombre': 'Usuario', 'descripcion': 'Usuario estándar', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'USER'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
    | 
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\errors.py", line 165, in __call__
    await self.app(scope, receive, _send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    with collapse_excgroups():
         ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\main.py", line 190, in security_headers
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    raise app_exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    with collapse_excgroups():
         ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\main.py", line 181, in log_requests
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    raise app_exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    with collapse_excgroups():
         ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\main.py", line 158, in cors_middleware
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    raise app_exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    with collapse_excgroups():
         ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\middleware\tenant_middleware.py", line 293, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    raise app_exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 715, in __call__
    await self.middleware_stack(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 735, in app
    await route.handle(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 288, in handle
    await self.app(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 76, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 73, in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\fastapi\routing.py", line 327, in app
    content = await serialize_response(
              ^^^^^^^^^^^^^^^^^^^^^^^^^
    ...<9 lines>...
    )
    ^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\fastapi\routing.py", line 176, in serialize_response
    raise ResponseValidationError(
        errors=_normalize_errors(errors), body=response_content
    )
fastapi.exceptions.ResponseValidationError: 3 validation errors:
  {'type': 'value_error', 'loc': ('response', 'roles', 0), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 1, 'nombre': 'Administrador', 'descripcion': 'Administrador con acceso completo', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'ADMIN'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
  {'type': 'value_error', 'loc': ('response', 'roles', 1), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 2, 'nombre': 'Supervisor', 'descripcion': 'Supervisor de departamento', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'SUPERVISOR'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
  {'type': 'value_error', 'loc': ('response', 'roles', 2), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 3, 'nombre': 'Usuario', 'descripcion': 'Usuario estándar', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'USER'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}

2025-11-24 12:01:42,271 - app.middleware.tenant_middleware - INFO - [TENANT_MW] Inicializado - BASE_DOMAIN=app.local, SYSTEM_ID=1, EXCLUDED_SUBDOMAINS={'api', 'backend', 'cdn', 'assets', 'static', 'www', 'admin'}
2025-11-24 12:01:44,366 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/usuarios/
2025-11-24 12:01:44,368 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 12:01:44,368 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': acme.app.local:5173
2025-11-24 12:01:44,368 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-11-24 12:01:44,369 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 12:01:44,369 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-11-24 12:01:44,425 - app.middleware.tenant_middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=2
2025-11-24 12:01:44,434 - app.core.multi_db - INFO - [METADATA] Metadata cargada para cliente 2: multi - bd_cliente_acme
2025-11-24 12:01:44,434 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=multi, bd=bd_cliente_acme, servidor=localhost
2025-11-24 12:01:44,434 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=2, db_type=multi, bd=bd_cliente_acme, path=/api/v1/usuarios/
2025-11-24 12:01:44,435 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/roles/all-active/
2025-11-24 12:01:44,438 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:01:44,467 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:01:44,475 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:01:44,477 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:01:44,481 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:01:44,484 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:01:44,485 - app.api.v1.endpoints.usuarios - INFO - Solicitud GET /usuarios/ recibida por usuario 1 del cliente 2 - Paginación: page=1, limit=10, Búsqueda: 'None'
2025-11-24 12:01:44,485 - app.services.usuario_service - INFO - Obteniendo usuarios paginados para cliente 2: page=1, limit=10, search='None'
2025-11-24 12:01:44,485 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:01:44,492 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:01:44,498 - app.services.usuario_service - INFO - Obtención paginada de usuarios completada exitosamente
2025-11-24 12:01:44,499 - app.api.v1.endpoints.usuarios - INFO - Lista paginada de usuarios recuperada para cliente 2 - Total: 3, Página: 1
2025-11-24 12:01:44,499 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 12:01:44,500 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': acme.app.local:5173
2025-11-24 12:01:44,500 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-11-24 12:01:44,500 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 12:01:44,500 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-11-24 12:01:44,501 - app.middleware.tenant_middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=2
2025-11-24 12:01:44,501 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=multi, bd=bd_cliente_acme, servidor=localhost
2025-11-24 12:01:44,501 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=2, db_type=multi, bd=bd_cliente_acme, path=/api/v1/roles/all-active/
2025-11-24 12:01:44,502 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:01:44,503 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:01:44,504 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:01:44,505 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:01:44,507 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:01:44,508 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:01:44,509 - app.api.v1.endpoints.roles - INFO - Solicitud GET /roles/all-active/ recibida por usuario 1 del cliente 2 para lista simple
2025-11-24 12:01:44,509 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:01:44,512 - app.services.rol_service - INFO - Se encontraron 3 roles activos para cliente 2
2025-11-24 12:01:44,512 - app.api.v1.endpoints.roles - INFO - Lista simple de roles activos recuperada para cliente 2 - Total: 3
2025-11-24 12:01:44,513 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/usuarios/ 200 146.4ms
2025-11-24 12:01:44,514 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/roles/all-active/ 200 78.6ms
2025-11-24 12:01:44,516 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/usuarios/
2025-11-24 12:01:44,517 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 12:01:44,517 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': acme.app.local:5173
2025-11-24 12:01:44,517 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-11-24 12:01:44,517 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 12:01:44,517 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-11-24 12:01:44,518 - app.middleware.tenant_middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=2
2025-11-24 12:01:44,519 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=multi, bd=bd_cliente_acme, servidor=localhost
2025-11-24 12:01:44,519 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=2, db_type=multi, bd=bd_cliente_acme, path=/api/v1/usuarios/
2025-11-24 12:01:44,520 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:01:44,521 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:01:44,523 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:01:44,524 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:01:44,525 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:01:44,526 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:01:44,527 - app.api.v1.endpoints.usuarios - INFO - Solicitud GET /usuarios/ recibida por usuario 1 del cliente 2 - Paginación: page=1, limit=10, Búsqueda: 'None'
2025-11-24 12:01:44,527 - app.services.usuario_service - INFO - Obteniendo usuarios paginados para cliente 2: page=1, limit=10, search='None'
2025-11-24 12:01:44,527 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:01:44,529 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:01:44,531 - app.services.usuario_service - INFO - Obtención paginada de usuarios completada exitosamente
2025-11-24 12:01:44,532 - app.api.v1.endpoints.usuarios - INFO - Lista paginada de usuarios recuperada para cliente 2 - Total: 3, Página: 1
2025-11-24 12:01:44,532 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/roles/all-active/
2025-11-24 12:01:44,533 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 12:01:44,533 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': acme.app.local:5173
2025-11-24 12:01:44,533 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-11-24 12:01:44,533 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 12:01:44,533 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-11-24 12:01:44,534 - app.middleware.tenant_middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=2
2025-11-24 12:01:44,535 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=multi, bd=bd_cliente_acme, servidor=localhost
2025-11-24 12:01:44,535 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=2, db_type=multi, bd=bd_cliente_acme, path=/api/v1/roles/all-active/
2025-11-24 12:01:44,536 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:01:44,536 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:01:44,538 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:01:44,539 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:01:44,540 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:01:44,542 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:01:44,542 - app.api.v1.endpoints.roles - INFO - Solicitud GET /roles/all-active/ recibida por usuario 1 del cliente 2 para lista simple
2025-11-24 12:01:44,543 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:01:44,543 - app.services.rol_service - INFO - Se encontraron 3 roles activos para cliente 2
2025-11-24 12:01:44,544 - app.api.v1.endpoints.roles - INFO - Lista simple de roles activos recuperada para cliente 2 - Total: 3
2025-11-24 12:01:44,544 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/usuarios/ 200 28.4ms
2025-11-24 12:01:44,545 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/roles/all-active/ 200 12.8ms
2025-11-24 12:02:25,298 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/roles/
2025-11-24 12:02:25,298 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 12:02:25,299 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': acme.app.local:5173
2025-11-24 12:02:25,299 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-11-24 12:02:25,299 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 12:02:25,299 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-11-24 12:02:25,303 - app.middleware.tenant_middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=2
2025-11-24 12:02:25,303 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=multi, bd=bd_cliente_acme, servidor=localhost
2025-11-24 12:02:25,303 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=2, db_type=multi, bd=bd_cliente_acme, path=/api/v1/roles/
2025-11-24 12:02:25,304 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:02:25,309 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:02:25,317 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:02:25,318 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:02:25,323 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:02:25,329 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:02:25,330 - app.api.v1.endpoints.roles - INFO - Solicitud GET /roles/ recibida por usuario 1 del cliente 2 - Paginación: page=1, limit=10, Búsqueda: 'None'
2025-11-24 12:02:25,330 - app.services.rol_service - INFO - Obteniendo roles paginados para cliente 2: page=1, limit=10, search='None'
2025-11-24 12:02:25,331 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:02:25,335 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:02:25,340 - app.services.rol_service - INFO - Obtención paginada de roles para cliente 2 completada exitosamente
2025-11-24 12:02:25,341 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/roles/ N/A 43.1ms
2025-11-24 12:02:25,341 - app.core.exceptions - ERROR - Error no manejado: 3 validation errors:
  {'type': 'value_error', 'loc': ('response', 'roles', 0), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 1, 'nombre': 'Administrador', 'descripcion': 'Administrador con acceso completo', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'ADMIN'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
  {'type': 'value_error', 'loc': ('response', 'roles', 1), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 2, 'nombre': 'Supervisor', 'descripcion': 'Supervisor de departamento', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'SUPERVISOR'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
  {'type': 'value_error', 'loc': ('response', 'roles', 2), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 3, 'nombre': 'Usuario', 'descripcion': 'Usuario estándar', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'USER'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
  + Exception Group Traceback (most recent call last):
  |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 76, in collapse_excgroups
  |     yield
  |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 186, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ~~~~~~~~~~~~~~~~~~~~~~~^^
  |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\anyio\_backends\_asyncio.py", line 815, in __aexit__
  |     raise BaseExceptionGroup(
  |         "unhandled errors in a TaskGroup", self._exceptions
  |     )
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\errors.py", line 165, in __call__
    |     await self.app(scope, receive, _send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    |     with collapse_excgroups():
    |          ~~~~~~~~~~~~~~~~~~^^
    |   File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\app\main.py", line 190, in security_headers
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    |     raise app_exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    |     with collapse_excgroups():
    |          ~~~~~~~~~~~~~~~~~~^^
    |   File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\app\main.py", line 181, in log_requests
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    |     raise app_exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    |     with collapse_excgroups():
    |          ~~~~~~~~~~~~~~~~~~^^
    |   File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\app\main.py", line 158, in cors_middleware
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    |     raise app_exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    |     with collapse_excgroups():
    |          ~~~~~~~~~~~~~~~~~~^^
    |   File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\app\middleware\tenant_middleware.py", line 293, in dispatch
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    |     raise app_exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\exceptions.py", line 62, in __call__
    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 715, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 735, in app
    |     await route.handle(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 288, in handle
    |     await self.app(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 76, in app
    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 73, in app
    |     response = await f(request)
    |                ^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\fastapi\routing.py", line 327, in app
    |     content = await serialize_response(
    |               ^^^^^^^^^^^^^^^^^^^^^^^^^
    |     ...<9 lines>...
    |     )
    |     ^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\fastapi\routing.py", line 176, in serialize_response
    |     raise ResponseValidationError(
    |         errors=_normalize_errors(errors), body=response_content
    |     )
    | fastapi.exceptions.ResponseValidationError: 3 validation errors:
    |   {'type': 'value_error', 'loc': ('response', 'roles', 0), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 1, 'nombre': 'Administrador', 'descripcion': 'Administrador con acceso completo', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'ADMIN'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
    |   {'type': 'value_error', 'loc': ('response', 'roles', 1), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 2, 'nombre': 'Supervisor', 'descripcion': 'Supervisor de departamento', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'SUPERVISOR'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
    |   {'type': 'value_error', 'loc': ('response', 'roles', 2), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 3, 'nombre': 'Usuario', 'descripcion': 'Usuario estándar', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'USER'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
    | 
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\errors.py", line 165, in __call__
    await self.app(scope, receive, _send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    with collapse_excgroups():
         ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\main.py", line 190, in security_headers
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    raise app_exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    with collapse_excgroups():
         ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\main.py", line 181, in log_requests
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    raise app_exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    with collapse_excgroups():
         ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\main.py", line 158, in cors_middleware
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    raise app_exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    with collapse_excgroups():
         ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\middleware\tenant_middleware.py", line 293, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    raise app_exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 715, in __call__
    await self.middleware_stack(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 735, in app
    await route.handle(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 288, in handle
    await self.app(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 76, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 73, in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\fastapi\routing.py", line 327, in app
    content = await serialize_response(
              ^^^^^^^^^^^^^^^^^^^^^^^^^
    ...<9 lines>...
    )
    ^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\fastapi\routing.py", line 176, in serialize_response
    raise ResponseValidationError(
        errors=_normalize_errors(errors), body=response_content
    )
fastapi.exceptions.ResponseValidationError: 3 validation errors:
  {'type': 'value_error', 'loc': ('response', 'roles', 0), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 1, 'nombre': 'Administrador', 'descripcion': 'Administrador con acceso completo', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'ADMIN'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
  {'type': 'value_error', 'loc': ('response', 'roles', 1), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 2, 'nombre': 'Supervisor', 'descripcion': 'Supervisor de departamento', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'SUPERVISOR'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
  {'type': 'value_error', 'loc': ('response', 'roles', 2), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 3, 'nombre': 'Usuario', 'descripcion': 'Usuario estándar', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'USER'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}

2025-11-24 12:02:25,377 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/roles/
2025-11-24 12:02:25,378 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 12:02:25,378 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': acme.app.local:5173
2025-11-24 12:02:25,378 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-11-24 12:02:25,379 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 12:02:25,379 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-11-24 12:02:25,381 - app.middleware.tenant_middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=2
2025-11-24 12:02:25,381 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=multi, bd=bd_cliente_acme, servidor=localhost
2025-11-24 12:02:25,382 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=2, db_type=multi, bd=bd_cliente_acme, path=/api/v1/roles/
2025-11-24 12:02:25,383 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:02:25,384 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:02:25,385 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:02:25,386 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:02:25,387 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:02:25,389 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:02:25,390 - app.api.v1.endpoints.roles - INFO - Solicitud GET /roles/ recibida por usuario 1 del cliente 2 - Paginación: page=1, limit=10, Búsqueda: 'None'
2025-11-24 12:02:25,390 - app.services.rol_service - INFO - Obteniendo roles paginados para cliente 2: page=1, limit=10, search='None'
2025-11-24 12:02:25,390 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:02:25,393 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:02:25,395 - app.services.rol_service - INFO - Obtención paginada de roles para cliente 2 completada exitosamente
2025-11-24 12:02:25,396 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/roles/ N/A 18.5ms
2025-11-24 12:02:25,396 - app.core.exceptions - ERROR - Error no manejado: 3 validation errors:
  {'type': 'value_error', 'loc': ('response', 'roles', 0), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 1, 'nombre': 'Administrador', 'descripcion': 'Administrador con acceso completo', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'ADMIN'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
  {'type': 'value_error', 'loc': ('response', 'roles', 1), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 2, 'nombre': 'Supervisor', 'descripcion': 'Supervisor de departamento', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'SUPERVISOR'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
  {'type': 'value_error', 'loc': ('response', 'roles', 2), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 3, 'nombre': 'Usuario', 'descripcion': 'Usuario estándar', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'USER'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
  + Exception Group Traceback (most recent call last):
  |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 76, in collapse_excgroups
  |     yield
  |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 186, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ~~~~~~~~~~~~~~~~~~~~~~~^^
  |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\anyio\_backends\_asyncio.py", line 815, in __aexit__
  |     raise BaseExceptionGroup(
  |         "unhandled errors in a TaskGroup", self._exceptions
  |     )
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\errors.py", line 165, in __call__
    |     await self.app(scope, receive, _send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    |     with collapse_excgroups():
    |          ~~~~~~~~~~~~~~~~~~^^
    |   File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\app\main.py", line 190, in security_headers
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    |     raise app_exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    |     with collapse_excgroups():
    |          ~~~~~~~~~~~~~~~~~~^^
    |   File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\app\main.py", line 181, in log_requests
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    |     raise app_exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    |     with collapse_excgroups():
    |          ~~~~~~~~~~~~~~~~~~^^
    |   File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\app\main.py", line 158, in cors_middleware
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    |     raise app_exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    |     with collapse_excgroups():
    |          ~~~~~~~~~~~~~~~~~~^^
    |   File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\app\middleware\tenant_middleware.py", line 293, in dispatch
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    |     raise app_exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\exceptions.py", line 62, in __call__
    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 715, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 735, in app
    |     await route.handle(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 288, in handle
    |     await self.app(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 76, in app
    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 73, in app
    |     response = await f(request)
    |                ^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\fastapi\routing.py", line 327, in app
    |     content = await serialize_response(
    |               ^^^^^^^^^^^^^^^^^^^^^^^^^
    |     ...<9 lines>...
    |     )
    |     ^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\fastapi\routing.py", line 176, in serialize_response
    |     raise ResponseValidationError(
    |         errors=_normalize_errors(errors), body=response_content
    |     )
    | fastapi.exceptions.ResponseValidationError: 3 validation errors:
    |   {'type': 'value_error', 'loc': ('response', 'roles', 0), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 1, 'nombre': 'Administrador', 'descripcion': 'Administrador con acceso completo', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'ADMIN'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
    |   {'type': 'value_error', 'loc': ('response', 'roles', 1), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 2, 'nombre': 'Supervisor', 'descripcion': 'Supervisor de departamento', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'SUPERVISOR'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
    |   {'type': 'value_error', 'loc': ('response', 'roles', 2), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 3, 'nombre': 'Usuario', 'descripcion': 'Usuario estándar', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'USER'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
    | 
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\errors.py", line 165, in __call__
    await self.app(scope, receive, _send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    with collapse_excgroups():
         ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\main.py", line 190, in security_headers
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    raise app_exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    with collapse_excgroups():
         ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\main.py", line 181, in log_requests
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    raise app_exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    with collapse_excgroups():
         ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\main.py", line 158, in cors_middleware
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    raise app_exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    with collapse_excgroups():
         ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\middleware\tenant_middleware.py", line 293, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    raise app_exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 715, in __call__
    await self.middleware_stack(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 735, in app
    await route.handle(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 288, in handle
    await self.app(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 76, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 73, in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\fastapi\routing.py", line 327, in app
    content = await serialize_response(
              ^^^^^^^^^^^^^^^^^^^^^^^^^
    ...<9 lines>...
    )
    ^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\fastapi\routing.py", line 176, in serialize_response
    raise ResponseValidationError(
        errors=_normalize_errors(errors), body=response_content
    )
fastapi.exceptions.ResponseValidationError: 3 validation errors:
  {'type': 'value_error', 'loc': ('response', 'roles', 0), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 1, 'nombre': 'Administrador', 'descripcion': 'Administrador con acceso completo', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'ADMIN'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
  {'type': 'value_error', 'loc': ('response', 'roles', 1), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 2, 'nombre': 'Supervisor', 'descripcion': 'Supervisor de departamento', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'SUPERVISOR'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
  {'type': 'value_error', 'loc': ('response', 'roles', 2), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 3, 'nombre': 'Usuario', 'descripcion': 'Usuario estándar', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'USER'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}

2025-11-24 12:04:03,669 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/usuarios/
2025-11-24 12:04:03,670 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 12:04:03,671 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': acme.app.local:5173
2025-11-24 12:04:03,671 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-11-24 12:04:03,671 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 12:04:03,671 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-11-24 12:04:03,688 - app.middleware.tenant_middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=2
2025-11-24 12:04:03,688 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=multi, bd=bd_cliente_acme, servidor=localhost
2025-11-24 12:04:03,689 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=2, db_type=multi, bd=bd_cliente_acme, path=/api/v1/usuarios/
2025-11-24 12:04:03,690 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:04:03,700 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:04:03,706 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:04:03,707 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:04:03,711 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:04:03,714 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:04:03,715 - app.api.v1.endpoints.usuarios - INFO - Solicitud GET /usuarios/ recibida por usuario 1 del cliente 2 - Paginación: page=1, limit=10, Búsqueda: 'None'
2025-11-24 12:04:03,715 - app.services.usuario_service - INFO - Obteniendo usuarios paginados para cliente 2: page=1, limit=10, search='None'
2025-11-24 12:04:03,716 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:04:03,721 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:04:03,728 - app.services.usuario_service - INFO - Obtención paginada de usuarios completada exitosamente
2025-11-24 12:04:03,728 - app.api.v1.endpoints.usuarios - INFO - Lista paginada de usuarios recuperada para cliente 2 - Total: 3, Página: 1
2025-11-24 12:04:03,729 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/roles/all-active/
2025-11-24 12:04:03,729 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 12:04:03,729 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': acme.app.local:5173
2025-11-24 12:04:03,729 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-11-24 12:04:03,729 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 12:04:03,730 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-11-24 12:04:03,736 - app.middleware.tenant_middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=2
2025-11-24 12:04:03,737 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=multi, bd=bd_cliente_acme, servidor=localhost
2025-11-24 12:04:03,737 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=2, db_type=multi, bd=bd_cliente_acme, path=/api/v1/roles/all-active/
2025-11-24 12:04:03,738 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:04:03,740 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:04:03,741 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:04:03,742 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:04:03,742 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:04:03,743 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:04:03,744 - app.api.v1.endpoints.roles - INFO - Solicitud GET /roles/all-active/ recibida por usuario 1 del cliente 2 para lista simple
2025-11-24 12:04:03,744 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:04:03,746 - app.services.rol_service - INFO - Se encontraron 3 roles activos para cliente 2
2025-11-24 12:04:03,746 - app.api.v1.endpoints.roles - INFO - Lista simple de roles activos recuperada para cliente 2 - Total: 3
2025-11-24 12:04:03,747 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/usuarios/ 200 77.6ms
2025-11-24 12:04:03,747 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/roles/all-active/ 200 19.0ms
2025-11-24 12:04:03,749 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/usuarios/
2025-11-24 12:04:03,750 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 12:04:03,750 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': acme.app.local:5173
2025-11-24 12:04:03,750 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-11-24 12:04:03,750 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 12:04:03,750 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-11-24 12:04:03,752 - app.middleware.tenant_middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=2
2025-11-24 12:04:03,752 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=multi, bd=bd_cliente_acme, servidor=localhost
2025-11-24 12:04:03,752 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=2, db_type=multi, bd=bd_cliente_acme, path=/api/v1/usuarios/
2025-11-24 12:04:03,753 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:04:03,754 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:04:03,755 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:04:03,756 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:04:03,757 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:04:03,758 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:04:03,759 - app.api.v1.endpoints.usuarios - INFO - Solicitud GET /usuarios/ recibida por usuario 1 del cliente 2 - Paginación: page=1, limit=10, Búsqueda: 'None'
2025-11-24 12:04:03,759 - app.services.usuario_service - INFO - Obteniendo usuarios paginados para cliente 2: page=1, limit=10, search='None'
2025-11-24 12:04:03,759 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:04:03,761 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:04:03,763 - app.services.usuario_service - INFO - Obtención paginada de usuarios completada exitosamente
2025-11-24 12:04:03,763 - app.api.v1.endpoints.usuarios - INFO - Lista paginada de usuarios recuperada para cliente 2 - Total: 3, Página: 1
2025-11-24 12:04:03,764 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/roles/all-active/
2025-11-24 12:04:03,765 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 12:04:03,765 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': acme.app.local:5173
2025-11-24 12:04:03,765 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-11-24 12:04:03,765 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 12:04:03,765 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-11-24 12:04:03,766 - app.middleware.tenant_middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=2
2025-11-24 12:04:03,766 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=multi, bd=bd_cliente_acme, servidor=localhost
2025-11-24 12:04:03,766 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=2, db_type=multi, bd=bd_cliente_acme, path=/api/v1/roles/all-active/
2025-11-24 12:04:03,767 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:04:03,768 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:04:03,769 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:04:03,770 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:04:03,771 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:04:03,771 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:04:03,773 - app.api.v1.endpoints.roles - INFO - Solicitud GET /roles/all-active/ recibida por usuario 1 del cliente 2 para lista simple
2025-11-24 12:04:03,773 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:04:03,774 - app.services.rol_service - INFO - Se encontraron 3 roles activos para cliente 2
2025-11-24 12:04:03,774 - app.api.v1.endpoints.roles - INFO - Lista simple de roles activos recuperada para cliente 2 - Total: 3
2025-11-24 12:04:03,775 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/usuarios/ 200 25.8ms
2025-11-24 12:04:03,776 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/roles/all-active/ 200 11.7ms
2025-11-24 12:04:11,264 - app.middleware.tenant_middleware - INFO - [TENANT_MW] Inicializado - BASE_DOMAIN=app.local, SYSTEM_ID=1, EXCLUDED_SUBDOMAINS={'assets', 'cdn', 'www', 'api', 'admin', 'backend', 'static'}
2025-11-24 12:04:14,184 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/roles/
2025-11-24 12:04:14,185 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 12:04:14,185 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': acme.app.local:5173
2025-11-24 12:04:14,185 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-11-24 12:04:14,185 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 12:04:14,186 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-11-24 12:04:14,228 - app.middleware.tenant_middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=2
2025-11-24 12:04:14,235 - app.core.multi_db - INFO - [METADATA] Metadata cargada para cliente 2: multi - bd_cliente_acme
2025-11-24 12:04:14,236 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=multi, bd=bd_cliente_acme, servidor=localhost
2025-11-24 12:04:14,236 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=2, db_type=multi, bd=bd_cliente_acme, path=/api/v1/roles/
2025-11-24 12:04:14,240 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:04:14,288 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:04:14,295 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:04:14,297 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:04:14,304 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:04:14,308 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:04:14,310 - app.api.v1.endpoints.roles - INFO - Solicitud GET /roles/ recibida por usuario 1 del cliente 2 - Paginación: page=1, limit=10, Búsqueda: 'None'
2025-11-24 12:04:14,310 - app.services.rol_service - INFO - Obteniendo roles paginados para cliente 2: page=1, limit=10, search='None'
2025-11-24 12:04:14,310 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:04:14,316 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:04:14,321 - app.services.rol_service - INFO - Obtención paginada de roles para cliente 2 completada exitosamente
2025-11-24 12:04:14,322 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/roles/ N/A 137.9ms
2025-11-24 12:04:14,322 - app.core.exceptions - ERROR - Error no manejado: 3 validation errors:
  {'type': 'value_error', 'loc': ('response', 'roles', 0), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 1, 'nombre': 'Administrador', 'descripcion': 'Administrador con acceso completo', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'ADMIN'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
  {'type': 'value_error', 'loc': ('response', 'roles', 1), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 2, 'nombre': 'Supervisor', 'descripcion': 'Supervisor de departamento', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'SUPERVISOR'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
  {'type': 'value_error', 'loc': ('response', 'roles', 2), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 3, 'nombre': 'Usuario', 'descripcion': 'Usuario estándar', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'USER'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
  + Exception Group Traceback (most recent call last):
  |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 76, in collapse_excgroups
  |     yield
  |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 186, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ~~~~~~~~~~~~~~~~~~~~~~~^^
  |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\anyio\_backends\_asyncio.py", line 815, in __aexit__
  |     raise BaseExceptionGroup(
  |         "unhandled errors in a TaskGroup", self._exceptions
  |     )
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\errors.py", line 165, in __call__
    |     await self.app(scope, receive, _send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    |     with collapse_excgroups():
    |          ~~~~~~~~~~~~~~~~~~^^
    |   File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\app\main.py", line 190, in security_headers
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    |     raise app_exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    |     with collapse_excgroups():
    |          ~~~~~~~~~~~~~~~~~~^^
    |   File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\app\main.py", line 181, in log_requests
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    |     raise app_exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    |     with collapse_excgroups():
    |          ~~~~~~~~~~~~~~~~~~^^
    |   File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\app\main.py", line 158, in cors_middleware
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    |     raise app_exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    |     with collapse_excgroups():
    |          ~~~~~~~~~~~~~~~~~~^^
    |   File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\app\middleware\tenant_middleware.py", line 293, in dispatch
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    |     raise app_exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\exceptions.py", line 62, in __call__
    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 715, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 735, in app
    |     await route.handle(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 288, in handle
    |     await self.app(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 76, in app
    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 73, in app
    |     response = await f(request)
    |                ^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\fastapi\routing.py", line 327, in app
    |     content = await serialize_response(
    |               ^^^^^^^^^^^^^^^^^^^^^^^^^
    |     ...<9 lines>...
    |     )
    |     ^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\fastapi\routing.py", line 176, in serialize_response
    |     raise ResponseValidationError(
    |         errors=_normalize_errors(errors), body=response_content
    |     )
    | fastapi.exceptions.ResponseValidationError: 3 validation errors:
    |   {'type': 'value_error', 'loc': ('response', 'roles', 0), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 1, 'nombre': 'Administrador', 'descripcion': 'Administrador con acceso completo', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'ADMIN'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
    |   {'type': 'value_error', 'loc': ('response', 'roles', 1), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 2, 'nombre': 'Supervisor', 'descripcion': 'Supervisor de departamento', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'SUPERVISOR'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
    |   {'type': 'value_error', 'loc': ('response', 'roles', 2), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 3, 'nombre': 'Usuario', 'descripcion': 'Usuario estándar', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'USER'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
    | 
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\errors.py", line 165, in __call__
    await self.app(scope, receive, _send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    with collapse_excgroups():
         ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\main.py", line 190, in security_headers
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    raise app_exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    with collapse_excgroups():
         ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\main.py", line 181, in log_requests
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    raise app_exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    with collapse_excgroups():
         ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\main.py", line 158, in cors_middleware
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    raise app_exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    with collapse_excgroups():
         ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\middleware\tenant_middleware.py", line 293, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    raise app_exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 715, in __call__
    await self.middleware_stack(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 735, in app
    await route.handle(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 288, in handle
    await self.app(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 76, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 73, in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\fastapi\routing.py", line 327, in app
    content = await serialize_response(
              ^^^^^^^^^^^^^^^^^^^^^^^^^
    ...<9 lines>...
    )
    ^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\fastapi\routing.py", line 176, in serialize_response
    raise ResponseValidationError(
        errors=_normalize_errors(errors), body=response_content
    )
fastapi.exceptions.ResponseValidationError: 3 validation errors:
  {'type': 'value_error', 'loc': ('response', 'roles', 0), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 1, 'nombre': 'Administrador', 'descripcion': 'Administrador con acceso completo', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'ADMIN'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
  {'type': 'value_error', 'loc': ('response', 'roles', 1), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 2, 'nombre': 'Supervisor', 'descripcion': 'Supervisor de departamento', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'SUPERVISOR'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
  {'type': 'value_error', 'loc': ('response', 'roles', 2), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 3, 'nombre': 'Usuario', 'descripcion': 'Usuario estándar', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'USER'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}

2025-11-24 12:04:14,356 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/roles/
2025-11-24 12:04:14,356 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 12:04:14,356 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': acme.app.local:5173
2025-11-24 12:04:14,356 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-11-24 12:04:14,357 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 12:04:14,357 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-11-24 12:04:14,360 - app.middleware.tenant_middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=2
2025-11-24 12:04:14,361 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=multi, bd=bd_cliente_acme, servidor=localhost
2025-11-24 12:04:14,361 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=2, db_type=multi, bd=bd_cliente_acme, path=/api/v1/roles/
2025-11-24 12:04:14,362 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:04:14,368 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:04:14,377 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:04:14,382 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:04:14,387 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:04:14,391 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:04:14,392 - app.api.v1.endpoints.roles - INFO - Solicitud GET /roles/ recibida por usuario 1 del cliente 2 - Paginación: page=1, limit=10, Búsqueda: 'None'
2025-11-24 12:04:14,393 - app.services.rol_service - INFO - Obteniendo roles paginados para cliente 2: page=1, limit=10, search='None'
2025-11-24 12:04:14,393 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:04:14,397 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:04:14,399 - app.services.rol_service - INFO - Obtención paginada de roles para cliente 2 completada exitosamente
2025-11-24 12:04:14,400 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/roles/ N/A 44.4ms
2025-11-24 12:04:14,401 - app.core.exceptions - ERROR - Error no manejado: 3 validation errors:
  {'type': 'value_error', 'loc': ('response', 'roles', 0), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 1, 'nombre': 'Administrador', 'descripcion': 'Administrador con acceso completo', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'ADMIN'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
  {'type': 'value_error', 'loc': ('response', 'roles', 1), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 2, 'nombre': 'Supervisor', 'descripcion': 'Supervisor de departamento', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'SUPERVISOR'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
  {'type': 'value_error', 'loc': ('response', 'roles', 2), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 3, 'nombre': 'Usuario', 'descripcion': 'Usuario estándar', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'USER'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
  + Exception Group Traceback (most recent call last):
  |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 76, in collapse_excgroups
  |     yield
  |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 186, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ~~~~~~~~~~~~~~~~~~~~~~~^^
  |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\anyio\_backends\_asyncio.py", line 815, in __aexit__
  |     raise BaseExceptionGroup(
  |         "unhandled errors in a TaskGroup", self._exceptions
  |     )
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\errors.py", line 165, in __call__
    |     await self.app(scope, receive, _send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    |     with collapse_excgroups():
    |          ~~~~~~~~~~~~~~~~~~^^
    |   File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\app\main.py", line 190, in security_headers
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    |     raise app_exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    |     with collapse_excgroups():
    |          ~~~~~~~~~~~~~~~~~~^^
    |   File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\app\main.py", line 181, in log_requests
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    |     raise app_exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    |     with collapse_excgroups():
    |          ~~~~~~~~~~~~~~~~~~^^
    |   File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\app\main.py", line 158, in cors_middleware
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    |     raise app_exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    |     with collapse_excgroups():
    |          ~~~~~~~~~~~~~~~~~~^^
    |   File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\app\middleware\tenant_middleware.py", line 293, in dispatch
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    |     raise app_exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\exceptions.py", line 62, in __call__
    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 715, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 735, in app
    |     await route.handle(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 288, in handle
    |     await self.app(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 76, in app
    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 73, in app
    |     response = await f(request)
    |                ^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\fastapi\routing.py", line 327, in app
    |     content = await serialize_response(
    |               ^^^^^^^^^^^^^^^^^^^^^^^^^
    |     ...<9 lines>...
    |     )
    |     ^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\fastapi\routing.py", line 176, in serialize_response
    |     raise ResponseValidationError(
    |         errors=_normalize_errors(errors), body=response_content
    |     )
    | fastapi.exceptions.ResponseValidationError: 3 validation errors:
    |   {'type': 'value_error', 'loc': ('response', 'roles', 0), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 1, 'nombre': 'Administrador', 'descripcion': 'Administrador con acceso completo', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'ADMIN'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
    |   {'type': 'value_error', 'loc': ('response', 'roles', 1), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 2, 'nombre': 'Supervisor', 'descripcion': 'Supervisor de departamento', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'SUPERVISOR'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
    |   {'type': 'value_error', 'loc': ('response', 'roles', 2), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 3, 'nombre': 'Usuario', 'descripcion': 'Usuario estándar', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'USER'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
    | 
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\errors.py", line 165, in __call__
    await self.app(scope, receive, _send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    with collapse_excgroups():
         ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\main.py", line 190, in security_headers
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    raise app_exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    with collapse_excgroups():
         ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\main.py", line 181, in log_requests
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    raise app_exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    with collapse_excgroups():
         ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\main.py", line 158, in cors_middleware
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    raise app_exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    with collapse_excgroups():
         ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\middleware\tenant_middleware.py", line 293, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    raise app_exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 715, in __call__
    await self.middleware_stack(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 735, in app
    await route.handle(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 288, in handle
    await self.app(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 76, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 73, in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\fastapi\routing.py", line 327, in app
    content = await serialize_response(
              ^^^^^^^^^^^^^^^^^^^^^^^^^
    ...<9 lines>...
    )
    ^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\fastapi\routing.py", line 176, in serialize_response
    raise ResponseValidationError(
        errors=_normalize_errors(errors), body=response_content
    )
fastapi.exceptions.ResponseValidationError: 3 validation errors:
  {'type': 'value_error', 'loc': ('response', 'roles', 0), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 1, 'nombre': 'Administrador', 'descripcion': 'Administrador con acceso completo', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'ADMIN'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
  {'type': 'value_error', 'loc': ('response', 'roles', 1), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 2, 'nombre': 'Supervisor', 'descripcion': 'Supervisor de departamento', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'SUPERVISOR'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
  {'type': 'value_error', 'loc': ('response', 'roles', 2), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 3, 'nombre': 'Usuario', 'descripcion': 'Usuario estándar', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'USER'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}

2025-11-24 12:05:04,599 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/usuarios/
2025-11-24 12:05:04,600 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 12:05:04,600 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': acme.app.local:5173
2025-11-24 12:05:04,600 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-11-24 12:05:04,601 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 12:05:04,601 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-11-24 12:05:04,604 - app.middleware.tenant_middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=2
2025-11-24 12:05:04,604 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=multi, bd=bd_cliente_acme, servidor=localhost
2025-11-24 12:05:04,604 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=2, db_type=multi, bd=bd_cliente_acme, path=/api/v1/usuarios/
2025-11-24 12:05:04,606 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:05:04,608 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:05:04,617 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:05:04,619 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:05:04,623 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:05:04,627 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:05:04,630 - app.api.v1.endpoints.usuarios - INFO - Solicitud GET /usuarios/ recibida por usuario 1 del cliente 2 - Paginación: page=1, limit=10, Búsqueda: 'None'
2025-11-24 12:05:04,630 - app.services.usuario_service - INFO - Obteniendo usuarios paginados para cliente 2: page=1, limit=10, search='None'
2025-11-24 12:05:04,630 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:05:04,636 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:05:04,643 - app.services.usuario_service - INFO - Obtención paginada de usuarios completada exitosamente
2025-11-24 12:05:04,644 - app.api.v1.endpoints.usuarios - INFO - Lista paginada de usuarios recuperada para cliente 2 - Total: 3, Página: 1
2025-11-24 12:05:04,645 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/roles/all-active/
2025-11-24 12:05:04,646 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 12:05:04,646 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': acme.app.local:5173
2025-11-24 12:05:04,646 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-11-24 12:05:04,646 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 12:05:04,646 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-11-24 12:05:04,648 - app.middleware.tenant_middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=2
2025-11-24 12:05:04,648 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=multi, bd=bd_cliente_acme, servidor=localhost
2025-11-24 12:05:04,648 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=2, db_type=multi, bd=bd_cliente_acme, path=/api/v1/roles/all-active/
2025-11-24 12:05:04,648 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/usuarios/ 200 49.2ms
2025-11-24 12:05:04,649 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:05:04,650 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:05:04,651 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:05:04,652 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:05:04,653 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:05:04,654 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:05:04,655 - app.api.v1.endpoints.roles - INFO - Solicitud GET /roles/all-active/ recibida por usuario 1 del cliente 2 para lista simple
2025-11-24 12:05:04,655 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:05:04,657 - app.services.rol_service - INFO - Se encontraron 3 roles activos para cliente 2
2025-11-24 12:05:04,657 - app.api.v1.endpoints.roles - INFO - Lista simple de roles activos recuperada para cliente 2 - Total: 3
2025-11-24 12:05:04,659 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/roles/all-active/ 200 13.6ms
2025-11-24 12:05:04,660 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/usuarios/
2025-11-24 12:05:04,661 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 12:05:04,661 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': acme.app.local:5173
2025-11-24 12:05:04,662 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-11-24 12:05:04,662 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 12:05:04,662 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-11-24 12:05:04,663 - app.middleware.tenant_middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=2
2025-11-24 12:05:04,663 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=multi, bd=bd_cliente_acme, servidor=localhost
2025-11-24 12:05:04,664 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=2, db_type=multi, bd=bd_cliente_acme, path=/api/v1/usuarios/
2025-11-24 12:05:04,664 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:05:04,665 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:05:04,666 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:05:04,667 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:05:04,667 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:05:04,668 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:05:04,669 - app.api.v1.endpoints.usuarios - INFO - Solicitud GET /usuarios/ recibida por usuario 1 del cliente 2 - Paginación: page=1, limit=10, Búsqueda: 'None'
2025-11-24 12:05:04,669 - app.services.usuario_service - INFO - Obteniendo usuarios paginados para cliente 2: page=1, limit=10, search='None'
2025-11-24 12:05:04,669 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:05:04,671 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:05:04,673 - app.services.usuario_service - INFO - Obtención paginada de usuarios completada exitosamente
2025-11-24 12:05:04,673 - app.api.v1.endpoints.usuarios - INFO - Lista paginada de usuarios recuperada para cliente 2 - Total: 3, Página: 1
2025-11-24 12:05:04,674 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/roles/all-active/
2025-11-24 12:05:04,674 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/usuarios/ 200 13.8ms
2025-11-24 12:05:04,674 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 12:05:04,675 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': acme.app.local:5173
2025-11-24 12:05:04,675 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-11-24 12:05:04,675 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 12:05:04,675 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-11-24 12:05:04,676 - app.middleware.tenant_middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=2
2025-11-24 12:05:04,676 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=multi, bd=bd_cliente_acme, servidor=localhost
2025-11-24 12:05:04,676 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=2, db_type=multi, bd=bd_cliente_acme, path=/api/v1/roles/all-active/
2025-11-24 12:05:04,677 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:05:04,678 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:05:04,680 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:05:04,681 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:05:04,681 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:05:04,682 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:05:04,683 - app.api.v1.endpoints.roles - INFO - Solicitud GET /roles/all-active/ recibida por usuario 1 del cliente 2 para lista simple
2025-11-24 12:05:04,683 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:05:04,683 - app.services.rol_service - INFO - Se encontraron 3 roles activos para cliente 2
2025-11-24 12:05:04,684 - app.api.v1.endpoints.roles - INFO - Lista simple de roles activos recuperada para cliente 2 - Total: 3
2025-11-24 12:05:04,684 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/roles/all-active/ 200 10.5ms
2025-11-24 12:05:05,894 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/areas/
2025-11-24 12:05:05,895 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 12:05:05,895 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': acme.app.local:5173
2025-11-24 12:05:05,896 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-11-24 12:05:05,896 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 12:05:05,896 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-11-24 12:05:05,898 - app.middleware.tenant_middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=2
2025-11-24 12:05:05,898 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=multi, bd=bd_cliente_acme, servidor=localhost
2025-11-24 12:05:05,898 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=2, db_type=multi, bd=bd_cliente_acme, path=/api/v1/areas/
2025-11-24 12:05:05,899 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:05:05,901 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:05:05,902 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:05:05,904 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:05:05,905 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:05:05,906 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:05:05,907 - app.api.v1.endpoints.areas - INFO - Solicitud GET /areas/ recibida por usuario 1 del cliente 2 - Paginación: skip=0, limit=10, Búsqueda: 'None'
2025-11-24 12:05:05,908 - app.services.area_service - INFO - Obteniendo áreas paginadas para cliente 2: skip=0, limit=10, search='None'
2025-11-24 12:05:05,908 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:05:05,912 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:05:05,917 - app.services.area_service - INFO - Paginación completada para cliente 2: 2 áreas de 2 totales
2025-11-24 12:05:05,917 - app.api.v1.endpoints.areas - INFO - Lista paginada de áreas recuperada para cliente 2 - Total: 2, Página: 1
2025-11-24 12:05:05,918 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/areas/ 200 24.0ms
2025-11-24 12:05:05,920 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/areas/
2025-11-24 12:05:05,920 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 12:05:05,920 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': acme.app.local:5173
2025-11-24 12:05:05,920 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-11-24 12:05:05,920 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 12:05:05,921 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-11-24 12:05:05,922 - app.middleware.tenant_middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=2
2025-11-24 12:05:05,922 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=multi, bd=bd_cliente_acme, servidor=localhost
2025-11-24 12:05:05,922 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=2, db_type=multi, bd=bd_cliente_acme, path=/api/v1/areas/
2025-11-24 12:05:05,923 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:05:05,924 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:05:05,924 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:05:05,925 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:05:05,926 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:05:05,927 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:05:05,927 - app.api.v1.endpoints.areas - INFO - Solicitud GET /areas/ recibida por usuario 1 del cliente 2 - Paginación: skip=0, limit=10, Búsqueda: 'None'
2025-11-24 12:05:05,927 - app.services.area_service - INFO - Obteniendo áreas paginadas para cliente 2: skip=0, limit=10, search='None'
2025-11-24 12:05:05,928 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:05:05,930 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:05:05,932 - app.services.area_service - INFO - Paginación completada para cliente 2: 2 áreas de 2 totales
2025-11-24 12:05:05,932 - app.api.v1.endpoints.areas - INFO - Lista paginada de áreas recuperada para cliente 2 - Total: 2, Página: 1
2025-11-24 12:05:05,933 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/areas/ 200 13.0ms
2025-11-24 12:05:42,018 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/areas/list/
2025-11-24 12:05:42,019 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 12:05:42,019 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': acme.app.local:5173
2025-11-24 12:05:42,019 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-11-24 12:05:42,019 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 12:05:42,019 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-11-24 12:05:42,024 - app.middleware.tenant_middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=2
2025-11-24 12:05:42,024 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=multi, bd=bd_cliente_acme, servidor=localhost
2025-11-24 12:05:42,024 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=2, db_type=multi, bd=bd_cliente_acme, path=/api/v1/areas/list/
2025-11-24 12:05:42,025 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:05:42,028 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:05:42,031 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:05:42,032 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:05:42,034 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:05:42,038 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:05:42,039 - app.api.v1.endpoints.areas - INFO - Solicitud GET /areas/list/ recibida por usuario 1 del cliente 2 para lista simple
2025-11-24 12:05:42,039 - app.services.area_service - INFO - Obteniendo lista simple de áreas activas para cliente 2
2025-11-24 12:05:42,039 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:05:42,042 - app.services.area_service - INFO - Lista simple obtenida para cliente 2: 2 áreas activas
2025-11-24 12:05:42,042 - app.api.v1.endpoints.areas - INFO - Lista simple de áreas recuperada para cliente 2 - Total: 2 áreas activas
2025-11-24 12:05:42,043 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/areas/list/ 200 24.7ms
2025-11-24 12:05:42,045 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/areas/list/
2025-11-24 12:05:42,045 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 12:05:42,046 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': acme.app.local:5173
2025-11-24 12:05:42,046 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-11-24 12:05:42,047 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 12:05:42,047 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-11-24 12:05:42,049 - app.middleware.tenant_middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=2
2025-11-24 12:05:42,049 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=multi, bd=bd_cliente_acme, servidor=localhost
2025-11-24 12:05:42,049 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=2, db_type=multi, bd=bd_cliente_acme, path=/api/v1/areas/list/
2025-11-24 12:05:42,050 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:05:42,051 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:05:42,053 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:05:42,054 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:05:42,055 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:05:42,055 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:05:42,056 - app.api.v1.endpoints.areas - INFO - Solicitud GET /areas/list/ recibida por usuario 1 del cliente 2 para lista simple
2025-11-24 12:05:42,057 - app.services.area_service - INFO - Obteniendo lista simple de áreas activas para cliente 2
2025-11-24 12:05:42,057 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:05:42,058 - app.services.area_service - INFO - Lista simple obtenida para cliente 2: 2 áreas activas
2025-11-24 12:05:42,058 - app.api.v1.endpoints.areas - INFO - Lista simple de áreas recuperada para cliente 2 - Total: 2 áreas activas
2025-11-24 12:05:42,059 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/areas/list/ 200 14.3ms
2025-11-24 12:05:44,451 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/menus/area/2/tree/
2025-11-24 12:05:44,451 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/menus/area/2/tree/ 200 0.6ms
2025-11-24 12:05:44,453 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/menus/area/2/tree/
2025-11-24 12:05:44,453 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 12:05:44,453 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': acme.app.local:5173
2025-11-24 12:05:44,453 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-11-24 12:05:44,454 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 12:05:44,454 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-11-24 12:05:44,455 - app.middleware.tenant_middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=2
2025-11-24 12:05:44,455 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=multi, bd=bd_cliente_acme, servidor=localhost
2025-11-24 12:05:44,455 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=2, db_type=multi, bd=bd_cliente_acme, path=/api/v1/menus/area/2/tree/
2025-11-24 12:05:44,455 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:05:44,456 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:05:44,457 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:05:44,458 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:05:44,459 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:05:44,460 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:05:44,461 - app.api.v1.endpoints.menus - INFO - Solicitud GET /menus/area/2/tree/ recibida por usuario 1 del cliente 2.
2025-11-24 12:05:44,461 - app.services.menu_service - INFO - Obteniendo árbol de menú para cliente 2, area_id: 2
2025-11-24 12:05:44,461 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:05:44,468 - app.utils.menu_helper - ERROR - Error procesando item de menú 4: 1 validation error for MenuItem
cliente_id
  Field required [type=missing, input_value={'menu_id': 4, 'nombre': ...macén', 'children': []}, input_type=dict]
    For further information visit https://errors.pydantic.dev/2.10/v/missing
Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\utils\menu_helper.py", line 34, in build_menu_tree
    menu_item_obj = MenuItem(
        menu_id=menu_id,
    ...<10 lines>...
        children=[]
    )
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\pydantic\main.py", line 214, in __init__
    validated_self = self.__pydantic_validator__.validate_python(data, self_instance=self)
pydantic_core._pydantic_core.ValidationError: 1 validation error for MenuItem
cliente_id
  Field required [type=missing, input_value={'menu_id': 4, 'nombre': ...macén', 'children': []}, input_type=dict]
    For further information visit https://errors.pydantic.dev/2.10/v/missing
2025-11-24 12:05:44,470 - app.utils.menu_helper - ERROR - Error procesando item de menú 5: 1 validation error for MenuItem
cliente_id
  Field required [type=missing, input_value={'menu_id': 5, 'nombre': ...macén', 'children': []}, input_type=dict]
    For further information visit https://errors.pydantic.dev/2.10/v/missing
Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\utils\menu_helper.py", line 34, in build_menu_tree
    menu_item_obj = MenuItem(
        menu_id=menu_id,
    ...<10 lines>...
        children=[]
    )
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\pydantic\main.py", line 214, in __init__
    validated_self = self.__pydantic_validator__.validate_python(data, self_instance=self)
pydantic_core._pydantic_core.ValidationError: 1 validation error for MenuItem
cliente_id
  Field required [type=missing, input_value={'menu_id': 5, 'nombre': ...macén', 'children': []}, input_type=dict]
    For further information visit https://errors.pydantic.dev/2.10/v/missing
2025-11-24 12:05:44,471 - app.utils.menu_helper - INFO - Árbol de menú construido con 0 items raíz.
2025-11-24 12:05:44,471 - app.services.menu_service - INFO - Árbol de menú del cliente 2, área 2 construido con 0 items raíz.
2025-11-24 12:05:44,472 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/menus/area/2/tree/ 200 19.0ms
2025-11-24 12:05:46,766 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/menus/area/1/tree/
2025-11-24 12:05:46,766 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/menus/area/1/tree/ 200 0.5ms
2025-11-24 12:05:46,768 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/menus/area/1/tree/
2025-11-24 12:05:46,768 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 12:05:46,768 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': acme.app.local:5173
2025-11-24 12:05:46,769 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-11-24 12:05:46,769 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 12:05:46,769 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-11-24 12:05:46,770 - app.middleware.tenant_middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=2
2025-11-24 12:05:46,770 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=multi, bd=bd_cliente_acme, servidor=localhost
2025-11-24 12:05:46,770 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=2, db_type=multi, bd=bd_cliente_acme, path=/api/v1/menus/area/1/tree/
2025-11-24 12:05:46,771 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:05:46,772 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:05:46,773 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:05:46,773 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:05:46,774 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:05:46,775 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:05:46,776 - app.api.v1.endpoints.menus - INFO - Solicitud GET /menus/area/1/tree/ recibida por usuario 1 del cliente 2.
2025-11-24 12:05:46,776 - app.services.menu_service - INFO - Obteniendo árbol de menú para cliente 2, area_id: 1
2025-11-24 12:05:46,776 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:05:46,777 - app.services.menu_service - INFO - No se encontraron menús para el cliente 2, área ID: 1.
2025-11-24 12:05:46,777 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/menus/area/1/tree/ 200 9.7ms
2025-11-24 12:05:53,775 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/areas/
2025-11-24 12:05:53,775 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 12:05:53,776 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': acme.app.local:5173
2025-11-24 12:05:53,776 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-11-24 12:05:53,776 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 12:05:53,776 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-11-24 12:05:53,778 - app.middleware.tenant_middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=2
2025-11-24 12:05:53,778 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=multi, bd=bd_cliente_acme, servidor=localhost
2025-11-24 12:05:53,778 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=2, db_type=multi, bd=bd_cliente_acme, path=/api/v1/areas/
2025-11-24 12:05:53,779 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:05:53,780 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:05:53,783 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:05:53,784 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:05:53,786 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:05:53,787 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:05:53,788 - app.api.v1.endpoints.areas - INFO - Solicitud GET /areas/ recibida por usuario 1 del cliente 2 - Paginación: skip=0, limit=10, Búsqueda: 'None'
2025-11-24 12:05:53,788 - app.services.area_service - INFO - Obteniendo áreas paginadas para cliente 2: skip=0, limit=10, search='None'
2025-11-24 12:05:53,788 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:05:53,793 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:05:53,798 - app.services.area_service - INFO - Paginación completada para cliente 2: 2 áreas de 2 totales
2025-11-24 12:05:53,798 - app.api.v1.endpoints.areas - INFO - Lista paginada de áreas recuperada para cliente 2 - Total: 2, Página: 1
2025-11-24 12:05:53,799 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/areas/ 200 23.9ms
2025-11-24 12:05:53,801 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/areas/
2025-11-24 12:05:53,801 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 12:05:53,801 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': acme.app.local:5173
2025-11-24 12:05:53,801 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-11-24 12:05:53,802 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 12:05:53,802 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-11-24 12:05:53,803 - app.middleware.tenant_middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=2
2025-11-24 12:05:53,803 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=multi, bd=bd_cliente_acme, servidor=localhost
2025-11-24 12:05:53,803 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=2, db_type=multi, bd=bd_cliente_acme, path=/api/v1/areas/
2025-11-24 12:05:53,804 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:05:53,805 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:05:53,806 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:05:53,807 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:05:53,808 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:05:53,809 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:05:53,810 - app.api.v1.endpoints.areas - INFO - Solicitud GET /areas/ recibida por usuario 1 del cliente 2 - Paginación: skip=0, limit=10, Búsqueda: 'None'
2025-11-24 12:05:53,810 - app.services.area_service - INFO - Obteniendo áreas paginadas para cliente 2: skip=0, limit=10, search='None'
2025-11-24 12:05:53,810 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:05:53,812 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:05:53,814 - app.services.area_service - INFO - Paginación completada para cliente 2: 2 áreas de 2 totales
2025-11-24 12:05:53,814 - app.api.v1.endpoints.areas - INFO - Lista paginada de áreas recuperada para cliente 2 - Total: 2, Página: 1
2025-11-24 12:05:53,815 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/areas/ 200 14.1ms
2025-11-24 12:06:00,382 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/roles/
2025-11-24 12:06:00,383 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 12:06:00,383 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': acme.app.local:5173
2025-11-24 12:06:00,384 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-11-24 12:06:00,384 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 12:06:00,384 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-11-24 12:06:00,385 - app.middleware.tenant_middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=2
2025-11-24 12:06:00,385 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=multi, bd=bd_cliente_acme, servidor=localhost
2025-11-24 12:06:00,385 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=2, db_type=multi, bd=bd_cliente_acme, path=/api/v1/roles/
2025-11-24 12:06:00,386 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:06:00,387 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:06:00,388 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:06:00,389 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:06:00,391 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:06:00,392 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:06:00,393 - app.api.v1.endpoints.roles - INFO - Solicitud GET /roles/ recibida por usuario 1 del cliente 2 - Paginación: page=1, limit=10, Búsqueda: 'None'
2025-11-24 12:06:00,393 - app.services.rol_service - INFO - Obteniendo roles paginados para cliente 2: page=1, limit=10, search='None'
2025-11-24 12:06:00,393 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:06:00,398 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:06:00,402 - app.services.rol_service - INFO - Obtención paginada de roles para cliente 2 completada exitosamente
2025-11-24 12:06:00,403 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/roles/ N/A 20.3ms
2025-11-24 12:06:00,403 - app.core.exceptions - ERROR - Error no manejado: 3 validation errors:
  {'type': 'value_error', 'loc': ('response', 'roles', 0), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 1, 'nombre': 'Administrador', 'descripcion': 'Administrador con acceso completo', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'ADMIN'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
  {'type': 'value_error', 'loc': ('response', 'roles', 1), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 2, 'nombre': 'Supervisor', 'descripcion': 'Supervisor de departamento', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'SUPERVISOR'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
  {'type': 'value_error', 'loc': ('response', 'roles', 2), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 3, 'nombre': 'Usuario', 'descripcion': 'Usuario estándar', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'USER'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
  + Exception Group Traceback (most recent call last):
  |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 76, in collapse_excgroups
  |     yield
  |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 186, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ~~~~~~~~~~~~~~~~~~~~~~~^^
  |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\anyio\_backends\_asyncio.py", line 815, in __aexit__
  |     raise BaseExceptionGroup(
  |         "unhandled errors in a TaskGroup", self._exceptions
  |     )
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\errors.py", line 165, in __call__
    |     await self.app(scope, receive, _send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    |     with collapse_excgroups():
    |          ~~~~~~~~~~~~~~~~~~^^
    |   File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\app\main.py", line 190, in security_headers
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    |     raise app_exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    |     with collapse_excgroups():
    |          ~~~~~~~~~~~~~~~~~~^^
    |   File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\app\main.py", line 181, in log_requests
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    |     raise app_exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    |     with collapse_excgroups():
    |          ~~~~~~~~~~~~~~~~~~^^
    |   File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\app\main.py", line 158, in cors_middleware
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    |     raise app_exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    |     with collapse_excgroups():
    |          ~~~~~~~~~~~~~~~~~~^^
    |   File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\app\middleware\tenant_middleware.py", line 293, in dispatch
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    |     raise app_exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\exceptions.py", line 62, in __call__
    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 715, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 735, in app
    |     await route.handle(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 288, in handle
    |     await self.app(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 76, in app
    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 73, in app
    |     response = await f(request)
    |                ^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\fastapi\routing.py", line 327, in app
    |     content = await serialize_response(
    |               ^^^^^^^^^^^^^^^^^^^^^^^^^
    |     ...<9 lines>...
    |     )
    |     ^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\fastapi\routing.py", line 176, in serialize_response
    |     raise ResponseValidationError(
    |         errors=_normalize_errors(errors), body=response_content
    |     )
    | fastapi.exceptions.ResponseValidationError: 3 validation errors:
    |   {'type': 'value_error', 'loc': ('response', 'roles', 0), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 1, 'nombre': 'Administrador', 'descripcion': 'Administrador con acceso completo', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'ADMIN'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
    |   {'type': 'value_error', 'loc': ('response', 'roles', 1), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 2, 'nombre': 'Supervisor', 'descripcion': 'Supervisor de departamento', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'SUPERVISOR'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
    |   {'type': 'value_error', 'loc': ('response', 'roles', 2), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 3, 'nombre': 'Usuario', 'descripcion': 'Usuario estándar', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'USER'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
    | 
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\errors.py", line 165, in __call__
    await self.app(scope, receive, _send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    with collapse_excgroups():
         ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\main.py", line 190, in security_headers
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    raise app_exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    with collapse_excgroups():
         ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\main.py", line 181, in log_requests
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    raise app_exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    with collapse_excgroups():
         ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\main.py", line 158, in cors_middleware
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    raise app_exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    with collapse_excgroups():
         ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\middleware\tenant_middleware.py", line 293, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    raise app_exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 715, in __call__
    await self.middleware_stack(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 735, in app
    await route.handle(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 288, in handle
    await self.app(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 76, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 73, in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\fastapi\routing.py", line 327, in app
    content = await serialize_response(
              ^^^^^^^^^^^^^^^^^^^^^^^^^
    ...<9 lines>...
    )
    ^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\fastapi\routing.py", line 176, in serialize_response
    raise ResponseValidationError(
        errors=_normalize_errors(errors), body=response_content
    )
fastapi.exceptions.ResponseValidationError: 3 validation errors:
  {'type': 'value_error', 'loc': ('response', 'roles', 0), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 1, 'nombre': 'Administrador', 'descripcion': 'Administrador con acceso completo', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'ADMIN'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
  {'type': 'value_error', 'loc': ('response', 'roles', 1), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 2, 'nombre': 'Supervisor', 'descripcion': 'Supervisor de departamento', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'SUPERVISOR'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
  {'type': 'value_error', 'loc': ('response', 'roles', 2), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 3, 'nombre': 'Usuario', 'descripcion': 'Usuario estándar', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'USER'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}

2025-11-24 12:06:00,425 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/roles/
2025-11-24 12:06:00,426 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 12:06:00,426 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': acme.app.local:5173
2025-11-24 12:06:00,426 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-11-24 12:06:00,426 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 12:06:00,426 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-11-24 12:06:00,428 - app.middleware.tenant_middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=2
2025-11-24 12:06:00,428 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=multi, bd=bd_cliente_acme, servidor=localhost
2025-11-24 12:06:00,428 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=2, db_type=multi, bd=bd_cliente_acme, path=/api/v1/roles/
2025-11-24 12:06:00,429 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:06:00,429 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:06:00,430 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:06:00,431 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:06:00,432 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:06:00,433 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:06:00,434 - app.api.v1.endpoints.roles - INFO - Solicitud GET /roles/ recibida por usuario 1 del cliente 2 - Paginación: page=1, limit=10, Búsqueda: 'None'
2025-11-24 12:06:00,434 - app.services.rol_service - INFO - Obteniendo roles paginados para cliente 2: page=1, limit=10, search='None'
2025-11-24 12:06:00,434 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:06:00,436 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:06:00,438 - app.services.rol_service - INFO - Obtención paginada de roles para cliente 2 completada exitosamente
2025-11-24 12:06:00,438 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/roles/ N/A 13.0ms
2025-11-24 12:06:00,439 - app.core.exceptions - ERROR - Error no manejado: 3 validation errors:
  {'type': 'value_error', 'loc': ('response', 'roles', 0), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 1, 'nombre': 'Administrador', 'descripcion': 'Administrador con acceso completo', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'ADMIN'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
  {'type': 'value_error', 'loc': ('response', 'roles', 1), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 2, 'nombre': 'Supervisor', 'descripcion': 'Supervisor de departamento', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'SUPERVISOR'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
  {'type': 'value_error', 'loc': ('response', 'roles', 2), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 3, 'nombre': 'Usuario', 'descripcion': 'Usuario estándar', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'USER'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
  + Exception Group Traceback (most recent call last):
  |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 76, in collapse_excgroups
  |     yield
  |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 186, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ~~~~~~~~~~~~~~~~~~~~~~~^^
  |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\anyio\_backends\_asyncio.py", line 815, in __aexit__
  |     raise BaseExceptionGroup(
  |         "unhandled errors in a TaskGroup", self._exceptions
  |     )
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\errors.py", line 165, in __call__
    |     await self.app(scope, receive, _send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    |     with collapse_excgroups():
    |          ~~~~~~~~~~~~~~~~~~^^
    |   File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\app\main.py", line 190, in security_headers
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    |     raise app_exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    |     with collapse_excgroups():
    |          ~~~~~~~~~~~~~~~~~~^^
    |   File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\app\main.py", line 181, in log_requests
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    |     raise app_exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    |     with collapse_excgroups():
    |          ~~~~~~~~~~~~~~~~~~^^
    |   File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\app\main.py", line 158, in cors_middleware
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    |     raise app_exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    |     with collapse_excgroups():
    |          ~~~~~~~~~~~~~~~~~~^^
    |   File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\app\middleware\tenant_middleware.py", line 293, in dispatch
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    |     raise app_exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\exceptions.py", line 62, in __call__
    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 715, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 735, in app
    |     await route.handle(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 288, in handle
    |     await self.app(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 76, in app
    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 73, in app
    |     response = await f(request)
    |                ^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\fastapi\routing.py", line 327, in app
    |     content = await serialize_response(
    |               ^^^^^^^^^^^^^^^^^^^^^^^^^
    |     ...<9 lines>...
    |     )
    |     ^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\fastapi\routing.py", line 176, in serialize_response
    |     raise ResponseValidationError(
    |         errors=_normalize_errors(errors), body=response_content
    |     )
    | fastapi.exceptions.ResponseValidationError: 3 validation errors:
    |   {'type': 'value_error', 'loc': ('response', 'roles', 0), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 1, 'nombre': 'Administrador', 'descripcion': 'Administrador con acceso completo', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'ADMIN'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
    |   {'type': 'value_error', 'loc': ('response', 'roles', 1), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 2, 'nombre': 'Supervisor', 'descripcion': 'Supervisor de departamento', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'SUPERVISOR'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
    |   {'type': 'value_error', 'loc': ('response', 'roles', 2), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 3, 'nombre': 'Usuario', 'descripcion': 'Usuario estándar', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'USER'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
    | 
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\errors.py", line 165, in __call__
    await self.app(scope, receive, _send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    with collapse_excgroups():
         ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\main.py", line 190, in security_headers
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    raise app_exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    with collapse_excgroups():
         ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\main.py", line 181, in log_requests
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    raise app_exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    with collapse_excgroups():
         ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\main.py", line 158, in cors_middleware
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    raise app_exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    with collapse_excgroups():
         ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\middleware\tenant_middleware.py", line 293, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    raise app_exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 715, in __call__
    await self.middleware_stack(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 735, in app
    await route.handle(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 288, in handle
    await self.app(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 76, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 73, in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\fastapi\routing.py", line 327, in app
    content = await serialize_response(
              ^^^^^^^^^^^^^^^^^^^^^^^^^
    ...<9 lines>...
    )
    ^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\fastapi\routing.py", line 176, in serialize_response
    raise ResponseValidationError(
        errors=_normalize_errors(errors), body=response_content
    )
fastapi.exceptions.ResponseValidationError: 3 validation errors:
  {'type': 'value_error', 'loc': ('response', 'roles', 0), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 1, 'nombre': 'Administrador', 'descripcion': 'Administrador con acceso completo', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'ADMIN'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
  {'type': 'value_error', 'loc': ('response', 'roles', 1), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 2, 'nombre': 'Supervisor', 'descripcion': 'Supervisor de departamento', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'SUPERVISOR'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
  {'type': 'value_error', 'loc': ('response', 'roles', 2), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 3, 'nombre': 'Usuario', 'descripcion': 'Usuario estándar', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'USER'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}

2025-11-24 12:06:30,577 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/usuarios/
2025-11-24 12:06:30,578 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 12:06:30,578 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': acme.app.local:5173
2025-11-24 12:06:30,578 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-11-24 12:06:30,578 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 12:06:30,578 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-11-24 12:06:30,582 - app.middleware.tenant_middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=2
2025-11-24 12:06:30,582 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=multi, bd=bd_cliente_acme, servidor=localhost
2025-11-24 12:06:30,582 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=2, db_type=multi, bd=bd_cliente_acme, path=/api/v1/usuarios/
2025-11-24 12:06:30,584 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:06:30,585 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:06:30,587 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:06:30,589 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:06:30,590 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:06:30,591 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:06:30,592 - app.api.v1.endpoints.usuarios - INFO - Solicitud GET /usuarios/ recibida por usuario 1 del cliente 2 - Paginación: page=1, limit=10, Búsqueda: 'None'
2025-11-24 12:06:30,593 - app.services.usuario_service - INFO - Obteniendo usuarios paginados para cliente 2: page=1, limit=10, search='None'
2025-11-24 12:06:30,593 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:06:30,599 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:06:30,606 - app.services.usuario_service - INFO - Obtención paginada de usuarios completada exitosamente
2025-11-24 12:06:30,607 - app.api.v1.endpoints.usuarios - INFO - Lista paginada de usuarios recuperada para cliente 2 - Total: 3, Página: 1
2025-11-24 12:06:30,609 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/roles/all-active/
2025-11-24 12:06:30,610 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 12:06:30,610 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': acme.app.local:5173
2025-11-24 12:06:30,610 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-11-24 12:06:30,610 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 12:06:30,610 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-11-24 12:06:30,611 - app.middleware.tenant_middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=2
2025-11-24 12:06:30,612 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=multi, bd=bd_cliente_acme, servidor=localhost
2025-11-24 12:06:30,612 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=2, db_type=multi, bd=bd_cliente_acme, path=/api/v1/roles/all-active/
2025-11-24 12:06:30,613 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:06:30,614 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:06:30,615 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:06:30,616 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:06:30,617 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:06:30,618 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:06:30,618 - app.api.v1.endpoints.roles - INFO - Solicitud GET /roles/all-active/ recibida por usuario 1 del cliente 2 para lista simple
2025-11-24 12:06:30,619 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:06:30,621 - app.services.rol_service - INFO - Se encontraron 3 roles activos para cliente 2
2025-11-24 12:06:30,621 - app.api.v1.endpoints.roles - INFO - Lista simple de roles activos recuperada para cliente 2 - Total: 3
2025-11-24 12:06:30,621 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/usuarios/ 200 44.7ms
2025-11-24 12:06:30,623 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/roles/all-active/ 200 13.7ms
2025-11-24 12:06:30,624 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/usuarios/
2025-11-24 12:06:30,625 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 12:06:30,625 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': acme.app.local:5173
2025-11-24 12:06:30,625 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-11-24 12:06:30,625 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 12:06:30,626 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-11-24 12:06:30,627 - app.middleware.tenant_middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=2
2025-11-24 12:06:30,627 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=multi, bd=bd_cliente_acme, servidor=localhost
2025-11-24 12:06:30,627 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=2, db_type=multi, bd=bd_cliente_acme, path=/api/v1/usuarios/
2025-11-24 12:06:30,628 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:06:30,630 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:06:30,631 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:06:30,631 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:06:30,632 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:06:30,633 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:06:30,634 - app.api.v1.endpoints.usuarios - INFO - Solicitud GET /usuarios/ recibida por usuario 1 del cliente 2 - Paginación: page=1, limit=10, Búsqueda: 'None'
2025-11-24 12:06:30,634 - app.services.usuario_service - INFO - Obteniendo usuarios paginados para cliente 2: page=1, limit=10, search='None'
2025-11-24 12:06:30,634 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:06:30,636 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:06:30,637 - app.services.usuario_service - INFO - Obtención paginada de usuarios completada exitosamente
2025-11-24 12:06:30,638 - app.api.v1.endpoints.usuarios - INFO - Lista paginada de usuarios recuperada para cliente 2 - Total: 3, Página: 1
2025-11-24 12:06:30,638 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/roles/all-active/
2025-11-24 12:06:30,639 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 12:06:30,639 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': acme.app.local:5173
2025-11-24 12:06:30,639 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-11-24 12:06:30,639 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 12:06:30,639 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-11-24 12:06:30,640 - app.middleware.tenant_middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=2
2025-11-24 12:06:30,640 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=multi, bd=bd_cliente_acme, servidor=localhost
2025-11-24 12:06:30,641 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=2, db_type=multi, bd=bd_cliente_acme, path=/api/v1/roles/all-active/
2025-11-24 12:06:30,641 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/usuarios/ 200 16.8ms
2025-11-24 12:06:30,641 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:06:30,642 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:06:30,643 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:06:30,644 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:06:30,645 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:06:30,646 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:06:30,647 - app.api.v1.endpoints.roles - INFO - Solicitud GET /roles/all-active/ recibida por usuario 1 del cliente 2 para lista simple
2025-11-24 12:06:30,647 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:06:30,648 - app.services.rol_service - INFO - Se encontraron 3 roles activos para cliente 2
2025-11-24 12:06:30,648 - app.api.v1.endpoints.roles - INFO - Lista simple de roles activos recuperada para cliente 2 - Total: 3
2025-11-24 12:06:30,649 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/roles/all-active/ 200 10.9ms
2025-11-24 12:45:24,608 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/roles/
2025-11-24 12:45:24,609 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/roles/
2025-11-24 12:45:24,609 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/roles/ 200 1.0ms
2025-11-24 12:45:24,610 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/roles/ 200 0.7ms
2025-11-24 12:45:24,612 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/roles/
2025-11-24 12:45:24,612 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 12:45:24,612 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': acme.app.local:5173
2025-11-24 12:45:24,613 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-11-24 12:45:24,613 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 12:45:24,613 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-11-24 12:45:24,628 - app.middleware.tenant_middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=2
2025-11-24 12:45:24,633 - app.core.multi_db - INFO - [METADATA] Metadata cargada para cliente 2: multi - bd_cliente_acme
2025-11-24 12:45:24,633 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=multi, bd=bd_cliente_acme, servidor=localhost
2025-11-24 12:45:24,633 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=2, db_type=multi, bd=bd_cliente_acme, path=/api/v1/roles/
2025-11-24 12:45:24,634 - app.api.deps - WARNING - Error de validación JWT: Signature has expired.
2025-11-24 12:45:24,635 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/roles/ 401 23.3ms
2025-11-24 12:45:24,637 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/roles/
2025-11-24 12:45:24,637 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 12:45:24,638 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': acme.app.local:5173
2025-11-24 12:45:24,638 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-11-24 12:45:24,639 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 12:45:24,639 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-11-24 12:45:24,640 - app.middleware.tenant_middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=2
2025-11-24 12:45:24,641 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=multi, bd=bd_cliente_acme, servidor=localhost
2025-11-24 12:45:24,641 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=2, db_type=multi, bd=bd_cliente_acme, path=/api/v1/roles/
2025-11-24 12:45:24,642 - app.api.deps - WARNING - Error de validación JWT: Signature has expired.
2025-11-24 12:45:24,643 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/auth/refresh/
2025-11-24 12:45:24,644 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/auth/refresh/ 200 0.7ms
2025-11-24 12:45:24,644 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/roles/ 401 7.0ms
2025-11-24 12:45:24,647 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/refresh/
2025-11-24 12:45:24,647 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 12:45:24,647 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': acme.app.local:5173
2025-11-24 12:45:24,647 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-11-24 12:45:24,648 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 12:45:24,648 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-11-24 12:45:24,649 - app.middleware.tenant_middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=2
2025-11-24 12:45:24,649 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=multi, bd=bd_cliente_acme, servidor=localhost
2025-11-24 12:45:24,649 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=2, db_type=multi, bd=bd_cliente_acme, path=/api/v1/auth/refresh/
2025-11-24 12:45:24,652 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:45:24,669 - app.services.refresh_token_service - INFO - [VALIDATE-TOKEN] Token válido - Cliente 2, Usuario 1, Tipo: web
2025-11-24 12:45:24,669 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:45:24,672 - app.core.auth - INFO - [REFRESH] Token validado exitosamente (BD OK) para usuario: admin_acme (Cliente: 2, Level: 4, Type: tenant_admin)
2025-11-24 12:45:24,673 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:45:24,680 - app.core.auth - INFO - Niveles calculados - Usuario 1: level=4, super_admin=False, type=tenant_admin
2025-11-24 12:45:24,681 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:45:24,682 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:45:24,685 - app.db.queries - INFO - Inserción exitosa, filas afectadas: -1
2025-11-24 12:45:24,685 - app.services.refresh_token_service - INFO - [STORE-TOKEN] Token insertado exitosamente - Cliente 2, Usuario 1, Tipo: web, Token ID: 2, Rotación: True
2025-11-24 12:45:24,685 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:45:24,691 - app.db.queries - INFO - Actualización exitosa, filas afectadas: -1
2025-11-24 12:45:24,692 - app.services.refresh_token_service - WARNING - [REVOKE-TOKEN] Token no encontrado o ya revocado - Cliente 2, Usuario 1
2025-11-24 12:45:24,692 - app.api.v1.endpoints.auth - WARNING - [REFRESH] Token antiguo no encontrado para revocar (no crítico)
2025-11-24 12:45:24,692 - app.api.v1.endpoints.auth - INFO - [REFRESH-WEB] Token rotado exitosamente - ID: 2
2025-11-24 12:45:24,692 - app.api.v1.endpoints.auth - INFO - [REFRESH-WEB] Token refrescado exitosamente - Usuario: admin_acme
2025-11-24 12:45:24,693 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/refresh/ 200 46.4ms
2025-11-24 12:45:24,697 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/roles/
2025-11-24 12:45:24,697 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 12:45:24,697 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': acme.app.local:5173
2025-11-24 12:45:24,698 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-11-24 12:45:24,698 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 12:45:24,698 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-11-24 12:45:24,699 - app.middleware.tenant_middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=2
2025-11-24 12:45:24,699 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=multi, bd=bd_cliente_acme, servidor=localhost
2025-11-24 12:45:24,699 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=2, db_type=multi, bd=bd_cliente_acme, path=/api/v1/roles/
2025-11-24 12:45:24,700 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:45:24,701 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:45:24,702 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:45:24,703 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:45:24,704 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:45:24,705 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:45:24,706 - app.api.v1.endpoints.roles - INFO - Solicitud GET /roles/ recibida por usuario 1 del cliente 2 - Paginación: page=1, limit=10, Búsqueda: 'None'
2025-11-24 12:45:24,707 - app.services.rol_service - INFO - Obteniendo roles paginados para cliente 2: page=1, limit=10, search='None'
2025-11-24 12:45:24,707 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:45:24,712 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:45:24,716 - app.services.rol_service - INFO - Obtención paginada de roles para cliente 2 completada exitosamente
2025-11-24 12:45:24,716 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/roles/ N/A 19.7ms
2025-11-24 12:45:24,717 - app.core.exceptions - ERROR - Error no manejado: 3 validation errors:
  {'type': 'value_error', 'loc': ('response', 'roles', 0), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 1, 'nombre': 'Administrador', 'descripcion': 'Administrador con acceso completo', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'ADMIN'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
  {'type': 'value_error', 'loc': ('response', 'roles', 1), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 2, 'nombre': 'Supervisor', 'descripcion': 'Supervisor de departamento', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'SUPERVISOR'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
  {'type': 'value_error', 'loc': ('response', 'roles', 2), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 3, 'nombre': 'Usuario', 'descripcion': 'Usuario estándar', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'USER'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
  + Exception Group Traceback (most recent call last):
  |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 76, in collapse_excgroups
  |     yield
  |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 186, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ~~~~~~~~~~~~~~~~~~~~~~~^^
  |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\anyio\_backends\_asyncio.py", line 815, in __aexit__
  |     raise BaseExceptionGroup(
  |         "unhandled errors in a TaskGroup", self._exceptions
  |     )
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\errors.py", line 165, in __call__
    |     await self.app(scope, receive, _send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    |     with collapse_excgroups():
    |          ~~~~~~~~~~~~~~~~~~^^
    |   File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\app\main.py", line 190, in security_headers
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    |     raise app_exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    |     with collapse_excgroups():
    |          ~~~~~~~~~~~~~~~~~~^^
    |   File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\app\main.py", line 181, in log_requests
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    |     raise app_exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    |     with collapse_excgroups():
    |          ~~~~~~~~~~~~~~~~~~^^
    |   File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\app\main.py", line 158, in cors_middleware
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    |     raise app_exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    |     with collapse_excgroups():
    |          ~~~~~~~~~~~~~~~~~~^^
    |   File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\app\middleware\tenant_middleware.py", line 293, in dispatch
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    |     raise app_exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\exceptions.py", line 62, in __call__
    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 715, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 735, in app
    |     await route.handle(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 288, in handle
    |     await self.app(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 76, in app
    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 73, in app
    |     response = await f(request)
    |                ^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\fastapi\routing.py", line 327, in app
    |     content = await serialize_response(
    |               ^^^^^^^^^^^^^^^^^^^^^^^^^
    |     ...<9 lines>...
    |     )
    |     ^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\fastapi\routing.py", line 176, in serialize_response
    |     raise ResponseValidationError(
    |         errors=_normalize_errors(errors), body=response_content
    |     )
    | fastapi.exceptions.ResponseValidationError: 3 validation errors:
    |   {'type': 'value_error', 'loc': ('response', 'roles', 0), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 1, 'nombre': 'Administrador', 'descripcion': 'Administrador con acceso completo', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'ADMIN'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
    |   {'type': 'value_error', 'loc': ('response', 'roles', 1), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 2, 'nombre': 'Supervisor', 'descripcion': 'Supervisor de departamento', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'SUPERVISOR'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
    |   {'type': 'value_error', 'loc': ('response', 'roles', 2), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 3, 'nombre': 'Usuario', 'descripcion': 'Usuario estándar', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'USER'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
    | 
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\errors.py", line 165, in __call__
    await self.app(scope, receive, _send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    with collapse_excgroups():
         ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\main.py", line 190, in security_headers
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    raise app_exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    with collapse_excgroups():
         ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\main.py", line 181, in log_requests
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    raise app_exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    with collapse_excgroups():
         ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\main.py", line 158, in cors_middleware
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    raise app_exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    with collapse_excgroups():
         ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\middleware\tenant_middleware.py", line 293, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    raise app_exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 715, in __call__
    await self.middleware_stack(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 735, in app
    await route.handle(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 288, in handle
    await self.app(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 76, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 73, in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\fastapi\routing.py", line 327, in app
    content = await serialize_response(
              ^^^^^^^^^^^^^^^^^^^^^^^^^
    ...<9 lines>...
    )
    ^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\fastapi\routing.py", line 176, in serialize_response
    raise ResponseValidationError(
        errors=_normalize_errors(errors), body=response_content
    )
fastapi.exceptions.ResponseValidationError: 3 validation errors:
  {'type': 'value_error', 'loc': ('response', 'roles', 0), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 1, 'nombre': 'Administrador', 'descripcion': 'Administrador con acceso completo', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'ADMIN'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
  {'type': 'value_error', 'loc': ('response', 'roles', 1), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 2, 'nombre': 'Supervisor', 'descripcion': 'Supervisor de departamento', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'SUPERVISOR'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
  {'type': 'value_error', 'loc': ('response', 'roles', 2), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 3, 'nombre': 'Usuario', 'descripcion': 'Usuario estándar', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'USER'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}

2025-11-24 12:45:24,743 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/roles/
2025-11-24 12:45:24,743 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 12:45:24,744 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': acme.app.local:5173
2025-11-24 12:45:24,744 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-11-24 12:45:24,744 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 12:45:24,744 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-11-24 12:45:24,745 - app.middleware.tenant_middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=2
2025-11-24 12:45:24,745 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=multi, bd=bd_cliente_acme, servidor=localhost
2025-11-24 12:45:24,745 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=2, db_type=multi, bd=bd_cliente_acme, path=/api/v1/roles/
2025-11-24 12:45:24,746 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:45:24,747 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:45:24,748 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:45:24,749 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:45:24,749 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:45:24,750 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:45:24,751 - app.api.v1.endpoints.roles - INFO - Solicitud GET /roles/ recibida por usuario 1 del cliente 2 - Paginación: page=1, limit=10, Búsqueda: 'None'
2025-11-24 12:45:24,751 - app.services.rol_service - INFO - Obteniendo roles paginados para cliente 2: page=1, limit=10, search='None'
2025-11-24 12:45:24,752 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:45:24,753 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:45:24,755 - app.services.rol_service - INFO - Obtención paginada de roles para cliente 2 completada exitosamente
2025-11-24 12:45:24,756 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/roles/ N/A 13.3ms
2025-11-24 12:45:24,757 - app.core.exceptions - ERROR - Error no manejado: 3 validation errors:
  {'type': 'value_error', 'loc': ('response', 'roles', 0), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 1, 'nombre': 'Administrador', 'descripcion': 'Administrador con acceso completo', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'ADMIN'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
  {'type': 'value_error', 'loc': ('response', 'roles', 1), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 2, 'nombre': 'Supervisor', 'descripcion': 'Supervisor de departamento', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'SUPERVISOR'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
  {'type': 'value_error', 'loc': ('response', 'roles', 2), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 3, 'nombre': 'Usuario', 'descripcion': 'Usuario estándar', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'USER'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
  + Exception Group Traceback (most recent call last):
  |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 76, in collapse_excgroups
  |     yield
  |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 186, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ~~~~~~~~~~~~~~~~~~~~~~~^^
  |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\anyio\_backends\_asyncio.py", line 815, in __aexit__
  |     raise BaseExceptionGroup(
  |         "unhandled errors in a TaskGroup", self._exceptions
  |     )
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\errors.py", line 165, in __call__
    |     await self.app(scope, receive, _send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    |     with collapse_excgroups():
    |          ~~~~~~~~~~~~~~~~~~^^
    |   File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\app\main.py", line 190, in security_headers
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    |     raise app_exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    |     with collapse_excgroups():
    |          ~~~~~~~~~~~~~~~~~~^^
    |   File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\app\main.py", line 181, in log_requests
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    |     raise app_exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    |     with collapse_excgroups():
    |          ~~~~~~~~~~~~~~~~~~^^
    |   File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\app\main.py", line 158, in cors_middleware
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    |     raise app_exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    |     with collapse_excgroups():
    |          ~~~~~~~~~~~~~~~~~~^^
    |   File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\app\middleware\tenant_middleware.py", line 293, in dispatch
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    |     raise app_exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\exceptions.py", line 62, in __call__
    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 715, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 735, in app
    |     await route.handle(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 288, in handle
    |     await self.app(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 76, in app
    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 73, in app
    |     response = await f(request)
    |                ^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\fastapi\routing.py", line 327, in app
    |     content = await serialize_response(
    |               ^^^^^^^^^^^^^^^^^^^^^^^^^
    |     ...<9 lines>...
    |     )
    |     ^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\fastapi\routing.py", line 176, in serialize_response
    |     raise ResponseValidationError(
    |         errors=_normalize_errors(errors), body=response_content
    |     )
    | fastapi.exceptions.ResponseValidationError: 3 validation errors:
    |   {'type': 'value_error', 'loc': ('response', 'roles', 0), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 1, 'nombre': 'Administrador', 'descripcion': 'Administrador con acceso completo', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'ADMIN'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
    |   {'type': 'value_error', 'loc': ('response', 'roles', 1), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 2, 'nombre': 'Supervisor', 'descripcion': 'Supervisor de departamento', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'SUPERVISOR'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
    |   {'type': 'value_error', 'loc': ('response', 'roles', 2), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 3, 'nombre': 'Usuario', 'descripcion': 'Usuario estándar', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'USER'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
    | 
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\errors.py", line 165, in __call__
    await self.app(scope, receive, _send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    with collapse_excgroups():
         ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\main.py", line 190, in security_headers
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    raise app_exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    with collapse_excgroups():
         ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\main.py", line 181, in log_requests
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    raise app_exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    with collapse_excgroups():
         ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\main.py", line 158, in cors_middleware
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    raise app_exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    with collapse_excgroups():
         ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\middleware\tenant_middleware.py", line 293, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    raise app_exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 715, in __call__
    await self.middleware_stack(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 735, in app
    await route.handle(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 288, in handle
    await self.app(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 76, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 73, in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\fastapi\routing.py", line 327, in app
    content = await serialize_response(
              ^^^^^^^^^^^^^^^^^^^^^^^^^
    ...<9 lines>...
    )
    ^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\fastapi\routing.py", line 176, in serialize_response
    raise ResponseValidationError(
        errors=_normalize_errors(errors), body=response_content
    )
fastapi.exceptions.ResponseValidationError: 3 validation errors:
  {'type': 'value_error', 'loc': ('response', 'roles', 0), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 1, 'nombre': 'Administrador', 'descripcion': 'Administrador con acceso completo', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'ADMIN'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
  {'type': 'value_error', 'loc': ('response', 'roles', 1), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 2, 'nombre': 'Supervisor', 'descripcion': 'Supervisor de departamento', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'SUPERVISOR'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
  {'type': 'value_error', 'loc': ('response', 'roles', 2), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 3, 'nombre': 'Usuario', 'descripcion': 'Usuario estándar', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'USER'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}

2025-11-24 12:45:25,685 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/usuarios/
2025-11-24 12:45:25,687 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/usuarios/ 200 1.6ms
2025-11-24 12:45:25,687 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/roles/all-active/
2025-11-24 12:45:25,688 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/roles/all-active/ 200 1.5ms
2025-11-24 12:45:25,689 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/usuarios/
2025-11-24 12:45:25,689 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/roles/all-active/
2025-11-24 12:45:25,690 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/usuarios/ 200 1.6ms
2025-11-24 12:45:25,691 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/roles/all-active/ 200 1.6ms
2025-11-24 12:45:25,693 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/usuarios/
2025-11-24 12:45:25,694 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 12:45:25,694 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': acme.app.local:5173
2025-11-24 12:45:25,694 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-11-24 12:45:25,694 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 12:45:25,694 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-11-24 12:45:25,695 - app.middleware.tenant_middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=2
2025-11-24 12:45:25,696 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=multi, bd=bd_cliente_acme, servidor=localhost
2025-11-24 12:45:25,696 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=2, db_type=multi, bd=bd_cliente_acme, path=/api/v1/usuarios/
2025-11-24 12:45:25,697 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:45:25,698 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:45:25,699 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:45:25,700 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:45:25,701 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:45:25,702 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:45:25,702 - app.api.v1.endpoints.usuarios - INFO - Solicitud GET /usuarios/ recibida por usuario 1 del cliente 2 - Paginación: page=1, limit=10, Búsqueda: 'None'
2025-11-24 12:45:25,703 - app.services.usuario_service - INFO - Obteniendo usuarios paginados para cliente 2: page=1, limit=10, search='None'
2025-11-24 12:45:25,703 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:45:25,707 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:45:25,714 - app.services.usuario_service - INFO - Obtención paginada de usuarios completada exitosamente
2025-11-24 12:45:25,715 - app.api.v1.endpoints.usuarios - INFO - Lista paginada de usuarios recuperada para cliente 2 - Total: 3, Página: 1
2025-11-24 12:45:25,715 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/roles/all-active/
2025-11-24 12:45:25,716 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 12:45:25,716 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': acme.app.local:5173
2025-11-24 12:45:25,716 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-11-24 12:45:25,716 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 12:45:25,716 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-11-24 12:45:25,717 - app.middleware.tenant_middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=2
2025-11-24 12:45:25,717 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=multi, bd=bd_cliente_acme, servidor=localhost
2025-11-24 12:45:25,717 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=2, db_type=multi, bd=bd_cliente_acme, path=/api/v1/roles/all-active/
2025-11-24 12:45:25,718 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:45:25,718 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:45:25,719 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:45:25,720 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:45:25,721 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:45:25,721 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:45:25,722 - app.api.v1.endpoints.roles - INFO - Solicitud GET /roles/all-active/ recibida por usuario 1 del cliente 2 para lista simple
2025-11-24 12:45:25,723 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:45:25,725 - app.services.rol_service - INFO - Se encontraron 3 roles activos para cliente 2
2025-11-24 12:45:25,725 - app.api.v1.endpoints.roles - INFO - Lista simple de roles activos recuperada para cliente 2 - Total: 3
2025-11-24 12:45:25,726 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/usuarios/ 200 33.0ms
2025-11-24 12:45:25,727 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/roles/all-active/ 200 11.7ms
2025-11-24 12:45:25,728 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/usuarios/
2025-11-24 12:45:25,729 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 12:45:25,729 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': acme.app.local:5173
2025-11-24 12:45:25,729 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-11-24 12:45:25,729 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 12:45:25,730 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-11-24 12:45:25,730 - app.middleware.tenant_middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=2
2025-11-24 12:45:25,731 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=multi, bd=bd_cliente_acme, servidor=localhost
2025-11-24 12:45:25,731 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=2, db_type=multi, bd=bd_cliente_acme, path=/api/v1/usuarios/
2025-11-24 12:45:25,732 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:45:25,733 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:45:25,733 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:45:25,734 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:45:25,735 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:45:25,735 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:45:25,736 - app.api.v1.endpoints.usuarios - INFO - Solicitud GET /usuarios/ recibida por usuario 1 del cliente 2 - Paginación: page=1, limit=10, Búsqueda: 'None'
2025-11-24 12:45:25,736 - app.services.usuario_service - INFO - Obteniendo usuarios paginados para cliente 2: page=1, limit=10, search='None'
2025-11-24 12:45:25,736 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:45:25,738 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:45:25,741 - app.services.usuario_service - INFO - Obtención paginada de usuarios completada exitosamente
2025-11-24 12:45:25,741 - app.api.v1.endpoints.usuarios - INFO - Lista paginada de usuarios recuperada para cliente 2 - Total: 3, Página: 1
2025-11-24 12:45:25,742 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/roles/all-active/
2025-11-24 12:45:25,742 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 12:45:25,743 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': acme.app.local:5173
2025-11-24 12:45:25,743 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-11-24 12:45:25,743 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 12:45:25,743 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-11-24 12:45:25,744 - app.middleware.tenant_middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=2
2025-11-24 12:45:25,744 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=multi, bd=bd_cliente_acme, servidor=localhost
2025-11-24 12:45:25,744 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=2, db_type=multi, bd=bd_cliente_acme, path=/api/v1/roles/all-active/
2025-11-24 12:45:25,745 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:45:25,745 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:45:25,746 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:45:25,747 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:45:25,748 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:45:25,748 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:45:25,749 - app.api.v1.endpoints.roles - INFO - Solicitud GET /roles/all-active/ recibida por usuario 1 del cliente 2 para lista simple
2025-11-24 12:45:25,749 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:45:25,750 - app.services.rol_service - INFO - Se encontraron 3 roles activos para cliente 2
2025-11-24 12:45:25,750 - app.api.v1.endpoints.roles - INFO - Lista simple de roles activos recuperada para cliente 2 - Total: 3
2025-11-24 12:45:25,750 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/usuarios/ 200 21.7ms
2025-11-24 12:45:25,751 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/roles/all-active/ 200 9.2ms
2025-11-24 12:45:29,238 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/roles/
2025-11-24 12:45:29,238 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 12:45:29,239 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': acme.app.local:5173
2025-11-24 12:45:29,239 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-11-24 12:45:29,239 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 12:45:29,239 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-11-24 12:45:29,240 - app.middleware.tenant_middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=2
2025-11-24 12:45:29,240 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=multi, bd=bd_cliente_acme, servidor=localhost
2025-11-24 12:45:29,240 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=2, db_type=multi, bd=bd_cliente_acme, path=/api/v1/roles/
2025-11-24 12:45:29,241 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:45:29,242 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:45:29,244 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:45:29,245 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:45:29,246 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:45:29,247 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:45:29,248 - app.api.v1.endpoints.roles - INFO - Solicitud GET /roles/ recibida por usuario 1 del cliente 2 - Paginación: page=1, limit=10, Búsqueda: 'None'
2025-11-24 12:45:29,249 - app.services.rol_service - INFO - Obteniendo roles paginados para cliente 2: page=1, limit=10, search='None'
2025-11-24 12:45:29,249 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:45:29,250 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:45:29,252 - app.services.rol_service - INFO - Obtención paginada de roles para cliente 2 completada exitosamente
2025-11-24 12:45:29,253 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/roles/ N/A 14.9ms
2025-11-24 12:45:29,253 - app.core.exceptions - ERROR - Error no manejado: 3 validation errors:
  {'type': 'value_error', 'loc': ('response', 'roles', 0), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 1, 'nombre': 'Administrador', 'descripcion': 'Administrador con acceso completo', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'ADMIN'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
  {'type': 'value_error', 'loc': ('response', 'roles', 1), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 2, 'nombre': 'Supervisor', 'descripcion': 'Supervisor de departamento', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'SUPERVISOR'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
  {'type': 'value_error', 'loc': ('response', 'roles', 2), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 3, 'nombre': 'Usuario', 'descripcion': 'Usuario estándar', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'USER'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
  + Exception Group Traceback (most recent call last):
  |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 76, in collapse_excgroups
  |     yield
  |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 186, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ~~~~~~~~~~~~~~~~~~~~~~~^^
  |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\anyio\_backends\_asyncio.py", line 815, in __aexit__
  |     raise BaseExceptionGroup(
  |         "unhandled errors in a TaskGroup", self._exceptions
  |     )
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\errors.py", line 165, in __call__
    |     await self.app(scope, receive, _send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    |     with collapse_excgroups():
    |          ~~~~~~~~~~~~~~~~~~^^
    |   File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\app\main.py", line 190, in security_headers
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    |     raise app_exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    |     with collapse_excgroups():
    |          ~~~~~~~~~~~~~~~~~~^^
    |   File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\app\main.py", line 181, in log_requests
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    |     raise app_exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    |     with collapse_excgroups():
    |          ~~~~~~~~~~~~~~~~~~^^
    |   File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\app\main.py", line 158, in cors_middleware
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    |     raise app_exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    |     with collapse_excgroups():
    |          ~~~~~~~~~~~~~~~~~~^^
    |   File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\app\middleware\tenant_middleware.py", line 293, in dispatch
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    |     raise app_exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\exceptions.py", line 62, in __call__
    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 715, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 735, in app
    |     await route.handle(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 288, in handle
    |     await self.app(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 76, in app
    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 73, in app
    |     response = await f(request)
    |                ^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\fastapi\routing.py", line 327, in app
    |     content = await serialize_response(
    |               ^^^^^^^^^^^^^^^^^^^^^^^^^
    |     ...<9 lines>...
    |     )
    |     ^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\fastapi\routing.py", line 176, in serialize_response
    |     raise ResponseValidationError(
    |         errors=_normalize_errors(errors), body=response_content
    |     )
    | fastapi.exceptions.ResponseValidationError: 3 validation errors:
    |   {'type': 'value_error', 'loc': ('response', 'roles', 0), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 1, 'nombre': 'Administrador', 'descripcion': 'Administrador con acceso completo', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'ADMIN'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
    |   {'type': 'value_error', 'loc': ('response', 'roles', 1), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 2, 'nombre': 'Supervisor', 'descripcion': 'Supervisor de departamento', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'SUPERVISOR'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
    |   {'type': 'value_error', 'loc': ('response', 'roles', 2), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 3, 'nombre': 'Usuario', 'descripcion': 'Usuario estándar', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'USER'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
    | 
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\errors.py", line 165, in __call__
    await self.app(scope, receive, _send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    with collapse_excgroups():
         ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\main.py", line 190, in security_headers
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    raise app_exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    with collapse_excgroups():
         ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\main.py", line 181, in log_requests
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    raise app_exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    with collapse_excgroups():
         ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\main.py", line 158, in cors_middleware
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    raise app_exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    with collapse_excgroups():
         ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\middleware\tenant_middleware.py", line 293, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    raise app_exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 715, in __call__
    await self.middleware_stack(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 735, in app
    await route.handle(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 288, in handle
    await self.app(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 76, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 73, in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\fastapi\routing.py", line 327, in app
    content = await serialize_response(
              ^^^^^^^^^^^^^^^^^^^^^^^^^
    ...<9 lines>...
    )
    ^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\fastapi\routing.py", line 176, in serialize_response
    raise ResponseValidationError(
        errors=_normalize_errors(errors), body=response_content
    )
fastapi.exceptions.ResponseValidationError: 3 validation errors:
  {'type': 'value_error', 'loc': ('response', 'roles', 0), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 1, 'nombre': 'Administrador', 'descripcion': 'Administrador con acceso completo', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'ADMIN'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
  {'type': 'value_error', 'loc': ('response', 'roles', 1), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 2, 'nombre': 'Supervisor', 'descripcion': 'Supervisor de departamento', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'SUPERVISOR'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
  {'type': 'value_error', 'loc': ('response', 'roles', 2), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 3, 'nombre': 'Usuario', 'descripcion': 'Usuario estándar', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'USER'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}

2025-11-24 12:45:29,281 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/roles/
2025-11-24 12:45:29,281 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 12:45:29,281 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': acme.app.local:5173
2025-11-24 12:45:29,282 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-11-24 12:45:29,282 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 12:45:29,282 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-11-24 12:45:29,283 - app.middleware.tenant_middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=2
2025-11-24 12:45:29,283 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=multi, bd=bd_cliente_acme, servidor=localhost
2025-11-24 12:45:29,283 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=2, db_type=multi, bd=bd_cliente_acme, path=/api/v1/roles/
2025-11-24 12:45:29,284 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:45:29,285 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:45:29,286 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:45:29,287 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:45:29,287 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:45:29,288 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:45:29,289 - app.api.v1.endpoints.roles - INFO - Solicitud GET /roles/ recibida por usuario 1 del cliente 2 - Paginación: page=1, limit=10, Búsqueda: 'None'
2025-11-24 12:45:29,289 - app.services.rol_service - INFO - Obteniendo roles paginados para cliente 2: page=1, limit=10, search='None'
2025-11-24 12:45:29,289 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:45:29,291 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:45:29,293 - app.services.rol_service - INFO - Obtención paginada de roles para cliente 2 completada exitosamente
2025-11-24 12:45:29,293 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/roles/ N/A 12.7ms
2025-11-24 12:45:29,294 - app.core.exceptions - ERROR - Error no manejado: 3 validation errors:
  {'type': 'value_error', 'loc': ('response', 'roles', 0), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 1, 'nombre': 'Administrador', 'descripcion': 'Administrador con acceso completo', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'ADMIN'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
  {'type': 'value_error', 'loc': ('response', 'roles', 1), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 2, 'nombre': 'Supervisor', 'descripcion': 'Supervisor de departamento', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'SUPERVISOR'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
  {'type': 'value_error', 'loc': ('response', 'roles', 2), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 3, 'nombre': 'Usuario', 'descripcion': 'Usuario estándar', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'USER'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
  + Exception Group Traceback (most recent call last):
  |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 76, in collapse_excgroups
  |     yield
  |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 186, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ~~~~~~~~~~~~~~~~~~~~~~~^^
  |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\anyio\_backends\_asyncio.py", line 815, in __aexit__
  |     raise BaseExceptionGroup(
  |         "unhandled errors in a TaskGroup", self._exceptions
  |     )
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\errors.py", line 165, in __call__
    |     await self.app(scope, receive, _send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    |     with collapse_excgroups():
    |          ~~~~~~~~~~~~~~~~~~^^
    |   File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\app\main.py", line 190, in security_headers
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    |     raise app_exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    |     with collapse_excgroups():
    |          ~~~~~~~~~~~~~~~~~~^^
    |   File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\app\main.py", line 181, in log_requests
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    |     raise app_exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    |     with collapse_excgroups():
    |          ~~~~~~~~~~~~~~~~~~^^
    |   File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\app\main.py", line 158, in cors_middleware
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    |     raise app_exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    |     with collapse_excgroups():
    |          ~~~~~~~~~~~~~~~~~~^^
    |   File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\app\middleware\tenant_middleware.py", line 293, in dispatch
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    |     raise app_exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\exceptions.py", line 62, in __call__
    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 715, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 735, in app
    |     await route.handle(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 288, in handle
    |     await self.app(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 76, in app
    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 73, in app
    |     response = await f(request)
    |                ^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\fastapi\routing.py", line 327, in app
    |     content = await serialize_response(
    |               ^^^^^^^^^^^^^^^^^^^^^^^^^
    |     ...<9 lines>...
    |     )
    |     ^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\fastapi\routing.py", line 176, in serialize_response
    |     raise ResponseValidationError(
    |         errors=_normalize_errors(errors), body=response_content
    |     )
    | fastapi.exceptions.ResponseValidationError: 3 validation errors:
    |   {'type': 'value_error', 'loc': ('response', 'roles', 0), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 1, 'nombre': 'Administrador', 'descripcion': 'Administrador con acceso completo', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'ADMIN'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
    |   {'type': 'value_error', 'loc': ('response', 'roles', 1), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 2, 'nombre': 'Supervisor', 'descripcion': 'Supervisor de departamento', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'SUPERVISOR'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
    |   {'type': 'value_error', 'loc': ('response', 'roles', 2), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 3, 'nombre': 'Usuario', 'descripcion': 'Usuario estándar', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'USER'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
    | 
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\errors.py", line 165, in __call__
    await self.app(scope, receive, _send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    with collapse_excgroups():
         ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\main.py", line 190, in security_headers
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    raise app_exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    with collapse_excgroups():
         ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\main.py", line 181, in log_requests
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    raise app_exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    with collapse_excgroups():
         ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\main.py", line 158, in cors_middleware
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    raise app_exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    with collapse_excgroups():
         ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\middleware\tenant_middleware.py", line 293, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    raise app_exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 715, in __call__
    await self.middleware_stack(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 735, in app
    await route.handle(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 288, in handle
    await self.app(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 76, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 73, in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\fastapi\routing.py", line 327, in app
    content = await serialize_response(
              ^^^^^^^^^^^^^^^^^^^^^^^^^
    ...<9 lines>...
    )
    ^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\fastapi\routing.py", line 176, in serialize_response
    raise ResponseValidationError(
        errors=_normalize_errors(errors), body=response_content
    )
fastapi.exceptions.ResponseValidationError: 3 validation errors:
  {'type': 'value_error', 'loc': ('response', 'roles', 0), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 1, 'nombre': 'Administrador', 'descripcion': 'Administrador con acceso completo', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'ADMIN'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
  {'type': 'value_error', 'loc': ('response', 'roles', 1), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 2, 'nombre': 'Supervisor', 'descripcion': 'Supervisor de departamento', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'SUPERVISOR'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
  {'type': 'value_error', 'loc': ('response', 'roles', 2), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 3, 'nombre': 'Usuario', 'descripcion': 'Usuario estándar', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'USER'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}

2025-11-24 12:45:29,883 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/areas/
2025-11-24 12:45:29,884 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/areas/ 200 0.9ms
2025-11-24 12:45:29,885 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/areas/
2025-11-24 12:45:29,885 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/areas/ 200 0.7ms
2025-11-24 12:45:29,887 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/areas/
2025-11-24 12:45:29,887 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 12:45:29,887 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': acme.app.local:5173
2025-11-24 12:45:29,887 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-11-24 12:45:29,887 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 12:45:29,888 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-11-24 12:45:29,889 - app.middleware.tenant_middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=2
2025-11-24 12:45:29,889 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=multi, bd=bd_cliente_acme, servidor=localhost
2025-11-24 12:45:29,890 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=2, db_type=multi, bd=bd_cliente_acme, path=/api/v1/areas/
2025-11-24 12:45:29,891 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:45:29,893 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:45:29,894 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:45:29,896 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:45:29,897 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:45:29,898 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:45:29,899 - app.api.v1.endpoints.areas - INFO - Solicitud GET /areas/ recibida por usuario 1 del cliente 2 - Paginación: skip=0, limit=10, Búsqueda: 'None'
2025-11-24 12:45:29,899 - app.services.area_service - INFO - Obteniendo áreas paginadas para cliente 2: skip=0, limit=10, search='None'
2025-11-24 12:45:29,899 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:45:29,903 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:45:29,906 - app.services.area_service - INFO - Paginación completada para cliente 2: 2 áreas de 2 totales
2025-11-24 12:45:29,907 - app.api.v1.endpoints.areas - INFO - Lista paginada de áreas recuperada para cliente 2 - Total: 2, Página: 1
2025-11-24 12:45:29,907 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/areas/ 200 20.8ms
2025-11-24 12:45:29,909 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/areas/
2025-11-24 12:45:29,909 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 12:45:29,910 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': acme.app.local:5173
2025-11-24 12:45:29,910 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-11-24 12:45:29,910 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 12:45:29,910 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-11-24 12:45:29,911 - app.middleware.tenant_middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=2
2025-11-24 12:45:29,912 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=multi, bd=bd_cliente_acme, servidor=localhost
2025-11-24 12:45:29,912 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=2, db_type=multi, bd=bd_cliente_acme, path=/api/v1/areas/
2025-11-24 12:45:29,913 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:45:29,914 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:45:29,914 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:45:29,915 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:45:29,916 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:45:29,916 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:45:29,918 - app.api.v1.endpoints.areas - INFO - Solicitud GET /areas/ recibida por usuario 1 del cliente 2 - Paginación: skip=0, limit=10, Búsqueda: 'None'
2025-11-24 12:45:29,918 - app.services.area_service - INFO - Obteniendo áreas paginadas para cliente 2: skip=0, limit=10, search='None'
2025-11-24 12:45:29,918 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:45:29,920 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:45:29,921 - app.services.area_service - INFO - Paginación completada para cliente 2: 2 áreas de 2 totales
2025-11-24 12:45:29,921 - app.api.v1.endpoints.areas - INFO - Lista paginada de áreas recuperada para cliente 2 - Total: 2, Página: 1
2025-11-24 12:45:29,922 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/areas/ 200 12.9ms
2025-11-24 12:46:07,203 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/usuarios/
2025-11-24 12:46:07,203 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 12:46:07,204 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': acme.app.local:5173
2025-11-24 12:46:07,204 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-11-24 12:46:07,204 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 12:46:07,204 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-11-24 12:46:07,208 - app.middleware.tenant_middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=2
2025-11-24 12:46:07,208 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=multi, bd=bd_cliente_acme, servidor=localhost
2025-11-24 12:46:07,208 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=2, db_type=multi, bd=bd_cliente_acme, path=/api/v1/usuarios/
2025-11-24 12:46:07,209 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:46:07,211 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:46:07,215 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:46:07,216 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:46:07,217 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:46:07,218 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:46:07,219 - app.api.v1.endpoints.usuarios - INFO - Solicitud GET /usuarios/ recibida por usuario 1 del cliente 2 - Paginación: page=1, limit=10, Búsqueda: 'None'
2025-11-24 12:46:07,219 - app.services.usuario_service - INFO - Obteniendo usuarios paginados para cliente 2: page=1, limit=10, search='None'
2025-11-24 12:46:07,220 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:46:07,225 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:46:07,234 - app.services.usuario_service - INFO - Obtención paginada de usuarios completada exitosamente
2025-11-24 12:46:07,234 - app.api.v1.endpoints.usuarios - INFO - Lista paginada de usuarios recuperada para cliente 2 - Total: 3, Página: 1
2025-11-24 12:46:07,235 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/roles/all-active/
2025-11-24 12:46:07,236 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 12:46:07,236 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': acme.app.local:5173
2025-11-24 12:46:07,236 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-11-24 12:46:07,236 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 12:46:07,236 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-11-24 12:46:07,237 - app.middleware.tenant_middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=2
2025-11-24 12:46:07,237 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=multi, bd=bd_cliente_acme, servidor=localhost
2025-11-24 12:46:07,237 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=2, db_type=multi, bd=bd_cliente_acme, path=/api/v1/roles/all-active/
2025-11-24 12:46:07,238 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/usuarios/ 200 34.9ms
2025-11-24 12:46:07,239 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:46:07,240 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:46:07,241 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:46:07,242 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:46:07,243 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:46:07,243 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:46:07,244 - app.api.v1.endpoints.roles - INFO - Solicitud GET /roles/all-active/ recibida por usuario 1 del cliente 2 para lista simple
2025-11-24 12:46:07,245 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:46:07,248 - app.services.rol_service - INFO - Se encontraron 3 roles activos para cliente 2
2025-11-24 12:46:07,248 - app.api.v1.endpoints.roles - INFO - Lista simple de roles activos recuperada para cliente 2 - Total: 3
2025-11-24 12:46:07,250 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/roles/all-active/ 200 15.1ms
2025-11-24 12:46:07,252 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/usuarios/
2025-11-24 12:46:07,253 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 12:46:07,253 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': acme.app.local:5173
2025-11-24 12:46:07,253 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-11-24 12:46:07,254 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 12:46:07,254 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-11-24 12:46:07,255 - app.middleware.tenant_middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=2
2025-11-24 12:46:07,255 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=multi, bd=bd_cliente_acme, servidor=localhost
2025-11-24 12:46:07,256 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=2, db_type=multi, bd=bd_cliente_acme, path=/api/v1/usuarios/
2025-11-24 12:46:07,257 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:46:07,258 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:46:07,259 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:46:07,260 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:46:07,261 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:46:07,263 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:46:07,264 - app.api.v1.endpoints.usuarios - INFO - Solicitud GET /usuarios/ recibida por usuario 1 del cliente 2 - Paginación: page=1, limit=10, Búsqueda: 'None'
2025-11-24 12:46:07,265 - app.services.usuario_service - INFO - Obteniendo usuarios paginados para cliente 2: page=1, limit=10, search='None'
2025-11-24 12:46:07,265 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:46:07,267 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:46:07,269 - app.services.usuario_service - INFO - Obtención paginada de usuarios completada exitosamente
2025-11-24 12:46:07,269 - app.api.v1.endpoints.usuarios - INFO - Lista paginada de usuarios recuperada para cliente 2 - Total: 3, Página: 1
2025-11-24 12:46:07,270 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/roles/all-active/
2025-11-24 12:46:07,271 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 12:46:07,271 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': acme.app.local:5173
2025-11-24 12:46:07,271 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-11-24 12:46:07,271 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 12:46:07,271 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-11-24 12:46:07,272 - app.middleware.tenant_middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=2
2025-11-24 12:46:07,272 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=multi, bd=bd_cliente_acme, servidor=localhost
2025-11-24 12:46:07,273 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=2, db_type=multi, bd=bd_cliente_acme, path=/api/v1/roles/all-active/
2025-11-24 12:46:07,273 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/usuarios/ 200 21.2ms
2025-11-24 12:46:07,273 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:46:07,274 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:46:07,275 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:46:07,276 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:46:07,277 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:46:07,278 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:46:07,279 - app.api.v1.endpoints.roles - INFO - Solicitud GET /roles/all-active/ recibida por usuario 1 del cliente 2 para lista simple
2025-11-24 12:46:07,279 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:46:07,281 - app.services.rol_service - INFO - Se encontraron 3 roles activos para cliente 2
2025-11-24 12:46:07,281 - app.api.v1.endpoints.roles - INFO - Lista simple de roles activos recuperada para cliente 2 - Total: 3
2025-11-24 12:46:07,282 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/roles/all-active/ 200 12.3ms
2025-11-24 12:46:27,624 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/areas/
2025-11-24 12:46:27,624 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 12:46:27,624 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': acme.app.local:5173
2025-11-24 12:46:27,624 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-11-24 12:46:27,625 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 12:46:27,625 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-11-24 12:46:27,626 - app.middleware.tenant_middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=2
2025-11-24 12:46:27,626 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=multi, bd=bd_cliente_acme, servidor=localhost
2025-11-24 12:46:27,626 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=2, db_type=multi, bd=bd_cliente_acme, path=/api/v1/areas/
2025-11-24 12:46:27,627 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:46:27,629 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:46:27,630 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:46:27,631 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:46:27,633 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:46:27,634 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:46:27,634 - app.api.v1.endpoints.areas - INFO - Solicitud GET /areas/ recibida por usuario 1 del cliente 2 - Paginación: skip=0, limit=10, Búsqueda: 'None'
2025-11-24 12:46:27,635 - app.services.area_service - INFO - Obteniendo áreas paginadas para cliente 2: skip=0, limit=10, search='None'
2025-11-24 12:46:27,635 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:46:27,638 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:46:27,641 - app.services.area_service - INFO - Paginación completada para cliente 2: 2 áreas de 2 totales
2025-11-24 12:46:27,641 - app.api.v1.endpoints.areas - INFO - Lista paginada de áreas recuperada para cliente 2 - Total: 2, Página: 1
2025-11-24 12:46:27,642 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/areas/ 200 18.6ms
2025-11-24 12:46:27,644 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/areas/
2025-11-24 12:46:27,644 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 12:46:27,644 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': acme.app.local:5173
2025-11-24 12:46:27,645 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-11-24 12:46:27,645 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 12:46:27,645 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-11-24 12:46:27,646 - app.middleware.tenant_middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=2
2025-11-24 12:46:27,646 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=multi, bd=bd_cliente_acme, servidor=localhost
2025-11-24 12:46:27,646 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=2, db_type=multi, bd=bd_cliente_acme, path=/api/v1/areas/
2025-11-24 12:46:27,647 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:46:27,649 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:46:27,650 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:46:27,651 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:46:27,652 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:46:27,652 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:46:27,653 - app.api.v1.endpoints.areas - INFO - Solicitud GET /areas/ recibida por usuario 1 del cliente 2 - Paginación: skip=0, limit=10, Búsqueda: 'None'
2025-11-24 12:46:27,653 - app.services.area_service - INFO - Obteniendo áreas paginadas para cliente 2: skip=0, limit=10, search='None'
2025-11-24 12:46:27,653 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:46:27,655 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:46:27,656 - app.services.area_service - INFO - Paginación completada para cliente 2: 2 áreas de 2 totales
2025-11-24 12:46:27,656 - app.api.v1.endpoints.areas - INFO - Lista paginada de áreas recuperada para cliente 2 - Total: 2, Página: 1
2025-11-24 12:46:27,657 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/areas/ 200 13.1ms
2025-11-24 12:46:33,126 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/areas/list/
2025-11-24 12:46:33,127 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/areas/list/ 200 0.6ms
2025-11-24 12:46:33,128 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/areas/list/
2025-11-24 12:46:33,128 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/areas/list/ 200 0.5ms
2025-11-24 12:46:33,129 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/areas/list/
2025-11-24 12:46:33,130 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 12:46:33,130 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': acme.app.local:5173
2025-11-24 12:46:33,130 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-11-24 12:46:33,130 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 12:46:33,130 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-11-24 12:46:33,132 - app.middleware.tenant_middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=2
2025-11-24 12:46:33,132 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=multi, bd=bd_cliente_acme, servidor=localhost
2025-11-24 12:46:33,132 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=2, db_type=multi, bd=bd_cliente_acme, path=/api/v1/areas/list/
2025-11-24 12:46:33,133 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:46:33,134 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:46:33,137 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:46:33,138 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:46:33,139 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:46:33,140 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:46:33,142 - app.api.v1.endpoints.areas - INFO - Solicitud GET /areas/list/ recibida por usuario 1 del cliente 2 para lista simple
2025-11-24 12:46:33,142 - app.services.area_service - INFO - Obteniendo lista simple de áreas activas para cliente 2
2025-11-24 12:46:33,142 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:46:33,145 - app.services.area_service - INFO - Lista simple obtenida para cliente 2: 2 áreas activas
2025-11-24 12:46:33,145 - app.api.v1.endpoints.areas - INFO - Lista simple de áreas recuperada para cliente 2 - Total: 2 áreas activas
2025-11-24 12:46:33,145 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/areas/list/ 200 15.9ms
2025-11-24 12:46:33,147 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/areas/list/
2025-11-24 12:46:33,148 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 12:46:33,148 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': acme.app.local:5173
2025-11-24 12:46:33,148 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-11-24 12:46:33,148 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 12:46:33,148 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-11-24 12:46:33,150 - app.middleware.tenant_middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=2
2025-11-24 12:46:33,150 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=multi, bd=bd_cliente_acme, servidor=localhost
2025-11-24 12:46:33,150 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=2, db_type=multi, bd=bd_cliente_acme, path=/api/v1/areas/list/
2025-11-24 12:46:33,151 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:46:33,152 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:46:33,153 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:46:33,154 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:46:33,155 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:46:33,156 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:46:33,157 - app.api.v1.endpoints.areas - INFO - Solicitud GET /areas/list/ recibida por usuario 1 del cliente 2 para lista simple
2025-11-24 12:46:33,158 - app.services.area_service - INFO - Obteniendo lista simple de áreas activas para cliente 2
2025-11-24 12:46:33,158 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:46:33,159 - app.services.area_service - INFO - Lista simple obtenida para cliente 2: 2 áreas activas
2025-11-24 12:46:33,159 - app.api.v1.endpoints.areas - INFO - Lista simple de áreas recuperada para cliente 2 - Total: 2 áreas activas
2025-11-24 12:46:33,159 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/areas/list/ 200 12.3ms
2025-11-24 12:46:34,296 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/areas/
2025-11-24 12:46:34,297 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 12:46:34,297 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': acme.app.local:5173
2025-11-24 12:46:34,297 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-11-24 12:46:34,297 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 12:46:34,297 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-11-24 12:46:34,298 - app.middleware.tenant_middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=2
2025-11-24 12:46:34,298 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=multi, bd=bd_cliente_acme, servidor=localhost
2025-11-24 12:46:34,299 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=2, db_type=multi, bd=bd_cliente_acme, path=/api/v1/areas/
2025-11-24 12:46:34,299 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:46:34,300 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:46:34,302 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:46:34,303 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:46:34,305 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:46:34,306 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:46:34,307 - app.api.v1.endpoints.areas - INFO - Solicitud GET /areas/ recibida por usuario 1 del cliente 2 - Paginación: skip=0, limit=10, Búsqueda: 'None'
2025-11-24 12:46:34,307 - app.services.area_service - INFO - Obteniendo áreas paginadas para cliente 2: skip=0, limit=10, search='None'
2025-11-24 12:46:34,307 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:46:34,309 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:46:34,311 - app.services.area_service - INFO - Paginación completada para cliente 2: 2 áreas de 2 totales
2025-11-24 12:46:34,311 - app.api.v1.endpoints.areas - INFO - Lista paginada de áreas recuperada para cliente 2 - Total: 2, Página: 1
2025-11-24 12:46:34,312 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/areas/ 200 15.9ms
2025-11-24 12:46:34,314 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/areas/
2025-11-24 12:46:34,314 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 12:46:34,314 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': acme.app.local:5173
2025-11-24 12:46:34,315 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-11-24 12:46:34,315 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 12:46:34,315 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-11-24 12:46:34,316 - app.middleware.tenant_middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=2
2025-11-24 12:46:34,316 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=multi, bd=bd_cliente_acme, servidor=localhost
2025-11-24 12:46:34,316 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=2, db_type=multi, bd=bd_cliente_acme, path=/api/v1/areas/
2025-11-24 12:46:34,317 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:46:34,318 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:46:34,319 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:46:34,320 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:46:34,321 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:46:34,322 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:46:34,323 - app.api.v1.endpoints.areas - INFO - Solicitud GET /areas/ recibida por usuario 1 del cliente 2 - Paginación: skip=0, limit=10, Búsqueda: 'None'
2025-11-24 12:46:34,323 - app.services.area_service - INFO - Obteniendo áreas paginadas para cliente 2: skip=0, limit=10, search='None'
2025-11-24 12:46:34,323 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:46:34,325 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:46:34,326 - app.services.area_service - INFO - Paginación completada para cliente 2: 2 áreas de 2 totales
2025-11-24 12:46:34,326 - app.api.v1.endpoints.areas - INFO - Lista paginada de áreas recuperada para cliente 2 - Total: 2, Página: 1
2025-11-24 12:46:34,327 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/areas/ 200 13.0ms
2025-11-24 12:46:59,155 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/areas/list/
2025-11-24 12:46:59,156 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 12:46:59,156 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': acme.app.local:5173
2025-11-24 12:46:59,156 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-11-24 12:46:59,156 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 12:46:59,156 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-11-24 12:46:59,158 - app.middleware.tenant_middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=2
2025-11-24 12:46:59,158 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=multi, bd=bd_cliente_acme, servidor=localhost
2025-11-24 12:46:59,158 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=2, db_type=multi, bd=bd_cliente_acme, path=/api/v1/areas/list/
2025-11-24 12:46:59,159 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:46:59,160 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:46:59,162 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:46:59,163 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:46:59,165 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:46:59,166 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:46:59,168 - app.api.v1.endpoints.areas - INFO - Solicitud GET /areas/list/ recibida por usuario 1 del cliente 2 para lista simple
2025-11-24 12:46:59,168 - app.services.area_service - INFO - Obteniendo lista simple de áreas activas para cliente 2
2025-11-24 12:46:59,168 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:46:59,170 - app.services.area_service - INFO - Lista simple obtenida para cliente 2: 2 áreas activas
2025-11-24 12:46:59,170 - app.api.v1.endpoints.areas - INFO - Lista simple de áreas recuperada para cliente 2 - Total: 2 áreas activas
2025-11-24 12:46:59,171 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/areas/list/ 200 15.7ms
2025-11-24 12:46:59,173 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/areas/list/
2025-11-24 12:46:59,173 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 12:46:59,173 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': acme.app.local:5173
2025-11-24 12:46:59,173 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-11-24 12:46:59,174 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 12:46:59,174 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-11-24 12:46:59,175 - app.middleware.tenant_middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=2
2025-11-24 12:46:59,175 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=multi, bd=bd_cliente_acme, servidor=localhost
2025-11-24 12:46:59,175 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=2, db_type=multi, bd=bd_cliente_acme, path=/api/v1/areas/list/
2025-11-24 12:46:59,176 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:46:59,177 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:46:59,178 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:46:59,180 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:46:59,181 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:46:59,182 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:46:59,183 - app.api.v1.endpoints.areas - INFO - Solicitud GET /areas/list/ recibida por usuario 1 del cliente 2 para lista simple
2025-11-24 12:46:59,183 - app.services.area_service - INFO - Obteniendo lista simple de áreas activas para cliente 2
2025-11-24 12:46:59,183 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:46:59,184 - app.services.area_service - INFO - Lista simple obtenida para cliente 2: 2 áreas activas
2025-11-24 12:46:59,184 - app.api.v1.endpoints.areas - INFO - Lista simple de áreas recuperada para cliente 2 - Total: 2 áreas activas
2025-11-24 12:46:59,184 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/areas/list/ 200 11.5ms
2025-11-24 12:47:00,818 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/menus/area/2/tree/
2025-11-24 12:47:00,819 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/menus/area/2/tree/ 200 0.7ms
2025-11-24 12:47:00,821 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/menus/area/2/tree/
2025-11-24 12:47:00,821 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 12:47:00,822 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': acme.app.local:5173
2025-11-24 12:47:00,822 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-11-24 12:47:00,822 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 12:47:00,822 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-11-24 12:47:00,823 - app.middleware.tenant_middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=2
2025-11-24 12:47:00,823 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=multi, bd=bd_cliente_acme, servidor=localhost
2025-11-24 12:47:00,823 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=2, db_type=multi, bd=bd_cliente_acme, path=/api/v1/menus/area/2/tree/
2025-11-24 12:47:00,824 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:47:00,825 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:47:00,826 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:47:00,826 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:47:00,827 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:47:00,828 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:47:00,829 - app.api.v1.endpoints.menus - INFO - Solicitud GET /menus/area/2/tree/ recibida por usuario 1 del cliente 2.
2025-11-24 12:47:00,829 - app.services.menu_service - INFO - Obteniendo árbol de menú para cliente 2, area_id: 2
2025-11-24 12:47:00,829 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:47:00,833 - app.utils.menu_helper - ERROR - Error procesando item de menú 4: 1 validation error for MenuItem
cliente_id
  Field required [type=missing, input_value={'menu_id': 4, 'nombre': ...macén', 'children': []}, input_type=dict]
    For further information visit https://errors.pydantic.dev/2.10/v/missing
Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\utils\menu_helper.py", line 34, in build_menu_tree
    menu_item_obj = MenuItem(
        menu_id=menu_id,
    ...<10 lines>...
        children=[]
    )
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\pydantic\main.py", line 214, in __init__
    validated_self = self.__pydantic_validator__.validate_python(data, self_instance=self)
pydantic_core._pydantic_core.ValidationError: 1 validation error for MenuItem
cliente_id
  Field required [type=missing, input_value={'menu_id': 4, 'nombre': ...macén', 'children': []}, input_type=dict]
    For further information visit https://errors.pydantic.dev/2.10/v/missing
2025-11-24 12:47:00,834 - app.utils.menu_helper - ERROR - Error procesando item de menú 5: 1 validation error for MenuItem
cliente_id
  Field required [type=missing, input_value={'menu_id': 5, 'nombre': ...macén', 'children': []}, input_type=dict]
    For further information visit https://errors.pydantic.dev/2.10/v/missing
Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\utils\menu_helper.py", line 34, in build_menu_tree
    menu_item_obj = MenuItem(
        menu_id=menu_id,
    ...<10 lines>...
        children=[]
    )
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\pydantic\main.py", line 214, in __init__
    validated_self = self.__pydantic_validator__.validate_python(data, self_instance=self)
pydantic_core._pydantic_core.ValidationError: 1 validation error for MenuItem
cliente_id
  Field required [type=missing, input_value={'menu_id': 5, 'nombre': ...macén', 'children': []}, input_type=dict]
    For further information visit https://errors.pydantic.dev/2.10/v/missing
2025-11-24 12:47:00,835 - app.utils.menu_helper - INFO - Árbol de menú construido con 0 items raíz.
2025-11-24 12:47:00,835 - app.services.menu_service - INFO - Árbol de menú del cliente 2, área 2 construido con 0 items raíz.
2025-11-24 12:47:00,836 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/menus/area/2/tree/ 200 14.8ms
2025-11-24 12:47:06,838 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/menus/area/1/tree/
2025-11-24 12:47:06,838 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/menus/area/1/tree/ 200 0.6ms
2025-11-24 12:47:06,840 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/menus/area/1/tree/
2025-11-24 12:47:06,840 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 12:47:06,841 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': acme.app.local:5173
2025-11-24 12:47:06,841 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-11-24 12:47:06,841 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 12:47:06,841 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-11-24 12:47:06,844 - app.middleware.tenant_middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=2
2025-11-24 12:47:06,844 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=multi, bd=bd_cliente_acme, servidor=localhost
2025-11-24 12:47:06,844 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=2, db_type=multi, bd=bd_cliente_acme, path=/api/v1/menus/area/1/tree/
2025-11-24 12:47:06,845 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:47:06,846 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:47:06,848 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:47:06,848 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:47:06,849 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:47:06,850 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:47:06,851 - app.api.v1.endpoints.menus - INFO - Solicitud GET /menus/area/1/tree/ recibida por usuario 1 del cliente 2.
2025-11-24 12:47:06,851 - app.services.menu_service - INFO - Obteniendo árbol de menú para cliente 2, area_id: 1
2025-11-24 12:47:06,851 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:47:06,855 - app.services.menu_service - INFO - No se encontraron menús para el cliente 2, área ID: 1.
2025-11-24 12:47:06,856 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/menus/area/1/tree/ 200 15.9ms
2025-11-24 12:47:17,898 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/roles/
2025-11-24 12:47:17,898 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 12:47:17,899 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': acme.app.local:5173
2025-11-24 12:47:17,899 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-11-24 12:47:17,899 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 12:47:17,899 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-11-24 12:47:17,903 - app.middleware.tenant_middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=2
2025-11-24 12:47:17,903 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=multi, bd=bd_cliente_acme, servidor=localhost
2025-11-24 12:47:17,903 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=2, db_type=multi, bd=bd_cliente_acme, path=/api/v1/roles/
2025-11-24 12:47:17,904 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:47:17,906 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:47:17,908 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:47:17,909 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:47:17,911 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:47:17,912 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:47:17,913 - app.api.v1.endpoints.roles - INFO - Solicitud GET /roles/ recibida por usuario 1 del cliente 2 - Paginación: page=1, limit=10, Búsqueda: 'None'
2025-11-24 12:47:17,914 - app.services.rol_service - INFO - Obteniendo roles paginados para cliente 2: page=1, limit=10, search='None'
2025-11-24 12:47:17,914 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:47:17,919 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:47:17,922 - app.services.rol_service - INFO - Obtención paginada de roles para cliente 2 completada exitosamente
2025-11-24 12:47:17,923 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/roles/ N/A 25.0ms
2025-11-24 12:47:17,924 - app.core.exceptions - ERROR - Error no manejado: 3 validation errors:
  {'type': 'value_error', 'loc': ('response', 'roles', 0), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 1, 'nombre': 'Administrador', 'descripcion': 'Administrador con acceso completo', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'ADMIN'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
  {'type': 'value_error', 'loc': ('response', 'roles', 1), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 2, 'nombre': 'Supervisor', 'descripcion': 'Supervisor de departamento', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'SUPERVISOR'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
  {'type': 'value_error', 'loc': ('response', 'roles', 2), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 3, 'nombre': 'Usuario', 'descripcion': 'Usuario estándar', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'USER'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
  + Exception Group Traceback (most recent call last):
  |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 76, in collapse_excgroups
  |     yield
  |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 186, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ~~~~~~~~~~~~~~~~~~~~~~~^^
  |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\anyio\_backends\_asyncio.py", line 815, in __aexit__
  |     raise BaseExceptionGroup(
  |         "unhandled errors in a TaskGroup", self._exceptions
  |     )
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\errors.py", line 165, in __call__
    |     await self.app(scope, receive, _send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    |     with collapse_excgroups():
    |          ~~~~~~~~~~~~~~~~~~^^
    |   File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\app\main.py", line 190, in security_headers
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    |     raise app_exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    |     with collapse_excgroups():
    |          ~~~~~~~~~~~~~~~~~~^^
    |   File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\app\main.py", line 181, in log_requests
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    |     raise app_exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    |     with collapse_excgroups():
    |          ~~~~~~~~~~~~~~~~~~^^
    |   File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\app\main.py", line 158, in cors_middleware
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    |     raise app_exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    |     with collapse_excgroups():
    |          ~~~~~~~~~~~~~~~~~~^^
    |   File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\app\middleware\tenant_middleware.py", line 293, in dispatch
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    |     raise app_exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\exceptions.py", line 62, in __call__
    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 715, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 735, in app
    |     await route.handle(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 288, in handle
    |     await self.app(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 76, in app
    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 73, in app
    |     response = await f(request)
    |                ^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\fastapi\routing.py", line 327, in app
    |     content = await serialize_response(
    |               ^^^^^^^^^^^^^^^^^^^^^^^^^
    |     ...<9 lines>...
    |     )
    |     ^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\fastapi\routing.py", line 176, in serialize_response
    |     raise ResponseValidationError(
    |         errors=_normalize_errors(errors), body=response_content
    |     )
    | fastapi.exceptions.ResponseValidationError: 3 validation errors:
    |   {'type': 'value_error', 'loc': ('response', 'roles', 0), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 1, 'nombre': 'Administrador', 'descripcion': 'Administrador con acceso completo', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'ADMIN'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
    |   {'type': 'value_error', 'loc': ('response', 'roles', 1), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 2, 'nombre': 'Supervisor', 'descripcion': 'Supervisor de departamento', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'SUPERVISOR'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
    |   {'type': 'value_error', 'loc': ('response', 'roles', 2), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 3, 'nombre': 'Usuario', 'descripcion': 'Usuario estándar', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'USER'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
    | 
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\errors.py", line 165, in __call__
    await self.app(scope, receive, _send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    with collapse_excgroups():
         ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\main.py", line 190, in security_headers
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    raise app_exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    with collapse_excgroups():
         ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\main.py", line 181, in log_requests
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    raise app_exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    with collapse_excgroups():
         ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\main.py", line 158, in cors_middleware
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    raise app_exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    with collapse_excgroups():
         ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\middleware\tenant_middleware.py", line 293, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    raise app_exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 715, in __call__
    await self.middleware_stack(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 735, in app
    await route.handle(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 288, in handle
    await self.app(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 76, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 73, in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\fastapi\routing.py", line 327, in app
    content = await serialize_response(
              ^^^^^^^^^^^^^^^^^^^^^^^^^
    ...<9 lines>...
    )
    ^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\fastapi\routing.py", line 176, in serialize_response
    raise ResponseValidationError(
        errors=_normalize_errors(errors), body=response_content
    )
fastapi.exceptions.ResponseValidationError: 3 validation errors:
  {'type': 'value_error', 'loc': ('response', 'roles', 0), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 1, 'nombre': 'Administrador', 'descripcion': 'Administrador con acceso completo', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'ADMIN'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
  {'type': 'value_error', 'loc': ('response', 'roles', 1), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 2, 'nombre': 'Supervisor', 'descripcion': 'Supervisor de departamento', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'SUPERVISOR'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
  {'type': 'value_error', 'loc': ('response', 'roles', 2), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 3, 'nombre': 'Usuario', 'descripcion': 'Usuario estándar', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'USER'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}

2025-11-24 12:47:17,945 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/roles/
2025-11-24 12:47:17,945 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 12:47:17,946 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': acme.app.local:5173
2025-11-24 12:47:17,949 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-11-24 12:47:17,950 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 12:47:17,950 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-11-24 12:47:17,952 - app.middleware.tenant_middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=2
2025-11-24 12:47:17,952 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=multi, bd=bd_cliente_acme, servidor=localhost
2025-11-24 12:47:17,953 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=2, db_type=multi, bd=bd_cliente_acme, path=/api/v1/roles/
2025-11-24 12:47:17,954 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:47:17,955 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:47:17,956 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:47:17,957 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:47:17,958 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:47:17,958 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:47:17,959 - app.api.v1.endpoints.roles - INFO - Solicitud GET /roles/ recibida por usuario 1 del cliente 2 - Paginación: page=1, limit=10, Búsqueda: 'None'
2025-11-24 12:47:17,959 - app.services.rol_service - INFO - Obteniendo roles paginados para cliente 2: page=1, limit=10, search='None'
2025-11-24 12:47:17,960 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:47:17,962 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 12:47:17,965 - app.services.rol_service - INFO - Obtención paginada de roles para cliente 2 completada exitosamente
2025-11-24 12:47:17,966 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/roles/ N/A 21.3ms
2025-11-24 12:47:17,967 - app.core.exceptions - ERROR - Error no manejado: 3 validation errors:
  {'type': 'value_error', 'loc': ('response', 'roles', 0), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 1, 'nombre': 'Administrador', 'descripcion': 'Administrador con acceso completo', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'ADMIN'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
  {'type': 'value_error', 'loc': ('response', 'roles', 1), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 2, 'nombre': 'Supervisor', 'descripcion': 'Supervisor de departamento', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'SUPERVISOR'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
  {'type': 'value_error', 'loc': ('response', 'roles', 2), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 3, 'nombre': 'Usuario', 'descripcion': 'Usuario estándar', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'USER'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
  + Exception Group Traceback (most recent call last):
  |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 76, in collapse_excgroups
  |     yield
  |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 186, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ~~~~~~~~~~~~~~~~~~~~~~~^^
  |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\anyio\_backends\_asyncio.py", line 815, in __aexit__
  |     raise BaseExceptionGroup(
  |         "unhandled errors in a TaskGroup", self._exceptions
  |     )
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\errors.py", line 165, in __call__
    |     await self.app(scope, receive, _send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    |     with collapse_excgroups():
    |          ~~~~~~~~~~~~~~~~~~^^
    |   File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\app\main.py", line 190, in security_headers
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    |     raise app_exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    |     with collapse_excgroups():
    |          ~~~~~~~~~~~~~~~~~~^^
    |   File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\app\main.py", line 181, in log_requests
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    |     raise app_exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    |     with collapse_excgroups():
    |          ~~~~~~~~~~~~~~~~~~^^
    |   File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\app\main.py", line 158, in cors_middleware
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    |     raise app_exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    |     with collapse_excgroups():
    |          ~~~~~~~~~~~~~~~~~~^^
    |   File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\app\middleware\tenant_middleware.py", line 293, in dispatch
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    |     raise app_exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\exceptions.py", line 62, in __call__
    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 715, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 735, in app
    |     await route.handle(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 288, in handle
    |     await self.app(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 76, in app
    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 73, in app
    |     response = await f(request)
    |                ^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\fastapi\routing.py", line 327, in app
    |     content = await serialize_response(
    |               ^^^^^^^^^^^^^^^^^^^^^^^^^
    |     ...<9 lines>...
    |     )
    |     ^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\fastapi\routing.py", line 176, in serialize_response
    |     raise ResponseValidationError(
    |         errors=_normalize_errors(errors), body=response_content
    |     )
    | fastapi.exceptions.ResponseValidationError: 3 validation errors:
    |   {'type': 'value_error', 'loc': ('response', 'roles', 0), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 1, 'nombre': 'Administrador', 'descripcion': 'Administrador con acceso completo', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'ADMIN'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
    |   {'type': 'value_error', 'loc': ('response', 'roles', 1), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 2, 'nombre': 'Supervisor', 'descripcion': 'Supervisor de departamento', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'SUPERVISOR'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
    |   {'type': 'value_error', 'loc': ('response', 'roles', 2), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 3, 'nombre': 'Usuario', 'descripcion': 'Usuario estándar', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'USER'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
    | 
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\errors.py", line 165, in __call__
    await self.app(scope, receive, _send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    with collapse_excgroups():
         ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\main.py", line 190, in security_headers
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    raise app_exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    with collapse_excgroups():
         ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\main.py", line 181, in log_requests
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    raise app_exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    with collapse_excgroups():
         ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\main.py", line 158, in cors_middleware
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    raise app_exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    with collapse_excgroups():
         ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\middleware\tenant_middleware.py", line 293, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    raise app_exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 715, in __call__
    await self.middleware_stack(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 735, in app
    await route.handle(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 288, in handle
    await self.app(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 76, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 73, in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\fastapi\routing.py", line 327, in app
    content = await serialize_response(
              ^^^^^^^^^^^^^^^^^^^^^^^^^
    ...<9 lines>...
    )
    ^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\fastapi\routing.py", line 176, in serialize_response
    raise ResponseValidationError(
        errors=_normalize_errors(errors), body=response_content
    )
fastapi.exceptions.ResponseValidationError: 3 validation errors:
  {'type': 'value_error', 'loc': ('response', 'roles', 0), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 1, 'nombre': 'Administrador', 'descripcion': 'Administrador con acceso completo', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'ADMIN'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
  {'type': 'value_error', 'loc': ('response', 'roles', 1), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 2, 'nombre': 'Supervisor', 'descripcion': 'Supervisor de departamento', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'SUPERVISOR'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
  {'type': 'value_error', 'loc': ('response', 'roles', 2), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 3, 'nombre': 'Usuario', 'descripcion': 'Usuario estándar', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'USER'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}

2025-11-24 13:26:50,474 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/areas/
2025-11-24 13:26:50,474 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/areas/
2025-11-24 13:26:50,475 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/areas/ 200 1.0ms
2025-11-24 13:26:50,475 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/areas/ 200 0.6ms
2025-11-24 13:26:50,478 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/areas/
2025-11-24 13:26:50,479 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 13:26:50,479 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': acme.app.local:5173
2025-11-24 13:26:50,479 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-11-24 13:26:50,480 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 13:26:50,480 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-11-24 13:26:50,493 - app.middleware.tenant_middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=2
2025-11-24 13:26:50,495 - app.core.multi_db - INFO - [METADATA] Metadata cargada para cliente 2: multi - bd_cliente_acme
2025-11-24 13:26:50,495 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=multi, bd=bd_cliente_acme, servidor=localhost
2025-11-24 13:26:50,495 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=2, db_type=multi, bd=bd_cliente_acme, path=/api/v1/areas/
2025-11-24 13:26:50,496 - app.api.deps - WARNING - Error de validación JWT: Signature has expired.
2025-11-24 13:26:50,497 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/areas/ 401 18.4ms
2025-11-24 13:26:50,498 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/areas/
2025-11-24 13:26:50,498 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 13:26:50,499 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': acme.app.local:5173
2025-11-24 13:26:50,499 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-11-24 13:26:50,499 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 13:26:50,499 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-11-24 13:26:50,500 - app.middleware.tenant_middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=2
2025-11-24 13:26:50,500 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=multi, bd=bd_cliente_acme, servidor=localhost
2025-11-24 13:26:50,501 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=2, db_type=multi, bd=bd_cliente_acme, path=/api/v1/areas/
2025-11-24 13:26:50,501 - app.api.deps - WARNING - Error de validación JWT: Signature has expired.
2025-11-24 13:26:50,502 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/auth/refresh/
2025-11-24 13:26:50,502 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/auth/refresh/ 200 0.4ms
2025-11-24 13:26:50,502 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/areas/ 401 4.2ms
2025-11-24 13:26:50,504 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/refresh/
2025-11-24 13:26:50,505 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 13:26:50,505 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': acme.app.local:5173
2025-11-24 13:26:50,505 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-11-24 13:26:50,505 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 13:26:50,505 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-11-24 13:26:50,506 - app.middleware.tenant_middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=2
2025-11-24 13:26:50,506 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=multi, bd=bd_cliente_acme, servidor=localhost
2025-11-24 13:26:50,507 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=2, db_type=multi, bd=bd_cliente_acme, path=/api/v1/auth/refresh/
2025-11-24 13:26:50,508 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 13:26:50,518 - app.services.refresh_token_service - INFO - [VALIDATE-TOKEN] Token válido - Cliente 2, Usuario 1, Tipo: web
2025-11-24 13:26:50,518 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 13:26:50,520 - app.core.auth - INFO - [REFRESH] Token validado exitosamente (BD OK) para usuario: admin_acme (Cliente: 2, Level: 4, Type: tenant_admin)
2025-11-24 13:26:50,521 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 13:26:50,526 - app.core.auth - INFO - Niveles calculados - Usuario 1: level=4, super_admin=False, type=tenant_admin
2025-11-24 13:26:50,526 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 13:26:50,527 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 13:26:50,530 - app.db.queries - INFO - Inserción exitosa, filas afectadas: -1
2025-11-24 13:26:50,531 - app.services.refresh_token_service - INFO - [STORE-TOKEN] Token insertado exitosamente - Cliente 2, Usuario 1, Tipo: web, Token ID: 3, Rotación: True
2025-11-24 13:26:50,531 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 13:26:50,535 - app.db.queries - INFO - Actualización exitosa, filas afectadas: -1
2025-11-24 13:26:50,535 - app.services.refresh_token_service - WARNING - [REVOKE-TOKEN] Token no encontrado o ya revocado - Cliente 2, Usuario 1
2025-11-24 13:26:50,535 - app.api.v1.endpoints.auth - WARNING - [REFRESH] Token antiguo no encontrado para revocar (no crítico)
2025-11-24 13:26:50,535 - app.api.v1.endpoints.auth - INFO - [REFRESH-WEB] Token rotado exitosamente - ID: 3
2025-11-24 13:26:50,536 - app.api.v1.endpoints.auth - INFO - [REFRESH-WEB] Token refrescado exitosamente - Usuario: admin_acme
2025-11-24 13:26:50,536 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/refresh/ 200 31.8ms
2025-11-24 13:26:50,540 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/areas/
2025-11-24 13:26:50,540 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 13:26:50,540 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': acme.app.local:5173
2025-11-24 13:26:50,540 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-11-24 13:26:50,540 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 13:26:50,541 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-11-24 13:26:50,541 - app.middleware.tenant_middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=2
2025-11-24 13:26:50,542 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=multi, bd=bd_cliente_acme, servidor=localhost
2025-11-24 13:26:50,542 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=2, db_type=multi, bd=bd_cliente_acme, path=/api/v1/areas/
2025-11-24 13:26:50,543 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 13:26:50,544 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 13:26:50,545 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 13:26:50,546 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 13:26:50,547 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 13:26:50,548 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 13:26:50,548 - app.api.v1.endpoints.areas - INFO - Solicitud GET /areas/ recibida por usuario 1 del cliente 2 - Paginación: skip=0, limit=10, Búsqueda: 'None'
2025-11-24 13:26:50,549 - app.services.area_service - INFO - Obteniendo áreas paginadas para cliente 2: skip=0, limit=10, search='None'
2025-11-24 13:26:50,549 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 13:26:50,552 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 13:26:50,556 - app.services.area_service - INFO - Paginación completada para cliente 2: 2 áreas de 2 totales
2025-11-24 13:26:50,556 - app.api.v1.endpoints.areas - INFO - Lista paginada de áreas recuperada para cliente 2 - Total: 2, Página: 1
2025-11-24 13:26:50,556 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/areas/ 200 16.6ms
2025-11-24 13:26:50,558 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/areas/
2025-11-24 13:26:50,558 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 13:26:50,558 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': acme.app.local:5173
2025-11-24 13:26:50,558 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-11-24 13:26:50,559 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 13:26:50,559 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-11-24 13:26:50,560 - app.middleware.tenant_middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=2
2025-11-24 13:26:50,560 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=multi, bd=bd_cliente_acme, servidor=localhost
2025-11-24 13:26:50,560 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=2, db_type=multi, bd=bd_cliente_acme, path=/api/v1/areas/
2025-11-24 13:26:50,561 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 13:26:50,562 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 13:26:50,563 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 13:26:50,563 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 13:26:50,564 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 13:26:50,565 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 13:26:50,566 - app.api.v1.endpoints.areas - INFO - Solicitud GET /areas/ recibida por usuario 1 del cliente 2 - Paginación: skip=0, limit=10, Búsqueda: 'None'
2025-11-24 13:26:50,566 - app.services.area_service - INFO - Obteniendo áreas paginadas para cliente 2: skip=0, limit=10, search='None'
2025-11-24 13:26:50,566 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 13:26:50,568 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 13:26:50,570 - app.services.area_service - INFO - Paginación completada para cliente 2: 2 áreas de 2 totales
2025-11-24 13:26:50,570 - app.api.v1.endpoints.areas - INFO - Lista paginada de áreas recuperada para cliente 2 - Total: 2, Página: 1
2025-11-24 13:26:50,571 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/areas/ 200 12.8ms
2025-11-24 13:26:52,226 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/areas/list/
2025-11-24 13:26:52,226 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/areas/list/ 200 0.7ms
2025-11-24 13:26:52,227 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/areas/list/
2025-11-24 13:26:52,227 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/areas/list/ 200 0.8ms
2025-11-24 13:26:52,228 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/areas/list/
2025-11-24 13:26:52,229 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 13:26:52,229 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': acme.app.local:5173
2025-11-24 13:26:52,229 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-11-24 13:26:52,229 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 13:26:52,230 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-11-24 13:26:52,231 - app.middleware.tenant_middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=2
2025-11-24 13:26:52,232 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=multi, bd=bd_cliente_acme, servidor=localhost
2025-11-24 13:26:52,232 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=2, db_type=multi, bd=bd_cliente_acme, path=/api/v1/areas/list/
2025-11-24 13:26:52,233 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 13:26:52,235 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 13:26:52,236 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 13:26:52,237 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 13:26:52,238 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 13:26:52,239 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 13:26:52,240 - app.api.v1.endpoints.areas - INFO - Solicitud GET /areas/list/ recibida por usuario 1 del cliente 2 para lista simple
2025-11-24 13:26:52,240 - app.services.area_service - INFO - Obteniendo lista simple de áreas activas para cliente 2
2025-11-24 13:26:52,241 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 13:26:52,243 - app.services.area_service - INFO - Lista simple obtenida para cliente 2: 2 áreas activas
2025-11-24 13:26:52,243 - app.api.v1.endpoints.areas - INFO - Lista simple de áreas recuperada para cliente 2 - Total: 2 áreas activas
2025-11-24 13:26:52,243 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/areas/list/ 200 14.9ms
2025-11-24 13:26:52,245 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/areas/list/
2025-11-24 13:26:52,246 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 13:26:52,246 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': acme.app.local:5173
2025-11-24 13:26:52,246 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-11-24 13:26:52,247 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 13:26:52,247 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-11-24 13:26:52,248 - app.middleware.tenant_middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=2
2025-11-24 13:26:52,248 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=multi, bd=bd_cliente_acme, servidor=localhost
2025-11-24 13:26:52,249 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=2, db_type=multi, bd=bd_cliente_acme, path=/api/v1/areas/list/
2025-11-24 13:26:52,250 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 13:26:52,251 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 13:26:52,252 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 13:26:52,252 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 13:26:52,253 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 13:26:52,254 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 13:26:52,255 - app.api.v1.endpoints.areas - INFO - Solicitud GET /areas/list/ recibida por usuario 1 del cliente 2 para lista simple
2025-11-24 13:26:52,255 - app.services.area_service - INFO - Obteniendo lista simple de áreas activas para cliente 2
2025-11-24 13:26:52,255 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 13:26:52,256 - app.services.area_service - INFO - Lista simple obtenida para cliente 2: 2 áreas activas
2025-11-24 13:26:52,256 - app.api.v1.endpoints.areas - INFO - Lista simple de áreas recuperada para cliente 2 - Total: 2 áreas activas
2025-11-24 13:26:52,257 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/areas/list/ 200 11.6ms
2025-11-24 13:26:53,250 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/roles/
2025-11-24 13:26:53,250 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/roles/ 200 0.5ms
2025-11-24 13:26:53,252 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/roles/
2025-11-24 13:26:53,253 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 13:26:53,253 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': acme.app.local:5173
2025-11-24 13:26:53,253 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-11-24 13:26:53,253 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 13:26:53,253 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-11-24 13:26:53,254 - app.middleware.tenant_middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=2
2025-11-24 13:26:53,255 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=multi, bd=bd_cliente_acme, servidor=localhost
2025-11-24 13:26:53,255 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=2, db_type=multi, bd=bd_cliente_acme, path=/api/v1/roles/
2025-11-24 13:26:53,256 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 13:26:53,257 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 13:26:53,259 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 13:26:53,260 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 13:26:53,261 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 13:26:53,262 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 13:26:53,264 - app.api.v1.endpoints.roles - INFO - Solicitud GET /roles/ recibida por usuario 1 del cliente 2 - Paginación: page=1, limit=10, Búsqueda: 'None'
2025-11-24 13:26:53,264 - app.services.rol_service - INFO - Obteniendo roles paginados para cliente 2: page=1, limit=10, search='None'
2025-11-24 13:26:53,265 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 13:26:53,269 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 13:26:53,273 - app.services.rol_service - INFO - Obtención paginada de roles para cliente 2 completada exitosamente
2025-11-24 13:26:53,273 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/roles/ N/A 21.2ms
2025-11-24 13:26:53,274 - app.core.exceptions - ERROR - Error no manejado: 3 validation errors:
  {'type': 'value_error', 'loc': ('response', 'roles', 0), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 1, 'nombre': 'Administrador', 'descripcion': 'Administrador con acceso completo', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'ADMIN'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
  {'type': 'value_error', 'loc': ('response', 'roles', 1), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 2, 'nombre': 'Supervisor', 'descripcion': 'Supervisor de departamento', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'SUPERVISOR'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
  {'type': 'value_error', 'loc': ('response', 'roles', 2), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 3, 'nombre': 'Usuario', 'descripcion': 'Usuario estándar', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'USER'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
  + Exception Group Traceback (most recent call last):
  |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 76, in collapse_excgroups
  |     yield
  |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 186, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ~~~~~~~~~~~~~~~~~~~~~~~^^
  |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\anyio\_backends\_asyncio.py", line 815, in __aexit__
  |     raise BaseExceptionGroup(
  |         "unhandled errors in a TaskGroup", self._exceptions
  |     )
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\errors.py", line 165, in __call__
    |     await self.app(scope, receive, _send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    |     with collapse_excgroups():
    |          ~~~~~~~~~~~~~~~~~~^^
    |   File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\app\main.py", line 190, in security_headers
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    |     raise app_exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    |     with collapse_excgroups():
    |          ~~~~~~~~~~~~~~~~~~^^
    |   File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\app\main.py", line 181, in log_requests
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    |     raise app_exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    |     with collapse_excgroups():
    |          ~~~~~~~~~~~~~~~~~~^^
    |   File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\app\main.py", line 158, in cors_middleware
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    |     raise app_exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    |     with collapse_excgroups():
    |          ~~~~~~~~~~~~~~~~~~^^
    |   File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\app\middleware\tenant_middleware.py", line 293, in dispatch
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    |     raise app_exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\exceptions.py", line 62, in __call__
    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 715, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 735, in app
    |     await route.handle(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 288, in handle
    |     await self.app(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 76, in app
    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 73, in app
    |     response = await f(request)
    |                ^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\fastapi\routing.py", line 327, in app
    |     content = await serialize_response(
    |               ^^^^^^^^^^^^^^^^^^^^^^^^^
    |     ...<9 lines>...
    |     )
    |     ^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\fastapi\routing.py", line 176, in serialize_response
    |     raise ResponseValidationError(
    |         errors=_normalize_errors(errors), body=response_content
    |     )
    | fastapi.exceptions.ResponseValidationError: 3 validation errors:
    |   {'type': 'value_error', 'loc': ('response', 'roles', 0), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 1, 'nombre': 'Administrador', 'descripcion': 'Administrador con acceso completo', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'ADMIN'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
    |   {'type': 'value_error', 'loc': ('response', 'roles', 1), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 2, 'nombre': 'Supervisor', 'descripcion': 'Supervisor de departamento', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'SUPERVISOR'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
    |   {'type': 'value_error', 'loc': ('response', 'roles', 2), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 3, 'nombre': 'Usuario', 'descripcion': 'Usuario estándar', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'USER'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
    | 
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\errors.py", line 165, in __call__
    await self.app(scope, receive, _send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    with collapse_excgroups():
         ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\main.py", line 190, in security_headers
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    raise app_exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    with collapse_excgroups():
         ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\main.py", line 181, in log_requests
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    raise app_exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    with collapse_excgroups():
         ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\main.py", line 158, in cors_middleware
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    raise app_exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    with collapse_excgroups():
         ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\middleware\tenant_middleware.py", line 293, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    raise app_exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 715, in __call__
    await self.middleware_stack(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 735, in app
    await route.handle(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 288, in handle
    await self.app(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 76, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 73, in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\fastapi\routing.py", line 327, in app
    content = await serialize_response(
              ^^^^^^^^^^^^^^^^^^^^^^^^^
    ...<9 lines>...
    )
    ^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\fastapi\routing.py", line 176, in serialize_response
    raise ResponseValidationError(
        errors=_normalize_errors(errors), body=response_content
    )
fastapi.exceptions.ResponseValidationError: 3 validation errors:
  {'type': 'value_error', 'loc': ('response', 'roles', 0), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 1, 'nombre': 'Administrador', 'descripcion': 'Administrador con acceso completo', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'ADMIN'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
  {'type': 'value_error', 'loc': ('response', 'roles', 1), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 2, 'nombre': 'Supervisor', 'descripcion': 'Supervisor de departamento', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'SUPERVISOR'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
  {'type': 'value_error', 'loc': ('response', 'roles', 2), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 3, 'nombre': 'Usuario', 'descripcion': 'Usuario estándar', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'USER'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}

2025-11-24 13:26:53,294 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/roles/
2025-11-24 13:26:53,295 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 13:26:53,295 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': acme.app.local:5173
2025-11-24 13:26:53,295 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-11-24 13:26:53,295 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 13:26:53,295 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-11-24 13:26:53,297 - app.middleware.tenant_middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=2
2025-11-24 13:26:53,297 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=multi, bd=bd_cliente_acme, servidor=localhost
2025-11-24 13:26:53,297 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=2, db_type=multi, bd=bd_cliente_acme, path=/api/v1/roles/
2025-11-24 13:26:53,298 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 13:26:53,299 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 13:26:53,300 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 13:26:53,301 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 13:26:53,302 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 13:26:53,303 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 13:26:53,303 - app.api.v1.endpoints.roles - INFO - Solicitud GET /roles/ recibida por usuario 1 del cliente 2 - Paginación: page=1, limit=10, Búsqueda: 'None'
2025-11-24 13:26:53,304 - app.services.rol_service - INFO - Obteniendo roles paginados para cliente 2: page=1, limit=10, search='None'
2025-11-24 13:26:53,304 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 13:26:53,305 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 13:26:53,307 - app.services.rol_service - INFO - Obtención paginada de roles para cliente 2 completada exitosamente
2025-11-24 13:26:53,307 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/roles/ N/A 13.0ms
2025-11-24 13:26:53,308 - app.core.exceptions - ERROR - Error no manejado: 3 validation errors:
  {'type': 'value_error', 'loc': ('response', 'roles', 0), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 1, 'nombre': 'Administrador', 'descripcion': 'Administrador con acceso completo', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'ADMIN'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
  {'type': 'value_error', 'loc': ('response', 'roles', 1), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 2, 'nombre': 'Supervisor', 'descripcion': 'Supervisor de departamento', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'SUPERVISOR'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
  {'type': 'value_error', 'loc': ('response', 'roles', 2), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 3, 'nombre': 'Usuario', 'descripcion': 'Usuario estándar', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'USER'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
  + Exception Group Traceback (most recent call last):
  |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 76, in collapse_excgroups
  |     yield
  |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 186, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ~~~~~~~~~~~~~~~~~~~~~~~^^
  |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\anyio\_backends\_asyncio.py", line 815, in __aexit__
  |     raise BaseExceptionGroup(
  |         "unhandled errors in a TaskGroup", self._exceptions
  |     )
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\errors.py", line 165, in __call__
    |     await self.app(scope, receive, _send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    |     with collapse_excgroups():
    |          ~~~~~~~~~~~~~~~~~~^^
    |   File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\app\main.py", line 190, in security_headers
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    |     raise app_exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    |     with collapse_excgroups():
    |          ~~~~~~~~~~~~~~~~~~^^
    |   File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\app\main.py", line 181, in log_requests
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    |     raise app_exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    |     with collapse_excgroups():
    |          ~~~~~~~~~~~~~~~~~~^^
    |   File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\app\main.py", line 158, in cors_middleware
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    |     raise app_exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    |     with collapse_excgroups():
    |          ~~~~~~~~~~~~~~~~~~^^
    |   File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\app\middleware\tenant_middleware.py", line 293, in dispatch
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    |     raise app_exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\exceptions.py", line 62, in __call__
    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 715, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 735, in app
    |     await route.handle(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 288, in handle
    |     await self.app(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 76, in app
    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 73, in app
    |     response = await f(request)
    |                ^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\fastapi\routing.py", line 327, in app
    |     content = await serialize_response(
    |               ^^^^^^^^^^^^^^^^^^^^^^^^^
    |     ...<9 lines>...
    |     )
    |     ^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\fastapi\routing.py", line 176, in serialize_response
    |     raise ResponseValidationError(
    |         errors=_normalize_errors(errors), body=response_content
    |     )
    | fastapi.exceptions.ResponseValidationError: 3 validation errors:
    |   {'type': 'value_error', 'loc': ('response', 'roles', 0), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 1, 'nombre': 'Administrador', 'descripcion': 'Administrador con acceso completo', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'ADMIN'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
    |   {'type': 'value_error', 'loc': ('response', 'roles', 1), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 2, 'nombre': 'Supervisor', 'descripcion': 'Supervisor de departamento', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'SUPERVISOR'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
    |   {'type': 'value_error', 'loc': ('response', 'roles', 2), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 3, 'nombre': 'Usuario', 'descripcion': 'Usuario estándar', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'USER'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
    | 
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\errors.py", line 165, in __call__
    await self.app(scope, receive, _send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    with collapse_excgroups():
         ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\main.py", line 190, in security_headers
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    raise app_exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    with collapse_excgroups():
         ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\main.py", line 181, in log_requests
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    raise app_exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    with collapse_excgroups():
         ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\main.py", line 158, in cors_middleware
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    raise app_exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    with collapse_excgroups():
         ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\middleware\tenant_middleware.py", line 293, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    raise app_exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 715, in __call__
    await self.middleware_stack(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 735, in app
    await route.handle(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 288, in handle
    await self.app(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 76, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 73, in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\fastapi\routing.py", line 327, in app
    content = await serialize_response(
              ^^^^^^^^^^^^^^^^^^^^^^^^^
    ...<9 lines>...
    )
    ^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\fastapi\routing.py", line 176, in serialize_response
    raise ResponseValidationError(
        errors=_normalize_errors(errors), body=response_content
    )
fastapi.exceptions.ResponseValidationError: 3 validation errors:
  {'type': 'value_error', 'loc': ('response', 'roles', 0), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 1, 'nombre': 'Administrador', 'descripcion': 'Administrador con acceso completo', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'ADMIN'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
  {'type': 'value_error', 'loc': ('response', 'roles', 1), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 2, 'nombre': 'Supervisor', 'descripcion': 'Supervisor de departamento', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'SUPERVISOR'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
  {'type': 'value_error', 'loc': ('response', 'roles', 2), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 3, 'nombre': 'Usuario', 'descripcion': 'Usuario estándar', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'USER'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}

2025-11-24 13:32:12,770 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/areas/
2025-11-24 13:32:12,772 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 13:32:12,772 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': acme.app.local:5173
2025-11-24 13:32:12,772 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-11-24 13:32:12,773 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 13:32:12,773 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-11-24 13:32:12,788 - app.middleware.tenant_middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=2
2025-11-24 13:32:12,790 - app.core.multi_db - INFO - [METADATA] Metadata cargada para cliente 2: multi - bd_cliente_acme
2025-11-24 13:32:12,790 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=multi, bd=bd_cliente_acme, servidor=localhost
2025-11-24 13:32:12,791 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=2, db_type=multi, bd=bd_cliente_acme, path=/api/v1/areas/
2025-11-24 13:32:12,791 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 13:32:12,800 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 13:32:12,802 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 13:32:12,803 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 13:32:12,804 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 13:32:12,805 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 13:32:12,806 - app.api.v1.endpoints.areas - INFO - Solicitud GET /areas/ recibida por usuario 1 del cliente 2 - Paginación: skip=0, limit=10, Búsqueda: 'None'
2025-11-24 13:32:12,807 - app.services.area_service - INFO - Obteniendo áreas paginadas para cliente 2: skip=0, limit=10, search='None'
2025-11-24 13:32:12,807 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 13:32:12,811 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 13:32:12,815 - app.services.area_service - INFO - Paginación completada para cliente 2: 2 áreas de 2 totales
2025-11-24 13:32:12,815 - app.api.v1.endpoints.areas - INFO - Lista paginada de áreas recuperada para cliente 2 - Total: 2, Página: 1
2025-11-24 13:32:12,816 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/areas/ 200 45.9ms
2025-11-24 13:32:14,207 - app.middleware.tenant_middleware - INFO - [TENANT_MW] Inicializado - BASE_DOMAIN=app.local, SYSTEM_ID=1, EXCLUDED_SUBDOMAINS={'assets', 'api', 'backend', 'static', 'cdn', 'www', 'admin'}
2025-11-24 13:32:14,250 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/roles/
2025-11-24 13:32:14,250 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/areas/
2025-11-24 13:32:14,252 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 13:32:14,253 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': acme.app.local:5173
2025-11-24 13:32:14,253 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-11-24 13:32:14,253 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 13:32:14,253 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-11-24 13:32:14,287 - app.middleware.tenant_middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=2
2025-11-24 13:32:14,290 - app.core.multi_db - INFO - [METADATA] Metadata cargada para cliente 2: multi - bd_cliente_acme
2025-11-24 13:32:14,290 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=multi, bd=bd_cliente_acme, servidor=localhost
2025-11-24 13:32:14,290 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=2, db_type=multi, bd=bd_cliente_acme, path=/api/v1/roles/
2025-11-24 13:32:14,290 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 13:32:14,290 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': acme.app.local:5173
2025-11-24 13:32:14,291 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-11-24 13:32:14,291 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 13:32:14,291 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-11-24 13:32:14,292 - app.middleware.tenant_middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=2
2025-11-24 13:32:14,292 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=multi, bd=bd_cliente_acme, servidor=localhost
2025-11-24 13:32:14,292 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=2, db_type=multi, bd=bd_cliente_acme, path=/api/v1/areas/
2025-11-24 13:32:14,295 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 13:32:14,313 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 13:32:14,314 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 13:32:14,315 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 13:32:14,316 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 13:32:14,317 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 13:32:14,318 - app.api.v1.endpoints.roles - INFO - Solicitud GET /roles/ recibida por usuario 1 del cliente 2 - Paginación: page=1, limit=10, Búsqueda: 'None'
2025-11-24 13:32:14,318 - app.services.rol_service - INFO - Obteniendo roles paginados para cliente 2: page=1, limit=10, search='None'
2025-11-24 13:32:14,318 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 13:32:14,322 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 13:32:14,325 - app.services.rol_service - INFO - Obtención paginada de roles para cliente 2 completada exitosamente
2025-11-24 13:32:14,326 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 13:32:14,327 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 13:32:14,327 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 13:32:14,328 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 13:32:14,329 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 13:32:14,330 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 13:32:14,330 - app.api.v1.endpoints.areas - INFO - Solicitud GET /areas/ recibida por usuario 1 del cliente 2 - Paginación: skip=0, limit=10, Búsqueda: 'None'
2025-11-24 13:32:14,331 - app.services.area_service - INFO - Obteniendo áreas paginadas para cliente 2: skip=0, limit=10, search='None'
2025-11-24 13:32:14,331 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 13:32:14,332 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 13:32:14,333 - app.services.area_service - INFO - Paginación completada para cliente 2: 2 áreas de 2 totales
2025-11-24 13:32:14,334 - app.api.v1.endpoints.areas - INFO - Lista paginada de áreas recuperada para cliente 2 - Total: 2, Página: 1
2025-11-24 13:32:14,335 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/roles/ N/A 85.0ms
2025-11-24 13:32:14,335 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/areas/ 200 84.9ms
2025-11-24 13:32:14,336 - app.core.exceptions - ERROR - Error no manejado: 3 validation errors:
  {'type': 'value_error', 'loc': ('response', 'roles', 0), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 1, 'nombre': 'Administrador', 'descripcion': 'Administrador con acceso completo', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'ADMIN'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
  {'type': 'value_error', 'loc': ('response', 'roles', 1), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 2, 'nombre': 'Supervisor', 'descripcion': 'Supervisor de departamento', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'SUPERVISOR'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
  {'type': 'value_error', 'loc': ('response', 'roles', 2), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 3, 'nombre': 'Usuario', 'descripcion': 'Usuario estándar', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'USER'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
  + Exception Group Traceback (most recent call last):
  |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 76, in collapse_excgroups
  |     yield
  |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 186, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ~~~~~~~~~~~~~~~~~~~~~~~^^
  |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\anyio\_backends\_asyncio.py", line 815, in __aexit__
  |     raise BaseExceptionGroup(
  |         "unhandled errors in a TaskGroup", self._exceptions
  |     )
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\errors.py", line 165, in __call__
    |     await self.app(scope, receive, _send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    |     with collapse_excgroups():
    |          ~~~~~~~~~~~~~~~~~~^^
    |   File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\app\main.py", line 190, in security_headers
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    |     raise app_exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    |     with collapse_excgroups():
    |          ~~~~~~~~~~~~~~~~~~^^
    |   File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\app\main.py", line 181, in log_requests
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    |     raise app_exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    |     with collapse_excgroups():
    |          ~~~~~~~~~~~~~~~~~~^^
    |   File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\app\main.py", line 158, in cors_middleware
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    |     raise app_exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    |     with collapse_excgroups():
    |          ~~~~~~~~~~~~~~~~~~^^
    |   File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\app\middleware\tenant_middleware.py", line 293, in dispatch
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    |     raise app_exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\exceptions.py", line 62, in __call__
    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 715, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 735, in app
    |     await route.handle(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 288, in handle
    |     await self.app(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 76, in app
    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 73, in app
    |     response = await f(request)
    |                ^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\fastapi\routing.py", line 327, in app
    |     content = await serialize_response(
    |               ^^^^^^^^^^^^^^^^^^^^^^^^^
    |     ...<9 lines>...
    |     )
    |     ^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\fastapi\routing.py", line 176, in serialize_response
    |     raise ResponseValidationError(
    |         errors=_normalize_errors(errors), body=response_content
    |     )
    | fastapi.exceptions.ResponseValidationError: 3 validation errors:
    |   {'type': 'value_error', 'loc': ('response', 'roles', 0), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 1, 'nombre': 'Administrador', 'descripcion': 'Administrador con acceso completo', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'ADMIN'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
    |   {'type': 'value_error', 'loc': ('response', 'roles', 1), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 2, 'nombre': 'Supervisor', 'descripcion': 'Supervisor de departamento', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'SUPERVISOR'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
    |   {'type': 'value_error', 'loc': ('response', 'roles', 2), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 3, 'nombre': 'Usuario', 'descripcion': 'Usuario estándar', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'USER'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
    | 
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\errors.py", line 165, in __call__
    await self.app(scope, receive, _send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    with collapse_excgroups():
         ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\main.py", line 190, in security_headers
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    raise app_exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    with collapse_excgroups():
         ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\main.py", line 181, in log_requests
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    raise app_exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    with collapse_excgroups():
         ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\main.py", line 158, in cors_middleware
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    raise app_exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    with collapse_excgroups():
         ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\middleware\tenant_middleware.py", line 293, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    raise app_exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 715, in __call__
    await self.middleware_stack(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 735, in app
    await route.handle(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 288, in handle
    await self.app(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 76, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 73, in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\fastapi\routing.py", line 327, in app
    content = await serialize_response(
              ^^^^^^^^^^^^^^^^^^^^^^^^^
    ...<9 lines>...
    )
    ^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\fastapi\routing.py", line 176, in serialize_response
    raise ResponseValidationError(
        errors=_normalize_errors(errors), body=response_content
    )
fastapi.exceptions.ResponseValidationError: 3 validation errors:
  {'type': 'value_error', 'loc': ('response', 'roles', 0), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 1, 'nombre': 'Administrador', 'descripcion': 'Administrador con acceso completo', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'ADMIN'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
  {'type': 'value_error', 'loc': ('response', 'roles', 1), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 2, 'nombre': 'Supervisor', 'descripcion': 'Supervisor de departamento', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'SUPERVISOR'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
  {'type': 'value_error', 'loc': ('response', 'roles', 2), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 3, 'nombre': 'Usuario', 'descripcion': 'Usuario estándar', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'USER'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}

2025-11-24 13:32:14,364 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/roles/
2025-11-24 13:32:14,364 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 13:32:14,364 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': acme.app.local:5173
2025-11-24 13:32:14,364 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-11-24 13:32:14,365 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 13:32:14,365 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-11-24 13:32:14,366 - app.middleware.tenant_middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=2
2025-11-24 13:32:14,366 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=multi, bd=bd_cliente_acme, servidor=localhost
2025-11-24 13:32:14,366 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=2, db_type=multi, bd=bd_cliente_acme, path=/api/v1/roles/
2025-11-24 13:32:14,367 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 13:32:14,368 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 13:32:14,369 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 13:32:14,371 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 13:32:14,372 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 13:32:14,372 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 13:32:14,373 - app.api.v1.endpoints.roles - INFO - Solicitud GET /roles/ recibida por usuario 1 del cliente 2 - Paginación: page=1, limit=10, Búsqueda: 'None'
2025-11-24 13:32:14,373 - app.services.rol_service - INFO - Obteniendo roles paginados para cliente 2: page=1, limit=10, search='None'
2025-11-24 13:32:14,374 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 13:32:14,375 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 13:32:14,377 - app.services.rol_service - INFO - Obtención paginada de roles para cliente 2 completada exitosamente
2025-11-24 13:32:14,377 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/roles/ N/A 13.5ms
2025-11-24 13:32:14,378 - app.core.exceptions - ERROR - Error no manejado: 3 validation errors:
  {'type': 'value_error', 'loc': ('response', 'roles', 0), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 1, 'nombre': 'Administrador', 'descripcion': 'Administrador con acceso completo', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'ADMIN'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
  {'type': 'value_error', 'loc': ('response', 'roles', 1), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 2, 'nombre': 'Supervisor', 'descripcion': 'Supervisor de departamento', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'SUPERVISOR'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
  {'type': 'value_error', 'loc': ('response', 'roles', 2), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 3, 'nombre': 'Usuario', 'descripcion': 'Usuario estándar', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'USER'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
  + Exception Group Traceback (most recent call last):
  |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 76, in collapse_excgroups
  |     yield
  |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 186, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ~~~~~~~~~~~~~~~~~~~~~~~^^
  |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\anyio\_backends\_asyncio.py", line 815, in __aexit__
  |     raise BaseExceptionGroup(
  |         "unhandled errors in a TaskGroup", self._exceptions
  |     )
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\errors.py", line 165, in __call__
    |     await self.app(scope, receive, _send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    |     with collapse_excgroups():
    |          ~~~~~~~~~~~~~~~~~~^^
    |   File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\app\main.py", line 190, in security_headers
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    |     raise app_exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    |     with collapse_excgroups():
    |          ~~~~~~~~~~~~~~~~~~^^
    |   File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\app\main.py", line 181, in log_requests
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    |     raise app_exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    |     with collapse_excgroups():
    |          ~~~~~~~~~~~~~~~~~~^^
    |   File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\app\main.py", line 158, in cors_middleware
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    |     raise app_exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    |     with collapse_excgroups():
    |          ~~~~~~~~~~~~~~~~~~^^
    |   File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\app\middleware\tenant_middleware.py", line 293, in dispatch
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    |     raise app_exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\exceptions.py", line 62, in __call__
    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 715, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 735, in app
    |     await route.handle(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 288, in handle
    |     await self.app(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 76, in app
    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 73, in app
    |     response = await f(request)
    |                ^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\fastapi\routing.py", line 327, in app
    |     content = await serialize_response(
    |               ^^^^^^^^^^^^^^^^^^^^^^^^^
    |     ...<9 lines>...
    |     )
    |     ^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\fastapi\routing.py", line 176, in serialize_response
    |     raise ResponseValidationError(
    |         errors=_normalize_errors(errors), body=response_content
    |     )
    | fastapi.exceptions.ResponseValidationError: 3 validation errors:
    |   {'type': 'value_error', 'loc': ('response', 'roles', 0), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 1, 'nombre': 'Administrador', 'descripcion': 'Administrador con acceso completo', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'ADMIN'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
    |   {'type': 'value_error', 'loc': ('response', 'roles', 1), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 2, 'nombre': 'Supervisor', 'descripcion': 'Supervisor de departamento', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'SUPERVISOR'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
    |   {'type': 'value_error', 'loc': ('response', 'roles', 2), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 3, 'nombre': 'Usuario', 'descripcion': 'Usuario estándar', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'USER'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
    | 
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\errors.py", line 165, in __call__
    await self.app(scope, receive, _send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    with collapse_excgroups():
         ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\main.py", line 190, in security_headers
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    raise app_exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    with collapse_excgroups():
         ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\main.py", line 181, in log_requests
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    raise app_exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    with collapse_excgroups():
         ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\main.py", line 158, in cors_middleware
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    raise app_exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    with collapse_excgroups():
         ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\middleware\tenant_middleware.py", line 293, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    raise app_exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 715, in __call__
    await self.middleware_stack(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 735, in app
    await route.handle(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 288, in handle
    await self.app(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 76, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 73, in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\fastapi\routing.py", line 327, in app
    content = await serialize_response(
              ^^^^^^^^^^^^^^^^^^^^^^^^^
    ...<9 lines>...
    )
    ^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\fastapi\routing.py", line 176, in serialize_response
    raise ResponseValidationError(
        errors=_normalize_errors(errors), body=response_content
    )
fastapi.exceptions.ResponseValidationError: 3 validation errors:
  {'type': 'value_error', 'loc': ('response', 'roles', 0), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 1, 'nombre': 'Administrador', 'descripcion': 'Administrador con acceso completo', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'ADMIN'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
  {'type': 'value_error', 'loc': ('response', 'roles', 1), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 2, 'nombre': 'Supervisor', 'descripcion': 'Supervisor de departamento', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'SUPERVISOR'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
  {'type': 'value_error', 'loc': ('response', 'roles', 2), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 3, 'nombre': 'Usuario', 'descripcion': 'Usuario estándar', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'USER'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}

2025-11-24 13:32:23,270 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/usuarios/
2025-11-24 13:32:23,272 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/usuarios/ 200 1.1ms
2025-11-24 13:32:23,272 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/roles/all-active/
2025-11-24 13:32:23,273 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/roles/all-active/
2025-11-24 13:32:23,273 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/usuarios/
2025-11-24 13:32:23,274 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/roles/all-active/ 200 1.9ms
2025-11-24 13:32:23,275 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/roles/all-active/ 200 2.0ms
2025-11-24 13:32:23,275 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/usuarios/ 200 1.9ms
2025-11-24 13:32:23,278 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/usuarios/
2025-11-24 13:32:23,279 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 13:32:23,279 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': acme.app.local:5173
2025-11-24 13:32:23,279 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-11-24 13:32:23,280 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 13:32:23,280 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-11-24 13:32:23,281 - app.middleware.tenant_middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=2
2025-11-24 13:32:23,281 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=multi, bd=bd_cliente_acme, servidor=localhost
2025-11-24 13:32:23,282 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=2, db_type=multi, bd=bd_cliente_acme, path=/api/v1/usuarios/
2025-11-24 13:32:23,283 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 13:32:23,284 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 13:32:23,285 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 13:32:23,285 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 13:32:23,286 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 13:32:23,287 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 13:32:23,288 - app.api.v1.endpoints.usuarios - INFO - Solicitud GET /usuarios/ recibida por usuario 1 del cliente 2 - Paginación: page=1, limit=10, Búsqueda: 'None'
2025-11-24 13:32:23,288 - app.services.usuario_service - INFO - Obteniendo usuarios paginados para cliente 2: page=1, limit=10, search='None'
2025-11-24 13:32:23,288 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 13:32:23,294 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 13:32:23,300 - app.services.usuario_service - INFO - Obtención paginada de usuarios completada exitosamente
2025-11-24 13:32:23,300 - app.api.v1.endpoints.usuarios - INFO - Lista paginada de usuarios recuperada para cliente 2 - Total: 3, Página: 1
2025-11-24 13:32:23,301 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/roles/all-active/
2025-11-24 13:32:23,302 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 13:32:23,302 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': acme.app.local:5173
2025-11-24 13:32:23,302 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-11-24 13:32:23,302 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 13:32:23,302 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-11-24 13:32:23,303 - app.middleware.tenant_middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=2
2025-11-24 13:32:23,303 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=multi, bd=bd_cliente_acme, servidor=localhost
2025-11-24 13:32:23,303 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=2, db_type=multi, bd=bd_cliente_acme, path=/api/v1/roles/all-active/
2025-11-24 13:32:23,304 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 13:32:23,305 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 13:32:23,305 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 13:32:23,306 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 13:32:23,307 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 13:32:23,308 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 13:32:23,308 - app.api.v1.endpoints.roles - INFO - Solicitud GET /roles/all-active/ recibida por usuario 1 del cliente 2 para lista simple
2025-11-24 13:32:23,308 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 13:32:23,311 - app.services.rol_service - INFO - Se encontraron 3 roles activos para cliente 2
2025-11-24 13:32:23,311 - app.api.v1.endpoints.roles - INFO - Lista simple de roles activos recuperada para cliente 2 - Total: 3
2025-11-24 13:32:23,312 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/usuarios/ 200 34.3ms
2025-11-24 13:32:23,313 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/roles/all-active/ 200 11.7ms
2025-11-24 13:32:23,314 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/usuarios/
2025-11-24 13:32:23,315 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 13:32:23,315 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': acme.app.local:5173
2025-11-24 13:32:23,315 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-11-24 13:32:23,315 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 13:32:23,315 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-11-24 13:32:23,316 - app.middleware.tenant_middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=2
2025-11-24 13:32:23,317 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=multi, bd=bd_cliente_acme, servidor=localhost
2025-11-24 13:32:23,317 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=2, db_type=multi, bd=bd_cliente_acme, path=/api/v1/usuarios/
2025-11-24 13:32:23,318 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 13:32:23,319 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 13:32:23,319 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 13:32:23,320 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 13:32:23,321 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 13:32:23,322 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 13:32:23,322 - app.api.v1.endpoints.usuarios - INFO - Solicitud GET /usuarios/ recibida por usuario 1 del cliente 2 - Paginación: page=1, limit=10, Búsqueda: 'None'
2025-11-24 13:32:23,323 - app.services.usuario_service - INFO - Obteniendo usuarios paginados para cliente 2: page=1, limit=10, search='None'
2025-11-24 13:32:23,323 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 13:32:23,324 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 13:32:23,327 - app.services.usuario_service - INFO - Obtención paginada de usuarios completada exitosamente
2025-11-24 13:32:23,327 - app.api.v1.endpoints.usuarios - INFO - Lista paginada de usuarios recuperada para cliente 2 - Total: 3, Página: 1
2025-11-24 13:32:23,327 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/roles/all-active/
2025-11-24 13:32:23,328 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 13:32:23,328 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': acme.app.local:5173
2025-11-24 13:32:23,329 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-11-24 13:32:23,329 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 13:32:23,329 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-11-24 13:32:23,330 - app.middleware.tenant_middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=2
2025-11-24 13:32:23,330 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=multi, bd=bd_cliente_acme, servidor=localhost
2025-11-24 13:32:23,330 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=2, db_type=multi, bd=bd_cliente_acme, path=/api/v1/roles/all-active/
2025-11-24 13:32:23,331 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 13:32:23,332 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 13:32:23,333 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 13:32:23,333 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 13:32:23,334 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 13:32:23,335 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 13:32:23,335 - app.api.v1.endpoints.roles - INFO - Solicitud GET /roles/all-active/ recibida por usuario 1 del cliente 2 para lista simple
2025-11-24 13:32:23,336 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 13:32:23,336 - app.services.rol_service - INFO - Se encontraron 3 roles activos para cliente 2
2025-11-24 13:32:23,336 - app.api.v1.endpoints.roles - INFO - Lista simple de roles activos recuperada para cliente 2 - Total: 3
2025-11-24 13:32:23,337 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/usuarios/ 200 22.8ms
2025-11-24 13:32:23,337 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/roles/all-active/ 200 10.1ms
2025-11-24 13:32:25,305 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/roles/
2025-11-24 13:32:25,306 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 13:32:25,306 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': acme.app.local:5173
2025-11-24 13:32:25,306 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-11-24 13:32:25,306 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 13:32:25,306 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-11-24 13:32:25,308 - app.middleware.tenant_middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=2
2025-11-24 13:32:25,308 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=multi, bd=bd_cliente_acme, servidor=localhost
2025-11-24 13:32:25,308 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=2, db_type=multi, bd=bd_cliente_acme, path=/api/v1/roles/
2025-11-24 13:32:25,309 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 13:32:25,310 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 13:32:25,311 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 13:32:25,312 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 13:32:25,314 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 13:32:25,315 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 13:32:25,316 - app.api.v1.endpoints.roles - INFO - Solicitud GET /roles/ recibida por usuario 1 del cliente 2 - Paginación: page=1, limit=10, Búsqueda: 'None'
2025-11-24 13:32:25,317 - app.services.rol_service - INFO - Obteniendo roles paginados para cliente 2: page=1, limit=10, search='None'
2025-11-24 13:32:25,317 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 13:32:25,319 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 13:32:25,320 - app.services.rol_service - INFO - Obtención paginada de roles para cliente 2 completada exitosamente
2025-11-24 13:32:25,321 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/roles/ N/A 15.4ms
2025-11-24 13:32:25,321 - app.core.exceptions - ERROR - Error no manejado: 3 validation errors:
  {'type': 'value_error', 'loc': ('response', 'roles', 0), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 1, 'nombre': 'Administrador', 'descripcion': 'Administrador con acceso completo', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'ADMIN'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
  {'type': 'value_error', 'loc': ('response', 'roles', 1), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 2, 'nombre': 'Supervisor', 'descripcion': 'Supervisor de departamento', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'SUPERVISOR'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
  {'type': 'value_error', 'loc': ('response', 'roles', 2), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 3, 'nombre': 'Usuario', 'descripcion': 'Usuario estándar', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'USER'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
  + Exception Group Traceback (most recent call last):
  |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 76, in collapse_excgroups
  |     yield
  |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 186, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ~~~~~~~~~~~~~~~~~~~~~~~^^
  |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\anyio\_backends\_asyncio.py", line 815, in __aexit__
  |     raise BaseExceptionGroup(
  |         "unhandled errors in a TaskGroup", self._exceptions
  |     )
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\errors.py", line 165, in __call__
    |     await self.app(scope, receive, _send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    |     with collapse_excgroups():
    |          ~~~~~~~~~~~~~~~~~~^^
    |   File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\app\main.py", line 190, in security_headers
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    |     raise app_exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    |     with collapse_excgroups():
    |          ~~~~~~~~~~~~~~~~~~^^
    |   File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\app\main.py", line 181, in log_requests
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    |     raise app_exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    |     with collapse_excgroups():
    |          ~~~~~~~~~~~~~~~~~~^^
    |   File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\app\main.py", line 158, in cors_middleware
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    |     raise app_exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    |     with collapse_excgroups():
    |          ~~~~~~~~~~~~~~~~~~^^
    |   File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\app\middleware\tenant_middleware.py", line 293, in dispatch
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    |     raise app_exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\exceptions.py", line 62, in __call__
    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 715, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 735, in app
    |     await route.handle(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 288, in handle
    |     await self.app(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 76, in app
    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 73, in app
    |     response = await f(request)
    |                ^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\fastapi\routing.py", line 327, in app
    |     content = await serialize_response(
    |               ^^^^^^^^^^^^^^^^^^^^^^^^^
    |     ...<9 lines>...
    |     )
    |     ^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\fastapi\routing.py", line 176, in serialize_response
    |     raise ResponseValidationError(
    |         errors=_normalize_errors(errors), body=response_content
    |     )
    | fastapi.exceptions.ResponseValidationError: 3 validation errors:
    |   {'type': 'value_error', 'loc': ('response', 'roles', 0), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 1, 'nombre': 'Administrador', 'descripcion': 'Administrador con acceso completo', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'ADMIN'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
    |   {'type': 'value_error', 'loc': ('response', 'roles', 1), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 2, 'nombre': 'Supervisor', 'descripcion': 'Supervisor de departamento', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'SUPERVISOR'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
    |   {'type': 'value_error', 'loc': ('response', 'roles', 2), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 3, 'nombre': 'Usuario', 'descripcion': 'Usuario estándar', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'USER'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
    | 
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\errors.py", line 165, in __call__
    await self.app(scope, receive, _send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    with collapse_excgroups():
         ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\main.py", line 190, in security_headers
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    raise app_exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    with collapse_excgroups():
         ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\main.py", line 181, in log_requests
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    raise app_exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    with collapse_excgroups():
         ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\main.py", line 158, in cors_middleware
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    raise app_exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    with collapse_excgroups():
         ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\middleware\tenant_middleware.py", line 293, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    raise app_exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 715, in __call__
    await self.middleware_stack(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 735, in app
    await route.handle(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 288, in handle
    await self.app(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 76, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 73, in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\fastapi\routing.py", line 327, in app
    content = await serialize_response(
              ^^^^^^^^^^^^^^^^^^^^^^^^^
    ...<9 lines>...
    )
    ^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\fastapi\routing.py", line 176, in serialize_response
    raise ResponseValidationError(
        errors=_normalize_errors(errors), body=response_content
    )
fastapi.exceptions.ResponseValidationError: 3 validation errors:
  {'type': 'value_error', 'loc': ('response', 'roles', 0), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 1, 'nombre': 'Administrador', 'descripcion': 'Administrador con acceso completo', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'ADMIN'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
  {'type': 'value_error', 'loc': ('response', 'roles', 1), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 2, 'nombre': 'Supervisor', 'descripcion': 'Supervisor de departamento', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'SUPERVISOR'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
  {'type': 'value_error', 'loc': ('response', 'roles', 2), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 3, 'nombre': 'Usuario', 'descripcion': 'Usuario estándar', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'USER'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}

2025-11-24 13:32:25,343 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/roles/
2025-11-24 13:32:25,343 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 13:32:25,344 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': acme.app.local:5173
2025-11-24 13:32:25,344 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-11-24 13:32:25,344 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 13:32:25,344 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-11-24 13:32:25,346 - app.middleware.tenant_middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=2
2025-11-24 13:32:25,346 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=multi, bd=bd_cliente_acme, servidor=localhost
2025-11-24 13:32:25,346 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=2, db_type=multi, bd=bd_cliente_acme, path=/api/v1/roles/
2025-11-24 13:32:25,348 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 13:32:25,349 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 13:32:25,350 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 13:32:25,351 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 13:32:25,351 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 13:32:25,352 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 13:32:25,353 - app.api.v1.endpoints.roles - INFO - Solicitud GET /roles/ recibida por usuario 1 del cliente 2 - Paginación: page=1, limit=10, Búsqueda: 'None'
2025-11-24 13:32:25,353 - app.services.rol_service - INFO - Obteniendo roles paginados para cliente 2: page=1, limit=10, search='None'
2025-11-24 13:32:25,353 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 13:32:25,355 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 13:32:25,356 - app.services.rol_service - INFO - Obtención paginada de roles para cliente 2 completada exitosamente
2025-11-24 13:32:25,357 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/roles/ N/A 13.9ms
2025-11-24 13:32:25,357 - app.core.exceptions - ERROR - Error no manejado: 3 validation errors:
  {'type': 'value_error', 'loc': ('response', 'roles', 0), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 1, 'nombre': 'Administrador', 'descripcion': 'Administrador con acceso completo', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'ADMIN'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
  {'type': 'value_error', 'loc': ('response', 'roles', 1), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 2, 'nombre': 'Supervisor', 'descripcion': 'Supervisor de departamento', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'SUPERVISOR'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
  {'type': 'value_error', 'loc': ('response', 'roles', 2), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 3, 'nombre': 'Usuario', 'descripcion': 'Usuario estándar', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'USER'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
  + Exception Group Traceback (most recent call last):
  |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 76, in collapse_excgroups
  |     yield
  |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 186, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ~~~~~~~~~~~~~~~~~~~~~~~^^
  |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\anyio\_backends\_asyncio.py", line 815, in __aexit__
  |     raise BaseExceptionGroup(
  |         "unhandled errors in a TaskGroup", self._exceptions
  |     )
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\errors.py", line 165, in __call__
    |     await self.app(scope, receive, _send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    |     with collapse_excgroups():
    |          ~~~~~~~~~~~~~~~~~~^^
    |   File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\app\main.py", line 190, in security_headers
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    |     raise app_exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    |     with collapse_excgroups():
    |          ~~~~~~~~~~~~~~~~~~^^
    |   File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\app\main.py", line 181, in log_requests
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    |     raise app_exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    |     with collapse_excgroups():
    |          ~~~~~~~~~~~~~~~~~~^^
    |   File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\app\main.py", line 158, in cors_middleware
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    |     raise app_exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    |     with collapse_excgroups():
    |          ~~~~~~~~~~~~~~~~~~^^
    |   File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\app\middleware\tenant_middleware.py", line 293, in dispatch
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    |     raise app_exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\exceptions.py", line 62, in __call__
    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 715, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 735, in app
    |     await route.handle(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 288, in handle
    |     await self.app(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 76, in app
    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 73, in app
    |     response = await f(request)
    |                ^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\fastapi\routing.py", line 327, in app
    |     content = await serialize_response(
    |               ^^^^^^^^^^^^^^^^^^^^^^^^^
    |     ...<9 lines>...
    |     )
    |     ^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\fastapi\routing.py", line 176, in serialize_response
    |     raise ResponseValidationError(
    |         errors=_normalize_errors(errors), body=response_content
    |     )
    | fastapi.exceptions.ResponseValidationError: 3 validation errors:
    |   {'type': 'value_error', 'loc': ('response', 'roles', 0), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 1, 'nombre': 'Administrador', 'descripcion': 'Administrador con acceso completo', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'ADMIN'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
    |   {'type': 'value_error', 'loc': ('response', 'roles', 1), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 2, 'nombre': 'Supervisor', 'descripcion': 'Supervisor de departamento', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'SUPERVISOR'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
    |   {'type': 'value_error', 'loc': ('response', 'roles', 2), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 3, 'nombre': 'Usuario', 'descripcion': 'Usuario estándar', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'USER'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
    | 
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\errors.py", line 165, in __call__
    await self.app(scope, receive, _send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    with collapse_excgroups():
         ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\main.py", line 190, in security_headers
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    raise app_exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    with collapse_excgroups():
         ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\main.py", line 181, in log_requests
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    raise app_exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    with collapse_excgroups():
         ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\main.py", line 158, in cors_middleware
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    raise app_exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    with collapse_excgroups():
         ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\middleware\tenant_middleware.py", line 293, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    raise app_exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 715, in __call__
    await self.middleware_stack(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 735, in app
    await route.handle(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 288, in handle
    await self.app(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 76, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 73, in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\fastapi\routing.py", line 327, in app
    content = await serialize_response(
              ^^^^^^^^^^^^^^^^^^^^^^^^^
    ...<9 lines>...
    )
    ^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\fastapi\routing.py", line 176, in serialize_response
    raise ResponseValidationError(
        errors=_normalize_errors(errors), body=response_content
    )
fastapi.exceptions.ResponseValidationError: 3 validation errors:
  {'type': 'value_error', 'loc': ('response', 'roles', 0), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 1, 'nombre': 'Administrador', 'descripcion': 'Administrador con acceso completo', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'ADMIN'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
  {'type': 'value_error', 'loc': ('response', 'roles', 1), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 2, 'nombre': 'Supervisor', 'descripcion': 'Supervisor de departamento', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'SUPERVISOR'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}
  {'type': 'value_error', 'loc': ('response', 'roles', 2), 'msg': 'Value error, Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).', 'input': {'rol_id': 3, 'nombre': 'Usuario', 'descripcion': 'Usuario estándar', 'es_activo': True, 'fecha_creacion': datetime.datetime(2025, 11, 16, 10, 28, 49, 500000), 'cliente_id': 2, 'codigo_rol': 'USER'}, 'ctx': {'error': ValueError('Un rol con codigo_rol (rol de sistema) solo puede pertenecer al cliente SUPER ADMIN (cliente_id=1). Para otros clientes, cree un rol de cliente (codigo_rol=NULL).')}}

2025-11-24 13:34:47,568 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/usuarios/
2025-11-24 13:34:47,569 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 13:34:47,569 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': acme.app.local:5173
2025-11-24 13:34:47,570 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-11-24 13:34:47,570 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 13:34:47,570 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-11-24 13:34:47,584 - app.middleware.tenant_middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=2
2025-11-24 13:34:47,584 - app.middleware.tenant_middleware - INFO - [TENANT] Metadata cargada: db_type=multi, bd=bd_cliente_acme, servidor=localhost
2025-11-24 13:34:47,584 - app.middleware.tenant_middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=2, db_type=multi, bd=bd_cliente_acme, path=/api/v1/usuarios/
2025-11-24 13:34:47,585 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 13:34:47,593 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 13:34:47,595 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 13:34:47,596 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 13:34:47,598 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 13:34:47,599 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 13:34:47,600 - app.api.v1.endpoints.usuarios - INFO - Solicitud GET /usuarios/ recibida por usuario 1 del cliente 2 - Paginación: page=1, limit=10, Búsqueda: 'None'
2025-11-24 13:34:47,601 - app.services.usuario_service - INFO - Obteniendo usuarios paginados para cliente 2: page=1, limit=10, search='None'
2025-11-24 13:34:47,601 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 13:34:47,607 - app.core.multi_db - INFO - [ROUTING] Cliente 2 -> Multi-DB (bd_cliente_acme)
2025-11-24 13:34:47,614 - app.services.usuario_service - INFO - Obtención paginada de usuarios completada exitosamente
2025-11-24 13:34:47,614 - app.api.v1.endpoints.usuarios - INFO - Lista paginada de usuarios recuperada para cliente 2 - Total: 3, Página: 1
2025-11-24 13:34:47,615 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/roles/all-active/
2025-11-24 13:34:47,616 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-11-24 13:34:47,616 - app.middleware.tenant_middleware - INFO - [HOST_DETECTION] Tenant extraído de 'origin': acme.app.local:5173
2025-11-24 13:34:47,616 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-11-24 13:34:47,616 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-11-24 13:34:47,617 - app.middleware.tenant_middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-11-24 13:34:47,617 - app.middleware.tenant_middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=2
