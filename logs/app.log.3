2025-12-03 12:54:34,055 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 12:54:34,068 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 12:54:39,122 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 12:54:39,386 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 12:54:39,393 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 12:54:45,211 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 12:54:45,443 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 12:54:45,451 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 12:54:59,765 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 12:55:00,022 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 12:55:00,029 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 12:55:05,927 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 12:55:06,165 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 12:55:06,169 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 12:55:12,065 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 12:55:12,310 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 12:55:12,317 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 12:55:18,162 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 12:55:18,405 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 12:55:18,411 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 12:55:30,334 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 12:55:30,593 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 12:55:30,601 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 12:55:36,443 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 12:55:36,693 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 12:55:36,701 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 12:55:42,588 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 12:55:42,829 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 12:55:42,842 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 12:55:48,790 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 12:55:49,054 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 12:55:49,061 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 12:56:10,777 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 12:56:11,019 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 12:56:11,029 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 12:56:17,019 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 12:56:17,268 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 12:56:17,273 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 12:56:22,988 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 12:56:23,246 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 12:56:23,254 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 12:56:36,057 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 12:56:36,300 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 12:56:36,306 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 12:56:42,213 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 12:56:42,475 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 12:56:42,480 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 12:56:48,373 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 12:56:48,633 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 12:56:48,640 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 12:56:53,819 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 12:56:54,117 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 12:56:54,126 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 12:57:02,548 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 12:57:02,806 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 12:57:02,814 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 12:57:08,749 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 12:57:09,049 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 12:57:09,058 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 12:57:14,099 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 12:57:14,345 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 12:57:14,353 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 12:57:20,192 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 12:57:20,465 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 12:57:20,473 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 12:57:25,681 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 12:57:25,942 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 12:57:25,950 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 12:57:31,775 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 12:57:32,024 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 12:57:32,031 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 12:58:53,702 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 12:58:53,950 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 12:58:53,959 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 12:59:11,456 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 12:59:11,689 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 12:59:11,695 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 12:59:42,393 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 12:59:42,603 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 12:59:42,605 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:04:31,040 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:04:31,302 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:04:31,310 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:04:35,941 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:04:36,176 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:04:36,183 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:04:40,920 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:04:41,156 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:04:41,162 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:04:45,145 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:04:45,387 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:04:45,395 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:04:50,086 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:04:50,323 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:04:50,331 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:04:55,002 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:04:55,254 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:04:55,262 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:05:06,479 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:05:06,735 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:05:06,742 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:05:17,466 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:05:17,726 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:05:17,734 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:05:22,486 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:05:22,717 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:05:22,724 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:05:27,430 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:05:27,717 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:05:27,724 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:05:32,480 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:05:32,722 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:05:32,731 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:05:37,490 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:05:37,735 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:05:37,742 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:05:41,692 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:05:41,954 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:05:41,962 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:05:46,643 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:05:46,880 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:05:46,887 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:06:03,783 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:06:04,047 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:06:04,054 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:10:29,140 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:10:29,379 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:10:29,387 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:10:34,259 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:10:34,505 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:10:34,513 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:10:39,276 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:10:39,513 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:10:39,521 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:10:43,595 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:10:43,815 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:10:43,823 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:10:49,732 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:10:49,969 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:10:49,975 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:10:53,987 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:10:54,233 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:10:54,241 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:10:59,056 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:10:59,301 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:10:59,308 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:11:03,466 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:11:03,715 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:11:03,722 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:11:12,286 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:11:12,521 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:11:12,528 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:11:17,346 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:11:17,577 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:11:17,584 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:11:21,662 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:11:21,906 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:11:21,914 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:11:25,938 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:11:26,209 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:11:26,217 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:11:31,804 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:11:32,037 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:11:32,044 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:11:36,906 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:11:37,144 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:11:37,151 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:11:41,312 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:11:41,562 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:11:41,571 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:11:53,789 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:11:54,053 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:11:54,061 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:12:01,252 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:12:01,492 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:12:01,499 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:12:06,460 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:12:06,686 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:12:06,692 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:12:21,751 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:12:21,991 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:12:21,998 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:12:26,006 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:12:26,259 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:12:26,265 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:12:31,003 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:12:31,250 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:12:31,255 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:12:36,070 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:12:36,322 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:12:36,329 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:12:41,030 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:12:41,284 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:12:41,291 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:12:46,021 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:12:46,265 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:12:46,272 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:12:50,209 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:12:50,481 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:12:50,488 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:12:55,397 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:12:55,634 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:12:55,642 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:13:00,431 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:13:00,650 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:13:00,656 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:13:12,780 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:13:13,038 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:13:13,046 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:13:20,221 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:13:20,469 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:13:20,476 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:13:25,204 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:13:25,449 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:13:25,456 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:13:30,268 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:13:30,529 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:13:30,535 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:13:35,324 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:13:35,581 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:13:35,588 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:13:40,396 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:13:40,651 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:13:40,658 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:13:45,389 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:13:45,662 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:13:45,671 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:13:50,466 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:13:50,730 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:13:50,737 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:13:55,494 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:13:55,761 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:13:55,769 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:14:00,680 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:14:00,932 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:14:00,939 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:14:06,577 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:14:06,820 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:14:06,827 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:14:11,563 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:14:11,806 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:14:11,814 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:14:16,582 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:14:16,839 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:14:16,847 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:14:29,005 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:14:29,257 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:14:29,263 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:14:34,110 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:14:34,353 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:14:34,361 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:14:39,206 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:14:39,469 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:14:39,477 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:14:44,288 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:14:44,541 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:14:44,549 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:14:49,386 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:14:49,628 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:14:49,634 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:14:53,708 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:14:53,965 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:14:53,973 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:15:05,374 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:15:05,626 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:15:05,634 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:15:10,537 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:15:10,796 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:15:10,805 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:15:15,600 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:15:15,853 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:15:15,858 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:15:21,500 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:15:21,749 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:15:21,757 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:15:27,391 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:15:27,658 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:15:27,666 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:15:32,432 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:15:32,691 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:15:32,702 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:15:37,454 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:15:37,706 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:15:37,714 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:15:42,616 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:15:42,888 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:15:42,896 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:15:48,453 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:15:48,706 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:15:48,715 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:15:53,490 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:15:53,780 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:15:53,790 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:15:58,684 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:15:58,959 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:15:58,968 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:16:04,574 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:16:04,831 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:16:04,838 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:16:09,788 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:16:10,051 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:16:10,058 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:16:15,591 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:16:15,853 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:16:15,859 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:17:24,094 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:17:24,348 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:17:24,355 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:17:29,995 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:17:30,262 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:17:30,270 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:17:35,816 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:17:36,069 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:17:36,076 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:17:41,611 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:17:41,858 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:17:41,866 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:17:57,677 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:17:57,938 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:17:57,946 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:18:03,591 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:18:03,850 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:18:03,858 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:18:08,579 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:18:08,852 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:18:08,860 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:18:14,433 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:18:14,686 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:18:14,695 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:18:19,346 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:18:19,605 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:18:19,613 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:18:25,160 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:18:25,409 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:18:25,417 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:18:30,134 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:18:30,385 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:18:30,393 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:18:35,962 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:18:36,221 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:18:36,229 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:18:41,928 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:18:42,162 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:18:42,169 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:18:46,964 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:18:47,197 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:18:47,205 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:18:52,088 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:18:52,334 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:18:52,342 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:18:57,167 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:18:57,448 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:18:57,456 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:19:02,223 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:19:02,485 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:19:02,494 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:19:08,039 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:19:08,311 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:19:08,320 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:19:13,898 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:19:14,153 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:19:14,161 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:19:22,117 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:19:22,378 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:19:22,386 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:19:27,986 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:19:28,265 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:19:28,272 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:19:33,061 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:19:33,315 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:19:33,323 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:19:40,579 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:19:40,840 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:19:40,847 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:20:00,495 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:20:00,761 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:20:00,768 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:20:06,512 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:20:06,774 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:20:06,782 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:20:12,491 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:20:12,769 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:20:12,776 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:20:17,531 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:20:17,799 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:20:17,806 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:20:23,605 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:20:23,862 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:20:23,871 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:20:53,816 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:20:54,036 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:20:54,043 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:21:06,893 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:21:07,121 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:21:07,128 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:23:07,010 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:23:07,262 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:23:07,270 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:23:16,460 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:23:16,701 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:23:16,707 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:23:21,299 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:23:21,528 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:23:21,535 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:23:25,441 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:23:25,676 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:23:25,684 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:23:30,376 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:23:30,629 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:23:30,636 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:23:35,393 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:23:35,618 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:23:35,624 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:23:40,373 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:23:40,596 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:23:40,603 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:24:00,710 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:24:00,941 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:24:00,948 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:24:04,924 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:24:05,176 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:24:05,184 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:24:09,872 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:24:10,110 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:24:10,118 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:24:15,910 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:24:16,147 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:24:16,154 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:24:20,970 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:24:21,219 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:24:21,227 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:24:28,964 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:24:29,202 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:24:29,208 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:24:33,885 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:24:34,137 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:24:34,146 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:24:39,685 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:24:39,932 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:24:39,940 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:24:44,625 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:24:44,875 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:24:44,883 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:24:49,502 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:24:49,769 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:24:49,777 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:24:55,241 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:24:55,497 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:24:55,504 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:25:00,879 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:25:01,118 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:25:01,125 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:25:05,839 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:25:06,075 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:25:06,084 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:25:10,827 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:25:11,081 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:25:11,089 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:25:16,664 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:25:16,914 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:25:16,921 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:25:21,620 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:25:21,862 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:25:21,870 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:25:26,563 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:25:26,811 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:25:26,818 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:25:45,546 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:25:45,794 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:25:45,802 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:25:50,434 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:25:50,685 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:25:50,693 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:25:55,469 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:25:55,724 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:25:55,732 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:26:01,280 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:26:01,548 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:26:01,557 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:26:06,292 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:26:06,553 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:26:06,560 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:26:34,892 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:26:35,143 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:26:35,151 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:26:40,832 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:26:41,079 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:26:41,086 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:26:45,668 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:26:45,917 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:26:45,924 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:26:51,553 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:26:51,801 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:26:51,809 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:27:04,293 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:27:04,534 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:27:04,541 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:27:10,744 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:27:10,987 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:27:10,994 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:27:18,205 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:27:18,462 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:27:18,470 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:27:23,885 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:27:24,137 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:27:24,146 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:27:29,540 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:27:29,784 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:27:29,791 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:27:34,487 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:27:34,731 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:27:34,739 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:27:46,998 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:27:47,251 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:27:47,259 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:27:51,913 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:27:52,157 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:27:52,167 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:27:57,781 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:27:58,076 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:27:58,084 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:28:02,743 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:28:02,985 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:28:02,992 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:28:07,649 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:28:07,895 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:28:07,900 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:28:13,469 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:28:13,711 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:28:13,718 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:28:21,334 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:28:21,575 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:28:21,582 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:30:00,061 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:30:00,329 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:30:00,338 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:30:05,233 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:30:05,496 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:30:05,504 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:30:11,212 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:30:11,456 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:30:11,462 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:30:16,326 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:30:16,595 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:30:16,602 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:30:22,251 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:30:22,500 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:30:22,515 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:30:27,398 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:30:27,649 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:30:27,657 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:30:42,853 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:30:43,095 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:30:43,102 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:30:48,708 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:30:48,948 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:30:48,956 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:30:53,743 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:30:53,999 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:30:54,006 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:30:59,722 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:30:59,967 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:30:59,974 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:32:57,938 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:32:58,182 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:32:58,188 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:33:04,391 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:33:04,638 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:33:04,645 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:33:10,217 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:33:10,472 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:33:10,479 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:33:15,990 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:33:16,234 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:33:16,236 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:33:21,792 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:33:22,058 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:33:22,065 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:33:27,642 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:33:27,897 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:33:27,905 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:33:33,465 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:33:33,726 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:33:33,733 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:33:49,807 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:33:50,076 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:33:50,086 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:33:55,657 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:33:55,902 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:33:55,910 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:34:08,910 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:34:09,185 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:34:09,193 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:34:15,694 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:34:15,932 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:34:15,940 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:34:20,792 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:34:21,044 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:34:21,051 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:34:52,102 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:34:52,370 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:34:52,377 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:34:58,049 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:34:58,313 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:34:58,322 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:35:04,030 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:35:04,304 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:35:04,312 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:35:10,696 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:35:10,930 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:35:10,937 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 13:35:33,008 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 13:35:33,226 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 13:35:33,230 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 14:38:17,973 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 14:38:18,261 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 14:38:18,271 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 14:38:29,122 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 14:38:29,335 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 14:38:29,342 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 14:38:46,629 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 14:38:46,834 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 14:38:46,841 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 14:40:58,446 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 14:40:58,678 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 14:40:58,685 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 14:41:53,348 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 14:41:53,569 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 14:41:53,575 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 14:42:06,431 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 14:42:06,646 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 14:42:06,649 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 14:44:03,322 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 14:44:03,561 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 14:44:03,565 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 14:44:19,786 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 14:44:20,021 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 14:44:20,021 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 14:46:36,601 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 14:46:36,837 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 14:46:36,843 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 14:46:47,591 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 14:46:47,836 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 14:46:47,844 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 14:46:52,998 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 14:46:53,215 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 14:46:53,219 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 14:47:06,766 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 14:47:07,009 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 14:47:07,016 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 14:47:11,460 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 14:47:11,694 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 14:47:11,703 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 14:47:16,298 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 14:47:16,614 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 14:47:16,625 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 14:47:28,146 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 14:47:28,364 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 14:47:28,377 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 14:47:32,906 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 14:47:33,125 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 14:47:33,125 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 14:48:09,524 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 14:48:09,767 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 14:48:09,776 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 14:48:48,309 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 14:48:48,533 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 14:48:48,539 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 14:50:25,066 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 14:50:25,290 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 14:50:25,296 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 14:50:30,427 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 14:50:30,661 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 14:50:30,667 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 14:50:35,096 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 14:50:35,317 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 14:50:35,328 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 14:50:40,637 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 14:50:40,860 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 14:50:40,867 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 14:50:52,175 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 14:50:52,396 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 14:50:52,402 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 14:51:46,012 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 14:51:46,245 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 14:51:46,254 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 14:51:46,267 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 14:51:46,267 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 14:51:46,269 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 14:51:46,269 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 14:51:52,092 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 14:51:52,330 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 14:51:52,338 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 14:51:52,349 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 14:51:52,349 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 14:51:52,349 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 14:51:52,349 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 14:51:58,205 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 14:51:58,427 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 14:51:58,435 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 14:51:58,443 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 14:51:58,443 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 14:51:58,444 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 14:51:58,444 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 14:52:05,186 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 14:52:05,414 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 14:52:05,420 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 14:52:05,420 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 14:52:05,429 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 14:52:05,429 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 14:52:05,429 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 14:52:24,609 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 14:52:24,836 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 14:52:24,845 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 14:52:24,856 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 14:52:24,856 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 14:52:24,857 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 14:52:24,858 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 14:52:30,662 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 14:52:30,886 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 14:52:30,894 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 14:52:30,903 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 14:52:30,903 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 14:52:30,903 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 14:52:30,903 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 14:52:36,849 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 14:52:37,069 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 14:52:37,084 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 14:52:37,091 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 14:52:37,093 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 14:52:37,094 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 14:52:37,094 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 14:52:42,340 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 14:52:42,569 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 14:52:42,577 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 14:52:42,586 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 14:52:42,586 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 14:52:42,588 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 14:52:42,588 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 14:52:48,459 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 14:52:48,694 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 14:52:48,699 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 14:52:48,710 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 14:52:48,710 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 14:52:48,710 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 14:52:48,710 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 14:52:53,949 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 14:52:54,173 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 14:52:54,180 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 14:52:54,189 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 14:52:54,189 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 14:52:54,190 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 14:52:54,190 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 14:53:00,649 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 14:53:00,882 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 14:53:00,888 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 14:53:00,897 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 14:53:00,897 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 14:53:00,898 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 14:53:00,898 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 14:53:06,799 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 14:53:07,032 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 14:53:07,040 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 14:53:07,049 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 14:53:07,049 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 14:53:07,049 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 14:53:07,049 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 14:53:37,030 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 14:53:37,252 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 14:53:37,260 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 14:53:37,268 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 14:53:37,269 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 14:53:37,269 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 14:53:37,269 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 14:59:53,606 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 14:59:53,835 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 14:59:53,841 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 14:59:53,857 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 14:59:53,859 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 14:59:53,859 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 14:59:53,859 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 15:40:46,171 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 15:40:46,420 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 15:40:46,428 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 15:40:46,448 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 15:40:46,450 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 15:40:46,451 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 15:40:46,451 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 15:42:44,739 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 15:42:45,068 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 15:42:45,099 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 15:42:45,103 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 15:42:45,103 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 15:42:45,104 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 15:42:45,105 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 15:42:50,196 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 15:42:50,412 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 15:42:50,423 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 15:42:50,428 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 15:42:50,428 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 15:42:50,429 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 15:42:50,429 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 15:43:17,563 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 15:43:17,767 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 15:43:17,768 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 15:43:17,777 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 15:43:17,777 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 15:43:17,777 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 15:43:17,778 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 15:43:36,448 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 15:43:36,667 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 15:43:36,673 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 15:43:36,678 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 15:43:36,678 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 15:43:36,679 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 15:43:36,679 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 15:43:41,017 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 15:43:41,216 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 15:43:41,221 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 15:43:41,230 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 15:43:41,230 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 15:43:41,231 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 15:43:41,231 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 15:43:46,179 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 15:43:46,389 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 15:43:46,389 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 15:43:46,402 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 15:43:46,402 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 15:43:46,403 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 15:43:46,403 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 15:43:52,149 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 15:43:52,369 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 15:43:52,383 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 15:43:52,383 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 15:43:52,383 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 15:43:52,383 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 15:43:52,383 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 15:43:58,324 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 15:43:58,549 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 15:43:58,549 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 15:43:58,549 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 15:43:58,549 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 15:43:58,549 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 15:43:58,565 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 15:44:12,887 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 15:44:13,137 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 15:44:13,143 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 15:44:13,143 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 15:44:13,143 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 15:44:13,143 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 15:44:13,143 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 15:44:22,185 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 15:44:22,425 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 15:44:22,425 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 15:44:22,449 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 15:44:22,449 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 15:44:22,450 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 15:44:22,450 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 15:44:32,288 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 15:44:32,507 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 15:44:32,509 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 15:44:32,509 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 15:44:32,509 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 15:44:32,519 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 15:44:32,519 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 15:44:38,262 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 15:44:38,520 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 15:44:38,527 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 15:44:38,530 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 15:44:38,530 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 15:44:38,530 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 15:44:38,530 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 15:44:43,530 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 15:44:43,760 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 15:44:43,760 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 15:44:43,770 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 15:44:43,770 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 15:44:43,770 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 15:44:43,770 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 15:45:02,827 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 15:45:03,096 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 15:45:03,105 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 15:45:03,110 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 15:45:03,111 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 15:45:03,112 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 15:45:03,112 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 15:45:09,441 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 15:45:09,688 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 15:45:09,695 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 15:45:09,700 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 15:45:09,700 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 15:45:09,700 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 15:45:09,700 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 15:45:15,333 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 15:45:15,570 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 15:45:15,582 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 15:45:15,590 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 15:45:15,590 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 15:45:15,590 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 15:45:15,590 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 15:45:21,260 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 15:45:21,477 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 15:45:21,480 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 15:45:21,487 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 15:45:21,487 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 15:45:21,489 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 15:45:21,489 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 15:45:53,302 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 15:45:53,523 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 15:45:53,531 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 15:45:53,531 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 15:45:53,531 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 15:45:53,531 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 15:45:53,531 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 15:46:03,621 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 15:46:03,849 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 15:46:03,856 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 15:46:03,860 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 15:46:03,860 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 15:46:03,861 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 15:46:03,861 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 15:46:08,691 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 15:46:08,911 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 15:46:08,911 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 15:46:08,925 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 15:46:08,925 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 15:46:08,925 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 15:46:08,925 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 15:46:14,084 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 15:46:14,281 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 15:46:14,287 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 15:46:14,293 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 15:46:14,293 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 15:46:14,295 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 15:46:14,295 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 15:46:19,932 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 15:46:20,131 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 15:46:20,131 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 15:46:20,144 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 15:46:20,144 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 15:46:20,145 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 15:46:20,145 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 15:46:25,061 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 15:46:25,258 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 15:46:25,261 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 15:46:25,269 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 15:46:25,269 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 15:46:25,269 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 15:46:25,270 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 15:46:37,041 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 15:46:37,252 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 15:46:37,267 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 15:46:37,271 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 15:46:37,271 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 15:46:37,271 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 15:46:37,272 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 15:46:52,577 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 15:46:52,772 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 15:46:52,779 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 15:46:52,783 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 15:46:52,783 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 15:46:52,784 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 15:46:52,784 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 15:46:59,782 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 15:46:59,994 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 15:47:00,000 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 15:47:00,004 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 15:47:00,004 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 15:47:00,005 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 15:47:00,005 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 15:47:04,942 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 15:47:05,138 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 15:47:05,142 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 15:47:05,147 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 15:47:05,147 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 15:47:05,148 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 15:47:05,148 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 15:47:15,488 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 15:47:15,677 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 15:47:15,682 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 15:47:15,687 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 15:47:15,687 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 15:47:15,688 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 15:47:15,688 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 15:47:28,804 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 15:47:28,997 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 15:47:29,004 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 15:47:29,009 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 15:47:29,009 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 15:47:29,011 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 15:47:29,011 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 15:47:37,399 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 15:47:37,629 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 15:47:37,632 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 15:47:37,640 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 15:47:37,640 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 15:47:37,641 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 15:47:37,641 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 15:47:41,872 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 15:47:42,073 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 15:47:42,086 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 15:47:42,089 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 15:47:42,089 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 15:47:42,090 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 15:47:42,090 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 15:47:47,744 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 15:47:47,944 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 15:47:47,944 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 15:47:47,954 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 15:47:47,954 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 15:47:47,955 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 15:47:47,955 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 15:48:05,795 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 15:48:05,998 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 15:48:06,003 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 15:48:06,011 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 15:48:06,011 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 15:48:06,011 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 15:48:06,011 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 15:48:10,964 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 15:48:11,159 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 15:48:11,165 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 15:48:11,168 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 15:48:11,168 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 15:48:11,169 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 15:48:11,169 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 15:48:17,437 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 15:48:17,648 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 15:48:17,654 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 15:48:17,660 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 15:48:17,660 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 15:48:17,661 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 15:48:17,661 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 15:48:23,596 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 15:48:23,833 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 15:48:23,837 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 15:48:23,844 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 15:48:23,844 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 15:48:23,844 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 15:48:23,844 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 15:48:29,598 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 15:48:29,828 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 15:48:29,838 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 15:48:29,838 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 15:48:29,838 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 15:48:29,842 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 15:48:29,842 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 15:48:35,543 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 15:48:35,778 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 15:48:35,783 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 15:48:35,785 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 15:48:35,785 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 15:48:35,785 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 15:48:35,785 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 15:48:41,441 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 15:48:41,678 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 15:48:41,686 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 15:48:41,689 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 15:48:41,689 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 15:48:41,690 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 15:48:41,690 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 15:48:47,387 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 15:48:47,613 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 15:48:47,613 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 15:48:47,623 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 15:48:47,623 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 15:48:47,623 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 15:48:47,623 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 15:48:52,514 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 15:48:52,743 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 15:48:52,754 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 15:48:52,755 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 15:48:52,755 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 15:48:52,755 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 15:48:52,755 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 15:49:00,054 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 15:49:00,284 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 15:49:00,294 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 15:49:00,296 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 15:49:00,296 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 15:49:00,298 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 15:49:00,298 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 15:49:06,187 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 15:49:06,410 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 15:49:06,415 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 15:49:06,419 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 15:49:06,419 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 15:49:06,421 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 15:49:06,421 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 15:49:15,957 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 15:49:16,193 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 15:49:16,201 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 15:49:16,205 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 15:49:16,205 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 15:49:16,206 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 15:49:16,206 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 15:49:23,627 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 15:49:23,858 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 15:49:23,866 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 15:49:23,870 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 15:49:23,870 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 15:49:23,871 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 15:49:23,871 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 15:49:29,805 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 15:49:30,039 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 15:49:30,046 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 15:49:30,050 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 15:49:30,050 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 15:49:30,051 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 15:49:30,051 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 15:49:35,874 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 15:49:36,106 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 15:49:36,113 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 15:49:36,118 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 15:49:36,118 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 15:49:36,119 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 15:49:36,119 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 15:49:42,030 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 15:49:42,269 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 15:49:42,277 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 15:49:42,282 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 15:49:42,282 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 15:49:42,283 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 15:49:42,283 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 15:49:49,054 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 15:49:49,294 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 15:49:49,304 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 15:49:49,308 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 15:49:49,308 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 15:49:49,309 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 15:49:49,309 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 15:49:55,121 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 15:49:55,387 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 15:49:55,395 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 15:49:55,400 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 15:49:55,400 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 15:49:55,401 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 15:49:55,401 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 15:50:01,237 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 15:50:01,497 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 15:50:01,505 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 15:50:01,510 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 15:50:01,510 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 15:50:01,510 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 15:50:01,511 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 15:50:21,238 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 15:50:21,435 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 15:50:21,445 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 15:50:21,450 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 15:50:21,450 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 15:50:21,451 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 15:50:21,451 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 15:51:53,400 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 15:51:53,634 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 15:51:53,640 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 15:51:53,643 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 15:51:53,643 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 15:51:53,644 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 15:51:53,644 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 15:52:24,107 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 15:52:24,366 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 15:52:24,367 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 15:52:24,374 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 15:52:24,374 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 15:52:24,375 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 15:52:24,375 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 15:52:35,406 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 15:52:35,645 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 15:52:35,654 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 15:52:35,656 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 15:52:35,656 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 15:52:35,657 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 15:52:35,657 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 15:52:41,247 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 15:52:41,495 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 15:52:41,501 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 15:52:41,504 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 15:52:41,504 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 15:52:41,505 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 15:52:41,505 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 15:52:47,097 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 15:52:47,343 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 15:52:47,348 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 15:52:47,348 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 15:52:47,348 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 15:52:47,348 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 15:52:47,348 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 15:52:58,763 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 15:52:59,014 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 15:52:59,020 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 15:52:59,023 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 15:52:59,023 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 15:52:59,024 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 15:52:59,024 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 15:56:18,676 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 15:56:18,887 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 15:56:18,893 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 15:56:18,895 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 15:56:18,895 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 15:56:18,896 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 15:56:18,896 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 15:58:16,802 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 15:58:16,989 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 15:58:16,993 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 15:58:16,997 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 15:58:16,997 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 15:58:16,999 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 15:58:16,999 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 15:58:16,999 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=9b8ab97c-89d4-41dc-8bbf-54d193edbe02, DEFAULT_TYPE=single
2025-12-03 16:00:05,984 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 16:00:06,239 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 16:00:06,247 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 16:00:06,249 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 16:00:06,249 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 16:00:06,249 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 16:00:06,249 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 16:00:06,249 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=9b8ab97c-89d4-41dc-8bbf-54d193edbe02, DEFAULT_TYPE=single
2025-12-03 16:00:17,968 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 16:00:18,179 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 16:00:18,184 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 16:00:18,188 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 16:00:18,188 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 16:00:18,188 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 16:00:18,188 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 16:00:18,189 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=9b8ab97c-89d4-41dc-8bbf-54d193edbe02, DEFAULT_TYPE=single
2025-12-03 16:00:44,750 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 16:00:45,016 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 16:00:45,021 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 16:00:45,023 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 16:00:45,023 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 16:00:45,023 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 16:00:45,025 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 16:00:45,025 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=9b8ab97c-89d4-41dc-8bbf-54d193edbe02, DEFAULT_TYPE=single
2025-12-03 16:01:54,869 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 16:01:55,121 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 16:01:55,127 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 16:01:55,130 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 16:01:55,130 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 16:01:55,131 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 16:01:55,131 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 16:01:55,131 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=9b8ab97c-89d4-41dc-8bbf-54d193edbe02, DEFAULT_TYPE=single
2025-12-03 16:02:10,560 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 16:02:10,751 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 16:02:10,756 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 16:02:10,763 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 16:02:10,763 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 16:02:10,763 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 16:02:10,763 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 16:02:10,764 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=9b8ab97c-89d4-41dc-8bbf-54d193edbe02, DEFAULT_TYPE=single
2025-12-03 16:02:27,780 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 16:02:27,979 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 16:02:27,986 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 16:02:27,989 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 16:02:27,989 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 16:02:27,990 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 16:02:27,990 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 16:02:27,990 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=9b8ab97c-89d4-41dc-8bbf-54d193edbe02, DEFAULT_TYPE=single
2025-12-03 16:03:09,707 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 16:03:09,947 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 16:03:09,957 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 16:03:09,960 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 16:03:09,960 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 16:03:09,961 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 16:03:09,961 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 16:03:09,961 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=9b8ab97c-89d4-41dc-8bbf-54d193edbe02, DEFAULT_TYPE=single
2025-12-03 16:03:18,190 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 16:03:18,412 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 16:03:18,417 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 16:03:18,420 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 16:03:18,420 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 16:03:18,421 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 16:03:18,421 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 16:03:18,421 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=9b8ab97c-89d4-41dc-8bbf-54d193edbe02, DEFAULT_TYPE=single
2025-12-03 16:03:55,844 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 16:03:56,083 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 16:03:56,088 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 16:03:56,088 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 16:03:56,088 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 16:03:56,088 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 16:03:56,088 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 16:03:56,088 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=9b8ab97c-89d4-41dc-8bbf-54d193edbe02, DEFAULT_TYPE=single
2025-12-03 16:04:03,900 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 16:04:04,134 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 16:04:04,140 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 16:04:04,144 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 16:04:04,144 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 16:04:04,145 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 16:04:04,145 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 16:04:04,145 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=9b8ab97c-89d4-41dc-8bbf-54d193edbe02, DEFAULT_TYPE=single
2025-12-03 16:05:12,149 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 16:05:12,389 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 16:05:12,395 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 16:05:12,400 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 16:05:12,400 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 16:05:12,401 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 16:05:12,401 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 16:05:12,401 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=9b8ab97c-89d4-41dc-8bbf-54d193edbe02, DEFAULT_TYPE=single
2025-12-03 16:05:54,288 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 16:05:54,515 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 16:05:54,525 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 16:05:54,527 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 16:05:54,528 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 16:05:54,528 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 16:05:54,528 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 16:05:54,529 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=9b8ab97c-89d4-41dc-8bbf-54d193edbe02, DEFAULT_TYPE=single
2025-12-03 16:06:07,810 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 16:06:08,062 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 16:06:08,067 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 16:06:08,070 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 16:06:08,070 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 16:06:08,071 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 16:06:08,071 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 16:06:08,072 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=9b8ab97c-89d4-41dc-8bbf-54d193edbe02, DEFAULT_TYPE=single
2025-12-03 16:06:12,780 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 16:06:13,010 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 16:06:13,010 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 16:06:13,019 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 16:06:13,019 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 16:06:13,019 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 16:06:13,019 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 16:06:13,019 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=9b8ab97c-89d4-41dc-8bbf-54d193edbe02, DEFAULT_TYPE=single
2025-12-03 16:06:21,210 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 16:06:21,450 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 16:06:21,456 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 16:06:21,462 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 16:06:21,462 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 16:06:21,462 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 16:06:21,462 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 16:06:21,462 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=9b8ab97c-89d4-41dc-8bbf-54d193edbe02, DEFAULT_TYPE=single
2025-12-03 16:09:02,402 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 16:09:02,659 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 16:09:02,660 - app.infrastructure.database.connection_async - ERROR - [ASYNC_CONNECTION] aioodbc NO disponible
2025-12-03 16:09:02,660 - app.infrastructure.database.connection_async - ERROR - [ASYNC_CONNECTION] CRÍTICO: Instalar: pip install aioodbc
2025-12-03 16:09:28,245 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 16:09:28,441 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 16:09:28,449 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 16:09:28,452 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 16:09:28,453 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 16:09:28,453 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 16:09:28,453 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 16:09:28,453 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=9b8ab97c-89d4-41dc-8bbf-54d193edbe02, DEFAULT_TYPE=single
2025-12-03 16:09:41,873 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 16:09:42,103 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 16:09:42,104 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 16:09:42,104 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 16:09:42,104 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 16:09:42,113 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 16:09:42,113 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 16:09:42,113 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=9b8ab97c-89d4-41dc-8bbf-54d193edbe02, DEFAULT_TYPE=single
2025-12-03 16:09:42,578 - app.core.security.rate_limiting - INFO - [RATE_LIMITING] Activado. Límites: Login=10/minute, API=200/minute
2025-12-03 16:09:42,578 - app.core.security.rate_limiting - INFO - ✅ Módulo de rate limiting cargado y activo
2025-12-03 16:09:51,790 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 16:09:52,006 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 16:09:52,011 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 16:09:52,015 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 16:09:52,015 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 16:09:52,016 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 16:09:52,016 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 16:09:52,016 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=9b8ab97c-89d4-41dc-8bbf-54d193edbe02, DEFAULT_TYPE=single
2025-12-03 16:09:52,424 - app.core.security.rate_limiting - INFO - [RATE_LIMITING] Activado. Límites: Login=10/minute, API=200/minute
2025-12-03 16:09:52,424 - app.core.security.rate_limiting - INFO - ✅ Módulo de rate limiting cargado y activo
2025-12-03 16:09:56,601 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 16:09:56,834 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 16:09:56,834 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 16:09:56,834 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 16:09:56,834 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 16:09:56,844 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 16:09:56,844 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 16:09:56,844 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=9b8ab97c-89d4-41dc-8bbf-54d193edbe02, DEFAULT_TYPE=single
2025-12-03 16:09:57,248 - app.core.security.rate_limiting - INFO - [RATE_LIMITING] Activado. Límites: Login=10/minute, API=200/minute
2025-12-03 16:09:57,248 - app.core.security.rate_limiting - INFO - ✅ Módulo de rate limiting cargado y activo
2025-12-03 16:09:58,617 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 16:09:58,809 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 16:09:58,814 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 16:09:58,816 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 16:09:58,816 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 16:09:58,816 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 16:09:58,817 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 16:09:58,817 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=9b8ab97c-89d4-41dc-8bbf-54d193edbe02, DEFAULT_TYPE=single
2025-12-03 16:09:59,090 - app.core.security.rate_limiting - INFO - [RATE_LIMITING] Activado. Límites: Login=10/minute, API=200/minute
2025-12-03 16:09:59,092 - app.core.security.rate_limiting - INFO - ✅ Módulo de rate limiting cargado y activo
2025-12-03 16:10:16,008 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 16:10:16,246 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 16:10:16,246 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 16:10:16,254 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 16:10:16,254 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 16:10:16,254 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 16:10:16,254 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 16:10:16,256 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=9b8ab97c-89d4-41dc-8bbf-54d193edbe02, DEFAULT_TYPE=single
2025-12-03 16:10:16,654 - app.core.security.rate_limiting - INFO - [RATE_LIMITING] Activado. Límites: Login=10/minute, API=200/minute
2025-12-03 16:10:16,654 - app.core.security.rate_limiting - INFO - ✅ Módulo de rate limiting cargado y activo
2025-12-03 16:10:38,031 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 16:10:38,228 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 16:10:38,233 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 16:10:38,236 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 16:10:38,236 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 16:10:38,237 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 16:10:38,237 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 16:10:38,237 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=9b8ab97c-89d4-41dc-8bbf-54d193edbe02, DEFAULT_TYPE=single
2025-12-03 16:10:38,483 - app.core.security.rate_limiting - INFO - [RATE_LIMITING] Activado. Límites: Login=10/minute, API=200/minute
2025-12-03 16:10:38,483 - app.core.security.rate_limiting - INFO - ✅ Módulo de rate limiting cargado y activo
2025-12-03 16:10:48,564 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 16:10:48,846 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 16:10:48,852 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 16:10:48,857 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 16:10:48,857 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 16:10:48,859 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 16:10:48,859 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 16:10:48,859 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=9b8ab97c-89d4-41dc-8bbf-54d193edbe02, DEFAULT_TYPE=single
2025-12-03 16:10:49,264 - app.core.security.rate_limiting - INFO - [RATE_LIMITING] Activado. Límites: Login=10/minute, API=200/minute
2025-12-03 16:10:49,264 - app.core.security.rate_limiting - INFO - ✅ Módulo de rate limiting cargado y activo
2025-12-03 16:10:49,365 - app.core.authorization.rbac - INFO - 🔐 Inicializando sistema de autorización...
2025-12-03 16:10:49,365 - app.core.authorization.rbac - INFO - ✅ Sistema de autorización inicializado correctamente
2025-12-03 16:10:49,365 - app.core.authorization.rbac - INFO - 📊 Permisos del sistema: 6 módulos configurados
2025-12-03 16:10:53,527 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 16:10:53,739 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 16:10:53,743 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 16:10:53,746 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 16:10:53,746 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 16:10:53,747 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 16:10:53,747 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 16:10:53,747 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=9b8ab97c-89d4-41dc-8bbf-54d193edbe02, DEFAULT_TYPE=single
2025-12-03 16:10:54,004 - app.core.security.rate_limiting - INFO - [RATE_LIMITING] Activado. Límites: Login=10/minute, API=200/minute
2025-12-03 16:10:54,004 - app.core.security.rate_limiting - INFO - ✅ Módulo de rate limiting cargado y activo
2025-12-03 16:10:54,120 - app.core.authorization.rbac - INFO - 🔐 Inicializando sistema de autorización...
2025-12-03 16:10:54,120 - app.core.authorization.rbac - INFO - ✅ Sistema de autorización inicializado correctamente
2025-12-03 16:10:54,120 - app.core.authorization.rbac - INFO - 📊 Permisos del sistema: 6 módulos configurados
2025-12-03 16:11:04,705 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 16:11:04,895 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 16:11:04,895 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 16:11:04,905 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 16:11:04,905 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 16:11:04,906 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 16:11:04,906 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 16:11:04,906 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=9b8ab97c-89d4-41dc-8bbf-54d193edbe02, DEFAULT_TYPE=single
2025-12-03 16:11:05,249 - app.core.security.rate_limiting - INFO - [RATE_LIMITING] Activado. Límites: Login=10/minute, API=200/minute
2025-12-03 16:11:05,249 - app.core.security.rate_limiting - INFO - ✅ Módulo de rate limiting cargado y activo
2025-12-03 16:11:05,320 - app.core.authorization.rbac - INFO - 🔐 Inicializando sistema de autorización...
2025-12-03 16:11:05,320 - app.core.authorization.rbac - INFO - ✅ Sistema de autorización inicializado correctamente
2025-12-03 16:11:05,320 - app.core.authorization.rbac - INFO - 📊 Permisos del sistema: 6 módulos configurados
2025-12-03 16:11:10,167 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 16:11:10,357 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 16:11:10,362 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 16:11:10,365 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 16:11:10,365 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 16:11:10,365 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 16:11:10,365 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 16:11:10,366 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=9b8ab97c-89d4-41dc-8bbf-54d193edbe02, DEFAULT_TYPE=single
2025-12-03 16:11:10,609 - app.core.security.rate_limiting - INFO - [RATE_LIMITING] Activado. Límites: Login=10/minute, API=200/minute
2025-12-03 16:11:10,609 - app.core.security.rate_limiting - INFO - ✅ Módulo de rate limiting cargado y activo
2025-12-03 16:11:10,708 - app.core.authorization.rbac - INFO - 🔐 Inicializando sistema de autorización...
2025-12-03 16:11:10,708 - app.core.authorization.rbac - INFO - ✅ Sistema de autorización inicializado correctamente
2025-12-03 16:11:10,708 - app.core.authorization.rbac - INFO - 📊 Permisos del sistema: 6 módulos configurados
2025-12-03 16:11:19,594 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 16:11:19,785 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 16:11:19,789 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 16:11:19,791 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 16:11:19,792 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 16:11:19,792 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 16:11:19,792 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 16:11:19,792 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=9b8ab97c-89d4-41dc-8bbf-54d193edbe02, DEFAULT_TYPE=single
2025-12-03 16:11:20,037 - app.core.security.rate_limiting - INFO - [RATE_LIMITING] Activado. Límites: Login=10/minute, API=200/minute
2025-12-03 16:11:20,037 - app.core.security.rate_limiting - INFO - ✅ Módulo de rate limiting cargado y activo
2025-12-03 16:11:20,141 - app.core.authorization.rbac - INFO - 🔐 Inicializando sistema de autorización...
2025-12-03 16:11:20,141 - app.core.authorization.rbac - INFO - ✅ Sistema de autorización inicializado correctamente
2025-12-03 16:11:20,141 - app.core.authorization.rbac - INFO - 📊 Permisos del sistema: 6 módulos configurados
2025-12-03 16:11:31,841 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 16:11:32,068 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 16:11:32,075 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 16:11:32,084 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 16:11:32,084 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 16:11:32,085 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 16:11:32,085 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 16:11:32,085 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=9b8ab97c-89d4-41dc-8bbf-54d193edbe02, DEFAULT_TYPE=single
2025-12-03 16:11:32,575 - app.core.security.rate_limiting - INFO - [RATE_LIMITING] Activado. Límites: Login=10/minute, API=200/minute
2025-12-03 16:11:32,575 - app.core.security.rate_limiting - INFO - ✅ Módulo de rate limiting cargado y activo
2025-12-03 16:11:32,685 - app.core.authorization.rbac - INFO - 🔐 Inicializando sistema de autorización...
2025-12-03 16:11:32,685 - app.core.authorization.rbac - INFO - ✅ Sistema de autorización inicializado correctamente
2025-12-03 16:11:32,685 - app.core.authorization.rbac - INFO - 📊 Permisos del sistema: 6 módulos configurados
2025-12-03 16:11:34,345 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 16:11:34,534 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 16:11:34,538 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 16:11:34,541 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 16:11:34,541 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 16:11:34,541 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 16:11:34,542 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 16:11:34,542 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=9b8ab97c-89d4-41dc-8bbf-54d193edbe02, DEFAULT_TYPE=single
2025-12-03 16:11:34,787 - app.core.security.rate_limiting - INFO - [RATE_LIMITING] Activado. Límites: Login=10/minute, API=200/minute
2025-12-03 16:11:34,788 - app.core.security.rate_limiting - INFO - ✅ Módulo de rate limiting cargado y activo
2025-12-03 16:11:34,888 - app.core.authorization.rbac - INFO - 🔐 Inicializando sistema de autorización...
2025-12-03 16:11:34,888 - app.core.authorization.rbac - INFO - ✅ Sistema de autorización inicializado correctamente
2025-12-03 16:11:34,888 - app.core.authorization.rbac - INFO - 📊 Permisos del sistema: 6 módulos configurados
2025-12-03 16:11:50,860 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 16:11:51,076 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 16:11:51,076 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 16:11:51,092 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 16:11:51,092 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 16:11:51,092 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 16:11:51,093 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 16:11:51,093 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=9b8ab97c-89d4-41dc-8bbf-54d193edbe02, DEFAULT_TYPE=single
2025-12-03 16:11:51,545 - app.core.security.rate_limiting - INFO - [RATE_LIMITING] Activado. Límites: Login=10/minute, API=200/minute
2025-12-03 16:11:51,545 - app.core.security.rate_limiting - INFO - ✅ Módulo de rate limiting cargado y activo
2025-12-03 16:11:51,652 - app.core.authorization.rbac - INFO - 🔐 Inicializando sistema de autorización...
2025-12-03 16:11:51,652 - app.core.authorization.rbac - INFO - ✅ Sistema de autorización inicializado correctamente
2025-12-03 16:11:51,652 - app.core.authorization.rbac - INFO - 📊 Permisos del sistema: 6 módulos configurados
2025-12-03 16:11:56,000 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 16:11:56,201 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 16:11:56,205 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 16:11:56,207 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 16:11:56,207 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 16:11:56,208 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 16:11:56,208 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 16:11:56,208 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=9b8ab97c-89d4-41dc-8bbf-54d193edbe02, DEFAULT_TYPE=single
2025-12-03 16:11:56,453 - app.core.security.rate_limiting - INFO - [RATE_LIMITING] Activado. Límites: Login=10/minute, API=200/minute
2025-12-03 16:11:56,453 - app.core.security.rate_limiting - INFO - ✅ Módulo de rate limiting cargado y activo
2025-12-03 16:11:56,555 - app.core.authorization.rbac - INFO - 🔐 Inicializando sistema de autorización...
2025-12-03 16:11:56,555 - app.core.authorization.rbac - INFO - ✅ Sistema de autorización inicializado correctamente
2025-12-03 16:11:56,555 - app.core.authorization.rbac - INFO - 📊 Permisos del sistema: 6 módulos configurados
2025-12-03 16:12:07,133 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 16:12:07,376 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 16:12:07,387 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 16:12:07,391 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 16:12:07,391 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 16:12:07,392 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 16:12:07,392 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 16:12:07,392 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=9b8ab97c-89d4-41dc-8bbf-54d193edbe02, DEFAULT_TYPE=single
2025-12-03 16:12:07,831 - app.core.security.rate_limiting - INFO - [RATE_LIMITING] Activado. Límites: Login=10/minute, API=200/minute
2025-12-03 16:12:07,831 - app.core.security.rate_limiting - INFO - ✅ Módulo de rate limiting cargado y activo
2025-12-03 16:12:07,945 - app.core.authorization.rbac - INFO - 🔐 Inicializando sistema de autorización...
2025-12-03 16:12:07,945 - app.core.authorization.rbac - INFO - ✅ Sistema de autorización inicializado correctamente
2025-12-03 16:12:07,945 - app.core.authorization.rbac - INFO - 📊 Permisos del sistema: 6 módulos configurados
2025-12-03 16:12:08,204 - app.core.tenant.middleware - INFO - Módulo tenant_middleware cargado (versión híbrida con soporte para proxies)
2025-12-03 16:12:08,206 - app.main - INFO - ✅ Rate limiting configurado y activo
2025-12-03 16:12:08,354 - app.core.tenant.middleware - INFO - [TENANT_MW] Inicializado - BASE_DOMAIN=app.local, SYSTEM_ID=9B8AB97C-89D4-41DC-8BBF-54D193EDBE02, EXCLUDED_SUBDOMAINS={'admin', 'www', 'assets', 'static', 'backend', 'api', 'cdn'}
2025-12-03 16:12:38,306 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 16:12:38,502 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 16:12:38,508 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 16:12:38,510 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 16:12:38,510 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 16:12:38,511 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 16:12:38,511 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 16:12:38,511 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=9b8ab97c-89d4-41dc-8bbf-54d193edbe02, DEFAULT_TYPE=single
2025-12-03 16:12:38,756 - app.core.security.rate_limiting - INFO - [RATE_LIMITING] Activado. Límites: Login=10/minute, API=200/minute
2025-12-03 16:12:38,756 - app.core.security.rate_limiting - INFO - ✅ Módulo de rate limiting cargado y activo
2025-12-03 16:12:38,853 - app.core.authorization.rbac - INFO - 🔐 Inicializando sistema de autorización...
2025-12-03 16:12:38,853 - app.core.authorization.rbac - INFO - ✅ Sistema de autorización inicializado correctamente
2025-12-03 16:12:38,853 - app.core.authorization.rbac - INFO - 📊 Permisos del sistema: 6 módulos configurados
2025-12-03 16:12:39,007 - app.core.tenant.middleware - INFO - Módulo tenant_middleware cargado (versión híbrida con soporte para proxies)
2025-12-03 16:12:39,007 - app.main - INFO - ✅ Rate limiting configurado y activo
2025-12-03 16:12:54,528 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 16:12:54,704 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 16:12:54,706 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 16:12:54,706 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 16:12:54,706 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 16:12:54,714 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 16:12:54,714 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 16:12:54,714 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=9b8ab97c-89d4-41dc-8bbf-54d193edbe02, DEFAULT_TYPE=single
2025-12-03 16:12:55,037 - app.core.security.rate_limiting - INFO - [RATE_LIMITING] Activado. Límites: Login=10/minute, API=200/minute
2025-12-03 16:12:55,037 - app.core.security.rate_limiting - INFO - ✅ Módulo de rate limiting cargado y activo
2025-12-03 16:12:55,112 - app.core.authorization.rbac - INFO - 🔐 Inicializando sistema de autorización...
2025-12-03 16:12:55,113 - app.core.authorization.rbac - INFO - ✅ Sistema de autorización inicializado correctamente
2025-12-03 16:12:55,113 - app.core.authorization.rbac - INFO - 📊 Permisos del sistema: 6 módulos configurados
2025-12-03 16:12:55,296 - app.core.tenant.middleware - INFO - Módulo tenant_middleware cargado (versión híbrida con soporte para proxies)
2025-12-03 16:12:55,296 - app.main - INFO - ✅ Rate limiting configurado y activo
2025-12-03 16:12:55,451 - app.core.tenant.middleware - INFO - [TENANT_MW] Inicializado - BASE_DOMAIN=app.local, SYSTEM_ID=9B8AB97C-89D4-41DC-8BBF-54D193EDBE02, EXCLUDED_SUBDOMAINS={'api', 'admin', 'backend', 'static', 'assets', 'cdn', 'www'}
2025-12-03 16:13:33,621 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 16:13:33,811 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 16:13:33,815 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 16:13:33,817 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 16:13:33,817 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 16:13:33,818 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 16:13:33,818 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 16:13:33,818 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=9b8ab97c-89d4-41dc-8bbf-54d193edbe02, DEFAULT_TYPE=single
2025-12-03 16:13:34,093 - app.core.security.rate_limiting - INFO - [RATE_LIMITING] Activado. Límites: Login=10/minute, API=200/minute
2025-12-03 16:13:34,093 - app.core.security.rate_limiting - INFO - ✅ Módulo de rate limiting cargado y activo
2025-12-03 16:13:34,197 - app.core.authorization.rbac - INFO - 🔐 Inicializando sistema de autorización...
2025-12-03 16:13:34,197 - app.core.authorization.rbac - INFO - ✅ Sistema de autorización inicializado correctamente
2025-12-03 16:13:34,197 - app.core.authorization.rbac - INFO - 📊 Permisos del sistema: 6 módulos configurados
2025-12-03 16:13:34,361 - app.core.tenant.middleware - INFO - Módulo tenant_middleware cargado (versión híbrida con soporte para proxies)
2025-12-03 16:13:34,362 - app.main - INFO - ✅ Rate limiting configurado y activo
2025-12-03 16:13:34,464 - app.core.tenant.middleware - INFO - [TENANT_MW] Inicializado - BASE_DOMAIN=app.local, SYSTEM_ID=9B8AB97C-89D4-41DC-8BBF-54D193EDBE02, EXCLUDED_SUBDOMAINS={'static', 'cdn', 'api', 'www', 'backend', 'admin', 'assets'}
2025-12-03 16:13:34,470 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Pool ADMIN inicializado. Size=10, MaxOverflow=5
2025-12-03 16:13:34,470 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Configuración de pools de tenants: MaxPools=50, PoolSize=3, MaxOverflow=2, InactivityTimeout=3600s
2025-12-03 16:13:34,470 - app.infrastructure.database.connection_pool - INFO - ✅ Módulo de connection pooling cargado y activo
2025-12-03 16:13:34,470 - app.infrastructure.database.connection_pool - INFO -    Configuración: MaxTenantPools=50, TenantPoolSize=3, InactivityTimeout=3600s
2025-12-03 16:13:34,471 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Todos los pools cerrados
2025-12-03 16:13:34,471 - app.main - INFO - ✅ Pools de conexión cerrados correctamente
2025-12-03 16:13:52,236 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 16:13:52,417 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 16:13:52,417 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 16:13:52,426 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 16:13:52,426 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 16:13:52,426 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 16:13:52,426 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 16:13:52,426 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=9b8ab97c-89d4-41dc-8bbf-54d193edbe02, DEFAULT_TYPE=single
2025-12-03 16:13:52,706 - app.core.security.rate_limiting - INFO - [RATE_LIMITING] Activado. Límites: Login=10/minute, API=200/minute
2025-12-03 16:13:52,706 - app.core.security.rate_limiting - INFO - ✅ Módulo de rate limiting cargado y activo
2025-12-03 16:13:52,807 - app.core.authorization.rbac - INFO - 🔐 Inicializando sistema de autorización...
2025-12-03 16:13:52,807 - app.core.authorization.rbac - INFO - ✅ Sistema de autorización inicializado correctamente
2025-12-03 16:13:52,807 - app.core.authorization.rbac - INFO - 📊 Permisos del sistema: 6 módulos configurados
2025-12-03 16:13:52,969 - app.core.tenant.middleware - INFO - Módulo tenant_middleware cargado (versión híbrida con soporte para proxies)
2025-12-03 16:13:52,969 - app.main - INFO - ✅ Rate limiting configurado y activo
2025-12-03 16:13:53,076 - app.core.tenant.middleware - INFO - [TENANT_MW] Inicializado - BASE_DOMAIN=app.local, SYSTEM_ID=9B8AB97C-89D4-41DC-8BBF-54D193EDBE02, EXCLUDED_SUBDOMAINS={'cdn', 'admin', 'static', 'api', 'www', 'assets', 'backend'}
2025-12-03 16:14:54,165 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /docs
2025-12-03 16:14:54,166 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host '127.0.0.1:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 16:14:54,166 - app.core.tenant.middleware - WARNING - [HOST_DETECTION] No se pudo extraer tenant real de origin/referer, usando cliente por defecto (SYSTEM)
2025-12-03 16:14:54,166 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: '127.0.0.1'
2025-12-03 16:14:54,166 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 16:14:54,166 - app.core.tenant.middleware - WARNING - [SUBDOMAIN] No se detectó subdominio válido en: '127.0.0.1'. Verifica BASE_DOMAIN='app.local'
2025-12-03 16:14:54,166 - app.core.tenant.middleware - WARNING - [TENANT] Sin subdominio en Host: 127.0.0.1:8000. Usando Cliente ID por defecto: 9b8ab97c-89d4-41dc-8bbf-54d193edbe02 (SYSTEM)
2025-12-03 16:14:54,166 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 16:14:54,166 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=9b8ab97c-89d4-41dc-8bbf-54d193edbe02, db_type=single, bd=bd_hybrid_sistema_central, path=/docs
2025-12-03 16:14:54,167 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /docs 200 2.3ms
2025-12-03 16:14:54,239 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /openapi.json
2025-12-03 16:14:54,240 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host '127.0.0.1:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 16:14:54,240 - app.core.tenant.middleware - WARNING - [HOST_DETECTION] No se pudo extraer tenant real de origin/referer, usando cliente por defecto (SYSTEM)
2025-12-03 16:14:54,240 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: '127.0.0.1'
2025-12-03 16:14:54,240 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 16:14:54,240 - app.core.tenant.middleware - WARNING - [SUBDOMAIN] No se detectó subdominio válido en: '127.0.0.1'. Verifica BASE_DOMAIN='app.local'
2025-12-03 16:14:54,240 - app.core.tenant.middleware - WARNING - [TENANT] Sin subdominio en Host: 127.0.0.1:8000. Usando Cliente ID por defecto: 9b8ab97c-89d4-41dc-8bbf-54d193edbe02 (SYSTEM)
2025-12-03 16:14:54,240 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 16:14:54,241 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=9b8ab97c-89d4-41dc-8bbf-54d193edbe02, db_type=single, bd=bd_hybrid_sistema_central, path=/openapi.json
2025-12-03 16:14:54,454 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /openapi.json 200 215.2ms
2025-12-03 16:15:53,396 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/auth/refresh/
2025-12-03 16:15:53,396 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/auth/refresh/ 200 0.6ms
2025-12-03 16:15:53,398 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/refresh/
2025-12-03 16:15:53,398 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 16:15:53,398 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 16:15:53,399 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 16:15:53,399 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 16:15:53,399 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 16:15:53,400 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 16:15:53,400 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 16:15:53,400 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 16:15:53,400 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: 9b8ab97c-89d4-41dc-8bbf-54d193edbe02
2025-12-03 16:15:53,400 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 16:15:53,400 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=9b8ab97c-89d4-41dc-8bbf-54d193edbe02, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/auth/refresh/
2025-12-03 16:15:53,455 - app.infrastructure.database.queries_async - WARNING - [QUERY] DEPRECATED: execute_query() recibió string SQL. Migrar a SQLAlchemy Core.
2025-12-03 16:15:53,456 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] AsyncEngine creado para admin
2025-12-03 16:15:53,457 - app.modules.auth.application.services.refresh_token_service - ERROR - [VALIDATE-TOKEN] Error inesperado validando refresh token: the greenlet library is required to use this function. No module named 'greenlet._greenlet'
Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 130, in execute_query
    result = await session.execute(text(query))
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 449, in execute
    result = await greenlet_spawn(
                   ^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\concurrency.py", line 101, in greenlet_spawn
    _not_implemented()
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\concurrency.py", line 81, in _not_implemented
    raise ValueError(
ValueError: the greenlet library is required to use this function. No module named 'greenlet._greenlet'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\connection_async.py", line 303, in get_db_connection
    yield session
  File "D:\base_multi_tenant_fastapi\app\core\tenant\routing.py", line 672, in get_connection_for_tenant
    yield session
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 135, in execute_query
    await session.rollback()
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 990, in rollback
    await greenlet_spawn(self.sync_session.rollback)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\concurrency.py", line 101, in greenlet_spawn
    _not_implemented()
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\concurrency.py", line 81, in _not_implemented
    raise ValueError(
ValueError: the greenlet library is required to use this function. No module named 'greenlet._greenlet'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\modules\auth\application\services\refresh_token_service.py", line 213, in validate_refresh_token
    result = await execute_query(GET_REFRESH_TOKEN_BY_HASH, (token_hash, cliente_id))
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 128, in execute_query
    async with _get_connection_context(connection_type, client_id) as session:
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\contextlib.py", line 231, in __aexit__
    await self.gen.athrow(value)
  File "D:\base_multi_tenant_fastapi\app\core\tenant\routing.py", line 671, in get_connection_for_tenant
    async with get_db_connection(DatabaseConnection.ADMIN) as session:
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\contextlib.py", line 231, in __aexit__
    await self.gen.athrow(value)
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\connection_async.py", line 301, in get_db_connection
    async with async_session() as session:
               ^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 1071, in __aexit__
    await asyncio.shield(task)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 1016, in close
    await greenlet_spawn(self.sync_session.close)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\concurrency.py", line 101, in greenlet_spawn
    _not_implemented()
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\concurrency.py", line 81, in _not_implemented
    raise ValueError(
ValueError: the greenlet library is required to use this function. No module named 'greenlet._greenlet'
2025-12-03 16:15:53,484 - app.core.application.base_service - ERROR - DatabaseError en validate_refresh_token: Error al validar el refresh token
Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 130, in execute_query
    result = await session.execute(text(query))
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 449, in execute
    result = await greenlet_spawn(
                   ^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\concurrency.py", line 101, in greenlet_spawn
    _not_implemented()
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\concurrency.py", line 81, in _not_implemented
    raise ValueError(
ValueError: the greenlet library is required to use this function. No module named 'greenlet._greenlet'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\connection_async.py", line 303, in get_db_connection
    yield session
  File "D:\base_multi_tenant_fastapi\app\core\tenant\routing.py", line 672, in get_connection_for_tenant
    yield session
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 135, in execute_query
    await session.rollback()
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 990, in rollback
    await greenlet_spawn(self.sync_session.rollback)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\concurrency.py", line 101, in greenlet_spawn
    _not_implemented()
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\concurrency.py", line 81, in _not_implemented
    raise ValueError(
ValueError: the greenlet library is required to use this function. No module named 'greenlet._greenlet'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\modules\auth\application\services\refresh_token_service.py", line 213, in validate_refresh_token
    result = await execute_query(GET_REFRESH_TOKEN_BY_HASH, (token_hash, cliente_id))
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 128, in execute_query
    async with _get_connection_context(connection_type, client_id) as session:
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\contextlib.py", line 231, in __aexit__
    await self.gen.athrow(value)
  File "D:\base_multi_tenant_fastapi\app\core\tenant\routing.py", line 671, in get_connection_for_tenant
    async with get_db_connection(DatabaseConnection.ADMIN) as session:
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\contextlib.py", line 231, in __aexit__
    await self.gen.athrow(value)
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\connection_async.py", line 301, in get_db_connection
    async with async_session() as session:
               ^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 1071, in __aexit__
    await asyncio.shield(task)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 1016, in close
    await greenlet_spawn(self.sync_session.close)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\concurrency.py", line 101, in greenlet_spawn
    _not_implemented()
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\concurrency.py", line 81, in _not_implemented
    raise ValueError(
ValueError: the greenlet library is required to use this function. No module named 'greenlet._greenlet'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\core\application\base_service.py", line 52, in wrapper
    return await func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\modules\auth\application\services\refresh_token_service.py", line 233, in validate_refresh_token
    raise DatabaseError(
app.core.exceptions.DatabaseError: Error al validar el refresh token
2025-12-03 16:15:53,486 - app.modules.auth.application.services.auth_service - ERROR - Error validando refresh token: Error al validar el refresh token
Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 130, in execute_query
    result = await session.execute(text(query))
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 449, in execute
    result = await greenlet_spawn(
                   ^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\concurrency.py", line 101, in greenlet_spawn
    _not_implemented()
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\concurrency.py", line 81, in _not_implemented
    raise ValueError(
ValueError: the greenlet library is required to use this function. No module named 'greenlet._greenlet'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\connection_async.py", line 303, in get_db_connection
    yield session
  File "D:\base_multi_tenant_fastapi\app\core\tenant\routing.py", line 672, in get_connection_for_tenant
    yield session
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 135, in execute_query
    await session.rollback()
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 990, in rollback
    await greenlet_spawn(self.sync_session.rollback)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\concurrency.py", line 101, in greenlet_spawn
    _not_implemented()
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\concurrency.py", line 81, in _not_implemented
    raise ValueError(
ValueError: the greenlet library is required to use this function. No module named 'greenlet._greenlet'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\modules\auth\application\services\refresh_token_service.py", line 213, in validate_refresh_token
    result = await execute_query(GET_REFRESH_TOKEN_BY_HASH, (token_hash, cliente_id))
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 128, in execute_query
    async with _get_connection_context(connection_type, client_id) as session:
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\contextlib.py", line 231, in __aexit__
    await self.gen.athrow(value)
  File "D:\base_multi_tenant_fastapi\app\core\tenant\routing.py", line 671, in get_connection_for_tenant
    async with get_db_connection(DatabaseConnection.ADMIN) as session:
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\contextlib.py", line 231, in __aexit__
    await self.gen.athrow(value)
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\connection_async.py", line 301, in get_db_connection
    async with async_session() as session:
               ^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 1071, in __aexit__
    await asyncio.shield(task)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 1016, in close
    await greenlet_spawn(self.sync_session.close)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\concurrency.py", line 101, in greenlet_spawn
    _not_implemented()
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\concurrency.py", line 81, in _not_implemented
    raise ValueError(
ValueError: the greenlet library is required to use this function. No module named 'greenlet._greenlet'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\modules\auth\application\services\auth_service.py", line 448, in get_current_user_from_refresh
    db_token_data = await RefreshTokenService.validate_refresh_token(refresh_token)
                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\core\application\base_service.py", line 52, in wrapper
    return await func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\modules\auth\application\services\refresh_token_service.py", line 233, in validate_refresh_token
    raise DatabaseError(
app.core.exceptions.DatabaseError: Error al validar el refresh token
2025-12-03 16:15:53,490 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/refresh/ 401 91.5ms
2025-12-03 16:15:55,781 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/refresh/
2025-12-03 16:15:55,781 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 16:15:55,781 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 16:15:55,782 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 16:15:55,782 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 16:15:55,782 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 16:15:55,782 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 16:15:55,782 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 16:15:55,782 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 16:15:55,782 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: 9b8ab97c-89d4-41dc-8bbf-54d193edbe02
2025-12-03 16:15:55,783 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 16:15:55,783 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=9b8ab97c-89d4-41dc-8bbf-54d193edbe02, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/auth/refresh/
2025-12-03 16:15:55,785 - app.infrastructure.database.queries_async - WARNING - [QUERY] DEPRECATED: execute_query() recibió string SQL. Migrar a SQLAlchemy Core.
2025-12-03 16:15:55,785 - app.modules.auth.application.services.refresh_token_service - ERROR - [VALIDATE-TOKEN] Error inesperado validando refresh token: the greenlet library is required to use this function. No module named 'greenlet._greenlet'
Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 130, in execute_query
    result = await session.execute(text(query))
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 449, in execute
    result = await greenlet_spawn(
                   ^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\concurrency.py", line 101, in greenlet_spawn
    _not_implemented()
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\concurrency.py", line 81, in _not_implemented
    raise ValueError(
ValueError: the greenlet library is required to use this function. No module named 'greenlet._greenlet'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\connection_async.py", line 303, in get_db_connection
    yield session
  File "D:\base_multi_tenant_fastapi\app\core\tenant\routing.py", line 672, in get_connection_for_tenant
    yield session
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 135, in execute_query
    await session.rollback()
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 990, in rollback
    await greenlet_spawn(self.sync_session.rollback)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\concurrency.py", line 101, in greenlet_spawn
    _not_implemented()
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\concurrency.py", line 81, in _not_implemented
    raise ValueError(
ValueError: the greenlet library is required to use this function. No module named 'greenlet._greenlet'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\modules\auth\application\services\refresh_token_service.py", line 213, in validate_refresh_token
    result = await execute_query(GET_REFRESH_TOKEN_BY_HASH, (token_hash, cliente_id))
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 128, in execute_query
    async with _get_connection_context(connection_type, client_id) as session:
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\contextlib.py", line 231, in __aexit__
    await self.gen.athrow(value)
  File "D:\base_multi_tenant_fastapi\app\core\tenant\routing.py", line 671, in get_connection_for_tenant
    async with get_db_connection(DatabaseConnection.ADMIN) as session:
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\contextlib.py", line 231, in __aexit__
    await self.gen.athrow(value)
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\connection_async.py", line 301, in get_db_connection
    async with async_session() as session:
               ^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 1071, in __aexit__
    await asyncio.shield(task)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 1016, in close
    await greenlet_spawn(self.sync_session.close)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\concurrency.py", line 101, in greenlet_spawn
    _not_implemented()
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\concurrency.py", line 81, in _not_implemented
    raise ValueError(
ValueError: the greenlet library is required to use this function. No module named 'greenlet._greenlet'
2025-12-03 16:15:55,789 - app.core.application.base_service - ERROR - DatabaseError en validate_refresh_token: Error al validar el refresh token
Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 130, in execute_query
    result = await session.execute(text(query))
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 449, in execute
    result = await greenlet_spawn(
                   ^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\concurrency.py", line 101, in greenlet_spawn
    _not_implemented()
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\concurrency.py", line 81, in _not_implemented
    raise ValueError(
ValueError: the greenlet library is required to use this function. No module named 'greenlet._greenlet'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\connection_async.py", line 303, in get_db_connection
    yield session
  File "D:\base_multi_tenant_fastapi\app\core\tenant\routing.py", line 672, in get_connection_for_tenant
    yield session
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 135, in execute_query
    await session.rollback()
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 990, in rollback
    await greenlet_spawn(self.sync_session.rollback)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\concurrency.py", line 101, in greenlet_spawn
    _not_implemented()
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\concurrency.py", line 81, in _not_implemented
    raise ValueError(
ValueError: the greenlet library is required to use this function. No module named 'greenlet._greenlet'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\modules\auth\application\services\refresh_token_service.py", line 213, in validate_refresh_token
    result = await execute_query(GET_REFRESH_TOKEN_BY_HASH, (token_hash, cliente_id))
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 128, in execute_query
    async with _get_connection_context(connection_type, client_id) as session:
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\contextlib.py", line 231, in __aexit__
    await self.gen.athrow(value)
  File "D:\base_multi_tenant_fastapi\app\core\tenant\routing.py", line 671, in get_connection_for_tenant
    async with get_db_connection(DatabaseConnection.ADMIN) as session:
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\contextlib.py", line 231, in __aexit__
    await self.gen.athrow(value)
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\connection_async.py", line 301, in get_db_connection
    async with async_session() as session:
               ^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 1071, in __aexit__
    await asyncio.shield(task)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 1016, in close
    await greenlet_spawn(self.sync_session.close)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\concurrency.py", line 101, in greenlet_spawn
    _not_implemented()
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\concurrency.py", line 81, in _not_implemented
    raise ValueError(
ValueError: the greenlet library is required to use this function. No module named 'greenlet._greenlet'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\core\application\base_service.py", line 52, in wrapper
    return await func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\modules\auth\application\services\refresh_token_service.py", line 233, in validate_refresh_token
    raise DatabaseError(
app.core.exceptions.DatabaseError: Error al validar el refresh token
2025-12-03 16:15:55,791 - app.modules.auth.application.services.auth_service - ERROR - Error validando refresh token: Error al validar el refresh token
Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 130, in execute_query
    result = await session.execute(text(query))
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 449, in execute
    result = await greenlet_spawn(
                   ^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\concurrency.py", line 101, in greenlet_spawn
    _not_implemented()
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\concurrency.py", line 81, in _not_implemented
    raise ValueError(
ValueError: the greenlet library is required to use this function. No module named 'greenlet._greenlet'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\connection_async.py", line 303, in get_db_connection
    yield session
  File "D:\base_multi_tenant_fastapi\app\core\tenant\routing.py", line 672, in get_connection_for_tenant
    yield session
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 135, in execute_query
    await session.rollback()
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 990, in rollback
    await greenlet_spawn(self.sync_session.rollback)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\concurrency.py", line 101, in greenlet_spawn
    _not_implemented()
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\concurrency.py", line 81, in _not_implemented
    raise ValueError(
ValueError: the greenlet library is required to use this function. No module named 'greenlet._greenlet'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\modules\auth\application\services\refresh_token_service.py", line 213, in validate_refresh_token
    result = await execute_query(GET_REFRESH_TOKEN_BY_HASH, (token_hash, cliente_id))
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 128, in execute_query
    async with _get_connection_context(connection_type, client_id) as session:
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\contextlib.py", line 231, in __aexit__
    await self.gen.athrow(value)
  File "D:\base_multi_tenant_fastapi\app\core\tenant\routing.py", line 671, in get_connection_for_tenant
    async with get_db_connection(DatabaseConnection.ADMIN) as session:
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\contextlib.py", line 231, in __aexit__
    await self.gen.athrow(value)
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\connection_async.py", line 301, in get_db_connection
    async with async_session() as session:
               ^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 1071, in __aexit__
    await asyncio.shield(task)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 1016, in close
    await greenlet_spawn(self.sync_session.close)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\concurrency.py", line 101, in greenlet_spawn
    _not_implemented()
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\concurrency.py", line 81, in _not_implemented
    raise ValueError(
ValueError: the greenlet library is required to use this function. No module named 'greenlet._greenlet'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\modules\auth\application\services\auth_service.py", line 448, in get_current_user_from_refresh
    db_token_data = await RefreshTokenService.validate_refresh_token(refresh_token)
                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\core\application\base_service.py", line 52, in wrapper
    return await func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\modules\auth\application\services\refresh_token_service.py", line 233, in validate_refresh_token
    raise DatabaseError(
app.core.exceptions.DatabaseError: Error al validar el refresh token
2025-12-03 16:15:55,794 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/refresh/ 401 13.4ms
2025-12-03 16:16:29,880 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/auth/login/
2025-12-03 16:16:29,880 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/auth/login/ 200 0.5ms
2025-12-03 16:16:29,881 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/login/
2025-12-03 16:16:29,882 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 16:16:29,882 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 16:16:29,882 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 16:16:29,882 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 16:16:29,882 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 16:16:29,882 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 16:16:29,883 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 16:16:29,883 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 16:16:29,883 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: 9b8ab97c-89d4-41dc-8bbf-54d193edbe02
2025-12-03 16:16:29,883 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 16:16:29,883 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=9b8ab97c-89d4-41dc-8bbf-54d193edbe02, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/auth/login/
2025-12-03 16:16:29,885 - app.core.application.base_service - ERROR - ERROR INESPERADO en obtener_cliente_por_id: execute_query() got multiple values for argument 'connection_type'
Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\core\application\base_service.py", line 52, in wrapper
    return await func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\modules\tenant\application\services\cliente_service.py", line 186, in obtener_cliente_por_id
    resultado = await execute_query(query, (cliente_id,), connection_type=DatabaseConnection.ADMIN)
                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
TypeError: execute_query() got multiple values for argument 'connection_type'
2025-12-03 16:16:29,886 - app.modules.auth.presentation.endpoints - ERROR - Error inesperado en /login/ para usuario superadmin: Error interno del servidor en obtener_cliente_por_id
Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\core\application\base_service.py", line 52, in wrapper
    return await func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\modules\tenant\application\services\cliente_service.py", line 186, in obtener_cliente_por_id
    resultado = await execute_query(query, (cliente_id,), connection_type=DatabaseConnection.ADMIN)
                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
TypeError: execute_query() got multiple values for argument 'connection_type'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\modules\auth\presentation\endpoints.py", line 134, in login
    cliente = await ClienteService.obtener_cliente_por_id(cliente_id)
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\core\application\base_service.py", line 69, in wrapper
    raise ServiceError(
app.core.exceptions.ServiceError: Error interno del servidor en obtener_cliente_por_id
2025-12-03 16:16:29,887 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/login/ 500 5.8ms
2025-12-03 16:16:58,910 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/refresh/
2025-12-03 16:16:58,911 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 16:16:58,911 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 16:16:58,911 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 16:16:58,911 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 16:16:58,911 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 16:16:58,911 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 16:16:58,911 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 16:16:58,913 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 16:16:58,913 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: 9b8ab97c-89d4-41dc-8bbf-54d193edbe02
2025-12-03 16:16:58,913 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 16:16:58,913 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=9b8ab97c-89d4-41dc-8bbf-54d193edbe02, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/auth/refresh/
2025-12-03 16:16:58,915 - app.infrastructure.database.queries_async - WARNING - [QUERY] DEPRECATED: execute_query() recibió string SQL. Migrar a SQLAlchemy Core.
2025-12-03 16:16:58,915 - app.modules.auth.application.services.refresh_token_service - ERROR - [VALIDATE-TOKEN] Error inesperado validando refresh token: the greenlet library is required to use this function. No module named 'greenlet._greenlet'
Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 130, in execute_query
    result = await session.execute(text(query))
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 449, in execute
    result = await greenlet_spawn(
                   ^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\concurrency.py", line 101, in greenlet_spawn
    _not_implemented()
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\concurrency.py", line 81, in _not_implemented
    raise ValueError(
ValueError: the greenlet library is required to use this function. No module named 'greenlet._greenlet'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\connection_async.py", line 303, in get_db_connection
    yield session
  File "D:\base_multi_tenant_fastapi\app\core\tenant\routing.py", line 672, in get_connection_for_tenant
    yield session
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 135, in execute_query
    await session.rollback()
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 990, in rollback
    await greenlet_spawn(self.sync_session.rollback)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\concurrency.py", line 101, in greenlet_spawn
    _not_implemented()
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\concurrency.py", line 81, in _not_implemented
    raise ValueError(
ValueError: the greenlet library is required to use this function. No module named 'greenlet._greenlet'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\modules\auth\application\services\refresh_token_service.py", line 213, in validate_refresh_token
    result = await execute_query(GET_REFRESH_TOKEN_BY_HASH, (token_hash, cliente_id))
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 128, in execute_query
    async with _get_connection_context(connection_type, client_id) as session:
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\contextlib.py", line 231, in __aexit__
    await self.gen.athrow(value)
  File "D:\base_multi_tenant_fastapi\app\core\tenant\routing.py", line 671, in get_connection_for_tenant
    async with get_db_connection(DatabaseConnection.ADMIN) as session:
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\contextlib.py", line 231, in __aexit__
    await self.gen.athrow(value)
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\connection_async.py", line 301, in get_db_connection
    async with async_session() as session:
               ^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 1071, in __aexit__
    await asyncio.shield(task)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 1016, in close
    await greenlet_spawn(self.sync_session.close)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\concurrency.py", line 101, in greenlet_spawn
    _not_implemented()
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\concurrency.py", line 81, in _not_implemented
    raise ValueError(
ValueError: the greenlet library is required to use this function. No module named 'greenlet._greenlet'
2025-12-03 16:16:58,919 - app.core.application.base_service - ERROR - DatabaseError en validate_refresh_token: Error al validar el refresh token
Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 130, in execute_query
    result = await session.execute(text(query))
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 449, in execute
    result = await greenlet_spawn(
                   ^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\concurrency.py", line 101, in greenlet_spawn
    _not_implemented()
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\concurrency.py", line 81, in _not_implemented
    raise ValueError(
ValueError: the greenlet library is required to use this function. No module named 'greenlet._greenlet'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\connection_async.py", line 303, in get_db_connection
    yield session
  File "D:\base_multi_tenant_fastapi\app\core\tenant\routing.py", line 672, in get_connection_for_tenant
    yield session
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 135, in execute_query
    await session.rollback()
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 990, in rollback
    await greenlet_spawn(self.sync_session.rollback)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\concurrency.py", line 101, in greenlet_spawn
    _not_implemented()
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\concurrency.py", line 81, in _not_implemented
    raise ValueError(
ValueError: the greenlet library is required to use this function. No module named 'greenlet._greenlet'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\modules\auth\application\services\refresh_token_service.py", line 213, in validate_refresh_token
    result = await execute_query(GET_REFRESH_TOKEN_BY_HASH, (token_hash, cliente_id))
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 128, in execute_query
    async with _get_connection_context(connection_type, client_id) as session:
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\contextlib.py", line 231, in __aexit__
    await self.gen.athrow(value)
  File "D:\base_multi_tenant_fastapi\app\core\tenant\routing.py", line 671, in get_connection_for_tenant
    async with get_db_connection(DatabaseConnection.ADMIN) as session:
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\contextlib.py", line 231, in __aexit__
    await self.gen.athrow(value)
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\connection_async.py", line 301, in get_db_connection
    async with async_session() as session:
               ^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 1071, in __aexit__
    await asyncio.shield(task)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 1016, in close
    await greenlet_spawn(self.sync_session.close)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\concurrency.py", line 101, in greenlet_spawn
    _not_implemented()
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\concurrency.py", line 81, in _not_implemented
    raise ValueError(
ValueError: the greenlet library is required to use this function. No module named 'greenlet._greenlet'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\core\application\base_service.py", line 52, in wrapper
    return await func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\modules\auth\application\services\refresh_token_service.py", line 233, in validate_refresh_token
    raise DatabaseError(
app.core.exceptions.DatabaseError: Error al validar el refresh token
2025-12-03 16:16:58,923 - app.modules.auth.application.services.auth_service - ERROR - Error validando refresh token: Error al validar el refresh token
Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 130, in execute_query
    result = await session.execute(text(query))
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 449, in execute
    result = await greenlet_spawn(
                   ^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\concurrency.py", line 101, in greenlet_spawn
    _not_implemented()
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\concurrency.py", line 81, in _not_implemented
    raise ValueError(
ValueError: the greenlet library is required to use this function. No module named 'greenlet._greenlet'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\connection_async.py", line 303, in get_db_connection
    yield session
  File "D:\base_multi_tenant_fastapi\app\core\tenant\routing.py", line 672, in get_connection_for_tenant
    yield session
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 135, in execute_query
    await session.rollback()
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 990, in rollback
    await greenlet_spawn(self.sync_session.rollback)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\concurrency.py", line 101, in greenlet_spawn
    _not_implemented()
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\concurrency.py", line 81, in _not_implemented
    raise ValueError(
ValueError: the greenlet library is required to use this function. No module named 'greenlet._greenlet'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\modules\auth\application\services\refresh_token_service.py", line 213, in validate_refresh_token
    result = await execute_query(GET_REFRESH_TOKEN_BY_HASH, (token_hash, cliente_id))
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 128, in execute_query
    async with _get_connection_context(connection_type, client_id) as session:
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\contextlib.py", line 231, in __aexit__
    await self.gen.athrow(value)
  File "D:\base_multi_tenant_fastapi\app\core\tenant\routing.py", line 671, in get_connection_for_tenant
    async with get_db_connection(DatabaseConnection.ADMIN) as session:
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\contextlib.py", line 231, in __aexit__
    await self.gen.athrow(value)
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\connection_async.py", line 301, in get_db_connection
    async with async_session() as session:
               ^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 1071, in __aexit__
    await asyncio.shield(task)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 1016, in close
    await greenlet_spawn(self.sync_session.close)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\concurrency.py", line 101, in greenlet_spawn
    _not_implemented()
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\concurrency.py", line 81, in _not_implemented
    raise ValueError(
ValueError: the greenlet library is required to use this function. No module named 'greenlet._greenlet'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\modules\auth\application\services\auth_service.py", line 448, in get_current_user_from_refresh
    db_token_data = await RefreshTokenService.validate_refresh_token(refresh_token)
                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\core\application\base_service.py", line 52, in wrapper
    return await func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\modules\auth\application\services\refresh_token_service.py", line 233, in validate_refresh_token
    raise DatabaseError(
app.core.exceptions.DatabaseError: Error al validar el refresh token
2025-12-03 16:16:58,926 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/refresh/ 401 15.0ms
2025-12-03 16:20:07,681 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Pool ADMIN inicializado. Size=10, MaxOverflow=5
2025-12-03 16:20:07,681 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Configuración de pools de tenants: MaxPools=50, PoolSize=3, MaxOverflow=2, InactivityTimeout=3600s
2025-12-03 16:20:07,681 - app.infrastructure.database.connection_pool - INFO - ✅ Módulo de connection pooling cargado y activo
2025-12-03 16:20:07,681 - app.infrastructure.database.connection_pool - INFO -    Configuración: MaxTenantPools=50, TenantPoolSize=3, InactivityTimeout=3600s
2025-12-03 16:20:07,683 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Todos los pools cerrados
2025-12-03 16:20:07,683 - app.main - INFO - ✅ Pools de conexión cerrados correctamente
2025-12-03 16:20:08,466 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 16:20:08,663 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 16:20:08,665 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 16:20:08,671 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 16:20:08,671 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 16:20:08,671 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 16:20:08,671 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 16:20:08,671 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=9b8ab97c-89d4-41dc-8bbf-54d193edbe02, DEFAULT_TYPE=single
2025-12-03 16:20:08,997 - app.core.security.rate_limiting - INFO - [RATE_LIMITING] Activado. Límites: Login=10/minute, API=200/minute
2025-12-03 16:20:08,997 - app.core.security.rate_limiting - INFO - ✅ Módulo de rate limiting cargado y activo
2025-12-03 16:20:09,073 - app.core.authorization.rbac - INFO - 🔐 Inicializando sistema de autorización...
2025-12-03 16:20:09,073 - app.core.authorization.rbac - INFO - ✅ Sistema de autorización inicializado correctamente
2025-12-03 16:20:09,073 - app.core.authorization.rbac - INFO - 📊 Permisos del sistema: 6 módulos configurados
2025-12-03 16:20:09,229 - app.core.tenant.middleware - INFO - Módulo tenant_middleware cargado (versión híbrida con soporte para proxies)
2025-12-03 16:20:09,229 - app.main - INFO - ✅ Rate limiting configurado y activo
2025-12-03 16:20:09,376 - app.core.tenant.middleware - INFO - [TENANT_MW] Inicializado - BASE_DOMAIN=app.local, SYSTEM_ID=9B8AB97C-89D4-41DC-8BBF-54D193EDBE02, EXCLUDED_SUBDOMAINS={'backend', 'admin', 'assets', 'cdn', 'www', 'api', 'static'}
2025-12-03 16:20:20,723 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/login/
2025-12-03 16:20:20,723 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host '127.0.0.1:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 16:20:20,723 - app.core.tenant.middleware - WARNING - [HOST_DETECTION] No se pudo extraer tenant real de origin/referer, usando cliente por defecto (SYSTEM)
2025-12-03 16:20:20,724 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: '127.0.0.1'
2025-12-03 16:20:20,724 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 16:20:20,724 - app.core.tenant.middleware - WARNING - [SUBDOMAIN] No se detectó subdominio válido en: '127.0.0.1'. Verifica BASE_DOMAIN='app.local'
2025-12-03 16:20:20,724 - app.core.tenant.middleware - WARNING - [TENANT] Sin subdominio en Host: 127.0.0.1:8000. Usando Cliente ID por defecto: 9b8ab97c-89d4-41dc-8bbf-54d193edbe02 (SYSTEM)
2025-12-03 16:20:20,724 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 16:20:20,724 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=9b8ab97c-89d4-41dc-8bbf-54d193edbe02, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/auth/login/
2025-12-03 16:20:20,729 - app.core.application.base_service - ERROR - ERROR INESPERADO en obtener_cliente_por_id: execute_query() got multiple values for argument 'connection_type'
Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\core\application\base_service.py", line 52, in wrapper
    return await func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\modules\tenant\application\services\cliente_service.py", line 186, in obtener_cliente_por_id
    resultado = await execute_query(query, (cliente_id,), connection_type=DatabaseConnection.ADMIN)
                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
TypeError: execute_query() got multiple values for argument 'connection_type'
2025-12-03 16:20:20,729 - app.modules.auth.presentation.endpoints - ERROR - Error inesperado en /login/ para usuario superadmin: Error interno del servidor en obtener_cliente_por_id
Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\core\application\base_service.py", line 52, in wrapper
    return await func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\modules\tenant\application\services\cliente_service.py", line 186, in obtener_cliente_por_id
    resultado = await execute_query(query, (cliente_id,), connection_type=DatabaseConnection.ADMIN)
                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
TypeError: execute_query() got multiple values for argument 'connection_type'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\modules\auth\presentation\endpoints.py", line 134, in login
    cliente = await ClienteService.obtener_cliente_por_id(cliente_id)
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\core\application\base_service.py", line 69, in wrapper
    raise ServiceError(
app.core.exceptions.ServiceError: Error interno del servidor en obtener_cliente_por_id
2025-12-03 16:20:20,732 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/login/ 500 9.4ms
2025-12-03 16:20:20,792 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Pool ADMIN inicializado. Size=10, MaxOverflow=5
2025-12-03 16:20:20,793 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Configuración de pools de tenants: MaxPools=50, PoolSize=3, MaxOverflow=2, InactivityTimeout=3600s
2025-12-03 16:20:20,793 - app.infrastructure.database.connection_pool - INFO - ✅ Módulo de connection pooling cargado y activo
2025-12-03 16:20:20,793 - app.infrastructure.database.connection_pool - INFO -    Configuración: MaxTenantPools=50, TenantPoolSize=3, InactivityTimeout=3600s
2025-12-03 16:20:20,793 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Todos los pools cerrados
2025-12-03 16:20:20,793 - app.main - INFO - ✅ Pools de conexión cerrados correctamente
2025-12-03 16:20:21,843 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 16:20:22,069 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 16:20:22,075 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 16:20:22,077 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 16:20:22,078 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 16:20:22,078 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 16:20:22,078 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 16:20:22,079 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=9b8ab97c-89d4-41dc-8bbf-54d193edbe02, DEFAULT_TYPE=single
2025-12-03 16:20:22,487 - app.core.security.rate_limiting - INFO - [RATE_LIMITING] Activado. Límites: Login=10/minute, API=200/minute
2025-12-03 16:20:22,487 - app.core.security.rate_limiting - INFO - ✅ Módulo de rate limiting cargado y activo
2025-12-03 16:20:22,593 - app.core.authorization.rbac - INFO - 🔐 Inicializando sistema de autorización...
2025-12-03 16:20:22,593 - app.core.authorization.rbac - INFO - ✅ Sistema de autorización inicializado correctamente
2025-12-03 16:20:22,593 - app.core.authorization.rbac - INFO - 📊 Permisos del sistema: 6 módulos configurados
2025-12-03 16:20:22,806 - app.core.tenant.middleware - INFO - Módulo tenant_middleware cargado (versión híbrida con soporte para proxies)
2025-12-03 16:20:22,807 - app.main - INFO - ✅ Rate limiting configurado y activo
2025-12-03 16:20:22,966 - app.core.tenant.middleware - INFO - [TENANT_MW] Inicializado - BASE_DOMAIN=app.local, SYSTEM_ID=9B8AB97C-89D4-41DC-8BBF-54D193EDBE02, EXCLUDED_SUBDOMAINS={'api', 'assets', 'www', 'cdn', 'static', 'admin', 'backend'}
2025-12-03 16:20:29,130 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /docs
2025-12-03 16:20:29,131 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host '127.0.0.1:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 16:20:29,131 - app.core.tenant.middleware - WARNING - [HOST_DETECTION] No se pudo extraer tenant real de origin/referer, usando cliente por defecto (SYSTEM)
2025-12-03 16:20:29,131 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: '127.0.0.1'
2025-12-03 16:20:29,131 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 16:20:29,131 - app.core.tenant.middleware - WARNING - [SUBDOMAIN] No se detectó subdominio válido en: '127.0.0.1'. Verifica BASE_DOMAIN='app.local'
2025-12-03 16:20:29,132 - app.core.tenant.middleware - WARNING - [TENANT] Sin subdominio en Host: 127.0.0.1:8000. Usando Cliente ID por defecto: 9b8ab97c-89d4-41dc-8bbf-54d193edbe02 (SYSTEM)
2025-12-03 16:20:29,132 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 16:20:29,132 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=9b8ab97c-89d4-41dc-8bbf-54d193edbe02, db_type=single, bd=bd_hybrid_sistema_central, path=/docs
2025-12-03 16:20:29,132 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /docs 200 2.4ms
2025-12-03 16:20:29,213 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /openapi.json
2025-12-03 16:20:29,214 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host '127.0.0.1:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 16:20:29,214 - app.core.tenant.middleware - WARNING - [HOST_DETECTION] No se pudo extraer tenant real de origin/referer, usando cliente por defecto (SYSTEM)
2025-12-03 16:20:29,214 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: '127.0.0.1'
2025-12-03 16:20:29,214 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 16:20:29,214 - app.core.tenant.middleware - WARNING - [SUBDOMAIN] No se detectó subdominio válido en: '127.0.0.1'. Verifica BASE_DOMAIN='app.local'
2025-12-03 16:20:29,215 - app.core.tenant.middleware - WARNING - [TENANT] Sin subdominio en Host: 127.0.0.1:8000. Usando Cliente ID por defecto: 9b8ab97c-89d4-41dc-8bbf-54d193edbe02 (SYSTEM)
2025-12-03 16:20:29,215 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 16:20:29,215 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=9b8ab97c-89d4-41dc-8bbf-54d193edbe02, db_type=single, bd=bd_hybrid_sistema_central, path=/openapi.json
2025-12-03 16:20:29,432 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /openapi.json 200 219.6ms
2025-12-03 16:20:50,037 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/login/
2025-12-03 16:20:50,038 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 16:20:50,038 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 16:20:50,038 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 16:20:50,038 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 16:20:50,039 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 16:20:50,039 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 16:20:50,039 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 16:20:50,039 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 16:20:50,039 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: 9b8ab97c-89d4-41dc-8bbf-54d193edbe02
2025-12-03 16:20:50,040 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 16:20:50,040 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=9b8ab97c-89d4-41dc-8bbf-54d193edbe02, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/auth/login/
2025-12-03 16:20:50,042 - app.core.application.base_service - ERROR - ERROR INESPERADO en obtener_cliente_por_id: execute_query() got multiple values for argument 'connection_type'
Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\core\application\base_service.py", line 52, in wrapper
    return await func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\modules\tenant\application\services\cliente_service.py", line 186, in obtener_cliente_por_id
    resultado = await execute_query(query, (cliente_id,), connection_type=DatabaseConnection.ADMIN)
                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
TypeError: execute_query() got multiple values for argument 'connection_type'
2025-12-03 16:20:50,042 - app.modules.auth.presentation.endpoints - ERROR - Error inesperado en /login/ para usuario superadmin: Error interno del servidor en obtener_cliente_por_id
Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\core\application\base_service.py", line 52, in wrapper
    return await func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\modules\tenant\application\services\cliente_service.py", line 186, in obtener_cliente_por_id
    resultado = await execute_query(query, (cliente_id,), connection_type=DatabaseConnection.ADMIN)
                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
TypeError: execute_query() got multiple values for argument 'connection_type'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\modules\auth\presentation\endpoints.py", line 134, in login
    cliente = await ClienteService.obtener_cliente_por_id(cliente_id)
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\core\application\base_service.py", line 69, in wrapper
    raise ServiceError(
app.core.exceptions.ServiceError: Error interno del servidor en obtener_cliente_por_id
2025-12-03 16:20:50,043 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/login/ 500 6.1ms
2025-12-03 16:24:22,405 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Pool ADMIN inicializado. Size=10, MaxOverflow=5
2025-12-03 16:24:22,405 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Configuración de pools de tenants: MaxPools=50, PoolSize=3, MaxOverflow=2, InactivityTimeout=3600s
2025-12-03 16:24:22,405 - app.infrastructure.database.connection_pool - INFO - ✅ Módulo de connection pooling cargado y activo
2025-12-03 16:24:22,405 - app.infrastructure.database.connection_pool - INFO -    Configuración: MaxTenantPools=50, TenantPoolSize=3, InactivityTimeout=3600s
2025-12-03 16:24:22,406 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Todos los pools cerrados
2025-12-03 16:24:22,406 - app.main - INFO - ✅ Pools de conexión cerrados correctamente
2025-12-03 16:24:23,289 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 16:24:23,491 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 16:24:23,497 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 16:24:23,499 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 16:24:23,499 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 16:24:23,500 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 16:24:23,500 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 16:24:23,500 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=9b8ab97c-89d4-41dc-8bbf-54d193edbe02, DEFAULT_TYPE=single
2025-12-03 16:24:23,525 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 16:24:23,752 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 16:24:23,758 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 16:24:23,761 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 16:24:23,762 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 16:24:23,762 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 16:24:23,763 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 16:24:23,763 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=9b8ab97c-89d4-41dc-8bbf-54d193edbe02, DEFAULT_TYPE=single
2025-12-03 16:24:23,763 - app.core.security.rate_limiting - INFO - [RATE_LIMITING] Activado. Límites: Login=10/minute, API=200/minute
2025-12-03 16:24:23,763 - app.core.security.rate_limiting - INFO - ✅ Módulo de rate limiting cargado y activo
2025-12-03 16:24:23,865 - app.core.authorization.rbac - INFO - 🔐 Inicializando sistema de autorización...
2025-12-03 16:24:23,865 - app.core.authorization.rbac - INFO - ✅ Sistema de autorización inicializado correctamente
2025-12-03 16:24:23,865 - app.core.authorization.rbac - INFO - 📊 Permisos del sistema: 6 módulos configurados
2025-12-03 16:24:24,028 - app.core.tenant.middleware - INFO - Módulo tenant_middleware cargado (versión híbrida con soporte para proxies)
2025-12-03 16:24:24,029 - app.main - INFO - ✅ Rate limiting configurado y activo
2025-12-03 16:24:24,233 - app.core.security.rate_limiting - INFO - [RATE_LIMITING] Activado. Límites: Login=10/minute, API=200/minute
2025-12-03 16:24:24,234 - app.core.security.rate_limiting - INFO - ✅ Módulo de rate limiting cargado y activo
2025-12-03 16:24:24,345 - app.core.authorization.rbac - INFO - 🔐 Inicializando sistema de autorización...
2025-12-03 16:24:24,347 - app.core.authorization.rbac - INFO - ✅ Sistema de autorización inicializado correctamente
2025-12-03 16:24:24,347 - app.core.authorization.rbac - INFO - 📊 Permisos del sistema: 6 módulos configurados
2025-12-03 16:24:24,597 - app.core.tenant.middleware - INFO - Módulo tenant_middleware cargado (versión híbrida con soporte para proxies)
2025-12-03 16:24:24,597 - app.main - INFO - ✅ Rate limiting configurado y activo
2025-12-03 16:24:24,763 - app.core.tenant.middleware - INFO - [TENANT_MW] Inicializado - BASE_DOMAIN=app.local, SYSTEM_ID=9B8AB97C-89D4-41DC-8BBF-54D193EDBE02, EXCLUDED_SUBDOMAINS={'www', 'backend', 'assets', 'api', 'admin', 'cdn', 'static'}
2025-12-03 16:25:05,718 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 16:25:05,915 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 16:25:05,919 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 16:25:05,922 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 16:25:05,922 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 16:25:05,922 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 16:25:05,922 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 16:25:05,922 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=9b8ab97c-89d4-41dc-8bbf-54d193edbe02, DEFAULT_TYPE=single
2025-12-03 16:25:06,167 - app.core.security.rate_limiting - INFO - [RATE_LIMITING] Activado. Límites: Login=10/minute, API=200/minute
2025-12-03 16:25:06,167 - app.core.security.rate_limiting - INFO - ✅ Módulo de rate limiting cargado y activo
2025-12-03 16:25:06,266 - app.core.authorization.rbac - INFO - 🔐 Inicializando sistema de autorización...
2025-12-03 16:25:06,266 - app.core.authorization.rbac - INFO - ✅ Sistema de autorización inicializado correctamente
2025-12-03 16:25:06,266 - app.core.authorization.rbac - INFO - 📊 Permisos del sistema: 6 módulos configurados
2025-12-03 16:25:06,419 - app.core.tenant.middleware - INFO - Módulo tenant_middleware cargado (versión híbrida con soporte para proxies)
2025-12-03 16:25:06,419 - app.main - INFO - ✅ Rate limiting configurado y activo
2025-12-03 16:25:21,188 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Pool ADMIN inicializado. Size=10, MaxOverflow=5
2025-12-03 16:25:21,188 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Configuración de pools de tenants: MaxPools=50, PoolSize=3, MaxOverflow=2, InactivityTimeout=3600s
2025-12-03 16:25:21,188 - app.infrastructure.database.connection_pool - INFO - ✅ Módulo de connection pooling cargado y activo
2025-12-03 16:25:21,188 - app.infrastructure.database.connection_pool - INFO -    Configuración: MaxTenantPools=50, TenantPoolSize=3, InactivityTimeout=3600s
2025-12-03 16:25:21,188 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Todos los pools cerrados
2025-12-03 16:25:21,188 - app.main - INFO - ✅ Pools de conexión cerrados correctamente
2025-12-03 16:25:21,302 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Pool ADMIN inicializado. Size=10, MaxOverflow=5
2025-12-03 16:25:21,302 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Configuración de pools de tenants: MaxPools=50, PoolSize=3, MaxOverflow=2, InactivityTimeout=3600s
2025-12-03 16:25:21,302 - app.infrastructure.database.connection_pool - INFO - ✅ Módulo de connection pooling cargado y activo
2025-12-03 16:25:21,302 - app.infrastructure.database.connection_pool - INFO -    Configuración: MaxTenantPools=50, TenantPoolSize=3, InactivityTimeout=3600s
2025-12-03 16:25:21,303 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Todos los pools cerrados
2025-12-03 16:25:21,303 - app.main - INFO - ✅ Pools de conexión cerrados correctamente
2025-12-03 16:25:22,071 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 16:25:22,271 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 16:25:22,278 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 16:25:22,280 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 16:25:22,280 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 16:25:22,281 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 16:25:22,281 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 16:25:22,282 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=9b8ab97c-89d4-41dc-8bbf-54d193edbe02, DEFAULT_TYPE=single
2025-12-03 16:25:22,363 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 16:25:22,627 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 16:25:22,628 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 16:25:22,636 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 16:25:22,636 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 16:25:22,638 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 16:25:22,638 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 16:25:22,639 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=9b8ab97c-89d4-41dc-8bbf-54d193edbe02, DEFAULT_TYPE=single
2025-12-03 16:25:22,664 - app.core.security.rate_limiting - INFO - [RATE_LIMITING] Activado. Límites: Login=10/minute, API=200/minute
2025-12-03 16:25:22,664 - app.core.security.rate_limiting - INFO - ✅ Módulo de rate limiting cargado y activo
2025-12-03 16:25:22,741 - app.core.authorization.rbac - INFO - 🔐 Inicializando sistema de autorización...
2025-12-03 16:25:22,741 - app.core.authorization.rbac - INFO - ✅ Sistema de autorización inicializado correctamente
2025-12-03 16:25:22,741 - app.core.authorization.rbac - INFO - 📊 Permisos del sistema: 6 módulos configurados
2025-12-03 16:25:22,922 - app.core.tenant.middleware - INFO - Módulo tenant_middleware cargado (versión híbrida con soporte para proxies)
2025-12-03 16:25:22,922 - app.main - INFO - ✅ Rate limiting configurado y activo
2025-12-03 16:25:23,098 - app.core.tenant.middleware - INFO - [TENANT_MW] Inicializado - BASE_DOMAIN=app.local, SYSTEM_ID=9B8AB97C-89D4-41DC-8BBF-54D193EDBE02, EXCLUDED_SUBDOMAINS={'assets', 'admin', 'www', 'api', 'cdn', 'static', 'backend'}
2025-12-03 16:25:23,106 - app.core.security.rate_limiting - INFO - [RATE_LIMITING] Activado. Límites: Login=10/minute, API=200/minute
2025-12-03 16:25:23,106 - app.core.security.rate_limiting - INFO - ✅ Módulo de rate limiting cargado y activo
2025-12-03 16:25:23,218 - app.core.authorization.rbac - INFO - 🔐 Inicializando sistema de autorización...
2025-12-03 16:25:23,218 - app.core.authorization.rbac - INFO - ✅ Sistema de autorización inicializado correctamente
2025-12-03 16:25:23,218 - app.core.authorization.rbac - INFO - 📊 Permisos del sistema: 6 módulos configurados
2025-12-03 16:25:23,482 - app.core.tenant.middleware - INFO - Módulo tenant_middleware cargado (versión híbrida con soporte para proxies)
2025-12-03 16:25:23,482 - app.main - INFO - ✅ Rate limiting configurado y activo
2025-12-03 16:25:23,661 - app.core.tenant.middleware - INFO - [TENANT_MW] Inicializado - BASE_DOMAIN=app.local, SYSTEM_ID=9B8AB97C-89D4-41DC-8BBF-54D193EDBE02, EXCLUDED_SUBDOMAINS={'static', 'backend', 'admin', 'www', 'cdn', 'assets', 'api'}
2025-12-03 16:28:07,371 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 16:28:07,576 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 16:28:07,581 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 16:28:07,582 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 16:28:07,582 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 16:28:07,583 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 16:28:07,583 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 16:28:07,583 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=9b8ab97c-89d4-41dc-8bbf-54d193edbe02, DEFAULT_TYPE=single
2025-12-03 16:28:24,923 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 16:28:25,124 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 16:28:25,129 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 16:28:25,131 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 16:28:25,131 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 16:28:25,132 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 16:28:25,132 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 16:28:25,132 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=9b8ab97c-89d4-41dc-8bbf-54d193edbe02, DEFAULT_TYPE=single
2025-12-03 16:28:38,031 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 16:28:38,223 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 16:28:38,228 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 16:28:38,229 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 16:28:38,229 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 16:28:38,230 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 16:28:38,230 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 16:28:38,230 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=9b8ab97c-89d4-41dc-8bbf-54d193edbe02, DEFAULT_TYPE=single
2025-12-03 16:28:38,494 - app.core.security.rate_limiting - INFO - [RATE_LIMITING] Activado. Límites: Login=10/minute, API=200/minute
2025-12-03 16:28:38,494 - app.core.security.rate_limiting - INFO - ✅ Módulo de rate limiting cargado y activo
2025-12-03 16:28:38,591 - app.core.authorization.rbac - INFO - 🔐 Inicializando sistema de autorización...
2025-12-03 16:28:38,591 - app.core.authorization.rbac - INFO - ✅ Sistema de autorización inicializado correctamente
2025-12-03 16:28:38,591 - app.core.authorization.rbac - INFO - 📊 Permisos del sistema: 6 módulos configurados
2025-12-03 16:28:38,746 - app.core.tenant.middleware - INFO - Módulo tenant_middleware cargado (versión híbrida con soporte para proxies)
2025-12-03 16:28:38,747 - app.main - INFO - ✅ Rate limiting configurado y activo
2025-12-03 16:29:07,451 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Pool ADMIN inicializado. Size=10, MaxOverflow=5
2025-12-03 16:29:07,452 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Configuración de pools de tenants: MaxPools=50, PoolSize=3, MaxOverflow=2, InactivityTimeout=3600s
2025-12-03 16:29:07,452 - app.infrastructure.database.connection_pool - INFO - ✅ Módulo de connection pooling cargado y activo
2025-12-03 16:29:07,452 - app.infrastructure.database.connection_pool - INFO -    Configuración: MaxTenantPools=50, TenantPoolSize=3, InactivityTimeout=3600s
2025-12-03 16:29:07,453 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Todos los pools cerrados
2025-12-03 16:29:07,453 - app.main - INFO - ✅ Pools de conexión cerrados correctamente
2025-12-03 16:29:08,242 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 16:29:08,447 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 16:29:08,454 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 16:29:08,457 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 16:29:08,458 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 16:29:08,459 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 16:29:08,459 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 16:29:08,459 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=9b8ab97c-89d4-41dc-8bbf-54d193edbe02, DEFAULT_TYPE=single
2025-12-03 16:29:08,784 - app.core.security.rate_limiting - INFO - [RATE_LIMITING] Activado. Límites: Login=10/minute, API=200/minute
2025-12-03 16:29:08,784 - app.core.security.rate_limiting - INFO - ✅ Módulo de rate limiting cargado y activo
2025-12-03 16:29:08,858 - app.core.authorization.rbac - INFO - 🔐 Inicializando sistema de autorización...
2025-12-03 16:29:08,858 - app.core.authorization.rbac - INFO - ✅ Sistema de autorización inicializado correctamente
2025-12-03 16:29:08,858 - app.core.authorization.rbac - INFO - 📊 Permisos del sistema: 6 módulos configurados
2025-12-03 16:29:09,015 - app.core.tenant.middleware - INFO - Módulo tenant_middleware cargado (versión híbrida con soporte para proxies)
2025-12-03 16:29:09,015 - app.main - INFO - ✅ Rate limiting configurado y activo
2025-12-03 16:29:09,162 - app.core.tenant.middleware - INFO - [TENANT_MW] Inicializado - BASE_DOMAIN=app.local, SYSTEM_ID=9B8AB97C-89D4-41DC-8BBF-54D193EDBE02, EXCLUDED_SUBDOMAINS={'api', 'admin', 'assets', 'static', 'backend', 'cdn', 'www'}
2025-12-03 16:29:17,310 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/auth/refresh/
2025-12-03 16:29:17,310 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/auth/refresh/ 200 0.9ms
2025-12-03 16:29:17,313 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/refresh/
2025-12-03 16:29:17,313 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 16:29:17,314 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 16:29:17,314 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 16:29:17,314 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 16:29:17,314 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 16:29:17,314 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 16:29:17,315 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 16:29:17,315 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 16:29:17,316 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: 9b8ab97c-89d4-41dc-8bbf-54d193edbe02
2025-12-03 16:29:17,316 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 16:29:17,316 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=9b8ab97c-89d4-41dc-8bbf-54d193edbe02, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/auth/refresh/
2025-12-03 16:29:17,321 - app.infrastructure.database.queries_async - WARNING - [QUERY] DEPRECATED: execute_query() recibió string SQL. Migrar a SQLAlchemy Core.
2025-12-03 16:29:17,323 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] AsyncEngine creado para admin
2025-12-03 16:29:17,323 - app.modules.auth.application.services.refresh_token_service - ERROR - [VALIDATE-TOKEN] Error inesperado validando refresh token: the greenlet library is required to use this function. No module named 'greenlet._greenlet'
Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 130, in execute_query
    result = await session.execute(text(query))
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 449, in execute
    result = await greenlet_spawn(
                   ^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\concurrency.py", line 101, in greenlet_spawn
    _not_implemented()
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\concurrency.py", line 81, in _not_implemented
    raise ValueError(
ValueError: the greenlet library is required to use this function. No module named 'greenlet._greenlet'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\connection_async.py", line 303, in get_db_connection
    yield session
  File "D:\base_multi_tenant_fastapi\app\core\tenant\routing.py", line 672, in get_connection_for_tenant
    yield session
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 135, in execute_query
    await session.rollback()
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 990, in rollback
    await greenlet_spawn(self.sync_session.rollback)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\concurrency.py", line 101, in greenlet_spawn
    _not_implemented()
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\concurrency.py", line 81, in _not_implemented
    raise ValueError(
ValueError: the greenlet library is required to use this function. No module named 'greenlet._greenlet'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\modules\auth\application\services\refresh_token_service.py", line 213, in validate_refresh_token
    result = await execute_query(GET_REFRESH_TOKEN_BY_HASH, (token_hash, cliente_id))
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 128, in execute_query
    async with _get_connection_context(connection_type, client_id) as session:
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\contextlib.py", line 231, in __aexit__
    await self.gen.athrow(value)
  File "D:\base_multi_tenant_fastapi\app\core\tenant\routing.py", line 671, in get_connection_for_tenant
    async with get_db_connection(DatabaseConnection.ADMIN) as session:
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\contextlib.py", line 231, in __aexit__
    await self.gen.athrow(value)
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\connection_async.py", line 301, in get_db_connection
    async with async_session() as session:
               ^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 1071, in __aexit__
    await asyncio.shield(task)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 1016, in close
    await greenlet_spawn(self.sync_session.close)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\concurrency.py", line 101, in greenlet_spawn
    _not_implemented()
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\concurrency.py", line 81, in _not_implemented
    raise ValueError(
ValueError: the greenlet library is required to use this function. No module named 'greenlet._greenlet'
2025-12-03 16:29:17,326 - app.core.application.base_service - ERROR - DatabaseError en validate_refresh_token: Error al validar el refresh token
Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 130, in execute_query
    result = await session.execute(text(query))
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 449, in execute
    result = await greenlet_spawn(
                   ^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\concurrency.py", line 101, in greenlet_spawn
    _not_implemented()
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\concurrency.py", line 81, in _not_implemented
    raise ValueError(
ValueError: the greenlet library is required to use this function. No module named 'greenlet._greenlet'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\connection_async.py", line 303, in get_db_connection
    yield session
  File "D:\base_multi_tenant_fastapi\app\core\tenant\routing.py", line 672, in get_connection_for_tenant
    yield session
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 135, in execute_query
    await session.rollback()
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 990, in rollback
    await greenlet_spawn(self.sync_session.rollback)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\concurrency.py", line 101, in greenlet_spawn
    _not_implemented()
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\concurrency.py", line 81, in _not_implemented
    raise ValueError(
ValueError: the greenlet library is required to use this function. No module named 'greenlet._greenlet'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\modules\auth\application\services\refresh_token_service.py", line 213, in validate_refresh_token
    result = await execute_query(GET_REFRESH_TOKEN_BY_HASH, (token_hash, cliente_id))
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 128, in execute_query
    async with _get_connection_context(connection_type, client_id) as session:
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\contextlib.py", line 231, in __aexit__
    await self.gen.athrow(value)
  File "D:\base_multi_tenant_fastapi\app\core\tenant\routing.py", line 671, in get_connection_for_tenant
    async with get_db_connection(DatabaseConnection.ADMIN) as session:
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\contextlib.py", line 231, in __aexit__
    await self.gen.athrow(value)
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\connection_async.py", line 301, in get_db_connection
    async with async_session() as session:
               ^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 1071, in __aexit__
    await asyncio.shield(task)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 1016, in close
    await greenlet_spawn(self.sync_session.close)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\concurrency.py", line 101, in greenlet_spawn
    _not_implemented()
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\concurrency.py", line 81, in _not_implemented
    raise ValueError(
ValueError: the greenlet library is required to use this function. No module named 'greenlet._greenlet'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\core\application\base_service.py", line 52, in wrapper
    return await func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\modules\auth\application\services\refresh_token_service.py", line 233, in validate_refresh_token
    raise DatabaseError(
app.core.exceptions.DatabaseError: Error al validar el refresh token
2025-12-03 16:29:17,330 - app.modules.auth.application.services.auth_service - ERROR - Error validando refresh token: Error al validar el refresh token
Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 130, in execute_query
    result = await session.execute(text(query))
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 449, in execute
    result = await greenlet_spawn(
                   ^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\concurrency.py", line 101, in greenlet_spawn
    _not_implemented()
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\concurrency.py", line 81, in _not_implemented
    raise ValueError(
ValueError: the greenlet library is required to use this function. No module named 'greenlet._greenlet'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\connection_async.py", line 303, in get_db_connection
    yield session
  File "D:\base_multi_tenant_fastapi\app\core\tenant\routing.py", line 672, in get_connection_for_tenant
    yield session
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 135, in execute_query
    await session.rollback()
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 990, in rollback
    await greenlet_spawn(self.sync_session.rollback)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\concurrency.py", line 101, in greenlet_spawn
    _not_implemented()
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\concurrency.py", line 81, in _not_implemented
    raise ValueError(
ValueError: the greenlet library is required to use this function. No module named 'greenlet._greenlet'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\modules\auth\application\services\refresh_token_service.py", line 213, in validate_refresh_token
    result = await execute_query(GET_REFRESH_TOKEN_BY_HASH, (token_hash, cliente_id))
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 128, in execute_query
    async with _get_connection_context(connection_type, client_id) as session:
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\contextlib.py", line 231, in __aexit__
    await self.gen.athrow(value)
  File "D:\base_multi_tenant_fastapi\app\core\tenant\routing.py", line 671, in get_connection_for_tenant
    async with get_db_connection(DatabaseConnection.ADMIN) as session:
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\contextlib.py", line 231, in __aexit__
    await self.gen.athrow(value)
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\connection_async.py", line 301, in get_db_connection
    async with async_session() as session:
               ^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 1071, in __aexit__
    await asyncio.shield(task)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 1016, in close
    await greenlet_spawn(self.sync_session.close)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\concurrency.py", line 101, in greenlet_spawn
    _not_implemented()
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\concurrency.py", line 81, in _not_implemented
    raise ValueError(
ValueError: the greenlet library is required to use this function. No module named 'greenlet._greenlet'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\modules\auth\application\services\auth_service.py", line 452, in get_current_user_from_refresh
    db_token_data = await RefreshTokenService.validate_refresh_token(refresh_token)
                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\core\application\base_service.py", line 52, in wrapper
    return await func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\modules\auth\application\services\refresh_token_service.py", line 233, in validate_refresh_token
    raise DatabaseError(
app.core.exceptions.DatabaseError: Error al validar el refresh token
2025-12-03 16:29:17,333 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/refresh/ 401 20.0ms
2025-12-03 16:29:29,275 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/refresh/
2025-12-03 16:29:29,275 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 16:29:29,275 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 16:29:29,275 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 16:29:29,275 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 16:29:29,276 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 16:29:29,276 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 16:29:29,276 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 16:29:29,276 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 16:29:29,276 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: 9b8ab97c-89d4-41dc-8bbf-54d193edbe02
2025-12-03 16:29:29,276 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 16:29:29,277 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=9b8ab97c-89d4-41dc-8bbf-54d193edbe02, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/auth/refresh/
2025-12-03 16:29:29,279 - app.infrastructure.database.queries_async - WARNING - [QUERY] DEPRECATED: execute_query() recibió string SQL. Migrar a SQLAlchemy Core.
2025-12-03 16:29:29,279 - app.modules.auth.application.services.refresh_token_service - ERROR - [VALIDATE-TOKEN] Error inesperado validando refresh token: the greenlet library is required to use this function. No module named 'greenlet._greenlet'
Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 130, in execute_query
    result = await session.execute(text(query))
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 449, in execute
    result = await greenlet_spawn(
                   ^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\concurrency.py", line 101, in greenlet_spawn
    _not_implemented()
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\concurrency.py", line 81, in _not_implemented
    raise ValueError(
ValueError: the greenlet library is required to use this function. No module named 'greenlet._greenlet'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\connection_async.py", line 303, in get_db_connection
    yield session
  File "D:\base_multi_tenant_fastapi\app\core\tenant\routing.py", line 672, in get_connection_for_tenant
    yield session
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 135, in execute_query
    await session.rollback()
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 990, in rollback
    await greenlet_spawn(self.sync_session.rollback)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\concurrency.py", line 101, in greenlet_spawn
    _not_implemented()
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\concurrency.py", line 81, in _not_implemented
    raise ValueError(
ValueError: the greenlet library is required to use this function. No module named 'greenlet._greenlet'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\modules\auth\application\services\refresh_token_service.py", line 213, in validate_refresh_token
    result = await execute_query(GET_REFRESH_TOKEN_BY_HASH, (token_hash, cliente_id))
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 128, in execute_query
    async with _get_connection_context(connection_type, client_id) as session:
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\contextlib.py", line 231, in __aexit__
    await self.gen.athrow(value)
  File "D:\base_multi_tenant_fastapi\app\core\tenant\routing.py", line 671, in get_connection_for_tenant
    async with get_db_connection(DatabaseConnection.ADMIN) as session:
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\contextlib.py", line 231, in __aexit__
    await self.gen.athrow(value)
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\connection_async.py", line 301, in get_db_connection
    async with async_session() as session:
               ^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 1071, in __aexit__
    await asyncio.shield(task)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 1016, in close
    await greenlet_spawn(self.sync_session.close)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\concurrency.py", line 101, in greenlet_spawn
    _not_implemented()
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\concurrency.py", line 81, in _not_implemented
    raise ValueError(
ValueError: the greenlet library is required to use this function. No module named 'greenlet._greenlet'
2025-12-03 16:29:29,282 - app.core.application.base_service - ERROR - DatabaseError en validate_refresh_token: Error al validar el refresh token
Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 130, in execute_query
    result = await session.execute(text(query))
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 449, in execute
    result = await greenlet_spawn(
                   ^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\concurrency.py", line 101, in greenlet_spawn
    _not_implemented()
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\concurrency.py", line 81, in _not_implemented
    raise ValueError(
ValueError: the greenlet library is required to use this function. No module named 'greenlet._greenlet'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\connection_async.py", line 303, in get_db_connection
    yield session
  File "D:\base_multi_tenant_fastapi\app\core\tenant\routing.py", line 672, in get_connection_for_tenant
    yield session
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 135, in execute_query
    await session.rollback()
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 990, in rollback
    await greenlet_spawn(self.sync_session.rollback)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\concurrency.py", line 101, in greenlet_spawn
    _not_implemented()
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\concurrency.py", line 81, in _not_implemented
    raise ValueError(
ValueError: the greenlet library is required to use this function. No module named 'greenlet._greenlet'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\modules\auth\application\services\refresh_token_service.py", line 213, in validate_refresh_token
    result = await execute_query(GET_REFRESH_TOKEN_BY_HASH, (token_hash, cliente_id))
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 128, in execute_query
    async with _get_connection_context(connection_type, client_id) as session:
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\contextlib.py", line 231, in __aexit__
    await self.gen.athrow(value)
  File "D:\base_multi_tenant_fastapi\app\core\tenant\routing.py", line 671, in get_connection_for_tenant
    async with get_db_connection(DatabaseConnection.ADMIN) as session:
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\contextlib.py", line 231, in __aexit__
    await self.gen.athrow(value)
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\connection_async.py", line 301, in get_db_connection
    async with async_session() as session:
               ^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 1071, in __aexit__
    await asyncio.shield(task)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 1016, in close
    await greenlet_spawn(self.sync_session.close)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\concurrency.py", line 101, in greenlet_spawn
    _not_implemented()
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\concurrency.py", line 81, in _not_implemented
    raise ValueError(
ValueError: the greenlet library is required to use this function. No module named 'greenlet._greenlet'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\core\application\base_service.py", line 52, in wrapper
    return await func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\modules\auth\application\services\refresh_token_service.py", line 233, in validate_refresh_token
    raise DatabaseError(
app.core.exceptions.DatabaseError: Error al validar el refresh token
2025-12-03 16:29:29,285 - app.modules.auth.application.services.auth_service - ERROR - Error validando refresh token: Error al validar el refresh token
Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 130, in execute_query
    result = await session.execute(text(query))
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 449, in execute
    result = await greenlet_spawn(
                   ^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\concurrency.py", line 101, in greenlet_spawn
    _not_implemented()
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\concurrency.py", line 81, in _not_implemented
    raise ValueError(
ValueError: the greenlet library is required to use this function. No module named 'greenlet._greenlet'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\connection_async.py", line 303, in get_db_connection
    yield session
  File "D:\base_multi_tenant_fastapi\app\core\tenant\routing.py", line 672, in get_connection_for_tenant
    yield session
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 135, in execute_query
    await session.rollback()
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 990, in rollback
    await greenlet_spawn(self.sync_session.rollback)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\concurrency.py", line 101, in greenlet_spawn
    _not_implemented()
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\concurrency.py", line 81, in _not_implemented
    raise ValueError(
ValueError: the greenlet library is required to use this function. No module named 'greenlet._greenlet'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\modules\auth\application\services\refresh_token_service.py", line 213, in validate_refresh_token
    result = await execute_query(GET_REFRESH_TOKEN_BY_HASH, (token_hash, cliente_id))
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 128, in execute_query
    async with _get_connection_context(connection_type, client_id) as session:
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\contextlib.py", line 231, in __aexit__
    await self.gen.athrow(value)
  File "D:\base_multi_tenant_fastapi\app\core\tenant\routing.py", line 671, in get_connection_for_tenant
    async with get_db_connection(DatabaseConnection.ADMIN) as session:
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\contextlib.py", line 231, in __aexit__
    await self.gen.athrow(value)
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\connection_async.py", line 301, in get_db_connection
    async with async_session() as session:
               ^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 1071, in __aexit__
    await asyncio.shield(task)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 1016, in close
    await greenlet_spawn(self.sync_session.close)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\concurrency.py", line 101, in greenlet_spawn
    _not_implemented()
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\concurrency.py", line 81, in _not_implemented
    raise ValueError(
ValueError: the greenlet library is required to use this function. No module named 'greenlet._greenlet'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\modules\auth\application\services\auth_service.py", line 452, in get_current_user_from_refresh
    db_token_data = await RefreshTokenService.validate_refresh_token(refresh_token)
                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\core\application\base_service.py", line 52, in wrapper
    return await func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\modules\auth\application\services\refresh_token_service.py", line 233, in validate_refresh_token
    raise DatabaseError(
app.core.exceptions.DatabaseError: Error al validar el refresh token
2025-12-03 16:29:29,291 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/refresh/ 401 16.3ms
2025-12-03 16:29:39,153 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/auth/login/
2025-12-03 16:29:39,155 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/auth/login/ 200 0.5ms
2025-12-03 16:29:39,167 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/login/
2025-12-03 16:29:39,169 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 16:29:39,169 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 16:29:39,169 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 16:29:39,169 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 16:29:39,169 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 16:29:39,170 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 16:29:39,170 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 16:29:39,170 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 16:29:39,170 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: 9b8ab97c-89d4-41dc-8bbf-54d193edbe02
2025-12-03 16:29:39,170 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 16:29:39,170 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=9b8ab97c-89d4-41dc-8bbf-54d193edbe02, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/auth/login/
2025-12-03 16:29:39,172 - app.core.application.base_service - ERROR - ERROR INESPERADO en obtener_cliente_por_id: query debe ser string SQL o objeto SQLAlchemy Core, recibido: <class 'sqlalchemy.sql.elements.TextClause'>
Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\core\application\base_service.py", line 52, in wrapper
    return await func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\modules\tenant\application\services\cliente_service.py", line 187, in obtener_cliente_por_id
    resultado = await execute_query(
                ^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 142, in execute_query
    raise ValueError(
ValueError: query debe ser string SQL o objeto SQLAlchemy Core, recibido: <class 'sqlalchemy.sql.elements.TextClause'>
2025-12-03 16:29:39,173 - app.modules.auth.presentation.endpoints - ERROR - Error inesperado en /login/ para usuario sueperadmin: Error interno del servidor en obtener_cliente_por_id
Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\core\application\base_service.py", line 52, in wrapper
    return await func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\modules\tenant\application\services\cliente_service.py", line 187, in obtener_cliente_por_id
    resultado = await execute_query(
                ^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 142, in execute_query
    raise ValueError(
ValueError: query debe ser string SQL o objeto SQLAlchemy Core, recibido: <class 'sqlalchemy.sql.elements.TextClause'>

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\modules\auth\presentation\endpoints.py", line 134, in login
    cliente = await ClienteService.obtener_cliente_por_id(cliente_id)
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\core\application\base_service.py", line 69, in wrapper
    raise ServiceError(
app.core.exceptions.ServiceError: Error interno del servidor en obtener_cliente_por_id
2025-12-03 16:29:39,174 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/login/ 500 7.2ms
2025-12-03 16:29:39,852 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Pool ADMIN inicializado. Size=10, MaxOverflow=5
2025-12-03 16:29:39,852 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Configuración de pools de tenants: MaxPools=50, PoolSize=3, MaxOverflow=2, InactivityTimeout=3600s
2025-12-03 16:29:39,852 - app.infrastructure.database.connection_pool - INFO - ✅ Módulo de connection pooling cargado y activo
2025-12-03 16:29:39,852 - app.infrastructure.database.connection_pool - INFO -    Configuración: MaxTenantPools=50, TenantPoolSize=3, InactivityTimeout=3600s
2025-12-03 16:29:39,852 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Todos los pools cerrados
2025-12-03 16:29:39,852 - app.main - INFO - ✅ Pools de conexión cerrados correctamente
2025-12-03 16:29:40,782 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 16:29:40,993 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 16:29:41,002 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 16:29:41,002 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 16:29:41,002 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 16:29:41,002 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 16:29:41,002 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 16:29:41,002 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=9b8ab97c-89d4-41dc-8bbf-54d193edbe02, DEFAULT_TYPE=single
2025-12-03 16:29:41,407 - app.core.security.rate_limiting - INFO - [RATE_LIMITING] Activado. Límites: Login=10/minute, API=200/minute
2025-12-03 16:29:41,407 - app.core.security.rate_limiting - INFO - ✅ Módulo de rate limiting cargado y activo
2025-12-03 16:29:41,507 - app.core.authorization.rbac - INFO - 🔐 Inicializando sistema de autorización...
2025-12-03 16:29:41,507 - app.core.authorization.rbac - INFO - ✅ Sistema de autorización inicializado correctamente
2025-12-03 16:29:41,507 - app.core.authorization.rbac - INFO - 📊 Permisos del sistema: 6 módulos configurados
2025-12-03 16:29:41,753 - app.core.tenant.middleware - INFO - Módulo tenant_middleware cargado (versión híbrida con soporte para proxies)
2025-12-03 16:29:41,753 - app.main - INFO - ✅ Rate limiting configurado y activo
2025-12-03 16:29:41,913 - app.core.tenant.middleware - INFO - [TENANT_MW] Inicializado - BASE_DOMAIN=app.local, SYSTEM_ID=9B8AB97C-89D4-41DC-8BBF-54D193EDBE02, EXCLUDED_SUBDOMAINS={'admin', 'cdn', 'www', 'static', 'backend', 'api', 'assets'}
2025-12-03 16:29:43,570 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Pool ADMIN inicializado. Size=10, MaxOverflow=5
2025-12-03 16:29:43,570 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Configuración de pools de tenants: MaxPools=50, PoolSize=3, MaxOverflow=2, InactivityTimeout=3600s
2025-12-03 16:29:43,570 - app.infrastructure.database.connection_pool - INFO - ✅ Módulo de connection pooling cargado y activo
2025-12-03 16:29:43,570 - app.infrastructure.database.connection_pool - INFO -    Configuración: MaxTenantPools=50, TenantPoolSize=3, InactivityTimeout=3600s
2025-12-03 16:29:43,570 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Todos los pools cerrados
2025-12-03 16:29:43,570 - app.main - INFO - ✅ Pools de conexión cerrados correctamente
2025-12-03 16:29:47,839 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/refresh/
2025-12-03 16:29:47,840 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 16:29:47,840 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 16:29:47,840 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 16:29:47,840 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 16:29:47,840 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 16:29:47,841 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 16:29:47,841 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 16:29:47,841 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 16:29:47,841 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: 9b8ab97c-89d4-41dc-8bbf-54d193edbe02
2025-12-03 16:29:47,841 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 16:29:47,841 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=9b8ab97c-89d4-41dc-8bbf-54d193edbe02, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/auth/refresh/
2025-12-03 16:29:47,854 - app.infrastructure.database.queries_async - WARNING - [QUERY] DEPRECATED: execute_query() recibió string SQL. Migrar a SQLAlchemy Core.
2025-12-03 16:29:47,856 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] AsyncEngine creado para admin
2025-12-03 16:29:48,040 - app.infrastructure.database.queries_async - ERROR - Error en execute_query async (string): (pyodbc.Error) ('07002', '[07002] [Microsoft][ODBC Driver 17 for SQL Server]COUNT field incorrect or syntax error (0) (SQLExecDirectW)')
[SQL: 
SELECT 
    token_id, usuario_id, token_hash, expires_at, 
    is_revoked, created_at, client_type, cliente_id
FROM refresh_tokens
WHERE token_hash = ? AND cliente_id = ? AND is_revoked = 0 AND expires_at > GETDATE();
]
(Background on this error at: https://sqlalche.me/e/20/dbapi)
2025-12-03 16:29:48,041 - app.infrastructure.database.connection_async - ERROR - [ASYNC_CONNECTION] Error en sesión async: Error en la consulta: (pyodbc.Error) ('07002', '[07002] [Microsoft][ODBC Driver 17 for SQL Server]COUNT field incorrect or syntax error (0) (SQLExecDirectW)')
[SQL: 
SELECT 
    token_id, usuario_id, token_hash, expires_at, 
    is_revoked, created_at, client_type, cliente_id
FROM refresh_tokens
WHERE token_hash = ? AND cliente_id = ? AND is_revoked = 0 AND expires_at > GETDATE();
]
(Background on this error at: https://sqlalche.me/e/20/dbapi)
Traceback (most recent call last):
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\site-packages\sqlalchemy\engine\base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\site-packages\sqlalchemy\engine\default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 230, in execute
    self._adapt_connection._handle_exception(error)
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 368, in _handle_exception
    raise error.with_traceback(exc_info[2])
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 228, in execute
    return self.await_(self._execute_async(operation, parameters))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 251, in _execute_async
    result = await self._cursor.execute(operation, parameters)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\site-packages\aioodbc\cursor.py", line 132, in execute
    await self._run_operation(self._impl.execute, sql, *params)
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\site-packages\aioodbc\cursor.py", line 30, in _run_operation
    result = await self._conn._execute(func, *args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\concurrent\futures\thread.py", line 59, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
pyodbc.Error: ('07002', '[07002] [Microsoft][ODBC Driver 17 for SQL Server]COUNT field incorrect or syntax error (0) (SQLExecDirectW)')

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 130, in execute_query
    result = await session.execute(text(query))
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 449, in execute
    result = await greenlet_spawn(
             ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 203, in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\site-packages\sqlalchemy\orm\session.py", line 2351, in execute
    return self._execute_internal(
           ^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\site-packages\sqlalchemy\orm\session.py", line 2258, in _execute_internal
    result = conn.execute(
             ^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\site-packages\sqlalchemy\engine\base.py", line 1419, in execute
    return meth(
           ^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\site-packages\sqlalchemy\sql\elements.py", line 526, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\site-packages\sqlalchemy\engine\base.py", line 1641, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\site-packages\sqlalchemy\engine\base.py", line 1846, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\site-packages\sqlalchemy\engine\base.py", line 1986, in _exec_single_context
    self._handle_dbapi_exception(
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\site-packages\sqlalchemy\engine\base.py", line 2355, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\site-packages\sqlalchemy\engine\base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\site-packages\sqlalchemy\engine\default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 230, in execute
    self._adapt_connection._handle_exception(error)
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 368, in _handle_exception
    raise error.with_traceback(exc_info[2])
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 228, in execute
    return self.await_(self._execute_async(operation, parameters))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 251, in _execute_async
    result = await self._cursor.execute(operation, parameters)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\site-packages\aioodbc\cursor.py", line 132, in execute
    await self._run_operation(self._impl.execute, sql, *params)
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\site-packages\aioodbc\cursor.py", line 30, in _run_operation
    result = await self._conn._execute(func, *args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\concurrent\futures\thread.py", line 59, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
sqlalchemy.exc.DBAPIError: (pyodbc.Error) ('07002', '[07002] [Microsoft][ODBC Driver 17 for SQL Server]COUNT field incorrect or syntax error (0) (SQLExecDirectW)')
[SQL: 
SELECT 
    token_id, usuario_id, token_hash, expires_at, 
    is_revoked, created_at, client_type, cliente_id
FROM refresh_tokens
WHERE token_hash = ? AND cliente_id = ? AND is_revoked = 0 AND expires_at > GETDATE();
]
(Background on this error at: https://sqlalche.me/e/20/dbapi)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\connection_async.py", line 303, in get_db_connection
    yield session
  File "D:\base_multi_tenant_fastapi\app\core\tenant\routing.py", line 672, in get_connection_for_tenant
    yield session
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 137, in execute_query
    raise DatabaseError(
app.core.exceptions.DatabaseError: Error en la consulta: (pyodbc.Error) ('07002', '[07002] [Microsoft][ODBC Driver 17 for SQL Server]COUNT field incorrect or syntax error (0) (SQLExecDirectW)')
[SQL: 
SELECT 
    token_id, usuario_id, token_hash, expires_at, 
    is_revoked, created_at, client_type, cliente_id
FROM refresh_tokens
WHERE token_hash = ? AND cliente_id = ? AND is_revoked = 0 AND expires_at > GETDATE();
]
(Background on this error at: https://sqlalche.me/e/20/dbapi)
2025-12-03 16:29:48,053 - app.core.application.base_service - ERROR - DatabaseError en validate_refresh_token: Error en la consulta: (pyodbc.Error) ('07002', '[07002] [Microsoft][ODBC Driver 17 for SQL Server]COUNT field incorrect or syntax error (0) (SQLExecDirectW)')
[SQL: 
SELECT 
    token_id, usuario_id, token_hash, expires_at, 
    is_revoked, created_at, client_type, cliente_id
FROM refresh_tokens
WHERE token_hash = ? AND cliente_id = ? AND is_revoked = 0 AND expires_at > GETDATE();
]
(Background on this error at: https://sqlalche.me/e/20/dbapi)
Traceback (most recent call last):
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\site-packages\sqlalchemy\engine\base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\site-packages\sqlalchemy\engine\default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 230, in execute
    self._adapt_connection._handle_exception(error)
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 368, in _handle_exception
    raise error.with_traceback(exc_info[2])
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 228, in execute
    return self.await_(self._execute_async(operation, parameters))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 251, in _execute_async
    result = await self._cursor.execute(operation, parameters)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\site-packages\aioodbc\cursor.py", line 132, in execute
    await self._run_operation(self._impl.execute, sql, *params)
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\site-packages\aioodbc\cursor.py", line 30, in _run_operation
    result = await self._conn._execute(func, *args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\concurrent\futures\thread.py", line 59, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
pyodbc.Error: ('07002', '[07002] [Microsoft][ODBC Driver 17 for SQL Server]COUNT field incorrect or syntax error (0) (SQLExecDirectW)')

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 130, in execute_query
    result = await session.execute(text(query))
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 449, in execute
    result = await greenlet_spawn(
             ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 203, in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\site-packages\sqlalchemy\orm\session.py", line 2351, in execute
    return self._execute_internal(
           ^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\site-packages\sqlalchemy\orm\session.py", line 2258, in _execute_internal
    result = conn.execute(
             ^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\site-packages\sqlalchemy\engine\base.py", line 1419, in execute
    return meth(
           ^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\site-packages\sqlalchemy\sql\elements.py", line 526, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\site-packages\sqlalchemy\engine\base.py", line 1641, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\site-packages\sqlalchemy\engine\base.py", line 1846, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\site-packages\sqlalchemy\engine\base.py", line 1986, in _exec_single_context
    self._handle_dbapi_exception(
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\site-packages\sqlalchemy\engine\base.py", line 2355, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\site-packages\sqlalchemy\engine\base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\site-packages\sqlalchemy\engine\default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 230, in execute
    self._adapt_connection._handle_exception(error)
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 368, in _handle_exception
    raise error.with_traceback(exc_info[2])
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 228, in execute
    return self.await_(self._execute_async(operation, parameters))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 251, in _execute_async
    result = await self._cursor.execute(operation, parameters)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\site-packages\aioodbc\cursor.py", line 132, in execute
    await self._run_operation(self._impl.execute, sql, *params)
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\site-packages\aioodbc\cursor.py", line 30, in _run_operation
    result = await self._conn._execute(func, *args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\concurrent\futures\thread.py", line 59, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
sqlalchemy.exc.DBAPIError: (pyodbc.Error) ('07002', '[07002] [Microsoft][ODBC Driver 17 for SQL Server]COUNT field incorrect or syntax error (0) (SQLExecDirectW)')
[SQL: 
SELECT 
    token_id, usuario_id, token_hash, expires_at, 
    is_revoked, created_at, client_type, cliente_id
FROM refresh_tokens
WHERE token_hash = ? AND cliente_id = ? AND is_revoked = 0 AND expires_at > GETDATE();
]
(Background on this error at: https://sqlalche.me/e/20/dbapi)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\core\application\base_service.py", line 52, in wrapper
    return await func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\modules\auth\application\services\refresh_token_service.py", line 213, in validate_refresh_token
    result = await execute_query(GET_REFRESH_TOKEN_BY_HASH, (token_hash, cliente_id))
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 137, in execute_query
    raise DatabaseError(
app.core.exceptions.DatabaseError: Error en la consulta: (pyodbc.Error) ('07002', '[07002] [Microsoft][ODBC Driver 17 for SQL Server]COUNT field incorrect or syntax error (0) (SQLExecDirectW)')
[SQL: 
SELECT 
    token_id, usuario_id, token_hash, expires_at, 
    is_revoked, created_at, client_type, cliente_id
FROM refresh_tokens
WHERE token_hash = ? AND cliente_id = ? AND is_revoked = 0 AND expires_at > GETDATE();
]
(Background on this error at: https://sqlalche.me/e/20/dbapi)
2025-12-03 16:29:48,055 - app.modules.auth.application.services.auth_service - ERROR - Error validando refresh token: Error en la consulta: (pyodbc.Error) ('07002', '[07002] [Microsoft][ODBC Driver 17 for SQL Server]COUNT field incorrect or syntax error (0) (SQLExecDirectW)')
[SQL: 
SELECT 
    token_id, usuario_id, token_hash, expires_at, 
    is_revoked, created_at, client_type, cliente_id
FROM refresh_tokens
WHERE token_hash = ? AND cliente_id = ? AND is_revoked = 0 AND expires_at > GETDATE();
]
(Background on this error at: https://sqlalche.me/e/20/dbapi)
Traceback (most recent call last):
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\site-packages\sqlalchemy\engine\base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\site-packages\sqlalchemy\engine\default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 230, in execute
    self._adapt_connection._handle_exception(error)
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 368, in _handle_exception
    raise error.with_traceback(exc_info[2])
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 228, in execute
    return self.await_(self._execute_async(operation, parameters))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 251, in _execute_async
    result = await self._cursor.execute(operation, parameters)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\site-packages\aioodbc\cursor.py", line 132, in execute
    await self._run_operation(self._impl.execute, sql, *params)
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\site-packages\aioodbc\cursor.py", line 30, in _run_operation
    result = await self._conn._execute(func, *args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\concurrent\futures\thread.py", line 59, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
pyodbc.Error: ('07002', '[07002] [Microsoft][ODBC Driver 17 for SQL Server]COUNT field incorrect or syntax error (0) (SQLExecDirectW)')

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 130, in execute_query
    result = await session.execute(text(query))
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 449, in execute
    result = await greenlet_spawn(
             ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 203, in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\site-packages\sqlalchemy\orm\session.py", line 2351, in execute
    return self._execute_internal(
           ^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\site-packages\sqlalchemy\orm\session.py", line 2258, in _execute_internal
    result = conn.execute(
             ^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\site-packages\sqlalchemy\engine\base.py", line 1419, in execute
    return meth(
           ^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\site-packages\sqlalchemy\sql\elements.py", line 526, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\site-packages\sqlalchemy\engine\base.py", line 1641, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\site-packages\sqlalchemy\engine\base.py", line 1846, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\site-packages\sqlalchemy\engine\base.py", line 1986, in _exec_single_context
    self._handle_dbapi_exception(
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\site-packages\sqlalchemy\engine\base.py", line 2355, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\site-packages\sqlalchemy\engine\base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\site-packages\sqlalchemy\engine\default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 230, in execute
    self._adapt_connection._handle_exception(error)
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 368, in _handle_exception
    raise error.with_traceback(exc_info[2])
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 228, in execute
    return self.await_(self._execute_async(operation, parameters))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 251, in _execute_async
    result = await self._cursor.execute(operation, parameters)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\site-packages\aioodbc\cursor.py", line 132, in execute
    await self._run_operation(self._impl.execute, sql, *params)
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\site-packages\aioodbc\cursor.py", line 30, in _run_operation
    result = await self._conn._execute(func, *args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\concurrent\futures\thread.py", line 59, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
sqlalchemy.exc.DBAPIError: (pyodbc.Error) ('07002', '[07002] [Microsoft][ODBC Driver 17 for SQL Server]COUNT field incorrect or syntax error (0) (SQLExecDirectW)')
[SQL: 
SELECT 
    token_id, usuario_id, token_hash, expires_at, 
    is_revoked, created_at, client_type, cliente_id
FROM refresh_tokens
WHERE token_hash = ? AND cliente_id = ? AND is_revoked = 0 AND expires_at > GETDATE();
]
(Background on this error at: https://sqlalche.me/e/20/dbapi)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\modules\auth\application\services\auth_service.py", line 452, in get_current_user_from_refresh
    db_token_data = await RefreshTokenService.validate_refresh_token(refresh_token)
                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\core\application\base_service.py", line 52, in wrapper
    return await func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\modules\auth\application\services\refresh_token_service.py", line 213, in validate_refresh_token
    result = await execute_query(GET_REFRESH_TOKEN_BY_HASH, (token_hash, cliente_id))
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 137, in execute_query
    raise DatabaseError(
app.core.exceptions.DatabaseError: Error en la consulta: (pyodbc.Error) ('07002', '[07002] [Microsoft][ODBC Driver 17 for SQL Server]COUNT field incorrect or syntax error (0) (SQLExecDirectW)')
[SQL: 
SELECT 
    token_id, usuario_id, token_hash, expires_at, 
    is_revoked, created_at, client_type, cliente_id
FROM refresh_tokens
WHERE token_hash = ? AND cliente_id = ? AND is_revoked = 0 AND expires_at > GETDATE();
]
(Background on this error at: https://sqlalche.me/e/20/dbapi)
2025-12-03 16:29:48,058 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/refresh/ 401 218.3ms
2025-12-03 16:29:50,966 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 16:29:51,152 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 16:29:51,157 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 16:29:51,163 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 16:29:51,163 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 16:29:51,164 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 16:29:51,164 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 16:29:51,165 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=9b8ab97c-89d4-41dc-8bbf-54d193edbe02, DEFAULT_TYPE=single
2025-12-03 16:29:51,494 - app.core.security.rate_limiting - INFO - [RATE_LIMITING] Activado. Límites: Login=10/minute, API=200/minute
2025-12-03 16:29:51,494 - app.core.security.rate_limiting - INFO - ✅ Módulo de rate limiting cargado y activo
2025-12-03 16:29:51,562 - app.core.authorization.rbac - INFO - 🔐 Inicializando sistema de autorización...
2025-12-03 16:29:51,562 - app.core.authorization.rbac - INFO - ✅ Sistema de autorización inicializado correctamente
2025-12-03 16:29:51,562 - app.core.authorization.rbac - INFO - 📊 Permisos del sistema: 6 módulos configurados
2025-12-03 16:29:51,722 - app.core.tenant.middleware - INFO - Módulo tenant_middleware cargado (versión híbrida con soporte para proxies)
2025-12-03 16:29:51,722 - app.main - INFO - ✅ Rate limiting configurado y activo
2025-12-03 16:29:51,872 - app.core.tenant.middleware - INFO - [TENANT_MW] Inicializado - BASE_DOMAIN=app.local, SYSTEM_ID=9B8AB97C-89D4-41DC-8BBF-54D193EDBE02, EXCLUDED_SUBDOMAINS={'assets', 'static', 'api', 'backend', 'www', 'cdn', 'admin'}
2025-12-03 16:29:57,500 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/refresh/
2025-12-03 16:29:57,501 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 16:29:57,501 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 16:29:57,501 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 16:29:57,501 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 16:29:57,501 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 16:29:57,501 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 16:29:57,501 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 16:29:57,501 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 16:29:57,502 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: 9b8ab97c-89d4-41dc-8bbf-54d193edbe02
2025-12-03 16:29:57,502 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 16:29:57,502 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=9b8ab97c-89d4-41dc-8bbf-54d193edbe02, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/auth/refresh/
2025-12-03 16:29:57,509 - app.infrastructure.database.queries_async - WARNING - [QUERY] DEPRECATED: execute_query() recibió string SQL. Migrar a SQLAlchemy Core.
2025-12-03 16:29:57,511 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] AsyncEngine creado para admin
2025-12-03 16:29:57,511 - app.modules.auth.application.services.refresh_token_service - ERROR - [VALIDATE-TOKEN] Error inesperado validando refresh token: the greenlet library is required to use this function. No module named 'greenlet._greenlet'
Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 130, in execute_query
    result = await session.execute(text(query))
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 449, in execute
    result = await greenlet_spawn(
                   ^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\concurrency.py", line 101, in greenlet_spawn
    _not_implemented()
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\concurrency.py", line 81, in _not_implemented
    raise ValueError(
ValueError: the greenlet library is required to use this function. No module named 'greenlet._greenlet'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\connection_async.py", line 303, in get_db_connection
    yield session
  File "D:\base_multi_tenant_fastapi\app\core\tenant\routing.py", line 672, in get_connection_for_tenant
    yield session
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 135, in execute_query
    await session.rollback()
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 990, in rollback
    await greenlet_spawn(self.sync_session.rollback)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\concurrency.py", line 101, in greenlet_spawn
    _not_implemented()
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\concurrency.py", line 81, in _not_implemented
    raise ValueError(
ValueError: the greenlet library is required to use this function. No module named 'greenlet._greenlet'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\modules\auth\application\services\refresh_token_service.py", line 213, in validate_refresh_token
    result = await execute_query(GET_REFRESH_TOKEN_BY_HASH, (token_hash, cliente_id))
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 128, in execute_query
    async with _get_connection_context(connection_type, client_id) as session:
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\contextlib.py", line 231, in __aexit__
    await self.gen.athrow(value)
  File "D:\base_multi_tenant_fastapi\app\core\tenant\routing.py", line 671, in get_connection_for_tenant
    async with get_db_connection(DatabaseConnection.ADMIN) as session:
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\contextlib.py", line 231, in __aexit__
    await self.gen.athrow(value)
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\connection_async.py", line 301, in get_db_connection
    async with async_session() as session:
               ^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 1071, in __aexit__
    await asyncio.shield(task)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 1016, in close
    await greenlet_spawn(self.sync_session.close)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\concurrency.py", line 101, in greenlet_spawn
    _not_implemented()
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\concurrency.py", line 81, in _not_implemented
    raise ValueError(
ValueError: the greenlet library is required to use this function. No module named 'greenlet._greenlet'
2025-12-03 16:29:57,517 - app.core.application.base_service - ERROR - DatabaseError en validate_refresh_token: Error al validar el refresh token
Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 130, in execute_query
    result = await session.execute(text(query))
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 449, in execute
    result = await greenlet_spawn(
                   ^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\concurrency.py", line 101, in greenlet_spawn
    _not_implemented()
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\concurrency.py", line 81, in _not_implemented
    raise ValueError(
ValueError: the greenlet library is required to use this function. No module named 'greenlet._greenlet'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\connection_async.py", line 303, in get_db_connection
    yield session
  File "D:\base_multi_tenant_fastapi\app\core\tenant\routing.py", line 672, in get_connection_for_tenant
    yield session
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 135, in execute_query
    await session.rollback()
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 990, in rollback
    await greenlet_spawn(self.sync_session.rollback)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\concurrency.py", line 101, in greenlet_spawn
    _not_implemented()
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\concurrency.py", line 81, in _not_implemented
    raise ValueError(
ValueError: the greenlet library is required to use this function. No module named 'greenlet._greenlet'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\modules\auth\application\services\refresh_token_service.py", line 213, in validate_refresh_token
    result = await execute_query(GET_REFRESH_TOKEN_BY_HASH, (token_hash, cliente_id))
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 128, in execute_query
    async with _get_connection_context(connection_type, client_id) as session:
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\contextlib.py", line 231, in __aexit__
    await self.gen.athrow(value)
  File "D:\base_multi_tenant_fastapi\app\core\tenant\routing.py", line 671, in get_connection_for_tenant
    async with get_db_connection(DatabaseConnection.ADMIN) as session:
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\contextlib.py", line 231, in __aexit__
    await self.gen.athrow(value)
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\connection_async.py", line 301, in get_db_connection
    async with async_session() as session:
               ^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 1071, in __aexit__
    await asyncio.shield(task)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 1016, in close
    await greenlet_spawn(self.sync_session.close)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\concurrency.py", line 101, in greenlet_spawn
    _not_implemented()
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\concurrency.py", line 81, in _not_implemented
    raise ValueError(
ValueError: the greenlet library is required to use this function. No module named 'greenlet._greenlet'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\core\application\base_service.py", line 52, in wrapper
    return await func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\modules\auth\application\services\refresh_token_service.py", line 233, in validate_refresh_token
    raise DatabaseError(
app.core.exceptions.DatabaseError: Error al validar el refresh token
2025-12-03 16:29:57,519 - app.modules.auth.application.services.auth_service - ERROR - Error validando refresh token: Error al validar el refresh token
Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 130, in execute_query
    result = await session.execute(text(query))
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 449, in execute
    result = await greenlet_spawn(
                   ^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\concurrency.py", line 101, in greenlet_spawn
    _not_implemented()
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\concurrency.py", line 81, in _not_implemented
    raise ValueError(
ValueError: the greenlet library is required to use this function. No module named 'greenlet._greenlet'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\connection_async.py", line 303, in get_db_connection
    yield session
  File "D:\base_multi_tenant_fastapi\app\core\tenant\routing.py", line 672, in get_connection_for_tenant
    yield session
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 135, in execute_query
    await session.rollback()
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 990, in rollback
    await greenlet_spawn(self.sync_session.rollback)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\concurrency.py", line 101, in greenlet_spawn
    _not_implemented()
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\concurrency.py", line 81, in _not_implemented
    raise ValueError(
ValueError: the greenlet library is required to use this function. No module named 'greenlet._greenlet'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\modules\auth\application\services\refresh_token_service.py", line 213, in validate_refresh_token
    result = await execute_query(GET_REFRESH_TOKEN_BY_HASH, (token_hash, cliente_id))
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 128, in execute_query
    async with _get_connection_context(connection_type, client_id) as session:
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\contextlib.py", line 231, in __aexit__
    await self.gen.athrow(value)
  File "D:\base_multi_tenant_fastapi\app\core\tenant\routing.py", line 671, in get_connection_for_tenant
    async with get_db_connection(DatabaseConnection.ADMIN) as session:
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\contextlib.py", line 231, in __aexit__
    await self.gen.athrow(value)
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\connection_async.py", line 301, in get_db_connection
    async with async_session() as session:
               ^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 1071, in __aexit__
    await asyncio.shield(task)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 1016, in close
    await greenlet_spawn(self.sync_session.close)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\concurrency.py", line 101, in greenlet_spawn
    _not_implemented()
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\concurrency.py", line 81, in _not_implemented
    raise ValueError(
ValueError: the greenlet library is required to use this function. No module named 'greenlet._greenlet'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\modules\auth\application\services\auth_service.py", line 452, in get_current_user_from_refresh
    db_token_data = await RefreshTokenService.validate_refresh_token(refresh_token)
                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\core\application\base_service.py", line 52, in wrapper
    return await func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\modules\auth\application\services\refresh_token_service.py", line 233, in validate_refresh_token
    raise DatabaseError(
app.core.exceptions.DatabaseError: Error al validar el refresh token
2025-12-03 16:29:57,523 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/refresh/ 401 23.9ms
2025-12-03 16:30:55,074 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/login/
2025-12-03 16:30:55,074 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 16:30:55,074 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 16:30:55,075 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 16:30:55,075 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 16:30:55,075 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 16:30:55,075 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 16:30:55,075 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 16:30:55,075 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 16:30:55,076 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: 9b8ab97c-89d4-41dc-8bbf-54d193edbe02
2025-12-03 16:30:55,076 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 16:30:55,076 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=9b8ab97c-89d4-41dc-8bbf-54d193edbe02, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/auth/login/
2025-12-03 16:30:55,079 - app.core.application.base_service - ERROR - ERROR INESPERADO en obtener_cliente_por_id: query debe ser string SQL o objeto SQLAlchemy Core, recibido: <class 'sqlalchemy.sql.elements.TextClause'>
Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\core\application\base_service.py", line 52, in wrapper
    return await func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\modules\tenant\application\services\cliente_service.py", line 187, in obtener_cliente_por_id
    resultado = await execute_query(
                ^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 142, in execute_query
    raise ValueError(
ValueError: query debe ser string SQL o objeto SQLAlchemy Core, recibido: <class 'sqlalchemy.sql.elements.TextClause'>
2025-12-03 16:30:55,081 - app.modules.auth.presentation.endpoints - ERROR - Error inesperado en /login/ para usuario superadmin: Error interno del servidor en obtener_cliente_por_id
Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\core\application\base_service.py", line 52, in wrapper
    return await func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\modules\tenant\application\services\cliente_service.py", line 187, in obtener_cliente_por_id
    resultado = await execute_query(
                ^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 142, in execute_query
    raise ValueError(
ValueError: query debe ser string SQL o objeto SQLAlchemy Core, recibido: <class 'sqlalchemy.sql.elements.TextClause'>

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\modules\auth\presentation\endpoints.py", line 134, in login
    cliente = await ClienteService.obtener_cliente_por_id(cliente_id)
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\core\application\base_service.py", line 69, in wrapper
    raise ServiceError(
app.core.exceptions.ServiceError: Error interno del servidor en obtener_cliente_por_id
2025-12-03 16:30:55,082 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/login/ 500 7.9ms
2025-12-03 16:32:27,033 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 16:32:27,228 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 16:32:27,232 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 16:32:27,238 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 16:32:27,238 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 16:32:27,239 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 16:32:27,239 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 16:32:27,239 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=9b8ab97c-89d4-41dc-8bbf-54d193edbe02, DEFAULT_TYPE=single
2025-12-03 16:32:27,479 - app.core.security.rate_limiting - INFO - [RATE_LIMITING] Activado. Límites: Login=10/minute, API=200/minute
2025-12-03 16:32:27,479 - app.core.security.rate_limiting - INFO - ✅ Módulo de rate limiting cargado y activo
2025-12-03 16:32:27,572 - app.core.authorization.rbac - INFO - 🔐 Inicializando sistema de autorización...
2025-12-03 16:32:27,572 - app.core.authorization.rbac - INFO - ✅ Sistema de autorización inicializado correctamente
2025-12-03 16:32:27,572 - app.core.authorization.rbac - INFO - 📊 Permisos del sistema: 6 módulos configurados
2025-12-03 16:32:27,728 - app.core.tenant.middleware - INFO - Módulo tenant_middleware cargado (versión híbrida con soporte para proxies)
2025-12-03 16:32:27,729 - app.main - INFO - ✅ Rate limiting configurado y activo
2025-12-03 16:32:45,990 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Pool ADMIN inicializado. Size=10, MaxOverflow=5
2025-12-03 16:32:45,990 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Configuración de pools de tenants: MaxPools=50, PoolSize=3, MaxOverflow=2, InactivityTimeout=3600s
2025-12-03 16:32:45,990 - app.infrastructure.database.connection_pool - INFO - ✅ Módulo de connection pooling cargado y activo
2025-12-03 16:32:45,990 - app.infrastructure.database.connection_pool - INFO -    Configuración: MaxTenantPools=50, TenantPoolSize=3, InactivityTimeout=3600s
2025-12-03 16:32:45,990 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Todos los pools cerrados
2025-12-03 16:32:45,991 - app.main - INFO - ✅ Pools de conexión cerrados correctamente
2025-12-03 16:32:46,784 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 16:32:46,992 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 16:32:46,998 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 16:32:47,000 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 16:32:47,000 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 16:32:47,001 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 16:32:47,001 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 16:32:47,001 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=9b8ab97c-89d4-41dc-8bbf-54d193edbe02, DEFAULT_TYPE=single
2025-12-03 16:32:47,356 - app.core.security.rate_limiting - INFO - [RATE_LIMITING] Activado. Límites: Login=10/minute, API=200/minute
2025-12-03 16:32:47,356 - app.core.security.rate_limiting - INFO - ✅ Módulo de rate limiting cargado y activo
2025-12-03 16:32:47,426 - app.core.authorization.rbac - INFO - 🔐 Inicializando sistema de autorización...
2025-12-03 16:32:47,426 - app.core.authorization.rbac - INFO - ✅ Sistema de autorización inicializado correctamente
2025-12-03 16:32:47,426 - app.core.authorization.rbac - INFO - 📊 Permisos del sistema: 6 módulos configurados
2025-12-03 16:32:47,595 - app.core.tenant.middleware - INFO - Módulo tenant_middleware cargado (versión híbrida con soporte para proxies)
2025-12-03 16:32:47,595 - app.main - INFO - ✅ Rate limiting configurado y activo
2025-12-03 16:32:47,768 - app.core.tenant.middleware - INFO - [TENANT_MW] Inicializado - BASE_DOMAIN=app.local, SYSTEM_ID=9B8AB97C-89D4-41DC-8BBF-54D193EDBE02, EXCLUDED_SUBDOMAINS={'assets', 'static', 'cdn', 'api', 'admin', 'backend', 'www'}
2025-12-03 16:32:49,030 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Pool ADMIN inicializado. Size=10, MaxOverflow=5
2025-12-03 16:32:49,030 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Configuración de pools de tenants: MaxPools=50, PoolSize=3, MaxOverflow=2, InactivityTimeout=3600s
2025-12-03 16:32:49,030 - app.infrastructure.database.connection_pool - INFO - ✅ Módulo de connection pooling cargado y activo
2025-12-03 16:32:49,030 - app.infrastructure.database.connection_pool - INFO -    Configuración: MaxTenantPools=50, TenantPoolSize=3, InactivityTimeout=3600s
2025-12-03 16:32:49,030 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Todos los pools cerrados
2025-12-03 16:32:49,030 - app.main - INFO - ✅ Pools de conexión cerrados correctamente
2025-12-03 16:32:49,897 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 16:32:50,171 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 16:32:50,182 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 16:32:50,187 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 16:32:50,188 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 16:32:50,189 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 16:32:50,189 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 16:32:50,189 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=9b8ab97c-89d4-41dc-8bbf-54d193edbe02, DEFAULT_TYPE=single
2025-12-03 16:32:50,525 - app.core.security.rate_limiting - INFO - [RATE_LIMITING] Activado. Límites: Login=10/minute, API=200/minute
2025-12-03 16:32:50,525 - app.core.security.rate_limiting - INFO - ✅ Módulo de rate limiting cargado y activo
2025-12-03 16:32:50,596 - app.core.authorization.rbac - INFO - 🔐 Inicializando sistema de autorización...
2025-12-03 16:32:50,596 - app.core.authorization.rbac - INFO - ✅ Sistema de autorización inicializado correctamente
2025-12-03 16:32:50,596 - app.core.authorization.rbac - INFO - 📊 Permisos del sistema: 6 módulos configurados
2025-12-03 16:32:50,767 - app.core.tenant.middleware - INFO - Módulo tenant_middleware cargado (versión híbrida con soporte para proxies)
2025-12-03 16:32:50,767 - app.main - INFO - ✅ Rate limiting configurado y activo
2025-12-03 16:32:50,927 - app.core.tenant.middleware - INFO - [TENANT_MW] Inicializado - BASE_DOMAIN=app.local, SYSTEM_ID=9B8AB97C-89D4-41DC-8BBF-54D193EDBE02, EXCLUDED_SUBDOMAINS={'assets', 'api', 'backend', 'cdn', 'static', 'admin', 'www'}
2025-12-03 16:32:54,085 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 16:32:54,284 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 16:32:54,288 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 16:32:54,290 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 16:32:54,290 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 16:32:54,291 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 16:32:54,291 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 16:32:54,291 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=9b8ab97c-89d4-41dc-8bbf-54d193edbe02, DEFAULT_TYPE=single
2025-12-03 16:32:54,537 - app.core.security.rate_limiting - INFO - [RATE_LIMITING] Activado. Límites: Login=10/minute, API=200/minute
2025-12-03 16:32:54,538 - app.core.security.rate_limiting - INFO - ✅ Módulo de rate limiting cargado y activo
2025-12-03 16:32:54,637 - app.core.authorization.rbac - INFO - 🔐 Inicializando sistema de autorización...
2025-12-03 16:32:54,637 - app.core.authorization.rbac - INFO - ✅ Sistema de autorización inicializado correctamente
2025-12-03 16:32:54,637 - app.core.authorization.rbac - INFO - 📊 Permisos del sistema: 6 módulos configurados
2025-12-03 16:32:54,820 - app.core.tenant.middleware - INFO - Módulo tenant_middleware cargado (versión híbrida con soporte para proxies)
2025-12-03 16:32:54,822 - app.main - INFO - ✅ Rate limiting configurado y activo
2025-12-03 16:33:21,847 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 16:33:22,039 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 16:33:22,044 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 16:33:22,045 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 16:33:22,047 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 16:33:22,047 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 16:33:22,047 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 16:33:22,047 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=9b8ab97c-89d4-41dc-8bbf-54d193edbe02, DEFAULT_TYPE=single
2025-12-03 16:33:22,290 - app.core.security.rate_limiting - INFO - [RATE_LIMITING] Activado. Límites: Login=10/minute, API=200/minute
2025-12-03 16:33:22,290 - app.core.security.rate_limiting - INFO - ✅ Módulo de rate limiting cargado y activo
2025-12-03 16:33:22,394 - app.core.authorization.rbac - INFO - 🔐 Inicializando sistema de autorización...
2025-12-03 16:33:22,394 - app.core.authorization.rbac - INFO - ✅ Sistema de autorización inicializado correctamente
2025-12-03 16:33:22,394 - app.core.authorization.rbac - INFO - 📊 Permisos del sistema: 6 módulos configurados
2025-12-03 16:33:22,549 - app.core.tenant.middleware - INFO - Módulo tenant_middleware cargado (versión híbrida con soporte para proxies)
2025-12-03 16:33:22,549 - app.main - INFO - ✅ Rate limiting configurado y activo
2025-12-03 16:33:37,060 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Pool ADMIN inicializado. Size=10, MaxOverflow=5
2025-12-03 16:33:37,062 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Configuración de pools de tenants: MaxPools=50, PoolSize=3, MaxOverflow=2, InactivityTimeout=3600s
2025-12-03 16:33:37,064 - app.infrastructure.database.connection_pool - INFO - ✅ Módulo de connection pooling cargado y activo
2025-12-03 16:33:37,065 - app.infrastructure.database.connection_pool - INFO -    Configuración: MaxTenantPools=50, TenantPoolSize=3, InactivityTimeout=3600s
2025-12-03 16:33:37,066 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Todos los pools cerrados
2025-12-03 16:33:37,066 - app.main - INFO - ✅ Pools de conexión cerrados correctamente
2025-12-03 16:33:37,920 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 16:33:38,086 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 16:33:38,112 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 16:33:38,122 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 16:33:38,122 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 16:33:38,122 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 16:33:38,122 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 16:33:38,122 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=9b8ab97c-89d4-41dc-8bbf-54d193edbe02, DEFAULT_TYPE=single
2025-12-03 16:33:38,434 - app.core.security.rate_limiting - INFO - [RATE_LIMITING] Activado. Límites: Login=10/minute, API=200/minute
2025-12-03 16:33:38,434 - app.core.security.rate_limiting - INFO - ✅ Módulo de rate limiting cargado y activo
2025-12-03 16:33:38,503 - app.core.authorization.rbac - INFO - 🔐 Inicializando sistema de autorización...
2025-12-03 16:33:38,503 - app.core.authorization.rbac - INFO - ✅ Sistema de autorización inicializado correctamente
2025-12-03 16:33:38,503 - app.core.authorization.rbac - INFO - 📊 Permisos del sistema: 6 módulos configurados
2025-12-03 16:33:38,656 - app.core.tenant.middleware - INFO - Módulo tenant_middleware cargado (versión híbrida con soporte para proxies)
2025-12-03 16:33:38,656 - app.main - INFO - ✅ Rate limiting configurado y activo
2025-12-03 16:33:38,799 - app.core.tenant.middleware - INFO - [TENANT_MW] Inicializado - BASE_DOMAIN=app.local, SYSTEM_ID=9B8AB97C-89D4-41DC-8BBF-54D193EDBE02, EXCLUDED_SUBDOMAINS={'admin', 'static', 'api', 'cdn', 'assets', 'www', 'backend'}
2025-12-03 16:33:44,423 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/refresh/
2025-12-03 16:33:44,423 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 16:33:44,423 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 16:33:44,424 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 16:33:44,424 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 16:33:44,424 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 16:33:44,424 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 16:33:44,424 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 16:33:44,424 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 16:33:44,424 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: 9b8ab97c-89d4-41dc-8bbf-54d193edbe02
2025-12-03 16:33:44,424 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 16:33:44,424 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=9b8ab97c-89d4-41dc-8bbf-54d193edbe02, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/auth/refresh/
2025-12-03 16:33:44,431 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] AsyncEngine creado para admin
2025-12-03 16:33:44,431 - app.modules.auth.application.services.refresh_token_service - ERROR - [VALIDATE-TOKEN] Error inesperado validando refresh token: the greenlet library is required to use this function. No module named 'greenlet._greenlet'
Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 125, in execute_query
    result = await session.execute(query)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 449, in execute
    result = await greenlet_spawn(
                   ^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\concurrency.py", line 101, in greenlet_spawn
    _not_implemented()
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\concurrency.py", line 81, in _not_implemented
    raise ValueError(
ValueError: the greenlet library is required to use this function. No module named 'greenlet._greenlet'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\connection_async.py", line 303, in get_db_connection
    yield session
  File "D:\base_multi_tenant_fastapi\app\core\tenant\routing.py", line 672, in get_connection_for_tenant
    yield session
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 130, in execute_query
    await session.rollback()
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 990, in rollback
    await greenlet_spawn(self.sync_session.rollback)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\concurrency.py", line 101, in greenlet_spawn
    _not_implemented()
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\concurrency.py", line 81, in _not_implemented
    raise ValueError(
ValueError: the greenlet library is required to use this function. No module named 'greenlet._greenlet'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\modules\auth\application\services\refresh_token_service.py", line 218, in validate_refresh_token
    result = await execute_query(
             ^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 123, in execute_query
    async with _get_connection_context(connection_type, client_id) as session:
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\contextlib.py", line 231, in __aexit__
    await self.gen.athrow(value)
  File "D:\base_multi_tenant_fastapi\app\core\tenant\routing.py", line 671, in get_connection_for_tenant
    async with get_db_connection(DatabaseConnection.ADMIN) as session:
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\contextlib.py", line 231, in __aexit__
    await self.gen.athrow(value)
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\connection_async.py", line 301, in get_db_connection
    async with async_session() as session:
               ^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 1071, in __aexit__
    await asyncio.shield(task)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 1016, in close
    await greenlet_spawn(self.sync_session.close)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\concurrency.py", line 101, in greenlet_spawn
    _not_implemented()
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\concurrency.py", line 81, in _not_implemented
    raise ValueError(
ValueError: the greenlet library is required to use this function. No module named 'greenlet._greenlet'
2025-12-03 16:33:44,437 - app.core.application.base_service - ERROR - DatabaseError en validate_refresh_token: Error al validar el refresh token
Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 125, in execute_query
    result = await session.execute(query)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 449, in execute
    result = await greenlet_spawn(
                   ^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\concurrency.py", line 101, in greenlet_spawn
    _not_implemented()
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\concurrency.py", line 81, in _not_implemented
    raise ValueError(
ValueError: the greenlet library is required to use this function. No module named 'greenlet._greenlet'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\connection_async.py", line 303, in get_db_connection
    yield session
  File "D:\base_multi_tenant_fastapi\app\core\tenant\routing.py", line 672, in get_connection_for_tenant
    yield session
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 130, in execute_query
    await session.rollback()
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 990, in rollback
    await greenlet_spawn(self.sync_session.rollback)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\concurrency.py", line 101, in greenlet_spawn
    _not_implemented()
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\concurrency.py", line 81, in _not_implemented
    raise ValueError(
ValueError: the greenlet library is required to use this function. No module named 'greenlet._greenlet'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\modules\auth\application\services\refresh_token_service.py", line 218, in validate_refresh_token
    result = await execute_query(
             ^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 123, in execute_query
    async with _get_connection_context(connection_type, client_id) as session:
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\contextlib.py", line 231, in __aexit__
    await self.gen.athrow(value)
  File "D:\base_multi_tenant_fastapi\app\core\tenant\routing.py", line 671, in get_connection_for_tenant
    async with get_db_connection(DatabaseConnection.ADMIN) as session:
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\contextlib.py", line 231, in __aexit__
    await self.gen.athrow(value)
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\connection_async.py", line 301, in get_db_connection
    async with async_session() as session:
               ^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 1071, in __aexit__
    await asyncio.shield(task)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 1016, in close
    await greenlet_spawn(self.sync_session.close)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\concurrency.py", line 101, in greenlet_spawn
    _not_implemented()
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\concurrency.py", line 81, in _not_implemented
    raise ValueError(
ValueError: the greenlet library is required to use this function. No module named 'greenlet._greenlet'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\core\application\base_service.py", line 52, in wrapper
    return await func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\modules\auth\application\services\refresh_token_service.py", line 242, in validate_refresh_token
    raise DatabaseError(
app.core.exceptions.DatabaseError: Error al validar el refresh token
2025-12-03 16:33:44,440 - app.modules.auth.application.services.auth_service - ERROR - Error validando refresh token: Error al validar el refresh token
Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 125, in execute_query
    result = await session.execute(query)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 449, in execute
    result = await greenlet_spawn(
                   ^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\concurrency.py", line 101, in greenlet_spawn
    _not_implemented()
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\concurrency.py", line 81, in _not_implemented
    raise ValueError(
ValueError: the greenlet library is required to use this function. No module named 'greenlet._greenlet'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\connection_async.py", line 303, in get_db_connection
    yield session
  File "D:\base_multi_tenant_fastapi\app\core\tenant\routing.py", line 672, in get_connection_for_tenant
    yield session
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 130, in execute_query
    await session.rollback()
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 990, in rollback
    await greenlet_spawn(self.sync_session.rollback)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\concurrency.py", line 101, in greenlet_spawn
    _not_implemented()
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\concurrency.py", line 81, in _not_implemented
    raise ValueError(
ValueError: the greenlet library is required to use this function. No module named 'greenlet._greenlet'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\modules\auth\application\services\refresh_token_service.py", line 218, in validate_refresh_token
    result = await execute_query(
             ^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 123, in execute_query
    async with _get_connection_context(connection_type, client_id) as session:
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\contextlib.py", line 231, in __aexit__
    await self.gen.athrow(value)
  File "D:\base_multi_tenant_fastapi\app\core\tenant\routing.py", line 671, in get_connection_for_tenant
    async with get_db_connection(DatabaseConnection.ADMIN) as session:
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\contextlib.py", line 231, in __aexit__
    await self.gen.athrow(value)
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\connection_async.py", line 301, in get_db_connection
    async with async_session() as session:
               ^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 1071, in __aexit__
    await asyncio.shield(task)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 1016, in close
    await greenlet_spawn(self.sync_session.close)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\concurrency.py", line 101, in greenlet_spawn
    _not_implemented()
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\concurrency.py", line 81, in _not_implemented
    raise ValueError(
ValueError: the greenlet library is required to use this function. No module named 'greenlet._greenlet'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\modules\auth\application\services\auth_service.py", line 452, in get_current_user_from_refresh
    db_token_data = await RefreshTokenService.validate_refresh_token(refresh_token)
                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\core\application\base_service.py", line 52, in wrapper
    return await func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\modules\auth\application\services\refresh_token_service.py", line 242, in validate_refresh_token
    raise DatabaseError(
app.core.exceptions.DatabaseError: Error al validar el refresh token
2025-12-03 16:33:44,442 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/refresh/ 401 20.1ms
2025-12-03 16:34:40,192 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Pool ADMIN inicializado. Size=10, MaxOverflow=5
2025-12-03 16:34:40,192 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Configuración de pools de tenants: MaxPools=50, PoolSize=3, MaxOverflow=2, InactivityTimeout=3600s
2025-12-03 16:34:40,193 - app.infrastructure.database.connection_pool - INFO - ✅ Módulo de connection pooling cargado y activo
2025-12-03 16:34:40,193 - app.infrastructure.database.connection_pool - INFO -    Configuración: MaxTenantPools=50, TenantPoolSize=3, InactivityTimeout=3600s
2025-12-03 16:34:40,193 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Todos los pools cerrados
2025-12-03 16:34:40,193 - app.main - INFO - ✅ Pools de conexión cerrados correctamente
2025-12-03 16:34:41,068 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 16:34:41,287 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 16:34:41,287 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 16:34:41,287 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 16:34:41,287 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 16:34:41,308 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 16:34:41,308 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 16:34:41,308 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=9b8ab97c-89d4-41dc-8bbf-54d193edbe02, DEFAULT_TYPE=single
2025-12-03 16:34:41,659 - app.core.security.rate_limiting - INFO - [RATE_LIMITING] Activado. Límites: Login=10/minute, API=200/minute
2025-12-03 16:34:41,659 - app.core.security.rate_limiting - INFO - ✅ Módulo de rate limiting cargado y activo
2025-12-03 16:34:41,763 - app.core.authorization.rbac - INFO - 🔐 Inicializando sistema de autorización...
2025-12-03 16:34:41,763 - app.core.authorization.rbac - INFO - ✅ Sistema de autorización inicializado correctamente
2025-12-03 16:34:41,763 - app.core.authorization.rbac - INFO - 📊 Permisos del sistema: 6 módulos configurados
2025-12-03 16:34:42,008 - app.core.tenant.middleware - INFO - Módulo tenant_middleware cargado (versión híbrida con soporte para proxies)
2025-12-03 16:34:42,009 - app.main - INFO - ✅ Rate limiting configurado y activo
2025-12-03 16:34:42,201 - app.core.tenant.middleware - INFO - [TENANT_MW] Inicializado - BASE_DOMAIN=app.local, SYSTEM_ID=9B8AB97C-89D4-41DC-8BBF-54D193EDBE02, EXCLUDED_SUBDOMAINS={'admin', 'api', 'static', 'backend', 'www', 'cdn', 'assets'}
2025-12-03 16:34:45,652 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/login/
2025-12-03 16:34:45,652 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 16:34:45,652 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 16:34:45,652 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 16:34:45,654 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 16:34:45,654 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 16:34:45,654 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 16:34:45,654 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 16:34:45,654 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 16:34:45,654 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: 9b8ab97c-89d4-41dc-8bbf-54d193edbe02
2025-12-03 16:34:45,654 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 16:34:45,655 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=9b8ab97c-89d4-41dc-8bbf-54d193edbe02, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/auth/login/
2025-12-03 16:34:45,657 - app.core.application.base_service - ERROR - ERROR INESPERADO en obtener_cliente_por_id: the greenlet library is required to use this function. No module named 'greenlet._greenlet'
Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 125, in execute_query
    result = await session.execute(query)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 449, in execute
    result = await greenlet_spawn(
                   ^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\concurrency.py", line 101, in greenlet_spawn
    _not_implemented()
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\concurrency.py", line 81, in _not_implemented
    raise ValueError(
ValueError: the greenlet library is required to use this function. No module named 'greenlet._greenlet'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\connection_async.py", line 303, in get_db_connection
    yield session
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 130, in execute_query
    await session.rollback()
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 990, in rollback
    await greenlet_spawn(self.sync_session.rollback)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\concurrency.py", line 101, in greenlet_spawn
    _not_implemented()
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\concurrency.py", line 81, in _not_implemented
    raise ValueError(
ValueError: the greenlet library is required to use this function. No module named 'greenlet._greenlet'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\core\application\base_service.py", line 52, in wrapper
    return await func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\modules\tenant\application\services\cliente_service.py", line 187, in obtener_cliente_por_id
    resultado = await execute_query(
                ^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 123, in execute_query
    async with _get_connection_context(connection_type, client_id) as session:
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\contextlib.py", line 231, in __aexit__
    await self.gen.athrow(value)
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\connection_async.py", line 301, in get_db_connection
    async with async_session() as session:
               ^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 1071, in __aexit__
    await asyncio.shield(task)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 1016, in close
    await greenlet_spawn(self.sync_session.close)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\concurrency.py", line 101, in greenlet_spawn
    _not_implemented()
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\concurrency.py", line 81, in _not_implemented
    raise ValueError(
ValueError: the greenlet library is required to use this function. No module named 'greenlet._greenlet'
2025-12-03 16:34:45,660 - app.modules.auth.presentation.endpoints - ERROR - Error inesperado en /login/ para usuario superadmin: Error interno del servidor en obtener_cliente_por_id
Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 125, in execute_query
    result = await session.execute(query)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 449, in execute
    result = await greenlet_spawn(
                   ^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\concurrency.py", line 101, in greenlet_spawn
    _not_implemented()
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\concurrency.py", line 81, in _not_implemented
    raise ValueError(
ValueError: the greenlet library is required to use this function. No module named 'greenlet._greenlet'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\connection_async.py", line 303, in get_db_connection
    yield session
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 130, in execute_query
    await session.rollback()
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 990, in rollback
    await greenlet_spawn(self.sync_session.rollback)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\concurrency.py", line 101, in greenlet_spawn
    _not_implemented()
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\concurrency.py", line 81, in _not_implemented
    raise ValueError(
ValueError: the greenlet library is required to use this function. No module named 'greenlet._greenlet'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\core\application\base_service.py", line 52, in wrapper
    return await func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\modules\tenant\application\services\cliente_service.py", line 187, in obtener_cliente_por_id
    resultado = await execute_query(
                ^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 123, in execute_query
    async with _get_connection_context(connection_type, client_id) as session:
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\contextlib.py", line 231, in __aexit__
    await self.gen.athrow(value)
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\connection_async.py", line 301, in get_db_connection
    async with async_session() as session:
               ^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 1071, in __aexit__
    await asyncio.shield(task)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 1016, in close
    await greenlet_spawn(self.sync_session.close)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\concurrency.py", line 101, in greenlet_spawn
    _not_implemented()
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\concurrency.py", line 81, in _not_implemented
    raise ValueError(
ValueError: the greenlet library is required to use this function. No module named 'greenlet._greenlet'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\modules\auth\presentation\endpoints.py", line 134, in login
    cliente = await ClienteService.obtener_cliente_por_id(cliente_id)
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\core\application\base_service.py", line 69, in wrapper
    raise ServiceError(
app.core.exceptions.ServiceError: Error interno del servidor en obtener_cliente_por_id
2025-12-03 16:34:45,664 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/login/ 500 11.2ms
2025-12-03 16:38:26,045 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 16:38:26,288 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 16:38:26,294 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 16:38:26,296 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 16:38:26,296 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 16:38:26,296 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 16:38:26,296 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 16:38:26,296 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=9b8ab97c-89d4-41dc-8bbf-54d193edbe02, DEFAULT_TYPE=single
2025-12-03 16:38:26,557 - app.core.security.rate_limiting - INFO - [RATE_LIMITING] Activado. Límites: Login=10/minute, API=200/minute
2025-12-03 16:38:26,557 - app.core.security.rate_limiting - INFO - ✅ Módulo de rate limiting cargado y activo
2025-12-03 16:38:26,667 - app.core.authorization.rbac - INFO - 🔐 Inicializando sistema de autorización...
2025-12-03 16:38:26,667 - app.core.authorization.rbac - INFO - ✅ Sistema de autorización inicializado correctamente
2025-12-03 16:38:26,667 - app.core.authorization.rbac - INFO - 📊 Permisos del sistema: 6 módulos configurados
2025-12-03 16:38:26,823 - app.core.tenant.middleware - INFO - Módulo tenant_middleware cargado (versión híbrida con soporte para proxies)
2025-12-03 16:38:26,824 - app.main - INFO - ✅ Rate limiting configurado y activo
2025-12-03 16:38:37,481 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Pool ADMIN inicializado. Size=10, MaxOverflow=5
2025-12-03 16:38:37,481 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Configuración de pools de tenants: MaxPools=50, PoolSize=3, MaxOverflow=2, InactivityTimeout=3600s
2025-12-03 16:38:37,481 - app.infrastructure.database.connection_pool - INFO - ✅ Módulo de connection pooling cargado y activo
2025-12-03 16:38:37,481 - app.infrastructure.database.connection_pool - INFO -    Configuración: MaxTenantPools=50, TenantPoolSize=3, InactivityTimeout=3600s
2025-12-03 16:38:37,481 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Todos los pools cerrados
2025-12-03 16:38:37,481 - app.main - INFO - ✅ Pools de conexión cerrados correctamente
2025-12-03 16:38:38,371 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 16:38:38,642 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 16:38:38,651 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 16:38:38,653 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 16:38:38,653 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 16:38:38,654 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 16:38:38,654 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 16:38:38,654 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=9b8ab97c-89d4-41dc-8bbf-54d193edbe02, DEFAULT_TYPE=single
2025-12-03 16:38:39,080 - app.core.security.rate_limiting - INFO - [RATE_LIMITING] Activado. Límites: Login=10/minute, API=200/minute
2025-12-03 16:38:39,080 - app.core.security.rate_limiting - INFO - ✅ Módulo de rate limiting cargado y activo
2025-12-03 16:38:39,178 - app.core.authorization.rbac - INFO - 🔐 Inicializando sistema de autorización...
2025-12-03 16:38:39,178 - app.core.authorization.rbac - INFO - ✅ Sistema de autorización inicializado correctamente
2025-12-03 16:38:39,178 - app.core.authorization.rbac - INFO - 📊 Permisos del sistema: 6 módulos configurados
2025-12-03 16:38:39,418 - app.core.tenant.middleware - INFO - Módulo tenant_middleware cargado (versión híbrida con soporte para proxies)
2025-12-03 16:38:39,418 - app.main - INFO - ✅ Rate limiting configurado y activo
2025-12-03 16:38:39,590 - app.core.tenant.middleware - INFO - [TENANT_MW] Inicializado - BASE_DOMAIN=app.local, SYSTEM_ID=9B8AB97C-89D4-41DC-8BBF-54D193EDBE02, EXCLUDED_SUBDOMAINS={'api', 'static', 'backend', 'admin', 'www', 'cdn', 'assets'}
2025-12-03 16:38:47,738 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/refresh/
2025-12-03 16:38:47,738 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 16:38:47,738 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 16:38:47,738 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 16:38:47,738 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 16:38:47,738 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 16:38:47,741 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 16:38:47,741 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 16:38:47,741 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 16:38:47,741 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: 9b8ab97c-89d4-41dc-8bbf-54d193edbe02
2025-12-03 16:38:47,741 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 16:38:47,741 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=9b8ab97c-89d4-41dc-8bbf-54d193edbe02, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/auth/refresh/
2025-12-03 16:38:47,749 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] AsyncEngine creado para admin
2025-12-03 16:38:47,921 - app.infrastructure.database.queries_async - ERROR - Error en execute_query async (TextClause): (pyodbc.DataError) ('22018', '[22018] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Operand type clash: uniqueidentifier is incompatible with int (206) (SQLExecDirectW); [22018] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Statement(s) could not be prepared. (8180)')
[SQL: 
SELECT 
    token_id, usuario_id, token_hash, expires_at, 
    is_revoked, created_at, client_type, cliente_id
FROM refresh_tokens
WHERE token_hash = ? AND cliente_id = ? AND is_revoked = 0 AND expires_at > GETDATE();
]
[parameters: ('90ac19a737e5b9e3dc01716c66d6046229dc8cce0a249edb46897c44d9824f36', UUID('9b8ab97c-89d4-41dc-8bbf-54d193edbe02'))]
(Background on this error at: https://sqlalche.me/e/20/9h9h)
2025-12-03 16:38:47,921 - app.infrastructure.database.connection_async - ERROR - [ASYNC_CONNECTION] Error en sesión async: Error en la consulta: (pyodbc.DataError) ('22018', '[22018] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Operand type clash: uniqueidentifier is incompatible with int (206) (SQLExecDirectW); [22018] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Statement(s) could not be prepared. (8180)')
[SQL: 
SELECT 
    token_id, usuario_id, token_hash, expires_at, 
    is_revoked, created_at, client_type, cliente_id
FROM refresh_tokens
WHERE token_hash = ? AND cliente_id = ? AND is_revoked = 0 AND expires_at > GETDATE();
]
[parameters: ('90ac19a737e5b9e3dc01716c66d6046229dc8cce0a249edb46897c44d9824f36', UUID('9b8ab97c-89d4-41dc-8bbf-54d193edbe02'))]
(Background on this error at: https://sqlalche.me/e/20/9h9h)
Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 230, in execute
    self._adapt_connection._handle_exception(error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 368, in _handle_exception
    raise error.with_traceback(exc_info[2])
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 228, in execute
    return self.await_(self._execute_async(operation, parameters))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 251, in _execute_async
    result = await self._cursor.execute(operation, parameters)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 132, in execute
    await self._run_operation(self._impl.execute, sql, *params)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 30, in _run_operation
    result = await self._conn._execute(func, *args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\concurrent\futures\thread.py", line 59, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
pyodbc.DataError: ('22018', '[22018] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Operand type clash: uniqueidentifier is incompatible with int (206) (SQLExecDirectW); [22018] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Statement(s) could not be prepared. (8180)')

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 125, in execute_query
    result = await session.execute(query)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 449, in execute
    result = await greenlet_spawn(
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 203, in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2351, in execute
    return self._execute_internal(
           ^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2258, in _execute_internal
    result = conn.execute(
             ^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1419, in execute
    return meth(
           ^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\sql\elements.py", line 526, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1641, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1846, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1986, in _exec_single_context
    self._handle_dbapi_exception(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 2355, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 230, in execute
    self._adapt_connection._handle_exception(error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 368, in _handle_exception
    raise error.with_traceback(exc_info[2])
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 228, in execute
    return self.await_(self._execute_async(operation, parameters))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 251, in _execute_async
    result = await self._cursor.execute(operation, parameters)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 132, in execute
    await self._run_operation(self._impl.execute, sql, *params)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 30, in _run_operation
    result = await self._conn._execute(func, *args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\concurrent\futures\thread.py", line 59, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
sqlalchemy.exc.DataError: (pyodbc.DataError) ('22018', '[22018] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Operand type clash: uniqueidentifier is incompatible with int (206) (SQLExecDirectW); [22018] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Statement(s) could not be prepared. (8180)')
[SQL: 
SELECT 
    token_id, usuario_id, token_hash, expires_at, 
    is_revoked, created_at, client_type, cliente_id
FROM refresh_tokens
WHERE token_hash = ? AND cliente_id = ? AND is_revoked = 0 AND expires_at > GETDATE();
]
[parameters: ('90ac19a737e5b9e3dc01716c66d6046229dc8cce0a249edb46897c44d9824f36', UUID('9b8ab97c-89d4-41dc-8bbf-54d193edbe02'))]
(Background on this error at: https://sqlalche.me/e/20/9h9h)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\connection_async.py", line 303, in get_db_connection
    yield session
  File "D:\base_multi_tenant_fastapi\app\core\tenant\routing.py", line 672, in get_connection_for_tenant
    yield session
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 132, in execute_query
    raise DatabaseError(
app.core.exceptions.DatabaseError: Error en la consulta: (pyodbc.DataError) ('22018', '[22018] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Operand type clash: uniqueidentifier is incompatible with int (206) (SQLExecDirectW); [22018] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Statement(s) could not be prepared. (8180)')
[SQL: 
SELECT 
    token_id, usuario_id, token_hash, expires_at, 
    is_revoked, created_at, client_type, cliente_id
FROM refresh_tokens
WHERE token_hash = ? AND cliente_id = ? AND is_revoked = 0 AND expires_at > GETDATE();
]
[parameters: ('90ac19a737e5b9e3dc01716c66d6046229dc8cce0a249edb46897c44d9824f36', UUID('9b8ab97c-89d4-41dc-8bbf-54d193edbe02'))]
(Background on this error at: https://sqlalche.me/e/20/9h9h)
2025-12-03 16:38:48,003 - app.core.application.base_service - ERROR - DatabaseError en validate_refresh_token: Error en la consulta: (pyodbc.DataError) ('22018', '[22018] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Operand type clash: uniqueidentifier is incompatible with int (206) (SQLExecDirectW); [22018] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Statement(s) could not be prepared. (8180)')
[SQL: 
SELECT 
    token_id, usuario_id, token_hash, expires_at, 
    is_revoked, created_at, client_type, cliente_id
FROM refresh_tokens
WHERE token_hash = ? AND cliente_id = ? AND is_revoked = 0 AND expires_at > GETDATE();
]
[parameters: ('90ac19a737e5b9e3dc01716c66d6046229dc8cce0a249edb46897c44d9824f36', UUID('9b8ab97c-89d4-41dc-8bbf-54d193edbe02'))]
(Background on this error at: https://sqlalche.me/e/20/9h9h)
Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 230, in execute
    self._adapt_connection._handle_exception(error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 368, in _handle_exception
    raise error.with_traceback(exc_info[2])
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 228, in execute
    return self.await_(self._execute_async(operation, parameters))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 251, in _execute_async
    result = await self._cursor.execute(operation, parameters)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 132, in execute
    await self._run_operation(self._impl.execute, sql, *params)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 30, in _run_operation
    result = await self._conn._execute(func, *args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\concurrent\futures\thread.py", line 59, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
pyodbc.DataError: ('22018', '[22018] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Operand type clash: uniqueidentifier is incompatible with int (206) (SQLExecDirectW); [22018] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Statement(s) could not be prepared. (8180)')

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 125, in execute_query
    result = await session.execute(query)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 449, in execute
    result = await greenlet_spawn(
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 203, in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2351, in execute
    return self._execute_internal(
           ^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2258, in _execute_internal
    result = conn.execute(
             ^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1419, in execute
    return meth(
           ^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\sql\elements.py", line 526, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1641, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1846, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1986, in _exec_single_context
    self._handle_dbapi_exception(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 2355, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 230, in execute
    self._adapt_connection._handle_exception(error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 368, in _handle_exception
    raise error.with_traceback(exc_info[2])
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 228, in execute
    return self.await_(self._execute_async(operation, parameters))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 251, in _execute_async
    result = await self._cursor.execute(operation, parameters)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 132, in execute
    await self._run_operation(self._impl.execute, sql, *params)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 30, in _run_operation
    result = await self._conn._execute(func, *args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\concurrent\futures\thread.py", line 59, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
sqlalchemy.exc.DataError: (pyodbc.DataError) ('22018', '[22018] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Operand type clash: uniqueidentifier is incompatible with int (206) (SQLExecDirectW); [22018] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Statement(s) could not be prepared. (8180)')
[SQL: 
SELECT 
    token_id, usuario_id, token_hash, expires_at, 
    is_revoked, created_at, client_type, cliente_id
FROM refresh_tokens
WHERE token_hash = ? AND cliente_id = ? AND is_revoked = 0 AND expires_at > GETDATE();
]
[parameters: ('90ac19a737e5b9e3dc01716c66d6046229dc8cce0a249edb46897c44d9824f36', UUID('9b8ab97c-89d4-41dc-8bbf-54d193edbe02'))]
(Background on this error at: https://sqlalche.me/e/20/9h9h)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\core\application\base_service.py", line 52, in wrapper
    return await func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\modules\auth\application\services\refresh_token_service.py", line 218, in validate_refresh_token
    result = await execute_query(
             ^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 132, in execute_query
    raise DatabaseError(
app.core.exceptions.DatabaseError: Error en la consulta: (pyodbc.DataError) ('22018', '[22018] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Operand type clash: uniqueidentifier is incompatible with int (206) (SQLExecDirectW); [22018] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Statement(s) could not be prepared. (8180)')
[SQL: 
SELECT 
    token_id, usuario_id, token_hash, expires_at, 
    is_revoked, created_at, client_type, cliente_id
FROM refresh_tokens
WHERE token_hash = ? AND cliente_id = ? AND is_revoked = 0 AND expires_at > GETDATE();
]
[parameters: ('90ac19a737e5b9e3dc01716c66d6046229dc8cce0a249edb46897c44d9824f36', UUID('9b8ab97c-89d4-41dc-8bbf-54d193edbe02'))]
(Background on this error at: https://sqlalche.me/e/20/9h9h)
2025-12-03 16:38:48,011 - app.modules.auth.application.services.auth_service - ERROR - Error validando refresh token: Error en la consulta: (pyodbc.DataError) ('22018', '[22018] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Operand type clash: uniqueidentifier is incompatible with int (206) (SQLExecDirectW); [22018] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Statement(s) could not be prepared. (8180)')
[SQL: 
SELECT 
    token_id, usuario_id, token_hash, expires_at, 
    is_revoked, created_at, client_type, cliente_id
FROM refresh_tokens
WHERE token_hash = ? AND cliente_id = ? AND is_revoked = 0 AND expires_at > GETDATE();
]
[parameters: ('90ac19a737e5b9e3dc01716c66d6046229dc8cce0a249edb46897c44d9824f36', UUID('9b8ab97c-89d4-41dc-8bbf-54d193edbe02'))]
(Background on this error at: https://sqlalche.me/e/20/9h9h)
Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 230, in execute
    self._adapt_connection._handle_exception(error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 368, in _handle_exception
    raise error.with_traceback(exc_info[2])
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 228, in execute
    return self.await_(self._execute_async(operation, parameters))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 251, in _execute_async
    result = await self._cursor.execute(operation, parameters)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 132, in execute
    await self._run_operation(self._impl.execute, sql, *params)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 30, in _run_operation
    result = await self._conn._execute(func, *args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\concurrent\futures\thread.py", line 59, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
pyodbc.DataError: ('22018', '[22018] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Operand type clash: uniqueidentifier is incompatible with int (206) (SQLExecDirectW); [22018] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Statement(s) could not be prepared. (8180)')

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 125, in execute_query
    result = await session.execute(query)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 449, in execute
    result = await greenlet_spawn(
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 203, in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2351, in execute
    return self._execute_internal(
           ^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2258, in _execute_internal
    result = conn.execute(
             ^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1419, in execute
    return meth(
           ^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\sql\elements.py", line 526, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1641, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1846, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1986, in _exec_single_context
    self._handle_dbapi_exception(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 2355, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 230, in execute
    self._adapt_connection._handle_exception(error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 368, in _handle_exception
    raise error.with_traceback(exc_info[2])
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 228, in execute
    return self.await_(self._execute_async(operation, parameters))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 251, in _execute_async
    result = await self._cursor.execute(operation, parameters)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 132, in execute
    await self._run_operation(self._impl.execute, sql, *params)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 30, in _run_operation
    result = await self._conn._execute(func, *args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\concurrent\futures\thread.py", line 59, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
sqlalchemy.exc.DataError: (pyodbc.DataError) ('22018', '[22018] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Operand type clash: uniqueidentifier is incompatible with int (206) (SQLExecDirectW); [22018] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Statement(s) could not be prepared. (8180)')
[SQL: 
SELECT 
    token_id, usuario_id, token_hash, expires_at, 
    is_revoked, created_at, client_type, cliente_id
FROM refresh_tokens
WHERE token_hash = ? AND cliente_id = ? AND is_revoked = 0 AND expires_at > GETDATE();
]
[parameters: ('90ac19a737e5b9e3dc01716c66d6046229dc8cce0a249edb46897c44d9824f36', UUID('9b8ab97c-89d4-41dc-8bbf-54d193edbe02'))]
(Background on this error at: https://sqlalche.me/e/20/9h9h)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\modules\auth\application\services\auth_service.py", line 452, in get_current_user_from_refresh
    db_token_data = await RefreshTokenService.validate_refresh_token(refresh_token)
                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\core\application\base_service.py", line 52, in wrapper
    return await func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\modules\auth\application\services\refresh_token_service.py", line 218, in validate_refresh_token
    result = await execute_query(
             ^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 132, in execute_query
    raise DatabaseError(
app.core.exceptions.DatabaseError: Error en la consulta: (pyodbc.DataError) ('22018', '[22018] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Operand type clash: uniqueidentifier is incompatible with int (206) (SQLExecDirectW); [22018] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Statement(s) could not be prepared. (8180)')
[SQL: 
SELECT 
    token_id, usuario_id, token_hash, expires_at, 
    is_revoked, created_at, client_type, cliente_id
FROM refresh_tokens
WHERE token_hash = ? AND cliente_id = ? AND is_revoked = 0 AND expires_at > GETDATE();
]
[parameters: ('90ac19a737e5b9e3dc01716c66d6046229dc8cce0a249edb46897c44d9824f36', UUID('9b8ab97c-89d4-41dc-8bbf-54d193edbe02'))]
(Background on this error at: https://sqlalche.me/e/20/9h9h)
2025-12-03 16:38:48,015 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/refresh/ 401 276.8ms
2025-12-03 16:39:40,611 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Pool ADMIN inicializado. Size=10, MaxOverflow=5
2025-12-03 16:39:40,611 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Configuración de pools de tenants: MaxPools=50, PoolSize=3, MaxOverflow=2, InactivityTimeout=3600s
2025-12-03 16:39:40,611 - app.infrastructure.database.connection_pool - INFO - ✅ Módulo de connection pooling cargado y activo
2025-12-03 16:39:40,611 - app.infrastructure.database.connection_pool - INFO -    Configuración: MaxTenantPools=50, TenantPoolSize=3, InactivityTimeout=3600s
2025-12-03 16:39:40,612 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Todos los pools cerrados
2025-12-03 16:39:40,612 - app.main - INFO - ✅ Pools de conexión cerrados correctamente
2025-12-03 16:39:41,596 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 16:39:41,835 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 16:39:41,844 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 16:39:41,849 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 16:39:41,849 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 16:39:41,849 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 16:39:41,849 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 16:39:41,849 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=9b8ab97c-89d4-41dc-8bbf-54d193edbe02, DEFAULT_TYPE=single
2025-12-03 16:39:42,274 - app.core.security.rate_limiting - INFO - [RATE_LIMITING] Activado. Límites: Login=10/minute, API=200/minute
2025-12-03 16:39:42,274 - app.core.security.rate_limiting - INFO - ✅ Módulo de rate limiting cargado y activo
2025-12-03 16:39:42,372 - app.core.authorization.rbac - INFO - 🔐 Inicializando sistema de autorización...
2025-12-03 16:39:42,372 - app.core.authorization.rbac - INFO - ✅ Sistema de autorización inicializado correctamente
2025-12-03 16:39:42,372 - app.core.authorization.rbac - INFO - 📊 Permisos del sistema: 6 módulos configurados
2025-12-03 16:39:42,582 - app.core.tenant.middleware - INFO - Módulo tenant_middleware cargado (versión híbrida con soporte para proxies)
2025-12-03 16:39:42,582 - app.main - INFO - ✅ Rate limiting configurado y activo
2025-12-03 16:39:42,741 - app.core.tenant.middleware - INFO - [TENANT_MW] Inicializado - BASE_DOMAIN=app.local, SYSTEM_ID=9B8AB97C-89D4-41DC-8BBF-54D193EDBE02, EXCLUDED_SUBDOMAINS={'assets', 'cdn', 'static', 'admin', 'backend', 'api', 'www'}
2025-12-03 16:40:33,763 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/auth/login/
2025-12-03 16:40:33,764 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/auth/login/ 200 0.5ms
2025-12-03 16:40:33,765 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/login/
2025-12-03 16:40:33,766 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 16:40:33,766 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 16:40:33,766 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 16:40:33,766 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 16:40:33,766 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 16:40:33,766 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 16:40:33,767 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 16:40:33,767 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 16:40:33,767 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: 9b8ab97c-89d4-41dc-8bbf-54d193edbe02
2025-12-03 16:40:33,767 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 16:40:33,767 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=9b8ab97c-89d4-41dc-8bbf-54d193edbe02, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/auth/login/
2025-12-03 16:40:33,777 - app.infrastructure.database.queries_async - ERROR - Error en execute_query async (TextClause): (pyodbc.DataError) ('22018', '[22018] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Operand type clash: uniqueidentifier is incompatible with int (206) (SQLExecDirectW); [22018] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Statement(s) could not be prepared. (8180)')
[SQL: 
        SELECT 
            cliente_id, codigo_cliente, subdominio, razon_social, nombre_comercial, ruc,
            tipo_instalacion, servidor_api_local, modo_autenticacion, logo_url,
            favicon_url, color_primario, color_secundario, tema_personalizado,
            plan_suscripcion, estado_suscripcion, fecha_inicio_suscripcion,
            fecha_fin_trial, contacto_nombre, contacto_email, contacto_telefono,
            es_activo, es_demo, metadata_json,
            api_key_sincronizacion, sincronizacion_habilitada, ultima_sincronizacion,
            fecha_creacion, fecha_actualizacion, fecha_ultimo_acceso
        FROM cliente
        WHERE cliente_id = ?
        ]
[parameters: (UUID('9b8ab97c-89d4-41dc-8bbf-54d193edbe02'),)]
(Background on this error at: https://sqlalche.me/e/20/9h9h)
2025-12-03 16:40:33,777 - app.infrastructure.database.connection_async - ERROR - [ASYNC_CONNECTION] Error en sesión async: Error en la consulta: (pyodbc.DataError) ('22018', '[22018] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Operand type clash: uniqueidentifier is incompatible with int (206) (SQLExecDirectW); [22018] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Statement(s) could not be prepared. (8180)')
[SQL: 
        SELECT 
            cliente_id, codigo_cliente, subdominio, razon_social, nombre_comercial, ruc,
            tipo_instalacion, servidor_api_local, modo_autenticacion, logo_url,
            favicon_url, color_primario, color_secundario, tema_personalizado,
            plan_suscripcion, estado_suscripcion, fecha_inicio_suscripcion,
            fecha_fin_trial, contacto_nombre, contacto_email, contacto_telefono,
            es_activo, es_demo, metadata_json,
            api_key_sincronizacion, sincronizacion_habilitada, ultima_sincronizacion,
            fecha_creacion, fecha_actualizacion, fecha_ultimo_acceso
        FROM cliente
        WHERE cliente_id = ?
        ]
[parameters: (UUID('9b8ab97c-89d4-41dc-8bbf-54d193edbe02'),)]
(Background on this error at: https://sqlalche.me/e/20/9h9h)
Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 230, in execute
    self._adapt_connection._handle_exception(error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 368, in _handle_exception
    raise error.with_traceback(exc_info[2])
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 228, in execute
    return self.await_(self._execute_async(operation, parameters))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 251, in _execute_async
    result = await self._cursor.execute(operation, parameters)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 132, in execute
    await self._run_operation(self._impl.execute, sql, *params)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 30, in _run_operation
    result = await self._conn._execute(func, *args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\concurrent\futures\thread.py", line 59, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
pyodbc.DataError: ('22018', '[22018] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Operand type clash: uniqueidentifier is incompatible with int (206) (SQLExecDirectW); [22018] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Statement(s) could not be prepared. (8180)')

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 125, in execute_query
    result = await session.execute(query)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 449, in execute
    result = await greenlet_spawn(
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 203, in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2351, in execute
    return self._execute_internal(
           ^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2258, in _execute_internal
    result = conn.execute(
             ^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1419, in execute
    return meth(
           ^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\sql\elements.py", line 526, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1641, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1846, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1986, in _exec_single_context
    self._handle_dbapi_exception(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 2355, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 230, in execute
    self._adapt_connection._handle_exception(error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 368, in _handle_exception
    raise error.with_traceback(exc_info[2])
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 228, in execute
    return self.await_(self._execute_async(operation, parameters))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 251, in _execute_async
    result = await self._cursor.execute(operation, parameters)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 132, in execute
    await self._run_operation(self._impl.execute, sql, *params)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 30, in _run_operation
    result = await self._conn._execute(func, *args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\concurrent\futures\thread.py", line 59, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
sqlalchemy.exc.DataError: (pyodbc.DataError) ('22018', '[22018] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Operand type clash: uniqueidentifier is incompatible with int (206) (SQLExecDirectW); [22018] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Statement(s) could not be prepared. (8180)')
[SQL: 
        SELECT 
            cliente_id, codigo_cliente, subdominio, razon_social, nombre_comercial, ruc,
            tipo_instalacion, servidor_api_local, modo_autenticacion, logo_url,
            favicon_url, color_primario, color_secundario, tema_personalizado,
            plan_suscripcion, estado_suscripcion, fecha_inicio_suscripcion,
            fecha_fin_trial, contacto_nombre, contacto_email, contacto_telefono,
            es_activo, es_demo, metadata_json,
            api_key_sincronizacion, sincronizacion_habilitada, ultima_sincronizacion,
            fecha_creacion, fecha_actualizacion, fecha_ultimo_acceso
        FROM cliente
        WHERE cliente_id = ?
        ]
[parameters: (UUID('9b8ab97c-89d4-41dc-8bbf-54d193edbe02'),)]
(Background on this error at: https://sqlalche.me/e/20/9h9h)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\connection_async.py", line 303, in get_db_connection
    yield session
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 132, in execute_query
    raise DatabaseError(
app.core.exceptions.DatabaseError: Error en la consulta: (pyodbc.DataError) ('22018', '[22018] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Operand type clash: uniqueidentifier is incompatible with int (206) (SQLExecDirectW); [22018] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Statement(s) could not be prepared. (8180)')
[SQL: 
        SELECT 
            cliente_id, codigo_cliente, subdominio, razon_social, nombre_comercial, ruc,
            tipo_instalacion, servidor_api_local, modo_autenticacion, logo_url,
            favicon_url, color_primario, color_secundario, tema_personalizado,
            plan_suscripcion, estado_suscripcion, fecha_inicio_suscripcion,
            fecha_fin_trial, contacto_nombre, contacto_email, contacto_telefono,
            es_activo, es_demo, metadata_json,
            api_key_sincronizacion, sincronizacion_habilitada, ultima_sincronizacion,
            fecha_creacion, fecha_actualizacion, fecha_ultimo_acceso
        FROM cliente
        WHERE cliente_id = ?
        ]
[parameters: (UUID('9b8ab97c-89d4-41dc-8bbf-54d193edbe02'),)]
(Background on this error at: https://sqlalche.me/e/20/9h9h)
2025-12-03 16:40:33,783 - app.core.application.base_service - ERROR - DatabaseError en obtener_cliente_por_id: Error en la consulta: (pyodbc.DataError) ('22018', '[22018] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Operand type clash: uniqueidentifier is incompatible with int (206) (SQLExecDirectW); [22018] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Statement(s) could not be prepared. (8180)')
[SQL: 
        SELECT 
            cliente_id, codigo_cliente, subdominio, razon_social, nombre_comercial, ruc,
            tipo_instalacion, servidor_api_local, modo_autenticacion, logo_url,
            favicon_url, color_primario, color_secundario, tema_personalizado,
            plan_suscripcion, estado_suscripcion, fecha_inicio_suscripcion,
            fecha_fin_trial, contacto_nombre, contacto_email, contacto_telefono,
            es_activo, es_demo, metadata_json,
            api_key_sincronizacion, sincronizacion_habilitada, ultima_sincronizacion,
            fecha_creacion, fecha_actualizacion, fecha_ultimo_acceso
        FROM cliente
        WHERE cliente_id = ?
        ]
[parameters: (UUID('9b8ab97c-89d4-41dc-8bbf-54d193edbe02'),)]
(Background on this error at: https://sqlalche.me/e/20/9h9h)
Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 230, in execute
    self._adapt_connection._handle_exception(error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 368, in _handle_exception
    raise error.with_traceback(exc_info[2])
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 228, in execute
    return self.await_(self._execute_async(operation, parameters))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 251, in _execute_async
    result = await self._cursor.execute(operation, parameters)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 132, in execute
    await self._run_operation(self._impl.execute, sql, *params)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 30, in _run_operation
    result = await self._conn._execute(func, *args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\concurrent\futures\thread.py", line 59, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
pyodbc.DataError: ('22018', '[22018] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Operand type clash: uniqueidentifier is incompatible with int (206) (SQLExecDirectW); [22018] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Statement(s) could not be prepared. (8180)')

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 125, in execute_query
    result = await session.execute(query)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 449, in execute
    result = await greenlet_spawn(
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 203, in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2351, in execute
    return self._execute_internal(
           ^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2258, in _execute_internal
    result = conn.execute(
             ^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1419, in execute
    return meth(
           ^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\sql\elements.py", line 526, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1641, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1846, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1986, in _exec_single_context
    self._handle_dbapi_exception(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 2355, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 230, in execute
    self._adapt_connection._handle_exception(error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 368, in _handle_exception
    raise error.with_traceback(exc_info[2])
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 228, in execute
    return self.await_(self._execute_async(operation, parameters))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 251, in _execute_async
    result = await self._cursor.execute(operation, parameters)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 132, in execute
    await self._run_operation(self._impl.execute, sql, *params)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 30, in _run_operation
    result = await self._conn._execute(func, *args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\concurrent\futures\thread.py", line 59, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
sqlalchemy.exc.DataError: (pyodbc.DataError) ('22018', '[22018] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Operand type clash: uniqueidentifier is incompatible with int (206) (SQLExecDirectW); [22018] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Statement(s) could not be prepared. (8180)')
[SQL: 
        SELECT 
            cliente_id, codigo_cliente, subdominio, razon_social, nombre_comercial, ruc,
            tipo_instalacion, servidor_api_local, modo_autenticacion, logo_url,
            favicon_url, color_primario, color_secundario, tema_personalizado,
            plan_suscripcion, estado_suscripcion, fecha_inicio_suscripcion,
            fecha_fin_trial, contacto_nombre, contacto_email, contacto_telefono,
            es_activo, es_demo, metadata_json,
            api_key_sincronizacion, sincronizacion_habilitada, ultima_sincronizacion,
            fecha_creacion, fecha_actualizacion, fecha_ultimo_acceso
        FROM cliente
        WHERE cliente_id = ?
        ]
[parameters: (UUID('9b8ab97c-89d4-41dc-8bbf-54d193edbe02'),)]
(Background on this error at: https://sqlalche.me/e/20/9h9h)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\core\application\base_service.py", line 52, in wrapper
    return await func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\modules\tenant\application\services\cliente_service.py", line 187, in obtener_cliente_por_id
    resultado = await execute_query(
                ^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 132, in execute_query
    raise DatabaseError(
app.core.exceptions.DatabaseError: Error en la consulta: (pyodbc.DataError) ('22018', '[22018] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Operand type clash: uniqueidentifier is incompatible with int (206) (SQLExecDirectW); [22018] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Statement(s) could not be prepared. (8180)')
[SQL: 
        SELECT 
            cliente_id, codigo_cliente, subdominio, razon_social, nombre_comercial, ruc,
            tipo_instalacion, servidor_api_local, modo_autenticacion, logo_url,
            favicon_url, color_primario, color_secundario, tema_personalizado,
            plan_suscripcion, estado_suscripcion, fecha_inicio_suscripcion,
            fecha_fin_trial, contacto_nombre, contacto_email, contacto_telefono,
            es_activo, es_demo, metadata_json,
            api_key_sincronizacion, sincronizacion_habilitada, ultima_sincronizacion,
            fecha_creacion, fecha_actualizacion, fecha_ultimo_acceso
        FROM cliente
        WHERE cliente_id = ?
        ]
[parameters: (UUID('9b8ab97c-89d4-41dc-8bbf-54d193edbe02'),)]
(Background on this error at: https://sqlalche.me/e/20/9h9h)
2025-12-03 16:40:33,789 - app.modules.auth.presentation.endpoints - ERROR - Error inesperado en /login/ para usuario superadmin: Error en la consulta: (pyodbc.DataError) ('22018', '[22018] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Operand type clash: uniqueidentifier is incompatible with int (206) (SQLExecDirectW); [22018] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Statement(s) could not be prepared. (8180)')
[SQL: 
        SELECT 
            cliente_id, codigo_cliente, subdominio, razon_social, nombre_comercial, ruc,
            tipo_instalacion, servidor_api_local, modo_autenticacion, logo_url,
            favicon_url, color_primario, color_secundario, tema_personalizado,
            plan_suscripcion, estado_suscripcion, fecha_inicio_suscripcion,
            fecha_fin_trial, contacto_nombre, contacto_email, contacto_telefono,
            es_activo, es_demo, metadata_json,
            api_key_sincronizacion, sincronizacion_habilitada, ultima_sincronizacion,
            fecha_creacion, fecha_actualizacion, fecha_ultimo_acceso
        FROM cliente
        WHERE cliente_id = ?
        ]
[parameters: (UUID('9b8ab97c-89d4-41dc-8bbf-54d193edbe02'),)]
(Background on this error at: https://sqlalche.me/e/20/9h9h)
Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 230, in execute
    self._adapt_connection._handle_exception(error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 368, in _handle_exception
    raise error.with_traceback(exc_info[2])
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 228, in execute
    return self.await_(self._execute_async(operation, parameters))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 251, in _execute_async
    result = await self._cursor.execute(operation, parameters)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 132, in execute
    await self._run_operation(self._impl.execute, sql, *params)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 30, in _run_operation
    result = await self._conn._execute(func, *args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\concurrent\futures\thread.py", line 59, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
pyodbc.DataError: ('22018', '[22018] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Operand type clash: uniqueidentifier is incompatible with int (206) (SQLExecDirectW); [22018] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Statement(s) could not be prepared. (8180)')

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 125, in execute_query
    result = await session.execute(query)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 449, in execute
    result = await greenlet_spawn(
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 203, in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2351, in execute
    return self._execute_internal(
           ^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2258, in _execute_internal
    result = conn.execute(
             ^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1419, in execute
    return meth(
           ^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\sql\elements.py", line 526, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1641, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1846, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1986, in _exec_single_context
    self._handle_dbapi_exception(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 2355, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 230, in execute
    self._adapt_connection._handle_exception(error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 368, in _handle_exception
    raise error.with_traceback(exc_info[2])
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 228, in execute
    return self.await_(self._execute_async(operation, parameters))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 251, in _execute_async
    result = await self._cursor.execute(operation, parameters)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 132, in execute
    await self._run_operation(self._impl.execute, sql, *params)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 30, in _run_operation
    result = await self._conn._execute(func, *args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\concurrent\futures\thread.py", line 59, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
sqlalchemy.exc.DataError: (pyodbc.DataError) ('22018', '[22018] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Operand type clash: uniqueidentifier is incompatible with int (206) (SQLExecDirectW); [22018] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Statement(s) could not be prepared. (8180)')
[SQL: 
        SELECT 
            cliente_id, codigo_cliente, subdominio, razon_social, nombre_comercial, ruc,
            tipo_instalacion, servidor_api_local, modo_autenticacion, logo_url,
            favicon_url, color_primario, color_secundario, tema_personalizado,
            plan_suscripcion, estado_suscripcion, fecha_inicio_suscripcion,
            fecha_fin_trial, contacto_nombre, contacto_email, contacto_telefono,
            es_activo, es_demo, metadata_json,
            api_key_sincronizacion, sincronizacion_habilitada, ultima_sincronizacion,
            fecha_creacion, fecha_actualizacion, fecha_ultimo_acceso
        FROM cliente
        WHERE cliente_id = ?
        ]
[parameters: (UUID('9b8ab97c-89d4-41dc-8bbf-54d193edbe02'),)]
(Background on this error at: https://sqlalche.me/e/20/9h9h)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\modules\auth\presentation\endpoints.py", line 134, in login
    cliente = await ClienteService.obtener_cliente_por_id(cliente_id)
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\core\application\base_service.py", line 52, in wrapper
    return await func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\modules\tenant\application\services\cliente_service.py", line 187, in obtener_cliente_por_id
    resultado = await execute_query(
                ^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 132, in execute_query
    raise DatabaseError(
app.core.exceptions.DatabaseError: Error en la consulta: (pyodbc.DataError) ('22018', '[22018] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Operand type clash: uniqueidentifier is incompatible with int (206) (SQLExecDirectW); [22018] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Statement(s) could not be prepared. (8180)')
[SQL: 
        SELECT 
            cliente_id, codigo_cliente, subdominio, razon_social, nombre_comercial, ruc,
            tipo_instalacion, servidor_api_local, modo_autenticacion, logo_url,
            favicon_url, color_primario, color_secundario, tema_personalizado,
            plan_suscripcion, estado_suscripcion, fecha_inicio_suscripcion,
            fecha_fin_trial, contacto_nombre, contacto_email, contacto_telefono,
            es_activo, es_demo, metadata_json,
            api_key_sincronizacion, sincronizacion_habilitada, ultima_sincronizacion,
            fecha_creacion, fecha_actualizacion, fecha_ultimo_acceso
        FROM cliente
        WHERE cliente_id = ?
        ]
[parameters: (UUID('9b8ab97c-89d4-41dc-8bbf-54d193edbe02'),)]
(Background on this error at: https://sqlalche.me/e/20/9h9h)
2025-12-03 16:40:33,792 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/login/ 500 29.3ms
2025-12-03 17:39:10,508 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/auth/refresh/
2025-12-03 17:39:10,509 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/auth/refresh/ 200 0.8ms
2025-12-03 17:39:10,512 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/refresh/
2025-12-03 17:39:10,512 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 17:39:10,513 - app.core.tenant.middleware - WARNING - [HOST_DETECTION] No se pudo extraer tenant real de origin/referer, usando cliente por defecto (SYSTEM)
2025-12-03 17:39:10,513 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'backend.app.local'
2025-12-03 17:39:10,513 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 17:39:10,513 - app.core.tenant.middleware - INFO - [SUBDOMAIN] 'backend' es infraestructura, ignorando (usando SYSTEM)
2025-12-03 17:39:10,513 - app.core.tenant.middleware - WARNING - [TENANT] Sin subdominio en Host: backend.app.local:8000. Usando Cliente ID por defecto: 9b8ab97c-89d4-41dc-8bbf-54d193edbe02 (SYSTEM)
2025-12-03 17:39:10,513 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 17:39:10,513 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=9b8ab97c-89d4-41dc-8bbf-54d193edbe02, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/auth/refresh/
2025-12-03 17:39:10,516 - app.modules.auth.application.services.auth_service - WARNING - [REFRESH] No se proporcionó refresh token. Cliente: web
2025-12-03 17:39:10,517 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/refresh/ 401 4.7ms
2025-12-03 20:09:17,267 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/auth/refresh/
2025-12-03 20:09:17,267 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/auth/refresh/ 200 0.6ms
2025-12-03 20:09:17,270 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/refresh/
2025-12-03 20:09:17,271 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 20:09:17,271 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 20:09:17,271 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 20:09:17,271 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 20:09:17,271 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 20:09:17,271 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 20:09:17,271 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 20:09:17,271 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 20:09:17,271 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: 9b8ab97c-89d4-41dc-8bbf-54d193edbe02
2025-12-03 20:09:17,271 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 20:09:17,271 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=9b8ab97c-89d4-41dc-8bbf-54d193edbe02, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/auth/refresh/
2025-12-03 20:09:17,293 - app.modules.auth.application.services.refresh_token_service - WARNING - [VALIDATE-TOKEN] Token no encontrado, revocado o expirado - Cliente 9b8ab97c-89d4-41dc-8bbf-54d193edbe02
2025-12-03 20:09:17,293 - app.modules.auth.application.services.auth_service - WARNING - [REFRESH] Token JWT válido, pero inactivo/revocado en BD. Usuario: superadmin
2025-12-03 20:09:17,297 - app.infrastructure.database.queries_async - ERROR - Error en execute_insert async (string): (pyodbc.Error) ('07002', '[07002] [Microsoft][ODBC Driver 17 for SQL Server]COUNT field incorrect or syntax error (0) (SQLExecDirectW)')
[SQL: 
INSERT INTO auth_audit_log (
    cliente_id,
    usuario_id,
    evento,
    nombre_usuario_intento,
    descripcion,
    exito,
    codigo_error,
    ip_address,
    user_agent,
    device_info,
    geolocation,
    metadata_json
)
OUTPUT INSERTED.log_id, INSERTED.fecha_evento
VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);
]
(Background on this error at: https://sqlalche.me/e/20/dbapi)
2025-12-03 20:09:17,297 - app.infrastructure.database.connection_async - ERROR - [ASYNC_CONNECTION] Error en sesión async: Error en la inserción: (pyodbc.Error) ('07002', '[07002] [Microsoft][ODBC Driver 17 for SQL Server]COUNT field incorrect or syntax error (0) (SQLExecDirectW)')
[SQL: 
INSERT INTO auth_audit_log (
    cliente_id,
    usuario_id,
    evento,
    nombre_usuario_intento,
    descripcion,
    exito,
    codigo_error,
    ip_address,
    user_agent,
    device_info,
    geolocation,
    metadata_json
)
OUTPUT INSERTED.log_id, INSERTED.fecha_evento
VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);
]
(Background on this error at: https://sqlalche.me/e/20/dbapi)
Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 230, in execute
    self._adapt_connection._handle_exception(error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 368, in _handle_exception
    raise error.with_traceback(exc_info[2])
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 228, in execute
    return self.await_(self._execute_async(operation, parameters))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 251, in _execute_async
    result = await self._cursor.execute(operation, parameters)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 132, in execute
    await self._run_operation(self._impl.execute, sql, *params)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 30, in _run_operation
    result = await self._conn._execute(func, *args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\concurrent\futures\thread.py", line 59, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
pyodbc.Error: ('07002', '[07002] [Microsoft][ODBC Driver 17 for SQL Server]COUNT field incorrect or syntax error (0) (SQLExecDirectW)')

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 269, in execute_insert
    result = await session.execute(text(query))
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 449, in execute
    result = await greenlet_spawn(
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 203, in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2351, in execute
    return self._execute_internal(
           ^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2258, in _execute_internal
    result = conn.execute(
             ^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1419, in execute
    return meth(
           ^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\sql\elements.py", line 526, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1641, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1846, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1986, in _exec_single_context
    self._handle_dbapi_exception(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 2355, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 230, in execute
    self._adapt_connection._handle_exception(error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 368, in _handle_exception
    raise error.with_traceback(exc_info[2])
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 228, in execute
    return self.await_(self._execute_async(operation, parameters))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 251, in _execute_async
    result = await self._cursor.execute(operation, parameters)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 132, in execute
    await self._run_operation(self._impl.execute, sql, *params)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 30, in _run_operation
    result = await self._conn._execute(func, *args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\concurrent\futures\thread.py", line 59, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
sqlalchemy.exc.DBAPIError: (pyodbc.Error) ('07002', '[07002] [Microsoft][ODBC Driver 17 for SQL Server]COUNT field incorrect or syntax error (0) (SQLExecDirectW)')
[SQL: 
INSERT INTO auth_audit_log (
    cliente_id,
    usuario_id,
    evento,
    nombre_usuario_intento,
    descripcion,
    exito,
    codigo_error,
    ip_address,
    user_agent,
    device_info,
    geolocation,
    metadata_json
)
OUTPUT INSERTED.log_id, INSERTED.fecha_evento
VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);
]
(Background on this error at: https://sqlalche.me/e/20/dbapi)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\connection_async.py", line 303, in get_db_connection
    yield session
  File "D:\base_multi_tenant_fastapi\app\core\tenant\routing.py", line 672, in get_connection_for_tenant
    yield session
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 285, in execute_insert
    raise DatabaseError(
app.core.exceptions.DatabaseError: Error en la inserción: (pyodbc.Error) ('07002', '[07002] [Microsoft][ODBC Driver 17 for SQL Server]COUNT field incorrect or syntax error (0) (SQLExecDirectW)')
[SQL: 
INSERT INTO auth_audit_log (
    cliente_id,
    usuario_id,
    evento,
    nombre_usuario_intento,
    descripcion,
    exito,
    codigo_error,
    ip_address,
    user_agent,
    device_info,
    geolocation,
    metadata_json
)
OUTPUT INSERTED.log_id, INSERTED.fecha_evento
VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);
]
(Background on this error at: https://sqlalche.me/e/20/dbapi)
2025-12-03 20:09:17,301 - app.core.application.base_service - ERROR - DatabaseError en registrar_auth_event: Error en la inserción: (pyodbc.Error) ('07002', '[07002] [Microsoft][ODBC Driver 17 for SQL Server]COUNT field incorrect or syntax error (0) (SQLExecDirectW)')
[SQL: 
INSERT INTO auth_audit_log (
    cliente_id,
    usuario_id,
    evento,
    nombre_usuario_intento,
    descripcion,
    exito,
    codigo_error,
    ip_address,
    user_agent,
    device_info,
    geolocation,
    metadata_json
)
OUTPUT INSERTED.log_id, INSERTED.fecha_evento
VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);
]
(Background on this error at: https://sqlalche.me/e/20/dbapi)
Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 230, in execute
    self._adapt_connection._handle_exception(error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 368, in _handle_exception
    raise error.with_traceback(exc_info[2])
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 228, in execute
    return self.await_(self._execute_async(operation, parameters))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 251, in _execute_async
    result = await self._cursor.execute(operation, parameters)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 132, in execute
    await self._run_operation(self._impl.execute, sql, *params)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 30, in _run_operation
    result = await self._conn._execute(func, *args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\concurrent\futures\thread.py", line 59, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
pyodbc.Error: ('07002', '[07002] [Microsoft][ODBC Driver 17 for SQL Server]COUNT field incorrect or syntax error (0) (SQLExecDirectW)')

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 269, in execute_insert
    result = await session.execute(text(query))
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 449, in execute
    result = await greenlet_spawn(
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 203, in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2351, in execute
    return self._execute_internal(
           ^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2258, in _execute_internal
    result = conn.execute(
             ^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1419, in execute
    return meth(
           ^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\sql\elements.py", line 526, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1641, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1846, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1986, in _exec_single_context
    self._handle_dbapi_exception(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 2355, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 230, in execute
    self._adapt_connection._handle_exception(error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 368, in _handle_exception
    raise error.with_traceback(exc_info[2])
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 228, in execute
    return self.await_(self._execute_async(operation, parameters))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 251, in _execute_async
    result = await self._cursor.execute(operation, parameters)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 132, in execute
    await self._run_operation(self._impl.execute, sql, *params)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 30, in _run_operation
    result = await self._conn._execute(func, *args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\concurrent\futures\thread.py", line 59, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
sqlalchemy.exc.DBAPIError: (pyodbc.Error) ('07002', '[07002] [Microsoft][ODBC Driver 17 for SQL Server]COUNT field incorrect or syntax error (0) (SQLExecDirectW)')
[SQL: 
INSERT INTO auth_audit_log (
    cliente_id,
    usuario_id,
    evento,
    nombre_usuario_intento,
    descripcion,
    exito,
    codigo_error,
    ip_address,
    user_agent,
    device_info,
    geolocation,
    metadata_json
)
OUTPUT INSERTED.log_id, INSERTED.fecha_evento
VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);
]
(Background on this error at: https://sqlalche.me/e/20/dbapi)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\core\application\base_service.py", line 52, in wrapper
    return await func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\modules\superadmin\application\services\audit_service.py", line 80, in registrar_auth_event
    result = await execute_insert(INSERT_AUTH_AUDIT_LOG, params)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 285, in execute_insert
    raise DatabaseError(
app.core.exceptions.DatabaseError: Error en la inserción: (pyodbc.Error) ('07002', '[07002] [Microsoft][ODBC Driver 17 for SQL Server]COUNT field incorrect or syntax error (0) (SQLExecDirectW)')
[SQL: 
INSERT INTO auth_audit_log (
    cliente_id,
    usuario_id,
    evento,
    nombre_usuario_intento,
    descripcion,
    exito,
    codigo_error,
    ip_address,
    user_agent,
    device_info,
    geolocation,
    metadata_json
)
OUTPUT INSERTED.log_id, INSERTED.fecha_evento
VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);
]
(Background on this error at: https://sqlalche.me/e/20/dbapi)
2025-12-03 20:09:17,305 - app.modules.auth.application.services.auth_service - ERROR - [AUDIT] Error registrando evento token_invalid_or_revoked (no crítico)
Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 230, in execute
    self._adapt_connection._handle_exception(error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 368, in _handle_exception
    raise error.with_traceback(exc_info[2])
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 228, in execute
    return self.await_(self._execute_async(operation, parameters))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 251, in _execute_async
    result = await self._cursor.execute(operation, parameters)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 132, in execute
    await self._run_operation(self._impl.execute, sql, *params)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 30, in _run_operation
    result = await self._conn._execute(func, *args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\concurrent\futures\thread.py", line 59, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
pyodbc.Error: ('07002', '[07002] [Microsoft][ODBC Driver 17 for SQL Server]COUNT field incorrect or syntax error (0) (SQLExecDirectW)')

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 269, in execute_insert
    result = await session.execute(text(query))
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 449, in execute
    result = await greenlet_spawn(
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 203, in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2351, in execute
    return self._execute_internal(
           ^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2258, in _execute_internal
    result = conn.execute(
             ^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1419, in execute
    return meth(
           ^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\sql\elements.py", line 526, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1641, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1846, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1986, in _exec_single_context
    self._handle_dbapi_exception(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 2355, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 230, in execute
    self._adapt_connection._handle_exception(error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 368, in _handle_exception
    raise error.with_traceback(exc_info[2])
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 228, in execute
    return self.await_(self._execute_async(operation, parameters))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 251, in _execute_async
    result = await self._cursor.execute(operation, parameters)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 132, in execute
    await self._run_operation(self._impl.execute, sql, *params)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 30, in _run_operation
    result = await self._conn._execute(func, *args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\concurrent\futures\thread.py", line 59, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
sqlalchemy.exc.DBAPIError: (pyodbc.Error) ('07002', '[07002] [Microsoft][ODBC Driver 17 for SQL Server]COUNT field incorrect or syntax error (0) (SQLExecDirectW)')
[SQL: 
INSERT INTO auth_audit_log (
    cliente_id,
    usuario_id,
    evento,
    nombre_usuario_intento,
    descripcion,
    exito,
    codigo_error,
    ip_address,
    user_agent,
    device_info,
    geolocation,
    metadata_json
)
OUTPUT INSERTED.log_id, INSERTED.fecha_evento
VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);
]
(Background on this error at: https://sqlalche.me/e/20/dbapi)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\modules\auth\application\services\auth_service.py", line 462, in get_current_user_from_refresh
    await AuditService.registrar_auth_event(
  File "D:\base_multi_tenant_fastapi\app\core\application\base_service.py", line 52, in wrapper
    return await func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\modules\superadmin\application\services\audit_service.py", line 80, in registrar_auth_event
    result = await execute_insert(INSERT_AUTH_AUDIT_LOG, params)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 285, in execute_insert
    raise DatabaseError(
app.core.exceptions.DatabaseError: Error en la inserción: (pyodbc.Error) ('07002', '[07002] [Microsoft][ODBC Driver 17 for SQL Server]COUNT field incorrect or syntax error (0) (SQLExecDirectW)')
[SQL: 
INSERT INTO auth_audit_log (
    cliente_id,
    usuario_id,
    evento,
    nombre_usuario_intento,
    descripcion,
    exito,
    codigo_error,
    ip_address,
    user_agent,
    device_info,
    geolocation,
    metadata_json
)
OUTPUT INSERTED.log_id, INSERTED.fecha_evento
VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);
]
(Background on this error at: https://sqlalche.me/e/20/dbapi)
2025-12-03 20:09:17,311 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/refresh/ 401 40.6ms
2025-12-03 20:09:35,347 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Pool ADMIN inicializado. Size=10, MaxOverflow=5
2025-12-03 20:09:35,347 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Configuración de pools de tenants: MaxPools=50, PoolSize=3, MaxOverflow=2, InactivityTimeout=3600s
2025-12-03 20:09:35,347 - app.infrastructure.database.connection_pool - INFO - ✅ Módulo de connection pooling cargado y activo
2025-12-03 20:09:35,347 - app.infrastructure.database.connection_pool - INFO -    Configuración: MaxTenantPools=50, TenantPoolSize=3, InactivityTimeout=3600s
2025-12-03 20:09:35,347 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Todos los pools cerrados
2025-12-03 20:09:35,347 - app.main - INFO - ✅ Pools de conexión cerrados correctamente
2025-12-03 20:09:37,682 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 20:09:37,899 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 20:09:37,907 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 20:09:37,911 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 20:09:37,911 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 20:09:37,912 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 20:09:37,912 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 20:09:37,912 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=9b8ab97c-89d4-41dc-8bbf-54d193edbe02, DEFAULT_TYPE=single
2025-12-03 20:09:38,249 - app.core.security.rate_limiting - INFO - [RATE_LIMITING] Activado. Límites: Login=10/minute, API=200/minute
2025-12-03 20:09:38,249 - app.core.security.rate_limiting - INFO - ✅ Módulo de rate limiting cargado y activo
2025-12-03 20:09:38,317 - app.core.authorization.rbac - INFO - 🔐 Inicializando sistema de autorización...
2025-12-03 20:09:38,317 - app.core.authorization.rbac - INFO - ✅ Sistema de autorización inicializado correctamente
2025-12-03 20:09:38,317 - app.core.authorization.rbac - INFO - 📊 Permisos del sistema: 6 módulos configurados
2025-12-03 20:09:38,481 - app.core.tenant.middleware - INFO - Módulo tenant_middleware cargado (versión híbrida con soporte para proxies)
2025-12-03 20:09:38,482 - app.main - INFO - ✅ Rate limiting configurado y activo
2025-12-03 20:09:38,629 - app.core.tenant.middleware - INFO - [TENANT_MW] Inicializado - BASE_DOMAIN=app.local, SYSTEM_ID=9B8AB97C-89D4-41DC-8BBF-54D193EDBE02, EXCLUDED_SUBDOMAINS={'static', 'api', 'admin', 'cdn', 'backend', 'www', 'assets'}
2025-12-03 20:09:54,439 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/auth/login/
2025-12-03 20:09:54,441 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/auth/login/ 200 0.7ms
2025-12-03 20:09:54,443 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/login/
2025-12-03 20:09:54,443 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 20:09:54,443 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 20:09:54,443 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 20:09:54,444 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 20:09:54,444 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 20:09:54,444 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 20:09:54,444 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 20:09:54,444 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 20:09:54,444 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: 9b8ab97c-89d4-41dc-8bbf-54d193edbe02
2025-12-03 20:09:54,444 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 20:09:54,445 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=9b8ab97c-89d4-41dc-8bbf-54d193edbe02, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/auth/login/
2025-12-03 20:09:54,449 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] AsyncEngine creado para admin
2025-12-03 20:09:54,632 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/login/ 401 193.4ms
2025-12-03 20:12:33,628 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/login/
2025-12-03 20:12:33,629 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 20:12:33,629 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 20:12:33,629 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 20:12:33,629 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 20:12:33,630 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 20:12:33,630 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 20:12:33,630 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 20:12:33,630 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 20:12:33,630 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: 9b8ab97c-89d4-41dc-8bbf-54d193edbe02
2025-12-03 20:12:33,630 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 20:12:33,630 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=9b8ab97c-89d4-41dc-8bbf-54d193edbe02, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/auth/login/
2025-12-03 20:12:33,637 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/login/ 401 9.8ms
2025-12-03 20:12:50,548 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Pool ADMIN inicializado. Size=10, MaxOverflow=5
2025-12-03 20:12:50,548 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Configuración de pools de tenants: MaxPools=50, PoolSize=3, MaxOverflow=2, InactivityTimeout=3600s
2025-12-03 20:12:50,548 - app.infrastructure.database.connection_pool - INFO - ✅ Módulo de connection pooling cargado y activo
2025-12-03 20:12:50,550 - app.infrastructure.database.connection_pool - INFO -    Configuración: MaxTenantPools=50, TenantPoolSize=3, InactivityTimeout=3600s
2025-12-03 20:12:50,550 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Todos los pools cerrados
2025-12-03 20:12:50,550 - app.main - INFO - ✅ Pools de conexión cerrados correctamente
2025-12-03 20:12:52,788 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 20:12:52,980 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 20:12:52,990 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 20:12:52,994 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 20:12:52,994 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 20:12:52,995 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 20:12:52,995 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 20:12:52,995 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, DEFAULT_TYPE=single
2025-12-03 20:12:53,330 - app.core.security.rate_limiting - INFO - [RATE_LIMITING] Activado. Límites: Login=10/minute, API=200/minute
2025-12-03 20:12:53,330 - app.core.security.rate_limiting - INFO - ✅ Módulo de rate limiting cargado y activo
2025-12-03 20:12:53,400 - app.core.authorization.rbac - INFO - 🔐 Inicializando sistema de autorización...
2025-12-03 20:12:53,400 - app.core.authorization.rbac - INFO - ✅ Sistema de autorización inicializado correctamente
2025-12-03 20:12:53,400 - app.core.authorization.rbac - INFO - 📊 Permisos del sistema: 6 módulos configurados
2025-12-03 20:12:53,583 - app.core.tenant.middleware - INFO - Módulo tenant_middleware cargado (versión híbrida con soporte para proxies)
2025-12-03 20:12:53,583 - app.main - INFO - ✅ Rate limiting configurado y activo
2025-12-03 20:12:53,720 - app.core.tenant.middleware - INFO - [TENANT_MW] Inicializado - BASE_DOMAIN=app.local, SYSTEM_ID=BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, EXCLUDED_SUBDOMAINS={'admin', 'cdn', 'api', 'www', 'assets', 'static', 'backend'}
2025-12-03 20:13:02,236 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/login/
2025-12-03 20:13:02,236 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 20:13:02,236 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 20:13:02,236 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 20:13:02,236 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 20:13:02,236 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 20:13:02,237 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 20:13:02,237 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 20:13:02,237 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 20:13:02,237 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 20:13:02,237 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 20:13:02,237 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/auth/login/
2025-12-03 20:13:02,240 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] AsyncEngine creado para admin
2025-12-03 20:13:02,392 - app.modules.auth.presentation.endpoints - INFO - Cliente bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7 resuelto y validado para login.
2025-12-03 20:13:02,392 - app.modules.auth.application.services.auth_service - INFO - [AUTH] Intento de login: username='superadmin', cliente_id_destino=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 20:13:02,392 - app.modules.auth.application.services.auth_service - INFO - [AUTH] SUPERADMIN detectado. Buscando en BD ADMIN (cliente_id=BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7), accediendo a cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 20:13:02,392 - app.modules.auth.application.services.auth_service - ERROR - [AUTH] Error en autenticación: username='superadmin', cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, error=execute_query() got multiple values for argument 'connection_type'
Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\modules\auth\application\services\auth_service.py", line 163, in authenticate_user
    result = await execute_query(
                   ^^^^^^^^^^^^^^
TypeError: execute_query() got multiple values for argument 'connection_type'
2025-12-03 20:13:02,400 - app.infrastructure.database.queries_async - ERROR - Error en execute_insert async (string): (pyodbc.Error) ('07002', '[07002] [Microsoft][ODBC Driver 17 for SQL Server]COUNT field incorrect or syntax error (0) (SQLExecDirectW)')
[SQL: 
INSERT INTO auth_audit_log (
    cliente_id,
    usuario_id,
    evento,
    nombre_usuario_intento,
    descripcion,
    exito,
    codigo_error,
    ip_address,
    user_agent,
    device_info,
    geolocation,
    metadata_json
)
OUTPUT INSERTED.log_id, INSERTED.fecha_evento
VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);
]
(Background on this error at: https://sqlalche.me/e/20/dbapi)
2025-12-03 20:13:02,400 - app.infrastructure.database.connection_async - ERROR - [ASYNC_CONNECTION] Error en sesión async: Error en la inserción: (pyodbc.Error) ('07002', '[07002] [Microsoft][ODBC Driver 17 for SQL Server]COUNT field incorrect or syntax error (0) (SQLExecDirectW)')
[SQL: 
INSERT INTO auth_audit_log (
    cliente_id,
    usuario_id,
    evento,
    nombre_usuario_intento,
    descripcion,
    exito,
    codigo_error,
    ip_address,
    user_agent,
    device_info,
    geolocation,
    metadata_json
)
OUTPUT INSERTED.log_id, INSERTED.fecha_evento
VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);
]
(Background on this error at: https://sqlalche.me/e/20/dbapi)
Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 230, in execute
    self._adapt_connection._handle_exception(error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 368, in _handle_exception
    raise error.with_traceback(exc_info[2])
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 228, in execute
    return self.await_(self._execute_async(operation, parameters))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 251, in _execute_async
    result = await self._cursor.execute(operation, parameters)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 132, in execute
    await self._run_operation(self._impl.execute, sql, *params)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 30, in _run_operation
    result = await self._conn._execute(func, *args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\concurrent\futures\thread.py", line 59, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
pyodbc.Error: ('07002', '[07002] [Microsoft][ODBC Driver 17 for SQL Server]COUNT field incorrect or syntax error (0) (SQLExecDirectW)')

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 269, in execute_insert
    result = await session.execute(text(query))
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 449, in execute
    result = await greenlet_spawn(
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 203, in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2351, in execute
    return self._execute_internal(
           ^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2258, in _execute_internal
    result = conn.execute(
             ^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1419, in execute
    return meth(
           ^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\sql\elements.py", line 526, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1641, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1846, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1986, in _exec_single_context
    self._handle_dbapi_exception(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 2355, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 230, in execute
    self._adapt_connection._handle_exception(error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 368, in _handle_exception
    raise error.with_traceback(exc_info[2])
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 228, in execute
    return self.await_(self._execute_async(operation, parameters))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 251, in _execute_async
    result = await self._cursor.execute(operation, parameters)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 132, in execute
    await self._run_operation(self._impl.execute, sql, *params)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 30, in _run_operation
    result = await self._conn._execute(func, *args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\concurrent\futures\thread.py", line 59, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
sqlalchemy.exc.DBAPIError: (pyodbc.Error) ('07002', '[07002] [Microsoft][ODBC Driver 17 for SQL Server]COUNT field incorrect or syntax error (0) (SQLExecDirectW)')
[SQL: 
INSERT INTO auth_audit_log (
    cliente_id,
    usuario_id,
    evento,
    nombre_usuario_intento,
    descripcion,
    exito,
    codigo_error,
    ip_address,
    user_agent,
    device_info,
    geolocation,
    metadata_json
)
OUTPUT INSERTED.log_id, INSERTED.fecha_evento
VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);
]
(Background on this error at: https://sqlalche.me/e/20/dbapi)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\connection_async.py", line 303, in get_db_connection
    yield session
  File "D:\base_multi_tenant_fastapi\app\core\tenant\routing.py", line 672, in get_connection_for_tenant
    yield session
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 285, in execute_insert
    raise DatabaseError(
app.core.exceptions.DatabaseError: Error en la inserción: (pyodbc.Error) ('07002', '[07002] [Microsoft][ODBC Driver 17 for SQL Server]COUNT field incorrect or syntax error (0) (SQLExecDirectW)')
[SQL: 
INSERT INTO auth_audit_log (
    cliente_id,
    usuario_id,
    evento,
    nombre_usuario_intento,
    descripcion,
    exito,
    codigo_error,
    ip_address,
    user_agent,
    device_info,
    geolocation,
    metadata_json
)
OUTPUT INSERTED.log_id, INSERTED.fecha_evento
VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);
]
(Background on this error at: https://sqlalche.me/e/20/dbapi)
2025-12-03 20:13:02,410 - app.core.application.base_service - ERROR - DatabaseError en registrar_auth_event: Error en la inserción: (pyodbc.Error) ('07002', '[07002] [Microsoft][ODBC Driver 17 for SQL Server]COUNT field incorrect or syntax error (0) (SQLExecDirectW)')
[SQL: 
INSERT INTO auth_audit_log (
    cliente_id,
    usuario_id,
    evento,
    nombre_usuario_intento,
    descripcion,
    exito,
    codigo_error,
    ip_address,
    user_agent,
    device_info,
    geolocation,
    metadata_json
)
OUTPUT INSERTED.log_id, INSERTED.fecha_evento
VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);
]
(Background on this error at: https://sqlalche.me/e/20/dbapi)
Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 230, in execute
    self._adapt_connection._handle_exception(error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 368, in _handle_exception
    raise error.with_traceback(exc_info[2])
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 228, in execute
    return self.await_(self._execute_async(operation, parameters))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 251, in _execute_async
    result = await self._cursor.execute(operation, parameters)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 132, in execute
    await self._run_operation(self._impl.execute, sql, *params)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 30, in _run_operation
    result = await self._conn._execute(func, *args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\concurrent\futures\thread.py", line 59, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
pyodbc.Error: ('07002', '[07002] [Microsoft][ODBC Driver 17 for SQL Server]COUNT field incorrect or syntax error (0) (SQLExecDirectW)')

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 269, in execute_insert
    result = await session.execute(text(query))
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 449, in execute
    result = await greenlet_spawn(
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 203, in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2351, in execute
    return self._execute_internal(
           ^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2258, in _execute_internal
    result = conn.execute(
             ^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1419, in execute
    return meth(
           ^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\sql\elements.py", line 526, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1641, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1846, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1986, in _exec_single_context
    self._handle_dbapi_exception(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 2355, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 230, in execute
    self._adapt_connection._handle_exception(error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 368, in _handle_exception
    raise error.with_traceback(exc_info[2])
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 228, in execute
    return self.await_(self._execute_async(operation, parameters))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 251, in _execute_async
    result = await self._cursor.execute(operation, parameters)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 132, in execute
    await self._run_operation(self._impl.execute, sql, *params)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 30, in _run_operation
    result = await self._conn._execute(func, *args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\concurrent\futures\thread.py", line 59, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
sqlalchemy.exc.DBAPIError: (pyodbc.Error) ('07002', '[07002] [Microsoft][ODBC Driver 17 for SQL Server]COUNT field incorrect or syntax error (0) (SQLExecDirectW)')
[SQL: 
INSERT INTO auth_audit_log (
    cliente_id,
    usuario_id,
    evento,
    nombre_usuario_intento,
    descripcion,
    exito,
    codigo_error,
    ip_address,
    user_agent,
    device_info,
    geolocation,
    metadata_json
)
OUTPUT INSERTED.log_id, INSERTED.fecha_evento
VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);
]
(Background on this error at: https://sqlalche.me/e/20/dbapi)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\core\application\base_service.py", line 52, in wrapper
    return await func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\modules\superadmin\application\services\audit_service.py", line 80, in registrar_auth_event
    result = await execute_insert(INSERT_AUTH_AUDIT_LOG, params)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 285, in execute_insert
    raise DatabaseError(
app.core.exceptions.DatabaseError: Error en la inserción: (pyodbc.Error) ('07002', '[07002] [Microsoft][ODBC Driver 17 for SQL Server]COUNT field incorrect or syntax error (0) (SQLExecDirectW)')
[SQL: 
INSERT INTO auth_audit_log (
    cliente_id,
    usuario_id,
    evento,
    nombre_usuario_intento,
    descripcion,
    exito,
    codigo_error,
    ip_address,
    user_agent,
    device_info,
    geolocation,
    metadata_json
)
OUTPUT INSERTED.log_id, INSERTED.fecha_evento
VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);
]
(Background on this error at: https://sqlalche.me/e/20/dbapi)
2025-12-03 20:13:02,415 - app.modules.auth.presentation.endpoints - ERROR - [AUDIT] Error registrando evento login_failed (no crítico)
Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 230, in execute
    self._adapt_connection._handle_exception(error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 368, in _handle_exception
    raise error.with_traceback(exc_info[2])
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 228, in execute
    return self.await_(self._execute_async(operation, parameters))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 251, in _execute_async
    result = await self._cursor.execute(operation, parameters)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 132, in execute
    await self._run_operation(self._impl.execute, sql, *params)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 30, in _run_operation
    result = await self._conn._execute(func, *args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\concurrent\futures\thread.py", line 59, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
pyodbc.Error: ('07002', '[07002] [Microsoft][ODBC Driver 17 for SQL Server]COUNT field incorrect or syntax error (0) (SQLExecDirectW)')

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 269, in execute_insert
    result = await session.execute(text(query))
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 449, in execute
    result = await greenlet_spawn(
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 203, in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2351, in execute
    return self._execute_internal(
           ^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2258, in _execute_internal
    result = conn.execute(
             ^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1419, in execute
    return meth(
           ^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\sql\elements.py", line 526, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1641, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1846, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1986, in _exec_single_context
    self._handle_dbapi_exception(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 2355, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 230, in execute
    self._adapt_connection._handle_exception(error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 368, in _handle_exception
    raise error.with_traceback(exc_info[2])
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 228, in execute
    return self.await_(self._execute_async(operation, parameters))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 251, in _execute_async
    result = await self._cursor.execute(operation, parameters)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 132, in execute
    await self._run_operation(self._impl.execute, sql, *params)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 30, in _run_operation
    result = await self._conn._execute(func, *args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\concurrent\futures\thread.py", line 59, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
sqlalchemy.exc.DBAPIError: (pyodbc.Error) ('07002', '[07002] [Microsoft][ODBC Driver 17 for SQL Server]COUNT field incorrect or syntax error (0) (SQLExecDirectW)')
[SQL: 
INSERT INTO auth_audit_log (
    cliente_id,
    usuario_id,
    evento,
    nombre_usuario_intento,
    descripcion,
    exito,
    codigo_error,
    ip_address,
    user_agent,
    device_info,
    geolocation,
    metadata_json
)
OUTPUT INSERTED.log_id, INSERTED.fecha_evento
VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);
]
(Background on this error at: https://sqlalche.me/e/20/dbapi)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\modules\auth\presentation\endpoints.py", line 157, in login
    await AuditService.registrar_auth_event(
  File "D:\base_multi_tenant_fastapi\app\core\application\base_service.py", line 52, in wrapper
    return await func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\modules\superadmin\application\services\audit_service.py", line 80, in registrar_auth_event
    result = await execute_insert(INSERT_AUTH_AUDIT_LOG, params)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 285, in execute_insert
    raise DatabaseError(
app.core.exceptions.DatabaseError: Error en la inserción: (pyodbc.Error) ('07002', '[07002] [Microsoft][ODBC Driver 17 for SQL Server]COUNT field incorrect or syntax error (0) (SQLExecDirectW)')
[SQL: 
INSERT INTO auth_audit_log (
    cliente_id,
    usuario_id,
    evento,
    nombre_usuario_intento,
    descripcion,
    exito,
    codigo_error,
    ip_address,
    user_agent,
    device_info,
    geolocation,
    metadata_json
)
OUTPUT INSERTED.log_id, INSERTED.fecha_evento
VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);
]
(Background on this error at: https://sqlalche.me/e/20/dbapi)
2025-12-03 20:13:02,422 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/login/ 500 186.6ms
2025-12-03 20:16:44,287 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Pool ADMIN inicializado. Size=10, MaxOverflow=5
2025-12-03 20:16:44,287 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Configuración de pools de tenants: MaxPools=50, PoolSize=3, MaxOverflow=2, InactivityTimeout=3600s
2025-12-03 20:16:44,288 - app.infrastructure.database.connection_pool - INFO - ✅ Módulo de connection pooling cargado y activo
2025-12-03 20:16:44,288 - app.infrastructure.database.connection_pool - INFO -    Configuración: MaxTenantPools=50, TenantPoolSize=3, InactivityTimeout=3600s
2025-12-03 20:16:44,288 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Todos los pools cerrados
2025-12-03 20:16:44,288 - app.main - INFO - ✅ Pools de conexión cerrados correctamente
2025-12-03 20:16:45,098 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 20:16:45,303 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 20:16:45,303 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 20:16:45,311 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 20:16:45,311 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 20:16:45,312 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 20:16:45,312 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 20:16:45,312 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, DEFAULT_TYPE=single
2025-12-03 20:16:45,643 - app.core.security.rate_limiting - INFO - [RATE_LIMITING] Activado. Límites: Login=10/minute, API=200/minute
2025-12-03 20:16:45,643 - app.core.security.rate_limiting - INFO - ✅ Módulo de rate limiting cargado y activo
2025-12-03 20:16:45,713 - app.core.authorization.rbac - INFO - 🔐 Inicializando sistema de autorización...
2025-12-03 20:16:45,713 - app.core.authorization.rbac - INFO - ✅ Sistema de autorización inicializado correctamente
2025-12-03 20:16:45,713 - app.core.authorization.rbac - INFO - 📊 Permisos del sistema: 6 módulos configurados
2025-12-03 20:16:45,881 - app.core.tenant.middleware - INFO - Módulo tenant_middleware cargado (versión híbrida con soporte para proxies)
2025-12-03 20:16:45,882 - app.main - INFO - ✅ Rate limiting configurado y activo
2025-12-03 20:16:46,023 - app.core.tenant.middleware - INFO - [TENANT_MW] Inicializado - BASE_DOMAIN=app.local, SYSTEM_ID=BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, EXCLUDED_SUBDOMAINS={'www', 'assets', 'static', 'api', 'cdn', 'backend', 'admin'}
2025-12-03 20:16:56,373 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/refresh/
2025-12-03 20:16:56,373 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 20:16:56,373 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 20:16:56,373 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 20:16:56,373 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 20:16:56,373 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 20:16:56,373 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 20:16:56,373 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 20:16:56,373 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 20:16:56,373 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 20:16:56,373 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 20:16:56,373 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/auth/refresh/
2025-12-03 20:16:56,385 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] AsyncEngine creado para admin
2025-12-03 20:16:56,545 - app.modules.auth.application.services.refresh_token_service - WARNING - [VALIDATE-TOKEN] Token no encontrado, revocado o expirado - Cliente bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 20:16:56,545 - app.modules.auth.application.services.auth_service - WARNING - [REFRESH] Token JWT válido, pero inactivo/revocado en BD. Usuario: superadmin
2025-12-03 20:16:56,545 - app.modules.superadmin.application.services.audit_service - ERROR - [AUDIT] Error registrando auth_audit_log: query debe ser string SQL o objeto SQLAlchemy Core (Insert), recibido: <class 'sqlalchemy.sql.elements.TextClause'>
Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\modules\superadmin\application\services\audit_service.py", line 82, in registrar_auth_event
    result = await execute_insert(
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 290, in execute_insert
    raise ValueError(
ValueError: query debe ser string SQL o objeto SQLAlchemy Core (Insert), recibido: <class 'sqlalchemy.sql.elements.TextClause'>
2025-12-03 20:16:56,547 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/refresh/ 401 172.5ms
2025-12-03 20:17:47,128 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/login/
2025-12-03 20:17:47,129 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 20:17:47,129 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 20:17:47,129 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 20:17:47,129 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 20:17:47,129 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 20:17:47,129 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 20:17:47,130 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 20:17:47,130 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 20:17:47,130 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 20:17:47,130 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 20:17:47,130 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/auth/login/
2025-12-03 20:17:47,149 - app.modules.auth.presentation.endpoints - INFO - Cliente bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7 resuelto y validado para login.
2025-12-03 20:17:47,149 - app.modules.auth.application.services.auth_service - INFO - [AUTH] Intento de login: username='superadmin', cliente_id_destino=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 20:17:47,149 - app.modules.auth.application.services.auth_service - INFO - [AUTH] SUPERADMIN detectado. Buscando en BD ADMIN (cliente_id=BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7), accediendo a cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 20:17:47,404 - app.infrastructure.database.queries_async - WARNING - [QUERY] DEPRECATED: execute_query() recibió string SQL. Migrar a SQLAlchemy Core.
2025-12-03 20:17:47,404 - app.infrastructure.database.queries_async - ERROR - Error en execute_query async (string): (pyodbc.Error) ('07002', '[07002] [Microsoft][ODBC Driver 17 for SQL Server]COUNT field incorrect or syntax error (0) (SQLExecDirectW)')
[SQL: 
SELECT 
    ISNULL(MAX(r.nivel_acceso), 1) as max_level,
    COUNT(CASE WHEN r.codigo_rol = 'SUPER_ADMIN' AND r.nivel_acceso = 5 THEN 1 END) as super_admin_count,
    COUNT(*) as total_roles
FROM usuario_rol ur
INNER JOIN rol r ON ur.rol_id = r.rol_id
WHERE ur.usuario_id = ? 
  AND ur.es_activo = 1
  AND r.es_activo = 1
  AND (r.cliente_id = ? OR r.cliente_id IS NULL)
]
(Background on this error at: https://sqlalche.me/e/20/dbapi)
2025-12-03 20:17:47,411 - app.infrastructure.database.connection_async - ERROR - [ASYNC_CONNECTION] Error en sesión async: Error en la consulta: (pyodbc.Error) ('07002', '[07002] [Microsoft][ODBC Driver 17 for SQL Server]COUNT field incorrect or syntax error (0) (SQLExecDirectW)')
[SQL: 
SELECT 
    ISNULL(MAX(r.nivel_acceso), 1) as max_level,
    COUNT(CASE WHEN r.codigo_rol = 'SUPER_ADMIN' AND r.nivel_acceso = 5 THEN 1 END) as super_admin_count,
    COUNT(*) as total_roles
FROM usuario_rol ur
INNER JOIN rol r ON ur.rol_id = r.rol_id
WHERE ur.usuario_id = ? 
  AND ur.es_activo = 1
  AND r.es_activo = 1
  AND (r.cliente_id = ? OR r.cliente_id IS NULL)
]
(Background on this error at: https://sqlalche.me/e/20/dbapi)
Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 230, in execute
    self._adapt_connection._handle_exception(error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 368, in _handle_exception
    raise error.with_traceback(exc_info[2])
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 228, in execute
    return self.await_(self._execute_async(operation, parameters))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 251, in _execute_async
    result = await self._cursor.execute(operation, parameters)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 132, in execute
    await self._run_operation(self._impl.execute, sql, *params)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 30, in _run_operation
    result = await self._conn._execute(func, *args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\concurrent\futures\thread.py", line 59, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
pyodbc.Error: ('07002', '[07002] [Microsoft][ODBC Driver 17 for SQL Server]COUNT field incorrect or syntax error (0) (SQLExecDirectW)')

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 147, in execute_query
    result = await session.execute(text(query))
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 449, in execute
    result = await greenlet_spawn(
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 203, in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2351, in execute
    return self._execute_internal(
           ^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2258, in _execute_internal
    result = conn.execute(
             ^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1419, in execute
    return meth(
           ^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\sql\elements.py", line 526, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1641, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1846, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1986, in _exec_single_context
    self._handle_dbapi_exception(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 2355, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 230, in execute
    self._adapt_connection._handle_exception(error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 368, in _handle_exception
    raise error.with_traceback(exc_info[2])
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 228, in execute
    return self.await_(self._execute_async(operation, parameters))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 251, in _execute_async
    result = await self._cursor.execute(operation, parameters)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 132, in execute
    await self._run_operation(self._impl.execute, sql, *params)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 30, in _run_operation
    result = await self._conn._execute(func, *args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\concurrent\futures\thread.py", line 59, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
sqlalchemy.exc.DBAPIError: (pyodbc.Error) ('07002', '[07002] [Microsoft][ODBC Driver 17 for SQL Server]COUNT field incorrect or syntax error (0) (SQLExecDirectW)')
[SQL: 
SELECT 
    ISNULL(MAX(r.nivel_acceso), 1) as max_level,
    COUNT(CASE WHEN r.codigo_rol = 'SUPER_ADMIN' AND r.nivel_acceso = 5 THEN 1 END) as super_admin_count,
    COUNT(*) as total_roles
FROM usuario_rol ur
INNER JOIN rol r ON ur.rol_id = r.rol_id
WHERE ur.usuario_id = ? 
  AND ur.es_activo = 1
  AND r.es_activo = 1
  AND (r.cliente_id = ? OR r.cliente_id IS NULL)
]
(Background on this error at: https://sqlalche.me/e/20/dbapi)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\connection_async.py", line 303, in get_db_connection
    yield session
  File "D:\base_multi_tenant_fastapi\app\core\tenant\routing.py", line 672, in get_connection_for_tenant
    yield session
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 154, in execute_query
    raise DatabaseError(
app.core.exceptions.DatabaseError: Error en la consulta: (pyodbc.Error) ('07002', '[07002] [Microsoft][ODBC Driver 17 for SQL Server]COUNT field incorrect or syntax error (0) (SQLExecDirectW)')
[SQL: 
SELECT 
    ISNULL(MAX(r.nivel_acceso), 1) as max_level,
    COUNT(CASE WHEN r.codigo_rol = 'SUPER_ADMIN' AND r.nivel_acceso = 5 THEN 1 END) as super_admin_count,
    COUNT(*) as total_roles
FROM usuario_rol ur
INNER JOIN rol r ON ur.rol_id = r.rol_id
WHERE ur.usuario_id = ? 
  AND ur.es_activo = 1
  AND r.es_activo = 1
  AND (r.cliente_id = ? OR r.cliente_id IS NULL)
]
(Background on this error at: https://sqlalche.me/e/20/dbapi)
2025-12-03 20:17:47,419 - app.modules.auth.application.services.auth_service - ERROR - Error al obtener niveles de acceso para usuario 154134AD-A5EB-4F45-AEF0-5F9AAA282C8E: Error en la consulta: (pyodbc.Error) ('07002', '[07002] [Microsoft][ODBC Driver 17 for SQL Server]COUNT field incorrect or syntax error (0) (SQLExecDirectW)')
[SQL: 
SELECT 
    ISNULL(MAX(r.nivel_acceso), 1) as max_level,
    COUNT(CASE WHEN r.codigo_rol = 'SUPER_ADMIN' AND r.nivel_acceso = 5 THEN 1 END) as super_admin_count,
    COUNT(*) as total_roles
FROM usuario_rol ur
INNER JOIN rol r ON ur.rol_id = r.rol_id
WHERE ur.usuario_id = ? 
  AND ur.es_activo = 1
  AND r.es_activo = 1
  AND (r.cliente_id = ? OR r.cliente_id IS NULL)
]
(Background on this error at: https://sqlalche.me/e/20/dbapi)
2025-12-03 20:17:47,419 - app.modules.auth.application.services.auth_service - INFO - [AUTH] Login exitoso: username='superadmin', usuario_id=154134AD-A5EB-4F45-AEF0-5F9AAA282C8E, cliente_origen=BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, cliente_destino=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, access_level=1, user_type=user
2025-12-03 20:17:47,420 - app.modules.auth.presentation.endpoints - INFO - [LOGIN] Superadmin accediendo a cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 20:17:47,420 - app.modules.auth.presentation.endpoints - ERROR - Error inesperado en /login/ para usuario superadmin: 'coroutine' object has no attribute 'get'
Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\modules\auth\presentation\endpoints.py", line 205, in login
    access_token = create_access_token(data=token_data)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\core\security\jwt.py", line 40, in create_access_token
    "access_level": level_info.get('access_level', 1),
                    ^^^^^^^^^^^^^^
AttributeError: 'coroutine' object has no attribute 'get'
2025-12-03 20:17:47,422 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/login/ 500 292.5ms
2025-12-03 20:20:05,193 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Pool ADMIN inicializado. Size=10, MaxOverflow=5
2025-12-03 20:20:05,194 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Configuración de pools de tenants: MaxPools=50, PoolSize=3, MaxOverflow=2, InactivityTimeout=3600s
2025-12-03 20:20:05,194 - app.infrastructure.database.connection_pool - INFO - ✅ Módulo de connection pooling cargado y activo
2025-12-03 20:20:05,194 - app.infrastructure.database.connection_pool - INFO -    Configuración: MaxTenantPools=50, TenantPoolSize=3, InactivityTimeout=3600s
2025-12-03 20:20:05,194 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Todos los pools cerrados
2025-12-03 20:20:05,194 - app.main - INFO - ✅ Pools de conexión cerrados correctamente
2025-12-03 20:20:06,060 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 20:20:06,256 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 20:20:06,258 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 20:20:06,269 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 20:20:06,270 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 20:20:06,270 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 20:20:06,270 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 20:20:06,270 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, DEFAULT_TYPE=single
2025-12-03 20:20:13,717 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 20:20:13,917 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 20:20:13,922 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 20:20:13,926 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 20:20:13,926 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 20:20:13,927 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 20:20:13,927 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 20:20:13,927 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, DEFAULT_TYPE=single
2025-12-03 20:20:32,307 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Pool ADMIN inicializado. Size=10, MaxOverflow=5
2025-12-03 20:20:32,307 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Configuración de pools de tenants: MaxPools=50, PoolSize=3, MaxOverflow=2, InactivityTimeout=3600s
2025-12-03 20:20:32,307 - app.infrastructure.database.connection_pool - INFO - ✅ Módulo de connection pooling cargado y activo
2025-12-03 20:20:32,307 - app.infrastructure.database.connection_pool - INFO -    Configuración: MaxTenantPools=50, TenantPoolSize=3, InactivityTimeout=3600s
2025-12-03 20:20:32,307 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Todos los pools cerrados
2025-12-03 20:20:32,307 - app.main - INFO - ✅ Pools de conexión cerrados correctamente
2025-12-03 20:20:33,053 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 20:20:33,227 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 20:20:33,245 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 20:20:33,247 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 20:20:33,247 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 20:20:33,248 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 20:20:33,248 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 20:20:33,248 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, DEFAULT_TYPE=single
2025-12-03 20:21:03,537 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 20:21:03,669 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 20:21:03,762 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 20:21:03,769 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 20:21:03,777 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 20:21:03,777 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 20:21:03,777 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 20:21:03,777 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 20:21:03,777 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, DEFAULT_TYPE=single
2025-12-03 20:21:03,928 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 20:21:03,937 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 20:21:03,937 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 20:21:03,937 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 20:21:03,937 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 20:21:03,942 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 20:21:03,942 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, DEFAULT_TYPE=single
2025-12-03 20:21:04,262 - app.core.security.rate_limiting - INFO - [RATE_LIMITING] Activado. Límites: Login=10/minute, API=200/minute
2025-12-03 20:21:04,262 - app.core.security.rate_limiting - INFO - ✅ Módulo de rate limiting cargado y activo
2025-12-03 20:21:04,370 - app.core.authorization.rbac - INFO - 🔐 Inicializando sistema de autorización...
2025-12-03 20:21:04,370 - app.core.authorization.rbac - INFO - ✅ Sistema de autorización inicializado correctamente
2025-12-03 20:21:04,370 - app.core.authorization.rbac - INFO - 📊 Permisos del sistema: 6 módulos configurados
2025-12-03 20:21:04,403 - app.core.security.rate_limiting - INFO - [RATE_LIMITING] Activado. Límites: Login=10/minute, API=200/minute
2025-12-03 20:21:04,403 - app.core.security.rate_limiting - INFO - ✅ Módulo de rate limiting cargado y activo
2025-12-03 20:21:04,512 - app.core.authorization.rbac - INFO - 🔐 Inicializando sistema de autorización...
2025-12-03 20:21:04,512 - app.core.authorization.rbac - INFO - ✅ Sistema de autorización inicializado correctamente
2025-12-03 20:21:04,512 - app.core.authorization.rbac - INFO - 📊 Permisos del sistema: 6 módulos configurados
2025-12-03 20:21:04,613 - app.core.tenant.middleware - INFO - Módulo tenant_middleware cargado (versión híbrida con soporte para proxies)
2025-12-03 20:21:04,613 - app.main - INFO - ✅ Rate limiting configurado y activo
2025-12-03 20:21:04,720 - app.core.tenant.middleware - INFO - Módulo tenant_middleware cargado (versión híbrida con soporte para proxies)
2025-12-03 20:21:04,720 - app.main - INFO - ✅ Rate limiting configurado y activo
2025-12-03 20:21:04,778 - app.core.tenant.middleware - INFO - [TENANT_MW] Inicializado - BASE_DOMAIN=app.local, SYSTEM_ID=BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, EXCLUDED_SUBDOMAINS={'www', 'admin', 'assets', 'cdn', 'api', 'backend', 'static'}
2025-12-03 20:21:04,885 - app.core.tenant.middleware - INFO - [TENANT_MW] Inicializado - BASE_DOMAIN=app.local, SYSTEM_ID=BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, EXCLUDED_SUBDOMAINS={'api', 'assets', 'www', 'cdn', 'static', 'admin', 'backend'}
2025-12-03 20:21:19,201 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Pool ADMIN inicializado. Size=10, MaxOverflow=5
2025-12-03 20:21:19,204 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Configuración de pools de tenants: MaxPools=50, PoolSize=3, MaxOverflow=2, InactivityTimeout=3600s
2025-12-03 20:21:19,204 - app.infrastructure.database.connection_pool - INFO - ✅ Módulo de connection pooling cargado y activo
2025-12-03 20:21:19,204 - app.infrastructure.database.connection_pool - INFO -    Configuración: MaxTenantPools=50, TenantPoolSize=3, InactivityTimeout=3600s
2025-12-03 20:21:19,204 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Todos los pools cerrados
2025-12-03 20:21:19,204 - app.main - INFO - ✅ Pools de conexión cerrados correctamente
2025-12-03 20:21:20,009 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 20:21:20,202 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 20:21:20,208 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 20:21:20,214 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 20:21:20,214 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 20:21:20,214 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 20:21:20,214 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 20:21:20,214 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, DEFAULT_TYPE=single
2025-12-03 20:21:20,526 - app.core.security.rate_limiting - INFO - [RATE_LIMITING] Activado. Límites: Login=10/minute, API=200/minute
2025-12-03 20:21:20,526 - app.core.security.rate_limiting - INFO - ✅ Módulo de rate limiting cargado y activo
2025-12-03 20:21:20,594 - app.core.authorization.rbac - INFO - 🔐 Inicializando sistema de autorización...
2025-12-03 20:21:20,594 - app.core.authorization.rbac - INFO - ✅ Sistema de autorización inicializado correctamente
2025-12-03 20:21:20,597 - app.core.authorization.rbac - INFO - 📊 Permisos del sistema: 6 módulos configurados
2025-12-03 20:21:20,751 - app.core.tenant.middleware - INFO - Módulo tenant_middleware cargado (versión híbrida con soporte para proxies)
2025-12-03 20:21:20,751 - app.main - INFO - ✅ Rate limiting configurado y activo
2025-12-03 20:21:20,902 - app.core.tenant.middleware - INFO - [TENANT_MW] Inicializado - BASE_DOMAIN=app.local, SYSTEM_ID=BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, EXCLUDED_SUBDOMAINS={'admin', 'www', 'assets', 'api', 'cdn', 'backend', 'static'}
2025-12-03 20:21:27,005 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/auth/refresh/
2025-12-03 20:21:27,006 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/auth/refresh/ 200 0.8ms
2025-12-03 20:21:27,008 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/refresh/
2025-12-03 20:21:27,009 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 20:21:27,009 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 20:21:27,009 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 20:21:27,009 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 20:21:27,009 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 20:21:27,009 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 20:21:27,010 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 20:21:27,010 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 20:21:27,010 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 20:21:27,010 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 20:21:27,010 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/auth/refresh/
2025-12-03 20:21:27,018 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] AsyncEngine creado para admin
2025-12-03 20:21:27,158 - app.modules.auth.application.services.refresh_token_service - WARNING - [VALIDATE-TOKEN] Token no encontrado, revocado o expirado - Cliente bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 20:21:27,158 - app.modules.auth.application.services.auth_service - WARNING - [REFRESH] Token JWT válido, pero inactivo/revocado en BD. Usuario: superadmin
2025-12-03 20:21:31,844 - app.infrastructure.cache.redis_cache - WARNING - [REDIS_CACHE] Error conectando a Redis: Error 10061 connecting to localhost:6379. No se puede establecer una conexión ya que el equipo de destino denegó expresamente dicha conexión.. Cache desactivado automáticamente (usando fallback en memoria).
2025-12-03 20:21:31,844 - app.infrastructure.cache.redis_cache - INFO - ℹ️ Módulo de Redis cache cargado pero desactivado (usando fallback en memoria)
2025-12-03 20:21:31,858 - app.core.tenant.routing - WARNING - [METADATA] No se encontró metadata para cliente 00000000-0000-0000-0000-000000000001. Usando Single-DB como fallback.
2025-12-03 20:21:31,860 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] AsyncEngine creado para tenant_00000000-0000-0000-0000-000000000001
2025-12-03 20:21:31,880 - app.infrastructure.database.queries_async - ERROR - Error en execute_insert async (TextClause): (pyodbc.DataError) ('22018', '[22018] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Operand type clash: int is incompatible with uniqueidentifier (206) (SQLExecDirectW); [22018] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Statement(s) could not be prepared. (8180)')
[SQL: 
INSERT INTO auth_audit_log (
    cliente_id,
    usuario_id,
    evento,
    nombre_usuario_intento,
    descripcion,
    exito,
    codigo_error,
    ip_address,
    user_agent,
    device_info,
    geolocation,
    metadata_json
)
OUTPUT INSERTED.log_id, INSERTED.fecha_evento
VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);
]
[parameters: (1, None, 'token_invalid_or_revoked', 'superadmin', 'Refresh token inválido, expirado o revocado en base de datos', 0, 'REFRESH_TOKEN_INVALID_DB', '127.0.0.1', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36', None, None, '{"client_type": "web"}')]
(Background on this error at: https://sqlalche.me/e/20/9h9h)
2025-12-03 20:21:31,880 - app.infrastructure.database.connection_async - ERROR - [ASYNC_CONNECTION] Error en sesión async: Error en la inserción: (pyodbc.DataError) ('22018', '[22018] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Operand type clash: int is incompatible with uniqueidentifier (206) (SQLExecDirectW); [22018] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Statement(s) could not be prepared. (8180)')
[SQL: 
INSERT INTO auth_audit_log (
    cliente_id,
    usuario_id,
    evento,
    nombre_usuario_intento,
    descripcion,
    exito,
    codigo_error,
    ip_address,
    user_agent,
    device_info,
    geolocation,
    metadata_json
)
OUTPUT INSERTED.log_id, INSERTED.fecha_evento
VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);
]
[parameters: (1, None, 'token_invalid_or_revoked', 'superadmin', 'Refresh token inválido, expirado o revocado en base de datos', 0, 'REFRESH_TOKEN_INVALID_DB', '127.0.0.1', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36', None, None, '{"client_type": "web"}')]
(Background on this error at: https://sqlalche.me/e/20/9h9h)
Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 230, in execute
    self._adapt_connection._handle_exception(error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 368, in _handle_exception
    raise error.with_traceback(exc_info[2])
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 228, in execute
    return self.await_(self._execute_async(operation, parameters))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 251, in _execute_async
    result = await self._cursor.execute(operation, parameters)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 132, in execute
    await self._run_operation(self._impl.execute, sql, *params)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 30, in _run_operation
    result = await self._conn._execute(func, *args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\concurrent\futures\thread.py", line 59, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
pyodbc.DataError: ('22018', '[22018] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Operand type clash: int is incompatible with uniqueidentifier (206) (SQLExecDirectW); [22018] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Statement(s) could not be prepared. (8180)')

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 270, in execute_insert
    result = await session.execute(query)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 449, in execute
    result = await greenlet_spawn(
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 203, in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2351, in execute
    return self._execute_internal(
           ^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2258, in _execute_internal
    result = conn.execute(
             ^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1419, in execute
    return meth(
           ^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\sql\elements.py", line 526, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1641, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1846, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1986, in _exec_single_context
    self._handle_dbapi_exception(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 2355, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 230, in execute
    self._adapt_connection._handle_exception(error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 368, in _handle_exception
    raise error.with_traceback(exc_info[2])
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 228, in execute
    return self.await_(self._execute_async(operation, parameters))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 251, in _execute_async
    result = await self._cursor.execute(operation, parameters)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 132, in execute
    await self._run_operation(self._impl.execute, sql, *params)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 30, in _run_operation
    result = await self._conn._execute(func, *args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\concurrent\futures\thread.py", line 59, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
sqlalchemy.exc.DataError: (pyodbc.DataError) ('22018', '[22018] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Operand type clash: int is incompatible with uniqueidentifier (206) (SQLExecDirectW); [22018] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Statement(s) could not be prepared. (8180)')
[SQL: 
INSERT INTO auth_audit_log (
    cliente_id,
    usuario_id,
    evento,
    nombre_usuario_intento,
    descripcion,
    exito,
    codigo_error,
    ip_address,
    user_agent,
    device_info,
    geolocation,
    metadata_json
)
OUTPUT INSERTED.log_id, INSERTED.fecha_evento
VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);
]
[parameters: (1, None, 'token_invalid_or_revoked', 'superadmin', 'Refresh token inválido, expirado o revocado en base de datos', 0, 'REFRESH_TOKEN_INVALID_DB', '127.0.0.1', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36', None, None, '{"client_type": "web"}')]
(Background on this error at: https://sqlalche.me/e/20/9h9h)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\connection_async.py", line 303, in get_db_connection
    yield session
  File "D:\base_multi_tenant_fastapi\app\core\tenant\routing.py", line 700, in get_connection_for_tenant
    yield session
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 286, in execute_insert
    raise DatabaseError(
app.core.exceptions.DatabaseError: Error en la inserción: (pyodbc.DataError) ('22018', '[22018] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Operand type clash: int is incompatible with uniqueidentifier (206) (SQLExecDirectW); [22018] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Statement(s) could not be prepared. (8180)')
[SQL: 
INSERT INTO auth_audit_log (
    cliente_id,
    usuario_id,
    evento,
    nombre_usuario_intento,
    descripcion,
    exito,
    codigo_error,
    ip_address,
    user_agent,
    device_info,
    geolocation,
    metadata_json
)
OUTPUT INSERTED.log_id, INSERTED.fecha_evento
VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);
]
[parameters: (1, None, 'token_invalid_or_revoked', 'superadmin', 'Refresh token inválido, expirado o revocado en base de datos', 0, 'REFRESH_TOKEN_INVALID_DB', '127.0.0.1', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36', None, None, '{"client_type": "web"}')]
(Background on this error at: https://sqlalche.me/e/20/9h9h)
2025-12-03 20:21:31,888 - app.core.application.base_service - ERROR - DatabaseError en registrar_auth_event: Error en la inserción: (pyodbc.DataError) ('22018', '[22018] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Operand type clash: int is incompatible with uniqueidentifier (206) (SQLExecDirectW); [22018] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Statement(s) could not be prepared. (8180)')
[SQL: 
INSERT INTO auth_audit_log (
    cliente_id,
    usuario_id,
    evento,
    nombre_usuario_intento,
    descripcion,
    exito,
    codigo_error,
    ip_address,
    user_agent,
    device_info,
    geolocation,
    metadata_json
)
OUTPUT INSERTED.log_id, INSERTED.fecha_evento
VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);
]
[parameters: (1, None, 'token_invalid_or_revoked', 'superadmin', 'Refresh token inválido, expirado o revocado en base de datos', 0, 'REFRESH_TOKEN_INVALID_DB', '127.0.0.1', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36', None, None, '{"client_type": "web"}')]
(Background on this error at: https://sqlalche.me/e/20/9h9h)
Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 230, in execute
    self._adapt_connection._handle_exception(error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 368, in _handle_exception
    raise error.with_traceback(exc_info[2])
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 228, in execute
    return self.await_(self._execute_async(operation, parameters))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 251, in _execute_async
    result = await self._cursor.execute(operation, parameters)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 132, in execute
    await self._run_operation(self._impl.execute, sql, *params)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 30, in _run_operation
    result = await self._conn._execute(func, *args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\concurrent\futures\thread.py", line 59, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
pyodbc.DataError: ('22018', '[22018] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Operand type clash: int is incompatible with uniqueidentifier (206) (SQLExecDirectW); [22018] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Statement(s) could not be prepared. (8180)')

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 270, in execute_insert
    result = await session.execute(query)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 449, in execute
    result = await greenlet_spawn(
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 203, in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2351, in execute
    return self._execute_internal(
           ^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2258, in _execute_internal
    result = conn.execute(
             ^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1419, in execute
    return meth(
           ^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\sql\elements.py", line 526, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1641, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1846, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1986, in _exec_single_context
    self._handle_dbapi_exception(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 2355, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 230, in execute
    self._adapt_connection._handle_exception(error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 368, in _handle_exception
    raise error.with_traceback(exc_info[2])
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 228, in execute
    return self.await_(self._execute_async(operation, parameters))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 251, in _execute_async
    result = await self._cursor.execute(operation, parameters)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 132, in execute
    await self._run_operation(self._impl.execute, sql, *params)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 30, in _run_operation
    result = await self._conn._execute(func, *args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\concurrent\futures\thread.py", line 59, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
sqlalchemy.exc.DataError: (pyodbc.DataError) ('22018', '[22018] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Operand type clash: int is incompatible with uniqueidentifier (206) (SQLExecDirectW); [22018] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Statement(s) could not be prepared. (8180)')
[SQL: 
INSERT INTO auth_audit_log (
    cliente_id,
    usuario_id,
    evento,
    nombre_usuario_intento,
    descripcion,
    exito,
    codigo_error,
    ip_address,
    user_agent,
    device_info,
    geolocation,
    metadata_json
)
OUTPUT INSERTED.log_id, INSERTED.fecha_evento
VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);
]
[parameters: (1, None, 'token_invalid_or_revoked', 'superadmin', 'Refresh token inválido, expirado o revocado en base de datos', 0, 'REFRESH_TOKEN_INVALID_DB', '127.0.0.1', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36', None, None, '{"client_type": "web"}')]
(Background on this error at: https://sqlalche.me/e/20/9h9h)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\core\application\base_service.py", line 52, in wrapper
    return await func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\modules\superadmin\application\services\audit_service.py", line 82, in registrar_auth_event
    result = await execute_insert(
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 286, in execute_insert
    raise DatabaseError(
app.core.exceptions.DatabaseError: Error en la inserción: (pyodbc.DataError) ('22018', '[22018] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Operand type clash: int is incompatible with uniqueidentifier (206) (SQLExecDirectW); [22018] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Statement(s) could not be prepared. (8180)')
[SQL: 
INSERT INTO auth_audit_log (
    cliente_id,
    usuario_id,
    evento,
    nombre_usuario_intento,
    descripcion,
    exito,
    codigo_error,
    ip_address,
    user_agent,
    device_info,
    geolocation,
    metadata_json
)
OUTPUT INSERTED.log_id, INSERTED.fecha_evento
VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);
]
[parameters: (1, None, 'token_invalid_or_revoked', 'superadmin', 'Refresh token inválido, expirado o revocado en base de datos', 0, 'REFRESH_TOKEN_INVALID_DB', '127.0.0.1', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36', None, None, '{"client_type": "web"}')]
(Background on this error at: https://sqlalche.me/e/20/9h9h)
2025-12-03 20:21:31,895 - app.modules.auth.application.services.auth_service - ERROR - [AUDIT] Error registrando evento token_invalid_or_revoked (no crítico)
Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 230, in execute
    self._adapt_connection._handle_exception(error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 368, in _handle_exception
    raise error.with_traceback(exc_info[2])
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 228, in execute
    return self.await_(self._execute_async(operation, parameters))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 251, in _execute_async
    result = await self._cursor.execute(operation, parameters)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 132, in execute
    await self._run_operation(self._impl.execute, sql, *params)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 30, in _run_operation
    result = await self._conn._execute(func, *args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\concurrent\futures\thread.py", line 59, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
pyodbc.DataError: ('22018', '[22018] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Operand type clash: int is incompatible with uniqueidentifier (206) (SQLExecDirectW); [22018] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Statement(s) could not be prepared. (8180)')

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 270, in execute_insert
    result = await session.execute(query)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 449, in execute
    result = await greenlet_spawn(
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 203, in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2351, in execute
    return self._execute_internal(
           ^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2258, in _execute_internal
    result = conn.execute(
             ^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1419, in execute
    return meth(
           ^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\sql\elements.py", line 526, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1641, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1846, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1986, in _exec_single_context
    self._handle_dbapi_exception(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 2355, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 230, in execute
    self._adapt_connection._handle_exception(error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 368, in _handle_exception
    raise error.with_traceback(exc_info[2])
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 228, in execute
    return self.await_(self._execute_async(operation, parameters))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 251, in _execute_async
    result = await self._cursor.execute(operation, parameters)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 132, in execute
    await self._run_operation(self._impl.execute, sql, *params)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 30, in _run_operation
    result = await self._conn._execute(func, *args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\concurrent\futures\thread.py", line 59, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
sqlalchemy.exc.DataError: (pyodbc.DataError) ('22018', '[22018] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Operand type clash: int is incompatible with uniqueidentifier (206) (SQLExecDirectW); [22018] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Statement(s) could not be prepared. (8180)')
[SQL: 
INSERT INTO auth_audit_log (
    cliente_id,
    usuario_id,
    evento,
    nombre_usuario_intento,
    descripcion,
    exito,
    codigo_error,
    ip_address,
    user_agent,
    device_info,
    geolocation,
    metadata_json
)
OUTPUT INSERTED.log_id, INSERTED.fecha_evento
VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);
]
[parameters: (1, None, 'token_invalid_or_revoked', 'superadmin', 'Refresh token inválido, expirado o revocado en base de datos', 0, 'REFRESH_TOKEN_INVALID_DB', '127.0.0.1', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36', None, None, '{"client_type": "web"}')]
(Background on this error at: https://sqlalche.me/e/20/9h9h)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\modules\auth\application\services\auth_service.py", line 478, in get_current_user_from_refresh
    await AuditService.registrar_auth_event(
  File "D:\base_multi_tenant_fastapi\app\core\application\base_service.py", line 52, in wrapper
    return await func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\modules\superadmin\application\services\audit_service.py", line 82, in registrar_auth_event
    result = await execute_insert(
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 286, in execute_insert
    raise DatabaseError(
app.core.exceptions.DatabaseError: Error en la inserción: (pyodbc.DataError) ('22018', '[22018] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Operand type clash: int is incompatible with uniqueidentifier (206) (SQLExecDirectW); [22018] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Statement(s) could not be prepared. (8180)')
[SQL: 
INSERT INTO auth_audit_log (
    cliente_id,
    usuario_id,
    evento,
    nombre_usuario_intento,
    descripcion,
    exito,
    codigo_error,
    ip_address,
    user_agent,
    device_info,
    geolocation,
    metadata_json
)
OUTPUT INSERTED.log_id, INSERTED.fecha_evento
VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);
]
[parameters: (1, None, 'token_invalid_or_revoked', 'superadmin', 'Refresh token inválido, expirado o revocado en base de datos', 0, 'REFRESH_TOKEN_INVALID_DB', '127.0.0.1', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36', None, None, '{"client_type": "web"}')]
(Background on this error at: https://sqlalche.me/e/20/9h9h)
2025-12-03 20:21:31,898 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/refresh/ 401 4890.0ms
2025-12-03 20:21:40,222 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Pool ADMIN inicializado. Size=10, MaxOverflow=5
2025-12-03 20:21:40,222 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Configuración de pools de tenants: MaxPools=50, PoolSize=3, MaxOverflow=2, InactivityTimeout=3600s
2025-12-03 20:21:40,222 - app.infrastructure.database.connection_pool - INFO - ✅ Módulo de connection pooling cargado y activo
2025-12-03 20:21:40,222 - app.infrastructure.database.connection_pool - INFO -    Configuración: MaxTenantPools=50, TenantPoolSize=3, InactivityTimeout=3600s
2025-12-03 20:21:40,227 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Todos los pools cerrados
2025-12-03 20:21:40,227 - app.main - INFO - ✅ Pools de conexión cerrados correctamente
2025-12-03 20:21:40,320 - asyncio - ERROR - Unclosed connection
connection: <aioodbc.connection.Connection object at 0x000002ACB2880110>
2025-12-03 20:21:40,321 - asyncio - ERROR - Unclosed connection
connection: <aioodbc.connection.Connection object at 0x000002ACB28F9AC0>
2025-12-03 20:21:42,488 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 20:21:42,690 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 20:21:42,698 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 20:21:42,701 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 20:21:42,701 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 20:21:42,702 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 20:21:42,702 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 20:21:42,702 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, DEFAULT_TYPE=single
2025-12-03 20:21:43,019 - app.core.security.rate_limiting - INFO - [RATE_LIMITING] Activado. Límites: Login=10/minute, API=200/minute
2025-12-03 20:21:43,019 - app.core.security.rate_limiting - INFO - ✅ Módulo de rate limiting cargado y activo
2025-12-03 20:21:43,082 - app.core.authorization.rbac - INFO - 🔐 Inicializando sistema de autorización...
2025-12-03 20:21:43,088 - app.core.authorization.rbac - INFO - ✅ Sistema de autorización inicializado correctamente
2025-12-03 20:21:43,088 - app.core.authorization.rbac - INFO - 📊 Permisos del sistema: 6 módulos configurados
2025-12-03 20:21:43,239 - app.core.tenant.middleware - INFO - Módulo tenant_middleware cargado (versión híbrida con soporte para proxies)
2025-12-03 20:21:43,239 - app.main - INFO - ✅ Rate limiting configurado y activo
2025-12-03 20:21:43,380 - app.core.tenant.middleware - INFO - [TENANT_MW] Inicializado - BASE_DOMAIN=app.local, SYSTEM_ID=BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, EXCLUDED_SUBDOMAINS={'assets', 'admin', 'cdn', 'www', 'backend', 'static', 'api'}
2025-12-03 20:21:45,866 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/refresh/
2025-12-03 20:21:45,866 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 20:21:45,867 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 20:21:45,867 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 20:21:45,867 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 20:21:45,867 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 20:21:45,867 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 20:21:45,867 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 20:21:45,868 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 20:21:45,868 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 20:21:45,868 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 20:21:45,868 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/auth/refresh/
2025-12-03 20:21:45,876 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] AsyncEngine creado para admin
2025-12-03 20:21:46,032 - app.modules.auth.application.services.refresh_token_service - WARNING - [VALIDATE-TOKEN] Token no encontrado, revocado o expirado - Cliente bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 20:21:46,033 - app.modules.auth.application.services.auth_service - WARNING - [REFRESH] Token JWT válido, pero inactivo/revocado en BD. Usuario: superadmin
2025-12-03 20:21:50,148 - app.infrastructure.cache.redis_cache - WARNING - [REDIS_CACHE] Error conectando a Redis: Error 10061 connecting to localhost:6379. No se puede establecer una conexión ya que el equipo de destino denegó expresamente dicha conexión.. Cache desactivado automáticamente (usando fallback en memoria).
2025-12-03 20:21:50,148 - app.infrastructure.cache.redis_cache - INFO - ℹ️ Módulo de Redis cache cargado pero desactivado (usando fallback en memoria)
2025-12-03 20:21:50,158 - app.core.tenant.routing - WARNING - [METADATA] No se encontró metadata para cliente 00000000-0000-0000-0000-000000000001. Usando Single-DB como fallback.
2025-12-03 20:21:50,158 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] AsyncEngine creado para tenant_00000000-0000-0000-0000-000000000001
2025-12-03 20:21:50,171 - app.infrastructure.database.queries_async - ERROR - Error en execute_insert async (TextClause): (pyodbc.DataError) ('22018', '[22018] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Operand type clash: int is incompatible with uniqueidentifier (206) (SQLExecDirectW); [22018] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Statement(s) could not be prepared. (8180)')
[SQL: 
INSERT INTO auth_audit_log (
    cliente_id,
    usuario_id,
    evento,
    nombre_usuario_intento,
    descripcion,
    exito,
    codigo_error,
    ip_address,
    user_agent,
    device_info,
    geolocation,
    metadata_json
)
OUTPUT INSERTED.log_id, INSERTED.fecha_evento
VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);
]
[parameters: (1, None, 'token_invalid_or_revoked', 'superadmin', 'Refresh token inválido, expirado o revocado en base de datos', 0, 'REFRESH_TOKEN_INVALID_DB', '127.0.0.1', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36', None, None, '{"client_type": "web"}')]
(Background on this error at: https://sqlalche.me/e/20/9h9h)
2025-12-03 20:21:50,171 - app.infrastructure.database.connection_async - ERROR - [ASYNC_CONNECTION] Error en sesión async: Error en la inserción: (pyodbc.DataError) ('22018', '[22018] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Operand type clash: int is incompatible with uniqueidentifier (206) (SQLExecDirectW); [22018] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Statement(s) could not be prepared. (8180)')
[SQL: 
INSERT INTO auth_audit_log (
    cliente_id,
    usuario_id,
    evento,
    nombre_usuario_intento,
    descripcion,
    exito,
    codigo_error,
    ip_address,
    user_agent,
    device_info,
    geolocation,
    metadata_json
)
OUTPUT INSERTED.log_id, INSERTED.fecha_evento
VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);
]
[parameters: (1, None, 'token_invalid_or_revoked', 'superadmin', 'Refresh token inválido, expirado o revocado en base de datos', 0, 'REFRESH_TOKEN_INVALID_DB', '127.0.0.1', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36', None, None, '{"client_type": "web"}')]
(Background on this error at: https://sqlalche.me/e/20/9h9h)
Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 230, in execute
    self._adapt_connection._handle_exception(error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 368, in _handle_exception
    raise error.with_traceback(exc_info[2])
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 228, in execute
    return self.await_(self._execute_async(operation, parameters))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 251, in _execute_async
    result = await self._cursor.execute(operation, parameters)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 132, in execute
    await self._run_operation(self._impl.execute, sql, *params)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 30, in _run_operation
    result = await self._conn._execute(func, *args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\concurrent\futures\thread.py", line 59, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
pyodbc.DataError: ('22018', '[22018] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Operand type clash: int is incompatible with uniqueidentifier (206) (SQLExecDirectW); [22018] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Statement(s) could not be prepared. (8180)')

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 270, in execute_insert
    result = await session.execute(query)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 449, in execute
    result = await greenlet_spawn(
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 203, in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2351, in execute
    return self._execute_internal(
           ^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2258, in _execute_internal
    result = conn.execute(
             ^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1419, in execute
    return meth(
           ^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\sql\elements.py", line 526, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1641, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1846, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1986, in _exec_single_context
    self._handle_dbapi_exception(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 2355, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 230, in execute
    self._adapt_connection._handle_exception(error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 368, in _handle_exception
    raise error.with_traceback(exc_info[2])
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 228, in execute
    return self.await_(self._execute_async(operation, parameters))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 251, in _execute_async
    result = await self._cursor.execute(operation, parameters)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 132, in execute
    await self._run_operation(self._impl.execute, sql, *params)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 30, in _run_operation
    result = await self._conn._execute(func, *args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\concurrent\futures\thread.py", line 59, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
sqlalchemy.exc.DataError: (pyodbc.DataError) ('22018', '[22018] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Operand type clash: int is incompatible with uniqueidentifier (206) (SQLExecDirectW); [22018] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Statement(s) could not be prepared. (8180)')
[SQL: 
INSERT INTO auth_audit_log (
    cliente_id,
    usuario_id,
    evento,
    nombre_usuario_intento,
    descripcion,
    exito,
    codigo_error,
    ip_address,
    user_agent,
    device_info,
    geolocation,
    metadata_json
)
OUTPUT INSERTED.log_id, INSERTED.fecha_evento
VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);
]
[parameters: (1, None, 'token_invalid_or_revoked', 'superadmin', 'Refresh token inválido, expirado o revocado en base de datos', 0, 'REFRESH_TOKEN_INVALID_DB', '127.0.0.1', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36', None, None, '{"client_type": "web"}')]
(Background on this error at: https://sqlalche.me/e/20/9h9h)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\connection_async.py", line 303, in get_db_connection
    yield session
  File "D:\base_multi_tenant_fastapi\app\core\tenant\routing.py", line 700, in get_connection_for_tenant
    yield session
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 286, in execute_insert
    raise DatabaseError(
app.core.exceptions.DatabaseError: Error en la inserción: (pyodbc.DataError) ('22018', '[22018] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Operand type clash: int is incompatible with uniqueidentifier (206) (SQLExecDirectW); [22018] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Statement(s) could not be prepared. (8180)')
[SQL: 
INSERT INTO auth_audit_log (
    cliente_id,
    usuario_id,
    evento,
    nombre_usuario_intento,
    descripcion,
    exito,
    codigo_error,
    ip_address,
    user_agent,
    device_info,
    geolocation,
    metadata_json
)
OUTPUT INSERTED.log_id, INSERTED.fecha_evento
VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);
]
[parameters: (1, None, 'token_invalid_or_revoked', 'superadmin', 'Refresh token inválido, expirado o revocado en base de datos', 0, 'REFRESH_TOKEN_INVALID_DB', '127.0.0.1', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36', None, None, '{"client_type": "web"}')]
(Background on this error at: https://sqlalche.me/e/20/9h9h)
2025-12-03 20:21:50,183 - app.core.application.base_service - ERROR - DatabaseError en registrar_auth_event: Error en la inserción: (pyodbc.DataError) ('22018', '[22018] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Operand type clash: int is incompatible with uniqueidentifier (206) (SQLExecDirectW); [22018] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Statement(s) could not be prepared. (8180)')
[SQL: 
INSERT INTO auth_audit_log (
    cliente_id,
    usuario_id,
    evento,
    nombre_usuario_intento,
    descripcion,
    exito,
    codigo_error,
    ip_address,
    user_agent,
    device_info,
    geolocation,
    metadata_json
)
OUTPUT INSERTED.log_id, INSERTED.fecha_evento
VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);
]
[parameters: (1, None, 'token_invalid_or_revoked', 'superadmin', 'Refresh token inválido, expirado o revocado en base de datos', 0, 'REFRESH_TOKEN_INVALID_DB', '127.0.0.1', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36', None, None, '{"client_type": "web"}')]
(Background on this error at: https://sqlalche.me/e/20/9h9h)
Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 230, in execute
    self._adapt_connection._handle_exception(error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 368, in _handle_exception
    raise error.with_traceback(exc_info[2])
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 228, in execute
    return self.await_(self._execute_async(operation, parameters))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 251, in _execute_async
    result = await self._cursor.execute(operation, parameters)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 132, in execute
    await self._run_operation(self._impl.execute, sql, *params)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 30, in _run_operation
    result = await self._conn._execute(func, *args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\concurrent\futures\thread.py", line 59, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
pyodbc.DataError: ('22018', '[22018] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Operand type clash: int is incompatible with uniqueidentifier (206) (SQLExecDirectW); [22018] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Statement(s) could not be prepared. (8180)')

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 270, in execute_insert
    result = await session.execute(query)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 449, in execute
    result = await greenlet_spawn(
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 203, in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2351, in execute
    return self._execute_internal(
           ^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2258, in _execute_internal
    result = conn.execute(
             ^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1419, in execute
    return meth(
           ^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\sql\elements.py", line 526, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1641, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1846, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1986, in _exec_single_context
    self._handle_dbapi_exception(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 2355, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 230, in execute
    self._adapt_connection._handle_exception(error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 368, in _handle_exception
    raise error.with_traceback(exc_info[2])
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 228, in execute
    return self.await_(self._execute_async(operation, parameters))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 251, in _execute_async
    result = await self._cursor.execute(operation, parameters)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 132, in execute
    await self._run_operation(self._impl.execute, sql, *params)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 30, in _run_operation
    result = await self._conn._execute(func, *args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\concurrent\futures\thread.py", line 59, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
sqlalchemy.exc.DataError: (pyodbc.DataError) ('22018', '[22018] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Operand type clash: int is incompatible with uniqueidentifier (206) (SQLExecDirectW); [22018] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Statement(s) could not be prepared. (8180)')
[SQL: 
INSERT INTO auth_audit_log (
    cliente_id,
    usuario_id,
    evento,
    nombre_usuario_intento,
    descripcion,
    exito,
    codigo_error,
    ip_address,
    user_agent,
    device_info,
    geolocation,
    metadata_json
)
OUTPUT INSERTED.log_id, INSERTED.fecha_evento
VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);
]
[parameters: (1, None, 'token_invalid_or_revoked', 'superadmin', 'Refresh token inválido, expirado o revocado en base de datos', 0, 'REFRESH_TOKEN_INVALID_DB', '127.0.0.1', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36', None, None, '{"client_type": "web"}')]
(Background on this error at: https://sqlalche.me/e/20/9h9h)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\core\application\base_service.py", line 52, in wrapper
    return await func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\modules\superadmin\application\services\audit_service.py", line 82, in registrar_auth_event
    result = await execute_insert(
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 286, in execute_insert
    raise DatabaseError(
app.core.exceptions.DatabaseError: Error en la inserción: (pyodbc.DataError) ('22018', '[22018] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Operand type clash: int is incompatible with uniqueidentifier (206) (SQLExecDirectW); [22018] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Statement(s) could not be prepared. (8180)')
[SQL: 
INSERT INTO auth_audit_log (
    cliente_id,
    usuario_id,
    evento,
    nombre_usuario_intento,
    descripcion,
    exito,
    codigo_error,
    ip_address,
    user_agent,
    device_info,
    geolocation,
    metadata_json
)
OUTPUT INSERTED.log_id, INSERTED.fecha_evento
VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);
]
[parameters: (1, None, 'token_invalid_or_revoked', 'superadmin', 'Refresh token inválido, expirado o revocado en base de datos', 0, 'REFRESH_TOKEN_INVALID_DB', '127.0.0.1', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36', None, None, '{"client_type": "web"}')]
(Background on this error at: https://sqlalche.me/e/20/9h9h)
2025-12-03 20:21:50,188 - app.modules.auth.application.services.auth_service - ERROR - [AUDIT] Error registrando evento token_invalid_or_revoked (no crítico)
Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 230, in execute
    self._adapt_connection._handle_exception(error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 368, in _handle_exception
    raise error.with_traceback(exc_info[2])
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 228, in execute
    return self.await_(self._execute_async(operation, parameters))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 251, in _execute_async
    result = await self._cursor.execute(operation, parameters)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 132, in execute
    await self._run_operation(self._impl.execute, sql, *params)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 30, in _run_operation
    result = await self._conn._execute(func, *args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\concurrent\futures\thread.py", line 59, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
pyodbc.DataError: ('22018', '[22018] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Operand type clash: int is incompatible with uniqueidentifier (206) (SQLExecDirectW); [22018] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Statement(s) could not be prepared. (8180)')

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 270, in execute_insert
    result = await session.execute(query)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 449, in execute
    result = await greenlet_spawn(
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 203, in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2351, in execute
    return self._execute_internal(
           ^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2258, in _execute_internal
    result = conn.execute(
             ^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1419, in execute
    return meth(
           ^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\sql\elements.py", line 526, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1641, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1846, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1986, in _exec_single_context
    self._handle_dbapi_exception(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 2355, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 230, in execute
    self._adapt_connection._handle_exception(error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 368, in _handle_exception
    raise error.with_traceback(exc_info[2])
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 228, in execute
    return self.await_(self._execute_async(operation, parameters))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 251, in _execute_async
    result = await self._cursor.execute(operation, parameters)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 132, in execute
    await self._run_operation(self._impl.execute, sql, *params)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 30, in _run_operation
    result = await self._conn._execute(func, *args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\concurrent\futures\thread.py", line 59, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
sqlalchemy.exc.DataError: (pyodbc.DataError) ('22018', '[22018] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Operand type clash: int is incompatible with uniqueidentifier (206) (SQLExecDirectW); [22018] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Statement(s) could not be prepared. (8180)')
[SQL: 
INSERT INTO auth_audit_log (
    cliente_id,
    usuario_id,
    evento,
    nombre_usuario_intento,
    descripcion,
    exito,
    codigo_error,
    ip_address,
    user_agent,
    device_info,
    geolocation,
    metadata_json
)
OUTPUT INSERTED.log_id, INSERTED.fecha_evento
VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);
]
[parameters: (1, None, 'token_invalid_or_revoked', 'superadmin', 'Refresh token inválido, expirado o revocado en base de datos', 0, 'REFRESH_TOKEN_INVALID_DB', '127.0.0.1', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36', None, None, '{"client_type": "web"}')]
(Background on this error at: https://sqlalche.me/e/20/9h9h)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\modules\auth\application\services\auth_service.py", line 478, in get_current_user_from_refresh
    await AuditService.registrar_auth_event(
  File "D:\base_multi_tenant_fastapi\app\core\application\base_service.py", line 52, in wrapper
    return await func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\modules\superadmin\application\services\audit_service.py", line 82, in registrar_auth_event
    result = await execute_insert(
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 286, in execute_insert
    raise DatabaseError(
app.core.exceptions.DatabaseError: Error en la inserción: (pyodbc.DataError) ('22018', '[22018] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Operand type clash: int is incompatible with uniqueidentifier (206) (SQLExecDirectW); [22018] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Statement(s) could not be prepared. (8180)')
[SQL: 
INSERT INTO auth_audit_log (
    cliente_id,
    usuario_id,
    evento,
    nombre_usuario_intento,
    descripcion,
    exito,
    codigo_error,
    ip_address,
    user_agent,
    device_info,
    geolocation,
    metadata_json
)
OUTPUT INSERTED.log_id, INSERTED.fecha_evento
VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);
]
[parameters: (1, None, 'token_invalid_or_revoked', 'superadmin', 'Refresh token inválido, expirado o revocado en base de datos', 0, 'REFRESH_TOKEN_INVALID_DB', '127.0.0.1', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36', None, None, '{"client_type": "web"}')]
(Background on this error at: https://sqlalche.me/e/20/9h9h)
2025-12-03 20:21:50,192 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/refresh/ 401 4327.6ms
2025-12-03 20:25:32,464 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Pool ADMIN inicializado. Size=10, MaxOverflow=5
2025-12-03 20:25:32,464 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Configuración de pools de tenants: MaxPools=50, PoolSize=3, MaxOverflow=2, InactivityTimeout=3600s
2025-12-03 20:25:32,464 - app.infrastructure.database.connection_pool - INFO - ✅ Módulo de connection pooling cargado y activo
2025-12-03 20:25:32,464 - app.infrastructure.database.connection_pool - INFO -    Configuración: MaxTenantPools=50, TenantPoolSize=3, InactivityTimeout=3600s
2025-12-03 20:25:32,464 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Pool ADMIN inicializado. Size=10, MaxOverflow=5
2025-12-03 20:25:32,464 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Configuración de pools de tenants: MaxPools=50, PoolSize=3, MaxOverflow=2, InactivityTimeout=3600s
2025-12-03 20:25:32,464 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Todos los pools cerrados
2025-12-03 20:25:32,464 - app.main - INFO - ✅ Pools de conexión cerrados correctamente
2025-12-03 20:25:32,464 - app.infrastructure.database.connection_pool - INFO - ✅ Módulo de connection pooling cargado y activo
2025-12-03 20:25:32,464 - app.infrastructure.database.connection_pool - INFO -    Configuración: MaxTenantPools=50, TenantPoolSize=3, InactivityTimeout=3600s
2025-12-03 20:25:32,469 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Todos los pools cerrados
2025-12-03 20:25:32,469 - app.main - INFO - ✅ Pools de conexión cerrados correctamente
2025-12-03 20:25:32,573 - asyncio - ERROR - Unclosed connection
connection: <aioodbc.connection.Connection object at 0x0000028B3AD8F710>
2025-12-03 20:25:32,575 - asyncio - ERROR - Unclosed connection
connection: <aioodbc.connection.Connection object at 0x0000028B3B5B49E0>
2025-12-03 20:25:33,299 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 20:25:33,497 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 20:25:33,502 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 20:25:33,502 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 20:25:33,502 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 20:25:33,505 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 20:25:33,506 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 20:25:33,506 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 20:25:33,506 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, DEFAULT_TYPE=single
2025-12-03 20:25:33,741 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 20:25:33,748 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 20:25:33,748 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 20:25:33,751 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 20:25:33,751 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 20:25:33,752 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 20:25:33,752 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, DEFAULT_TYPE=single
2025-12-03 20:26:20,013 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 20:26:20,242 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 20:26:20,256 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 20:26:20,257 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 20:26:20,259 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 20:26:20,259 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 20:26:20,259 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 20:26:20,259 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, DEFAULT_TYPE=single
2025-12-03 20:26:20,353 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 20:26:20,536 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 20:26:20,542 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 20:26:20,546 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 20:26:20,546 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 20:26:20,546 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 20:26:20,547 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 20:26:20,547 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, DEFAULT_TYPE=single
2025-12-03 20:26:31,172 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 20:26:31,412 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 20:26:31,412 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 20:26:31,423 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 20:26:31,426 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 20:26:31,426 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 20:26:31,426 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 20:26:31,426 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 20:26:31,426 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, DEFAULT_TYPE=single
2025-12-03 20:26:31,630 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 20:26:31,633 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 20:26:31,639 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 20:26:31,639 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 20:26:31,639 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 20:26:31,639 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 20:26:31,639 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, DEFAULT_TYPE=single
2025-12-03 20:26:31,897 - app.core.security.rate_limiting - INFO - [RATE_LIMITING] Activado. Límites: Login=10/minute, API=200/minute
2025-12-03 20:26:31,897 - app.core.security.rate_limiting - INFO - ✅ Módulo de rate limiting cargado y activo
2025-12-03 20:26:31,973 - app.core.security.rate_limiting - INFO - [RATE_LIMITING] Activado. Límites: Login=10/minute, API=200/minute
2025-12-03 20:26:31,973 - app.core.security.rate_limiting - INFO - ✅ Módulo de rate limiting cargado y activo
2025-12-03 20:26:32,005 - app.core.authorization.rbac - INFO - 🔐 Inicializando sistema de autorización...
2025-12-03 20:26:32,005 - app.core.authorization.rbac - INFO - ✅ Sistema de autorización inicializado correctamente
2025-12-03 20:26:32,005 - app.core.authorization.rbac - INFO - 📊 Permisos del sistema: 6 módulos configurados
2025-12-03 20:26:32,042 - app.core.authorization.rbac - INFO - 🔐 Inicializando sistema de autorización...
2025-12-03 20:26:32,042 - app.core.authorization.rbac - INFO - ✅ Sistema de autorización inicializado correctamente
2025-12-03 20:26:32,042 - app.core.authorization.rbac - INFO - 📊 Permisos del sistema: 6 módulos configurados
2025-12-03 20:26:32,214 - app.core.tenant.middleware - INFO - Módulo tenant_middleware cargado (versión híbrida con soporte para proxies)
2025-12-03 20:26:32,214 - app.main - INFO - ✅ Rate limiting configurado y activo
2025-12-03 20:26:32,243 - app.core.tenant.middleware - INFO - Módulo tenant_middleware cargado (versión híbrida con soporte para proxies)
2025-12-03 20:26:32,243 - app.main - INFO - ✅ Rate limiting configurado y activo
2025-12-03 20:26:32,367 - app.core.tenant.middleware - INFO - [TENANT_MW] Inicializado - BASE_DOMAIN=app.local, SYSTEM_ID=BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, EXCLUDED_SUBDOMAINS={'api', 'admin', 'backend', 'cdn', 'static', 'www', 'assets'}
2025-12-03 20:26:32,398 - app.core.tenant.middleware - INFO - [TENANT_MW] Inicializado - BASE_DOMAIN=app.local, SYSTEM_ID=BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, EXCLUDED_SUBDOMAINS={'www', 'assets', 'static', 'cdn', 'api', 'backend', 'admin'}
2025-12-03 20:27:07,696 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Pool ADMIN inicializado. Size=10, MaxOverflow=5
2025-12-03 20:27:07,696 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Configuración de pools de tenants: MaxPools=50, PoolSize=3, MaxOverflow=2, InactivityTimeout=3600s
2025-12-03 20:27:07,697 - app.infrastructure.database.connection_pool - INFO - ✅ Módulo de connection pooling cargado y activo
2025-12-03 20:27:07,697 - app.infrastructure.database.connection_pool - INFO -    Configuración: MaxTenantPools=50, TenantPoolSize=3, InactivityTimeout=3600s
2025-12-03 20:27:07,697 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Todos los pools cerrados
2025-12-03 20:27:07,697 - app.main - INFO - ✅ Pools de conexión cerrados correctamente
2025-12-03 20:27:08,524 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 20:27:08,715 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 20:27:08,715 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 20:27:08,724 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 20:27:08,724 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 20:27:08,724 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 20:27:08,725 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 20:27:08,725 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, DEFAULT_TYPE=single
2025-12-03 20:27:09,057 - app.core.security.rate_limiting - INFO - [RATE_LIMITING] Activado. Límites: Login=10/minute, API=200/minute
2025-12-03 20:27:09,057 - app.core.security.rate_limiting - INFO - ✅ Módulo de rate limiting cargado y activo
2025-12-03 20:27:09,128 - app.core.authorization.rbac - INFO - 🔐 Inicializando sistema de autorización...
2025-12-03 20:27:09,129 - app.core.authorization.rbac - INFO - ✅ Sistema de autorización inicializado correctamente
2025-12-03 20:27:09,129 - app.core.authorization.rbac - INFO - 📊 Permisos del sistema: 6 módulos configurados
2025-12-03 20:27:09,276 - app.core.tenant.middleware - INFO - Módulo tenant_middleware cargado (versión híbrida con soporte para proxies)
2025-12-03 20:27:09,276 - app.main - INFO - ✅ Rate limiting configurado y activo
2025-12-03 20:27:09,426 - app.core.tenant.middleware - INFO - [TENANT_MW] Inicializado - BASE_DOMAIN=app.local, SYSTEM_ID=BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, EXCLUDED_SUBDOMAINS={'assets', 'admin', 'api', 'backend', 'static', 'www', 'cdn'}
2025-12-03 20:27:11,875 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/refresh/
2025-12-03 20:27:11,875 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 20:27:11,875 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 20:27:11,875 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 20:27:11,875 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 20:27:11,875 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 20:27:11,875 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 20:27:11,875 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 20:27:11,875 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 20:27:11,875 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 20:27:11,875 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 20:27:11,879 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/auth/refresh/
2025-12-03 20:27:11,888 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] AsyncEngine creado para admin
2025-12-03 20:27:12,053 - app.modules.auth.application.services.refresh_token_service - WARNING - [VALIDATE-TOKEN] Token no encontrado, revocado o expirado - Cliente bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 20:27:12,053 - app.modules.auth.application.services.auth_service - WARNING - [REFRESH] Token JWT válido, pero inactivo/revocado en BD. Usuario: superadmin
2025-12-03 20:27:12,069 - app.modules.superadmin.application.services.audit_service - INFO - [AUDIT] auth_audit_log registrado: evento=token_invalid_or_revoked, cliente_id=1, usuario_id=None, exito=False
2025-12-03 20:27:12,069 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/refresh/ 401 195.7ms
2025-12-03 20:27:29,852 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/auth/login/
2025-12-03 20:27:29,852 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/auth/login/ 200 0.4ms
2025-12-03 20:27:29,854 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/login/
2025-12-03 20:27:29,854 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 20:27:29,854 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 20:27:29,854 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 20:27:29,854 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 20:27:29,854 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 20:27:29,855 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 20:27:29,855 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 20:27:29,855 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 20:27:29,855 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 20:27:29,855 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 20:27:29,855 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/auth/login/
2025-12-03 20:27:29,861 - app.modules.auth.presentation.endpoints - INFO - Cliente bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7 resuelto y validado para login.
2025-12-03 20:27:29,861 - app.modules.auth.application.services.auth_service - INFO - [AUTH] Intento de login: username='superadmin', cliente_id_destino=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 20:27:29,861 - app.modules.auth.application.services.auth_service - INFO - [AUTH] SUPERADMIN detectado. Buscando en BD ADMIN (cliente_id=BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7), accediendo a cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 20:27:30,123 - app.modules.auth.application.services.auth_service - INFO - Niveles calculados - Usuario 154134AD-A5EB-4F45-AEF0-5F9AAA282C8E: level=5, super_admin=True, type=super_admin
2025-12-03 20:27:30,123 - app.modules.auth.application.services.auth_service - INFO - [AUTH] Login exitoso: username='superadmin', usuario_id=154134AD-A5EB-4F45-AEF0-5F9AAA282C8E, cliente_origen=BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, cliente_destino=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, access_level=5, user_type=super_admin
2025-12-03 20:27:30,123 - app.modules.auth.presentation.endpoints - INFO - [LOGIN] Superadmin accediendo a cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 20:27:30,133 - app.modules.auth.application.services.auth_service - INFO - Niveles calculados - Usuario 154134AD-A5EB-4F45-AEF0-5F9AAA282C8E: level=5, super_admin=True, type=super_admin
2025-12-03 20:27:30,133 - app.modules.auth.presentation.endpoints - ERROR - Error inesperado en /login/ para usuario superadmin: Object of type UUID is not JSON serializable
Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\modules\auth\presentation\endpoints.py", line 205, in login
    access_token = create_access_token(data=token_data)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\core\security\jwt.py", line 49, in create_access_token
    return jwt.encode(to_encode, settings.SECRET_KEY, algorithm=settings.ALGORITHM)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\jose\jwt.py", line 53, in encode
    return jws.sign(claims, key, headers=headers, algorithm=algorithm)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\jose\jws.py", line 42, in sign
    encoded_payload = _encode_payload(payload)
                      ^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\jose\jws.py", line 146, in _encode_payload
    payload = json.dumps(
              ^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\json\__init__.py", line 238, in dumps
    **kw).encode(obj)
          ^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\json\encoder.py", line 200, in encode
    chunks = self.iterencode(o, _one_shot=True)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\json\encoder.py", line 258, in iterencode
    return _iterencode(o, 0)
           ^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\json\encoder.py", line 180, in default
    raise TypeError(f'Object of type {o.__class__.__name__} '
TypeError: Object of type UUID is not JSON serializable
2025-12-03 20:27:30,155 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/login/ 500 304.3ms
2025-12-03 20:27:36,653 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Pool ADMIN inicializado. Size=10, MaxOverflow=5
2025-12-03 20:27:36,653 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Configuración de pools de tenants: MaxPools=50, PoolSize=3, MaxOverflow=2, InactivityTimeout=3600s
2025-12-03 20:27:36,653 - app.infrastructure.database.connection_pool - INFO - ✅ Módulo de connection pooling cargado y activo
2025-12-03 20:27:36,653 - app.infrastructure.database.connection_pool - INFO -    Configuración: MaxTenantPools=50, TenantPoolSize=3, InactivityTimeout=3600s
2025-12-03 20:27:36,653 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Todos los pools cerrados
2025-12-03 20:27:36,653 - app.main - INFO - ✅ Pools de conexión cerrados correctamente
2025-12-03 20:27:38,735 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 20:27:38,942 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 20:27:38,948 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 20:27:38,950 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 20:27:38,950 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 20:27:38,951 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 20:27:38,951 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 20:27:38,951 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, DEFAULT_TYPE=single
2025-12-03 20:27:39,291 - app.core.security.rate_limiting - INFO - [RATE_LIMITING] Activado. Límites: Login=10/minute, API=200/minute
2025-12-03 20:27:39,291 - app.core.security.rate_limiting - INFO - ✅ Módulo de rate limiting cargado y activo
2025-12-03 20:27:39,364 - app.core.authorization.rbac - INFO - 🔐 Inicializando sistema de autorización...
2025-12-03 20:27:39,364 - app.core.authorization.rbac - INFO - ✅ Sistema de autorización inicializado correctamente
2025-12-03 20:27:39,364 - app.core.authorization.rbac - INFO - 📊 Permisos del sistema: 6 módulos configurados
2025-12-03 20:27:39,526 - app.core.tenant.middleware - INFO - Módulo tenant_middleware cargado (versión híbrida con soporte para proxies)
2025-12-03 20:27:39,526 - app.main - INFO - ✅ Rate limiting configurado y activo
2025-12-03 20:27:39,672 - app.core.tenant.middleware - INFO - [TENANT_MW] Inicializado - BASE_DOMAIN=app.local, SYSTEM_ID=BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, EXCLUDED_SUBDOMAINS={'assets', 'cdn', 'api', 'admin', 'www', 'backend', 'static'}
2025-12-03 20:27:41,689 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/refresh/
2025-12-03 20:27:41,689 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 20:27:41,689 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 20:27:41,689 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 20:27:41,689 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 20:27:41,689 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 20:27:41,690 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 20:27:41,690 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 20:27:41,690 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 20:27:41,690 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 20:27:41,690 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 20:27:41,691 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/auth/refresh/
2025-12-03 20:27:41,698 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] AsyncEngine creado para admin
2025-12-03 20:27:41,741 - app.modules.auth.application.services.refresh_token_service - WARNING - [VALIDATE-TOKEN] Token no encontrado, revocado o expirado - Cliente bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 20:27:41,741 - app.modules.auth.application.services.auth_service - WARNING - [REFRESH] Token JWT válido, pero inactivo/revocado en BD. Usuario: superadmin
2025-12-03 20:27:41,747 - app.modules.superadmin.application.services.audit_service - INFO - [AUDIT] auth_audit_log registrado: evento=token_invalid_or_revoked, cliente_id=1, usuario_id=None, exito=False
2025-12-03 20:27:41,748 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/refresh/ 401 59.4ms
2025-12-03 20:27:52,194 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/login/
2025-12-03 20:27:52,195 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 20:27:52,195 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 20:27:52,195 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 20:27:52,195 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 20:27:52,195 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 20:27:52,195 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 20:27:52,195 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 20:27:52,195 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 20:27:52,196 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 20:27:52,196 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 20:27:52,196 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/auth/login/
2025-12-03 20:27:52,201 - app.modules.auth.presentation.endpoints - INFO - Cliente bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7 resuelto y validado para login.
2025-12-03 20:27:52,202 - app.modules.auth.application.services.auth_service - INFO - [AUTH] Intento de login: username='superadmin', cliente_id_destino=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 20:27:52,202 - app.modules.auth.application.services.auth_service - INFO - [AUTH] SUPERADMIN detectado. Buscando en BD ADMIN (cliente_id=BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7), accediendo a cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 20:27:52,443 - app.modules.auth.application.services.auth_service - INFO - Niveles calculados - Usuario 154134AD-A5EB-4F45-AEF0-5F9AAA282C8E: level=5, super_admin=True, type=super_admin
2025-12-03 20:27:52,444 - app.modules.auth.application.services.auth_service - INFO - [AUTH] Login exitoso: username='superadmin', usuario_id=154134AD-A5EB-4F45-AEF0-5F9AAA282C8E, cliente_origen=BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, cliente_destino=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, access_level=5, user_type=super_admin
2025-12-03 20:27:52,444 - app.modules.auth.presentation.endpoints - INFO - [LOGIN] Superadmin accediendo a cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 20:27:52,447 - app.modules.auth.application.services.auth_service - INFO - Niveles calculados - Usuario 154134AD-A5EB-4F45-AEF0-5F9AAA282C8E: level=5, super_admin=True, type=super_admin
2025-12-03 20:27:52,447 - app.modules.auth.presentation.endpoints - ERROR - Error inesperado en /login/ para usuario superadmin: Object of type UUID is not JSON serializable
Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\modules\auth\presentation\endpoints.py", line 205, in login
    access_token = create_access_token(data=token_data)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\core\security\jwt.py", line 49, in create_access_token
    return jwt.encode(to_encode, settings.SECRET_KEY, algorithm=settings.ALGORITHM)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\jose\jwt.py", line 53, in encode
    return jws.sign(claims, key, headers=headers, algorithm=algorithm)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\jose\jws.py", line 42, in sign
    encoded_payload = _encode_payload(payload)
                      ^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\jose\jws.py", line 146, in _encode_payload
    payload = json.dumps(
              ^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\json\__init__.py", line 238, in dumps
    **kw).encode(obj)
          ^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\json\encoder.py", line 200, in encode
    chunks = self.iterencode(o, _one_shot=True)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\json\encoder.py", line 258, in iterencode
    return _iterencode(o, 0)
           ^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\json\encoder.py", line 180, in default
    raise TypeError(f'Object of type {o.__class__.__name__} '
TypeError: Object of type UUID is not JSON serializable
2025-12-03 20:27:52,450 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/login/ 500 255.8ms
2025-12-03 20:29:22,065 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Pool ADMIN inicializado. Size=10, MaxOverflow=5
2025-12-03 20:29:22,065 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Configuración de pools de tenants: MaxPools=50, PoolSize=3, MaxOverflow=2, InactivityTimeout=3600s
2025-12-03 20:29:22,065 - app.infrastructure.database.connection_pool - INFO - ✅ Módulo de connection pooling cargado y activo
2025-12-03 20:29:22,065 - app.infrastructure.database.connection_pool - INFO -    Configuración: MaxTenantPools=50, TenantPoolSize=3, InactivityTimeout=3600s
2025-12-03 20:29:22,065 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Todos los pools cerrados
2025-12-03 20:29:22,065 - app.main - INFO - ✅ Pools de conexión cerrados correctamente
2025-12-03 20:29:22,885 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 20:29:23,075 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 20:29:23,085 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 20:29:23,088 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 20:29:23,088 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 20:29:23,088 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 20:29:23,088 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 20:29:23,089 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, DEFAULT_TYPE=single
2025-12-03 20:29:23,403 - app.core.security.rate_limiting - INFO - [RATE_LIMITING] Activado. Límites: Login=10/minute, API=200/minute
2025-12-03 20:29:23,403 - app.core.security.rate_limiting - INFO - ✅ Módulo de rate limiting cargado y activo
2025-12-03 20:29:23,475 - app.core.authorization.rbac - INFO - 🔐 Inicializando sistema de autorización...
2025-12-03 20:29:23,475 - app.core.authorization.rbac - INFO - ✅ Sistema de autorización inicializado correctamente
2025-12-03 20:29:23,475 - app.core.authorization.rbac - INFO - 📊 Permisos del sistema: 6 módulos configurados
2025-12-03 20:29:23,629 - app.core.tenant.middleware - INFO - Módulo tenant_middleware cargado (versión híbrida con soporte para proxies)
2025-12-03 20:29:23,629 - app.main - INFO - ✅ Rate limiting configurado y activo
2025-12-03 20:29:23,775 - app.core.tenant.middleware - INFO - [TENANT_MW] Inicializado - BASE_DOMAIN=app.local, SYSTEM_ID=BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, EXCLUDED_SUBDOMAINS={'assets', 'admin', 'static', 'api', 'www', 'cdn', 'backend'}
2025-12-03 20:29:25,905 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/refresh/
2025-12-03 20:29:25,905 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 20:29:25,905 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 20:29:25,905 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 20:29:25,905 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 20:29:25,905 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 20:29:25,905 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 20:29:25,905 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 20:29:25,905 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 20:29:25,905 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 20:29:25,905 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 20:29:25,905 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/auth/refresh/
2025-12-03 20:29:25,915 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] AsyncEngine creado para admin
2025-12-03 20:29:26,067 - app.modules.auth.application.services.refresh_token_service - WARNING - [VALIDATE-TOKEN] Token no encontrado, revocado o expirado - Cliente bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 20:29:26,067 - app.modules.auth.application.services.auth_service - WARNING - [REFRESH] Token JWT válido, pero inactivo/revocado en BD. Usuario: superadmin
2025-12-03 20:29:26,083 - app.modules.superadmin.application.services.audit_service - INFO - [AUDIT] auth_audit_log registrado: evento=token_invalid_or_revoked, cliente_id=1, usuario_id=None, exito=False
2025-12-03 20:29:26,084 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/refresh/ 401 176.3ms
2025-12-03 20:29:39,194 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/login/
2025-12-03 20:29:39,195 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 20:29:39,195 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 20:29:39,195 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 20:29:39,195 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 20:29:39,195 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 20:29:39,195 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 20:29:39,195 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 20:29:39,195 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 20:29:39,197 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 20:29:39,197 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 20:29:39,197 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/auth/login/
2025-12-03 20:29:39,204 - app.modules.auth.presentation.endpoints - INFO - Cliente bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7 resuelto y validado para login.
2025-12-03 20:29:39,204 - app.modules.auth.application.services.auth_service - INFO - [AUTH] Intento de login: username='superadmin', cliente_id_destino=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 20:29:39,204 - app.modules.auth.application.services.auth_service - INFO - [AUTH] SUPERADMIN detectado. Buscando en BD ADMIN (cliente_id=BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7), accediendo a cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 20:29:39,448 - app.modules.auth.application.services.auth_service - INFO - Niveles calculados - Usuario 154134AD-A5EB-4F45-AEF0-5F9AAA282C8E: level=5, super_admin=True, type=super_admin
2025-12-03 20:29:39,448 - app.modules.auth.application.services.auth_service - INFO - [AUTH] Login exitoso: username='superadmin', usuario_id=154134AD-A5EB-4F45-AEF0-5F9AAA282C8E, cliente_origen=BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, cliente_destino=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, access_level=5, user_type=super_admin
2025-12-03 20:29:39,448 - app.modules.auth.presentation.endpoints - INFO - [LOGIN] Superadmin accediendo a cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 20:29:39,456 - app.modules.auth.application.services.auth_service - INFO - Niveles calculados - Usuario 154134AD-A5EB-4F45-AEF0-5F9AAA282C8E: level=5, super_admin=True, type=super_admin
2025-12-03 20:29:39,459 - app.infrastructure.database.queries_async - ERROR - Error en execute_insert async (string): (pyodbc.Error) ('07002', '[07002] [Microsoft][ODBC Driver 17 for SQL Server]COUNT field incorrect or syntax error (0) (SQLExecDirectW)')
[SQL: 
INSERT INTO refresh_tokens (
    usuario_id, token_hash, expires_at, client_type, ip_address, user_agent, cliente_id
)
OUTPUT INSERTED.token_id, INSERTED.created_at, INSERTED.cliente_id
VALUES (?, ?, ?, ?, ?, ?, ?);
]
(Background on this error at: https://sqlalche.me/e/20/dbapi)
2025-12-03 20:29:39,459 - app.infrastructure.database.connection_async - ERROR - [ASYNC_CONNECTION] Error en sesión async: Error en la inserción: (pyodbc.Error) ('07002', '[07002] [Microsoft][ODBC Driver 17 for SQL Server]COUNT field incorrect or syntax error (0) (SQLExecDirectW)')
[SQL: 
INSERT INTO refresh_tokens (
    usuario_id, token_hash, expires_at, client_type, ip_address, user_agent, cliente_id
)
OUTPUT INSERTED.token_id, INSERTED.created_at, INSERTED.cliente_id
VALUES (?, ?, ?, ?, ?, ?, ?);
]
(Background on this error at: https://sqlalche.me/e/20/dbapi)
Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 230, in execute
    self._adapt_connection._handle_exception(error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 368, in _handle_exception
    raise error.with_traceback(exc_info[2])
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 228, in execute
    return self.await_(self._execute_async(operation, parameters))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 251, in _execute_async
    result = await self._cursor.execute(operation, parameters)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 132, in execute
    await self._run_operation(self._impl.execute, sql, *params)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 30, in _run_operation
    result = await self._conn._execute(func, *args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\concurrent\futures\thread.py", line 59, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
pyodbc.Error: ('07002', '[07002] [Microsoft][ODBC Driver 17 for SQL Server]COUNT field incorrect or syntax error (0) (SQLExecDirectW)')

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 295, in execute_insert
    result = await session.execute(text(query))
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 449, in execute
    result = await greenlet_spawn(
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 203, in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2351, in execute
    return self._execute_internal(
           ^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2258, in _execute_internal
    result = conn.execute(
             ^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1419, in execute
    return meth(
           ^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\sql\elements.py", line 526, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1641, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1846, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1986, in _exec_single_context
    self._handle_dbapi_exception(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 2355, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 230, in execute
    self._adapt_connection._handle_exception(error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 368, in _handle_exception
    raise error.with_traceback(exc_info[2])
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 228, in execute
    return self.await_(self._execute_async(operation, parameters))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 251, in _execute_async
    result = await self._cursor.execute(operation, parameters)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 132, in execute
    await self._run_operation(self._impl.execute, sql, *params)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 30, in _run_operation
    result = await self._conn._execute(func, *args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\concurrent\futures\thread.py", line 59, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
sqlalchemy.exc.DBAPIError: (pyodbc.Error) ('07002', '[07002] [Microsoft][ODBC Driver 17 for SQL Server]COUNT field incorrect or syntax error (0) (SQLExecDirectW)')
[SQL: 
INSERT INTO refresh_tokens (
    usuario_id, token_hash, expires_at, client_type, ip_address, user_agent, cliente_id
)
OUTPUT INSERTED.token_id, INSERTED.created_at, INSERTED.cliente_id
VALUES (?, ?, ?, ?, ?, ?, ?);
]
(Background on this error at: https://sqlalche.me/e/20/dbapi)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\connection_async.py", line 303, in get_db_connection
    yield session
  File "D:\base_multi_tenant_fastapi\app\core\tenant\routing.py", line 672, in get_connection_for_tenant
    yield session
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 311, in execute_insert
    raise DatabaseError(
app.core.exceptions.DatabaseError: Error en la inserción: (pyodbc.Error) ('07002', '[07002] [Microsoft][ODBC Driver 17 for SQL Server]COUNT field incorrect or syntax error (0) (SQLExecDirectW)')
[SQL: 
INSERT INTO refresh_tokens (
    usuario_id, token_hash, expires_at, client_type, ip_address, user_agent, cliente_id
)
OUTPUT INSERTED.token_id, INSERTED.created_at, INSERTED.cliente_id
VALUES (?, ?, ?, ?, ?, ?, ?);
]
(Background on this error at: https://sqlalche.me/e/20/dbapi)
2025-12-03 20:29:39,467 - app.core.application.base_service - ERROR - DatabaseError en store_refresh_token: Error en la inserción: (pyodbc.Error) ('07002', '[07002] [Microsoft][ODBC Driver 17 for SQL Server]COUNT field incorrect or syntax error (0) (SQLExecDirectW)')
[SQL: 
INSERT INTO refresh_tokens (
    usuario_id, token_hash, expires_at, client_type, ip_address, user_agent, cliente_id
)
OUTPUT INSERTED.token_id, INSERTED.created_at, INSERTED.cliente_id
VALUES (?, ?, ?, ?, ?, ?, ?);
]
(Background on this error at: https://sqlalche.me/e/20/dbapi)
Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 230, in execute
    self._adapt_connection._handle_exception(error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 368, in _handle_exception
    raise error.with_traceback(exc_info[2])
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 228, in execute
    return self.await_(self._execute_async(operation, parameters))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 251, in _execute_async
    result = await self._cursor.execute(operation, parameters)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 132, in execute
    await self._run_operation(self._impl.execute, sql, *params)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 30, in _run_operation
    result = await self._conn._execute(func, *args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\concurrent\futures\thread.py", line 59, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
pyodbc.Error: ('07002', '[07002] [Microsoft][ODBC Driver 17 for SQL Server]COUNT field incorrect or syntax error (0) (SQLExecDirectW)')

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 295, in execute_insert
    result = await session.execute(text(query))
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 449, in execute
    result = await greenlet_spawn(
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 203, in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2351, in execute
    return self._execute_internal(
           ^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2258, in _execute_internal
    result = conn.execute(
             ^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1419, in execute
    return meth(
           ^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\sql\elements.py", line 526, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1641, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1846, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1986, in _exec_single_context
    self._handle_dbapi_exception(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 2355, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 230, in execute
    self._adapt_connection._handle_exception(error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 368, in _handle_exception
    raise error.with_traceback(exc_info[2])
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 228, in execute
    return self.await_(self._execute_async(operation, parameters))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 251, in _execute_async
    result = await self._cursor.execute(operation, parameters)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 132, in execute
    await self._run_operation(self._impl.execute, sql, *params)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 30, in _run_operation
    result = await self._conn._execute(func, *args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\concurrent\futures\thread.py", line 59, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
sqlalchemy.exc.DBAPIError: (pyodbc.Error) ('07002', '[07002] [Microsoft][ODBC Driver 17 for SQL Server]COUNT field incorrect or syntax error (0) (SQLExecDirectW)')
[SQL: 
INSERT INTO refresh_tokens (
    usuario_id, token_hash, expires_at, client_type, ip_address, user_agent, cliente_id
)
OUTPUT INSERTED.token_id, INSERTED.created_at, INSERTED.cliente_id
VALUES (?, ?, ?, ?, ?, ?, ?);
]
(Background on this error at: https://sqlalche.me/e/20/dbapi)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\core\application\base_service.py", line 52, in wrapper
    return await func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\modules\auth\application\services\refresh_token_service.py", line 118, in store_refresh_token
    result = await execute_insert(INSERT_REFRESH_TOKEN, params)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 311, in execute_insert
    raise DatabaseError(
app.core.exceptions.DatabaseError: Error en la inserción: (pyodbc.Error) ('07002', '[07002] [Microsoft][ODBC Driver 17 for SQL Server]COUNT field incorrect or syntax error (0) (SQLExecDirectW)')
[SQL: 
INSERT INTO refresh_tokens (
    usuario_id, token_hash, expires_at, client_type, ip_address, user_agent, cliente_id
)
OUTPUT INSERTED.token_id, INSERTED.created_at, INSERTED.cliente_id
VALUES (?, ?, ?, ?, ?, ?, ?);
]
(Background on this error at: https://sqlalche.me/e/20/dbapi)
2025-12-03 20:29:39,470 - app.modules.auth.presentation.endpoints - ERROR - [LOGIN] Error almacenando refresh token: Error en la inserción: (pyodbc.Error) ('07002', '[07002] [Microsoft][ODBC Driver 17 for SQL Server]COUNT field incorrect or syntax error (0) (SQLExecDirectW)')
[SQL: 
INSERT INTO refresh_tokens (
    usuario_id, token_hash, expires_at, client_type, ip_address, user_agent, cliente_id
)
OUTPUT INSERTED.token_id, INSERTED.created_at, INSERTED.cliente_id
VALUES (?, ?, ?, ?, ?, ?, ?);
]
(Background on this error at: https://sqlalche.me/e/20/dbapi)
2025-12-03 20:29:39,470 - app.modules.auth.presentation.endpoints - INFO - Usuario superadmin autenticado exitosamente (WEB) para cliente bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 20:29:39,475 - app.modules.superadmin.application.services.audit_service - INFO - [AUDIT] auth_audit_log registrado: evento=login_success, cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, usuario_id=154134AD-A5EB-4F45-AEF0-5F9AAA282C8E, exito=True
2025-12-03 20:29:39,475 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/login/ 200 283.8ms
2025-12-03 20:29:39,491 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/clientes/tenant/branding
2025-12-03 20:29:39,491 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/clientes/tenant/branding 200 0.6ms
2025-12-03 20:29:39,497 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/clientes/tenant/branding
2025-12-03 20:29:39,502 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 20:29:39,504 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 20:29:39,505 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 20:29:39,506 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 20:29:39,506 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 20:29:39,506 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 20:29:39,506 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 20:29:39,507 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 20:29:39,508 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 20:29:39,508 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 20:29:39,508 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/clientes/tenant/branding
2025-12-03 20:29:39,531 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/menus/getmenu/
2025-12-03 20:29:39,533 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/menus/getmenu/ 200 1.1ms
2025-12-03 20:29:39,534 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/menus/getmenu/
2025-12-03 20:29:39,535 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/menus/getmenu/ 200 0.7ms
2025-12-03 20:29:39,536 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/menus/getmenu/
2025-12-03 20:29:39,538 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 20:29:39,538 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 20:29:39,538 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 20:29:39,539 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 20:29:39,539 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 20:29:39,539 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 20:29:39,539 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 20:29:39,539 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 20:29:39,539 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 20:29:39,539 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 20:29:39,539 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/menus/getmenu/
2025-12-03 20:29:39,555 - app.modules.tenant.presentation.endpoints_clientes - INFO - Solicitud GET /tenant/branding recibida para cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7 por usuario: superadmin
2025-12-03 20:29:39,555 - app.modules.tenant.application.services.cliente_service - INFO - Solicitando branding para cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 20:29:39,562 - app.modules.tenant.application.services.cliente_service - INFO - Branding obtenido exitosamente para cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 20:29:39,563 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/clientes/tenant/branding 200 66.3ms
2025-12-03 20:29:39,567 - app.modules.menus.presentation.endpoints - INFO - Solicitud GET /menus/getmenu/ recibida para usuario ID: 154134ad-a5eb-4f45-aef0-5f9aaa282c8e del cliente bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 20:29:39,567 - app.modules.menus.application.services.menu_service - INFO - Obteniendo menú filtrado para usuario_id: 154134ad-a5eb-4f45-aef0-5f9aaa282c8e
2025-12-03 20:29:39,568 - app.infrastructure.database.queries_async - ERROR - Error en execute_procedure_params async: (pyodbc.DataError) ('22018', '[22018] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Operand type clash: uniqueidentifier is incompatible with int (206) (SQLExecDirectW)')
[SQL: EXEC sp_GetMenuForUser @UsuarioID = ?]
[parameters: (UUID('154134ad-a5eb-4f45-aef0-5f9aaa282c8e'),)]
(Background on this error at: https://sqlalche.me/e/20/9h9h)
2025-12-03 20:29:39,568 - app.infrastructure.database.connection_async - ERROR - [ASYNC_CONNECTION] Error en sesión async: Error ejecutando stored procedure sp_GetMenuForUser: (pyodbc.DataError) ('22018', '[22018] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Operand type clash: uniqueidentifier is incompatible with int (206) (SQLExecDirectW)')
[SQL: EXEC sp_GetMenuForUser @UsuarioID = ?]
[parameters: (UUID('154134ad-a5eb-4f45-aef0-5f9aaa282c8e'),)]
(Background on this error at: https://sqlalche.me/e/20/9h9h)
Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 230, in execute
    self._adapt_connection._handle_exception(error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 368, in _handle_exception
    raise error.with_traceback(exc_info[2])
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 228, in execute
    return self.await_(self._execute_async(operation, parameters))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 251, in _execute_async
    result = await self._cursor.execute(operation, parameters)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 132, in execute
    await self._run_operation(self._impl.execute, sql, *params)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 30, in _run_operation
    result = await self._conn._execute(func, *args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\concurrent\futures\thread.py", line 59, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
pyodbc.DataError: ('22018', '[22018] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Operand type clash: uniqueidentifier is incompatible with int (206) (SQLExecDirectW)')

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 465, in execute_procedure_params
    result = await session.execute(query, param_bindings)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 449, in execute
    result = await greenlet_spawn(
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 203, in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2351, in execute
    return self._execute_internal(
           ^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2258, in _execute_internal
    result = conn.execute(
             ^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1419, in execute
    return meth(
           ^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\sql\elements.py", line 526, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1641, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1846, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1986, in _exec_single_context
    self._handle_dbapi_exception(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 2355, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 230, in execute
    self._adapt_connection._handle_exception(error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 368, in _handle_exception
    raise error.with_traceback(exc_info[2])
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 228, in execute
    return self.await_(self._execute_async(operation, parameters))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 251, in _execute_async
    result = await self._cursor.execute(operation, parameters)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 132, in execute
    await self._run_operation(self._impl.execute, sql, *params)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 30, in _run_operation
    result = await self._conn._execute(func, *args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\concurrent\futures\thread.py", line 59, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
sqlalchemy.exc.DataError: (pyodbc.DataError) ('22018', '[22018] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Operand type clash: uniqueidentifier is incompatible with int (206) (SQLExecDirectW)')
[SQL: EXEC sp_GetMenuForUser @UsuarioID = ?]
[parameters: (UUID('154134ad-a5eb-4f45-aef0-5f9aaa282c8e'),)]
(Background on this error at: https://sqlalche.me/e/20/9h9h)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\connection_async.py", line 303, in get_db_connection
    yield session
  File "D:\base_multi_tenant_fastapi\app\core\tenant\routing.py", line 672, in get_connection_for_tenant
    yield session
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 488, in execute_procedure_params
    raise DatabaseError(
app.core.exceptions.DatabaseError: Error ejecutando stored procedure sp_GetMenuForUser: (pyodbc.DataError) ('22018', '[22018] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Operand type clash: uniqueidentifier is incompatible with int (206) (SQLExecDirectW)')
[SQL: EXEC sp_GetMenuForUser @UsuarioID = ?]
[parameters: (UUID('154134ad-a5eb-4f45-aef0-5f9aaa282c8e'),)]
(Background on this error at: https://sqlalche.me/e/20/9h9h)
2025-12-03 20:29:39,575 - app.modules.menus.application.services.menu_service - ERROR - Error de BD al obtener menú para usuario 154134ad-a5eb-4f45-aef0-5f9aaa282c8e: Error ejecutando stored procedure sp_GetMenuForUser: (pyodbc.DataError) ('22018', '[22018] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Operand type clash: uniqueidentifier is incompatible with int (206) (SQLExecDirectW)')
[SQL: EXEC sp_GetMenuForUser @UsuarioID = ?]
[parameters: (UUID('154134ad-a5eb-4f45-aef0-5f9aaa282c8e'),)]
(Background on this error at: https://sqlalche.me/e/20/9h9h)
2025-12-03 20:29:39,575 - app.modules.menus.presentation.endpoints - ERROR - Error de servicio en GET /getmenu/ para usuario 154134ad-a5eb-4f45-aef0-5f9aaa282c8e: Error de base de datos al obtener menú del usuario
2025-12-03 20:29:39,575 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/menus/getmenu/ 500 38.9ms
2025-12-03 20:29:39,575 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/menus/getmenu/
2025-12-03 20:29:39,578 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 20:29:39,578 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 20:29:39,578 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 20:29:39,578 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 20:29:39,578 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 20:29:39,578 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 20:29:39,578 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 20:29:39,578 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 20:29:39,578 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 20:29:39,579 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 20:29:39,579 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/menus/getmenu/
2025-12-03 20:29:39,586 - app.modules.menus.presentation.endpoints - INFO - Solicitud GET /menus/getmenu/ recibida para usuario ID: 154134ad-a5eb-4f45-aef0-5f9aaa282c8e del cliente bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 20:29:39,596 - app.modules.menus.application.services.menu_service - INFO - Obteniendo menú filtrado para usuario_id: 154134ad-a5eb-4f45-aef0-5f9aaa282c8e
2025-12-03 20:29:39,599 - app.infrastructure.database.queries_async - ERROR - Error en execute_procedure_params async: (pyodbc.DataError) ('22018', '[22018] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Operand type clash: uniqueidentifier is incompatible with int (206) (SQLExecDirectW)')
[SQL: EXEC sp_GetMenuForUser @UsuarioID = ?]
[parameters: (UUID('154134ad-a5eb-4f45-aef0-5f9aaa282c8e'),)]
(Background on this error at: https://sqlalche.me/e/20/9h9h)
2025-12-03 20:29:39,600 - app.infrastructure.database.connection_async - ERROR - [ASYNC_CONNECTION] Error en sesión async: Error ejecutando stored procedure sp_GetMenuForUser: (pyodbc.DataError) ('22018', '[22018] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Operand type clash: uniqueidentifier is incompatible with int (206) (SQLExecDirectW)')
[SQL: EXEC sp_GetMenuForUser @UsuarioID = ?]
[parameters: (UUID('154134ad-a5eb-4f45-aef0-5f9aaa282c8e'),)]
(Background on this error at: https://sqlalche.me/e/20/9h9h)
Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 230, in execute
    self._adapt_connection._handle_exception(error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 368, in _handle_exception
    raise error.with_traceback(exc_info[2])
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 228, in execute
    return self.await_(self._execute_async(operation, parameters))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 251, in _execute_async
    result = await self._cursor.execute(operation, parameters)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 132, in execute
    await self._run_operation(self._impl.execute, sql, *params)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 30, in _run_operation
    result = await self._conn._execute(func, *args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\concurrent\futures\thread.py", line 59, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
pyodbc.DataError: ('22018', '[22018] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Operand type clash: uniqueidentifier is incompatible with int (206) (SQLExecDirectW)')

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 465, in execute_procedure_params
    result = await session.execute(query, param_bindings)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 449, in execute
    result = await greenlet_spawn(
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 203, in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2351, in execute
    return self._execute_internal(
           ^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2258, in _execute_internal
    result = conn.execute(
             ^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1419, in execute
    return meth(
           ^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\sql\elements.py", line 526, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1641, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1846, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1986, in _exec_single_context
    self._handle_dbapi_exception(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 2355, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 230, in execute
    self._adapt_connection._handle_exception(error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 368, in _handle_exception
    raise error.with_traceback(exc_info[2])
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 228, in execute
    return self.await_(self._execute_async(operation, parameters))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 251, in _execute_async
    result = await self._cursor.execute(operation, parameters)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 132, in execute
    await self._run_operation(self._impl.execute, sql, *params)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 30, in _run_operation
    result = await self._conn._execute(func, *args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\concurrent\futures\thread.py", line 59, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
sqlalchemy.exc.DataError: (pyodbc.DataError) ('22018', '[22018] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Operand type clash: uniqueidentifier is incompatible with int (206) (SQLExecDirectW)')
[SQL: EXEC sp_GetMenuForUser @UsuarioID = ?]
[parameters: (UUID('154134ad-a5eb-4f45-aef0-5f9aaa282c8e'),)]
(Background on this error at: https://sqlalche.me/e/20/9h9h)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\connection_async.py", line 303, in get_db_connection
    yield session
  File "D:\base_multi_tenant_fastapi\app\core\tenant\routing.py", line 672, in get_connection_for_tenant
    yield session
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 488, in execute_procedure_params
    raise DatabaseError(
app.core.exceptions.DatabaseError: Error ejecutando stored procedure sp_GetMenuForUser: (pyodbc.DataError) ('22018', '[22018] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Operand type clash: uniqueidentifier is incompatible with int (206) (SQLExecDirectW)')
[SQL: EXEC sp_GetMenuForUser @UsuarioID = ?]
[parameters: (UUID('154134ad-a5eb-4f45-aef0-5f9aaa282c8e'),)]
(Background on this error at: https://sqlalche.me/e/20/9h9h)
2025-12-03 20:29:39,603 - app.modules.menus.application.services.menu_service - ERROR - Error de BD al obtener menú para usuario 154134ad-a5eb-4f45-aef0-5f9aaa282c8e: Error ejecutando stored procedure sp_GetMenuForUser: (pyodbc.DataError) ('22018', '[22018] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Operand type clash: uniqueidentifier is incompatible with int (206) (SQLExecDirectW)')
[SQL: EXEC sp_GetMenuForUser @UsuarioID = ?]
[parameters: (UUID('154134ad-a5eb-4f45-aef0-5f9aaa282c8e'),)]
(Background on this error at: https://sqlalche.me/e/20/9h9h)
2025-12-03 20:29:39,603 - app.modules.menus.presentation.endpoints - ERROR - Error de servicio en GET /getmenu/ para usuario 154134ad-a5eb-4f45-aef0-5f9aaa282c8e: Error de base de datos al obtener menú del usuario
2025-12-03 20:29:39,603 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/menus/getmenu/ 500 26.6ms
2025-12-03 20:29:49,693 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/clientes/
2025-12-03 20:29:49,694 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/clientes/ 200 0.8ms
2025-12-03 20:29:49,694 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/clientes/
2025-12-03 20:29:49,695 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/clientes/ 200 0.9ms
2025-12-03 20:29:49,697 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/clientes/
2025-12-03 20:29:49,698 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 20:29:49,698 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 20:29:49,698 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 20:29:49,698 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 20:29:49,698 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 20:29:49,698 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 20:29:49,698 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 20:29:49,699 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 20:29:49,699 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 20:29:49,699 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 20:29:49,699 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/clientes/
2025-12-03 20:29:49,716 - app.modules.tenant.presentation.endpoints_clientes - INFO - Solicitud GET /clientes/ recibida - skip: 0, limit: 10, solo_activos: True, buscar: None por usuario: superadmin
2025-12-03 20:29:49,716 - app.modules.tenant.application.services.cliente_service - INFO - Listando clientes - skip: 0, limit: 10, solo_activos: True, buscar: None
2025-12-03 20:29:49,729 - app.modules.tenant.application.services.cliente_service - INFO - Listados 5 clientes de 5 totales
2025-12-03 20:29:49,731 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/clientes/ 200 34.3ms
2025-12-03 20:29:49,733 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/clientes/
2025-12-03 20:29:49,733 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 20:29:49,733 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 20:29:49,734 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 20:29:49,734 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 20:29:49,734 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 20:29:49,734 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 20:29:49,734 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 20:29:49,734 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 20:29:49,734 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 20:29:49,734 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 20:29:49,734 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/clientes/
2025-12-03 20:29:49,751 - app.modules.tenant.presentation.endpoints_clientes - INFO - Solicitud GET /clientes/ recibida - skip: 0, limit: 10, solo_activos: True, buscar: None por usuario: superadmin
2025-12-03 20:29:49,751 - app.modules.tenant.application.services.cliente_service - INFO - Listando clientes - skip: 0, limit: 10, solo_activos: True, buscar: None
2025-12-03 20:29:49,756 - app.modules.tenant.application.services.cliente_service - INFO - Listados 5 clientes de 5 totales
2025-12-03 20:29:49,757 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/clientes/ 200 23.8ms
2025-12-03 20:29:51,301 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/modulos/
2025-12-03 20:29:51,302 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/modulos/
2025-12-03 20:29:51,303 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/modulos/ 200 2.3ms
2025-12-03 20:29:51,303 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/modulos/ 200 1.6ms
2025-12-03 20:29:51,306 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/modulos/
2025-12-03 20:29:51,306 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 20:29:51,306 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 20:29:51,306 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 20:29:51,306 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 20:29:51,308 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 20:29:51,308 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 20:29:51,308 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 20:29:51,308 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 20:29:51,308 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 20:29:51,308 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 20:29:51,309 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/modulos/
2025-12-03 20:29:51,328 - app.modules.tenant.presentation.endpoints_modulos - INFO - Solicitud GET /modulos/ recibida - skip: 0, limit: 20, solo_activos: True
2025-12-03 20:29:51,329 - app.modules.tenant.application.services.modulo_service - INFO - Obteniendo catálogo de módulos - skip: 0, limit: 20
2025-12-03 20:29:51,336 - app.modules.tenant.application.services.modulo_service - INFO - Contando total de módulos en el sistema
2025-12-03 20:29:51,339 - app.modules.tenant.presentation.endpoints_modulos - INFO - Catálogo de módulos recuperado: 4 módulos de 4 totales
2025-12-03 20:29:51,340 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/modulos/ 200 33.1ms
2025-12-03 20:29:51,345 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/modulos/
2025-12-03 20:29:51,346 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 20:29:51,346 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 20:29:51,346 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 20:29:51,346 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 20:29:51,346 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 20:29:51,347 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 20:29:51,347 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 20:29:51,347 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 20:29:51,347 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 20:29:51,347 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 20:29:51,347 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/modulos/
2025-12-03 20:29:51,365 - app.modules.tenant.presentation.endpoints_modulos - INFO - Solicitud GET /modulos/ recibida - skip: 0, limit: 20, solo_activos: True
2025-12-03 20:29:51,365 - app.modules.tenant.application.services.modulo_service - INFO - Obteniendo catálogo de módulos - skip: 0, limit: 20
2025-12-03 20:29:51,368 - app.modules.tenant.application.services.modulo_service - INFO - Contando total de módulos en el sistema
2025-12-03 20:29:51,368 - app.modules.tenant.presentation.endpoints_modulos - INFO - Catálogo de módulos recuperado: 4 módulos de 4 totales
2025-12-03 20:29:51,368 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/modulos/ 200 26.5ms
2025-12-03 20:29:52,842 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/clientes/
2025-12-03 20:29:52,842 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 20:29:52,844 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 20:29:52,844 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 20:29:52,844 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 20:29:52,844 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 20:29:52,844 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 20:29:52,844 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 20:29:52,844 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 20:29:52,845 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 20:29:52,845 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 20:29:52,845 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/clientes/
2025-12-03 20:29:52,865 - app.modules.tenant.presentation.endpoints_clientes - INFO - Solicitud GET /clientes/ recibida - skip: 0, limit: 10, solo_activos: True, buscar: None por usuario: superadmin
2025-12-03 20:29:52,865 - app.modules.tenant.application.services.cliente_service - INFO - Listando clientes - skip: 0, limit: 10, solo_activos: True, buscar: None
2025-12-03 20:29:52,871 - app.modules.tenant.application.services.cliente_service - INFO - Listados 5 clientes de 5 totales
2025-12-03 20:29:52,871 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/clientes/ 200 30.3ms
2025-12-03 20:29:52,875 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/clientes/
2025-12-03 20:29:52,875 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 20:29:52,875 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 20:29:52,875 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 20:29:52,876 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 20:29:52,876 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 20:29:52,876 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 20:29:52,876 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 20:29:52,876 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 20:29:52,876 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 20:29:52,876 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 20:29:52,876 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/clientes/
2025-12-03 20:29:52,887 - app.modules.tenant.presentation.endpoints_clientes - INFO - Solicitud GET /clientes/ recibida - skip: 0, limit: 10, solo_activos: True, buscar: None por usuario: superadmin
2025-12-03 20:29:52,894 - app.modules.tenant.application.services.cliente_service - INFO - Listando clientes - skip: 0, limit: 10, solo_activos: True, buscar: None
2025-12-03 20:29:52,901 - app.modules.tenant.application.services.cliente_service - INFO - Listados 5 clientes de 5 totales
2025-12-03 20:29:52,901 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/clientes/ 200 26.7ms
2025-12-03 20:29:54,204 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/refresh/
2025-12-03 20:29:54,205 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 20:29:54,205 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 20:29:54,205 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 20:29:54,205 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 20:29:54,206 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 20:29:54,206 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 20:29:54,206 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 20:29:54,206 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 20:29:54,206 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 20:29:54,206 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 20:29:54,206 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/auth/refresh/
2025-12-03 20:29:54,206 - app.modules.auth.application.services.refresh_token_service - WARNING - [VALIDATE-TOKEN] Token no encontrado, revocado o expirado - Cliente bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 20:29:54,206 - app.modules.auth.application.services.auth_service - WARNING - [REFRESH] Token JWT válido, pero inactivo/revocado en BD. Usuario: superadmin
2025-12-03 20:29:54,217 - app.modules.superadmin.application.services.audit_service - INFO - [AUDIT] auth_audit_log registrado: evento=token_invalid_or_revoked, cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, usuario_id=None, exito=False
2025-12-03 20:29:54,218 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/refresh/ 401 13.6ms
2025-12-03 20:30:04,276 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Pool ADMIN inicializado. Size=10, MaxOverflow=5
2025-12-03 20:30:04,276 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Configuración de pools de tenants: MaxPools=50, PoolSize=3, MaxOverflow=2, InactivityTimeout=3600s
2025-12-03 20:30:04,276 - app.infrastructure.database.connection_pool - INFO - ✅ Módulo de connection pooling cargado y activo
2025-12-03 20:30:04,276 - app.infrastructure.database.connection_pool - INFO -    Configuración: MaxTenantPools=50, TenantPoolSize=3, InactivityTimeout=3600s
2025-12-03 20:30:04,276 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Todos los pools cerrados
2025-12-03 20:30:04,276 - app.main - INFO - ✅ Pools de conexión cerrados correctamente
2025-12-03 20:30:08,426 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 20:30:08,616 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 20:30:08,621 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 20:30:08,623 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 20:30:08,623 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 20:30:08,624 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 20:30:08,624 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 20:30:08,624 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, DEFAULT_TYPE=single
2025-12-03 20:30:08,956 - app.core.security.rate_limiting - INFO - [RATE_LIMITING] Activado. Límites: Login=10/minute, API=200/minute
2025-12-03 20:30:08,957 - app.core.security.rate_limiting - INFO - ✅ Módulo de rate limiting cargado y activo
2025-12-03 20:30:09,029 - app.core.authorization.rbac - INFO - 🔐 Inicializando sistema de autorización...
2025-12-03 20:30:09,029 - app.core.authorization.rbac - INFO - ✅ Sistema de autorización inicializado correctamente
2025-12-03 20:30:09,029 - app.core.authorization.rbac - INFO - 📊 Permisos del sistema: 6 módulos configurados
2025-12-03 20:30:09,198 - app.core.tenant.middleware - INFO - Módulo tenant_middleware cargado (versión híbrida con soporte para proxies)
2025-12-03 20:30:09,198 - app.main - INFO - ✅ Rate limiting configurado y activo
2025-12-03 20:30:09,347 - app.core.tenant.middleware - INFO - [TENANT_MW] Inicializado - BASE_DOMAIN=app.local, SYSTEM_ID=BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, EXCLUDED_SUBDOMAINS={'api', 'cdn', 'www', 'assets', 'static', 'admin', 'backend'}
2025-12-03 20:30:10,547 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/refresh/
2025-12-03 20:30:10,547 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 20:30:10,548 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 20:30:10,548 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 20:30:10,548 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 20:30:10,548 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 20:30:10,548 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 20:30:10,548 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 20:30:10,549 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 20:30:10,549 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 20:30:10,549 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 20:30:10,549 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/auth/refresh/
2025-12-03 20:30:10,558 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] AsyncEngine creado para admin
2025-12-03 20:30:10,599 - app.modules.auth.application.services.refresh_token_service - WARNING - [VALIDATE-TOKEN] Token no encontrado, revocado o expirado - Cliente bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 20:30:10,600 - app.modules.auth.application.services.auth_service - WARNING - [REFRESH] Token JWT válido, pero inactivo/revocado en BD. Usuario: superadmin
2025-12-03 20:30:10,604 - app.modules.superadmin.application.services.audit_service - INFO - [AUDIT] auth_audit_log registrado: evento=token_invalid_or_revoked, cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, usuario_id=None, exito=False
2025-12-03 20:30:10,606 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/refresh/ 401 58.7ms
2025-12-03 20:30:31,605 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/login/
2025-12-03 20:30:31,605 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 20:30:31,606 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 20:30:31,606 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 20:30:31,606 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 20:30:31,606 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 20:30:31,606 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 20:30:31,606 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 20:30:31,606 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 20:30:31,606 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 20:30:31,607 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 20:30:31,607 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/auth/login/
2025-12-03 20:30:31,623 - app.modules.auth.presentation.endpoints - INFO - Cliente bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7 resuelto y validado para login.
2025-12-03 20:30:31,623 - app.modules.auth.application.services.auth_service - INFO - [AUTH] Intento de login: username='superadmin', cliente_id_destino=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 20:30:31,623 - app.modules.auth.application.services.auth_service - INFO - [AUTH] SUPERADMIN detectado. Buscando en BD ADMIN (cliente_id=BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7), accediendo a cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 20:30:31,876 - app.modules.auth.application.services.auth_service - INFO - Niveles calculados - Usuario 154134AD-A5EB-4F45-AEF0-5F9AAA282C8E: level=5, super_admin=True, type=super_admin
2025-12-03 20:30:31,876 - app.modules.auth.application.services.auth_service - INFO - [AUTH] Login exitoso: username='superadmin', usuario_id=154134AD-A5EB-4F45-AEF0-5F9AAA282C8E, cliente_origen=BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, cliente_destino=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, access_level=5, user_type=super_admin
2025-12-03 20:30:31,876 - app.modules.auth.presentation.endpoints - INFO - [LOGIN] Superadmin accediendo a cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 20:30:31,883 - app.modules.auth.application.services.auth_service - INFO - Niveles calculados - Usuario 154134AD-A5EB-4F45-AEF0-5F9AAA282C8E: level=5, super_admin=True, type=super_admin
2025-12-03 20:30:31,887 - app.infrastructure.database.queries_async - ERROR - Error en execute_insert async (string): (pyodbc.Error) ('07002', '[07002] [Microsoft][ODBC Driver 17 for SQL Server]COUNT field incorrect or syntax error (0) (SQLExecDirectW)')
[SQL: 
INSERT INTO refresh_tokens (
    usuario_id, token_hash, expires_at, client_type, ip_address, user_agent, cliente_id
)
OUTPUT INSERTED.token_id, INSERTED.created_at, INSERTED.cliente_id
VALUES (?, ?, ?, ?, ?, ?, ?);
]
(Background on this error at: https://sqlalche.me/e/20/dbapi)
2025-12-03 20:30:31,888 - app.infrastructure.database.connection_async - ERROR - [ASYNC_CONNECTION] Error en sesión async: Error en la inserción: (pyodbc.Error) ('07002', '[07002] [Microsoft][ODBC Driver 17 for SQL Server]COUNT field incorrect or syntax error (0) (SQLExecDirectW)')
[SQL: 
INSERT INTO refresh_tokens (
    usuario_id, token_hash, expires_at, client_type, ip_address, user_agent, cliente_id
)
OUTPUT INSERTED.token_id, INSERTED.created_at, INSERTED.cliente_id
VALUES (?, ?, ?, ?, ?, ?, ?);
]
(Background on this error at: https://sqlalche.me/e/20/dbapi)
Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 230, in execute
    self._adapt_connection._handle_exception(error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 368, in _handle_exception
    raise error.with_traceback(exc_info[2])
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 228, in execute
    return self.await_(self._execute_async(operation, parameters))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 251, in _execute_async
    result = await self._cursor.execute(operation, parameters)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 132, in execute
    await self._run_operation(self._impl.execute, sql, *params)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 30, in _run_operation
    result = await self._conn._execute(func, *args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\concurrent\futures\thread.py", line 59, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
pyodbc.Error: ('07002', '[07002] [Microsoft][ODBC Driver 17 for SQL Server]COUNT field incorrect or syntax error (0) (SQLExecDirectW)')

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 295, in execute_insert
    result = await session.execute(text(query))
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 449, in execute
    result = await greenlet_spawn(
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 203, in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2351, in execute
    return self._execute_internal(
           ^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2258, in _execute_internal
    result = conn.execute(
             ^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1419, in execute
    return meth(
           ^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\sql\elements.py", line 526, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1641, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1846, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1986, in _exec_single_context
    self._handle_dbapi_exception(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 2355, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 230, in execute
    self._adapt_connection._handle_exception(error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 368, in _handle_exception
    raise error.with_traceback(exc_info[2])
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 228, in execute
    return self.await_(self._execute_async(operation, parameters))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 251, in _execute_async
    result = await self._cursor.execute(operation, parameters)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 132, in execute
    await self._run_operation(self._impl.execute, sql, *params)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 30, in _run_operation
    result = await self._conn._execute(func, *args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\concurrent\futures\thread.py", line 59, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
sqlalchemy.exc.DBAPIError: (pyodbc.Error) ('07002', '[07002] [Microsoft][ODBC Driver 17 for SQL Server]COUNT field incorrect or syntax error (0) (SQLExecDirectW)')
[SQL: 
INSERT INTO refresh_tokens (
    usuario_id, token_hash, expires_at, client_type, ip_address, user_agent, cliente_id
)
OUTPUT INSERTED.token_id, INSERTED.created_at, INSERTED.cliente_id
VALUES (?, ?, ?, ?, ?, ?, ?);
]
(Background on this error at: https://sqlalche.me/e/20/dbapi)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\connection_async.py", line 303, in get_db_connection
    yield session
  File "D:\base_multi_tenant_fastapi\app\core\tenant\routing.py", line 672, in get_connection_for_tenant
    yield session
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 311, in execute_insert
    raise DatabaseError(
app.core.exceptions.DatabaseError: Error en la inserción: (pyodbc.Error) ('07002', '[07002] [Microsoft][ODBC Driver 17 for SQL Server]COUNT field incorrect or syntax error (0) (SQLExecDirectW)')
[SQL: 
INSERT INTO refresh_tokens (
    usuario_id, token_hash, expires_at, client_type, ip_address, user_agent, cliente_id
)
OUTPUT INSERTED.token_id, INSERTED.created_at, INSERTED.cliente_id
VALUES (?, ?, ?, ?, ?, ?, ?);
]
(Background on this error at: https://sqlalche.me/e/20/dbapi)
2025-12-03 20:30:31,896 - app.core.application.base_service - ERROR - DatabaseError en store_refresh_token: Error en la inserción: (pyodbc.Error) ('07002', '[07002] [Microsoft][ODBC Driver 17 for SQL Server]COUNT field incorrect or syntax error (0) (SQLExecDirectW)')
[SQL: 
INSERT INTO refresh_tokens (
    usuario_id, token_hash, expires_at, client_type, ip_address, user_agent, cliente_id
)
OUTPUT INSERTED.token_id, INSERTED.created_at, INSERTED.cliente_id
VALUES (?, ?, ?, ?, ?, ?, ?);
]
(Background on this error at: https://sqlalche.me/e/20/dbapi)
Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 230, in execute
    self._adapt_connection._handle_exception(error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 368, in _handle_exception
    raise error.with_traceback(exc_info[2])
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 228, in execute
    return self.await_(self._execute_async(operation, parameters))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 251, in _execute_async
    result = await self._cursor.execute(operation, parameters)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 132, in execute
    await self._run_operation(self._impl.execute, sql, *params)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 30, in _run_operation
    result = await self._conn._execute(func, *args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\concurrent\futures\thread.py", line 59, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
pyodbc.Error: ('07002', '[07002] [Microsoft][ODBC Driver 17 for SQL Server]COUNT field incorrect or syntax error (0) (SQLExecDirectW)')

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 295, in execute_insert
    result = await session.execute(text(query))
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 449, in execute
    result = await greenlet_spawn(
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 203, in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2351, in execute
    return self._execute_internal(
           ^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2258, in _execute_internal
    result = conn.execute(
             ^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1419, in execute
    return meth(
           ^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\sql\elements.py", line 526, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1641, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1846, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1986, in _exec_single_context
    self._handle_dbapi_exception(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 2355, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 230, in execute
    self._adapt_connection._handle_exception(error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 368, in _handle_exception
    raise error.with_traceback(exc_info[2])
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 228, in execute
    return self.await_(self._execute_async(operation, parameters))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 251, in _execute_async
    result = await self._cursor.execute(operation, parameters)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 132, in execute
    await self._run_operation(self._impl.execute, sql, *params)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 30, in _run_operation
    result = await self._conn._execute(func, *args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\concurrent\futures\thread.py", line 59, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
sqlalchemy.exc.DBAPIError: (pyodbc.Error) ('07002', '[07002] [Microsoft][ODBC Driver 17 for SQL Server]COUNT field incorrect or syntax error (0) (SQLExecDirectW)')
[SQL: 
INSERT INTO refresh_tokens (
    usuario_id, token_hash, expires_at, client_type, ip_address, user_agent, cliente_id
)
OUTPUT INSERTED.token_id, INSERTED.created_at, INSERTED.cliente_id
VALUES (?, ?, ?, ?, ?, ?, ?);
]
(Background on this error at: https://sqlalche.me/e/20/dbapi)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\core\application\base_service.py", line 52, in wrapper
    return await func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\modules\auth\application\services\refresh_token_service.py", line 118, in store_refresh_token
    result = await execute_insert(INSERT_REFRESH_TOKEN, params)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 311, in execute_insert
    raise DatabaseError(
app.core.exceptions.DatabaseError: Error en la inserción: (pyodbc.Error) ('07002', '[07002] [Microsoft][ODBC Driver 17 for SQL Server]COUNT field incorrect or syntax error (0) (SQLExecDirectW)')
[SQL: 
INSERT INTO refresh_tokens (
    usuario_id, token_hash, expires_at, client_type, ip_address, user_agent, cliente_id
)
OUTPUT INSERTED.token_id, INSERTED.created_at, INSERTED.cliente_id
VALUES (?, ?, ?, ?, ?, ?, ?);
]
(Background on this error at: https://sqlalche.me/e/20/dbapi)
2025-12-03 20:30:31,902 - app.modules.auth.presentation.endpoints - ERROR - [LOGIN] Error almacenando refresh token: Error en la inserción: (pyodbc.Error) ('07002', '[07002] [Microsoft][ODBC Driver 17 for SQL Server]COUNT field incorrect or syntax error (0) (SQLExecDirectW)')
[SQL: 
INSERT INTO refresh_tokens (
    usuario_id, token_hash, expires_at, client_type, ip_address, user_agent, cliente_id
)
OUTPUT INSERTED.token_id, INSERTED.created_at, INSERTED.cliente_id
VALUES (?, ?, ?, ?, ?, ?, ?);
]
(Background on this error at: https://sqlalche.me/e/20/dbapi)
2025-12-03 20:30:31,903 - app.modules.auth.presentation.endpoints - INFO - Usuario superadmin autenticado exitosamente (WEB) para cliente bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 20:30:31,916 - app.modules.superadmin.application.services.audit_service - INFO - [AUDIT] auth_audit_log registrado: evento=login_success, cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, usuario_id=154134AD-A5EB-4F45-AEF0-5F9AAA282C8E, exito=True
2025-12-03 20:30:31,918 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/login/ 200 312.9ms
2025-12-03 20:30:31,926 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/clientes/tenant/branding
2025-12-03 20:30:31,926 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 20:30:31,926 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 20:30:31,926 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 20:30:31,926 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 20:30:31,928 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 20:30:31,928 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 20:30:31,928 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 20:30:31,928 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 20:30:31,928 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 20:30:31,928 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 20:30:31,928 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/clientes/tenant/branding
2025-12-03 20:30:31,942 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/menus/getmenu/
2025-12-03 20:30:31,942 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 20:30:31,942 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 20:30:31,944 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 20:30:31,944 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 20:30:31,944 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 20:30:31,944 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 20:30:31,944 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 20:30:31,944 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 20:30:31,944 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 20:30:31,944 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 20:30:31,944 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/menus/getmenu/
2025-12-03 20:30:31,976 - app.modules.tenant.presentation.endpoints_clientes - INFO - Solicitud GET /tenant/branding recibida para cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7 por usuario: superadmin
2025-12-03 20:30:31,976 - app.modules.tenant.application.services.cliente_service - INFO - Solicitando branding para cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 20:30:31,976 - app.modules.menus.presentation.endpoints - INFO - Solicitud GET /menus/getmenu/ recibida para usuario ID: 154134ad-a5eb-4f45-aef0-5f9aaa282c8e del cliente bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 20:30:31,976 - app.modules.menus.application.services.menu_service - INFO - Obteniendo menú filtrado para usuario_id: 154134ad-a5eb-4f45-aef0-5f9aaa282c8e
2025-12-03 20:30:31,976 - app.modules.tenant.application.services.cliente_service - INFO - Branding obtenido exitosamente para cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 20:30:31,976 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/clientes/tenant/branding 200 57.4ms
2025-12-03 20:30:31,986 - app.infrastructure.database.queries_async - ERROR - Error en execute_procedure_params async: (pyodbc.DataError) ('22018', '[22018] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Operand type clash: uniqueidentifier is incompatible with int (206) (SQLExecDirectW)')
[SQL: EXEC sp_GetMenuForUser @UsuarioID = ?]
[parameters: (UUID('154134ad-a5eb-4f45-aef0-5f9aaa282c8e'),)]
(Background on this error at: https://sqlalche.me/e/20/9h9h)
2025-12-03 20:30:31,986 - app.infrastructure.database.connection_async - ERROR - [ASYNC_CONNECTION] Error en sesión async: Error ejecutando stored procedure sp_GetMenuForUser: (pyodbc.DataError) ('22018', '[22018] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Operand type clash: uniqueidentifier is incompatible with int (206) (SQLExecDirectW)')
[SQL: EXEC sp_GetMenuForUser @UsuarioID = ?]
[parameters: (UUID('154134ad-a5eb-4f45-aef0-5f9aaa282c8e'),)]
(Background on this error at: https://sqlalche.me/e/20/9h9h)
Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 230, in execute
    self._adapt_connection._handle_exception(error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 368, in _handle_exception
    raise error.with_traceback(exc_info[2])
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 228, in execute
    return self.await_(self._execute_async(operation, parameters))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 251, in _execute_async
    result = await self._cursor.execute(operation, parameters)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 132, in execute
    await self._run_operation(self._impl.execute, sql, *params)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 30, in _run_operation
    result = await self._conn._execute(func, *args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\concurrent\futures\thread.py", line 59, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
pyodbc.DataError: ('22018', '[22018] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Operand type clash: uniqueidentifier is incompatible with int (206) (SQLExecDirectW)')

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 465, in execute_procedure_params
    result = await session.execute(query, param_bindings)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 449, in execute
    result = await greenlet_spawn(
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 203, in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2351, in execute
    return self._execute_internal(
           ^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2258, in _execute_internal
    result = conn.execute(
             ^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1419, in execute
    return meth(
           ^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\sql\elements.py", line 526, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1641, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1846, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1986, in _exec_single_context
    self._handle_dbapi_exception(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 2355, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 230, in execute
    self._adapt_connection._handle_exception(error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 368, in _handle_exception
    raise error.with_traceback(exc_info[2])
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 228, in execute
    return self.await_(self._execute_async(operation, parameters))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 251, in _execute_async
    result = await self._cursor.execute(operation, parameters)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 132, in execute
    await self._run_operation(self._impl.execute, sql, *params)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 30, in _run_operation
    result = await self._conn._execute(func, *args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\concurrent\futures\thread.py", line 59, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
sqlalchemy.exc.DataError: (pyodbc.DataError) ('22018', '[22018] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Operand type clash: uniqueidentifier is incompatible with int (206) (SQLExecDirectW)')
[SQL: EXEC sp_GetMenuForUser @UsuarioID = ?]
[parameters: (UUID('154134ad-a5eb-4f45-aef0-5f9aaa282c8e'),)]
(Background on this error at: https://sqlalche.me/e/20/9h9h)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\connection_async.py", line 303, in get_db_connection
    yield session
  File "D:\base_multi_tenant_fastapi\app\core\tenant\routing.py", line 672, in get_connection_for_tenant
    yield session
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 488, in execute_procedure_params
    raise DatabaseError(
app.core.exceptions.DatabaseError: Error ejecutando stored procedure sp_GetMenuForUser: (pyodbc.DataError) ('22018', '[22018] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Operand type clash: uniqueidentifier is incompatible with int (206) (SQLExecDirectW)')
[SQL: EXEC sp_GetMenuForUser @UsuarioID = ?]
[parameters: (UUID('154134ad-a5eb-4f45-aef0-5f9aaa282c8e'),)]
(Background on this error at: https://sqlalche.me/e/20/9h9h)
2025-12-03 20:30:31,990 - app.modules.menus.application.services.menu_service - ERROR - Error de BD al obtener menú para usuario 154134ad-a5eb-4f45-aef0-5f9aaa282c8e: Error ejecutando stored procedure sp_GetMenuForUser: (pyodbc.DataError) ('22018', '[22018] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Operand type clash: uniqueidentifier is incompatible with int (206) (SQLExecDirectW)')
[SQL: EXEC sp_GetMenuForUser @UsuarioID = ?]
[parameters: (UUID('154134ad-a5eb-4f45-aef0-5f9aaa282c8e'),)]
(Background on this error at: https://sqlalche.me/e/20/9h9h)
2025-12-03 20:30:31,990 - app.modules.menus.presentation.endpoints - ERROR - Error de servicio en GET /getmenu/ para usuario 154134ad-a5eb-4f45-aef0-5f9aaa282c8e: Error de base de datos al obtener menú del usuario
2025-12-03 20:30:31,990 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/menus/getmenu/ 500 48.4ms
2025-12-03 20:30:31,990 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/menus/getmenu/
2025-12-03 20:30:31,990 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 20:30:31,990 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 20:30:31,994 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 20:30:31,994 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 20:30:31,994 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 20:30:31,994 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 20:30:31,994 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 20:30:31,994 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 20:30:31,994 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 20:30:31,994 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 20:30:31,994 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/menus/getmenu/
2025-12-03 20:30:32,012 - app.modules.menus.presentation.endpoints - INFO - Solicitud GET /menus/getmenu/ recibida para usuario ID: 154134ad-a5eb-4f45-aef0-5f9aaa282c8e del cliente bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 20:30:32,012 - app.modules.menus.application.services.menu_service - INFO - Obteniendo menú filtrado para usuario_id: 154134ad-a5eb-4f45-aef0-5f9aaa282c8e
2025-12-03 20:30:32,014 - app.infrastructure.database.queries_async - ERROR - Error en execute_procedure_params async: (pyodbc.DataError) ('22018', '[22018] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Operand type clash: uniqueidentifier is incompatible with int (206) (SQLExecDirectW)')
[SQL: EXEC sp_GetMenuForUser @UsuarioID = ?]
[parameters: (UUID('154134ad-a5eb-4f45-aef0-5f9aaa282c8e'),)]
(Background on this error at: https://sqlalche.me/e/20/9h9h)
2025-12-03 20:30:32,014 - app.infrastructure.database.connection_async - ERROR - [ASYNC_CONNECTION] Error en sesión async: Error ejecutando stored procedure sp_GetMenuForUser: (pyodbc.DataError) ('22018', '[22018] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Operand type clash: uniqueidentifier is incompatible with int (206) (SQLExecDirectW)')
[SQL: EXEC sp_GetMenuForUser @UsuarioID = ?]
[parameters: (UUID('154134ad-a5eb-4f45-aef0-5f9aaa282c8e'),)]
(Background on this error at: https://sqlalche.me/e/20/9h9h)
Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 230, in execute
    self._adapt_connection._handle_exception(error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 368, in _handle_exception
    raise error.with_traceback(exc_info[2])
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 228, in execute
    return self.await_(self._execute_async(operation, parameters))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 251, in _execute_async
    result = await self._cursor.execute(operation, parameters)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 132, in execute
    await self._run_operation(self._impl.execute, sql, *params)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 30, in _run_operation
    result = await self._conn._execute(func, *args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\concurrent\futures\thread.py", line 59, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
pyodbc.DataError: ('22018', '[22018] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Operand type clash: uniqueidentifier is incompatible with int (206) (SQLExecDirectW)')

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 465, in execute_procedure_params
    result = await session.execute(query, param_bindings)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 449, in execute
    result = await greenlet_spawn(
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 203, in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2351, in execute
    return self._execute_internal(
           ^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2258, in _execute_internal
    result = conn.execute(
             ^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1419, in execute
    return meth(
           ^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\sql\elements.py", line 526, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1641, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1846, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1986, in _exec_single_context
    self._handle_dbapi_exception(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 2355, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 230, in execute
    self._adapt_connection._handle_exception(error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 368, in _handle_exception
    raise error.with_traceback(exc_info[2])
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 228, in execute
    return self.await_(self._execute_async(operation, parameters))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 251, in _execute_async
    result = await self._cursor.execute(operation, parameters)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 132, in execute
    await self._run_operation(self._impl.execute, sql, *params)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 30, in _run_operation
    result = await self._conn._execute(func, *args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\concurrent\futures\thread.py", line 59, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
sqlalchemy.exc.DataError: (pyodbc.DataError) ('22018', '[22018] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Operand type clash: uniqueidentifier is incompatible with int (206) (SQLExecDirectW)')
[SQL: EXEC sp_GetMenuForUser @UsuarioID = ?]
[parameters: (UUID('154134ad-a5eb-4f45-aef0-5f9aaa282c8e'),)]
(Background on this error at: https://sqlalche.me/e/20/9h9h)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\connection_async.py", line 303, in get_db_connection
    yield session
  File "D:\base_multi_tenant_fastapi\app\core\tenant\routing.py", line 672, in get_connection_for_tenant
    yield session
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 488, in execute_procedure_params
    raise DatabaseError(
app.core.exceptions.DatabaseError: Error ejecutando stored procedure sp_GetMenuForUser: (pyodbc.DataError) ('22018', '[22018] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Operand type clash: uniqueidentifier is incompatible with int (206) (SQLExecDirectW)')
[SQL: EXEC sp_GetMenuForUser @UsuarioID = ?]
[parameters: (UUID('154134ad-a5eb-4f45-aef0-5f9aaa282c8e'),)]
(Background on this error at: https://sqlalche.me/e/20/9h9h)
2025-12-03 20:30:32,018 - app.modules.menus.application.services.menu_service - ERROR - Error de BD al obtener menú para usuario 154134ad-a5eb-4f45-aef0-5f9aaa282c8e: Error ejecutando stored procedure sp_GetMenuForUser: (pyodbc.DataError) ('22018', '[22018] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Operand type clash: uniqueidentifier is incompatible with int (206) (SQLExecDirectW)')
[SQL: EXEC sp_GetMenuForUser @UsuarioID = ?]
[parameters: (UUID('154134ad-a5eb-4f45-aef0-5f9aaa282c8e'),)]
(Background on this error at: https://sqlalche.me/e/20/9h9h)
2025-12-03 20:30:32,019 - app.modules.menus.presentation.endpoints - ERROR - Error de servicio en GET /getmenu/ para usuario 154134ad-a5eb-4f45-aef0-5f9aaa282c8e: Error de base de datos al obtener menú del usuario
2025-12-03 20:30:32,020 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/menus/getmenu/ 500 26.6ms
2025-12-03 20:30:33,055 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Pool ADMIN inicializado. Size=10, MaxOverflow=5
2025-12-03 20:30:33,055 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Configuración de pools de tenants: MaxPools=50, PoolSize=3, MaxOverflow=2, InactivityTimeout=3600s
2025-12-03 20:30:33,055 - app.infrastructure.database.connection_pool - INFO - ✅ Módulo de connection pooling cargado y activo
2025-12-03 20:30:33,055 - app.infrastructure.database.connection_pool - INFO -    Configuración: MaxTenantPools=50, TenantPoolSize=3, InactivityTimeout=3600s
2025-12-03 20:30:33,055 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Todos los pools cerrados
2025-12-03 20:30:33,055 - app.main - INFO - ✅ Pools de conexión cerrados correctamente
2025-12-03 20:30:34,025 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 20:30:34,273 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 20:30:34,276 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 20:30:34,281 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 20:30:34,281 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 20:30:34,281 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 20:30:34,281 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 20:30:34,281 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, DEFAULT_TYPE=single
2025-12-03 20:30:34,731 - app.core.security.rate_limiting - INFO - [RATE_LIMITING] Activado. Límites: Login=10/minute, API=200/minute
2025-12-03 20:30:34,731 - app.core.security.rate_limiting - INFO - ✅ Módulo de rate limiting cargado y activo
2025-12-03 20:30:34,833 - app.core.authorization.rbac - INFO - 🔐 Inicializando sistema de autorización...
2025-12-03 20:30:34,833 - app.core.authorization.rbac - INFO - ✅ Sistema de autorización inicializado correctamente
2025-12-03 20:30:34,833 - app.core.authorization.rbac - INFO - 📊 Permisos del sistema: 6 módulos configurados
2025-12-03 20:30:35,076 - app.core.tenant.middleware - INFO - Módulo tenant_middleware cargado (versión híbrida con soporte para proxies)
2025-12-03 20:30:35,076 - app.main - INFO - ✅ Rate limiting configurado y activo
2025-12-03 20:30:35,265 - app.core.tenant.middleware - INFO - [TENANT_MW] Inicializado - BASE_DOMAIN=app.local, SYSTEM_ID=BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, EXCLUDED_SUBDOMAINS={'admin', 'backend', 'static', 'www', 'api', 'cdn', 'assets'}
2025-12-03 20:35:07,870 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Pool ADMIN inicializado. Size=10, MaxOverflow=5
2025-12-03 20:35:07,870 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Configuración de pools de tenants: MaxPools=50, PoolSize=3, MaxOverflow=2, InactivityTimeout=3600s
2025-12-03 20:35:07,870 - app.infrastructure.database.connection_pool - INFO - ✅ Módulo de connection pooling cargado y activo
2025-12-03 20:35:07,870 - app.infrastructure.database.connection_pool - INFO -    Configuración: MaxTenantPools=50, TenantPoolSize=3, InactivityTimeout=3600s
2025-12-03 20:35:07,870 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Todos los pools cerrados
2025-12-03 20:35:07,870 - app.main - INFO - ✅ Pools de conexión cerrados correctamente
2025-12-03 20:35:08,791 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 20:35:09,054 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 20:35:09,066 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 20:35:09,070 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 20:35:09,070 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 20:35:09,078 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 20:35:09,078 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 20:35:09,078 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, DEFAULT_TYPE=single
2025-12-03 20:35:09,472 - app.core.security.rate_limiting - INFO - [RATE_LIMITING] Activado. Límites: Login=10/minute, API=200/minute
2025-12-03 20:35:09,472 - app.core.security.rate_limiting - INFO - ✅ Módulo de rate limiting cargado y activo
2025-12-03 20:35:09,571 - app.core.authorization.rbac - INFO - 🔐 Inicializando sistema de autorización...
2025-12-03 20:35:09,571 - app.core.authorization.rbac - INFO - ✅ Sistema de autorización inicializado correctamente
2025-12-03 20:35:09,572 - app.core.authorization.rbac - INFO - 📊 Permisos del sistema: 6 módulos configurados
2025-12-03 20:35:09,765 - app.core.tenant.middleware - INFO - Módulo tenant_middleware cargado (versión híbrida con soporte para proxies)
2025-12-03 20:35:09,765 - app.main - INFO - ✅ Rate limiting configurado y activo
2025-12-03 20:35:09,924 - app.core.tenant.middleware - INFO - [TENANT_MW] Inicializado - BASE_DOMAIN=app.local, SYSTEM_ID=BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, EXCLUDED_SUBDOMAINS={'www', 'cdn', 'static', 'assets', 'admin', 'api', 'backend'}
2025-12-03 20:35:33,295 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Pool ADMIN inicializado. Size=10, MaxOverflow=5
2025-12-03 20:35:33,295 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Configuración de pools de tenants: MaxPools=50, PoolSize=3, MaxOverflow=2, InactivityTimeout=3600s
2025-12-03 20:35:33,295 - app.infrastructure.database.connection_pool - INFO - ✅ Módulo de connection pooling cargado y activo
2025-12-03 20:35:33,295 - app.infrastructure.database.connection_pool - INFO -    Configuración: MaxTenantPools=50, TenantPoolSize=3, InactivityTimeout=3600s
2025-12-03 20:35:33,296 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Todos los pools cerrados
2025-12-03 20:35:33,296 - app.main - INFO - ✅ Pools de conexión cerrados correctamente
2025-12-03 20:35:34,041 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 20:35:34,226 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 20:35:34,234 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 20:35:34,236 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 20:35:34,236 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 20:35:34,237 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 20:35:34,237 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 20:35:34,237 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, DEFAULT_TYPE=single
2025-12-03 20:35:34,558 - app.core.security.rate_limiting - INFO - [RATE_LIMITING] Activado. Límites: Login=10/minute, API=200/minute
2025-12-03 20:35:34,558 - app.core.security.rate_limiting - INFO - ✅ Módulo de rate limiting cargado y activo
2025-12-03 20:35:34,628 - app.core.authorization.rbac - INFO - 🔐 Inicializando sistema de autorización...
2025-12-03 20:35:34,628 - app.core.authorization.rbac - INFO - ✅ Sistema de autorización inicializado correctamente
2025-12-03 20:35:34,628 - app.core.authorization.rbac - INFO - 📊 Permisos del sistema: 6 módulos configurados
2025-12-03 20:35:34,784 - app.core.tenant.middleware - INFO - Módulo tenant_middleware cargado (versión híbrida con soporte para proxies)
2025-12-03 20:35:34,784 - app.main - INFO - ✅ Rate limiting configurado y activo
2025-12-03 20:35:34,924 - app.core.tenant.middleware - INFO - [TENANT_MW] Inicializado - BASE_DOMAIN=app.local, SYSTEM_ID=BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, EXCLUDED_SUBDOMAINS={'backend', 'www', 'api', 'assets', 'static', 'cdn', 'admin'}
2025-12-03 20:40:43,404 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/auth/refresh/
2025-12-03 20:40:43,404 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/auth/refresh/ 200 0.9ms
2025-12-03 20:40:43,407 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/refresh/
2025-12-03 20:40:43,408 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 20:40:43,408 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 20:40:43,408 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 20:40:43,408 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 20:40:43,409 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 20:40:43,409 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 20:40:43,409 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 20:40:43,409 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 20:40:43,409 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 20:40:43,409 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 20:40:43,410 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/auth/refresh/
2025-12-03 20:40:43,416 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] AsyncEngine creado para admin
2025-12-03 20:40:43,578 - app.modules.auth.application.services.refresh_token_service - WARNING - [VALIDATE-TOKEN] Token no encontrado, revocado o expirado - Cliente bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 20:40:43,578 - app.modules.auth.application.services.auth_service - WARNING - [REFRESH] Token JWT válido, pero inactivo/revocado en BD. Usuario: superadmin
2025-12-03 20:40:43,591 - app.modules.superadmin.application.services.audit_service - INFO - [AUDIT] auth_audit_log registrado: evento=token_invalid_or_revoked, cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, usuario_id=None, exito=False
2025-12-03 20:40:43,594 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/refresh/ 401 186.2ms
2025-12-03 20:40:48,900 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/refresh/
2025-12-03 20:40:48,901 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 20:40:48,901 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 20:40:48,901 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 20:40:48,901 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 20:40:48,901 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 20:40:48,901 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 20:40:48,902 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 20:40:48,902 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 20:40:48,902 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 20:40:48,902 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 20:40:48,902 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/auth/refresh/
2025-12-03 20:40:48,911 - app.modules.auth.application.services.refresh_token_service - WARNING - [VALIDATE-TOKEN] Token no encontrado, revocado o expirado - Cliente bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 20:40:48,911 - app.modules.auth.application.services.auth_service - WARNING - [REFRESH] Token JWT válido, pero inactivo/revocado en BD. Usuario: superadmin
2025-12-03 20:40:48,919 - app.modules.superadmin.application.services.audit_service - INFO - [AUDIT] auth_audit_log registrado: evento=token_invalid_or_revoked, cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, usuario_id=None, exito=False
2025-12-03 20:40:48,920 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/refresh/ 401 20.2ms
2025-12-03 20:41:02,750 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/auth/login/
2025-12-03 20:41:02,750 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/auth/login/ 200 0.5ms
2025-12-03 20:41:02,752 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/login/
2025-12-03 20:41:02,753 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 20:41:02,753 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 20:41:02,753 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 20:41:02,753 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 20:41:02,753 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 20:41:02,753 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 20:41:02,753 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 20:41:02,753 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 20:41:02,753 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 20:41:02,753 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 20:41:02,755 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/auth/login/
2025-12-03 20:41:02,762 - app.modules.auth.presentation.endpoints - INFO - Cliente bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7 resuelto y validado para login.
2025-12-03 20:41:02,762 - app.modules.auth.application.services.auth_service - INFO - [AUTH] Intento de login: username='superadmin', cliente_id_destino=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 20:41:02,762 - app.modules.auth.application.services.auth_service - INFO - [AUTH] SUPERADMIN detectado. Buscando en BD ADMIN (cliente_id=BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7), accediendo a cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 20:41:02,998 - app.modules.auth.application.services.auth_service - INFO - Niveles calculados - Usuario 154134AD-A5EB-4F45-AEF0-5F9AAA282C8E: level=5, super_admin=True, type=super_admin
2025-12-03 20:41:02,998 - app.modules.auth.application.services.auth_service - INFO - [AUTH] Login exitoso: username='superadmin', usuario_id=154134AD-A5EB-4F45-AEF0-5F9AAA282C8E, cliente_origen=BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, cliente_destino=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, access_level=5, user_type=super_admin
2025-12-03 20:41:02,998 - app.modules.auth.presentation.endpoints - INFO - [LOGIN] Superadmin accediendo a cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 20:41:02,998 - app.modules.auth.application.services.auth_service - INFO - Niveles calculados - Usuario 154134AD-A5EB-4F45-AEF0-5F9AAA282C8E: level=5, super_admin=True, type=super_admin
2025-12-03 20:41:03,014 - app.infrastructure.database.queries_async - ERROR - Error en execute_insert async (string): (pyodbc.Error) ('07002', '[07002] [Microsoft][ODBC Driver 17 for SQL Server]COUNT field incorrect or syntax error (0) (SQLExecDirectW)')
[SQL: 
INSERT INTO refresh_tokens (
    usuario_id, token_hash, expires_at, client_type, ip_address, user_agent, cliente_id
)
OUTPUT INSERTED.token_id, INSERTED.created_at, INSERTED.cliente_id
VALUES (?, ?, ?, ?, ?, ?, ?);
]
(Background on this error at: https://sqlalche.me/e/20/dbapi)
2025-12-03 20:41:03,014 - app.infrastructure.database.connection_async - ERROR - [ASYNC_CONNECTION] Error en sesión async: Error en la inserción: (pyodbc.Error) ('07002', '[07002] [Microsoft][ODBC Driver 17 for SQL Server]COUNT field incorrect or syntax error (0) (SQLExecDirectW)')
[SQL: 
INSERT INTO refresh_tokens (
    usuario_id, token_hash, expires_at, client_type, ip_address, user_agent, cliente_id
)
OUTPUT INSERTED.token_id, INSERTED.created_at, INSERTED.cliente_id
VALUES (?, ?, ?, ?, ?, ?, ?);
]
(Background on this error at: https://sqlalche.me/e/20/dbapi)
Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 230, in execute
    self._adapt_connection._handle_exception(error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 368, in _handle_exception
    raise error.with_traceback(exc_info[2])
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 228, in execute
    return self.await_(self._execute_async(operation, parameters))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 251, in _execute_async
    result = await self._cursor.execute(operation, parameters)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 132, in execute
    await self._run_operation(self._impl.execute, sql, *params)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 30, in _run_operation
    result = await self._conn._execute(func, *args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\concurrent\futures\thread.py", line 59, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
pyodbc.Error: ('07002', '[07002] [Microsoft][ODBC Driver 17 for SQL Server]COUNT field incorrect or syntax error (0) (SQLExecDirectW)')

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 295, in execute_insert
    result = await session.execute(text(query))
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 449, in execute
    result = await greenlet_spawn(
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 203, in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2351, in execute
    return self._execute_internal(
           ^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2258, in _execute_internal
    result = conn.execute(
             ^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1419, in execute
    return meth(
           ^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\sql\elements.py", line 526, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1641, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1846, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1986, in _exec_single_context
    self._handle_dbapi_exception(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 2355, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 230, in execute
    self._adapt_connection._handle_exception(error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 368, in _handle_exception
    raise error.with_traceback(exc_info[2])
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 228, in execute
    return self.await_(self._execute_async(operation, parameters))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 251, in _execute_async
    result = await self._cursor.execute(operation, parameters)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 132, in execute
    await self._run_operation(self._impl.execute, sql, *params)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 30, in _run_operation
    result = await self._conn._execute(func, *args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\concurrent\futures\thread.py", line 59, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
sqlalchemy.exc.DBAPIError: (pyodbc.Error) ('07002', '[07002] [Microsoft][ODBC Driver 17 for SQL Server]COUNT field incorrect or syntax error (0) (SQLExecDirectW)')
[SQL: 
INSERT INTO refresh_tokens (
    usuario_id, token_hash, expires_at, client_type, ip_address, user_agent, cliente_id
)
OUTPUT INSERTED.token_id, INSERTED.created_at, INSERTED.cliente_id
VALUES (?, ?, ?, ?, ?, ?, ?);
]
(Background on this error at: https://sqlalche.me/e/20/dbapi)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\connection_async.py", line 303, in get_db_connection
    yield session
  File "D:\base_multi_tenant_fastapi\app\core\tenant\routing.py", line 672, in get_connection_for_tenant
    yield session
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 311, in execute_insert
    raise DatabaseError(
app.core.exceptions.DatabaseError: Error en la inserción: (pyodbc.Error) ('07002', '[07002] [Microsoft][ODBC Driver 17 for SQL Server]COUNT field incorrect or syntax error (0) (SQLExecDirectW)')
[SQL: 
INSERT INTO refresh_tokens (
    usuario_id, token_hash, expires_at, client_type, ip_address, user_agent, cliente_id
)
OUTPUT INSERTED.token_id, INSERTED.created_at, INSERTED.cliente_id
VALUES (?, ?, ?, ?, ?, ?, ?);
]
(Background on this error at: https://sqlalche.me/e/20/dbapi)
2025-12-03 20:41:03,026 - app.core.application.base_service - ERROR - DatabaseError en store_refresh_token: Error en la inserción: (pyodbc.Error) ('07002', '[07002] [Microsoft][ODBC Driver 17 for SQL Server]COUNT field incorrect or syntax error (0) (SQLExecDirectW)')
[SQL: 
INSERT INTO refresh_tokens (
    usuario_id, token_hash, expires_at, client_type, ip_address, user_agent, cliente_id
)
OUTPUT INSERTED.token_id, INSERTED.created_at, INSERTED.cliente_id
VALUES (?, ?, ?, ?, ?, ?, ?);
]
(Background on this error at: https://sqlalche.me/e/20/dbapi)
Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 230, in execute
    self._adapt_connection._handle_exception(error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 368, in _handle_exception
    raise error.with_traceback(exc_info[2])
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 228, in execute
    return self.await_(self._execute_async(operation, parameters))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 251, in _execute_async
    result = await self._cursor.execute(operation, parameters)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 132, in execute
    await self._run_operation(self._impl.execute, sql, *params)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 30, in _run_operation
    result = await self._conn._execute(func, *args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\concurrent\futures\thread.py", line 59, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
pyodbc.Error: ('07002', '[07002] [Microsoft][ODBC Driver 17 for SQL Server]COUNT field incorrect or syntax error (0) (SQLExecDirectW)')

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 295, in execute_insert
    result = await session.execute(text(query))
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 449, in execute
    result = await greenlet_spawn(
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 203, in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2351, in execute
    return self._execute_internal(
           ^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2258, in _execute_internal
    result = conn.execute(
             ^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1419, in execute
    return meth(
           ^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\sql\elements.py", line 526, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1641, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1846, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1986, in _exec_single_context
    self._handle_dbapi_exception(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 2355, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 230, in execute
    self._adapt_connection._handle_exception(error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 368, in _handle_exception
    raise error.with_traceback(exc_info[2])
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 228, in execute
    return self.await_(self._execute_async(operation, parameters))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 251, in _execute_async
    result = await self._cursor.execute(operation, parameters)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 132, in execute
    await self._run_operation(self._impl.execute, sql, *params)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 30, in _run_operation
    result = await self._conn._execute(func, *args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\concurrent\futures\thread.py", line 59, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
sqlalchemy.exc.DBAPIError: (pyodbc.Error) ('07002', '[07002] [Microsoft][ODBC Driver 17 for SQL Server]COUNT field incorrect or syntax error (0) (SQLExecDirectW)')
[SQL: 
INSERT INTO refresh_tokens (
    usuario_id, token_hash, expires_at, client_type, ip_address, user_agent, cliente_id
)
OUTPUT INSERTED.token_id, INSERTED.created_at, INSERTED.cliente_id
VALUES (?, ?, ?, ?, ?, ?, ?);
]
(Background on this error at: https://sqlalche.me/e/20/dbapi)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\core\application\base_service.py", line 52, in wrapper
    return await func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\modules\auth\application\services\refresh_token_service.py", line 118, in store_refresh_token
    result = await execute_insert(INSERT_REFRESH_TOKEN, params)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 311, in execute_insert
    raise DatabaseError(
app.core.exceptions.DatabaseError: Error en la inserción: (pyodbc.Error) ('07002', '[07002] [Microsoft][ODBC Driver 17 for SQL Server]COUNT field incorrect or syntax error (0) (SQLExecDirectW)')
[SQL: 
INSERT INTO refresh_tokens (
    usuario_id, token_hash, expires_at, client_type, ip_address, user_agent, cliente_id
)
OUTPUT INSERTED.token_id, INSERTED.created_at, INSERTED.cliente_id
VALUES (?, ?, ?, ?, ?, ?, ?);
]
(Background on this error at: https://sqlalche.me/e/20/dbapi)
2025-12-03 20:41:03,030 - app.modules.auth.presentation.endpoints - ERROR - [LOGIN] Error almacenando refresh token: Error en la inserción: (pyodbc.Error) ('07002', '[07002] [Microsoft][ODBC Driver 17 for SQL Server]COUNT field incorrect or syntax error (0) (SQLExecDirectW)')
[SQL: 
INSERT INTO refresh_tokens (
    usuario_id, token_hash, expires_at, client_type, ip_address, user_agent, cliente_id
)
OUTPUT INSERTED.token_id, INSERTED.created_at, INSERTED.cliente_id
VALUES (?, ?, ?, ?, ?, ?, ?);
]
(Background on this error at: https://sqlalche.me/e/20/dbapi)
2025-12-03 20:41:03,031 - app.modules.auth.presentation.endpoints - INFO - Usuario superadmin autenticado exitosamente (WEB) para cliente bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 20:41:03,036 - app.modules.superadmin.application.services.audit_service - INFO - [AUDIT] auth_audit_log registrado: evento=login_success, cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, usuario_id=154134AD-A5EB-4F45-AEF0-5F9AAA282C8E, exito=True
2025-12-03 20:41:03,036 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/login/ 200 287.2ms
2025-12-03 20:41:03,047 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/clientes/tenant/branding
2025-12-03 20:41:03,048 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/clientes/tenant/branding 200 0.6ms
2025-12-03 20:41:03,050 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/clientes/tenant/branding
2025-12-03 20:41:03,051 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 20:41:03,051 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 20:41:03,051 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 20:41:03,051 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 20:41:03,051 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 20:41:03,051 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 20:41:03,051 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 20:41:03,052 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 20:41:03,052 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 20:41:03,052 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 20:41:03,052 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/clientes/tenant/branding
2025-12-03 20:41:03,063 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/menus/getmenu/
2025-12-03 20:41:03,065 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/menus/getmenu/ 200 1.5ms
2025-12-03 20:41:03,066 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/menus/getmenu/
2025-12-03 20:41:03,068 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/menus/getmenu/ 200 1.7ms
2025-12-03 20:41:03,070 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/menus/getmenu/
2025-12-03 20:41:03,073 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 20:41:03,073 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 20:41:03,073 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 20:41:03,073 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 20:41:03,073 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 20:41:03,074 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 20:41:03,074 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 20:41:03,074 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 20:41:03,074 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 20:41:03,074 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 20:41:03,074 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/menus/getmenu/
2025-12-03 20:41:03,111 - app.modules.tenant.presentation.endpoints_clientes - INFO - Solicitud GET /tenant/branding recibida para cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7 por usuario: superadmin
2025-12-03 20:41:03,111 - app.modules.tenant.application.services.cliente_service - INFO - Solicitando branding para cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 20:41:03,116 - app.modules.menus.presentation.endpoints - INFO - Solicitud GET /menus/getmenu/ recibida para usuario ID: 154134ad-a5eb-4f45-aef0-5f9aaa282c8e del cliente bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 20:41:03,117 - app.modules.menus.application.services.menu_service - INFO - Obteniendo menú filtrado para usuario_id: 154134ad-a5eb-4f45-aef0-5f9aaa282c8e
2025-12-03 20:41:03,119 - app.modules.tenant.application.services.cliente_service - INFO - Branding obtenido exitosamente para cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 20:41:03,120 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/clientes/tenant/branding 200 69.6ms
2025-12-03 20:41:03,186 - app.modules.menus.application.services.menu_service - INFO - No se encontraron menús permitidos para el usuario ID: 154134ad-a5eb-4f45-aef0-5f9aaa282c8e.
2025-12-03 20:41:03,186 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/menus/getmenu/ 200 116.9ms
2025-12-03 20:41:03,188 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/menus/getmenu/
2025-12-03 20:41:03,188 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 20:41:03,188 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 20:41:03,189 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 20:41:03,189 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 20:41:03,189 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 20:41:03,189 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 20:41:03,189 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 20:41:03,189 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 20:41:03,189 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 20:41:03,190 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 20:41:03,190 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/menus/getmenu/
2025-12-03 20:41:03,221 - app.modules.menus.presentation.endpoints - INFO - Solicitud GET /menus/getmenu/ recibida para usuario ID: 154134ad-a5eb-4f45-aef0-5f9aaa282c8e del cliente bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 20:41:03,221 - app.modules.menus.application.services.menu_service - INFO - Obteniendo menú filtrado para usuario_id: 154134ad-a5eb-4f45-aef0-5f9aaa282c8e
2025-12-03 20:41:03,226 - app.modules.menus.application.services.menu_service - INFO - No se encontraron menús permitidos para el usuario ID: 154134ad-a5eb-4f45-aef0-5f9aaa282c8e.
2025-12-03 20:41:03,226 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/menus/getmenu/ 200 39.1ms
2025-12-03 20:42:56,768 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Pool ADMIN inicializado. Size=10, MaxOverflow=5
2025-12-03 20:42:56,768 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Configuración de pools de tenants: MaxPools=50, PoolSize=3, MaxOverflow=2, InactivityTimeout=3600s
2025-12-03 20:42:56,768 - app.infrastructure.database.connection_pool - INFO - ✅ Módulo de connection pooling cargado y activo
2025-12-03 20:42:56,768 - app.infrastructure.database.connection_pool - INFO -    Configuración: MaxTenantPools=50, TenantPoolSize=3, InactivityTimeout=3600s
2025-12-03 20:42:56,768 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Todos los pools cerrados
2025-12-03 20:42:56,768 - app.main - INFO - ✅ Pools de conexión cerrados correctamente
2025-12-03 20:43:00,148 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/refresh/
2025-12-03 20:43:00,148 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 20:43:00,148 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 20:43:00,148 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 20:43:00,148 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 20:43:00,148 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 20:43:00,148 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 20:43:00,148 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 20:43:00,148 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 20:43:00,148 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 20:43:00,148 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 20:43:00,148 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/auth/refresh/
2025-12-03 20:43:00,160 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] AsyncEngine creado para admin
2025-12-03 20:43:00,318 - app.modules.auth.application.services.refresh_token_service - WARNING - [VALIDATE-TOKEN] Token no encontrado, revocado o expirado - Cliente bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 20:43:00,318 - app.modules.auth.application.services.auth_service - WARNING - [REFRESH] Token JWT válido, pero inactivo/revocado en BD. Usuario: superadmin
2025-12-03 20:43:00,328 - app.modules.superadmin.application.services.audit_service - INFO - [AUDIT] auth_audit_log registrado: evento=token_invalid_or_revoked, cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, usuario_id=None, exito=False
2025-12-03 20:43:00,328 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/refresh/ 401 182.8ms
2025-12-03 20:43:03,855 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 20:43:04,048 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 20:43:04,054 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 20:43:04,056 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 20:43:04,056 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 20:43:04,057 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 20:43:04,057 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 20:43:04,057 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, DEFAULT_TYPE=single
2025-12-03 20:43:04,377 - app.core.security.rate_limiting - INFO - [RATE_LIMITING] Activado. Límites: Login=10/minute, API=200/minute
2025-12-03 20:43:04,377 - app.core.security.rate_limiting - INFO - ✅ Módulo de rate limiting cargado y activo
2025-12-03 20:43:04,449 - app.core.authorization.rbac - INFO - 🔐 Inicializando sistema de autorización...
2025-12-03 20:43:04,450 - app.core.authorization.rbac - INFO - ✅ Sistema de autorización inicializado correctamente
2025-12-03 20:43:04,450 - app.core.authorization.rbac - INFO - 📊 Permisos del sistema: 6 módulos configurados
2025-12-03 20:43:04,611 - app.core.tenant.middleware - INFO - Módulo tenant_middleware cargado (versión híbrida con soporte para proxies)
2025-12-03 20:43:04,611 - app.main - INFO - ✅ Rate limiting configurado y activo
2025-12-03 20:43:04,752 - app.core.tenant.middleware - INFO - [TENANT_MW] Inicializado - BASE_DOMAIN=app.local, SYSTEM_ID=BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, EXCLUDED_SUBDOMAINS={'backend', 'api', 'www', 'assets', 'cdn', 'admin', 'static'}
2025-12-03 20:43:09,449 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/refresh/
2025-12-03 20:43:09,449 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 20:43:09,450 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 20:43:09,450 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 20:43:09,450 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 20:43:09,450 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 20:43:09,450 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 20:43:09,451 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 20:43:09,451 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 20:43:09,451 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 20:43:09,451 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 20:43:09,451 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/auth/refresh/
2025-12-03 20:43:09,460 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] AsyncEngine creado para admin
2025-12-03 20:43:09,505 - app.modules.auth.application.services.refresh_token_service - WARNING - [VALIDATE-TOKEN] Token no encontrado, revocado o expirado - Cliente bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 20:43:09,506 - app.modules.auth.application.services.auth_service - WARNING - [REFRESH] Token JWT válido, pero inactivo/revocado en BD. Usuario: superadmin
2025-12-03 20:43:09,511 - app.modules.superadmin.application.services.audit_service - INFO - [AUDIT] auth_audit_log registrado: evento=token_invalid_or_revoked, cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, usuario_id=None, exito=False
2025-12-03 20:43:09,512 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/refresh/ 401 62.7ms
2025-12-03 20:43:30,565 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/login/
2025-12-03 20:43:30,565 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 20:43:30,566 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 20:43:30,566 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 20:43:30,566 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 20:43:30,566 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 20:43:30,566 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 20:43:30,567 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 20:43:30,567 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 20:43:30,567 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 20:43:30,567 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 20:43:30,567 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/auth/login/
2025-12-03 20:43:30,575 - app.modules.auth.presentation.endpoints - INFO - Cliente bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7 resuelto y validado para login.
2025-12-03 20:43:30,575 - app.modules.auth.application.services.auth_service - INFO - [AUTH] Intento de login: username='superadmin', cliente_id_destino=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 20:43:30,575 - app.modules.auth.application.services.auth_service - INFO - [AUTH] SUPERADMIN detectado. Buscando en BD ADMIN (cliente_id=BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7), accediendo a cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 20:43:30,819 - app.modules.auth.application.services.auth_service - INFO - Niveles calculados - Usuario 154134AD-A5EB-4F45-AEF0-5F9AAA282C8E: level=5, super_admin=True, type=super_admin
2025-12-03 20:43:30,819 - app.modules.auth.application.services.auth_service - INFO - [AUTH] Login exitoso: username='superadmin', usuario_id=154134AD-A5EB-4F45-AEF0-5F9AAA282C8E, cliente_origen=BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, cliente_destino=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, access_level=5, user_type=super_admin
2025-12-03 20:43:30,819 - app.modules.auth.presentation.endpoints - INFO - [LOGIN] Superadmin accediendo a cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 20:43:30,825 - app.modules.auth.application.services.auth_service - INFO - Niveles calculados - Usuario 154134AD-A5EB-4F45-AEF0-5F9AAA282C8E: level=5, super_admin=True, type=super_admin
2025-12-03 20:43:30,830 - app.infrastructure.database.queries_async - ERROR - Error en execute_insert async (string): (pyodbc.Error) ('07002', '[07002] [Microsoft][ODBC Driver 17 for SQL Server]COUNT field incorrect or syntax error (0) (SQLExecDirectW)')
[SQL: 
INSERT INTO refresh_tokens (
    usuario_id, token_hash, expires_at, client_type, ip_address, user_agent, cliente_id
)
OUTPUT INSERTED.token_id, INSERTED.created_at, INSERTED.cliente_id
VALUES (?, ?, ?, ?, ?, ?, ?);
]
(Background on this error at: https://sqlalche.me/e/20/dbapi)
2025-12-03 20:43:30,830 - app.infrastructure.database.connection_async - ERROR - [ASYNC_CONNECTION] Error en sesión async: Error en la inserción: (pyodbc.Error) ('07002', '[07002] [Microsoft][ODBC Driver 17 for SQL Server]COUNT field incorrect or syntax error (0) (SQLExecDirectW)')
[SQL: 
INSERT INTO refresh_tokens (
    usuario_id, token_hash, expires_at, client_type, ip_address, user_agent, cliente_id
)
OUTPUT INSERTED.token_id, INSERTED.created_at, INSERTED.cliente_id
VALUES (?, ?, ?, ?, ?, ?, ?);
]
(Background on this error at: https://sqlalche.me/e/20/dbapi)
Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 230, in execute
    self._adapt_connection._handle_exception(error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 368, in _handle_exception
    raise error.with_traceback(exc_info[2])
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 228, in execute
    return self.await_(self._execute_async(operation, parameters))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 251, in _execute_async
    result = await self._cursor.execute(operation, parameters)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 132, in execute
    await self._run_operation(self._impl.execute, sql, *params)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 30, in _run_operation
    result = await self._conn._execute(func, *args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\concurrent\futures\thread.py", line 59, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
pyodbc.Error: ('07002', '[07002] [Microsoft][ODBC Driver 17 for SQL Server]COUNT field incorrect or syntax error (0) (SQLExecDirectW)')

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 295, in execute_insert
    result = await session.execute(text(query))
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 449, in execute
    result = await greenlet_spawn(
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 203, in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2351, in execute
    return self._execute_internal(
           ^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2258, in _execute_internal
    result = conn.execute(
             ^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1419, in execute
    return meth(
           ^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\sql\elements.py", line 526, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1641, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1846, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1986, in _exec_single_context
    self._handle_dbapi_exception(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 2355, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 230, in execute
    self._adapt_connection._handle_exception(error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 368, in _handle_exception
    raise error.with_traceback(exc_info[2])
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 228, in execute
    return self.await_(self._execute_async(operation, parameters))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 251, in _execute_async
    result = await self._cursor.execute(operation, parameters)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 132, in execute
    await self._run_operation(self._impl.execute, sql, *params)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 30, in _run_operation
    result = await self._conn._execute(func, *args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\concurrent\futures\thread.py", line 59, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
sqlalchemy.exc.DBAPIError: (pyodbc.Error) ('07002', '[07002] [Microsoft][ODBC Driver 17 for SQL Server]COUNT field incorrect or syntax error (0) (SQLExecDirectW)')
[SQL: 
INSERT INTO refresh_tokens (
    usuario_id, token_hash, expires_at, client_type, ip_address, user_agent, cliente_id
)
OUTPUT INSERTED.token_id, INSERTED.created_at, INSERTED.cliente_id
VALUES (?, ?, ?, ?, ?, ?, ?);
]
(Background on this error at: https://sqlalche.me/e/20/dbapi)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\connection_async.py", line 303, in get_db_connection
    yield session
  File "D:\base_multi_tenant_fastapi\app\core\tenant\routing.py", line 672, in get_connection_for_tenant
    yield session
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 311, in execute_insert
    raise DatabaseError(
app.core.exceptions.DatabaseError: Error en la inserción: (pyodbc.Error) ('07002', '[07002] [Microsoft][ODBC Driver 17 for SQL Server]COUNT field incorrect or syntax error (0) (SQLExecDirectW)')
[SQL: 
INSERT INTO refresh_tokens (
    usuario_id, token_hash, expires_at, client_type, ip_address, user_agent, cliente_id
)
OUTPUT INSERTED.token_id, INSERTED.created_at, INSERTED.cliente_id
VALUES (?, ?, ?, ?, ?, ?, ?);
]
(Background on this error at: https://sqlalche.me/e/20/dbapi)
2025-12-03 20:43:30,838 - app.core.application.base_service - ERROR - DatabaseError en store_refresh_token: Error en la inserción: (pyodbc.Error) ('07002', '[07002] [Microsoft][ODBC Driver 17 for SQL Server]COUNT field incorrect or syntax error (0) (SQLExecDirectW)')
[SQL: 
INSERT INTO refresh_tokens (
    usuario_id, token_hash, expires_at, client_type, ip_address, user_agent, cliente_id
)
OUTPUT INSERTED.token_id, INSERTED.created_at, INSERTED.cliente_id
VALUES (?, ?, ?, ?, ?, ?, ?);
]
(Background on this error at: https://sqlalche.me/e/20/dbapi)
Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 230, in execute
    self._adapt_connection._handle_exception(error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 368, in _handle_exception
    raise error.with_traceback(exc_info[2])
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 228, in execute
    return self.await_(self._execute_async(operation, parameters))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 251, in _execute_async
    result = await self._cursor.execute(operation, parameters)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 132, in execute
    await self._run_operation(self._impl.execute, sql, *params)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 30, in _run_operation
    result = await self._conn._execute(func, *args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\concurrent\futures\thread.py", line 59, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
pyodbc.Error: ('07002', '[07002] [Microsoft][ODBC Driver 17 for SQL Server]COUNT field incorrect or syntax error (0) (SQLExecDirectW)')

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 295, in execute_insert
    result = await session.execute(text(query))
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 449, in execute
    result = await greenlet_spawn(
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 203, in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2351, in execute
    return self._execute_internal(
           ^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2258, in _execute_internal
    result = conn.execute(
             ^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1419, in execute
    return meth(
           ^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\sql\elements.py", line 526, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1641, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1846, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1986, in _exec_single_context
    self._handle_dbapi_exception(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 2355, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 230, in execute
    self._adapt_connection._handle_exception(error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 368, in _handle_exception
    raise error.with_traceback(exc_info[2])
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 228, in execute
    return self.await_(self._execute_async(operation, parameters))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 251, in _execute_async
    result = await self._cursor.execute(operation, parameters)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 132, in execute
    await self._run_operation(self._impl.execute, sql, *params)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 30, in _run_operation
    result = await self._conn._execute(func, *args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\concurrent\futures\thread.py", line 59, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
sqlalchemy.exc.DBAPIError: (pyodbc.Error) ('07002', '[07002] [Microsoft][ODBC Driver 17 for SQL Server]COUNT field incorrect or syntax error (0) (SQLExecDirectW)')
[SQL: 
INSERT INTO refresh_tokens (
    usuario_id, token_hash, expires_at, client_type, ip_address, user_agent, cliente_id
)
OUTPUT INSERTED.token_id, INSERTED.created_at, INSERTED.cliente_id
VALUES (?, ?, ?, ?, ?, ?, ?);
]
(Background on this error at: https://sqlalche.me/e/20/dbapi)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\core\application\base_service.py", line 52, in wrapper
    return await func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\modules\auth\application\services\refresh_token_service.py", line 118, in store_refresh_token
    result = await execute_insert(INSERT_REFRESH_TOKEN, params)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 311, in execute_insert
    raise DatabaseError(
app.core.exceptions.DatabaseError: Error en la inserción: (pyodbc.Error) ('07002', '[07002] [Microsoft][ODBC Driver 17 for SQL Server]COUNT field incorrect or syntax error (0) (SQLExecDirectW)')
[SQL: 
INSERT INTO refresh_tokens (
    usuario_id, token_hash, expires_at, client_type, ip_address, user_agent, cliente_id
)
OUTPUT INSERTED.token_id, INSERTED.created_at, INSERTED.cliente_id
VALUES (?, ?, ?, ?, ?, ?, ?);
]
(Background on this error at: https://sqlalche.me/e/20/dbapi)
2025-12-03 20:43:30,845 - app.modules.auth.presentation.endpoints - ERROR - [LOGIN] Error almacenando refresh token: Error en la inserción: (pyodbc.Error) ('07002', '[07002] [Microsoft][ODBC Driver 17 for SQL Server]COUNT field incorrect or syntax error (0) (SQLExecDirectW)')
[SQL: 
INSERT INTO refresh_tokens (
    usuario_id, token_hash, expires_at, client_type, ip_address, user_agent, cliente_id
)
OUTPUT INSERTED.token_id, INSERTED.created_at, INSERTED.cliente_id
VALUES (?, ?, ?, ?, ?, ?, ?);
]
(Background on this error at: https://sqlalche.me/e/20/dbapi)
2025-12-03 20:43:30,845 - app.modules.auth.presentation.endpoints - INFO - Usuario superadmin autenticado exitosamente (WEB) para cliente bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 20:43:30,852 - app.modules.superadmin.application.services.audit_service - INFO - [AUDIT] auth_audit_log registrado: evento=login_success, cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, usuario_id=154134AD-A5EB-4F45-AEF0-5F9AAA282C8E, exito=True
2025-12-03 20:43:30,852 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/login/ 200 289.6ms
2025-12-03 20:43:30,862 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/clientes/tenant/branding
2025-12-03 20:43:30,862 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 20:43:30,862 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 20:43:30,862 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 20:43:30,862 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 20:43:30,865 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 20:43:30,865 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 20:43:30,865 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 20:43:30,865 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 20:43:30,865 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 20:43:30,865 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 20:43:30,865 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/clientes/tenant/branding
2025-12-03 20:43:30,888 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/menus/getmenu/
2025-12-03 20:43:30,888 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 20:43:30,888 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 20:43:30,888 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 20:43:30,888 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 20:43:30,888 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 20:43:30,888 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 20:43:30,888 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 20:43:30,888 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 20:43:30,888 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 20:43:30,888 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 20:43:30,888 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/menus/getmenu/
2025-12-03 20:43:30,950 - app.modules.tenant.presentation.endpoints_clientes - INFO - Solicitud GET /tenant/branding recibida para cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7 por usuario: superadmin
2025-12-03 20:43:30,950 - app.modules.tenant.application.services.cliente_service - INFO - Solicitando branding para cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 20:43:30,956 - app.modules.tenant.application.services.cliente_service - INFO - Branding obtenido exitosamente para cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 20:43:30,956 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/clientes/tenant/branding 200 93.4ms
2025-12-03 20:43:30,959 - app.modules.menus.presentation.endpoints - INFO - Solicitud GET /menus/getmenu/ recibida para usuario ID: 154134ad-a5eb-4f45-aef0-5f9aaa282c8e del cliente bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 20:43:30,959 - app.modules.menus.application.services.menu_service - INFO - Obteniendo menú filtrado para usuario_id: 154134ad-a5eb-4f45-aef0-5f9aaa282c8e
2025-12-03 20:43:31,029 - app.modules.menus.application.services.menu_service - INFO - No se encontraron menús permitidos para el usuario ID: 154134ad-a5eb-4f45-aef0-5f9aaa282c8e.
2025-12-03 20:43:31,029 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/menus/getmenu/ 200 143.4ms
2025-12-03 20:43:31,029 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/menus/getmenu/
2025-12-03 20:43:31,033 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 20:43:31,033 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 20:43:31,033 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 20:43:31,034 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 20:43:31,034 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 20:43:31,034 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 20:43:31,035 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 20:43:31,035 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 20:43:31,035 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 20:43:31,035 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 20:43:31,035 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/menus/getmenu/
2025-12-03 20:43:31,073 - app.modules.menus.presentation.endpoints - INFO - Solicitud GET /menus/getmenu/ recibida para usuario ID: 154134ad-a5eb-4f45-aef0-5f9aaa282c8e del cliente bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 20:43:31,075 - app.modules.menus.application.services.menu_service - INFO - Obteniendo menú filtrado para usuario_id: 154134ad-a5eb-4f45-aef0-5f9aaa282c8e
2025-12-03 20:43:31,075 - app.modules.menus.application.services.menu_service - INFO - No se encontraron menús permitidos para el usuario ID: 154134ad-a5eb-4f45-aef0-5f9aaa282c8e.
2025-12-03 20:43:31,078 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/menus/getmenu/ 200 45.9ms
2025-12-03 20:45:33,742 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Pool ADMIN inicializado. Size=10, MaxOverflow=5
2025-12-03 20:45:33,742 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Configuración de pools de tenants: MaxPools=50, PoolSize=3, MaxOverflow=2, InactivityTimeout=3600s
2025-12-03 20:45:33,742 - app.infrastructure.database.connection_pool - INFO - ✅ Módulo de connection pooling cargado y activo
2025-12-03 20:45:33,742 - app.infrastructure.database.connection_pool - INFO -    Configuración: MaxTenantPools=50, TenantPoolSize=3, InactivityTimeout=3600s
2025-12-03 20:45:33,742 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Todos los pools cerrados
2025-12-03 20:45:33,742 - app.main - INFO - ✅ Pools de conexión cerrados correctamente
2025-12-03 20:45:33,960 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Pool ADMIN inicializado. Size=10, MaxOverflow=5
2025-12-03 20:45:33,960 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Configuración de pools de tenants: MaxPools=50, PoolSize=3, MaxOverflow=2, InactivityTimeout=3600s
2025-12-03 20:45:33,960 - app.infrastructure.database.connection_pool - INFO - ✅ Módulo de connection pooling cargado y activo
2025-12-03 20:45:33,960 - app.infrastructure.database.connection_pool - INFO -    Configuración: MaxTenantPools=50, TenantPoolSize=3, InactivityTimeout=3600s
2025-12-03 20:45:33,960 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Todos los pools cerrados
2025-12-03 20:45:33,960 - app.main - INFO - ✅ Pools de conexión cerrados correctamente
2025-12-03 20:45:34,624 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 20:45:34,815 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 20:45:34,824 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 20:45:34,826 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 20:45:34,826 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 20:45:34,827 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 20:45:34,827 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 20:45:34,827 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, DEFAULT_TYPE=single
2025-12-03 20:45:34,970 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 20:45:35,190 - app.core.security.rate_limiting - INFO - [RATE_LIMITING] Activado. Límites: Login=10/minute, API=200/minute
2025-12-03 20:45:35,190 - app.core.security.rate_limiting - INFO - ✅ Módulo de rate limiting cargado y activo
2025-12-03 20:45:35,205 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 20:45:35,210 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 20:45:35,212 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 20:45:35,212 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 20:45:35,215 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 20:45:35,215 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 20:45:35,215 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, DEFAULT_TYPE=single
2025-12-03 20:45:35,265 - app.core.authorization.rbac - INFO - 🔐 Inicializando sistema de autorización...
2025-12-03 20:45:35,265 - app.core.authorization.rbac - INFO - ✅ Sistema de autorización inicializado correctamente
2025-12-03 20:45:35,265 - app.core.authorization.rbac - INFO - 📊 Permisos del sistema: 6 módulos configurados
2025-12-03 20:45:35,436 - app.core.tenant.middleware - INFO - Módulo tenant_middleware cargado (versión híbrida con soporte para proxies)
2025-12-03 20:45:35,437 - app.main - INFO - ✅ Rate limiting configurado y activo
2025-12-03 20:45:35,593 - app.core.tenant.middleware - INFO - [TENANT_MW] Inicializado - BASE_DOMAIN=app.local, SYSTEM_ID=BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, EXCLUDED_SUBDOMAINS={'backend', 'assets', 'www', 'admin', 'api', 'cdn', 'static'}
2025-12-03 20:45:35,648 - app.core.security.rate_limiting - INFO - [RATE_LIMITING] Activado. Límites: Login=10/minute, API=200/minute
2025-12-03 20:45:35,648 - app.core.security.rate_limiting - INFO - ✅ Módulo de rate limiting cargado y activo
2025-12-03 20:45:35,750 - app.core.authorization.rbac - INFO - 🔐 Inicializando sistema de autorización...
2025-12-03 20:45:35,750 - app.core.authorization.rbac - INFO - ✅ Sistema de autorización inicializado correctamente
2025-12-03 20:45:35,750 - app.core.authorization.rbac - INFO - 📊 Permisos del sistema: 6 módulos configurados
2025-12-03 20:45:35,990 - app.core.tenant.middleware - INFO - Módulo tenant_middleware cargado (versión híbrida con soporte para proxies)
2025-12-03 20:45:36,000 - app.main - INFO - ✅ Rate limiting configurado y activo
2025-12-03 20:45:36,160 - app.core.tenant.middleware - INFO - [TENANT_MW] Inicializado - BASE_DOMAIN=app.local, SYSTEM_ID=BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, EXCLUDED_SUBDOMAINS={'assets', 'admin', 'static', 'api', 'cdn', 'backend', 'www'}
2025-12-03 20:46:47,740 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Pool ADMIN inicializado. Size=10, MaxOverflow=5
2025-12-03 20:46:47,740 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Configuración de pools de tenants: MaxPools=50, PoolSize=3, MaxOverflow=2, InactivityTimeout=3600s
2025-12-03 20:46:47,740 - app.infrastructure.database.connection_pool - INFO - ✅ Módulo de connection pooling cargado y activo
2025-12-03 20:46:47,740 - app.infrastructure.database.connection_pool - INFO -    Configuración: MaxTenantPools=50, TenantPoolSize=3, InactivityTimeout=3600s
2025-12-03 20:46:47,741 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Todos los pools cerrados
2025-12-03 20:46:47,741 - app.main - INFO - ✅ Pools de conexión cerrados correctamente
2025-12-03 20:46:48,603 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 20:46:48,819 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 20:46:48,826 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 20:46:48,832 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 20:46:48,832 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 20:46:48,834 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 20:46:48,834 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 20:46:48,834 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, DEFAULT_TYPE=single
2025-12-03 20:46:49,169 - app.core.security.rate_limiting - INFO - [RATE_LIMITING] Activado. Límites: Login=10/minute, API=200/minute
2025-12-03 20:46:49,170 - app.core.security.rate_limiting - INFO - ✅ Módulo de rate limiting cargado y activo
2025-12-03 20:46:49,241 - app.core.authorization.rbac - INFO - 🔐 Inicializando sistema de autorización...
2025-12-03 20:46:49,241 - app.core.authorization.rbac - INFO - ✅ Sistema de autorización inicializado correctamente
2025-12-03 20:46:49,241 - app.core.authorization.rbac - INFO - 📊 Permisos del sistema: 6 módulos configurados
2025-12-03 20:46:49,402 - app.core.tenant.middleware - INFO - Módulo tenant_middleware cargado (versión híbrida con soporte para proxies)
2025-12-03 20:46:49,402 - app.main - INFO - ✅ Rate limiting configurado y activo
2025-12-03 20:46:49,545 - app.core.tenant.middleware - INFO - [TENANT_MW] Inicializado - BASE_DOMAIN=app.local, SYSTEM_ID=BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, EXCLUDED_SUBDOMAINS={'admin', 'static', 'cdn', 'api', 'assets', 'backend', 'www'}
2025-12-03 20:46:51,626 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/refresh/
2025-12-03 20:46:51,626 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 20:46:51,626 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 20:46:51,628 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 20:46:51,628 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 20:46:51,628 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 20:46:51,628 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 20:46:51,628 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 20:46:51,628 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 20:46:51,628 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 20:46:51,628 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 20:46:51,628 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/auth/refresh/
2025-12-03 20:46:51,631 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] AsyncEngine creado para admin
2025-12-03 20:46:51,775 - app.modules.auth.application.services.refresh_token_service - WARNING - [VALIDATE-TOKEN] Token no encontrado, revocado o expirado - Cliente bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 20:46:51,775 - app.modules.auth.application.services.auth_service - WARNING - [REFRESH] Token JWT válido, pero inactivo/revocado en BD. Usuario: superadmin
2025-12-03 20:46:51,788 - app.modules.superadmin.application.services.audit_service - INFO - [AUDIT] auth_audit_log registrado: evento=token_invalid_or_revoked, cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, usuario_id=None, exito=False
2025-12-03 20:46:51,790 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/refresh/ 401 162.6ms
2025-12-03 20:46:56,396 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Pool ADMIN inicializado. Size=10, MaxOverflow=5
2025-12-03 20:46:56,396 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Configuración de pools de tenants: MaxPools=50, PoolSize=3, MaxOverflow=2, InactivityTimeout=3600s
2025-12-03 20:46:56,396 - app.infrastructure.database.connection_pool - INFO - ✅ Módulo de connection pooling cargado y activo
2025-12-03 20:46:56,396 - app.infrastructure.database.connection_pool - INFO -    Configuración: MaxTenantPools=50, TenantPoolSize=3, InactivityTimeout=3600s
2025-12-03 20:46:56,397 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Todos los pools cerrados
2025-12-03 20:46:56,397 - app.main - INFO - ✅ Pools de conexión cerrados correctamente
2025-12-03 20:46:58,206 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 20:46:58,395 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 20:46:58,396 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 20:46:58,403 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 20:46:58,403 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 20:46:58,404 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 20:46:58,404 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 20:46:58,404 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, DEFAULT_TYPE=single
2025-12-03 20:46:58,722 - app.core.security.rate_limiting - INFO - [RATE_LIMITING] Activado. Límites: Login=10/minute, API=200/minute
2025-12-03 20:46:58,722 - app.core.security.rate_limiting - INFO - ✅ Módulo de rate limiting cargado y activo
2025-12-03 20:46:58,793 - app.core.authorization.rbac - INFO - 🔐 Inicializando sistema de autorización...
2025-12-03 20:46:58,793 - app.core.authorization.rbac - INFO - ✅ Sistema de autorización inicializado correctamente
2025-12-03 20:46:58,793 - app.core.authorization.rbac - INFO - 📊 Permisos del sistema: 6 módulos configurados
2025-12-03 20:46:58,962 - app.core.tenant.middleware - INFO - Módulo tenant_middleware cargado (versión híbrida con soporte para proxies)
2025-12-03 20:46:58,962 - app.main - INFO - ✅ Rate limiting configurado y activo
2025-12-03 20:46:59,113 - app.core.tenant.middleware - INFO - [TENANT_MW] Inicializado - BASE_DOMAIN=app.local, SYSTEM_ID=BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, EXCLUDED_SUBDOMAINS={'backend', 'assets', 'admin', 'cdn', 'api', 'static', 'www'}
2025-12-03 20:47:17,547 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/login/
2025-12-03 20:47:17,547 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 20:47:17,547 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 20:47:17,548 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 20:47:17,548 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 20:47:17,548 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 20:47:17,548 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 20:47:17,549 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 20:47:17,549 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 20:47:17,549 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 20:47:17,549 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 20:47:17,549 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/auth/login/
2025-12-03 20:47:17,553 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] AsyncEngine creado para admin
2025-12-03 20:47:17,632 - app.modules.auth.presentation.endpoints - INFO - Cliente bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7 resuelto y validado para login.
2025-12-03 20:47:17,633 - app.modules.auth.application.services.auth_service - INFO - [AUTH] Intento de login: username='superadmin', cliente_id_destino=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 20:47:17,633 - app.modules.auth.application.services.auth_service - INFO - [AUTH] SUPERADMIN detectado. Buscando en BD ADMIN (cliente_id=BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7), accediendo a cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 20:47:17,882 - app.modules.auth.application.services.auth_service - INFO - Niveles calculados - Usuario 154134AD-A5EB-4F45-AEF0-5F9AAA282C8E: level=5, super_admin=True, type=super_admin
2025-12-03 20:47:17,885 - app.modules.auth.application.services.auth_service - INFO - [AUTH] Login exitoso: username='superadmin', usuario_id=154134AD-A5EB-4F45-AEF0-5F9AAA282C8E, cliente_origen=BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, cliente_destino=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, access_level=5, user_type=super_admin
2025-12-03 20:47:17,885 - app.modules.auth.presentation.endpoints - INFO - [LOGIN] Superadmin accediendo a cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 20:47:17,885 - app.modules.auth.application.services.auth_service - INFO - Niveles calculados - Usuario 154134AD-A5EB-4F45-AEF0-5F9AAA282C8E: level=5, super_admin=True, type=super_admin
2025-12-03 20:47:17,894 - app.modules.auth.application.services.refresh_token_service - ERROR - [STORE-TOKEN] Error inesperado almacenando refresh token - Cliente bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, Usuario 154134AD-A5EB-4F45-AEF0-5F9AAA282C8E: name 'DatabaseConnection' is not defined
Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\modules\auth\application\services\refresh_token_service.py", line 121, in store_refresh_token
    connection_type=DatabaseConnection.DEFAULT,
                    ^^^^^^^^^^^^^^^^^^
NameError: name 'DatabaseConnection' is not defined
2025-12-03 20:47:17,899 - app.core.application.base_service - ERROR - DatabaseError en store_refresh_token: Error no manejado al almacenar el refresh token
Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\modules\auth\application\services\refresh_token_service.py", line 121, in store_refresh_token
    connection_type=DatabaseConnection.DEFAULT,
                    ^^^^^^^^^^^^^^^^^^
NameError: name 'DatabaseConnection' is not defined

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\core\application\base_service.py", line 52, in wrapper
    return await func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\modules\auth\application\services\refresh_token_service.py", line 203, in store_refresh_token
    raise DatabaseError(
app.core.exceptions.DatabaseError: Error no manejado al almacenar el refresh token
2025-12-03 20:47:17,905 - app.modules.auth.presentation.endpoints - ERROR - [LOGIN] Error almacenando refresh token: Error no manejado al almacenar el refresh token
2025-12-03 20:47:17,905 - app.modules.auth.presentation.endpoints - INFO - Usuario superadmin autenticado exitosamente (WEB) para cliente bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 20:47:17,912 - app.modules.superadmin.application.services.audit_service - INFO - [AUDIT] auth_audit_log registrado: evento=login_success, cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, usuario_id=154134AD-A5EB-4F45-AEF0-5F9AAA282C8E, exito=True
2025-12-03 20:47:17,914 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/login/ 200 366.9ms
2025-12-03 20:47:17,922 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/clientes/tenant/branding
2025-12-03 20:47:17,922 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 20:47:17,922 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 20:47:17,922 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 20:47:17,922 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 20:47:17,924 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 20:47:17,924 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 20:47:17,924 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 20:47:17,924 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 20:47:17,924 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 20:47:17,924 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 20:47:17,924 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/clientes/tenant/branding
2025-12-03 20:47:17,940 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/menus/getmenu/
2025-12-03 20:47:17,941 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 20:47:17,941 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 20:47:17,941 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 20:47:17,941 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 20:47:17,941 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 20:47:17,941 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 20:47:17,941 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 20:47:17,942 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 20:47:17,942 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 20:47:17,942 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 20:47:17,942 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/menus/getmenu/
2025-12-03 20:47:17,974 - app.modules.tenant.presentation.endpoints_clientes - INFO - Solicitud GET /tenant/branding recibida para cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7 por usuario: superadmin
2025-12-03 20:47:17,974 - app.modules.tenant.application.services.cliente_service - INFO - Solicitando branding para cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 20:47:17,977 - app.modules.menus.presentation.endpoints - INFO - Solicitud GET /menus/getmenu/ recibida para usuario ID: 154134ad-a5eb-4f45-aef0-5f9aaa282c8e del cliente bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 20:47:17,977 - app.modules.menus.application.services.menu_service - INFO - Obteniendo menú filtrado para usuario_id: 154134ad-a5eb-4f45-aef0-5f9aaa282c8e
2025-12-03 20:47:17,980 - app.modules.tenant.application.services.cliente_service - INFO - Branding obtenido exitosamente para cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 20:47:17,980 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/clientes/tenant/branding 200 58.1ms
2025-12-03 20:47:18,033 - app.modules.menus.application.services.menu_service - INFO - No se encontraron menús permitidos para el usuario ID: 154134ad-a5eb-4f45-aef0-5f9aaa282c8e.
2025-12-03 20:47:18,034 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/menus/getmenu/ 200 93.4ms
2025-12-03 20:47:18,036 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/menus/getmenu/
2025-12-03 20:47:18,036 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 20:47:18,036 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 20:47:18,036 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 20:47:18,036 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 20:47:18,036 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 20:47:18,036 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 20:47:18,036 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 20:47:18,036 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 20:47:18,036 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 20:47:18,036 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 20:47:18,036 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/menus/getmenu/
2025-12-03 20:47:18,052 - app.modules.menus.presentation.endpoints - INFO - Solicitud GET /menus/getmenu/ recibida para usuario ID: 154134ad-a5eb-4f45-aef0-5f9aaa282c8e del cliente bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 20:47:18,052 - app.modules.menus.application.services.menu_service - INFO - Obteniendo menú filtrado para usuario_id: 154134ad-a5eb-4f45-aef0-5f9aaa282c8e
2025-12-03 20:47:18,057 - app.modules.menus.application.services.menu_service - INFO - No se encontraron menús permitidos para el usuario ID: 154134ad-a5eb-4f45-aef0-5f9aaa282c8e.
2025-12-03 20:47:18,057 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/menus/getmenu/ 200 22.5ms
2025-12-03 20:47:39,476 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/clientes/
2025-12-03 20:47:39,477 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/clientes/ 200 1.5ms
2025-12-03 20:47:39,477 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/clientes/
2025-12-03 20:47:39,478 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/clientes/ 200 1.0ms
2025-12-03 20:47:39,480 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/clientes/
2025-12-03 20:47:39,480 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 20:47:39,481 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 20:47:39,481 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 20:47:39,481 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 20:47:39,481 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 20:47:39,481 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 20:47:39,481 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 20:47:39,482 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 20:47:39,482 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 20:47:39,482 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 20:47:39,482 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/clientes/
2025-12-03 20:47:39,503 - app.modules.tenant.presentation.endpoints_clientes - INFO - Solicitud GET /clientes/ recibida - skip: 0, limit: 10, solo_activos: True, buscar: None por usuario: superadmin
2025-12-03 20:47:39,503 - app.modules.tenant.application.services.cliente_service - INFO - Listando clientes - skip: 0, limit: 10, solo_activos: True, buscar: None
2025-12-03 20:47:39,514 - app.modules.tenant.application.services.cliente_service - INFO - Listados 5 clientes de 5 totales
2025-12-03 20:47:39,514 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/clientes/ 200 34.0ms
2025-12-03 20:47:39,515 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/clientes/
2025-12-03 20:47:39,516 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 20:47:39,516 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 20:47:39,516 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 20:47:39,516 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 20:47:39,516 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 20:47:39,518 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 20:47:39,518 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 20:47:39,518 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 20:47:39,518 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 20:47:39,518 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 20:47:39,518 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/clientes/
2025-12-03 20:47:39,534 - app.modules.tenant.presentation.endpoints_clientes - INFO - Solicitud GET /clientes/ recibida - skip: 0, limit: 10, solo_activos: True, buscar: None por usuario: superadmin
2025-12-03 20:47:39,534 - app.modules.tenant.application.services.cliente_service - INFO - Listando clientes - skip: 0, limit: 10, solo_activos: True, buscar: None
2025-12-03 20:47:39,541 - app.modules.tenant.application.services.cliente_service - INFO - Listados 5 clientes de 5 totales
2025-12-03 20:47:39,542 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/clientes/ 200 25.2ms
2025-12-03 20:47:42,576 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/modulos/
2025-12-03 20:47:42,577 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/modulos/ 200 0.8ms
2025-12-03 20:47:42,577 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/modulos/
2025-12-03 20:47:42,578 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/modulos/ 200 0.9ms
2025-12-03 20:47:42,580 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/modulos/
2025-12-03 20:47:42,580 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 20:47:42,581 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 20:47:42,581 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 20:47:42,581 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 20:47:42,581 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 20:47:42,581 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 20:47:42,581 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 20:47:42,581 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 20:47:42,581 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 20:47:42,581 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 20:47:42,582 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/modulos/
2025-12-03 20:47:42,592 - app.modules.tenant.presentation.endpoints_modulos - INFO - Solicitud GET /modulos/ recibida - skip: 0, limit: 20, solo_activos: True
2025-12-03 20:47:42,592 - app.modules.tenant.application.services.modulo_service - INFO - Obteniendo catálogo de módulos - skip: 0, limit: 20
2025-12-03 20:47:42,605 - app.modules.tenant.application.services.modulo_service - INFO - Contando total de módulos en el sistema
2025-12-03 20:47:42,610 - app.modules.tenant.presentation.endpoints_modulos - INFO - Catálogo de módulos recuperado: 4 módulos de 4 totales
2025-12-03 20:47:42,610 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/modulos/ 200 30.6ms
2025-12-03 20:47:42,612 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/modulos/
2025-12-03 20:47:42,612 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 20:47:42,612 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 20:47:42,612 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 20:47:42,612 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 20:47:42,612 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 20:47:42,612 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 20:47:42,612 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 20:47:42,612 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 20:47:42,612 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 20:47:42,612 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 20:47:42,612 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/modulos/
2025-12-03 20:47:42,629 - app.modules.tenant.presentation.endpoints_modulos - INFO - Solicitud GET /modulos/ recibida - skip: 0, limit: 20, solo_activos: True
2025-12-03 20:47:42,629 - app.modules.tenant.application.services.modulo_service - INFO - Obteniendo catálogo de módulos - skip: 0, limit: 20
2025-12-03 20:47:42,631 - app.modules.tenant.application.services.modulo_service - INFO - Contando total de módulos en el sistema
2025-12-03 20:47:42,634 - app.modules.tenant.presentation.endpoints_modulos - INFO - Catálogo de módulos recuperado: 4 módulos de 4 totales
2025-12-03 20:47:42,634 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/modulos/ 200 23.1ms
2025-12-03 20:47:46,873 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/clientes/
2025-12-03 20:47:46,873 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 20:47:46,874 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 20:47:46,874 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 20:47:46,874 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 20:47:46,874 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 20:47:46,874 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 20:47:46,874 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 20:47:46,875 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 20:47:46,875 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 20:47:46,875 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 20:47:46,875 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/clientes/
2025-12-03 20:47:46,893 - app.modules.tenant.presentation.endpoints_clientes - INFO - Solicitud GET /clientes/ recibida - skip: 0, limit: 10, solo_activos: True, buscar: None por usuario: superadmin
2025-12-03 20:47:46,894 - app.modules.tenant.application.services.cliente_service - INFO - Listando clientes - skip: 0, limit: 10, solo_activos: True, buscar: None
2025-12-03 20:47:46,899 - app.modules.tenant.application.services.cliente_service - INFO - Listados 5 clientes de 5 totales
2025-12-03 20:47:46,899 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/clientes/ 200 28.3ms
2025-12-03 20:47:46,903 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/clientes/
2025-12-03 20:47:46,903 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 20:47:46,904 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 20:47:46,904 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 20:47:46,904 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 20:47:46,904 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 20:47:46,904 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 20:47:46,904 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 20:47:46,904 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 20:47:46,904 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 20:47:46,904 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 20:47:46,904 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/clientes/
2025-12-03 20:47:46,923 - app.modules.tenant.presentation.endpoints_clientes - INFO - Solicitud GET /clientes/ recibida - skip: 0, limit: 10, solo_activos: True, buscar: None por usuario: superadmin
2025-12-03 20:47:46,923 - app.modules.tenant.application.services.cliente_service - INFO - Listando clientes - skip: 0, limit: 10, solo_activos: True, buscar: None
2025-12-03 20:47:46,929 - app.modules.tenant.application.services.cliente_service - INFO - Listados 5 clientes de 5 totales
2025-12-03 20:47:46,930 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/clientes/ 200 27.3ms
2025-12-03 20:47:48,084 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/clientes/NaN/
2025-12-03 20:47:48,085 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/clientes/NaN/ 200 1.0ms
2025-12-03 20:47:48,085 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/clientes/NaN/estadisticas/
2025-12-03 20:47:48,086 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/clientes/NaN/
2025-12-03 20:47:48,086 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/clientes/NaN/estadisticas/
2025-12-03 20:47:48,087 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/clientes/NaN/estadisticas/ 200 1.7ms
2025-12-03 20:47:48,088 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/clientes/NaN/ 200 1.6ms
2025-12-03 20:47:48,088 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/clientes/NaN/estadisticas/ 200 1.6ms
2025-12-03 20:47:48,088 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/clientes/NaN/
2025-12-03 20:47:48,090 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 20:47:48,091 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 20:47:48,091 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 20:47:48,091 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 20:47:48,092 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 20:47:48,092 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 20:47:48,092 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 20:47:48,092 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 20:47:48,092 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 20:47:48,092 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 20:47:48,092 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/clientes/NaN/
2025-12-03 20:47:48,096 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/clientes/NaN/estadisticas/
2025-12-03 20:47:48,097 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 20:47:48,097 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 20:47:48,098 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 20:47:48,098 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 20:47:48,098 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 20:47:48,098 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 20:47:48,098 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 20:47:48,098 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 20:47:48,099 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 20:47:48,099 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 20:47:48,099 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/clientes/NaN/estadisticas/
2025-12-03 20:47:48,133 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/clientes/NaN/estadisticas/ 422 37.3ms
2025-12-03 20:47:48,135 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/clientes/NaN/ 422 46.7ms
2025-12-03 20:47:48,136 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/clientes/NaN/estadisticas/
2025-12-03 20:47:48,136 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 20:47:48,136 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 20:47:48,136 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 20:47:48,138 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 20:47:48,138 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 20:47:48,138 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 20:47:48,138 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 20:47:48,138 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 20:47:48,138 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 20:47:48,138 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 20:47:48,139 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/clientes/NaN/estadisticas/
2025-12-03 20:47:48,140 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/clientes/NaN/
2025-12-03 20:47:48,140 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 20:47:48,140 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 20:47:48,140 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 20:47:48,140 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 20:47:48,141 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 20:47:48,141 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 20:47:48,141 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 20:47:48,141 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 20:47:48,141 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 20:47:48,141 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 20:47:48,141 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/clientes/NaN/
2025-12-03 20:47:48,169 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/clientes/NaN/ 422 29.5ms
2025-12-03 20:47:48,171 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/clientes/NaN/estadisticas/ 422 34.7ms
2025-12-03 20:47:53,378 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/refresh/
2025-12-03 20:47:53,379 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 20:47:53,379 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 20:47:53,379 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 20:47:53,379 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 20:47:53,379 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 20:47:53,379 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 20:47:53,379 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 20:47:53,379 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 20:47:53,379 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 20:47:53,379 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 20:47:53,379 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/auth/refresh/
2025-12-03 20:47:53,391 - app.modules.auth.application.services.refresh_token_service - WARNING - [VALIDATE-TOKEN] Token no encontrado, revocado o expirado - Cliente bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 20:47:53,391 - app.modules.auth.application.services.auth_service - WARNING - [REFRESH] Token JWT válido, pero inactivo/revocado en BD. Usuario: superadmin
2025-12-03 20:47:53,396 - app.modules.superadmin.application.services.audit_service - INFO - [AUDIT] auth_audit_log registrado: evento=token_invalid_or_revoked, cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, usuario_id=None, exito=False
2025-12-03 20:47:53,396 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/refresh/ 401 20.3ms
2025-12-03 20:48:59,418 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Pool ADMIN inicializado. Size=10, MaxOverflow=5
2025-12-03 20:48:59,418 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Configuración de pools de tenants: MaxPools=50, PoolSize=3, MaxOverflow=2, InactivityTimeout=3600s
2025-12-03 20:48:59,418 - app.infrastructure.database.connection_pool - INFO - ✅ Módulo de connection pooling cargado y activo
2025-12-03 20:48:59,418 - app.infrastructure.database.connection_pool - INFO -    Configuración: MaxTenantPools=50, TenantPoolSize=3, InactivityTimeout=3600s
2025-12-03 20:48:59,419 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Todos los pools cerrados
2025-12-03 20:48:59,419 - app.main - INFO - ✅ Pools de conexión cerrados correctamente
2025-12-03 20:49:00,264 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 20:49:00,472 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 20:49:00,473 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 20:49:00,481 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 20:49:00,481 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 20:49:00,482 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 20:49:00,482 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 20:49:00,482 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, DEFAULT_TYPE=single
2025-12-03 20:49:00,822 - app.core.security.rate_limiting - INFO - [RATE_LIMITING] Activado. Límites: Login=10/minute, API=200/minute
2025-12-03 20:49:00,822 - app.core.security.rate_limiting - INFO - ✅ Módulo de rate limiting cargado y activo
2025-12-03 20:49:00,893 - app.core.authorization.rbac - INFO - 🔐 Inicializando sistema de autorización...
2025-12-03 20:49:00,893 - app.core.authorization.rbac - INFO - ✅ Sistema de autorización inicializado correctamente
2025-12-03 20:49:00,893 - app.core.authorization.rbac - INFO - 📊 Permisos del sistema: 6 módulos configurados
2025-12-03 20:49:01,060 - app.core.tenant.middleware - INFO - Módulo tenant_middleware cargado (versión híbrida con soporte para proxies)
2025-12-03 20:49:01,061 - app.main - INFO - ✅ Rate limiting configurado y activo
2025-12-03 20:49:01,206 - app.core.tenant.middleware - INFO - [TENANT_MW] Inicializado - BASE_DOMAIN=app.local, SYSTEM_ID=BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, EXCLUDED_SUBDOMAINS={'api', 'admin', 'static', 'www', 'cdn', 'assets', 'backend'}
2025-12-03 20:49:04,400 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/refresh/
2025-12-03 20:49:04,400 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 20:49:04,400 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 20:49:04,400 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 20:49:04,400 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 20:49:04,400 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 20:49:04,400 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 20:49:04,400 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 20:49:04,400 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 20:49:04,400 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 20:49:04,403 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 20:49:04,403 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/auth/refresh/
2025-12-03 20:49:04,411 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] AsyncEngine creado para admin
2025-12-03 20:49:04,524 - app.modules.auth.application.services.refresh_token_service - WARNING - [VALIDATE-TOKEN] Token no encontrado, revocado o expirado - Cliente bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 20:49:04,524 - app.modules.auth.application.services.auth_service - WARNING - [REFRESH] Token JWT válido, pero inactivo/revocado en BD. Usuario: superadmin
2025-12-03 20:49:04,537 - app.modules.superadmin.application.services.audit_service - INFO - [AUDIT] auth_audit_log registrado: evento=token_invalid_or_revoked, cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, usuario_id=None, exito=False
2025-12-03 20:49:04,537 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/refresh/ 401 136.7ms
2025-12-03 20:49:20,050 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/login/
2025-12-03 20:49:20,051 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 20:49:20,051 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 20:49:20,052 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 20:49:20,052 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 20:49:20,052 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 20:49:20,052 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 20:49:20,052 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 20:49:20,052 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 20:49:20,053 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 20:49:20,053 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 20:49:20,053 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/auth/login/
2025-12-03 20:49:20,064 - app.modules.auth.presentation.endpoints - INFO - Cliente bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7 resuelto y validado para login.
2025-12-03 20:49:20,064 - app.modules.auth.application.services.auth_service - INFO - [AUTH] Intento de login: username='superadmin', cliente_id_destino=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 20:49:20,064 - app.modules.auth.application.services.auth_service - INFO - [AUTH] SUPERADMIN detectado. Buscando en BD ADMIN (cliente_id=BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7), accediendo a cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 20:49:20,316 - app.modules.auth.application.services.auth_service - INFO - Niveles calculados - Usuario 154134AD-A5EB-4F45-AEF0-5F9AAA282C8E: level=5, super_admin=True, type=super_admin
2025-12-03 20:49:20,316 - app.modules.auth.application.services.auth_service - INFO - [AUTH] Login exitoso: username='superadmin', usuario_id=154134AD-A5EB-4F45-AEF0-5F9AAA282C8E, cliente_origen=BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, cliente_destino=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, access_level=5, user_type=super_admin
2025-12-03 20:49:20,316 - app.modules.auth.presentation.endpoints - INFO - [LOGIN] Superadmin accediendo a cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 20:49:20,316 - app.modules.auth.application.services.auth_service - INFO - Niveles calculados - Usuario 154134AD-A5EB-4F45-AEF0-5F9AAA282C8E: level=5, super_admin=True, type=super_admin
2025-12-03 20:49:20,330 - app.modules.auth.application.services.refresh_token_service - INFO - [STORE-TOKEN] Token insertado exitosamente - Cliente bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, Usuario 154134AD-A5EB-4F45-AEF0-5F9AAA282C8E, Tipo: web, Token ID: EA11EDC5-2D02-471E-8EFF-0711EE67496D, Rotación: False
2025-12-03 20:49:20,330 - app.modules.auth.presentation.endpoints - ERROR - [LOGIN] Error almacenando refresh token: '>' not supported between instances of 'str' and 'int'
2025-12-03 20:49:20,330 - app.modules.auth.presentation.endpoints - INFO - Usuario superadmin autenticado exitosamente (WEB) para cliente bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 20:49:20,336 - app.modules.superadmin.application.services.audit_service - INFO - [AUDIT] auth_audit_log registrado: evento=login_success, cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, usuario_id=154134AD-A5EB-4F45-AEF0-5F9AAA282C8E, exito=True
2025-12-03 20:49:20,337 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/login/ 200 286.5ms
2025-12-03 20:49:20,345 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/clientes/tenant/branding
2025-12-03 20:49:20,345 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 20:49:20,346 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 20:49:20,346 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 20:49:20,346 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 20:49:20,346 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 20:49:20,346 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 20:49:20,346 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 20:49:20,346 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 20:49:20,347 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 20:49:20,347 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 20:49:20,347 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/clientes/tenant/branding
2025-12-03 20:49:20,362 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/menus/getmenu/
2025-12-03 20:49:20,363 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 20:49:20,363 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 20:49:20,364 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 20:49:20,364 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 20:49:20,364 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 20:49:20,364 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 20:49:20,364 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 20:49:20,364 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 20:49:20,364 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 20:49:20,364 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 20:49:20,364 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/menus/getmenu/
2025-12-03 20:49:20,398 - app.modules.tenant.presentation.endpoints_clientes - INFO - Solicitud GET /tenant/branding recibida para cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7 por usuario: superadmin
2025-12-03 20:49:20,398 - app.modules.tenant.application.services.cliente_service - INFO - Solicitando branding para cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 20:49:20,404 - app.modules.tenant.application.services.cliente_service - INFO - Branding obtenido exitosamente para cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 20:49:20,404 - app.modules.menus.presentation.endpoints - INFO - Solicitud GET /menus/getmenu/ recibida para usuario ID: 154134ad-a5eb-4f45-aef0-5f9aaa282c8e del cliente bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 20:49:20,404 - app.modules.menus.application.services.menu_service - INFO - Obteniendo menú filtrado para usuario_id: 154134ad-a5eb-4f45-aef0-5f9aaa282c8e
2025-12-03 20:49:20,406 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/clientes/tenant/branding 200 60.5ms
2025-12-03 20:49:20,456 - app.modules.menus.application.services.menu_service - INFO - No se encontraron menús permitidos para el usuario ID: 154134ad-a5eb-4f45-aef0-5f9aaa282c8e.
2025-12-03 20:49:20,458 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/menus/getmenu/ 200 95.5ms
2025-12-03 20:49:20,459 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/menus/getmenu/
2025-12-03 20:49:20,459 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 20:49:20,459 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 20:49:20,459 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 20:49:20,459 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 20:49:20,459 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 20:49:20,459 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 20:49:20,459 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 20:49:20,459 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 20:49:20,459 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 20:49:20,463 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 20:49:20,463 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/menus/getmenu/
2025-12-03 20:49:20,476 - app.modules.menus.presentation.endpoints - INFO - Solicitud GET /menus/getmenu/ recibida para usuario ID: 154134ad-a5eb-4f45-aef0-5f9aaa282c8e del cliente bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 20:49:20,477 - app.modules.menus.application.services.menu_service - INFO - Obteniendo menú filtrado para usuario_id: 154134ad-a5eb-4f45-aef0-5f9aaa282c8e
2025-12-03 20:49:20,480 - app.modules.menus.application.services.menu_service - INFO - No se encontraron menús permitidos para el usuario ID: 154134ad-a5eb-4f45-aef0-5f9aaa282c8e.
2025-12-03 20:49:20,480 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/menus/getmenu/ 200 19.7ms
2025-12-03 20:49:56,566 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/refresh/
2025-12-03 20:49:56,567 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 20:49:56,567 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 20:49:56,567 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 20:49:56,567 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 20:49:56,567 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 20:49:56,567 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 20:49:56,567 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 20:49:56,568 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 20:49:56,568 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 20:49:56,568 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 20:49:56,568 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/auth/refresh/
2025-12-03 20:49:56,584 - app.modules.auth.application.services.refresh_token_service - INFO - [VALIDATE-TOKEN] Token válido - Cliente BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, Usuario 154134AD-A5EB-4F45-AEF0-5F9AAA282C8E, Tipo: web
2025-12-03 20:49:56,589 - app.infrastructure.database.queries_async - ERROR - Error en execute_auth_query async (string): (pyodbc.Error) ('07002', '[07002] [Microsoft][ODBC Driver 17 for SQL Server]COUNT field incorrect or syntax error (0) (SQLExecDirectW)')
[SQL: 
            SELECT usuario_id, cliente_id, nombre_usuario, correo, nombre, apellido, es_activo
            FROM usuario
            WHERE nombre_usuario = ? AND es_eliminado = 0
            ]
(Background on this error at: https://sqlalche.me/e/20/dbapi)
2025-12-03 20:49:56,590 - app.infrastructure.database.connection_async - ERROR - [ASYNC_CONNECTION] Error en sesión async: Error en la autenticación: (pyodbc.Error) ('07002', '[07002] [Microsoft][ODBC Driver 17 for SQL Server]COUNT field incorrect or syntax error (0) (SQLExecDirectW)')
[SQL: 
            SELECT usuario_id, cliente_id, nombre_usuario, correo, nombre, apellido, es_activo
            FROM usuario
            WHERE nombre_usuario = ? AND es_eliminado = 0
            ]
(Background on this error at: https://sqlalche.me/e/20/dbapi)
Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 230, in execute
    self._adapt_connection._handle_exception(error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 368, in _handle_exception
    raise error.with_traceback(exc_info[2])
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 228, in execute
    return self.await_(self._execute_async(operation, parameters))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 251, in _execute_async
    result = await self._cursor.execute(operation, parameters)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 132, in execute
    await self._run_operation(self._impl.execute, sql, *params)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 30, in _run_operation
    result = await self._conn._execute(func, *args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\concurrent\futures\thread.py", line 59, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
pyodbc.Error: ('07002', '[07002] [Microsoft][ODBC Driver 17 for SQL Server]COUNT field incorrect or syntax error (0) (SQLExecDirectW)')

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 203, in execute_auth_query
    result = await session.execute(text(query))
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 449, in execute
    result = await greenlet_spawn(
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 203, in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2351, in execute
    return self._execute_internal(
           ^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2258, in _execute_internal
    result = conn.execute(
             ^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1419, in execute
    return meth(
           ^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\sql\elements.py", line 526, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1641, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1846, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1986, in _exec_single_context
    self._handle_dbapi_exception(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 2355, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 230, in execute
    self._adapt_connection._handle_exception(error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 368, in _handle_exception
    raise error.with_traceback(exc_info[2])
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 228, in execute
    return self.await_(self._execute_async(operation, parameters))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 251, in _execute_async
    result = await self._cursor.execute(operation, parameters)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 132, in execute
    await self._run_operation(self._impl.execute, sql, *params)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 30, in _run_operation
    result = await self._conn._execute(func, *args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\concurrent\futures\thread.py", line 59, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
sqlalchemy.exc.DBAPIError: (pyodbc.Error) ('07002', '[07002] [Microsoft][ODBC Driver 17 for SQL Server]COUNT field incorrect or syntax error (0) (SQLExecDirectW)')
[SQL: 
            SELECT usuario_id, cliente_id, nombre_usuario, correo, nombre, apellido, es_activo
            FROM usuario
            WHERE nombre_usuario = ? AND es_eliminado = 0
            ]
(Background on this error at: https://sqlalche.me/e/20/dbapi)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\connection_async.py", line 303, in get_db_connection
    yield session
  File "D:\base_multi_tenant_fastapi\app\core\tenant\routing.py", line 672, in get_connection_for_tenant
    yield session
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 213, in execute_auth_query
    raise DatabaseError(
app.core.exceptions.DatabaseError: Error en la autenticación: (pyodbc.Error) ('07002', '[07002] [Microsoft][ODBC Driver 17 for SQL Server]COUNT field incorrect or syntax error (0) (SQLExecDirectW)')
[SQL: 
            SELECT usuario_id, cliente_id, nombre_usuario, correo, nombre, apellido, es_activo
            FROM usuario
            WHERE nombre_usuario = ? AND es_eliminado = 0
            ]
(Background on this error at: https://sqlalche.me/e/20/dbapi)
2025-12-03 20:49:56,600 - app.modules.auth.application.services.auth_service - ERROR - Error validando refresh token: Error en la autenticación: (pyodbc.Error) ('07002', '[07002] [Microsoft][ODBC Driver 17 for SQL Server]COUNT field incorrect or syntax error (0) (SQLExecDirectW)')
[SQL: 
            SELECT usuario_id, cliente_id, nombre_usuario, correo, nombre, apellido, es_activo
            FROM usuario
            WHERE nombre_usuario = ? AND es_eliminado = 0
            ]
(Background on this error at: https://sqlalche.me/e/20/dbapi)
Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 230, in execute
    self._adapt_connection._handle_exception(error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 368, in _handle_exception
    raise error.with_traceback(exc_info[2])
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 228, in execute
    return self.await_(self._execute_async(operation, parameters))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 251, in _execute_async
    result = await self._cursor.execute(operation, parameters)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 132, in execute
    await self._run_operation(self._impl.execute, sql, *params)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 30, in _run_operation
    result = await self._conn._execute(func, *args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\concurrent\futures\thread.py", line 59, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
pyodbc.Error: ('07002', '[07002] [Microsoft][ODBC Driver 17 for SQL Server]COUNT field incorrect or syntax error (0) (SQLExecDirectW)')

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 203, in execute_auth_query
    result = await session.execute(text(query))
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 449, in execute
    result = await greenlet_spawn(
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 203, in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2351, in execute
    return self._execute_internal(
           ^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2258, in _execute_internal
    result = conn.execute(
             ^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1419, in execute
    return meth(
           ^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\sql\elements.py", line 526, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1641, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1846, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1986, in _exec_single_context
    self._handle_dbapi_exception(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 2355, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 230, in execute
    self._adapt_connection._handle_exception(error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 368, in _handle_exception
    raise error.with_traceback(exc_info[2])
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 228, in execute
    return self.await_(self._execute_async(operation, parameters))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 251, in _execute_async
    result = await self._cursor.execute(operation, parameters)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 132, in execute
    await self._run_operation(self._impl.execute, sql, *params)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 30, in _run_operation
    result = await self._conn._execute(func, *args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\concurrent\futures\thread.py", line 59, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
sqlalchemy.exc.DBAPIError: (pyodbc.Error) ('07002', '[07002] [Microsoft][ODBC Driver 17 for SQL Server]COUNT field incorrect or syntax error (0) (SQLExecDirectW)')
[SQL: 
            SELECT usuario_id, cliente_id, nombre_usuario, correo, nombre, apellido, es_activo
            FROM usuario
            WHERE nombre_usuario = ? AND es_eliminado = 0
            ]
(Background on this error at: https://sqlalche.me/e/20/dbapi)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\modules\auth\application\services\auth_service.py", line 518, in get_current_user_from_refresh
    user = await execute_auth_query(query, (username,))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 213, in execute_auth_query
    raise DatabaseError(
app.core.exceptions.DatabaseError: Error en la autenticación: (pyodbc.Error) ('07002', '[07002] [Microsoft][ODBC Driver 17 for SQL Server]COUNT field incorrect or syntax error (0) (SQLExecDirectW)')
[SQL: 
            SELECT usuario_id, cliente_id, nombre_usuario, correo, nombre, apellido, es_activo
            FROM usuario
            WHERE nombre_usuario = ? AND es_eliminado = 0
            ]
(Background on this error at: https://sqlalche.me/e/20/dbapi)
2025-12-03 20:49:56,604 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/refresh/ 401 38.5ms
2025-12-03 20:50:34,215 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Pool ADMIN inicializado. Size=10, MaxOverflow=5
2025-12-03 20:50:34,215 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Configuración de pools de tenants: MaxPools=50, PoolSize=3, MaxOverflow=2, InactivityTimeout=3600s
2025-12-03 20:50:34,215 - app.infrastructure.database.connection_pool - INFO - ✅ Módulo de connection pooling cargado y activo
2025-12-03 20:50:34,215 - app.infrastructure.database.connection_pool - INFO -    Configuración: MaxTenantPools=50, TenantPoolSize=3, InactivityTimeout=3600s
2025-12-03 20:50:34,215 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Todos los pools cerrados
2025-12-03 20:50:34,215 - app.main - INFO - ✅ Pools de conexión cerrados correctamente
2025-12-03 20:50:34,925 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 20:50:35,115 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 20:50:35,125 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 20:50:35,127 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 20:50:35,127 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 20:50:35,128 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 20:50:35,128 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 20:50:35,128 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, DEFAULT_TYPE=single
2025-12-03 20:50:35,468 - app.core.security.rate_limiting - INFO - [RATE_LIMITING] Activado. Límites: Login=10/minute, API=200/minute
2025-12-03 20:50:35,468 - app.core.security.rate_limiting - INFO - ✅ Módulo de rate limiting cargado y activo
2025-12-03 20:50:35,535 - app.core.authorization.rbac - INFO - 🔐 Inicializando sistema de autorización...
2025-12-03 20:50:35,535 - app.core.authorization.rbac - INFO - ✅ Sistema de autorización inicializado correctamente
2025-12-03 20:50:35,535 - app.core.authorization.rbac - INFO - 📊 Permisos del sistema: 6 módulos configurados
2025-12-03 20:50:35,685 - app.core.tenant.middleware - INFO - Módulo tenant_middleware cargado (versión híbrida con soporte para proxies)
2025-12-03 20:50:35,685 - app.main - INFO - ✅ Rate limiting configurado y activo
2025-12-03 20:50:35,825 - app.core.tenant.middleware - INFO - [TENANT_MW] Inicializado - BASE_DOMAIN=app.local, SYSTEM_ID=BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, EXCLUDED_SUBDOMAINS={'assets', 'cdn', 'www', 'backend', 'api', 'static', 'admin'}
2025-12-03 20:51:46,009 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Pool ADMIN inicializado. Size=10, MaxOverflow=5
2025-12-03 20:51:46,009 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Configuración de pools de tenants: MaxPools=50, PoolSize=3, MaxOverflow=2, InactivityTimeout=3600s
2025-12-03 20:51:46,009 - app.infrastructure.database.connection_pool - INFO - ✅ Módulo de connection pooling cargado y activo
2025-12-03 20:51:46,010 - app.infrastructure.database.connection_pool - INFO -    Configuración: MaxTenantPools=50, TenantPoolSize=3, InactivityTimeout=3600s
2025-12-03 20:51:46,010 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Todos los pools cerrados
2025-12-03 20:51:46,010 - app.main - INFO - ✅ Pools de conexión cerrados correctamente
2025-12-03 20:51:46,800 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 20:51:46,991 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 20:51:46,996 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 20:51:47,009 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 20:51:47,009 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 20:51:47,009 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 20:51:47,011 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 20:51:47,011 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, DEFAULT_TYPE=single
2025-12-03 20:51:47,364 - app.core.security.rate_limiting - INFO - [RATE_LIMITING] Activado. Límites: Login=10/minute, API=200/minute
2025-12-03 20:51:47,364 - app.core.security.rate_limiting - INFO - ✅ Módulo de rate limiting cargado y activo
2025-12-03 20:51:47,436 - app.core.authorization.rbac - INFO - 🔐 Inicializando sistema de autorización...
2025-12-03 20:51:47,436 - app.core.authorization.rbac - INFO - ✅ Sistema de autorización inicializado correctamente
2025-12-03 20:51:47,436 - app.core.authorization.rbac - INFO - 📊 Permisos del sistema: 6 módulos configurados
2025-12-03 20:51:47,616 - app.core.tenant.middleware - INFO - Módulo tenant_middleware cargado (versión híbrida con soporte para proxies)
2025-12-03 20:51:47,616 - app.main - INFO - ✅ Rate limiting configurado y activo
2025-12-03 20:51:47,764 - app.core.tenant.middleware - INFO - [TENANT_MW] Inicializado - BASE_DOMAIN=app.local, SYSTEM_ID=BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, EXCLUDED_SUBDOMAINS={'backend', 'api', 'assets', 'cdn', 'static', 'admin', 'www'}
2025-12-03 20:51:51,329 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Pool ADMIN inicializado. Size=10, MaxOverflow=5
2025-12-03 20:51:51,329 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Configuración de pools de tenants: MaxPools=50, PoolSize=3, MaxOverflow=2, InactivityTimeout=3600s
2025-12-03 20:51:51,329 - app.infrastructure.database.connection_pool - INFO - ✅ Módulo de connection pooling cargado y activo
2025-12-03 20:51:51,329 - app.infrastructure.database.connection_pool - INFO -    Configuración: MaxTenantPools=50, TenantPoolSize=3, InactivityTimeout=3600s
2025-12-03 20:51:51,329 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Todos los pools cerrados
2025-12-03 20:51:51,329 - app.main - INFO - ✅ Pools de conexión cerrados correctamente
2025-12-03 20:51:56,506 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 20:51:56,710 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 20:51:56,716 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 20:51:56,718 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 20:51:56,718 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 20:51:56,719 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 20:51:56,719 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 20:51:56,719 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, DEFAULT_TYPE=single
2025-12-03 20:51:57,066 - app.core.security.rate_limiting - INFO - [RATE_LIMITING] Activado. Límites: Login=10/minute, API=200/minute
2025-12-03 20:51:57,066 - app.core.security.rate_limiting - INFO - ✅ Módulo de rate limiting cargado y activo
2025-12-03 20:51:57,138 - app.core.authorization.rbac - INFO - 🔐 Inicializando sistema de autorización...
2025-12-03 20:51:57,139 - app.core.authorization.rbac - INFO - ✅ Sistema de autorización inicializado correctamente
2025-12-03 20:51:57,139 - app.core.authorization.rbac - INFO - 📊 Permisos del sistema: 6 módulos configurados
2025-12-03 20:51:57,300 - app.core.tenant.middleware - INFO - Módulo tenant_middleware cargado (versión híbrida con soporte para proxies)
2025-12-03 20:51:57,300 - app.main - INFO - ✅ Rate limiting configurado y activo
2025-12-03 20:51:57,448 - app.core.tenant.middleware - INFO - [TENANT_MW] Inicializado - BASE_DOMAIN=app.local, SYSTEM_ID=BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, EXCLUDED_SUBDOMAINS={'static', 'cdn', 'www', 'api', 'assets', 'backend', 'admin'}
2025-12-03 20:52:07,567 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/auth/login/
2025-12-03 20:52:07,567 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/auth/login/ 200 0.7ms
2025-12-03 20:52:07,569 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/login/
2025-12-03 20:52:07,570 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 20:52:07,570 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 20:52:07,570 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 20:52:07,570 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 20:52:07,570 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 20:52:07,571 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 20:52:07,571 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 20:52:07,571 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 20:52:07,571 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 20:52:07,571 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 20:52:07,571 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/auth/login/
2025-12-03 20:52:07,573 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] AsyncEngine creado para admin
2025-12-03 20:52:07,716 - app.modules.auth.presentation.endpoints - INFO - Cliente bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7 resuelto y validado para login.
2025-12-03 20:52:07,716 - app.modules.auth.application.services.auth_service - INFO - [AUTH] Intento de login: username='superadmin', cliente_id_destino=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 20:52:07,716 - app.modules.auth.application.services.auth_service - INFO - [AUTH] SUPERADMIN detectado. Buscando en BD ADMIN (cliente_id=BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7), accediendo a cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 20:52:07,966 - app.modules.auth.application.services.auth_service - INFO - Niveles calculados - Usuario 154134AD-A5EB-4F45-AEF0-5F9AAA282C8E: level=5, super_admin=True, type=super_admin
2025-12-03 20:52:07,966 - app.modules.auth.application.services.auth_service - INFO - [AUTH] Login exitoso: username='superadmin', usuario_id=154134AD-A5EB-4F45-AEF0-5F9AAA282C8E, cliente_origen=BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, cliente_destino=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, access_level=5, user_type=super_admin
2025-12-03 20:52:07,966 - app.modules.auth.presentation.endpoints - INFO - [LOGIN] Superadmin accediendo a cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 20:52:07,971 - app.modules.auth.application.services.auth_service - INFO - Niveles calculados - Usuario 154134AD-A5EB-4F45-AEF0-5F9AAA282C8E: level=5, super_admin=True, type=super_admin
2025-12-03 20:52:07,981 - app.modules.auth.application.services.refresh_token_service - INFO - [STORE-TOKEN] Token insertado exitosamente - Cliente bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, Usuario 154134AD-A5EB-4F45-AEF0-5F9AAA282C8E, Tipo: web, Token ID: F79BF560-367C-4FA9-A9EC-DB09C7F11D93, Rotación: False
2025-12-03 20:52:07,981 - app.modules.auth.presentation.endpoints - ERROR - [LOGIN] Error almacenando refresh token: '>' not supported between instances of 'str' and 'int'
2025-12-03 20:52:07,981 - app.modules.auth.presentation.endpoints - INFO - Usuario superadmin autenticado exitosamente (WEB) para cliente bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 20:52:07,992 - app.modules.superadmin.application.services.audit_service - INFO - [AUDIT] auth_audit_log registrado: evento=login_success, cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, usuario_id=154134AD-A5EB-4F45-AEF0-5F9AAA282C8E, exito=True
2025-12-03 20:52:07,995 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/login/ 200 425.0ms
2025-12-03 20:52:08,006 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/clientes/tenant/branding
2025-12-03 20:52:08,006 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/clientes/tenant/branding 200 0.6ms
2025-12-03 20:52:08,010 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/clientes/tenant/branding
2025-12-03 20:52:08,010 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 20:52:08,011 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 20:52:08,011 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 20:52:08,011 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 20:52:08,011 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 20:52:08,011 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 20:52:08,012 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 20:52:08,012 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 20:52:08,012 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 20:52:08,012 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 20:52:08,012 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/clientes/tenant/branding
2025-12-03 20:52:08,026 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/menus/getmenu/
2025-12-03 20:52:08,028 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/menus/getmenu/ 200 1.1ms
2025-12-03 20:52:08,028 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/menus/getmenu/
2025-12-03 20:52:08,028 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/menus/getmenu/ 200 1.0ms
2025-12-03 20:52:08,035 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/menus/getmenu/
2025-12-03 20:52:08,035 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 20:52:08,035 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 20:52:08,035 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 20:52:08,036 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 20:52:08,036 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 20:52:08,037 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 20:52:08,037 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 20:52:08,037 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 20:52:08,037 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 20:52:08,037 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 20:52:08,037 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/menus/getmenu/
2025-12-03 20:52:08,068 - app.modules.tenant.presentation.endpoints_clientes - INFO - Solicitud GET /tenant/branding recibida para cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7 por usuario: superadmin
2025-12-03 20:52:08,068 - app.modules.tenant.application.services.cliente_service - INFO - Solicitando branding para cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 20:52:08,068 - app.modules.menus.presentation.endpoints - INFO - Solicitud GET /menus/getmenu/ recibida para usuario ID: 154134ad-a5eb-4f45-aef0-5f9aaa282c8e del cliente bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 20:52:08,068 - app.modules.menus.application.services.menu_service - INFO - Obteniendo menú filtrado para usuario_id: 154134ad-a5eb-4f45-aef0-5f9aaa282c8e
2025-12-03 20:52:08,075 - app.modules.tenant.application.services.cliente_service - INFO - Branding obtenido exitosamente para cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 20:52:08,076 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/clientes/tenant/branding 200 65.8ms
2025-12-03 20:52:08,131 - app.modules.menus.application.services.menu_service - INFO - No se encontraron menús permitidos para el usuario ID: 154134ad-a5eb-4f45-aef0-5f9aaa282c8e.
2025-12-03 20:52:08,131 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/menus/getmenu/ 200 107.5ms
2025-12-03 20:52:08,131 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/menus/getmenu/
2025-12-03 20:52:08,131 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 20:52:08,131 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 20:52:08,131 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 20:52:08,131 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 20:52:08,131 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 20:52:08,131 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 20:52:08,145 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 20:52:08,145 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 20:52:08,145 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 20:52:08,145 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 20:52:08,145 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/menus/getmenu/
2025-12-03 20:52:08,166 - app.modules.menus.presentation.endpoints - INFO - Solicitud GET /menus/getmenu/ recibida para usuario ID: 154134ad-a5eb-4f45-aef0-5f9aaa282c8e del cliente bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 20:52:08,166 - app.modules.menus.application.services.menu_service - INFO - Obteniendo menú filtrado para usuario_id: 154134ad-a5eb-4f45-aef0-5f9aaa282c8e
2025-12-03 20:52:08,169 - app.modules.menus.application.services.menu_service - INFO - No se encontraron menús permitidos para el usuario ID: 154134ad-a5eb-4f45-aef0-5f9aaa282c8e.
2025-12-03 20:52:08,169 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/menus/getmenu/ 200 25.9ms
2025-12-03 20:52:22,551 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/auth/refresh/
2025-12-03 20:52:22,551 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/auth/refresh/ 200 0.5ms
2025-12-03 20:52:22,552 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/refresh/
2025-12-03 20:52:22,552 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 20:52:22,552 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 20:52:22,552 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 20:52:22,552 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 20:52:22,552 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 20:52:22,552 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 20:52:22,552 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 20:52:22,552 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 20:52:22,552 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 20:52:22,552 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 20:52:22,552 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/auth/refresh/
2025-12-03 20:52:22,569 - app.modules.auth.application.services.refresh_token_service - INFO - [VALIDATE-TOKEN] Token válido - Cliente BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, Usuario 154134AD-A5EB-4F45-AEF0-5F9AAA282C8E, Tipo: web
2025-12-03 20:52:22,580 - app.modules.auth.application.services.auth_service - INFO - [REFRESH] Token validado exitosamente (BD OK) para usuario: superadmin (Cliente: BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, Level: 5, Type: super_admin)
2025-12-03 20:52:22,587 - app.modules.auth.application.services.auth_service - INFO - Niveles calculados - Usuario 154134AD-A5EB-4F45-AEF0-5F9AAA282C8E: level=5, super_admin=True, type=super_admin
2025-12-03 20:52:22,597 - app.modules.auth.application.services.refresh_token_service - INFO - [STORE-TOKEN] Token insertado exitosamente - Cliente BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, Usuario 154134AD-A5EB-4F45-AEF0-5F9AAA282C8E, Tipo: web, Token ID: 967FF28E-6E48-46ED-8FCF-7AFCDD1A4409, Rotación: True
2025-12-03 20:52:22,605 - app.infrastructure.database.queries_async - ERROR - Error en execute_update async (string): (pyodbc.Error) ('07002', '[07002] [Microsoft][ODBC Driver 17 for SQL Server]COUNT field incorrect or syntax error (0) (SQLExecDirectW)')
[SQL: 
UPDATE refresh_tokens
SET is_revoked = 1, revoked_at = GETDATE()
OUTPUT INSERTED.token_id, INSERTED.is_revoked, INSERTED.cliente_id
WHERE token_hash = ? AND usuario_id = ? AND cliente_id = ?;
]
(Background on this error at: https://sqlalche.me/e/20/dbapi)
2025-12-03 20:52:22,605 - app.infrastructure.database.connection_async - ERROR - [ASYNC_CONNECTION] Error en sesión async: Error en la actualización: (pyodbc.Error) ('07002', '[07002] [Microsoft][ODBC Driver 17 for SQL Server]COUNT field incorrect or syntax error (0) (SQLExecDirectW)')
[SQL: 
UPDATE refresh_tokens
SET is_revoked = 1, revoked_at = GETDATE()
OUTPUT INSERTED.token_id, INSERTED.is_revoked, INSERTED.cliente_id
WHERE token_hash = ? AND usuario_id = ? AND cliente_id = ?;
]
(Background on this error at: https://sqlalche.me/e/20/dbapi)
Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 230, in execute
    self._adapt_connection._handle_exception(error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 368, in _handle_exception
    raise error.with_traceback(exc_info[2])
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 228, in execute
    return self.await_(self._execute_async(operation, parameters))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 251, in _execute_async
    result = await self._cursor.execute(operation, parameters)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 132, in execute
    await self._run_operation(self._impl.execute, sql, *params)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 30, in _run_operation
    result = await self._conn._execute(func, *args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\concurrent\futures\thread.py", line 59, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
pyodbc.Error: ('07002', '[07002] [Microsoft][ODBC Driver 17 for SQL Server]COUNT field incorrect or syntax error (0) (SQLExecDirectW)')

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 441, in execute_update
    result = await session.execute(text(query))
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 449, in execute
    result = await greenlet_spawn(
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 203, in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2351, in execute
    return self._execute_internal(
           ^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2258, in _execute_internal
    result = conn.execute(
             ^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1419, in execute
    return meth(
           ^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\sql\elements.py", line 526, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1641, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1846, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1986, in _exec_single_context
    self._handle_dbapi_exception(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 2355, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 230, in execute
    self._adapt_connection._handle_exception(error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 368, in _handle_exception
    raise error.with_traceback(exc_info[2])
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 228, in execute
    return self.await_(self._execute_async(operation, parameters))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 251, in _execute_async
    result = await self._cursor.execute(operation, parameters)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 132, in execute
    await self._run_operation(self._impl.execute, sql, *params)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 30, in _run_operation
    result = await self._conn._execute(func, *args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\concurrent\futures\thread.py", line 59, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
sqlalchemy.exc.DBAPIError: (pyodbc.Error) ('07002', '[07002] [Microsoft][ODBC Driver 17 for SQL Server]COUNT field incorrect or syntax error (0) (SQLExecDirectW)')
[SQL: 
UPDATE refresh_tokens
SET is_revoked = 1, revoked_at = GETDATE()
OUTPUT INSERTED.token_id, INSERTED.is_revoked, INSERTED.cliente_id
WHERE token_hash = ? AND usuario_id = ? AND cliente_id = ?;
]
(Background on this error at: https://sqlalche.me/e/20/dbapi)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\connection_async.py", line 303, in get_db_connection
    yield session
  File "D:\base_multi_tenant_fastapi\app\core\tenant\routing.py", line 672, in get_connection_for_tenant
    yield session
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 457, in execute_update
    raise DatabaseError(
app.core.exceptions.DatabaseError: Error en la actualización: (pyodbc.Error) ('07002', '[07002] [Microsoft][ODBC Driver 17 for SQL Server]COUNT field incorrect or syntax error (0) (SQLExecDirectW)')
[SQL: 
UPDATE refresh_tokens
SET is_revoked = 1, revoked_at = GETDATE()
OUTPUT INSERTED.token_id, INSERTED.is_revoked, INSERTED.cliente_id
WHERE token_hash = ? AND usuario_id = ? AND cliente_id = ?;
]
(Background on this error at: https://sqlalche.me/e/20/dbapi)
2025-12-03 20:52:22,615 - app.core.application.base_service - ERROR - DatabaseError en revoke_token: Error en la actualización: (pyodbc.Error) ('07002', '[07002] [Microsoft][ODBC Driver 17 for SQL Server]COUNT field incorrect or syntax error (0) (SQLExecDirectW)')
[SQL: 
UPDATE refresh_tokens
SET is_revoked = 1, revoked_at = GETDATE()
OUTPUT INSERTED.token_id, INSERTED.is_revoked, INSERTED.cliente_id
WHERE token_hash = ? AND usuario_id = ? AND cliente_id = ?;
]
(Background on this error at: https://sqlalche.me/e/20/dbapi)
Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 230, in execute
    self._adapt_connection._handle_exception(error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 368, in _handle_exception
    raise error.with_traceback(exc_info[2])
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 228, in execute
    return self.await_(self._execute_async(operation, parameters))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 251, in _execute_async
    result = await self._cursor.execute(operation, parameters)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 132, in execute
    await self._run_operation(self._impl.execute, sql, *params)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 30, in _run_operation
    result = await self._conn._execute(func, *args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\concurrent\futures\thread.py", line 59, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
pyodbc.Error: ('07002', '[07002] [Microsoft][ODBC Driver 17 for SQL Server]COUNT field incorrect or syntax error (0) (SQLExecDirectW)')

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 441, in execute_update
    result = await session.execute(text(query))
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 449, in execute
    result = await greenlet_spawn(
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 203, in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2351, in execute
    return self._execute_internal(
           ^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2258, in _execute_internal
    result = conn.execute(
             ^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1419, in execute
    return meth(
           ^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\sql\elements.py", line 526, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1641, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1846, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1986, in _exec_single_context
    self._handle_dbapi_exception(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 2355, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 230, in execute
    self._adapt_connection._handle_exception(error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 368, in _handle_exception
    raise error.with_traceback(exc_info[2])
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 228, in execute
    return self.await_(self._execute_async(operation, parameters))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 251, in _execute_async
    result = await self._cursor.execute(operation, parameters)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 132, in execute
    await self._run_operation(self._impl.execute, sql, *params)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 30, in _run_operation
    result = await self._conn._execute(func, *args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\concurrent\futures\thread.py", line 59, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
sqlalchemy.exc.DBAPIError: (pyodbc.Error) ('07002', '[07002] [Microsoft][ODBC Driver 17 for SQL Server]COUNT field incorrect or syntax error (0) (SQLExecDirectW)')
[SQL: 
UPDATE refresh_tokens
SET is_revoked = 1, revoked_at = GETDATE()
OUTPUT INSERTED.token_id, INSERTED.is_revoked, INSERTED.cliente_id
WHERE token_hash = ? AND usuario_id = ? AND cliente_id = ?;
]
(Background on this error at: https://sqlalche.me/e/20/dbapi)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\core\application\base_service.py", line 52, in wrapper
    return await func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\modules\auth\application\services\refresh_token_service.py", line 262, in revoke_token
    result = await execute_update(REVOKE_REFRESH_TOKEN_BY_USER, (token_hash, usuario_id, cliente_id))
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 457, in execute_update
    raise DatabaseError(
app.core.exceptions.DatabaseError: Error en la actualización: (pyodbc.Error) ('07002', '[07002] [Microsoft][ODBC Driver 17 for SQL Server]COUNT field incorrect or syntax error (0) (SQLExecDirectW)')
[SQL: 
UPDATE refresh_tokens
SET is_revoked = 1, revoked_at = GETDATE()
OUTPUT INSERTED.token_id, INSERTED.is_revoked, INSERTED.cliente_id
WHERE token_hash = ? AND usuario_id = ? AND cliente_id = ?;
]
(Background on this error at: https://sqlalche.me/e/20/dbapi)
2025-12-03 20:52:22,620 - app.modules.auth.presentation.endpoints - WARNING - [REFRESH] Error revocando token antiguo (no crítico): Error en la actualización: (pyodbc.Error) ('07002', '[07002] [Microsoft][ODBC Driver 17 for SQL Server]COUNT field incorrect or syntax error (0) (SQLExecDirectW)')
[SQL: 
UPDATE refresh_tokens
SET is_revoked = 1, revoked_at = GETDATE()
OUTPUT INSERTED.token_id, INSERTED.is_revoked, INSERTED.cliente_id
WHERE token_hash = ? AND usuario_id = ? AND cliente_id = ?;
]
(Background on this error at: https://sqlalche.me/e/20/dbapi)
2025-12-03 20:52:22,620 - app.modules.auth.presentation.endpoints - ERROR - [REFRESH] Error en rotación de token: '>' not supported between instances of 'str' and 'int'
2025-12-03 20:52:22,620 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/refresh/ 500 67.7ms
2025-12-03 20:55:28,005 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Pool ADMIN inicializado. Size=10, MaxOverflow=5
2025-12-03 20:55:28,005 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Configuración de pools de tenants: MaxPools=50, PoolSize=3, MaxOverflow=2, InactivityTimeout=3600s
2025-12-03 20:55:28,005 - app.infrastructure.database.connection_pool - INFO - ✅ Módulo de connection pooling cargado y activo
2025-12-03 20:55:28,005 - app.infrastructure.database.connection_pool - INFO -    Configuración: MaxTenantPools=50, TenantPoolSize=3, InactivityTimeout=3600s
2025-12-03 20:55:28,005 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Todos los pools cerrados
2025-12-03 20:55:28,005 - app.main - INFO - ✅ Pools de conexión cerrados correctamente
2025-12-03 20:55:28,831 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 20:55:29,029 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 20:55:29,031 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 20:55:29,043 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 20:55:29,043 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 20:55:29,043 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 20:55:29,043 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 20:55:29,043 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, DEFAULT_TYPE=single
2025-12-03 20:55:29,361 - app.core.security.rate_limiting - INFO - [RATE_LIMITING] Activado. Límites: Login=10/minute, API=200/minute
2025-12-03 20:55:29,361 - app.core.security.rate_limiting - INFO - ✅ Módulo de rate limiting cargado y activo
2025-12-03 20:55:29,439 - app.core.authorization.rbac - INFO - 🔐 Inicializando sistema de autorización...
2025-12-03 20:55:29,439 - app.core.authorization.rbac - INFO - ✅ Sistema de autorización inicializado correctamente
2025-12-03 20:55:29,621 - app.main - INFO - ✅ Rate limiting configurado y activo
2025-12-03 20:55:34,540 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Pool ADMIN inicializado. Size=10, MaxOverflow=5
2025-12-03 21:01:21,305 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 21:01:21,495 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 21:01:21,505 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 21:01:21,508 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 21:01:21,508 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 21:01:21,509 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 21:01:21,510 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 21:01:21,510 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, DEFAULT_TYPE=single
2025-12-03 21:01:21,825 - app.core.security.rate_limiting - INFO - [RATE_LIMITING] Activado. Límites: Login=10/minute, API=200/minute
2025-12-03 21:01:21,825 - app.core.security.rate_limiting - INFO - ✅ Módulo de rate limiting cargado y activo
2025-12-03 21:01:21,905 - app.core.authorization.rbac - INFO - 🔐 Inicializando sistema de autorización...
2025-12-03 21:01:21,905 - app.core.authorization.rbac - INFO - ✅ Sistema de autorización inicializado correctamente
2025-12-03 21:01:21,905 - app.core.authorization.rbac - INFO - 📊 Permisos del sistema: 6 módulos configurados
2025-12-03 21:01:22,057 - app.core.tenant.middleware - INFO - Módulo tenant_middleware cargado (versión híbrida con soporte para proxies)
2025-12-03 21:01:22,063 - app.main - INFO - ✅ Rate limiting configurado y activo
2025-12-03 21:01:22,205 - app.core.tenant.middleware - INFO - [TENANT_MW] Inicializado - BASE_DOMAIN=app.local, SYSTEM_ID=BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, EXCLUDED_SUBDOMAINS={'admin', 'www', 'static', 'backend', 'assets', 'cdn', 'api'}
2025-12-03 21:01:27,355 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Pool ADMIN inicializado. Size=10, MaxOverflow=5
2025-12-03 21:01:27,355 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Configuración de pools de tenants: MaxPools=50, PoolSize=3, MaxOverflow=2, InactivityTimeout=3600s
2025-12-03 21:01:27,355 - app.infrastructure.database.connection_pool - INFO - ✅ Módulo de connection pooling cargado y activo
2025-12-03 21:01:27,355 - app.infrastructure.database.connection_pool - INFO -    Configuración: MaxTenantPools=50, TenantPoolSize=3, InactivityTimeout=3600s
2025-12-03 21:01:27,355 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Todos los pools cerrados
2025-12-03 21:01:27,355 - app.main - INFO - ✅ Pools de conexión cerrados correctamente
2025-12-03 21:01:29,690 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 21:01:29,888 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 21:01:29,895 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 21:01:29,897 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 21:01:29,898 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 21:01:29,898 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 21:01:29,899 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 21:01:29,899 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, DEFAULT_TYPE=single
2025-12-03 21:01:30,228 - app.core.security.rate_limiting - INFO - [RATE_LIMITING] Activado. Límites: Login=10/minute, API=200/minute
2025-12-03 21:01:30,229 - app.core.security.rate_limiting - INFO - ✅ Módulo de rate limiting cargado y activo
2025-12-03 21:01:30,299 - app.core.authorization.rbac - INFO - 🔐 Inicializando sistema de autorización...
2025-12-03 21:01:30,301 - app.core.authorization.rbac - INFO - ✅ Sistema de autorización inicializado correctamente
2025-12-03 21:01:30,301 - app.core.authorization.rbac - INFO - 📊 Permisos del sistema: 6 módulos configurados
2025-12-03 21:01:30,468 - app.core.tenant.middleware - INFO - Módulo tenant_middleware cargado (versión híbrida con soporte para proxies)
2025-12-03 21:01:30,469 - app.main - INFO - ✅ Rate limiting configurado y activo
2025-12-03 21:01:30,631 - app.core.tenant.middleware - INFO - [TENANT_MW] Inicializado - BASE_DOMAIN=app.local, SYSTEM_ID=BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, EXCLUDED_SUBDOMAINS={'www', 'cdn', 'static', 'admin', 'api', 'assets', 'backend'}
2025-12-03 21:01:46,626 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/login/
2025-12-03 21:01:46,627 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 21:01:46,627 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 21:01:46,628 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:01:46,628 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:01:46,628 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:01:46,629 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:01:46,629 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:01:46,629 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:01:46,630 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:01:46,630 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 21:01:46,631 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/auth/login/
2025-12-03 21:01:46,635 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] AsyncEngine creado para admin
2025-12-03 21:01:46,807 - app.modules.auth.presentation.endpoints - INFO - Cliente bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7 resuelto y validado para login.
2025-12-03 21:01:46,807 - app.modules.auth.application.services.auth_service - INFO - [AUTH] Intento de login: username='superadmin', cliente_id_destino=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:01:46,807 - app.modules.auth.application.services.auth_service - INFO - [AUTH] SUPERADMIN detectado. Buscando en BD ADMIN (cliente_id=BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7), accediendo a cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:01:47,066 - app.modules.auth.application.services.auth_service - INFO - Niveles calculados - Usuario 154134AD-A5EB-4F45-AEF0-5F9AAA282C8E: level=5, super_admin=True, type=super_admin
2025-12-03 21:01:47,066 - app.modules.auth.application.services.auth_service - INFO - [AUTH] Login exitoso: username='superadmin', usuario_id=154134AD-A5EB-4F45-AEF0-5F9AAA282C8E, cliente_origen=BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, cliente_destino=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, access_level=5, user_type=super_admin
2025-12-03 21:01:47,066 - app.modules.auth.presentation.endpoints - INFO - [LOGIN] Superadmin accediendo a cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:01:47,074 - app.modules.auth.application.services.auth_service - INFO - Niveles calculados - Usuario 154134AD-A5EB-4F45-AEF0-5F9AAA282C8E: level=5, super_admin=True, type=super_admin
2025-12-03 21:01:47,085 - app.modules.auth.application.services.refresh_token_service - INFO - [STORE-TOKEN] Token insertado exitosamente - Cliente bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, Usuario 154134AD-A5EB-4F45-AEF0-5F9AAA282C8E, Tipo: web, Token ID: 6A8F88AE-42E6-4324-B5B8-EF6838183A8B, Rotación: False
2025-12-03 21:01:47,086 - app.modules.auth.presentation.endpoints - INFO - [LOGIN-WEB] Token almacenado - ID: 6A8F88AE-42E6-4324-B5B8-EF6838183A8B
2025-12-03 21:01:47,086 - app.modules.auth.presentation.endpoints - INFO - Usuario superadmin autenticado exitosamente (WEB) para cliente bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:01:47,095 - app.modules.superadmin.application.services.audit_service - INFO - [AUDIT] auth_audit_log registrado: evento=login_success, cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, usuario_id=154134AD-A5EB-4F45-AEF0-5F9AAA282C8E, exito=True
2025-12-03 21:01:47,098 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/login/ 200 471.4ms
2025-12-03 21:01:47,110 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/clientes/tenant/branding
2025-12-03 21:01:47,111 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 21:01:47,112 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 21:01:47,113 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:01:47,113 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:01:47,114 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:01:47,114 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:01:47,114 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:01:47,116 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:01:47,116 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:01:47,117 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 21:01:47,117 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/clientes/tenant/branding
2025-12-03 21:01:47,126 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/menus/getmenu/
2025-12-03 21:01:47,128 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 21:01:47,128 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 21:01:47,129 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:01:47,130 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:01:47,130 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:01:47,131 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:01:47,131 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:01:47,132 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:01:47,133 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:01:47,134 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 21:01:47,134 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/menus/getmenu/
2025-12-03 21:01:47,179 - app.modules.tenant.presentation.endpoints_clientes - INFO - Solicitud GET /tenant/branding recibida para cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7 por usuario: superadmin
2025-12-03 21:01:47,179 - app.modules.tenant.application.services.cliente_service - INFO - Solicitando branding para cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:01:47,179 - app.modules.menus.presentation.endpoints - INFO - Solicitud GET /menus/getmenu/ recibida para usuario ID: 154134ad-a5eb-4f45-aef0-5f9aaa282c8e del cliente bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:01:47,179 - app.modules.menus.application.services.menu_service - INFO - Obteniendo menú filtrado para usuario_id: 154134ad-a5eb-4f45-aef0-5f9aaa282c8e
2025-12-03 21:01:47,185 - app.modules.tenant.application.services.cliente_service - INFO - Branding obtenido exitosamente para cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:01:47,185 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/clientes/tenant/branding 200 76.7ms
2025-12-03 21:01:47,242 - app.modules.menus.application.services.menu_service - INFO - No se encontraron menús permitidos para el usuario ID: 154134ad-a5eb-4f45-aef0-5f9aaa282c8e.
2025-12-03 21:01:47,245 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/menus/getmenu/ 200 118.8ms
2025-12-03 21:01:47,245 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/menus/getmenu/
2025-12-03 21:01:47,245 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 21:01:47,245 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 21:01:47,245 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:01:47,245 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:01:47,251 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:01:47,251 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:01:47,251 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:01:47,252 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:01:47,252 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:01:47,253 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 21:01:47,253 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/menus/getmenu/
2025-12-03 21:01:47,274 - app.modules.menus.presentation.endpoints - INFO - Solicitud GET /menus/getmenu/ recibida para usuario ID: 154134ad-a5eb-4f45-aef0-5f9aaa282c8e del cliente bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:01:47,275 - app.modules.menus.application.services.menu_service - INFO - Obteniendo menú filtrado para usuario_id: 154134ad-a5eb-4f45-aef0-5f9aaa282c8e
2025-12-03 21:01:47,275 - app.modules.menus.application.services.menu_service - INFO - No se encontraron menús permitidos para el usuario ID: 154134ad-a5eb-4f45-aef0-5f9aaa282c8e.
2025-12-03 21:01:47,275 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/menus/getmenu/ 200 32.0ms
2025-12-03 21:02:01,531 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/refresh/
2025-12-03 21:02:01,532 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 21:02:01,533 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 21:02:01,533 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:02:01,533 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:02:01,533 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:02:01,533 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:02:01,533 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:02:01,533 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:02:01,536 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:02:01,536 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 21:02:01,536 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/auth/refresh/
2025-12-03 21:02:01,546 - app.modules.auth.application.services.refresh_token_service - INFO - [VALIDATE-TOKEN] Token válido - Cliente BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, Usuario 154134AD-A5EB-4F45-AEF0-5F9AAA282C8E, Tipo: web
2025-12-03 21:02:01,553 - app.modules.auth.application.services.auth_service - INFO - [REFRESH] Token validado exitosamente (BD OK) para usuario: superadmin (Cliente: BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, Level: 5, Type: super_admin)
2025-12-03 21:02:01,556 - app.modules.auth.application.services.auth_service - INFO - Niveles calculados - Usuario 154134AD-A5EB-4F45-AEF0-5F9AAA282C8E: level=5, super_admin=True, type=super_admin
2025-12-03 21:02:01,571 - app.modules.auth.application.services.refresh_token_service - INFO - [STORE-TOKEN] Token insertado exitosamente - Cliente BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, Usuario 154134AD-A5EB-4F45-AEF0-5F9AAA282C8E, Tipo: web, Token ID: 0021B43D-E1DD-4923-926E-60D2BD16C373, Rotación: True
2025-12-03 21:02:01,582 - app.modules.auth.application.services.refresh_token_service - WARNING - [REVOKE-TOKEN] Token no encontrado o ya revocado - Cliente BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, Usuario 154134AD-A5EB-4F45-AEF0-5F9AAA282C8E
2025-12-03 21:02:01,582 - app.modules.auth.presentation.endpoints - WARNING - [REFRESH] Token antiguo no encontrado para revocar (no crítico)
2025-12-03 21:02:01,582 - app.modules.auth.presentation.endpoints - INFO - [REFRESH-WEB] Token rotado exitosamente - ID: 0021B43D-E1DD-4923-926E-60D2BD16C373
2025-12-03 21:02:01,584 - app.modules.auth.presentation.endpoints - INFO - [REFRESH-WEB] Token refrescado exitosamente - Usuario: superadmin
2025-12-03 21:02:01,591 - app.modules.superadmin.application.services.audit_service - INFO - [AUDIT] auth_audit_log registrado: evento=token_refresh, cliente_id=BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, usuario_id=154134AD-A5EB-4F45-AEF0-5F9AAA282C8E, exito=True
2025-12-03 21:02:01,592 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/refresh/ 200 60.8ms
2025-12-03 21:02:01,596 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/auth/me/
2025-12-03 21:02:01,596 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 21:02:01,597 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 21:02:01,597 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:02:01,597 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:02:01,598 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:02:01,598 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:02:01,598 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:02:01,599 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:02:01,599 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:02:01,600 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 21:02:01,600 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/auth/me/
2025-12-03 21:02:01,601 - app.modules.auth.application.services.auth_service - WARNING - [SECURITY] Token de tenant BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7 usado en tenant bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7. Usuario: superadmin
2025-12-03 21:02:01,601 - app.modules.auth.application.services.auth_service - ERROR - Error procesando payload del token: 403: Token no válido para este tenant. Por favor, inicie sesión nuevamente.
2025-12-03 21:02:01,602 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/auth/me/ 401 6.6ms
2025-12-03 21:02:01,604 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/refresh/
2025-12-03 21:02:01,605 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 21:02:01,606 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 21:02:01,606 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:02:01,606 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:02:01,606 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:02:01,606 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:02:01,606 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:02:01,606 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:02:01,606 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:02:01,606 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 21:02:01,606 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/auth/refresh/
2025-12-03 21:02:01,615 - app.modules.auth.application.services.refresh_token_service - INFO - [VALIDATE-TOKEN] Token válido - Cliente BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, Usuario 154134AD-A5EB-4F45-AEF0-5F9AAA282C8E, Tipo: web
2025-12-03 21:02:01,620 - app.modules.auth.application.services.auth_service - INFO - [REFRESH] Token validado exitosamente (BD OK) para usuario: superadmin (Cliente: BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, Level: 5, Type: super_admin)
2025-12-03 21:02:01,623 - app.modules.auth.application.services.auth_service - INFO - Niveles calculados - Usuario 154134AD-A5EB-4F45-AEF0-5F9AAA282C8E: level=5, super_admin=True, type=super_admin
2025-12-03 21:02:01,627 - app.modules.auth.application.services.refresh_token_service - INFO - [STORE-TOKEN-ROTATION] Token ya existe en BD (doble refresh detectado) - Cliente BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, Usuario 154134AD-A5EB-4F45-AEF0-5F9AAA282C8E, Token ID: 0021B43D-E1DD-4923-926E-60D2BD16C373
2025-12-03 21:02:01,627 - app.modules.auth.presentation.endpoints - INFO - [REFRESH-WEB] Token rotado exitosamente - ID: 0021B43D-E1DD-4923-926E-60D2BD16C373
2025-12-03 21:02:01,628 - app.modules.auth.presentation.endpoints - INFO - [REFRESH-WEB] Token refrescado exitosamente - Usuario: superadmin
2025-12-03 21:02:01,629 - app.modules.superadmin.application.services.audit_service - INFO - [AUDIT] auth_audit_log registrado: evento=token_refresh, cliente_id=BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, usuario_id=154134AD-A5EB-4F45-AEF0-5F9AAA282C8E, exito=True
2025-12-03 21:02:01,629 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/refresh/ 200 28.6ms
2025-12-03 21:02:01,636 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/auth/me/
2025-12-03 21:02:01,637 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 21:02:01,638 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 21:02:01,638 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:02:01,639 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:02:01,639 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:02:01,640 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:02:01,640 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:02:01,642 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:02:01,642 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:02:01,642 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 21:02:01,643 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/auth/me/
2025-12-03 21:02:01,644 - app.modules.auth.application.services.auth_service - WARNING - [SECURITY] Token de tenant BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7 usado en tenant bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7. Usuario: superadmin
2025-12-03 21:02:01,644 - app.modules.auth.application.services.auth_service - ERROR - Error procesando payload del token: 403: Token no válido para este tenant. Por favor, inicie sesión nuevamente.
2025-12-03 21:02:01,645 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/auth/me/ 401 8.1ms
2025-12-03 21:02:56,027 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Pool ADMIN inicializado. Size=10, MaxOverflow=5
2025-12-03 21:02:56,027 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Configuración de pools de tenants: MaxPools=50, PoolSize=3, MaxOverflow=2, InactivityTimeout=3600s
2025-12-03 21:02:56,027 - app.infrastructure.database.connection_pool - INFO - ✅ Módulo de connection pooling cargado y activo
2025-12-03 21:02:56,027 - app.infrastructure.database.connection_pool - INFO -    Configuración: MaxTenantPools=50, TenantPoolSize=3, InactivityTimeout=3600s
2025-12-03 21:02:56,027 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Todos los pools cerrados
2025-12-03 21:02:56,027 - app.main - INFO - ✅ Pools de conexión cerrados correctamente
2025-12-03 21:03:00,937 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 21:03:01,147 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 21:03:01,147 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 21:03:01,157 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 21:03:01,159 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 21:03:01,160 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 21:03:01,160 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 21:03:01,161 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, DEFAULT_TYPE=single
2025-12-03 21:03:01,477 - app.core.security.rate_limiting - INFO - [RATE_LIMITING] Activado. Límites: Login=10/minute, API=200/minute
2025-12-03 21:03:01,477 - app.core.security.rate_limiting - INFO - ✅ Módulo de rate limiting cargado y activo
2025-12-03 21:03:01,551 - app.core.authorization.rbac - INFO - 🔐 Inicializando sistema de autorización...
2025-12-03 21:03:01,551 - app.core.authorization.rbac - INFO - ✅ Sistema de autorización inicializado correctamente
2025-12-03 21:03:01,551 - app.core.authorization.rbac - INFO - 📊 Permisos del sistema: 6 módulos configurados
2025-12-03 21:03:01,707 - app.core.tenant.middleware - INFO - Módulo tenant_middleware cargado (versión híbrida con soporte para proxies)
2025-12-03 21:03:01,708 - app.main - INFO - ✅ Rate limiting configurado y activo
2025-12-03 21:03:01,848 - app.core.tenant.middleware - INFO - [TENANT_MW] Inicializado - BASE_DOMAIN=app.local, SYSTEM_ID=BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, EXCLUDED_SUBDOMAINS={'backend', 'cdn', 'api', 'www', 'admin', 'assets', 'static'}
2025-12-03 21:03:18,384 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/auth/login/
2025-12-03 21:03:18,385 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/auth/login/ 200 1.3ms
2025-12-03 21:03:18,388 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/login/
2025-12-03 21:03:18,389 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 21:03:18,389 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 21:03:18,390 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:03:18,390 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:03:18,391 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:03:18,391 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:03:18,392 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:03:18,392 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:03:18,392 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:03:18,392 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 21:03:18,392 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/auth/login/
2025-12-03 21:03:18,397 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] AsyncEngine creado para admin
2025-12-03 21:03:18,551 - app.modules.auth.presentation.endpoints - INFO - Cliente bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7 resuelto y validado para login.
2025-12-03 21:03:18,551 - app.modules.auth.application.services.auth_service - INFO - [AUTH] Intento de login: username='superadmin', cliente_id_destino=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:03:18,551 - app.modules.auth.application.services.auth_service - INFO - [AUTH] SUPERADMIN detectado. Buscando en BD ADMIN (cliente_id=BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7), accediendo a cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:03:18,797 - app.modules.auth.application.services.auth_service - INFO - Niveles calculados - Usuario 154134AD-A5EB-4F45-AEF0-5F9AAA282C8E: level=5, super_admin=True, type=super_admin
2025-12-03 21:03:18,797 - app.modules.auth.application.services.auth_service - INFO - [AUTH] Login exitoso: username='superadmin', usuario_id=154134AD-A5EB-4F45-AEF0-5F9AAA282C8E, cliente_origen=BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, cliente_destino=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, access_level=5, user_type=super_admin
2025-12-03 21:03:18,797 - app.modules.auth.presentation.endpoints - INFO - [LOGIN] Superadmin accediendo a cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:03:18,802 - app.modules.auth.application.services.auth_service - INFO - Niveles calculados - Usuario 154134AD-A5EB-4F45-AEF0-5F9AAA282C8E: level=5, super_admin=True, type=super_admin
2025-12-03 21:03:18,812 - app.modules.auth.application.services.refresh_token_service - INFO - [STORE-TOKEN] Token insertado exitosamente - Cliente bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, Usuario 154134AD-A5EB-4F45-AEF0-5F9AAA282C8E, Tipo: web, Token ID: C1E7E190-04DA-4756-9953-4091D1F73778, Rotación: False
2025-12-03 21:03:18,812 - app.modules.auth.presentation.endpoints - INFO - [LOGIN-WEB] Token almacenado - ID: C1E7E190-04DA-4756-9953-4091D1F73778
2025-12-03 21:03:18,812 - app.modules.auth.presentation.endpoints - INFO - Usuario superadmin autenticado exitosamente (WEB) para cliente bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:03:18,827 - app.modules.superadmin.application.services.audit_service - INFO - [AUDIT] auth_audit_log registrado: evento=login_success, cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, usuario_id=154134AD-A5EB-4F45-AEF0-5F9AAA282C8E, exito=True
2025-12-03 21:03:18,833 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/login/ 200 445.2ms
2025-12-03 21:03:18,839 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/clientes/tenant/branding
2025-12-03 21:03:18,839 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/clientes/tenant/branding 200 1.0ms
2025-12-03 21:03:18,845 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/clientes/tenant/branding
2025-12-03 21:03:18,847 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 21:03:18,847 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 21:03:18,848 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:03:18,848 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:03:18,849 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:03:18,850 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:03:18,850 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:03:18,851 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:03:18,852 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:03:18,853 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 21:03:18,853 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/clientes/tenant/branding
2025-12-03 21:03:18,862 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/menus/getmenu/
2025-12-03 21:03:18,863 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/menus/getmenu/ 200 2.2ms
2025-12-03 21:03:18,863 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/menus/getmenu/
2025-12-03 21:03:18,868 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/menus/getmenu/ 200 2.2ms
2025-12-03 21:03:18,871 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/menus/getmenu/
2025-12-03 21:03:18,875 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 21:03:18,875 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 21:03:18,877 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:03:18,878 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:03:18,878 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:03:18,879 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:03:18,879 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:03:18,879 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:03:18,880 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:03:18,881 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 21:03:18,881 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/menus/getmenu/
2025-12-03 21:03:18,937 - app.modules.tenant.presentation.endpoints_clientes - INFO - Solicitud GET /tenant/branding recibida para cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7 por usuario: superadmin
2025-12-03 21:03:18,937 - app.modules.tenant.application.services.cliente_service - INFO - Solicitando branding para cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:03:18,937 - app.modules.menus.presentation.endpoints - INFO - Solicitud GET /menus/getmenu/ recibida para usuario ID: 154134ad-a5eb-4f45-aef0-5f9aaa282c8e del cliente bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:03:18,937 - app.modules.menus.application.services.menu_service - INFO - Obteniendo menú filtrado para usuario_id: 154134ad-a5eb-4f45-aef0-5f9aaa282c8e
2025-12-03 21:03:18,947 - app.modules.tenant.application.services.cliente_service - INFO - Branding obtenido exitosamente para cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:03:18,947 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/clientes/tenant/branding 200 103.5ms
2025-12-03 21:03:19,006 - app.modules.menus.application.services.menu_service - INFO - No se encontraron menús permitidos para el usuario ID: 154134ad-a5eb-4f45-aef0-5f9aaa282c8e.
2025-12-03 21:03:19,007 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/menus/getmenu/ 200 135.1ms
2025-12-03 21:03:19,009 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/menus/getmenu/
2025-12-03 21:03:19,010 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 21:03:19,010 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 21:03:19,011 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:03:19,011 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:03:19,012 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:03:19,012 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:03:19,013 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:03:19,013 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:03:19,014 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:03:19,015 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 21:03:19,015 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/menus/getmenu/
2025-12-03 21:03:19,055 - app.modules.menus.presentation.endpoints - INFO - Solicitud GET /menus/getmenu/ recibida para usuario ID: 154134ad-a5eb-4f45-aef0-5f9aaa282c8e del cliente bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:03:19,057 - app.modules.menus.application.services.menu_service - INFO - Obteniendo menú filtrado para usuario_id: 154134ad-a5eb-4f45-aef0-5f9aaa282c8e
2025-12-03 21:03:19,062 - app.modules.menus.application.services.menu_service - INFO - No se encontraron menús permitidos para el usuario ID: 154134ad-a5eb-4f45-aef0-5f9aaa282c8e.
2025-12-03 21:03:19,063 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/menus/getmenu/ 200 54.0ms
2025-12-03 21:03:46,502 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/auth/refresh/
2025-12-03 21:03:46,502 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/auth/refresh/ 200 1.2ms
2025-12-03 21:03:46,505 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/refresh/
2025-12-03 21:03:46,505 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 21:03:46,505 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 21:03:46,507 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:03:46,508 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:03:46,508 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:03:46,509 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:03:46,509 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:03:46,510 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:03:46,511 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:03:46,511 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 21:03:46,511 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/auth/refresh/
2025-12-03 21:03:46,517 - app.modules.auth.application.services.refresh_token_service - INFO - [VALIDATE-TOKEN] Token válido - Cliente BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, Usuario 154134AD-A5EB-4F45-AEF0-5F9AAA282C8E, Tipo: web
2025-12-03 21:03:46,528 - app.modules.auth.application.services.auth_service - INFO - [REFRESH] Token validado exitosamente (BD OK) para usuario: superadmin (Cliente: BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, Level: 5, Type: super_admin)
2025-12-03 21:03:46,532 - app.modules.auth.application.services.auth_service - INFO - Niveles calculados - Usuario 154134AD-A5EB-4F45-AEF0-5F9AAA282C8E: level=5, super_admin=True, type=super_admin
2025-12-03 21:03:46,548 - app.modules.auth.application.services.refresh_token_service - INFO - [STORE-TOKEN] Token insertado exitosamente - Cliente BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, Usuario 154134AD-A5EB-4F45-AEF0-5F9AAA282C8E, Tipo: web, Token ID: 7E96DD89-4D49-493C-BF84-980462CC53C6, Rotación: True
2025-12-03 21:03:46,557 - app.modules.auth.application.services.refresh_token_service - WARNING - [REVOKE-TOKEN] Token no encontrado o ya revocado - Cliente BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, Usuario 154134AD-A5EB-4F45-AEF0-5F9AAA282C8E
2025-12-03 21:03:46,557 - app.modules.auth.presentation.endpoints - WARNING - [REFRESH] Token antiguo no encontrado para revocar (no crítico)
2025-12-03 21:03:46,557 - app.modules.auth.presentation.endpoints - INFO - [REFRESH-WEB] Token rotado exitosamente - ID: 7E96DD89-4D49-493C-BF84-980462CC53C6
2025-12-03 21:03:46,560 - app.modules.auth.presentation.endpoints - INFO - [REFRESH-WEB] Token refrescado exitosamente - Usuario: superadmin
2025-12-03 21:03:46,569 - app.modules.superadmin.application.services.audit_service - INFO - [AUDIT] auth_audit_log registrado: evento=token_refresh, cliente_id=BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, usuario_id=154134AD-A5EB-4F45-AEF0-5F9AAA282C8E, exito=True
2025-12-03 21:03:46,570 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/refresh/ 200 65.7ms
2025-12-03 21:03:46,574 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/auth/me/
2025-12-03 21:03:46,576 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 21:03:46,576 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 21:03:46,576 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:03:46,577 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:03:46,577 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:03:46,577 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:03:46,578 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:03:46,578 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:03:46,579 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:03:46,579 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 21:03:46,580 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/auth/me/
2025-12-03 21:03:46,581 - app.modules.auth.application.services.auth_service - WARNING - [SECURITY] Token de tenant BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7 usado en tenant bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7. Usuario: superadmin
2025-12-03 21:03:46,582 - app.modules.auth.application.services.auth_service - ERROR - Error procesando payload del token: 403: Token no válido para este tenant. Por favor, inicie sesión nuevamente.
2025-12-03 21:03:46,582 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/auth/me/ 401 7.9ms
2025-12-03 21:03:46,586 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/refresh/
2025-12-03 21:03:46,587 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 21:03:46,588 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 21:03:46,588 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:03:46,588 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:03:46,588 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:03:46,588 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:03:46,588 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:03:46,588 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:03:46,588 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:03:46,588 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 21:03:46,588 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/auth/refresh/
2025-12-03 21:03:46,599 - app.modules.auth.application.services.refresh_token_service - INFO - [VALIDATE-TOKEN] Token válido - Cliente BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, Usuario 154134AD-A5EB-4F45-AEF0-5F9AAA282C8E, Tipo: web
2025-12-03 21:03:46,601 - app.modules.auth.application.services.auth_service - INFO - [REFRESH] Token validado exitosamente (BD OK) para usuario: superadmin (Cliente: BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, Level: 5, Type: super_admin)
2025-12-03 21:03:46,604 - app.modules.auth.application.services.auth_service - INFO - Niveles calculados - Usuario 154134AD-A5EB-4F45-AEF0-5F9AAA282C8E: level=5, super_admin=True, type=super_admin
2025-12-03 21:03:46,609 - app.modules.auth.application.services.refresh_token_service - INFO - [STORE-TOKEN-ROTATION] Token ya existe en BD (doble refresh detectado) - Cliente BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, Usuario 154134AD-A5EB-4F45-AEF0-5F9AAA282C8E, Token ID: 7E96DD89-4D49-493C-BF84-980462CC53C6
2025-12-03 21:03:46,609 - app.modules.auth.presentation.endpoints - INFO - [REFRESH-WEB] Token rotado exitosamente - ID: 7E96DD89-4D49-493C-BF84-980462CC53C6
2025-12-03 21:03:46,610 - app.modules.auth.presentation.endpoints - INFO - [REFRESH-WEB] Token refrescado exitosamente - Usuario: superadmin
2025-12-03 21:03:46,614 - app.modules.superadmin.application.services.audit_service - INFO - [AUDIT] auth_audit_log registrado: evento=token_refresh, cliente_id=BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, usuario_id=154134AD-A5EB-4F45-AEF0-5F9AAA282C8E, exito=True
2025-12-03 21:03:46,615 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/refresh/ 200 29.0ms
2025-12-03 21:03:46,618 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/auth/me/
2025-12-03 21:03:46,619 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 21:03:46,620 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 21:03:46,621 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:03:46,621 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:03:46,621 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:03:46,621 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:03:46,621 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:03:46,621 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:03:46,621 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:03:46,621 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 21:03:46,621 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/auth/me/
2025-12-03 21:03:46,621 - app.modules.auth.application.services.auth_service - WARNING - [SECURITY] Token de tenant BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7 usado en tenant bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7. Usuario: superadmin
2025-12-03 21:03:46,621 - app.modules.auth.application.services.auth_service - ERROR - Error procesando payload del token: 403: Token no válido para este tenant. Por favor, inicie sesión nuevamente.
2025-12-03 21:03:46,626 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/auth/me/ 401 6.9ms
2025-12-03 21:05:36,088 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 21:05:36,322 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 21:05:36,337 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 21:05:36,339 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 21:05:36,340 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 21:05:36,341 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 21:05:36,341 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 21:05:36,342 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, DEFAULT_TYPE=single
2025-12-03 21:05:36,773 - app.core.security.rate_limiting - INFO - [RATE_LIMITING] Activado. Límites: Login=10/minute, API=200/minute
2025-12-03 21:05:36,774 - app.core.security.rate_limiting - INFO - ✅ Módulo de rate limiting cargado y activo
2025-12-03 21:05:36,849 - app.core.authorization.rbac - INFO - 🔐 Inicializando sistema de autorización...
2025-12-03 21:05:36,849 - app.core.authorization.rbac - INFO - ✅ Sistema de autorización inicializado correctamente
2025-12-03 21:05:36,849 - app.core.authorization.rbac - INFO - 📊 Permisos del sistema: 6 módulos configurados
2025-12-03 21:05:37,069 - app.core.tenant.middleware - INFO - Módulo tenant_middleware cargado (versión híbrida con soporte para proxies)
2025-12-03 21:05:37,069 - app.main - INFO - ✅ Rate limiting configurado y activo
2025-12-03 21:05:37,253 - app.core.tenant.middleware - INFO - [TENANT_MW] Inicializado - BASE_DOMAIN=app.local, SYSTEM_ID=BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, EXCLUDED_SUBDOMAINS={'www', 'assets', 'admin', 'cdn', 'static', 'api', 'backend'}
2025-12-03 21:05:56,202 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Pool ADMIN inicializado. Size=10, MaxOverflow=5
2025-12-03 21:05:56,203 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Configuración de pools de tenants: MaxPools=50, PoolSize=3, MaxOverflow=2, InactivityTimeout=3600s
2025-12-03 21:05:56,203 - app.infrastructure.database.connection_pool - INFO - ✅ Módulo de connection pooling cargado y activo
2025-12-03 21:05:56,204 - app.infrastructure.database.connection_pool - INFO -    Configuración: MaxTenantPools=50, TenantPoolSize=3, InactivityTimeout=3600s
2025-12-03 21:05:56,204 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Todos los pools cerrados
2025-12-03 21:05:56,204 - app.main - INFO - ✅ Pools de conexión cerrados correctamente
2025-12-03 21:05:57,029 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 21:05:57,230 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 21:05:57,230 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 21:05:57,243 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 21:05:57,243 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 21:05:57,244 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 21:05:57,244 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 21:05:57,245 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, DEFAULT_TYPE=single
2025-12-03 21:05:57,572 - app.core.security.rate_limiting - INFO - [RATE_LIMITING] Activado. Límites: Login=10/minute, API=200/minute
2025-12-03 21:05:57,572 - app.core.security.rate_limiting - INFO - ✅ Módulo de rate limiting cargado y activo
2025-12-03 21:05:57,649 - app.core.authorization.rbac - INFO - 🔐 Inicializando sistema de autorización...
2025-12-03 21:05:57,649 - app.core.authorization.rbac - INFO - ✅ Sistema de autorización inicializado correctamente
2025-12-03 21:05:57,649 - app.core.authorization.rbac - INFO - 📊 Permisos del sistema: 6 módulos configurados
2025-12-03 21:05:57,817 - app.core.tenant.middleware - INFO - Módulo tenant_middleware cargado (versión híbrida con soporte para proxies)
2025-12-03 21:05:57,818 - app.main - INFO - ✅ Rate limiting configurado y activo
2025-12-03 21:05:57,969 - app.core.tenant.middleware - INFO - [TENANT_MW] Inicializado - BASE_DOMAIN=app.local, SYSTEM_ID=BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, EXCLUDED_SUBDOMAINS={'admin', 'backend', 'static', 'cdn', 'assets', 'api', 'www'}
2025-12-03 21:06:01,701 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Pool ADMIN inicializado. Size=10, MaxOverflow=5
2025-12-03 21:06:01,701 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Configuración de pools de tenants: MaxPools=50, PoolSize=3, MaxOverflow=2, InactivityTimeout=3600s
2025-12-03 21:06:01,701 - app.infrastructure.database.connection_pool - INFO - ✅ Módulo de connection pooling cargado y activo
2025-12-03 21:06:01,701 - app.infrastructure.database.connection_pool - INFO -    Configuración: MaxTenantPools=50, TenantPoolSize=3, InactivityTimeout=3600s
2025-12-03 21:06:01,701 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Todos los pools cerrados
2025-12-03 21:06:01,701 - app.main - INFO - ✅ Pools de conexión cerrados correctamente
2025-12-03 21:06:03,462 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 21:06:03,659 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 21:06:03,668 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 21:06:03,671 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 21:06:03,672 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 21:06:03,673 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 21:06:03,673 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 21:06:03,673 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, DEFAULT_TYPE=single
2025-12-03 21:06:04,009 - app.core.security.rate_limiting - INFO - [RATE_LIMITING] Activado. Límites: Login=10/minute, API=200/minute
2025-12-03 21:06:04,009 - app.core.security.rate_limiting - INFO - ✅ Módulo de rate limiting cargado y activo
2025-12-03 21:06:04,082 - app.core.authorization.rbac - INFO - 🔐 Inicializando sistema de autorización...
2025-12-03 21:06:04,082 - app.core.authorization.rbac - INFO - ✅ Sistema de autorización inicializado correctamente
2025-12-03 21:06:04,082 - app.core.authorization.rbac - INFO - 📊 Permisos del sistema: 6 módulos configurados
2025-12-03 21:06:04,249 - app.core.tenant.middleware - INFO - Módulo tenant_middleware cargado (versión híbrida con soporte para proxies)
2025-12-03 21:06:04,251 - app.main - INFO - ✅ Rate limiting configurado y activo
2025-12-03 21:06:04,399 - app.core.tenant.middleware - INFO - [TENANT_MW] Inicializado - BASE_DOMAIN=app.local, SYSTEM_ID=BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, EXCLUDED_SUBDOMAINS={'www', 'api', 'backend', 'static', 'cdn', 'assets', 'admin'}
2025-12-03 21:06:16,168 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/login/
2025-12-03 21:06:16,170 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 21:06:16,170 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 21:06:16,171 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:06:16,171 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:06:16,171 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:06:16,172 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:06:16,172 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:06:16,173 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:06:16,173 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:06:16,173 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 21:06:16,173 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/auth/login/
2025-12-03 21:06:16,178 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] AsyncEngine creado para admin
2025-12-03 21:06:16,334 - app.modules.auth.presentation.endpoints - INFO - Cliente bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7 resuelto y validado para login.
2025-12-03 21:06:16,334 - app.modules.auth.application.services.auth_service - INFO - [AUTH] Intento de login: username='superadmin', cliente_id_destino=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:06:16,334 - app.modules.auth.application.services.auth_service - INFO - [AUTH] SUPERADMIN detectado. Buscando en BD ADMIN (cliente_id=BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7), accediendo a cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:06:16,578 - app.modules.auth.application.services.auth_service - INFO - Niveles calculados - Usuario 154134AD-A5EB-4F45-AEF0-5F9AAA282C8E: level=5, super_admin=True, type=super_admin
2025-12-03 21:06:16,579 - app.modules.auth.application.services.auth_service - INFO - [AUTH] Login exitoso: username='superadmin', usuario_id=154134AD-A5EB-4F45-AEF0-5F9AAA282C8E, cliente_origen=BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, cliente_destino=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, access_level=5, user_type=super_admin
2025-12-03 21:06:16,579 - app.modules.auth.presentation.endpoints - INFO - [LOGIN] Superadmin accediendo a cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:06:16,588 - app.modules.auth.application.services.auth_service - INFO - Niveles calculados - Usuario 154134AD-A5EB-4F45-AEF0-5F9AAA282C8E: level=5, super_admin=True, type=super_admin
2025-12-03 21:06:16,598 - app.modules.auth.application.services.refresh_token_service - INFO - [STORE-TOKEN] Token insertado exitosamente - Cliente bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, Usuario 154134AD-A5EB-4F45-AEF0-5F9AAA282C8E, Tipo: web, Token ID: 9322142F-01AC-4DAD-A7A9-206BD5031891, Rotación: False
2025-12-03 21:06:16,600 - app.modules.auth.presentation.endpoints - INFO - [LOGIN-WEB] Token almacenado - ID: 9322142F-01AC-4DAD-A7A9-206BD5031891
2025-12-03 21:06:16,600 - app.modules.auth.presentation.endpoints - INFO - Usuario superadmin autenticado exitosamente (WEB) para cliente bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:06:16,614 - app.modules.superadmin.application.services.audit_service - INFO - [AUDIT] auth_audit_log registrado: evento=login_success, cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, usuario_id=154134AD-A5EB-4F45-AEF0-5F9AAA282C8E, exito=True
2025-12-03 21:06:16,615 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/login/ 200 447.4ms
2025-12-03 21:06:16,619 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/clientes/tenant/branding
2025-12-03 21:06:16,619 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 21:06:16,619 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 21:06:16,628 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:06:16,628 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:06:16,628 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:06:16,629 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:06:16,629 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:06:16,631 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:06:16,631 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:06:16,632 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 21:06:16,632 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/clientes/tenant/branding
2025-12-03 21:06:16,643 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/menus/getmenu/
2025-12-03 21:06:16,645 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 21:06:16,646 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 21:06:16,647 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:06:16,647 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:06:16,647 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:06:16,649 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:06:16,649 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:06:16,650 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:06:16,650 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:06:16,651 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 21:06:16,652 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/menus/getmenu/
2025-12-03 21:06:16,687 - app.modules.tenant.presentation.endpoints_clientes - INFO - Solicitud GET /tenant/branding recibida para cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7 por usuario: superadmin
2025-12-03 21:06:16,687 - app.modules.tenant.application.services.cliente_service - INFO - Solicitando branding para cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:06:16,690 - app.modules.menus.presentation.endpoints - INFO - Solicitud GET /menus/getmenu/ recibida para usuario ID: 154134ad-a5eb-4f45-aef0-5f9aaa282c8e del cliente bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:06:16,690 - app.modules.menus.application.services.menu_service - INFO - Obteniendo menú filtrado para usuario_id: 154134ad-a5eb-4f45-aef0-5f9aaa282c8e
2025-12-03 21:06:16,690 - app.modules.tenant.application.services.cliente_service - INFO - Branding obtenido exitosamente para cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:06:16,690 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/clientes/tenant/branding 200 70.1ms
2025-12-03 21:06:16,699 - app.modules.menus.application.services.menu_service - INFO - No se encontraron menús permitidos para el usuario ID: 154134ad-a5eb-4f45-aef0-5f9aaa282c8e.
2025-12-03 21:06:16,700 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/menus/getmenu/ 200 57.4ms
2025-12-03 21:06:16,704 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/menus/getmenu/
2025-12-03 21:06:16,705 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 21:06:16,705 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 21:06:16,705 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:06:16,706 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:06:16,706 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:06:16,707 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:06:16,707 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:06:16,708 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:06:16,708 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:06:16,708 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 21:06:16,710 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/menus/getmenu/
2025-12-03 21:06:16,727 - app.modules.menus.presentation.endpoints - INFO - Solicitud GET /menus/getmenu/ recibida para usuario ID: 154134ad-a5eb-4f45-aef0-5f9aaa282c8e del cliente bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:06:16,728 - app.modules.menus.application.services.menu_service - INFO - Obteniendo menú filtrado para usuario_id: 154134ad-a5eb-4f45-aef0-5f9aaa282c8e
2025-12-03 21:06:16,731 - app.modules.menus.application.services.menu_service - INFO - No se encontraron menús permitidos para el usuario ID: 154134ad-a5eb-4f45-aef0-5f9aaa282c8e.
2025-12-03 21:06:16,731 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/menus/getmenu/ 200 27.9ms
2025-12-03 21:06:30,744 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/refresh/
2025-12-03 21:06:30,744 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 21:06:30,744 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 21:06:30,744 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:06:30,744 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:06:30,744 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:06:30,748 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:06:30,748 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:06:30,748 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:06:30,748 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:06:30,748 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 21:06:30,750 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/auth/refresh/
2025-12-03 21:06:30,756 - app.modules.auth.application.services.refresh_token_service - INFO - [VALIDATE-TOKEN] Token válido - Cliente BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, Usuario 154134AD-A5EB-4F45-AEF0-5F9AAA282C8E, Tipo: web
2025-12-03 21:06:30,765 - app.modules.auth.application.services.auth_service - INFO - [REFRESH] Token validado exitosamente (BD OK) para usuario: superadmin (Cliente: BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, Level: 5, Type: super_admin)
2025-12-03 21:06:30,767 - app.modules.auth.application.services.auth_service - INFO - Niveles calculados - Usuario 154134AD-A5EB-4F45-AEF0-5F9AAA282C8E: level=5, super_admin=True, type=super_admin
2025-12-03 21:06:30,778 - app.modules.auth.application.services.refresh_token_service - INFO - [STORE-TOKEN] Token insertado exitosamente - Cliente BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, Usuario 154134AD-A5EB-4F45-AEF0-5F9AAA282C8E, Tipo: web, Token ID: FFA6D240-6229-4098-B88E-2661F19D7CA7, Rotación: True
2025-12-03 21:06:30,786 - app.modules.auth.application.services.refresh_token_service - WARNING - [REVOKE-TOKEN] Token no encontrado o ya revocado - Cliente BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, Usuario 154134AD-A5EB-4F45-AEF0-5F9AAA282C8E
2025-12-03 21:06:30,786 - app.modules.auth.presentation.endpoints - WARNING - [REFRESH] Token antiguo no encontrado para revocar (no crítico)
2025-12-03 21:06:30,786 - app.modules.auth.presentation.endpoints - INFO - [REFRESH-WEB] Token rotado exitosamente - ID: FFA6D240-6229-4098-B88E-2661F19D7CA7
2025-12-03 21:06:30,790 - app.modules.auth.presentation.endpoints - INFO - [REFRESH-WEB] Token refrescado exitosamente - Usuario: superadmin
2025-12-03 21:06:30,795 - app.modules.superadmin.application.services.audit_service - INFO - [AUDIT] auth_audit_log registrado: evento=token_refresh, cliente_id=BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, usuario_id=154134AD-A5EB-4F45-AEF0-5F9AAA282C8E, exito=True
2025-12-03 21:06:30,795 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/refresh/ 200 52.9ms
2025-12-03 21:06:30,801 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/auth/me/
2025-12-03 21:06:30,802 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/auth/me/ 200 0.9ms
2025-12-03 21:06:30,804 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/auth/me/
2025-12-03 21:06:30,804 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 21:06:30,805 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 21:06:30,805 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:06:30,806 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:06:30,806 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:06:30,806 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:06:30,806 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:06:30,808 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:06:30,808 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:06:30,809 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 21:06:30,809 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/auth/me/
2025-12-03 21:06:30,813 - app.infrastructure.database.queries_async - ERROR - Error en execute_auth_query async (string): (sqlalchemy.exc.InvalidRequestError) A value is required for bind parameter 'username'
[SQL: 
        SELECT usuario_id, cliente_id, nombre_usuario, correo, nombre, apellido, es_activo
        FROM usuario
        WHERE nombre_usuario = ? AND es_eliminado = 0
        ]
[parameters: [{}]]
(Background on this error at: https://sqlalche.me/e/20/cd3x)
2025-12-03 21:06:30,815 - app.infrastructure.database.connection_async - ERROR - [ASYNC_CONNECTION] Error en sesión async: Error en la autenticación: (sqlalchemy.exc.InvalidRequestError) A value is required for bind parameter 'username'
[SQL: 
        SELECT usuario_id, cliente_id, nombre_usuario, correo, nombre, apellido, es_activo
        FROM usuario
        WHERE nombre_usuario = ? AND es_eliminado = 0
        ]
[parameters: [{}]]
(Background on this error at: https://sqlalche.me/e/20/cd3x)
Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1815, in _execute_context
    context = constructor(
              ^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\default.py", line 1414, in _init_compiled
    compiled.construct_params(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\sql\compiler.py", line 1947, in construct_params
    raise exc.InvalidRequestError(
sqlalchemy.exc.InvalidRequestError: A value is required for bind parameter 'username' (Background on this error at: https://sqlalche.me/e/20/cd3x)

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 250, in execute_auth_query
    result = await session.execute(query)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 449, in execute
    result = await greenlet_spawn(
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 203, in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2351, in execute
    return self._execute_internal(
           ^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2258, in _execute_internal
    result = conn.execute(
             ^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1419, in execute
    return meth(
           ^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\sql\elements.py", line 526, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1641, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1821, in _execute_context
    self._handle_dbapi_exception(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 2355, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1815, in _execute_context
    context = constructor(
              ^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\default.py", line 1414, in _init_compiled
    compiled.construct_params(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\sql\compiler.py", line 1947, in construct_params
    raise exc.InvalidRequestError(
sqlalchemy.exc.StatementError: (sqlalchemy.exc.InvalidRequestError) A value is required for bind parameter 'username'
[SQL: 
        SELECT usuario_id, cliente_id, nombre_usuario, correo, nombre, apellido, es_activo
        FROM usuario
        WHERE nombre_usuario = ? AND es_eliminado = 0
        ]
[parameters: [{}]]
(Background on this error at: https://sqlalche.me/e/20/cd3x)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\connection_async.py", line 303, in get_db_connection
    yield session
  File "D:\base_multi_tenant_fastapi\app\core\tenant\routing.py", line 672, in get_connection_for_tenant
    yield session
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 260, in execute_auth_query
    raise DatabaseError(
app.core.exceptions.DatabaseError: Error en la autenticación: (sqlalchemy.exc.InvalidRequestError) A value is required for bind parameter 'username'
[SQL: 
        SELECT usuario_id, cliente_id, nombre_usuario, correo, nombre, apellido, es_activo
        FROM usuario
        WHERE nombre_usuario = ? AND es_eliminado = 0
        ]
[parameters: [{}]]
(Background on this error at: https://sqlalche.me/e/20/cd3x)
2025-12-03 21:06:30,845 - app.core.exceptions - ERROR - CustomException: DB_AUTH_ERROR - Error en la autenticación: (sqlalchemy.exc.InvalidRequestError) A value is required for bind parameter 'username'
[SQL: 
        SELECT usuario_id, cliente_id, nombre_usuario, correo, nombre, apellido, es_activo
        FROM usuario
        WHERE nombre_usuario = ? AND es_eliminado = 0
        ]
[parameters: [{}]]
(Background on this error at: https://sqlalche.me/e/20/cd3x) | Path: /api/v1/auth/me/ | Method: GET
2025-12-03 21:06:30,848 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/auth/me/ 500 43.9ms
2025-12-03 21:10:35,404 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Pool ADMIN inicializado. Size=10, MaxOverflow=5
2025-12-03 21:10:35,404 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Configuración de pools de tenants: MaxPools=50, PoolSize=3, MaxOverflow=2, InactivityTimeout=3600s
2025-12-03 21:10:35,404 - app.infrastructure.database.connection_pool - INFO - ✅ Módulo de connection pooling cargado y activo
2025-12-03 21:10:35,404 - app.infrastructure.database.connection_pool - INFO -    Configuración: MaxTenantPools=50, TenantPoolSize=3, InactivityTimeout=3600s
2025-12-03 21:10:35,407 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Todos los pools cerrados
2025-12-03 21:10:35,408 - app.main - INFO - ✅ Pools de conexión cerrados correctamente
2025-12-03 21:10:36,473 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 21:10:36,684 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 21:10:36,694 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 21:10:36,694 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 21:10:36,694 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 21:10:36,699 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 21:10:36,699 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 21:10:36,699 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, DEFAULT_TYPE=single
2025-12-03 21:10:37,135 - app.core.security.rate_limiting - INFO - [RATE_LIMITING] Activado. Límites: Login=10/minute, API=200/minute
2025-12-03 21:10:37,135 - app.core.security.rate_limiting - INFO - ✅ Módulo de rate limiting cargado y activo
2025-12-03 21:10:37,238 - app.core.authorization.rbac - INFO - 🔐 Inicializando sistema de autorización...
2025-12-03 21:10:37,238 - app.core.authorization.rbac - INFO - ✅ Sistema de autorización inicializado correctamente
2025-12-03 21:10:37,238 - app.core.authorization.rbac - INFO - 📊 Permisos del sistema: 6 módulos configurados
2025-12-03 21:10:37,488 - app.core.tenant.middleware - INFO - Módulo tenant_middleware cargado (versión híbrida con soporte para proxies)
2025-12-03 21:10:37,488 - app.main - INFO - ✅ Rate limiting configurado y activo
2025-12-03 21:10:37,643 - app.core.tenant.middleware - INFO - [TENANT_MW] Inicializado - BASE_DOMAIN=app.local, SYSTEM_ID=BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, EXCLUDED_SUBDOMAINS={'api', 'backend', 'static', 'www', 'admin', 'cdn', 'assets'}
2025-12-03 21:12:14,135 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Pool ADMIN inicializado. Size=10, MaxOverflow=5
2025-12-03 21:12:14,135 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Configuración de pools de tenants: MaxPools=50, PoolSize=3, MaxOverflow=2, InactivityTimeout=3600s
2025-12-03 21:12:14,136 - app.infrastructure.database.connection_pool - INFO - ✅ Módulo de connection pooling cargado y activo
2025-12-03 21:12:14,136 - app.infrastructure.database.connection_pool - INFO -    Configuración: MaxTenantPools=50, TenantPoolSize=3, InactivityTimeout=3600s
2025-12-03 21:12:14,137 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Todos los pools cerrados
2025-12-03 21:12:14,137 - app.main - INFO - ✅ Pools de conexión cerrados correctamente
2025-12-03 21:12:14,947 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 21:12:15,139 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 21:12:15,148 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 21:12:15,156 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 21:12:15,158 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 21:12:15,159 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 21:12:15,159 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 21:12:15,160 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, DEFAULT_TYPE=single
2025-12-03 21:12:15,478 - app.core.security.rate_limiting - INFO - [RATE_LIMITING] Activado. Límites: Login=10/minute, API=200/minute
2025-12-03 21:12:15,478 - app.core.security.rate_limiting - INFO - ✅ Módulo de rate limiting cargado y activo
2025-12-03 21:12:15,560 - app.core.authorization.rbac - INFO - 🔐 Inicializando sistema de autorización...
2025-12-03 21:12:15,560 - app.core.authorization.rbac - INFO - ✅ Sistema de autorización inicializado correctamente
2025-12-03 21:12:15,561 - app.core.authorization.rbac - INFO - 📊 Permisos del sistema: 6 módulos configurados
2025-12-03 21:12:15,765 - app.core.tenant.middleware - INFO - Módulo tenant_middleware cargado (versión híbrida con soporte para proxies)
2025-12-03 21:12:15,775 - app.main - INFO - ✅ Rate limiting configurado y activo
2025-12-03 21:12:15,915 - app.core.tenant.middleware - INFO - [TENANT_MW] Inicializado - BASE_DOMAIN=app.local, SYSTEM_ID=BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, EXCLUDED_SUBDOMAINS={'www', 'cdn', 'backend', 'static', 'admin', 'assets', 'api'}
2025-12-03 21:12:17,405 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Pool ADMIN inicializado. Size=10, MaxOverflow=5
2025-12-03 21:12:17,405 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Configuración de pools de tenants: MaxPools=50, PoolSize=3, MaxOverflow=2, InactivityTimeout=3600s
2025-12-03 21:12:17,405 - app.infrastructure.database.connection_pool - INFO - ✅ Módulo de connection pooling cargado y activo
2025-12-03 21:12:17,405 - app.infrastructure.database.connection_pool - INFO -    Configuración: MaxTenantPools=50, TenantPoolSize=3, InactivityTimeout=3600s
2025-12-03 21:12:17,405 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Todos los pools cerrados
2025-12-03 21:12:17,405 - app.main - INFO - ✅ Pools de conexión cerrados correctamente
2025-12-03 21:12:19,005 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 21:12:19,219 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 21:12:19,219 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 21:12:19,227 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 21:12:19,228 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 21:12:19,229 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 21:12:19,229 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 21:12:19,229 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, DEFAULT_TYPE=single
2025-12-03 21:12:19,549 - app.core.security.rate_limiting - INFO - [RATE_LIMITING] Activado. Límites: Login=10/minute, API=200/minute
2025-12-03 21:12:19,549 - app.core.security.rate_limiting - INFO - ✅ Módulo de rate limiting cargado y activo
2025-12-03 21:12:19,619 - app.core.authorization.rbac - INFO - 🔐 Inicializando sistema de autorización...
2025-12-03 21:12:19,619 - app.core.authorization.rbac - INFO - ✅ Sistema de autorización inicializado correctamente
2025-12-03 21:12:19,619 - app.core.authorization.rbac - INFO - 📊 Permisos del sistema: 6 módulos configurados
2025-12-03 21:12:19,778 - app.core.tenant.middleware - INFO - Módulo tenant_middleware cargado (versión híbrida con soporte para proxies)
2025-12-03 21:12:19,778 - app.main - INFO - ✅ Rate limiting configurado y activo
2025-12-03 21:12:19,921 - app.core.tenant.middleware - INFO - [TENANT_MW] Inicializado - BASE_DOMAIN=app.local, SYSTEM_ID=BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, EXCLUDED_SUBDOMAINS={'api', 'cdn', 'assets', 'static', 'backend', 'www', 'admin'}
2025-12-03 21:12:32,516 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/login/
2025-12-03 21:12:32,517 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 21:12:32,517 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 21:12:32,517 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:12:32,519 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:12:32,519 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:12:32,520 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:12:32,520 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:12:32,520 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:12:32,520 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:12:32,520 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 21:12:32,520 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/auth/login/
2025-12-03 21:12:32,527 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] AsyncEngine creado para admin
2025-12-03 21:12:32,688 - app.modules.auth.presentation.endpoints - INFO - Cliente bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7 resuelto y validado para login.
2025-12-03 21:12:32,688 - app.modules.auth.application.services.auth_service - INFO - [AUTH] Intento de login: username='superadmin', cliente_id_destino=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:12:32,688 - app.modules.auth.application.services.auth_service - INFO - [AUTH] SUPERADMIN detectado. Buscando en BD ADMIN (cliente_id=BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7), accediendo a cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:12:32,936 - app.modules.auth.application.services.auth_service - INFO - Niveles calculados - Usuario 154134AD-A5EB-4F45-AEF0-5F9AAA282C8E: level=5, super_admin=True, type=super_admin
2025-12-03 21:12:32,936 - app.modules.auth.application.services.auth_service - INFO - [AUTH] Login exitoso: username='superadmin', usuario_id=154134AD-A5EB-4F45-AEF0-5F9AAA282C8E, cliente_origen=BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, cliente_destino=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, access_level=5, user_type=super_admin
2025-12-03 21:12:32,936 - app.modules.auth.presentation.endpoints - INFO - [LOGIN] Superadmin accediendo a cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:12:32,936 - app.modules.auth.application.services.auth_service - INFO - Niveles calculados - Usuario 154134AD-A5EB-4F45-AEF0-5F9AAA282C8E: level=5, super_admin=True, type=super_admin
2025-12-03 21:12:32,956 - app.modules.auth.application.services.refresh_token_service - INFO - [STORE-TOKEN] Token insertado exitosamente - Cliente bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, Usuario 154134AD-A5EB-4F45-AEF0-5F9AAA282C8E, Tipo: web, Token ID: 6E700C99-E5FC-4C8C-90D9-CD07490855BB, Rotación: False
2025-12-03 21:12:32,956 - app.modules.auth.presentation.endpoints - INFO - [LOGIN-WEB] Token almacenado - ID: 6E700C99-E5FC-4C8C-90D9-CD07490855BB
2025-12-03 21:12:32,957 - app.modules.auth.presentation.endpoints - INFO - Usuario superadmin autenticado exitosamente (WEB) para cliente bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:12:32,966 - app.modules.superadmin.application.services.audit_service - INFO - [AUDIT] auth_audit_log registrado: evento=login_success, cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, usuario_id=154134AD-A5EB-4F45-AEF0-5F9AAA282C8E, exito=True
2025-12-03 21:12:32,969 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/login/ 200 452.4ms
2025-12-03 21:12:32,976 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/clientes/tenant/branding
2025-12-03 21:12:32,976 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 21:12:32,976 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 21:12:32,983 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:12:32,983 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:12:32,983 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:12:32,985 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:12:32,985 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:12:32,985 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:12:32,987 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:12:32,988 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 21:12:32,988 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/clientes/tenant/branding
2025-12-03 21:12:32,999 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/menus/getmenu/
2025-12-03 21:12:33,000 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 21:12:33,001 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 21:12:33,001 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:12:33,002 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:12:33,002 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:12:33,003 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:12:33,004 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:12:33,004 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:12:33,004 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:12:33,005 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 21:12:33,007 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/menus/getmenu/
2025-12-03 21:12:33,057 - app.modules.tenant.presentation.endpoints_clientes - INFO - Solicitud GET /tenant/branding recibida para cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7 por usuario: superadmin
2025-12-03 21:12:33,059 - app.modules.tenant.application.services.cliente_service - INFO - Solicitando branding para cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:12:33,061 - app.modules.menus.presentation.endpoints - INFO - Solicitud GET /menus/getmenu/ recibida para usuario ID: 154134ad-a5eb-4f45-aef0-5f9aaa282c8e del cliente bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:12:33,062 - app.modules.menus.application.services.menu_service - INFO - Obteniendo menú filtrado para usuario_id: 154134ad-a5eb-4f45-aef0-5f9aaa282c8e
2025-12-03 21:12:33,067 - app.modules.tenant.application.services.cliente_service - INFO - Branding obtenido exitosamente para cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:12:33,068 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/clientes/tenant/branding 200 87.9ms
2025-12-03 21:12:33,075 - app.modules.menus.application.services.menu_service - INFO - No se encontraron menús permitidos para el usuario ID: 154134ad-a5eb-4f45-aef0-5f9aaa282c8e.
2025-12-03 21:12:33,075 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/menus/getmenu/ 200 78.2ms
2025-12-03 21:12:33,075 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/menus/getmenu/
2025-12-03 21:12:33,075 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 21:12:33,075 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 21:12:33,075 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:12:33,075 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:12:33,075 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:12:33,083 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:12:33,083 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:12:33,084 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:12:33,084 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:12:33,085 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 21:12:33,085 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/menus/getmenu/
2025-12-03 21:12:33,109 - app.modules.menus.presentation.endpoints - INFO - Solicitud GET /menus/getmenu/ recibida para usuario ID: 154134ad-a5eb-4f45-aef0-5f9aaa282c8e del cliente bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:12:33,110 - app.modules.menus.application.services.menu_service - INFO - Obteniendo menú filtrado para usuario_id: 154134ad-a5eb-4f45-aef0-5f9aaa282c8e
2025-12-03 21:12:33,112 - app.modules.menus.application.services.menu_service - INFO - No se encontraron menús permitidos para el usuario ID: 154134ad-a5eb-4f45-aef0-5f9aaa282c8e.
2025-12-03 21:12:33,112 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/menus/getmenu/ 200 35.7ms
2025-12-03 21:12:41,722 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/refresh/
2025-12-03 21:12:41,723 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 21:12:41,723 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 21:12:41,723 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:12:41,723 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:12:41,723 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:12:41,726 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:12:41,726 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:12:41,726 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:12:41,726 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:12:41,726 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 21:12:41,728 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/auth/refresh/
2025-12-03 21:12:41,736 - app.modules.auth.application.services.refresh_token_service - INFO - [VALIDATE-TOKEN] Token válido - Cliente BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, Usuario 154134AD-A5EB-4F45-AEF0-5F9AAA282C8E, Tipo: web
2025-12-03 21:12:41,744 - app.modules.auth.application.services.auth_service - INFO - [REFRESH] Token validado exitosamente (BD OK) para usuario: superadmin (Cliente: BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, Level: 5, Type: super_admin)
2025-12-03 21:12:41,748 - app.modules.auth.application.services.auth_service - INFO - Niveles calculados - Usuario 154134AD-A5EB-4F45-AEF0-5F9AAA282C8E: level=5, super_admin=True, type=super_admin
2025-12-03 21:12:41,756 - app.modules.auth.application.services.refresh_token_service - INFO - [STORE-TOKEN] Token insertado exitosamente - Cliente BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, Usuario 154134AD-A5EB-4F45-AEF0-5F9AAA282C8E, Tipo: web, Token ID: E5D63A6A-853D-4681-9F7D-6D82CD351452, Rotación: True
2025-12-03 21:12:41,766 - app.modules.auth.application.services.refresh_token_service - WARNING - [REVOKE-TOKEN] Token no encontrado o ya revocado - Cliente BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, Usuario 154134AD-A5EB-4F45-AEF0-5F9AAA282C8E
2025-12-03 21:12:41,766 - app.modules.auth.presentation.endpoints - WARNING - [REFRESH] Token antiguo no encontrado para revocar (no crítico)
2025-12-03 21:12:41,766 - app.modules.auth.presentation.endpoints - INFO - [REFRESH-WEB] Token rotado exitosamente - ID: E5D63A6A-853D-4681-9F7D-6D82CD351452
2025-12-03 21:12:41,770 - app.modules.auth.presentation.endpoints - INFO - [REFRESH-WEB] Token refrescado exitosamente - Usuario: superadmin
2025-12-03 21:12:41,776 - app.modules.superadmin.application.services.audit_service - INFO - [AUDIT] auth_audit_log registrado: evento=token_refresh, cliente_id=BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, usuario_id=154134AD-A5EB-4F45-AEF0-5F9AAA282C8E, exito=True
2025-12-03 21:12:41,776 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/refresh/ 200 54.8ms
2025-12-03 21:12:41,782 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/auth/me/
2025-12-03 21:12:41,783 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 21:12:41,783 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 21:12:41,784 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:12:41,784 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:12:41,784 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:12:41,786 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:12:41,786 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:12:41,786 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:12:41,787 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:12:41,787 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 21:12:41,787 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/auth/me/
2025-12-03 21:12:41,794 - app.modules.auth.presentation.endpoints - INFO - Solicitud /me/ recibida para usuario: superadmin
2025-12-03 21:12:41,794 - app.modules.auth.presentation.endpoints - INFO - [ME] Niveles desde token - Level: 5, Super Admin: True, Type: super_admin
2025-12-03 21:12:41,794 - app.modules.users.application.services.user_service - INFO - Obteniendo usuario completo ID 154134AD-A5EB-4F45-AEF0-5F9AAA282C8E para cliente BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7
2025-12-03 21:12:41,795 - app.infrastructure.database.queries_async - WARNING - [QUERY] DEPRECATED: execute_query() recibió string SQL. Migrar a SQLAlchemy Core.
2025-12-03 21:12:41,800 - app.infrastructure.database.queries_async - ERROR - Error en execute_query async (string): (pyodbc.Error) ('07002', '[07002] [Microsoft][ODBC Driver 17 for SQL Server]COUNT field incorrect or syntax error (0) (SQLExecDirectW)')
[SQL: 
            SELECT 
                -- 📋 DATOS BÁSICOS DEL USUARIO
                u.usuario_id,
                u.cliente_id,
                u.nombre_usuario,
                u.correo,
                u.nombre,
                u.apellido,
                u.dni,
                u.telefono,
                u.proveedor_autenticacion,
                u.es_activo,
                u.correo_confirmado,
                u.fecha_creacion,
                u.fecha_ultimo_acceso,
                u.fecha_actualizacion,
                
                -- 🎭 DATOS DE ROLES ASIGNADOS (si existen)
                r.rol_id,
                r.nombre as nombre_rol,
                r.descripcion as descripcion_rol,
                r.es_activo as rol_activo,
                ur.fecha_asignacion,
                ur.es_activo as asignacion_activa
                
            FROM dbo.usuario u
            -- 🔄 LEFT JOIN para incluir usuarios sin roles asignados
            LEFT JOIN dbo.usuario_rol ur ON u.usuario_id = ur.usuario_id 
                AND u.cliente_id = ur.cliente_id 
                AND ur.es_activo = 1
            LEFT JOIN dbo.rol r ON ur.rol_id = r.rol_id 
                AND r.es_activo = 1
            WHERE 
                u.usuario_id = ? 
                AND u.cliente_id = ? 
                AND u.es_eliminado = 0
            ORDER BY 
                u.usuario_id, 
                r.nombre
            ]
(Background on this error at: https://sqlalche.me/e/20/dbapi)
2025-12-03 21:12:41,801 - app.infrastructure.database.connection_async - ERROR - [ASYNC_CONNECTION] Error en sesión async: Error en la consulta: (pyodbc.Error) ('07002', '[07002] [Microsoft][ODBC Driver 17 for SQL Server]COUNT field incorrect or syntax error (0) (SQLExecDirectW)')
[SQL: 
            SELECT 
                -- 📋 DATOS BÁSICOS DEL USUARIO
                u.usuario_id,
                u.cliente_id,
                u.nombre_usuario,
                u.correo,
                u.nombre,
                u.apellido,
                u.dni,
                u.telefono,
                u.proveedor_autenticacion,
                u.es_activo,
                u.correo_confirmado,
                u.fecha_creacion,
                u.fecha_ultimo_acceso,
                u.fecha_actualizacion,
                
                -- 🎭 DATOS DE ROLES ASIGNADOS (si existen)
                r.rol_id,
                r.nombre as nombre_rol,
                r.descripcion as descripcion_rol,
                r.es_activo as rol_activo,
                ur.fecha_asignacion,
                ur.es_activo as asignacion_activa
                
            FROM dbo.usuario u
            -- 🔄 LEFT JOIN para incluir usuarios sin roles asignados
            LEFT JOIN dbo.usuario_rol ur ON u.usuario_id = ur.usuario_id 
                AND u.cliente_id = ur.cliente_id 
                AND ur.es_activo = 1
            LEFT JOIN dbo.rol r ON ur.rol_id = r.rol_id 
                AND r.es_activo = 1
            WHERE 
                u.usuario_id = ? 
                AND u.cliente_id = ? 
                AND u.es_eliminado = 0
            ORDER BY 
                u.usuario_id, 
                r.nombre
            ]
(Background on this error at: https://sqlalche.me/e/20/dbapi)
Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 230, in execute
    self._adapt_connection._handle_exception(error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 368, in _handle_exception
    raise error.with_traceback(exc_info[2])
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 228, in execute
    return self.await_(self._execute_async(operation, parameters))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 251, in _execute_async
    result = await self._cursor.execute(operation, parameters)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 132, in execute
    await self._run_operation(self._impl.execute, sql, *params)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 30, in _run_operation
    result = await self._conn._execute(func, *args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\concurrent\futures\thread.py", line 59, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
pyodbc.Error: ('07002', '[07002] [Microsoft][ODBC Driver 17 for SQL Server]COUNT field incorrect or syntax error (0) (SQLExecDirectW)')

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 148, in execute_query
    result = await session.execute(text(query))
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 449, in execute
    result = await greenlet_spawn(
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 203, in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2351, in execute
    return self._execute_internal(
           ^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2258, in _execute_internal
    result = conn.execute(
             ^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1419, in execute
    return meth(
           ^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\sql\elements.py", line 526, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1641, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1846, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1986, in _exec_single_context
    self._handle_dbapi_exception(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 2355, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 230, in execute
    self._adapt_connection._handle_exception(error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 368, in _handle_exception
    raise error.with_traceback(exc_info[2])
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 228, in execute
    return self.await_(self._execute_async(operation, parameters))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 251, in _execute_async
    result = await self._cursor.execute(operation, parameters)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 132, in execute
    await self._run_operation(self._impl.execute, sql, *params)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 30, in _run_operation
    result = await self._conn._execute(func, *args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\concurrent\futures\thread.py", line 59, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
sqlalchemy.exc.DBAPIError: (pyodbc.Error) ('07002', '[07002] [Microsoft][ODBC Driver 17 for SQL Server]COUNT field incorrect or syntax error (0) (SQLExecDirectW)')
[SQL: 
            SELECT 
                -- 📋 DATOS BÁSICOS DEL USUARIO
                u.usuario_id,
                u.cliente_id,
                u.nombre_usuario,
                u.correo,
                u.nombre,
                u.apellido,
                u.dni,
                u.telefono,
                u.proveedor_autenticacion,
                u.es_activo,
                u.correo_confirmado,
                u.fecha_creacion,
                u.fecha_ultimo_acceso,
                u.fecha_actualizacion,
                
                -- 🎭 DATOS DE ROLES ASIGNADOS (si existen)
                r.rol_id,
                r.nombre as nombre_rol,
                r.descripcion as descripcion_rol,
                r.es_activo as rol_activo,
                ur.fecha_asignacion,
                ur.es_activo as asignacion_activa
                
            FROM dbo.usuario u
            -- 🔄 LEFT JOIN para incluir usuarios sin roles asignados
            LEFT JOIN dbo.usuario_rol ur ON u.usuario_id = ur.usuario_id 
                AND u.cliente_id = ur.cliente_id 
                AND ur.es_activo = 1
            LEFT JOIN dbo.rol r ON ur.rol_id = r.rol_id 
                AND r.es_activo = 1
            WHERE 
                u.usuario_id = ? 
                AND u.cliente_id = ? 
                AND u.es_eliminado = 0
            ORDER BY 
                u.usuario_id, 
                r.nombre
            ]
(Background on this error at: https://sqlalche.me/e/20/dbapi)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\connection_async.py", line 303, in get_db_connection
    yield session
  File "D:\base_multi_tenant_fastapi\app\core\tenant\routing.py", line 672, in get_connection_for_tenant
    yield session
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 155, in execute_query
    raise DatabaseError(
app.core.exceptions.DatabaseError: Error en la consulta: (pyodbc.Error) ('07002', '[07002] [Microsoft][ODBC Driver 17 for SQL Server]COUNT field incorrect or syntax error (0) (SQLExecDirectW)')
[SQL: 
            SELECT 
                -- 📋 DATOS BÁSICOS DEL USUARIO
                u.usuario_id,
                u.cliente_id,
                u.nombre_usuario,
                u.correo,
                u.nombre,
                u.apellido,
                u.dni,
                u.telefono,
                u.proveedor_autenticacion,
                u.es_activo,
                u.correo_confirmado,
                u.fecha_creacion,
                u.fecha_ultimo_acceso,
                u.fecha_actualizacion,
                
                -- 🎭 DATOS DE ROLES ASIGNADOS (si existen)
                r.rol_id,
                r.nombre as nombre_rol,
                r.descripcion as descripcion_rol,
                r.es_activo as rol_activo,
                ur.fecha_asignacion,
                ur.es_activo as asignacion_activa
                
            FROM dbo.usuario u
            -- 🔄 LEFT JOIN para incluir usuarios sin roles asignados
            LEFT JOIN dbo.usuario_rol ur ON u.usuario_id = ur.usuario_id 
                AND u.cliente_id = ur.cliente_id 
                AND ur.es_activo = 1
            LEFT JOIN dbo.rol r ON ur.rol_id = r.rol_id 
                AND r.es_activo = 1
            WHERE 
                u.usuario_id = ? 
                AND u.cliente_id = ? 
                AND u.es_eliminado = 0
            ORDER BY 
                u.usuario_id, 
                r.nombre
            ]
(Background on this error at: https://sqlalche.me/e/20/dbapi)
2025-12-03 21:12:41,813 - app.modules.users.application.services.user_service - ERROR - Error de BD en obtener_usuario_completo_por_id: Error en la consulta: (pyodbc.Error) ('07002', '[07002] [Microsoft][ODBC Driver 17 for SQL Server]COUNT field incorrect or syntax error (0) (SQLExecDirectW)')
[SQL: 
            SELECT 
                -- 📋 DATOS BÁSICOS DEL USUARIO
                u.usuario_id,
                u.cliente_id,
                u.nombre_usuario,
                u.correo,
                u.nombre,
                u.apellido,
                u.dni,
                u.telefono,
                u.proveedor_autenticacion,
                u.es_activo,
                u.correo_confirmado,
                u.fecha_creacion,
                u.fecha_ultimo_acceso,
                u.fecha_actualizacion,
                
                -- 🎭 DATOS DE ROLES ASIGNADOS (si existen)
                r.rol_id,
                r.nombre as nombre_rol,
                r.descripcion as descripcion_rol,
                r.es_activo as rol_activo,
                ur.fecha_asignacion,
                ur.es_activo as asignacion_activa
                
            FROM dbo.usuario u
            -- 🔄 LEFT JOIN para incluir usuarios sin roles asignados
            LEFT JOIN dbo.usuario_rol ur ON u.usuario_id = ur.usuario_id 
                AND u.cliente_id = ur.cliente_id 
                AND ur.es_activo = 1
            LEFT JOIN dbo.rol r ON ur.rol_id = r.rol_id 
                AND r.es_activo = 1
            WHERE 
                u.usuario_id = ? 
                AND u.cliente_id = ? 
                AND u.es_eliminado = 0
            ORDER BY 
                u.usuario_id, 
                r.nombre
            ]
(Background on this error at: https://sqlalche.me/e/20/dbapi)
2025-12-03 21:12:41,813 - app.modules.auth.presentation.endpoints - ERROR - Error en /me/: Error de base de datos al obtener información completa del usuario
Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 230, in execute
    self._adapt_connection._handle_exception(error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 368, in _handle_exception
    raise error.with_traceback(exc_info[2])
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 228, in execute
    return self.await_(self._execute_async(operation, parameters))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 251, in _execute_async
    result = await self._cursor.execute(operation, parameters)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 132, in execute
    await self._run_operation(self._impl.execute, sql, *params)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 30, in _run_operation
    result = await self._conn._execute(func, *args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\concurrent\futures\thread.py", line 59, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
pyodbc.Error: ('07002', '[07002] [Microsoft][ODBC Driver 17 for SQL Server]COUNT field incorrect or syntax error (0) (SQLExecDirectW)')

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 148, in execute_query
    result = await session.execute(text(query))
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 449, in execute
    result = await greenlet_spawn(
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 203, in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2351, in execute
    return self._execute_internal(
           ^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2258, in _execute_internal
    result = conn.execute(
             ^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1419, in execute
    return meth(
           ^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\sql\elements.py", line 526, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1641, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1846, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1986, in _exec_single_context
    self._handle_dbapi_exception(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 2355, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 230, in execute
    self._adapt_connection._handle_exception(error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 368, in _handle_exception
    raise error.with_traceback(exc_info[2])
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 228, in execute
    return self.await_(self._execute_async(operation, parameters))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 251, in _execute_async
    result = await self._cursor.execute(operation, parameters)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 132, in execute
    await self._run_operation(self._impl.execute, sql, *params)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 30, in _run_operation
    result = await self._conn._execute(func, *args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\concurrent\futures\thread.py", line 59, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
sqlalchemy.exc.DBAPIError: (pyodbc.Error) ('07002', '[07002] [Microsoft][ODBC Driver 17 for SQL Server]COUNT field incorrect or syntax error (0) (SQLExecDirectW)')
[SQL: 
            SELECT 
                -- 📋 DATOS BÁSICOS DEL USUARIO
                u.usuario_id,
                u.cliente_id,
                u.nombre_usuario,
                u.correo,
                u.nombre,
                u.apellido,
                u.dni,
                u.telefono,
                u.proveedor_autenticacion,
                u.es_activo,
                u.correo_confirmado,
                u.fecha_creacion,
                u.fecha_ultimo_acceso,
                u.fecha_actualizacion,
                
                -- 🎭 DATOS DE ROLES ASIGNADOS (si existen)
                r.rol_id,
                r.nombre as nombre_rol,
                r.descripcion as descripcion_rol,
                r.es_activo as rol_activo,
                ur.fecha_asignacion,
                ur.es_activo as asignacion_activa
                
            FROM dbo.usuario u
            -- 🔄 LEFT JOIN para incluir usuarios sin roles asignados
            LEFT JOIN dbo.usuario_rol ur ON u.usuario_id = ur.usuario_id 
                AND u.cliente_id = ur.cliente_id 
                AND ur.es_activo = 1
            LEFT JOIN dbo.rol r ON ur.rol_id = r.rol_id 
                AND r.es_activo = 1
            WHERE 
                u.usuario_id = ? 
                AND u.cliente_id = ? 
                AND u.es_eliminado = 0
            ORDER BY 
                u.usuario_id, 
                r.nombre
            ]
(Background on this error at: https://sqlalche.me/e/20/dbapi)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\modules\users\application\services\user_service.py", line 286, in obtener_usuario_completo_por_id
    resultados = await execute_query(query, params)
                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 155, in execute_query
    raise DatabaseError(
app.core.exceptions.DatabaseError: Error en la consulta: (pyodbc.Error) ('07002', '[07002] [Microsoft][ODBC Driver 17 for SQL Server]COUNT field incorrect or syntax error (0) (SQLExecDirectW)')
[SQL: 
            SELECT 
                -- 📋 DATOS BÁSICOS DEL USUARIO
                u.usuario_id,
                u.cliente_id,
                u.nombre_usuario,
                u.correo,
                u.nombre,
                u.apellido,
                u.dni,
                u.telefono,
                u.proveedor_autenticacion,
                u.es_activo,
                u.correo_confirmado,
                u.fecha_creacion,
                u.fecha_ultimo_acceso,
                u.fecha_actualizacion,
                
                -- 🎭 DATOS DE ROLES ASIGNADOS (si existen)
                r.rol_id,
                r.nombre as nombre_rol,
                r.descripcion as descripcion_rol,
                r.es_activo as rol_activo,
                ur.fecha_asignacion,
                ur.es_activo as asignacion_activa
                
            FROM dbo.usuario u
            -- 🔄 LEFT JOIN para incluir usuarios sin roles asignados
            LEFT JOIN dbo.usuario_rol ur ON u.usuario_id = ur.usuario_id 
                AND u.cliente_id = ur.cliente_id 
                AND ur.es_activo = 1
            LEFT JOIN dbo.rol r ON ur.rol_id = r.rol_id 
                AND r.es_activo = 1
            WHERE 
                u.usuario_id = ? 
                AND u.cliente_id = ? 
                AND u.es_eliminado = 0
            ORDER BY 
                u.usuario_id, 
                r.nombre
            ]
(Background on this error at: https://sqlalche.me/e/20/dbapi)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\modules\auth\presentation\endpoints.py", line 319, in get_me
    usuario_completo = await usuario_service.obtener_usuario_completo_por_id(cliente_id, user_id)
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\core\application\base_service.py", line 52, in wrapper
    return await func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\modules\users\application\services\user_service.py", line 364, in obtener_usuario_completo_por_id
    raise ServiceError(
app.core.exceptions.ServiceError: Error de base de datos al obtener información completa del usuario
2025-12-03 21:12:41,818 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/auth/me/ 500 38.7ms
2025-12-03 21:15:35,841 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Pool ADMIN inicializado. Size=10, MaxOverflow=5
2025-12-03 21:15:35,841 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Configuración de pools de tenants: MaxPools=50, PoolSize=3, MaxOverflow=2, InactivityTimeout=3600s
2025-12-03 21:15:35,842 - app.infrastructure.database.connection_pool - INFO - ✅ Módulo de connection pooling cargado y activo
2025-12-03 21:15:35,842 - app.infrastructure.database.connection_pool - INFO -    Configuración: MaxTenantPools=50, TenantPoolSize=3, InactivityTimeout=3600s
2025-12-03 21:15:35,843 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Todos los pools cerrados
2025-12-03 21:15:35,843 - app.main - INFO - ✅ Pools de conexión cerrados correctamente
2025-12-03 21:15:36,906 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 21:15:37,155 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 21:15:37,163 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 21:15:37,174 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 21:15:37,174 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 21:15:37,175 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 21:15:37,176 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 21:15:37,176 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, DEFAULT_TYPE=single
2025-12-03 21:15:51,353 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 21:15:51,573 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 21:15:51,578 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 21:15:51,588 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 21:15:51,588 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 21:15:51,590 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 21:15:51,590 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 21:15:51,590 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, DEFAULT_TYPE=single
2025-12-03 21:16:04,029 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 21:16:04,289 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 21:16:04,300 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 21:16:04,313 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 21:16:04,314 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 21:16:04,315 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 21:16:04,316 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 21:16:04,316 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, DEFAULT_TYPE=single
2025-12-03 21:16:04,772 - app.core.security.rate_limiting - INFO - [RATE_LIMITING] Activado. Límites: Login=10/minute, API=200/minute
2025-12-03 21:16:04,772 - app.core.security.rate_limiting - INFO - ✅ Módulo de rate limiting cargado y activo
2025-12-03 21:16:04,856 - app.core.authorization.rbac - INFO - 🔐 Inicializando sistema de autorización...
2025-12-03 21:16:04,857 - app.core.authorization.rbac - INFO - ✅ Sistema de autorización inicializado correctamente
2025-12-03 21:16:04,857 - app.core.authorization.rbac - INFO - 📊 Permisos del sistema: 6 módulos configurados
2025-12-03 21:16:05,089 - app.core.tenant.middleware - INFO - Módulo tenant_middleware cargado (versión híbrida con soporte para proxies)
2025-12-03 21:16:05,089 - app.main - INFO - ✅ Rate limiting configurado y activo
2025-12-03 21:16:05,279 - app.core.tenant.middleware - INFO - [TENANT_MW] Inicializado - BASE_DOMAIN=app.local, SYSTEM_ID=BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, EXCLUDED_SUBDOMAINS={'static', 'admin', 'assets', 'backend', 'cdn', 'api', 'www'}
2025-12-03 21:16:50,068 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Pool ADMIN inicializado. Size=10, MaxOverflow=5
2025-12-03 21:16:50,068 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Configuración de pools de tenants: MaxPools=50, PoolSize=3, MaxOverflow=2, InactivityTimeout=3600s
2025-12-03 21:16:50,070 - app.infrastructure.database.connection_pool - INFO - ✅ Módulo de connection pooling cargado y activo
2025-12-03 21:16:50,070 - app.infrastructure.database.connection_pool - INFO -    Configuración: MaxTenantPools=50, TenantPoolSize=3, InactivityTimeout=3600s
2025-12-03 21:16:50,070 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Todos los pools cerrados
2025-12-03 21:16:50,071 - app.main - INFO - ✅ Pools de conexión cerrados correctamente
2025-12-03 21:16:50,877 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 21:16:51,063 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 21:16:51,080 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 21:16:51,089 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 21:16:51,089 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 21:16:51,091 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 21:16:51,091 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 21:16:51,092 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, DEFAULT_TYPE=single
2025-12-03 21:16:51,411 - app.core.security.rate_limiting - INFO - [RATE_LIMITING] Activado. Límites: Login=10/minute, API=200/minute
2025-12-03 21:16:51,412 - app.core.security.rate_limiting - INFO - ✅ Módulo de rate limiting cargado y activo
2025-12-03 21:16:51,480 - app.core.authorization.rbac - INFO - 🔐 Inicializando sistema de autorización...
2025-12-03 21:16:51,480 - app.core.authorization.rbac - INFO - ✅ Sistema de autorización inicializado correctamente
2025-12-03 21:16:51,480 - app.core.authorization.rbac - INFO - 📊 Permisos del sistema: 6 módulos configurados
2025-12-03 21:16:51,639 - app.core.tenant.middleware - INFO - Módulo tenant_middleware cargado (versión híbrida con soporte para proxies)
2025-12-03 21:16:51,641 - app.main - INFO - ✅ Rate limiting configurado y activo
2025-12-03 21:16:51,796 - app.core.tenant.middleware - INFO - [TENANT_MW] Inicializado - BASE_DOMAIN=app.local, SYSTEM_ID=BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, EXCLUDED_SUBDOMAINS={'www', 'backend', 'assets', 'api', 'cdn', 'admin', 'static'}
2025-12-03 21:16:53,303 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Pool ADMIN inicializado. Size=10, MaxOverflow=5
2025-12-03 21:16:53,303 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Configuración de pools de tenants: MaxPools=50, PoolSize=3, MaxOverflow=2, InactivityTimeout=3600s
2025-12-03 21:16:53,303 - app.infrastructure.database.connection_pool - INFO - ✅ Módulo de connection pooling cargado y activo
2025-12-03 21:16:53,303 - app.infrastructure.database.connection_pool - INFO -    Configuración: MaxTenantPools=50, TenantPoolSize=3, InactivityTimeout=3600s
2025-12-03 21:16:53,303 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Todos los pools cerrados
2025-12-03 21:16:53,303 - app.main - INFO - ✅ Pools de conexión cerrados correctamente
2025-12-03 21:16:56,153 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 21:16:56,376 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 21:16:56,383 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 21:16:56,385 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 21:16:56,385 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 21:16:56,386 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 21:16:56,387 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 21:16:56,387 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, DEFAULT_TYPE=single
2025-12-03 21:16:56,723 - app.core.security.rate_limiting - INFO - [RATE_LIMITING] Activado. Límites: Login=10/minute, API=200/minute
2025-12-03 21:16:56,723 - app.core.security.rate_limiting - INFO - ✅ Módulo de rate limiting cargado y activo
2025-12-03 21:16:56,806 - app.core.authorization.rbac - INFO - 🔐 Inicializando sistema de autorización...
2025-12-03 21:16:56,806 - app.core.authorization.rbac - INFO - ✅ Sistema de autorización inicializado correctamente
2025-12-03 21:16:56,807 - app.core.authorization.rbac - INFO - 📊 Permisos del sistema: 6 módulos configurados
2025-12-03 21:16:56,975 - app.core.tenant.middleware - INFO - Módulo tenant_middleware cargado (versión híbrida con soporte para proxies)
2025-12-03 21:16:56,976 - app.main - INFO - ✅ Rate limiting configurado y activo
2025-12-03 21:16:57,123 - app.core.tenant.middleware - INFO - [TENANT_MW] Inicializado - BASE_DOMAIN=app.local, SYSTEM_ID=BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, EXCLUDED_SUBDOMAINS={'api', 'www', 'assets', 'admin', 'static', 'cdn', 'backend'}
2025-12-03 21:17:08,382 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/auth/login/
2025-12-03 21:17:08,383 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/auth/login/ 200 1.0ms
2025-12-03 21:17:08,386 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/login/
2025-12-03 21:17:08,387 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 21:17:08,387 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 21:17:08,388 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:17:08,388 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:17:08,389 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:17:08,389 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:17:08,390 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:17:08,390 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:17:08,391 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:17:08,391 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 21:17:08,391 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/auth/login/
2025-12-03 21:17:08,394 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] AsyncEngine creado para admin
2025-12-03 21:17:08,552 - app.modules.auth.presentation.endpoints - INFO - Cliente bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7 resuelto y validado para login.
2025-12-03 21:17:08,552 - app.modules.auth.application.services.auth_service - INFO - [AUTH] Intento de login: username='superadmin', cliente_id_destino=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:17:08,552 - app.modules.auth.application.services.auth_service - INFO - [AUTH] SUPERADMIN detectado. Buscando en BD ADMIN (cliente_id=BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7), accediendo a cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:17:08,802 - app.modules.auth.application.services.auth_service - INFO - Niveles calculados - Usuario 154134AD-A5EB-4F45-AEF0-5F9AAA282C8E: level=5, super_admin=True, type=super_admin
2025-12-03 21:17:08,802 - app.modules.auth.application.services.auth_service - INFO - [AUTH] Login exitoso: username='superadmin', usuario_id=154134AD-A5EB-4F45-AEF0-5F9AAA282C8E, cliente_origen=BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, cliente_destino=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, access_level=5, user_type=super_admin
2025-12-03 21:17:08,802 - app.modules.auth.presentation.endpoints - INFO - [LOGIN] Superadmin accediendo a cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:17:08,810 - app.modules.auth.application.services.auth_service - INFO - Niveles calculados - Usuario 154134AD-A5EB-4F45-AEF0-5F9AAA282C8E: level=5, super_admin=True, type=super_admin
2025-12-03 21:17:08,820 - app.modules.auth.application.services.refresh_token_service - INFO - [STORE-TOKEN] Token insertado exitosamente - Cliente bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, Usuario 154134AD-A5EB-4F45-AEF0-5F9AAA282C8E, Tipo: web, Token ID: D795AD53-813A-4077-B1FD-03DCDF10ED11, Rotación: False
2025-12-03 21:17:08,820 - app.modules.auth.presentation.endpoints - INFO - [LOGIN-WEB] Token almacenado - ID: D795AD53-813A-4077-B1FD-03DCDF10ED11
2025-12-03 21:17:08,820 - app.modules.auth.presentation.endpoints - INFO - Usuario superadmin autenticado exitosamente (WEB) para cliente bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:17:08,831 - app.modules.superadmin.application.services.audit_service - INFO - [AUDIT] auth_audit_log registrado: evento=login_success, cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, usuario_id=154134AD-A5EB-4F45-AEF0-5F9AAA282C8E, exito=True
2025-12-03 21:17:08,831 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/login/ 200 450.1ms
2025-12-03 21:17:08,844 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/clientes/tenant/branding
2025-12-03 21:17:08,844 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/clientes/tenant/branding 200 1.0ms
2025-12-03 21:17:08,848 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/clientes/tenant/branding
2025-12-03 21:17:08,848 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 21:17:08,850 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 21:17:08,850 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:17:08,851 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:17:08,851 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:17:08,851 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:17:08,851 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:17:08,853 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:17:08,854 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:17:08,854 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 21:17:08,855 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/clientes/tenant/branding
2025-12-03 21:17:08,863 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/menus/getmenu/
2025-12-03 21:17:08,864 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/menus/getmenu/ 200 1.6ms
2025-12-03 21:17:08,864 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/menus/getmenu/
2025-12-03 21:17:08,867 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/menus/getmenu/ 200 2.1ms
2025-12-03 21:17:08,870 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/menus/getmenu/
2025-12-03 21:17:08,874 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 21:17:08,875 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 21:17:08,875 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:17:08,876 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:17:08,876 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:17:08,876 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:17:08,876 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:17:08,876 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:17:08,876 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:17:08,876 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 21:17:08,876 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/menus/getmenu/
2025-12-03 21:17:08,911 - app.modules.tenant.presentation.endpoints_clientes - INFO - Solicitud GET /tenant/branding recibida para cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7 por usuario: superadmin
2025-12-03 21:17:08,911 - app.modules.tenant.application.services.cliente_service - INFO - Solicitando branding para cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:17:08,911 - app.modules.menus.presentation.endpoints - INFO - Solicitud GET /menus/getmenu/ recibida para usuario ID: 154134ad-a5eb-4f45-aef0-5f9aaa282c8e del cliente bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:17:08,911 - app.modules.menus.application.services.menu_service - INFO - Obteniendo menú filtrado para usuario_id: 154134ad-a5eb-4f45-aef0-5f9aaa282c8e
2025-12-03 21:17:08,920 - app.modules.tenant.application.services.cliente_service - INFO - Branding obtenido exitosamente para cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:17:08,921 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/clientes/tenant/branding 200 73.0ms
2025-12-03 21:17:08,924 - app.modules.menus.application.services.menu_service - INFO - No se encontraron menús permitidos para el usuario ID: 154134ad-a5eb-4f45-aef0-5f9aaa282c8e.
2025-12-03 21:17:08,925 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/menus/getmenu/ 200 54.6ms
2025-12-03 21:17:08,927 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/menus/getmenu/
2025-12-03 21:17:08,928 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 21:17:08,929 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 21:17:08,930 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:17:08,930 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:17:08,931 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:17:08,931 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:17:08,931 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:17:08,931 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:17:08,931 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:17:08,931 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 21:17:08,931 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/menus/getmenu/
2025-12-03 21:17:08,955 - app.modules.menus.presentation.endpoints - INFO - Solicitud GET /menus/getmenu/ recibida para usuario ID: 154134ad-a5eb-4f45-aef0-5f9aaa282c8e del cliente bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:17:08,955 - app.modules.menus.application.services.menu_service - INFO - Obteniendo menú filtrado para usuario_id: 154134ad-a5eb-4f45-aef0-5f9aaa282c8e
2025-12-03 21:17:08,958 - app.modules.menus.application.services.menu_service - INFO - No se encontraron menús permitidos para el usuario ID: 154134ad-a5eb-4f45-aef0-5f9aaa282c8e.
2025-12-03 21:17:08,960 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/menus/getmenu/ 200 32.8ms
2025-12-03 21:17:40,425 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/auth/refresh/
2025-12-03 21:17:40,425 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/auth/refresh/ 200 1.0ms
2025-12-03 21:17:40,425 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/refresh/
2025-12-03 21:17:40,425 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 21:17:40,425 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 21:17:40,425 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:17:40,425 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:17:40,433 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:17:40,433 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:17:40,434 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:17:40,435 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:17:40,435 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:17:40,436 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 21:17:40,437 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/auth/refresh/
2025-12-03 21:17:40,458 - app.modules.auth.application.services.refresh_token_service - INFO - [VALIDATE-TOKEN] Token válido - Cliente BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, Usuario 154134AD-A5EB-4F45-AEF0-5F9AAA282C8E, Tipo: web
2025-12-03 21:17:40,465 - app.modules.auth.application.services.auth_service - INFO - [REFRESH] Token validado exitosamente (BD OK) para usuario: superadmin (Cliente: BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, Level: 5, Type: super_admin)
2025-12-03 21:17:40,475 - app.modules.auth.application.services.auth_service - INFO - Niveles calculados - Usuario 154134AD-A5EB-4F45-AEF0-5F9AAA282C8E: level=5, super_admin=True, type=super_admin
2025-12-03 21:17:40,491 - app.modules.auth.application.services.refresh_token_service - INFO - [STORE-TOKEN] Token insertado exitosamente - Cliente BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, Usuario 154134AD-A5EB-4F45-AEF0-5F9AAA282C8E, Tipo: web, Token ID: 38D26170-3A80-4A6E-AFDA-5521CCEFCDE7, Rotación: True
2025-12-03 21:17:40,499 - app.modules.auth.application.services.refresh_token_service - WARNING - [REVOKE-TOKEN] Token no encontrado o ya revocado - Cliente BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, Usuario 154134AD-A5EB-4F45-AEF0-5F9AAA282C8E
2025-12-03 21:17:40,500 - app.modules.auth.presentation.endpoints - WARNING - [REFRESH] Token antiguo no encontrado para revocar (no crítico)
2025-12-03 21:17:40,501 - app.modules.auth.presentation.endpoints - INFO - [REFRESH-WEB] Token rotado exitosamente - ID: 38D26170-3A80-4A6E-AFDA-5521CCEFCDE7
2025-12-03 21:17:40,502 - app.modules.auth.presentation.endpoints - INFO - [REFRESH-WEB] Token refrescado exitosamente - Usuario: superadmin
2025-12-03 21:17:40,518 - app.modules.superadmin.application.services.audit_service - INFO - [AUDIT] auth_audit_log registrado: evento=token_refresh, cliente_id=BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, usuario_id=154134AD-A5EB-4F45-AEF0-5F9AAA282C8E, exito=True
2025-12-03 21:17:40,519 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/refresh/ 200 90.1ms
2025-12-03 21:17:40,524 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/auth/me/
2025-12-03 21:17:40,525 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/auth/me/ 200 1.0ms
2025-12-03 21:17:40,527 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/auth/me/
2025-12-03 21:17:40,528 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 21:17:40,528 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 21:17:40,528 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:17:40,529 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:17:40,529 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:17:40,530 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:17:40,530 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:17:40,530 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:17:40,531 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:17:40,531 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 21:17:40,532 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/auth/me/
2025-12-03 21:17:40,539 - app.modules.auth.presentation.endpoints - INFO - Solicitud /me/ recibida para usuario: superadmin
2025-12-03 21:17:40,540 - app.modules.auth.presentation.endpoints - INFO - [ME] Niveles desde token - Level: 5, Super Admin: True, Type: super_admin
2025-12-03 21:17:40,540 - app.modules.users.application.services.user_service - INFO - Obteniendo usuario completo ID 154134AD-A5EB-4F45-AEF0-5F9AAA282C8E para cliente BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7
2025-12-03 21:17:40,541 - app.infrastructure.database.queries_async - WARNING - [QUERY] DEPRECATED: execute_query() recibió string SQL. Migrar a SQLAlchemy Core.
2025-12-03 21:17:40,569 - app.modules.users.application.services.user_service - INFO - Usuario completo obtenido exitosamente: ID 154134AD-A5EB-4F45-AEF0-5F9AAA282C8E con 1 roles activos
2025-12-03 21:17:40,569 - app.modules.auth.presentation.endpoints - INFO - [ME] Datos completos enviados - Usuario: superadmin, Type: super_admin, Level: 5, Super Admin: True, Roles: 1
2025-12-03 21:17:40,571 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/auth/me/ 200 43.5ms
2025-12-03 21:17:40,574 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/clientes/tenant/branding
2025-12-03 21:17:40,575 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 21:17:40,576 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 21:17:40,577 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:17:40,577 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:17:40,577 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:17:40,578 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:17:40,578 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:17:40,578 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:17:40,579 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:17:40,579 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 21:17:40,580 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/clientes/tenant/branding
2025-12-03 21:17:40,590 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/menus/getmenu/
2025-12-03 21:17:40,599 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 21:17:40,601 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 21:17:40,601 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:17:40,602 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:17:40,602 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:17:40,603 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:17:40,603 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:17:40,604 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:17:40,604 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:17:40,605 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 21:17:40,605 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/menus/getmenu/
2025-12-03 21:17:40,621 - app.modules.tenant.presentation.endpoints_clientes - INFO - Solicitud GET /tenant/branding recibida para cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7 por usuario: superadmin
2025-12-03 21:17:40,622 - app.modules.tenant.application.services.cliente_service - INFO - Solicitando branding para cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:17:40,626 - app.modules.tenant.application.services.cliente_service - INFO - Branding obtenido exitosamente para cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:17:40,626 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/clientes/tenant/branding 200 54.2ms
2025-12-03 21:17:40,636 - app.modules.menus.presentation.endpoints - INFO - Solicitud GET /menus/getmenu/ recibida para usuario ID: 154134ad-a5eb-4f45-aef0-5f9aaa282c8e del cliente bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:17:40,637 - app.modules.menus.application.services.menu_service - INFO - Obteniendo menú filtrado para usuario_id: 154134ad-a5eb-4f45-aef0-5f9aaa282c8e
2025-12-03 21:17:40,644 - app.modules.menus.application.services.menu_service - INFO - No se encontraron menús permitidos para el usuario ID: 154134ad-a5eb-4f45-aef0-5f9aaa282c8e.
2025-12-03 21:17:40,646 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/menus/getmenu/ 200 46.9ms
2025-12-03 21:17:40,648 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/menus/getmenu/
2025-12-03 21:17:40,648 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 21:17:40,650 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 21:17:40,650 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:17:40,651 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:17:40,651 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:17:40,652 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:17:40,652 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:17:40,652 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:17:40,652 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:17:40,654 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 21:17:40,654 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/menus/getmenu/
2025-12-03 21:17:40,674 - app.modules.menus.presentation.endpoints - INFO - Solicitud GET /menus/getmenu/ recibida para usuario ID: 154134ad-a5eb-4f45-aef0-5f9aaa282c8e del cliente bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:17:40,674 - app.modules.menus.application.services.menu_service - INFO - Obteniendo menú filtrado para usuario_id: 154134ad-a5eb-4f45-aef0-5f9aaa282c8e
2025-12-03 21:17:40,678 - app.modules.menus.application.services.menu_service - INFO - No se encontraron menús permitidos para el usuario ID: 154134ad-a5eb-4f45-aef0-5f9aaa282c8e.
2025-12-03 21:17:40,679 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/menus/getmenu/ 200 31.4ms
2025-12-03 21:17:47,795 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/refresh/
2025-12-03 21:17:47,796 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 21:17:47,796 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 21:17:47,798 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:17:47,798 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:17:47,798 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:17:47,799 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:17:47,799 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:17:47,799 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:17:47,801 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:17:47,801 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 21:17:47,801 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/auth/refresh/
2025-12-03 21:17:47,808 - app.modules.auth.application.services.refresh_token_service - INFO - [VALIDATE-TOKEN] Token válido - Cliente BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, Usuario 154134AD-A5EB-4F45-AEF0-5F9AAA282C8E, Tipo: web
2025-12-03 21:17:47,813 - app.modules.auth.application.services.auth_service - INFO - [REFRESH] Token validado exitosamente (BD OK) para usuario: superadmin (Cliente: BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, Level: 5, Type: super_admin)
2025-12-03 21:17:47,816 - app.modules.auth.application.services.auth_service - INFO - Niveles calculados - Usuario 154134AD-A5EB-4F45-AEF0-5F9AAA282C8E: level=5, super_admin=True, type=super_admin
2025-12-03 21:17:47,823 - app.modules.auth.application.services.refresh_token_service - INFO - [STORE-TOKEN] Token insertado exitosamente - Cliente BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, Usuario 154134AD-A5EB-4F45-AEF0-5F9AAA282C8E, Tipo: web, Token ID: 5AA32340-23CA-487C-9C4F-4F43743BF5DD, Rotación: True
2025-12-03 21:17:47,828 - app.modules.auth.application.services.refresh_token_service - WARNING - [REVOKE-TOKEN] Token no encontrado o ya revocado - Cliente BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, Usuario 154134AD-A5EB-4F45-AEF0-5F9AAA282C8E
2025-12-03 21:17:47,828 - app.modules.auth.presentation.endpoints - WARNING - [REFRESH] Token antiguo no encontrado para revocar (no crítico)
2025-12-03 21:17:47,829 - app.modules.auth.presentation.endpoints - INFO - [REFRESH-WEB] Token rotado exitosamente - ID: 5AA32340-23CA-487C-9C4F-4F43743BF5DD
2025-12-03 21:17:47,829 - app.modules.auth.presentation.endpoints - INFO - [REFRESH-WEB] Token refrescado exitosamente - Usuario: superadmin
2025-12-03 21:17:47,833 - app.modules.superadmin.application.services.audit_service - INFO - [AUDIT] auth_audit_log registrado: evento=token_refresh, cliente_id=BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, usuario_id=154134AD-A5EB-4F45-AEF0-5F9AAA282C8E, exito=True
2025-12-03 21:17:47,833 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/refresh/ 200 39.9ms
2025-12-03 21:17:47,839 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/auth/me/
2025-12-03 21:17:47,839 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 21:17:47,839 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 21:17:47,840 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:17:47,840 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:17:47,840 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:17:47,841 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:17:47,841 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:17:47,841 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:17:47,842 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:17:47,843 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 21:17:47,843 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/auth/me/
2025-12-03 21:17:47,848 - app.modules.auth.presentation.endpoints - INFO - Solicitud /me/ recibida para usuario: superadmin
2025-12-03 21:17:47,848 - app.modules.auth.presentation.endpoints - INFO - [ME] Niveles desde token - Level: 5, Super Admin: True, Type: super_admin
2025-12-03 21:17:47,848 - app.modules.users.application.services.user_service - INFO - Obteniendo usuario completo ID 154134AD-A5EB-4F45-AEF0-5F9AAA282C8E para cliente BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7
2025-12-03 21:17:47,849 - app.infrastructure.database.queries_async - WARNING - [QUERY] DEPRECATED: execute_query() recibió string SQL. Migrar a SQLAlchemy Core.
2025-12-03 21:17:47,857 - app.modules.users.application.services.user_service - INFO - Usuario completo obtenido exitosamente: ID 154134AD-A5EB-4F45-AEF0-5F9AAA282C8E con 1 roles activos
2025-12-03 21:17:47,857 - app.modules.auth.presentation.endpoints - INFO - [ME] Datos completos enviados - Usuario: superadmin, Type: super_admin, Level: 5, Super Admin: True, Roles: 1
2025-12-03 21:17:47,858 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/auth/me/ 200 20.5ms
2025-12-03 21:17:47,863 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/clientes/tenant/branding
2025-12-03 21:17:47,864 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 21:17:47,864 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 21:17:47,865 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:17:47,865 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:17:47,866 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:17:47,866 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:17:47,866 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:17:47,867 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:17:47,867 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:17:47,868 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 21:17:47,868 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/clientes/tenant/branding
2025-12-03 21:17:47,875 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/menus/getmenu/
2025-12-03 21:17:47,877 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 21:17:47,878 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 21:17:47,879 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:17:47,879 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:17:47,879 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:17:47,881 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:17:47,881 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:17:47,881 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:17:47,882 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:17:47,882 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 21:17:47,883 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/menus/getmenu/
2025-12-03 21:17:47,896 - app.modules.tenant.presentation.endpoints_clientes - INFO - Solicitud GET /tenant/branding recibida para cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7 por usuario: superadmin
2025-12-03 21:17:47,896 - app.modules.tenant.application.services.cliente_service - INFO - Solicitando branding para cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:17:47,914 - app.modules.tenant.application.services.cliente_service - INFO - Branding obtenido exitosamente para cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:17:47,916 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/clientes/tenant/branding 200 53.2ms
2025-12-03 21:17:47,919 - app.modules.menus.presentation.endpoints - INFO - Solicitud GET /menus/getmenu/ recibida para usuario ID: 154134ad-a5eb-4f45-aef0-5f9aaa282c8e del cliente bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:17:47,919 - app.modules.menus.application.services.menu_service - INFO - Obteniendo menú filtrado para usuario_id: 154134ad-a5eb-4f45-aef0-5f9aaa282c8e
2025-12-03 21:17:47,922 - app.modules.menus.application.services.menu_service - INFO - No se encontraron menús permitidos para el usuario ID: 154134ad-a5eb-4f45-aef0-5f9aaa282c8e.
2025-12-03 21:17:47,922 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/menus/getmenu/ 200 49.2ms
2025-12-03 21:17:47,932 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/menus/getmenu/
2025-12-03 21:17:47,932 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 21:17:47,933 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 21:17:47,933 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:17:47,934 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:17:47,934 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:17:47,934 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:17:47,935 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:17:47,935 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:17:47,935 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:17:47,935 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 21:17:47,935 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/menus/getmenu/
2025-12-03 21:17:47,952 - app.modules.menus.presentation.endpoints - INFO - Solicitud GET /menus/getmenu/ recibida para usuario ID: 154134ad-a5eb-4f45-aef0-5f9aaa282c8e del cliente bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:17:47,952 - app.modules.menus.application.services.menu_service - INFO - Obteniendo menú filtrado para usuario_id: 154134ad-a5eb-4f45-aef0-5f9aaa282c8e
2025-12-03 21:17:47,958 - app.modules.menus.application.services.menu_service - INFO - No se encontraron menús permitidos para el usuario ID: 154134ad-a5eb-4f45-aef0-5f9aaa282c8e.
2025-12-03 21:17:47,958 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/menus/getmenu/ 200 27.1ms
2025-12-03 21:20:36,195 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Pool ADMIN inicializado. Size=10, MaxOverflow=5
2025-12-03 21:20:36,195 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Configuración de pools de tenants: MaxPools=50, PoolSize=3, MaxOverflow=2, InactivityTimeout=3600s
2025-12-03 21:20:36,195 - app.infrastructure.database.connection_pool - INFO - ✅ Módulo de connection pooling cargado y activo
2025-12-03 21:20:36,195 - app.infrastructure.database.connection_pool - INFO -    Configuración: MaxTenantPools=50, TenantPoolSize=3, InactivityTimeout=3600s
2025-12-03 21:20:36,195 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Todos los pools cerrados
2025-12-03 21:20:36,203 - app.main - INFO - ✅ Pools de conexión cerrados correctamente
2025-12-03 21:20:37,183 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 21:20:37,397 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 21:20:37,408 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 21:20:37,408 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 21:20:37,413 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 21:20:37,413 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 21:20:37,413 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 21:20:37,413 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, DEFAULT_TYPE=single
2025-12-03 21:20:37,883 - app.core.security.rate_limiting - INFO - [RATE_LIMITING] Activado. Límites: Login=10/minute, API=200/minute
2025-12-03 21:20:37,883 - app.core.security.rate_limiting - INFO - ✅ Módulo de rate limiting cargado y activo
2025-12-03 21:20:37,989 - app.core.authorization.rbac - INFO - 🔐 Inicializando sistema de autorización...
2025-12-03 21:20:37,989 - app.core.authorization.rbac - INFO - ✅ Sistema de autorización inicializado correctamente
2025-12-03 21:20:37,989 - app.core.authorization.rbac - INFO - 📊 Permisos del sistema: 6 módulos configurados
2025-12-03 21:20:38,220 - app.core.tenant.middleware - INFO - Módulo tenant_middleware cargado (versión híbrida con soporte para proxies)
2025-12-03 21:20:38,223 - app.main - INFO - ✅ Rate limiting configurado y activo
2025-12-03 21:20:38,433 - app.core.tenant.middleware - INFO - [TENANT_MW] Inicializado - BASE_DOMAIN=app.local, SYSTEM_ID=BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, EXCLUDED_SUBDOMAINS={'static', 'www', 'cdn', 'api', 'assets', 'admin', 'backend'}
2025-12-03 21:23:53,140 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/refresh/
2025-12-03 21:23:53,146 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 21:23:53,146 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 21:23:53,146 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:23:53,146 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:23:53,148 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:23:53,148 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:23:53,148 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:23:53,148 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:23:53,150 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:23:53,150 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 21:23:53,152 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/auth/refresh/
2025-12-03 21:23:53,186 - app.modules.auth.application.services.refresh_token_service - INFO - [VALIDATE-TOKEN] Token válido - Cliente BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, Usuario 154134AD-A5EB-4F45-AEF0-5F9AAA282C8E, Tipo: web
2025-12-03 21:23:53,186 - app.modules.auth.application.services.auth_service - INFO - [REFRESH] Token validado exitosamente (BD OK) para usuario: superadmin (Cliente: BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, Level: 5, Type: super_admin)
2025-12-03 21:23:53,212 - app.modules.auth.application.services.auth_service - INFO - Niveles calculados - Usuario 154134AD-A5EB-4F45-AEF0-5F9AAA282C8E: level=5, super_admin=True, type=super_admin
2025-12-03 21:23:53,227 - app.modules.auth.application.services.refresh_token_service - INFO - [STORE-TOKEN] Token insertado exitosamente - Cliente BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, Usuario 154134AD-A5EB-4F45-AEF0-5F9AAA282C8E, Tipo: web, Token ID: BA943778-3559-46FC-9B95-9AD9157EC261, Rotación: True
2025-12-03 21:23:53,240 - app.modules.auth.application.services.refresh_token_service - WARNING - [REVOKE-TOKEN] Token no encontrado o ya revocado - Cliente BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, Usuario 154134AD-A5EB-4F45-AEF0-5F9AAA282C8E
2025-12-03 21:23:53,240 - app.modules.auth.presentation.endpoints - WARNING - [REFRESH] Token antiguo no encontrado para revocar (no crítico)
2025-12-03 21:23:53,241 - app.modules.auth.presentation.endpoints - INFO - [REFRESH-WEB] Token rotado exitosamente - ID: BA943778-3559-46FC-9B95-9AD9157EC261
2025-12-03 21:23:53,242 - app.modules.auth.presentation.endpoints - INFO - [REFRESH-WEB] Token refrescado exitosamente - Usuario: superadmin
2025-12-03 21:23:53,254 - app.modules.superadmin.application.services.audit_service - INFO - [AUDIT] auth_audit_log registrado: evento=token_refresh, cliente_id=BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, usuario_id=154134AD-A5EB-4F45-AEF0-5F9AAA282C8E, exito=True
2025-12-03 21:23:53,256 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/refresh/ 200 111.8ms
2025-12-03 21:23:53,259 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/auth/me/
2025-12-03 21:23:53,259 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 21:23:53,259 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 21:23:53,262 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:23:53,263 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:23:53,263 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:23:53,264 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:23:53,264 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:23:53,264 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:23:53,264 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:23:53,266 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 21:23:53,266 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/auth/me/
2025-12-03 21:23:53,273 - app.modules.auth.presentation.endpoints - INFO - Solicitud /me/ recibida para usuario: superadmin
2025-12-03 21:23:53,273 - app.modules.auth.presentation.endpoints - INFO - [ME] Niveles desde token - Level: 5, Super Admin: True, Type: super_admin
2025-12-03 21:23:53,275 - app.modules.users.application.services.user_service - INFO - Obteniendo usuario completo ID 154134AD-A5EB-4F45-AEF0-5F9AAA282C8E para cliente BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7
2025-12-03 21:23:53,275 - app.infrastructure.database.queries_async - WARNING - [QUERY] DEPRECATED: execute_query() recibió string SQL. Migrar a SQLAlchemy Core.
2025-12-03 21:23:53,301 - app.modules.users.application.services.user_service - INFO - Usuario completo obtenido exitosamente: ID 154134AD-A5EB-4F45-AEF0-5F9AAA282C8E con 1 roles activos
2025-12-03 21:23:53,302 - app.modules.auth.presentation.endpoints - INFO - [ME] Datos completos enviados - Usuario: superadmin, Type: super_admin, Level: 5, Super Admin: True, Roles: 1
2025-12-03 21:23:53,302 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/auth/me/ 200 44.1ms
2025-12-03 21:23:53,306 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/clientes/tenant/branding
2025-12-03 21:23:53,306 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 21:23:53,311 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 21:23:53,311 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:23:53,312 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:23:53,312 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:23:53,313 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:23:53,313 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:23:53,313 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:23:53,314 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:23:53,314 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 21:23:53,315 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/clientes/tenant/branding
2025-12-03 21:23:53,326 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/menus/getmenu/
2025-12-03 21:23:53,326 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 21:23:53,330 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 21:23:53,330 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:23:53,330 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:23:53,331 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:23:53,331 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:23:53,332 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:23:53,332 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:23:53,332 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:23:53,333 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 21:23:53,333 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/menus/getmenu/
2025-12-03 21:23:53,359 - app.modules.tenant.presentation.endpoints_clientes - INFO - Solicitud GET /tenant/branding recibida para cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7 por usuario: superadmin
2025-12-03 21:23:53,359 - app.modules.tenant.application.services.cliente_service - INFO - Solicitando branding para cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:23:53,359 - app.modules.menus.presentation.endpoints - INFO - Solicitud GET /menus/getmenu/ recibida para usuario ID: 154134ad-a5eb-4f45-aef0-5f9aaa282c8e del cliente bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:23:53,359 - app.modules.menus.application.services.menu_service - INFO - Obteniendo menú filtrado para usuario_id: 154134ad-a5eb-4f45-aef0-5f9aaa282c8e
2025-12-03 21:23:53,367 - app.modules.tenant.application.services.cliente_service - INFO - Branding obtenido exitosamente para cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:23:53,370 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/clientes/tenant/branding 200 60.3ms
2025-12-03 21:23:53,373 - app.modules.menus.application.services.menu_service - INFO - No se encontraron menús permitidos para el usuario ID: 154134ad-a5eb-4f45-aef0-5f9aaa282c8e.
2025-12-03 21:23:53,375 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/menus/getmenu/ 200 46.2ms
2025-12-03 21:23:53,377 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/menus/getmenu/
2025-12-03 21:23:53,377 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 21:23:53,378 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 21:23:53,378 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:23:53,379 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:23:53,379 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:23:53,380 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:23:53,380 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:23:53,380 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:23:53,380 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:23:53,380 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 21:23:53,380 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/menus/getmenu/
2025-12-03 21:23:53,401 - app.modules.menus.presentation.endpoints - INFO - Solicitud GET /menus/getmenu/ recibida para usuario ID: 154134ad-a5eb-4f45-aef0-5f9aaa282c8e del cliente bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:23:53,402 - app.modules.menus.application.services.menu_service - INFO - Obteniendo menú filtrado para usuario_id: 154134ad-a5eb-4f45-aef0-5f9aaa282c8e
2025-12-03 21:23:53,407 - app.modules.menus.application.services.menu_service - INFO - No se encontraron menús permitidos para el usuario ID: 154134ad-a5eb-4f45-aef0-5f9aaa282c8e.
2025-12-03 21:23:53,408 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/menus/getmenu/ 200 31.7ms
2025-12-03 21:24:12,430 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/refresh/
2025-12-03 21:24:12,432 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 21:24:12,433 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 21:24:12,433 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:24:12,434 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:24:12,434 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:24:12,435 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:24:12,435 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:24:12,435 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:24:12,436 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:24:12,436 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 21:24:12,437 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/auth/refresh/
2025-12-03 21:24:12,449 - app.modules.auth.application.services.refresh_token_service - INFO - [VALIDATE-TOKEN] Token válido - Cliente BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, Usuario 154134AD-A5EB-4F45-AEF0-5F9AAA282C8E, Tipo: web
2025-12-03 21:24:12,458 - app.modules.auth.application.services.auth_service - INFO - [REFRESH] Token validado exitosamente (BD OK) para usuario: superadmin (Cliente: BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, Level: 5, Type: super_admin)
2025-12-03 21:24:12,506 - app.modules.auth.application.services.auth_service - INFO - Niveles calculados - Usuario 154134AD-A5EB-4F45-AEF0-5F9AAA282C8E: level=5, super_admin=True, type=super_admin
2025-12-03 21:24:12,522 - app.modules.auth.application.services.refresh_token_service - INFO - [STORE-TOKEN] Token insertado exitosamente - Cliente BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, Usuario 154134AD-A5EB-4F45-AEF0-5F9AAA282C8E, Tipo: web, Token ID: DCBBD23E-D744-4053-AF69-3BF8AA268DDF, Rotación: True
2025-12-03 21:24:12,530 - app.modules.auth.application.services.refresh_token_service - WARNING - [REVOKE-TOKEN] Token no encontrado o ya revocado - Cliente BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, Usuario 154134AD-A5EB-4F45-AEF0-5F9AAA282C8E
2025-12-03 21:24:12,531 - app.modules.auth.presentation.endpoints - WARNING - [REFRESH] Token antiguo no encontrado para revocar (no crítico)
2025-12-03 21:24:12,531 - app.modules.auth.presentation.endpoints - INFO - [REFRESH-WEB] Token rotado exitosamente - ID: DCBBD23E-D744-4053-AF69-3BF8AA268DDF
2025-12-03 21:24:12,532 - app.modules.auth.presentation.endpoints - INFO - [REFRESH-WEB] Token refrescado exitosamente - Usuario: superadmin
2025-12-03 21:24:12,629 - app.modules.superadmin.application.services.audit_service - INFO - [AUDIT] auth_audit_log registrado: evento=token_refresh, cliente_id=BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, usuario_id=154134AD-A5EB-4F45-AEF0-5F9AAA282C8E, exito=True
2025-12-03 21:24:12,630 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/refresh/ 200 199.9ms
2025-12-03 21:24:12,635 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/auth/me/
2025-12-03 21:24:12,635 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 21:24:12,636 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 21:24:12,636 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:24:12,637 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:24:12,637 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:24:12,637 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:24:12,639 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:24:12,639 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:24:12,639 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:24:12,641 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 21:24:12,641 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/auth/me/
2025-12-03 21:24:12,647 - app.modules.auth.presentation.endpoints - INFO - Solicitud /me/ recibida para usuario: superadmin
2025-12-03 21:24:12,647 - app.modules.auth.presentation.endpoints - INFO - [ME] Niveles desde token - Level: 5, Super Admin: True, Type: super_admin
2025-12-03 21:24:12,648 - app.modules.users.application.services.user_service - INFO - Obteniendo usuario completo ID 154134AD-A5EB-4F45-AEF0-5F9AAA282C8E para cliente BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7
2025-12-03 21:24:12,648 - app.infrastructure.database.queries_async - WARNING - [QUERY] DEPRECATED: execute_query() recibió string SQL. Migrar a SQLAlchemy Core.
2025-12-03 21:24:12,711 - app.modules.users.application.services.user_service - INFO - Usuario completo obtenido exitosamente: ID 154134AD-A5EB-4F45-AEF0-5F9AAA282C8E con 1 roles activos
2025-12-03 21:24:12,711 - app.modules.auth.presentation.endpoints - INFO - [ME] Datos completos enviados - Usuario: superadmin, Type: super_admin, Level: 5, Super Admin: True, Roles: 1
2025-12-03 21:24:12,712 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/auth/me/ 200 77.2ms
2025-12-03 21:24:12,715 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/clientes/tenant/branding
2025-12-03 21:24:12,716 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 21:24:12,716 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 21:24:12,717 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:24:12,717 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:24:12,718 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:24:12,718 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:24:12,718 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:24:12,719 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:24:12,720 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:24:12,720 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 21:24:12,721 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/clientes/tenant/branding
2025-12-03 21:24:12,731 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/menus/getmenu/
2025-12-03 21:24:12,732 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 21:24:12,733 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 21:24:12,733 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:24:12,734 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:24:12,734 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:24:12,735 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:24:12,735 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:24:12,736 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:24:12,736 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:24:12,737 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 21:24:12,737 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/menus/getmenu/
2025-12-03 21:24:12,762 - app.modules.tenant.presentation.endpoints_clientes - INFO - Solicitud GET /tenant/branding recibida para cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7 por usuario: superadmin
2025-12-03 21:24:12,762 - app.modules.tenant.application.services.cliente_service - INFO - Solicitando branding para cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:24:12,772 - app.modules.tenant.application.services.cliente_service - INFO - Branding obtenido exitosamente para cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:24:12,773 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/clientes/tenant/branding 200 57.5ms
2025-12-03 21:24:12,779 - app.modules.menus.presentation.endpoints - INFO - Solicitud GET /menus/getmenu/ recibida para usuario ID: 154134ad-a5eb-4f45-aef0-5f9aaa282c8e del cliente bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:24:12,779 - app.modules.menus.application.services.menu_service - INFO - Obteniendo menú filtrado para usuario_id: 154134ad-a5eb-4f45-aef0-5f9aaa282c8e
2025-12-03 21:24:12,785 - app.modules.menus.application.services.menu_service - INFO - No se encontraron menús permitidos para el usuario ID: 154134ad-a5eb-4f45-aef0-5f9aaa282c8e.
2025-12-03 21:24:12,788 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/menus/getmenu/ 200 55.7ms
2025-12-03 21:24:12,791 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/menus/getmenu/
2025-12-03 21:24:12,792 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 21:24:12,792 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 21:24:12,792 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:24:12,793 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:24:12,793 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:24:12,795 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:24:12,795 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:24:12,796 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:24:12,796 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:24:12,797 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 21:24:12,797 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/menus/getmenu/
2025-12-03 21:24:12,824 - app.modules.menus.presentation.endpoints - INFO - Solicitud GET /menus/getmenu/ recibida para usuario ID: 154134ad-a5eb-4f45-aef0-5f9aaa282c8e del cliente bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:24:12,825 - app.modules.menus.application.services.menu_service - INFO - Obteniendo menú filtrado para usuario_id: 154134ad-a5eb-4f45-aef0-5f9aaa282c8e
2025-12-03 21:24:12,829 - app.modules.menus.application.services.menu_service - INFO - No se encontraron menús permitidos para el usuario ID: 154134ad-a5eb-4f45-aef0-5f9aaa282c8e.
2025-12-03 21:24:12,830 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/menus/getmenu/ 200 38.4ms
2025-12-03 21:24:46,433 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/refresh/
2025-12-03 21:24:46,434 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 21:24:46,434 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 21:24:46,436 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:24:46,436 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:24:46,436 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:24:46,437 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:24:46,438 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:24:46,439 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:24:46,440 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:24:46,441 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 21:24:46,442 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/auth/refresh/
2025-12-03 21:24:46,451 - app.modules.auth.application.services.refresh_token_service - INFO - [VALIDATE-TOKEN] Token válido - Cliente BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, Usuario 154134AD-A5EB-4F45-AEF0-5F9AAA282C8E, Tipo: web
2025-12-03 21:24:46,462 - app.modules.auth.application.services.auth_service - INFO - [REFRESH] Token validado exitosamente (BD OK) para usuario: superadmin (Cliente: BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, Level: 5, Type: super_admin)
2025-12-03 21:24:46,474 - app.modules.auth.application.services.auth_service - INFO - Niveles calculados - Usuario 154134AD-A5EB-4F45-AEF0-5F9AAA282C8E: level=5, super_admin=True, type=super_admin
2025-12-03 21:24:46,498 - app.modules.auth.application.services.refresh_token_service - INFO - [STORE-TOKEN] Token insertado exitosamente - Cliente BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, Usuario 154134AD-A5EB-4F45-AEF0-5F9AAA282C8E, Tipo: web, Token ID: F9940DD5-2BF8-48F3-A46F-85A3FEB3C211, Rotación: True
2025-12-03 21:24:46,507 - app.modules.auth.application.services.refresh_token_service - WARNING - [REVOKE-TOKEN] Token no encontrado o ya revocado - Cliente BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, Usuario 154134AD-A5EB-4F45-AEF0-5F9AAA282C8E
2025-12-03 21:24:46,508 - app.modules.auth.presentation.endpoints - WARNING - [REFRESH] Token antiguo no encontrado para revocar (no crítico)
2025-12-03 21:24:46,509 - app.modules.auth.presentation.endpoints - INFO - [REFRESH-WEB] Token rotado exitosamente - ID: F9940DD5-2BF8-48F3-A46F-85A3FEB3C211
2025-12-03 21:24:46,509 - app.modules.auth.presentation.endpoints - INFO - [REFRESH-WEB] Token refrescado exitosamente - Usuario: superadmin
2025-12-03 21:24:46,523 - app.modules.superadmin.application.services.audit_service - INFO - [AUDIT] auth_audit_log registrado: evento=token_refresh, cliente_id=BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, usuario_id=154134AD-A5EB-4F45-AEF0-5F9AAA282C8E, exito=True
2025-12-03 21:24:46,525 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/refresh/ 200 91.7ms
2025-12-03 21:24:46,530 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/auth/me/
2025-12-03 21:24:46,531 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 21:24:46,531 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 21:24:46,532 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:24:46,532 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:24:46,534 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:24:46,534 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:24:46,534 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:24:46,535 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:24:46,535 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:24:46,536 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 21:24:46,536 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/auth/me/
2025-12-03 21:24:46,543 - app.modules.auth.presentation.endpoints - INFO - Solicitud /me/ recibida para usuario: superadmin
2025-12-03 21:24:46,543 - app.modules.auth.presentation.endpoints - INFO - [ME] Niveles desde token - Level: 5, Super Admin: True, Type: super_admin
2025-12-03 21:24:46,544 - app.modules.users.application.services.user_service - INFO - Obteniendo usuario completo ID 154134AD-A5EB-4F45-AEF0-5F9AAA282C8E para cliente BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7
2025-12-03 21:24:46,544 - app.infrastructure.database.queries_async - WARNING - [QUERY] DEPRECATED: execute_query() recibió string SQL. Migrar a SQLAlchemy Core.
2025-12-03 21:24:46,564 - app.modules.users.application.services.user_service - INFO - Usuario completo obtenido exitosamente: ID 154134AD-A5EB-4F45-AEF0-5F9AAA282C8E con 1 roles activos
2025-12-03 21:24:46,565 - app.modules.auth.presentation.endpoints - INFO - [ME] Datos completos enviados - Usuario: superadmin, Type: super_admin, Level: 5, Super Admin: True, Roles: 1
2025-12-03 21:24:46,565 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/auth/me/ 200 36.0ms
2025-12-03 21:24:46,569 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/clientes/tenant/branding
2025-12-03 21:24:46,570 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 21:24:46,571 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 21:24:46,571 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:24:46,572 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:24:46,572 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:24:46,573 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:24:46,573 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:24:46,575 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:24:46,575 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:24:46,576 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 21:24:46,576 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/clientes/tenant/branding
2025-12-03 21:24:46,584 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/menus/getmenu/
2025-12-03 21:24:46,585 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 21:24:46,585 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 21:24:46,585 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:24:46,587 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:24:46,587 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:24:46,588 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:24:46,588 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:24:46,589 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:24:46,589 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:24:46,590 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 21:24:46,590 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/menus/getmenu/
2025-12-03 21:24:46,613 - app.modules.tenant.presentation.endpoints_clientes - INFO - Solicitud GET /tenant/branding recibida para cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7 por usuario: superadmin
2025-12-03 21:24:46,614 - app.modules.tenant.application.services.cliente_service - INFO - Solicitando branding para cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:24:46,618 - app.modules.menus.presentation.endpoints - INFO - Solicitud GET /menus/getmenu/ recibida para usuario ID: 154134ad-a5eb-4f45-aef0-5f9aaa282c8e del cliente bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:24:46,619 - app.modules.menus.application.services.menu_service - INFO - Obteniendo menú filtrado para usuario_id: 154134ad-a5eb-4f45-aef0-5f9aaa282c8e
2025-12-03 21:24:46,620 - app.modules.tenant.application.services.cliente_service - INFO - Branding obtenido exitosamente para cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:24:46,621 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/clientes/tenant/branding 200 52.4ms
2025-12-03 21:24:46,634 - app.modules.menus.application.services.menu_service - INFO - No se encontraron menús permitidos para el usuario ID: 154134ad-a5eb-4f45-aef0-5f9aaa282c8e.
2025-12-03 21:24:46,635 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/menus/getmenu/ 200 51.0ms
2025-12-03 21:24:46,637 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/menus/getmenu/
2025-12-03 21:24:46,638 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 21:24:46,639 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 21:24:46,640 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:24:46,640 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:24:46,641 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:24:46,641 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:24:46,642 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:24:46,642 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:24:46,643 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:24:46,643 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 21:24:46,644 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/menus/getmenu/
2025-12-03 21:24:46,664 - app.modules.menus.presentation.endpoints - INFO - Solicitud GET /menus/getmenu/ recibida para usuario ID: 154134ad-a5eb-4f45-aef0-5f9aaa282c8e del cliente bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:24:46,664 - app.modules.menus.application.services.menu_service - INFO - Obteniendo menú filtrado para usuario_id: 154134ad-a5eb-4f45-aef0-5f9aaa282c8e
2025-12-03 21:24:46,668 - app.modules.menus.application.services.menu_service - INFO - No se encontraron menús permitidos para el usuario ID: 154134ad-a5eb-4f45-aef0-5f9aaa282c8e.
2025-12-03 21:24:46,669 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/menus/getmenu/ 200 30.9ms
2025-12-03 21:24:55,097 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/clientes/
2025-12-03 21:24:55,099 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/clientes/
2025-12-03 21:24:55,099 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/clientes/ 200 2.1ms
2025-12-03 21:24:55,100 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/clientes/ 200 1.7ms
2025-12-03 21:24:55,103 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/clientes/
2025-12-03 21:24:55,104 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 21:24:55,104 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 21:24:55,104 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:24:55,106 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:24:55,106 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:24:55,107 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:24:55,108 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:24:55,108 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:24:55,108 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:24:55,109 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 21:24:55,109 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/clientes/
2025-12-03 21:24:55,129 - app.modules.tenant.presentation.endpoints_clientes - INFO - Solicitud GET /clientes/ recibida - skip: 0, limit: 10, solo_activos: True, buscar: None por usuario: superadmin
2025-12-03 21:24:55,129 - app.modules.tenant.application.services.cliente_service - INFO - Listando clientes - skip: 0, limit: 10, solo_activos: True, buscar: None
2025-12-03 21:24:55,140 - app.modules.tenant.application.services.cliente_service - INFO - Listados 5 clientes de 5 totales
2025-12-03 21:24:55,141 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/clientes/ 200 38.4ms
2025-12-03 21:24:55,143 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/clientes/
2025-12-03 21:24:55,144 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 21:24:55,144 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 21:24:55,145 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:24:55,145 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:24:55,146 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:24:55,146 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:24:55,147 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:24:55,148 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:24:55,148 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:24:55,149 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 21:24:55,149 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/clientes/
2025-12-03 21:24:55,167 - app.modules.tenant.presentation.endpoints_clientes - INFO - Solicitud GET /clientes/ recibida - skip: 0, limit: 10, solo_activos: True, buscar: None por usuario: superadmin
2025-12-03 21:24:55,168 - app.modules.tenant.application.services.cliente_service - INFO - Listando clientes - skip: 0, limit: 10, solo_activos: True, buscar: None
2025-12-03 21:24:55,174 - app.modules.tenant.application.services.cliente_service - INFO - Listados 5 clientes de 5 totales
2025-12-03 21:24:55,175 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/clientes/ 200 32.1ms
2025-12-03 21:25:01,504 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/clientes/NaN/
2025-12-03 21:25:01,505 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/clientes/NaN/ 200 2.0ms
2025-12-03 21:25:01,507 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/clientes/NaN/estadisticas/
2025-12-03 21:25:01,510 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/clientes/NaN/estadisticas/
2025-12-03 21:25:01,510 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/clientes/NaN/
2025-12-03 21:25:01,511 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/clientes/NaN/estadisticas/ 200 3.3ms
2025-12-03 21:25:01,512 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/clientes/NaN/estadisticas/ 200 2.8ms
2025-12-03 21:25:01,513 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/clientes/NaN/ 200 2.7ms
2025-12-03 21:25:01,515 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/clientes/NaN/
2025-12-03 21:25:01,516 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 21:25:01,517 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 21:25:01,517 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:25:01,518 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:25:01,518 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:25:01,518 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:25:01,519 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:25:01,519 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:25:01,520 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:25:01,520 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 21:25:01,521 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/clientes/NaN/
2025-12-03 21:25:01,522 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/clientes/NaN/estadisticas/
2025-12-03 21:25:01,524 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 21:25:01,525 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 21:25:01,525 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:25:01,526 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:25:01,526 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:25:01,526 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:25:01,527 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:25:01,527 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:25:01,528 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:25:01,528 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 21:25:01,528 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/clientes/NaN/estadisticas/
2025-12-03 21:25:01,553 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/clientes/NaN/ 422 37.5ms
2025-12-03 21:25:01,555 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/clientes/NaN/estadisticas/ 422 31.8ms
2025-12-03 21:25:01,557 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/clientes/NaN/
2025-12-03 21:25:01,558 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 21:25:01,559 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 21:25:01,559 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:25:01,559 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:25:01,560 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:25:01,560 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:25:01,561 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:25:01,561 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:25:01,562 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:25:01,562 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 21:25:01,562 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/clientes/NaN/
2025-12-03 21:25:01,565 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/clientes/NaN/estadisticas/
2025-12-03 21:25:01,566 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 21:25:01,566 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 21:25:01,567 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:25:01,567 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:25:01,567 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:25:01,568 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:25:01,568 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:25:01,569 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:25:01,569 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:25:01,569 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 21:25:01,570 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/clientes/NaN/estadisticas/
2025-12-03 21:25:01,597 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/clientes/NaN/estadisticas/ 422 31.9ms
2025-12-03 21:25:01,597 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/clientes/NaN/ 422 40.8ms
2025-12-03 21:25:17,247 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/clientes/
2025-12-03 21:25:17,249 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 21:25:17,249 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 21:25:17,249 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:25:17,250 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:25:17,250 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:25:17,251 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:25:17,251 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:25:17,252 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:25:17,253 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:25:17,253 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 21:25:17,254 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/clientes/
2025-12-03 21:25:17,274 - app.modules.tenant.presentation.endpoints_clientes - INFO - Solicitud GET /clientes/ recibida - skip: 0, limit: 10, solo_activos: True, buscar: None por usuario: superadmin
2025-12-03 21:25:17,275 - app.modules.tenant.application.services.cliente_service - INFO - Listando clientes - skip: 0, limit: 10, solo_activos: True, buscar: None
2025-12-03 21:25:17,279 - app.modules.tenant.application.services.cliente_service - INFO - Listados 5 clientes de 5 totales
2025-12-03 21:25:17,280 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/clientes/ 200 33.7ms
2025-12-03 21:25:17,282 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/clientes/
2025-12-03 21:25:17,283 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 21:25:17,283 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 21:25:17,285 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:25:17,285 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:25:17,285 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:25:17,286 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:25:17,286 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:25:17,287 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:25:17,287 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:25:17,288 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 21:25:17,288 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/clientes/
2025-12-03 21:25:17,303 - app.modules.tenant.presentation.endpoints_clientes - INFO - Solicitud GET /clientes/ recibida - skip: 0, limit: 10, solo_activos: True, buscar: None por usuario: superadmin
2025-12-03 21:25:17,303 - app.modules.tenant.application.services.cliente_service - INFO - Listando clientes - skip: 0, limit: 10, solo_activos: True, buscar: None
2025-12-03 21:25:17,310 - app.modules.tenant.application.services.cliente_service - INFO - Listados 5 clientes de 5 totales
2025-12-03 21:25:17,311 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/clientes/ 200 28.4ms
2025-12-03 21:25:25,321 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/clientes/NaN/
2025-12-03 21:25:25,322 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 21:25:25,323 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 21:25:25,323 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:25:25,324 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:25:25,324 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:25:25,325 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:25:25,325 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:25:25,327 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:25:25,328 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:25:25,329 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 21:25:25,330 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/clientes/NaN/
2025-12-03 21:25:25,332 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/clientes/NaN/estadisticas/
2025-12-03 21:25:25,333 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 21:25:25,334 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 21:25:25,334 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:25:25,335 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:25:25,335 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:25:25,337 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:25:25,337 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:25:25,338 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:25:25,338 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:25:25,338 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 21:25:25,339 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/clientes/NaN/estadisticas/
2025-12-03 21:25:25,397 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/clientes/NaN/estadisticas/ 422 64.9ms
2025-12-03 21:25:25,397 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/clientes/NaN/ 422 76.0ms
2025-12-03 21:25:25,400 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/clientes/NaN/
2025-12-03 21:25:25,401 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/clientes/NaN/estadisticas/
2025-12-03 21:25:25,402 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 21:25:25,402 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 21:25:25,403 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:25:25,403 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:25:25,404 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:25:25,404 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:25:25,404 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:25:25,405 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:25:25,406 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:25:25,407 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 21:25:25,407 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/clientes/NaN/
2025-12-03 21:25:25,408 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 21:25:25,408 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 21:25:25,408 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:25:25,408 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:25:25,408 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:25:25,408 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:25:25,408 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:25:25,408 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:25:25,411 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:25:25,411 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 21:25:25,412 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/clientes/NaN/estadisticas/
2025-12-03 21:25:25,438 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/clientes/NaN/ 422 38.3ms
2025-12-03 21:25:25,441 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/clientes/NaN/estadisticas/ 422 39.3ms
2025-12-03 21:27:43,351 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/clientes/
2025-12-03 21:27:43,360 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 21:27:43,360 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 21:27:43,361 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:27:43,362 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:27:43,362 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:27:43,363 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:27:43,364 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:27:43,364 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:27:43,365 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:27:43,365 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 21:27:43,367 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/clientes/
2025-12-03 21:27:43,424 - app.modules.tenant.presentation.endpoints_clientes - INFO - Solicitud GET /clientes/ recibida - skip: 0, limit: 10, solo_activos: True, buscar: None por usuario: superadmin
2025-12-03 21:27:43,425 - app.modules.tenant.application.services.cliente_service - INFO - Listando clientes - skip: 0, limit: 10, solo_activos: True, buscar: None
2025-12-03 21:27:43,442 - app.modules.tenant.application.services.cliente_service - INFO - Listados 5 clientes de 5 totales
2025-12-03 21:27:43,444 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/clientes/ 200 92.1ms
2025-12-03 21:27:43,506 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Pool ADMIN inicializado. Size=10, MaxOverflow=5
2025-12-03 21:27:43,507 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Configuración de pools de tenants: MaxPools=50, PoolSize=3, MaxOverflow=2, InactivityTimeout=3600s
2025-12-03 21:27:43,508 - app.infrastructure.database.connection_pool - INFO - ✅ Módulo de connection pooling cargado y activo
2025-12-03 21:27:43,508 - app.infrastructure.database.connection_pool - INFO -    Configuración: MaxTenantPools=50, TenantPoolSize=3, InactivityTimeout=3600s
2025-12-03 21:27:43,508 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Todos los pools cerrados
2025-12-03 21:27:43,510 - app.main - INFO - ✅ Pools de conexión cerrados correctamente
2025-12-03 21:27:45,184 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 21:27:45,555 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 21:27:45,584 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 21:27:45,587 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 21:27:45,587 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 21:27:45,588 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 21:27:45,588 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 21:27:45,590 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, DEFAULT_TYPE=single
2025-12-03 21:27:46,040 - app.core.security.rate_limiting - INFO - [RATE_LIMITING] Activado. Límites: Login=10/minute, API=200/minute
2025-12-03 21:27:46,040 - app.core.security.rate_limiting - INFO - ✅ Módulo de rate limiting cargado y activo
2025-12-03 21:27:46,145 - app.core.authorization.rbac - INFO - 🔐 Inicializando sistema de autorización...
2025-12-03 21:27:46,145 - app.core.authorization.rbac - INFO - ✅ Sistema de autorización inicializado correctamente
2025-12-03 21:27:46,145 - app.core.authorization.rbac - INFO - 📊 Permisos del sistema: 6 módulos configurados
2025-12-03 21:27:46,370 - app.core.tenant.middleware - INFO - Módulo tenant_middleware cargado (versión híbrida con soporte para proxies)
2025-12-03 21:27:46,372 - app.main - INFO - ✅ Rate limiting configurado y activo
2025-12-03 21:27:46,523 - app.core.tenant.middleware - INFO - [TENANT_MW] Inicializado - BASE_DOMAIN=app.local, SYSTEM_ID=BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, EXCLUDED_SUBDOMAINS={'api', 'assets', 'admin', 'backend', 'cdn', 'www', 'static'}
2025-12-03 21:27:46,523 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/clientes/
2025-12-03 21:27:46,523 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/clientes/NaN/
2025-12-03 21:27:46,530 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/clientes/NaN/estadisticas/
2025-12-03 21:27:46,530 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 21:27:46,530 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 21:27:46,530 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:27:46,530 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:27:46,530 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:27:46,530 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:27:46,530 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:27:46,530 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:27:46,530 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:27:46,530 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 21:27:46,530 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/clientes/
2025-12-03 21:27:46,530 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 21:27:46,530 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 21:27:46,530 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:27:46,530 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:27:46,530 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:27:46,539 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:27:46,539 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:27:46,539 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:27:46,539 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:27:46,541 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 21:27:46,541 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/clientes/NaN/
2025-12-03 21:27:46,541 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 21:27:46,541 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 21:27:46,541 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:27:46,541 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:27:46,541 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:27:46,541 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:27:46,541 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:27:46,541 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:27:46,541 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:27:46,541 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 21:27:46,541 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/clientes/NaN/estadisticas/
2025-12-03 21:27:46,550 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] AsyncEngine creado para admin
2025-12-03 21:27:46,723 - app.core.exceptions - WARNING - RequestValidationError en /api/v1/clientes/NaN/: ["El parámetro 'path.cliente_id' tiene un valor inválido (NaN). Se espera un UUID válido."]
2025-12-03 21:27:46,728 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/clientes/NaN/ 422 199.8ms
2025-12-03 21:27:46,732 - app.core.exceptions - WARNING - RequestValidationError en /api/v1/clientes/NaN/estadisticas/: ["El parámetro 'path.cliente_id' tiene un valor inválido (NaN). Se espera un UUID válido."]
2025-12-03 21:27:46,734 - app.modules.tenant.presentation.endpoints_clientes - INFO - Solicitud GET /clientes/ recibida - skip: 0, limit: 10, solo_activos: True, buscar: None por usuario: superadmin
2025-12-03 21:27:46,734 - app.modules.tenant.application.services.cliente_service - INFO - Listando clientes - skip: 0, limit: 10, solo_activos: True, buscar: None
2025-12-03 21:27:46,734 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/clientes/NaN/
2025-12-03 21:27:46,736 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 21:27:46,736 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 21:27:46,736 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:27:46,738 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:27:46,738 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:27:46,738 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:27:46,739 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:27:46,740 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:27:46,740 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:27:46,741 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 21:27:46,741 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/clientes/NaN/
2025-12-03 21:27:46,742 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/clientes/NaN/estadisticas/ 422 212.9ms
2025-12-03 21:27:46,742 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/clientes/NaN/estadisticas/
2025-12-03 21:27:46,742 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 21:27:46,742 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 21:27:46,742 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:27:46,742 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:27:46,742 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:27:46,750 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:27:46,750 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:27:46,750 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:27:46,750 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:27:46,750 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 21:27:46,750 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/clientes/NaN/estadisticas/
2025-12-03 21:27:46,767 - app.modules.tenant.application.services.cliente_service - INFO - Listados 5 clientes de 5 totales
2025-12-03 21:27:46,769 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/clientes/ 200 240.1ms
2025-12-03 21:27:46,781 - app.core.exceptions - WARNING - RequestValidationError en /api/v1/clientes/NaN/: ["El parámetro 'path.cliente_id' tiene un valor inválido (NaN). Se espera un UUID válido."]
2025-12-03 21:27:46,782 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/clientes/NaN/ 422 47.7ms
2025-12-03 21:27:46,784 - app.core.exceptions - WARNING - RequestValidationError en /api/v1/clientes/NaN/estadisticas/: ["El parámetro 'path.cliente_id' tiene un valor inválido (NaN). Se espera un UUID válido."]
2025-12-03 21:27:46,786 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/clientes/NaN/estadisticas/ 422 40.5ms
2025-12-03 21:27:50,662 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/clientes/
2025-12-03 21:27:50,664 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 21:27:50,665 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 21:27:50,665 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:27:50,666 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:27:50,667 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:27:50,667 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:27:50,668 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:27:50,668 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:27:50,668 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:27:50,670 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 21:27:50,671 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/clientes/
2025-12-03 21:27:50,690 - app.modules.tenant.presentation.endpoints_clientes - INFO - Solicitud GET /clientes/ recibida - skip: 0, limit: 10, solo_activos: True, buscar: None por usuario: superadmin
2025-12-03 21:27:50,691 - app.modules.tenant.application.services.cliente_service - INFO - Listando clientes - skip: 0, limit: 10, solo_activos: True, buscar: None
2025-12-03 21:27:50,695 - app.modules.tenant.application.services.cliente_service - INFO - Listados 5 clientes de 5 totales
2025-12-03 21:27:50,695 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/clientes/ 200 35.6ms
2025-12-03 21:27:50,700 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/clientes/
2025-12-03 21:27:50,700 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 21:27:50,700 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 21:27:50,700 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:27:50,700 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:27:50,700 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:27:50,700 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:27:50,700 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:27:50,700 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:27:50,700 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:27:50,700 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 21:27:50,700 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/clientes/
2025-12-03 21:27:50,724 - app.modules.tenant.presentation.endpoints_clientes - INFO - Solicitud GET /clientes/ recibida - skip: 0, limit: 10, solo_activos: True, buscar: None por usuario: superadmin
2025-12-03 21:27:50,724 - app.modules.tenant.application.services.cliente_service - INFO - Listando clientes - skip: 0, limit: 10, solo_activos: True, buscar: None
2025-12-03 21:27:50,730 - app.modules.tenant.application.services.cliente_service - INFO - Listados 5 clientes de 5 totales
2025-12-03 21:27:50,730 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/clientes/ 200 31.6ms
2025-12-03 21:27:51,489 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/modulos/
2025-12-03 21:27:51,489 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/modulos/ 200 1.3ms
2025-12-03 21:27:51,490 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/modulos/
2025-12-03 21:27:51,491 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/modulos/ 200 1.5ms
2025-12-03 21:27:51,493 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/modulos/
2025-12-03 21:27:51,494 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 21:27:51,494 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 21:27:51,496 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:27:51,497 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:27:51,497 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:27:51,497 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:27:51,497 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:27:51,497 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:27:51,497 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:27:51,497 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 21:27:51,500 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/modulos/
2025-12-03 21:27:51,514 - app.modules.tenant.presentation.endpoints_modulos - INFO - Solicitud GET /modulos/ recibida - skip: 0, limit: 20, solo_activos: True
2025-12-03 21:27:51,514 - app.modules.tenant.application.services.modulo_service - INFO - Obteniendo catálogo de módulos - skip: 0, limit: 20
2025-12-03 21:27:51,521 - app.modules.tenant.application.services.modulo_service - INFO - Contando total de módulos en el sistema
2025-12-03 21:27:51,521 - app.modules.tenant.presentation.endpoints_modulos - INFO - Catálogo de módulos recuperado: 4 módulos de 4 totales
2025-12-03 21:27:51,528 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/modulos/ 200 34.9ms
2025-12-03 21:27:51,531 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/modulos/
2025-12-03 21:27:51,532 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 21:27:51,533 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 21:27:51,533 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:27:51,533 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:27:51,534 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:27:51,534 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:27:51,535 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:27:51,535 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:27:51,536 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:27:51,536 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 21:27:51,536 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/modulos/
2025-12-03 21:27:51,550 - app.modules.tenant.presentation.endpoints_modulos - INFO - Solicitud GET /modulos/ recibida - skip: 0, limit: 20, solo_activos: True
2025-12-03 21:27:51,550 - app.modules.tenant.application.services.modulo_service - INFO - Obteniendo catálogo de módulos - skip: 0, limit: 20
2025-12-03 21:27:51,550 - app.modules.tenant.application.services.modulo_service - INFO - Contando total de módulos en el sistema
2025-12-03 21:27:51,550 - app.modules.tenant.presentation.endpoints_modulos - INFO - Catálogo de módulos recuperado: 4 módulos de 4 totales
2025-12-03 21:27:51,560 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/modulos/ 200 29.0ms
2025-12-03 21:27:57,321 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/modulos/
2025-12-03 21:27:57,322 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 21:27:57,323 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 21:27:57,323 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:27:57,323 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:27:57,324 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:27:57,324 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:27:57,325 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:27:57,325 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:27:57,326 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:27:57,326 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 21:27:57,326 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/modulos/
2025-12-03 21:27:57,340 - app.modules.tenant.presentation.endpoints_modulos - INFO - Solicitud GET /modulos/ recibida - skip: 0, limit: 20, solo_activos: True
2025-12-03 21:27:57,340 - app.modules.tenant.application.services.modulo_service - INFO - Obteniendo catálogo de módulos - skip: 0, limit: 20
2025-12-03 21:27:57,345 - app.modules.tenant.application.services.modulo_service - INFO - Contando total de módulos en el sistema
2025-12-03 21:27:57,345 - app.modules.tenant.presentation.endpoints_modulos - INFO - Catálogo de módulos recuperado: 4 módulos de 4 totales
2025-12-03 21:27:57,345 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/modulos/ 200 28.1ms
2025-12-03 21:28:02,805 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/modulos/
2025-12-03 21:28:02,806 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 21:28:02,807 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 21:28:02,807 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:28:02,808 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:28:02,808 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:28:02,809 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:28:02,809 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:28:02,810 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:28:02,810 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:28:02,810 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 21:28:02,810 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/modulos/
2025-12-03 21:28:02,830 - app.modules.tenant.presentation.endpoints_modulos - INFO - Solicitud GET /modulos/ recibida - skip: 0, limit: 20, solo_activos: True
2025-12-03 21:28:02,830 - app.modules.tenant.application.services.modulo_service - INFO - Obteniendo catálogo de módulos - skip: 0, limit: 20
2025-12-03 21:28:02,830 - app.modules.tenant.application.services.modulo_service - INFO - Contando total de módulos en el sistema
2025-12-03 21:28:02,830 - app.modules.tenant.presentation.endpoints_modulos - INFO - Catálogo de módulos recuperado: 4 módulos de 4 totales
2025-12-03 21:28:02,830 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/modulos/ 200 32.4ms
2025-12-03 21:28:02,840 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/modulos/
2025-12-03 21:28:02,840 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 21:28:02,840 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 21:28:02,841 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:28:02,842 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:28:02,842 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:28:02,842 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:28:02,843 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:28:02,843 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:28:02,844 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:28:02,844 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 21:28:02,845 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/modulos/
2025-12-03 21:28:02,860 - app.modules.tenant.presentation.endpoints_modulos - INFO - Solicitud GET /modulos/ recibida - skip: 0, limit: 20, solo_activos: True
2025-12-03 21:28:02,861 - app.modules.tenant.application.services.modulo_service - INFO - Obteniendo catálogo de módulos - skip: 0, limit: 20
2025-12-03 21:28:02,864 - app.modules.tenant.application.services.modulo_service - INFO - Contando total de módulos en el sistema
2025-12-03 21:28:02,867 - app.modules.tenant.presentation.endpoints_modulos - INFO - Catálogo de módulos recuperado: 4 módulos de 4 totales
2025-12-03 21:28:02,868 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/modulos/ 200 28.5ms
2025-12-03 21:28:04,555 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/clientes/
2025-12-03 21:28:04,556 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 21:28:04,556 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 21:28:04,557 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:28:04,557 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:28:04,557 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:28:04,558 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:28:04,558 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:28:04,559 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:28:04,559 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:28:04,560 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 21:28:04,560 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/clientes/
2025-12-03 21:28:04,580 - app.modules.tenant.presentation.endpoints_clientes - INFO - Solicitud GET /clientes/ recibida - skip: 0, limit: 10, solo_activos: True, buscar: None por usuario: superadmin
2025-12-03 21:28:04,580 - app.modules.tenant.application.services.cliente_service - INFO - Listando clientes - skip: 0, limit: 10, solo_activos: True, buscar: None
2025-12-03 21:28:04,580 - app.modules.tenant.application.services.cliente_service - INFO - Listados 5 clientes de 5 totales
2025-12-03 21:28:04,580 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/clientes/ 200 32.2ms
2025-12-03 21:28:04,580 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/clientes/
2025-12-03 21:28:04,590 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 21:28:04,590 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 21:28:04,590 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:28:04,591 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:28:04,591 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:28:04,591 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:28:04,591 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:28:04,593 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:28:04,594 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:28:04,594 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 21:28:04,595 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/clientes/
2025-12-03 21:28:04,610 - app.modules.tenant.presentation.endpoints_clientes - INFO - Solicitud GET /clientes/ recibida - skip: 0, limit: 10, solo_activos: True, buscar: None por usuario: superadmin
2025-12-03 21:28:04,611 - app.modules.tenant.application.services.cliente_service - INFO - Listando clientes - skip: 0, limit: 10, solo_activos: True, buscar: None
2025-12-03 21:28:04,617 - app.modules.tenant.application.services.cliente_service - INFO - Listados 5 clientes de 5 totales
2025-12-03 21:28:04,618 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/clientes/ 200 29.4ms
2025-12-03 21:28:05,242 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/modulos/
2025-12-03 21:28:05,244 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 21:28:05,244 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 21:28:05,245 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:28:05,245 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:28:05,246 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:28:05,246 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:28:05,247 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:28:05,247 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:28:05,248 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:28:05,248 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 21:28:05,249 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/modulos/
2025-12-03 21:28:05,261 - app.modules.tenant.presentation.endpoints_modulos - INFO - Solicitud GET /modulos/ recibida - skip: 0, limit: 20, solo_activos: True
2025-12-03 21:28:05,261 - app.modules.tenant.application.services.modulo_service - INFO - Obteniendo catálogo de módulos - skip: 0, limit: 20
2025-12-03 21:28:05,270 - app.modules.tenant.application.services.modulo_service - INFO - Contando total de módulos en el sistema
2025-12-03 21:28:05,270 - app.modules.tenant.presentation.endpoints_modulos - INFO - Catálogo de módulos recuperado: 4 módulos de 4 totales
2025-12-03 21:28:05,270 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/modulos/ 200 30.8ms
2025-12-03 21:28:05,275 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/modulos/
2025-12-03 21:28:05,275 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 21:28:05,276 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 21:28:05,276 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:28:05,278 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:28:05,278 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:28:05,278 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:28:05,278 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:28:05,278 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:28:05,280 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:28:05,280 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 21:28:05,280 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/modulos/
2025-12-03 21:28:05,296 - app.modules.tenant.presentation.endpoints_modulos - INFO - Solicitud GET /modulos/ recibida - skip: 0, limit: 20, solo_activos: True
2025-12-03 21:28:05,296 - app.modules.tenant.application.services.modulo_service - INFO - Obteniendo catálogo de módulos - skip: 0, limit: 20
2025-12-03 21:28:05,300 - app.modules.tenant.application.services.modulo_service - INFO - Contando total de módulos en el sistema
2025-12-03 21:28:05,303 - app.modules.tenant.presentation.endpoints_modulos - INFO - Catálogo de módulos recuperado: 4 módulos de 4 totales
2025-12-03 21:28:05,304 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/modulos/ 200 28.7ms
2025-12-03 21:28:08,195 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/modulos/search/
2025-12-03 21:28:08,195 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/modulos/search/ 200 0.8ms
2025-12-03 21:28:08,195 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/modulos/search/
2025-12-03 21:28:08,195 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 21:28:08,195 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 21:28:08,195 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:28:08,195 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:28:08,200 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:28:08,200 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:28:08,200 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:28:08,200 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:28:08,200 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:28:08,200 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 21:28:08,200 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/modulos/search/
2025-12-03 21:28:08,213 - app.modules.tenant.presentation.endpoints_modulos - INFO - Solicitud GET /modulos/search/ - buscar: pla, core: None, licencia: None
2025-12-03 21:28:08,213 - app.modules.tenant.application.services.modulo_service - INFO - Buscando módulos con filtros - buscar: pla, core: None, licencia: None
2025-12-03 21:28:08,228 - app.modules.tenant.application.services.modulo_service - INFO - Contando módulos con filtros de búsqueda
2025-12-03 21:28:08,230 - app.modules.tenant.presentation.endpoints_modulos - INFO - Búsqueda completada: 1 módulos de 1 totales
2025-12-03 21:28:08,235 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/modulos/search/ 200 36.5ms
2025-12-03 21:28:09,995 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/modulos/
2025-12-03 21:28:09,997 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 21:28:09,997 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 21:28:09,997 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:28:09,998 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:28:09,998 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:28:09,998 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:28:09,998 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:28:09,998 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:28:10,000 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:28:10,000 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 21:28:10,000 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/modulos/
2025-12-03 21:28:10,014 - app.modules.tenant.presentation.endpoints_modulos - INFO - Solicitud GET /modulos/ recibida - skip: 0, limit: 20, solo_activos: True
2025-12-03 21:28:10,014 - app.modules.tenant.application.services.modulo_service - INFO - Obteniendo catálogo de módulos - skip: 0, limit: 20
2025-12-03 21:28:10,014 - app.modules.tenant.application.services.modulo_service - INFO - Contando total de módulos en el sistema
2025-12-03 21:28:10,020 - app.modules.tenant.presentation.endpoints_modulos - INFO - Catálogo de módulos recuperado: 4 módulos de 4 totales
2025-12-03 21:28:10,020 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/modulos/ 200 26.7ms
2025-12-03 21:28:10,904 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/clientes/
2025-12-03 21:28:10,905 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 21:28:10,905 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 21:28:10,906 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:28:10,906 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:28:10,906 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:28:10,907 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:28:10,907 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:28:10,907 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:28:10,909 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:28:10,909 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 21:28:10,909 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/clientes/
2025-12-03 21:28:10,930 - app.modules.tenant.presentation.endpoints_clientes - INFO - Solicitud GET /clientes/ recibida - skip: 0, limit: 10, solo_activos: True, buscar: None por usuario: superadmin
2025-12-03 21:28:10,931 - app.modules.tenant.application.services.cliente_service - INFO - Listando clientes - skip: 0, limit: 10, solo_activos: True, buscar: None
2025-12-03 21:28:10,939 - app.modules.tenant.application.services.cliente_service - INFO - Listados 5 clientes de 5 totales
2025-12-03 21:28:10,939 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/clientes/ 200 35.2ms
2025-12-03 21:28:10,941 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/clientes/
2025-12-03 21:28:10,941 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 21:28:10,941 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 21:28:10,943 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:28:10,943 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:28:10,944 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:28:10,944 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:28:10,945 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:28:10,945 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:28:10,946 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:28:10,946 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 21:28:10,947 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/clientes/
2025-12-03 21:28:10,970 - app.modules.tenant.presentation.endpoints_clientes - INFO - Solicitud GET /clientes/ recibida - skip: 0, limit: 10, solo_activos: True, buscar: None por usuario: superadmin
2025-12-03 21:28:10,970 - app.modules.tenant.application.services.cliente_service - INFO - Listando clientes - skip: 0, limit: 10, solo_activos: True, buscar: None
2025-12-03 21:28:10,976 - app.modules.tenant.application.services.cliente_service - INFO - Listados 5 clientes de 5 totales
2025-12-03 21:28:10,979 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/clientes/ 200 37.3ms
2025-12-03 21:28:58,417 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/auth/refresh/
2025-12-03 21:28:58,418 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/auth/refresh/ 200 1.0ms
2025-12-03 21:28:58,420 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/refresh/
2025-12-03 21:28:58,421 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 21:28:58,421 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 21:28:58,421 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:28:58,421 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:28:58,421 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:28:58,421 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:28:58,421 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:28:58,421 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:28:58,421 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:28:58,421 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 21:28:58,421 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/auth/refresh/
2025-12-03 21:28:58,445 - app.modules.auth.application.services.refresh_token_service - INFO - [VALIDATE-TOKEN] Token válido - Cliente BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, Usuario 154134AD-A5EB-4F45-AEF0-5F9AAA282C8E, Tipo: web
2025-12-03 21:28:58,453 - app.modules.auth.application.services.auth_service - INFO - [REFRESH] Token validado exitosamente (BD OK) para usuario: superadmin (Cliente: BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, Level: 5, Type: super_admin)
2025-12-03 21:28:58,466 - app.modules.auth.application.services.auth_service - INFO - Niveles calculados - Usuario 154134AD-A5EB-4F45-AEF0-5F9AAA282C8E: level=5, super_admin=True, type=super_admin
2025-12-03 21:28:58,482 - app.modules.auth.application.services.refresh_token_service - INFO - [STORE-TOKEN] Token insertado exitosamente - Cliente BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, Usuario 154134AD-A5EB-4F45-AEF0-5F9AAA282C8E, Tipo: web, Token ID: 42A2B69C-3EA8-4B33-A404-A50C41866119, Rotación: True
2025-12-03 21:28:58,505 - app.modules.auth.application.services.refresh_token_service - WARNING - [REVOKE-TOKEN] Token no encontrado o ya revocado - Cliente BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, Usuario 154134AD-A5EB-4F45-AEF0-5F9AAA282C8E
2025-12-03 21:28:58,505 - app.modules.auth.presentation.endpoints - WARNING - [REFRESH] Token antiguo no encontrado para revocar (no crítico)
2025-12-03 21:28:58,507 - app.modules.auth.presentation.endpoints - INFO - [REFRESH-WEB] Token rotado exitosamente - ID: 42A2B69C-3EA8-4B33-A404-A50C41866119
2025-12-03 21:28:58,507 - app.modules.auth.presentation.endpoints - INFO - [REFRESH-WEB] Token refrescado exitosamente - Usuario: superadmin
2025-12-03 21:28:58,520 - app.modules.superadmin.application.services.audit_service - INFO - [AUDIT] auth_audit_log registrado: evento=token_refresh, cliente_id=BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, usuario_id=154134AD-A5EB-4F45-AEF0-5F9AAA282C8E, exito=True
2025-12-03 21:28:58,521 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/refresh/ 200 101.0ms
2025-12-03 21:28:58,525 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/auth/me/
2025-12-03 21:28:58,525 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/auth/me/ 200 0.9ms
2025-12-03 21:28:58,527 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/auth/me/
2025-12-03 21:28:58,529 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 21:28:58,529 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 21:28:58,529 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:28:58,530 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:28:58,530 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:28:58,531 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:28:58,532 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:28:58,532 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:28:58,532 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:28:58,532 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 21:28:58,532 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/auth/me/
2025-12-03 21:28:58,539 - app.modules.auth.presentation.endpoints - INFO - Solicitud /me/ recibida para usuario: superadmin
2025-12-03 21:28:58,541 - app.modules.auth.presentation.endpoints - INFO - [ME] Niveles desde token - Level: 5, Super Admin: True, Type: super_admin
2025-12-03 21:28:58,541 - app.modules.users.application.services.user_service - INFO - Obteniendo usuario completo ID 154134AD-A5EB-4F45-AEF0-5F9AAA282C8E para cliente BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7
2025-12-03 21:28:58,541 - app.infrastructure.database.queries_async - WARNING - [QUERY] DEPRECATED: execute_query() recibió string SQL. Migrar a SQLAlchemy Core.
2025-12-03 21:28:58,563 - app.modules.users.application.services.user_service - INFO - Usuario completo obtenido exitosamente: ID 154134AD-A5EB-4F45-AEF0-5F9AAA282C8E con 1 roles activos
2025-12-03 21:28:58,564 - app.modules.auth.presentation.endpoints - INFO - [ME] Datos completos enviados - Usuario: superadmin, Type: super_admin, Level: 5, Super Admin: True, Roles: 1
2025-12-03 21:28:58,566 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/auth/me/ 200 38.3ms
2025-12-03 21:28:58,566 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/clientes/tenant/branding
2025-12-03 21:28:58,571 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/clientes/tenant/branding 200 0.9ms
2025-12-03 21:28:58,571 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/clientes/tenant/branding
2025-12-03 21:28:58,571 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 21:28:58,571 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 21:28:58,571 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:28:58,571 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:28:58,571 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:28:58,571 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:28:58,571 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:28:58,571 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:28:58,571 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:28:58,571 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 21:28:58,571 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/clientes/tenant/branding
2025-12-03 21:28:58,586 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/menus/getmenu/
2025-12-03 21:28:58,588 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/menus/getmenu/ 200 1.7ms
2025-12-03 21:28:58,591 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/menus/getmenu/
2025-12-03 21:28:58,591 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/clientes/
2025-12-03 21:28:58,591 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 21:28:58,591 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 21:28:58,591 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:28:58,591 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:28:58,591 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:28:58,591 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:28:58,591 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:28:58,591 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:28:58,597 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:28:58,598 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 21:28:58,598 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/clientes/
2025-12-03 21:28:58,599 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/menus/getmenu/ 200 9.1ms
2025-12-03 21:28:58,603 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/menus/getmenu/
2025-12-03 21:28:58,603 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 21:28:58,605 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 21:28:58,605 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:28:58,605 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:28:58,605 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:28:58,605 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:28:58,607 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:28:58,607 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:28:58,607 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:28:58,607 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 21:28:58,609 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/menus/getmenu/
2025-12-03 21:28:58,649 - app.modules.tenant.presentation.endpoints_clientes - INFO - Solicitud GET /tenant/branding recibida para cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7 por usuario: superadmin
2025-12-03 21:28:58,649 - app.modules.tenant.application.services.cliente_service - INFO - Solicitando branding para cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:28:58,652 - app.modules.tenant.application.services.cliente_service - INFO - Branding obtenido exitosamente para cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:28:58,661 - app.modules.menus.presentation.endpoints - INFO - Solicitud GET /menus/getmenu/ recibida para usuario ID: 154134ad-a5eb-4f45-aef0-5f9aaa282c8e del cliente bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:28:58,661 - app.modules.menus.application.services.menu_service - INFO - Obteniendo menú filtrado para usuario_id: 154134ad-a5eb-4f45-aef0-5f9aaa282c8e
2025-12-03 21:28:58,663 - app.modules.tenant.presentation.endpoints_clientes - INFO - Solicitud GET /clientes/ recibida - skip: 0, limit: 10, solo_activos: True, buscar: None por usuario: superadmin
2025-12-03 21:28:58,663 - app.modules.tenant.application.services.cliente_service - INFO - Listando clientes - skip: 0, limit: 10, solo_activos: True, buscar: None
2025-12-03 21:28:58,666 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/clientes/tenant/branding 200 92.9ms
2025-12-03 21:28:58,671 - app.modules.tenant.application.services.cliente_service - INFO - Listados 5 clientes de 5 totales
2025-12-03 21:28:58,678 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/clientes/ 200 88.0ms
2025-12-03 21:28:58,680 - app.modules.menus.application.services.menu_service - INFO - No se encontraron menús permitidos para el usuario ID: 154134ad-a5eb-4f45-aef0-5f9aaa282c8e.
2025-12-03 21:28:58,682 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/menus/getmenu/ 200 78.9ms
2025-12-03 21:28:58,684 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/clientes/
2025-12-03 21:28:58,685 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 21:28:58,685 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 21:28:58,685 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:28:58,685 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:28:58,685 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:28:58,685 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:28:58,685 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:28:58,685 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:28:58,689 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:28:58,689 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 21:28:58,689 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/clientes/
2025-12-03 21:28:58,691 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/menus/getmenu/
2025-12-03 21:28:58,693 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 21:28:58,693 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 21:28:58,693 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:28:58,693 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:28:58,695 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:28:58,695 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:28:58,695 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:28:58,695 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:28:58,697 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:28:58,697 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 21:28:58,697 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/menus/getmenu/
2025-12-03 21:28:58,727 - app.modules.tenant.presentation.endpoints_clientes - INFO - Solicitud GET /clientes/ recibida - skip: 0, limit: 10, solo_activos: True, buscar: None por usuario: superadmin
2025-12-03 21:28:58,728 - app.modules.tenant.application.services.cliente_service - INFO - Listando clientes - skip: 0, limit: 10, solo_activos: True, buscar: None
2025-12-03 21:28:58,729 - app.modules.menus.presentation.endpoints - INFO - Solicitud GET /menus/getmenu/ recibida para usuario ID: 154134ad-a5eb-4f45-aef0-5f9aaa282c8e del cliente bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:28:58,729 - app.modules.menus.application.services.menu_service - INFO - Obteniendo menú filtrado para usuario_id: 154134ad-a5eb-4f45-aef0-5f9aaa282c8e
2025-12-03 21:28:58,733 - app.modules.menus.application.services.menu_service - INFO - No se encontraron menús permitidos para el usuario ID: 154134ad-a5eb-4f45-aef0-5f9aaa282c8e.
2025-12-03 21:28:58,733 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/menus/getmenu/ 200 44.7ms
2025-12-03 21:28:58,740 - app.modules.tenant.application.services.cliente_service - INFO - Listados 5 clientes de 5 totales
2025-12-03 21:28:58,741 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/clientes/ 200 57.1ms
2025-12-03 21:29:00,547 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/clientes/NaN/
2025-12-03 21:29:00,548 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 21:29:00,548 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 21:29:00,550 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:29:00,550 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:29:00,551 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:29:00,551 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:29:00,552 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:29:00,552 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:29:00,553 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:29:00,553 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 21:29:00,554 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/clientes/NaN/
2025-12-03 21:29:00,554 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/clientes/NaN/estadisticas/
2025-12-03 21:29:00,554 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 21:29:00,554 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 21:29:00,554 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:29:00,554 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:29:00,554 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:29:00,554 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:29:00,554 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:29:00,554 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:29:00,554 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:29:00,554 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 21:29:00,561 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/clientes/NaN/estadisticas/
2025-12-03 21:29:00,583 - app.core.exceptions - WARNING - RequestValidationError en /api/v1/clientes/NaN/: ["El parámetro 'path.cliente_id' tiene un valor inválido (NaN). Se espera un UUID válido."]
2025-12-03 21:29:00,584 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/clientes/NaN/ 422 38.2ms
2025-12-03 21:29:00,584 - app.core.exceptions - WARNING - RequestValidationError en /api/v1/clientes/NaN/estadisticas/: ["El parámetro 'path.cliente_id' tiene un valor inválido (NaN). Se espera un UUID válido."]
2025-12-03 21:29:00,584 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/clientes/NaN/
2025-12-03 21:29:00,584 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 21:29:00,584 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 21:29:00,589 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:29:00,589 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:29:00,589 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:29:00,589 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:29:00,591 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:29:00,591 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:29:00,591 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:29:00,591 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 21:29:00,591 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/clientes/NaN/
2025-12-03 21:29:00,591 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/clientes/NaN/estadisticas/ 422 37.7ms
2025-12-03 21:29:00,591 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/clientes/NaN/estadisticas/
2025-12-03 21:29:00,591 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 21:29:00,591 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 21:29:00,591 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:29:00,591 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:29:00,599 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:29:00,599 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:29:00,599 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:29:00,600 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:29:00,601 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:29:00,601 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 21:29:00,602 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/clientes/NaN/estadisticas/
2025-12-03 21:29:00,621 - app.core.exceptions - WARNING - RequestValidationError en /api/v1/clientes/NaN/: ["El parámetro 'path.cliente_id' tiene un valor inválido (NaN). Se espera un UUID válido."]
2025-12-03 21:29:00,621 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/clientes/NaN/ 422 40.1ms
2025-12-03 21:29:00,621 - app.core.exceptions - WARNING - RequestValidationError en /api/v1/clientes/NaN/estadisticas/: ["El parámetro 'path.cliente_id' tiene un valor inválido (NaN). Se espera un UUID válido."]
2025-12-03 21:29:00,621 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/clientes/NaN/estadisticas/ 422 34.8ms
2025-12-03 21:29:09,988 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/clientes/
2025-12-03 21:29:09,989 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 21:29:09,989 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 21:29:09,991 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:29:09,991 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:29:09,992 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:29:09,993 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:29:09,993 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:29:09,994 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:29:09,994 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:29:09,995 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 21:29:09,996 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/clientes/
2025-12-03 21:29:10,014 - app.modules.tenant.presentation.endpoints_clientes - INFO - Solicitud GET /clientes/ recibida - skip: 0, limit: 10, solo_activos: True, buscar: None por usuario: superadmin
2025-12-03 21:29:10,015 - app.modules.tenant.application.services.cliente_service - INFO - Listando clientes - skip: 0, limit: 10, solo_activos: True, buscar: None
2025-12-03 21:29:10,021 - app.modules.tenant.application.services.cliente_service - INFO - Listados 5 clientes de 5 totales
2025-12-03 21:29:10,023 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/clientes/ 200 33.9ms
2025-12-03 21:29:10,025 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/clientes/
2025-12-03 21:29:10,025 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 21:29:10,026 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 21:29:10,026 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:29:10,027 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:29:10,027 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:29:10,029 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:29:10,029 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:29:10,029 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:29:10,030 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:29:10,030 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 21:29:10,031 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/clientes/
2025-12-03 21:29:10,049 - app.modules.tenant.presentation.endpoints_clientes - INFO - Solicitud GET /clientes/ recibida - skip: 0, limit: 10, solo_activos: True, buscar: None por usuario: superadmin
2025-12-03 21:29:10,049 - app.modules.tenant.application.services.cliente_service - INFO - Listando clientes - skip: 0, limit: 10, solo_activos: True, buscar: None
2025-12-03 21:29:10,055 - app.modules.tenant.application.services.cliente_service - INFO - Listados 5 clientes de 5 totales
2025-12-03 21:29:10,056 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/clientes/ 200 31.3ms
2025-12-03 21:29:14,564 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/clientes/
2025-12-03 21:29:14,565 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 21:29:14,566 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 21:29:14,566 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:29:14,567 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:29:14,567 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:29:14,567 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:29:14,568 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:29:14,568 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:29:14,569 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:29:14,569 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 21:29:14,569 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/clientes/
2025-12-03 21:29:14,582 - app.modules.tenant.presentation.endpoints_clientes - INFO - Solicitud GET /clientes/ recibida - skip: 0, limit: 10, solo_activos: True, buscar: None por usuario: superadmin
2025-12-03 21:29:14,582 - app.modules.tenant.application.services.cliente_service - INFO - Listando clientes - skip: 0, limit: 10, solo_activos: True, buscar: None
2025-12-03 21:29:14,582 - app.modules.tenant.application.services.cliente_service - INFO - Listados 5 clientes de 5 totales
2025-12-03 21:29:14,582 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/clientes/ 200 29.1ms
2025-12-03 21:29:16,698 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/clientes/
2025-12-03 21:29:16,699 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 21:29:16,699 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 21:29:16,700 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:29:16,700 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:29:16,701 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:29:16,701 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 21:29:16,702 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:29:16,702 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 21:29:16,702 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 21:29:16,703 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 21:29:16,703 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/clientes/
2025-12-03 21:29:16,721 - app.modules.tenant.presentation.endpoints_clientes - INFO - Solicitud GET /clientes/ recibida - skip: 0, limit: 10, solo_activos: True, buscar: None por usuario: superadmin
2025-12-03 21:29:16,721 - app.modules.tenant.application.services.cliente_service - INFO - Listando clientes - skip: 0, limit: 10, solo_activos: True, buscar: None
2025-12-03 21:29:16,721 - app.modules.tenant.application.services.cliente_service - INFO - Listados 5 clientes de 5 totales
2025-12-03 21:29:16,731 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/clientes/ 200 32.6ms
2025-12-03 21:30:36,568 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Pool ADMIN inicializado. Size=10, MaxOverflow=5
2025-12-03 21:30:36,569 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Configuración de pools de tenants: MaxPools=50, PoolSize=3, MaxOverflow=2, InactivityTimeout=3600s
2025-12-03 21:30:36,570 - app.infrastructure.database.connection_pool - INFO - ✅ Módulo de connection pooling cargado y activo
2025-12-03 21:30:36,570 - app.infrastructure.database.connection_pool - INFO -    Configuración: MaxTenantPools=50, TenantPoolSize=3, InactivityTimeout=3600s
2025-12-03 21:30:36,570 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Todos los pools cerrados
2025-12-03 21:30:36,571 - app.main - INFO - ✅ Pools de conexión cerrados correctamente
2025-12-03 21:30:37,504 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 21:30:37,723 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 21:30:37,730 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 21:30:37,733 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 21:30:37,734 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 21:30:37,735 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 21:30:37,736 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 21:30:37,736 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, DEFAULT_TYPE=single
2025-12-03 21:30:38,127 - app.core.security.rate_limiting - INFO - [RATE_LIMITING] Activado. Límites: Login=10/minute, API=200/minute
2025-12-03 21:30:38,128 - app.core.security.rate_limiting - INFO - ✅ Módulo de rate limiting cargado y activo
2025-12-03 21:30:38,221 - app.core.authorization.rbac - INFO - 🔐 Inicializando sistema de autorización...
2025-12-03 21:30:38,221 - app.core.authorization.rbac - INFO - ✅ Sistema de autorización inicializado correctamente
2025-12-03 21:30:38,221 - app.core.authorization.rbac - INFO - 📊 Permisos del sistema: 6 módulos configurados
2025-12-03 21:30:38,458 - app.core.tenant.middleware - INFO - Módulo tenant_middleware cargado (versión híbrida con soporte para proxies)
2025-12-03 21:30:38,459 - app.main - INFO - ✅ Rate limiting configurado y activo
2025-12-03 21:30:38,656 - app.core.tenant.middleware - INFO - [TENANT_MW] Inicializado - BASE_DOMAIN=app.local, SYSTEM_ID=BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, EXCLUDED_SUBDOMAINS={'backend', 'assets', 'admin', 'api', 'www', 'cdn', 'static'}
2025-12-03 21:40:46,023 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/auth/refresh/
2025-12-03 21:40:46,024 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/auth/refresh/ 200 1.2ms
2025-12-03 21:40:46,028 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/refresh/
2025-12-03 21:40:46,029 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 21:40:46,029 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': techcorp.app.local:5173
2025-12-03 21:40:46,030 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'techcorp.app.local'
2025-12-03 21:40:46,030 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:40:46,031 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'techcorp'
2025-12-03 21:40:46,034 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'techcorp.app.local'
2025-12-03 21:40:46,035 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:40:46,035 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'techcorp'
2025-12-03 21:40:46,049 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='techcorp', Código='TECH003', ID=58f3cce8-037b-45da-91c3-497fd61f31e5
2025-12-03 21:40:50,198 - app.infrastructure.cache.redis_cache - WARNING - [REDIS_CACHE] Error conectando a Redis: Error 10061 connecting to localhost:6379. No se puede establecer una conexión ya que el equipo de destino denegó expresamente dicha conexión.. Cache desactivado automáticamente (usando fallback en memoria).
2025-12-03 21:40:50,198 - app.infrastructure.cache.redis_cache - INFO - ℹ️ Módulo de Redis cache cargado pero desactivado (usando fallback en memoria)
2025-12-03 21:40:50,202 - app.core.tenant.routing - WARNING - [METADATA] No se encontró metadata para cliente 58f3cce8-037b-45da-91c3-497fd61f31e5. Usando Single-DB como fallback.
2025-12-03 21:40:50,207 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 21:40:50,207 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=58f3cce8-037b-45da-91c3-497fd61f31e5, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/auth/refresh/
2025-12-03 21:40:50,210 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] AsyncEngine creado para tenant_58f3cce8-037b-45da-91c3-497fd61f31e5
2025-12-03 21:40:50,307 - app.modules.auth.application.services.refresh_token_service - WARNING - [VALIDATE-TOKEN] Token no encontrado, revocado o expirado - Cliente 58f3cce8-037b-45da-91c3-497fd61f31e5
2025-12-03 21:40:50,308 - app.modules.auth.application.services.auth_service - WARNING - [REFRESH] Token JWT válido, pero inactivo/revocado en BD. Usuario: superadmin
2025-12-03 21:40:50,322 - app.modules.superadmin.application.services.audit_service - INFO - [AUDIT] auth_audit_log registrado: evento=token_invalid_or_revoked, cliente_id=BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, usuario_id=None, exito=False
2025-12-03 21:40:50,322 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/refresh/ 401 4296.3ms
2025-12-03 21:41:02,510 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/auth/login/
2025-12-03 21:41:02,510 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/auth/login/ 200 0.9ms
2025-12-03 21:41:02,513 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/login/
2025-12-03 21:41:02,514 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 21:41:02,514 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': techcorp.app.local:5173
2025-12-03 21:41:02,515 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'techcorp.app.local'
2025-12-03 21:41:02,515 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:41:02,515 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'techcorp'
2025-12-03 21:41:02,516 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'techcorp.app.local'
2025-12-03 21:41:02,516 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:41:02,517 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'techcorp'
2025-12-03 21:41:02,523 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='techcorp', Código='TECH003', ID=58f3cce8-037b-45da-91c3-497fd61f31e5
2025-12-03 21:41:02,523 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 21:41:02,523 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=58f3cce8-037b-45da-91c3-497fd61f31e5, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/auth/login/
2025-12-03 21:41:02,532 - app.modules.auth.presentation.endpoints - INFO - Cliente 58f3cce8-037b-45da-91c3-497fd61f31e5 resuelto y validado para login.
2025-12-03 21:41:02,532 - app.modules.auth.application.services.auth_service - INFO - [AUTH] Intento de login: username='admin_tech', cliente_id_destino=58f3cce8-037b-45da-91c3-497fd61f31e5
2025-12-03 21:41:02,532 - app.modules.auth.application.services.auth_service - INFO - [AUTH] Usuario regular. Buscando en BD del cliente_id=58f3cce8-037b-45da-91c3-497fd61f31e5
2025-12-03 21:41:02,782 - app.modules.auth.application.services.auth_service - INFO - Niveles calculados - Usuario BA168EDA-B78F-4596-93B9-88AFC2D3A28E: level=4, super_admin=False, type=tenant_admin
2025-12-03 21:41:02,782 - app.modules.auth.application.services.auth_service - INFO - [AUTH] Login exitoso: username='admin_tech', usuario_id=BA168EDA-B78F-4596-93B9-88AFC2D3A28E, cliente_origen=58F3CCE8-037B-45DA-91C3-497FD61F31E5, cliente_destino=N/A, access_level=4, user_type=tenant_admin
2025-12-03 21:41:02,782 - app.infrastructure.database.queries_async - WARNING - [QUERY] DEPRECATED: execute_query() recibió string SQL. Migrar a SQLAlchemy Core.
2025-12-03 21:41:02,795 - app.modules.auth.application.services.auth_service - INFO - Niveles calculados - Usuario BA168EDA-B78F-4596-93B9-88AFC2D3A28E: level=4, super_admin=False, type=tenant_admin
2025-12-03 21:41:02,807 - app.modules.auth.application.services.refresh_token_service - INFO - [STORE-TOKEN] Token insertado exitosamente - Cliente 58f3cce8-037b-45da-91c3-497fd61f31e5, Usuario BA168EDA-B78F-4596-93B9-88AFC2D3A28E, Tipo: web, Token ID: E1953685-91FA-453F-BFC3-736DA055A80C, Rotación: False
2025-12-03 21:41:02,808 - app.modules.auth.presentation.endpoints - INFO - [LOGIN-WEB] Token almacenado - ID: E1953685-91FA-453F-BFC3-736DA055A80C
2025-12-03 21:41:02,809 - app.modules.auth.presentation.endpoints - INFO - Usuario admin_tech autenticado exitosamente (WEB) para cliente 58f3cce8-037b-45da-91c3-497fd61f31e5
2025-12-03 21:41:02,813 - app.modules.superadmin.application.services.audit_service - INFO - [AUDIT] auth_audit_log registrado: evento=login_success, cliente_id=58f3cce8-037b-45da-91c3-497fd61f31e5, usuario_id=BA168EDA-B78F-4596-93B9-88AFC2D3A28E, exito=True
2025-12-03 21:41:02,813 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/login/ 200 303.6ms
2025-12-03 21:41:02,827 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/clientes/tenant/branding
2025-12-03 21:41:02,828 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/clientes/tenant/branding 200 1.0ms
2025-12-03 21:41:02,831 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/clientes/tenant/branding
2025-12-03 21:41:02,831 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 21:41:02,832 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': techcorp.app.local:5173
2025-12-03 21:41:02,832 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'techcorp.app.local'
2025-12-03 21:41:02,833 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:41:02,833 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'techcorp'
2025-12-03 21:41:02,834 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'techcorp.app.local'
2025-12-03 21:41:02,834 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:41:02,835 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'techcorp'
2025-12-03 21:41:02,841 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='techcorp', Código='TECH003', ID=58f3cce8-037b-45da-91c3-497fd61f31e5
2025-12-03 21:41:02,842 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 21:41:02,842 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=58f3cce8-037b-45da-91c3-497fd61f31e5, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/clientes/tenant/branding
2025-12-03 21:41:02,854 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/menus/getmenu/
2025-12-03 21:41:02,858 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/menus/getmenu/ 200 3.1ms
2025-12-03 21:41:02,859 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/roles/all-active/
2025-12-03 21:41:02,859 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/menus/getmenu/
2025-12-03 21:41:02,859 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/usuarios/
2025-12-03 21:41:02,859 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/usuarios/
2025-12-03 21:41:02,859 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/roles/all-active/
2025-12-03 21:41:02,862 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/roles/all-active/ 200 4.6ms
2025-12-03 21:41:02,862 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/menus/getmenu/ 200 4.3ms
2025-12-03 21:41:02,862 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/usuarios/ 200 4.1ms
2025-12-03 21:41:02,865 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/usuarios/ 200 4.0ms
2025-12-03 21:41:02,865 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/roles/all-active/ 200 4.0ms
2025-12-03 21:41:02,871 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/menus/getmenu/
2025-12-03 21:41:02,873 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 21:41:02,874 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': techcorp.app.local:5173
2025-12-03 21:41:02,875 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'techcorp.app.local'
2025-12-03 21:41:02,875 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:41:02,875 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'techcorp'
2025-12-03 21:41:02,876 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'techcorp.app.local'
2025-12-03 21:41:02,876 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:41:02,878 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'techcorp'
2025-12-03 21:41:02,879 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/roles/all-active/
2025-12-03 21:41:02,880 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 21:41:02,881 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': techcorp.app.local:5173
2025-12-03 21:41:02,881 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'techcorp.app.local'
2025-12-03 21:41:02,882 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:41:02,882 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'techcorp'
2025-12-03 21:41:02,882 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'techcorp.app.local'
2025-12-03 21:41:02,883 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:41:02,883 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'techcorp'
2025-12-03 21:41:02,886 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/usuarios/
2025-12-03 21:41:02,886 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 21:41:02,888 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': techcorp.app.local:5173
2025-12-03 21:41:02,888 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'techcorp.app.local'
2025-12-03 21:41:02,889 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:41:02,889 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'techcorp'
2025-12-03 21:41:02,890 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'techcorp.app.local'
2025-12-03 21:41:02,890 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:41:02,891 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'techcorp'
2025-12-03 21:41:02,898 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='techcorp', Código='TECH003', ID=58f3cce8-037b-45da-91c3-497fd61f31e5
2025-12-03 21:41:02,899 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 21:41:02,899 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=58f3cce8-037b-45da-91c3-497fd61f31e5, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/roles/all-active/
2025-12-03 21:41:02,900 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='techcorp', Código='TECH003', ID=58f3cce8-037b-45da-91c3-497fd61f31e5
2025-12-03 21:41:02,900 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 21:41:02,902 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=58f3cce8-037b-45da-91c3-497fd61f31e5, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/menus/getmenu/
2025-12-03 21:41:02,905 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='techcorp', Código='TECH003', ID=58f3cce8-037b-45da-91c3-497fd61f31e5
2025-12-03 21:41:02,906 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 21:41:02,906 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=58f3cce8-037b-45da-91c3-497fd61f31e5, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/usuarios/
2025-12-03 21:41:02,929 - app.modules.tenant.presentation.endpoints_clientes - INFO - Solicitud GET /tenant/branding recibida para cliente_id=58f3cce8-037b-45da-91c3-497fd61f31e5 por usuario: admin_tech
2025-12-03 21:41:02,930 - app.modules.tenant.application.services.cliente_service - INFO - Solicitando branding para cliente_id=58f3cce8-037b-45da-91c3-497fd61f31e5
2025-12-03 21:41:02,933 - app.modules.tenant.application.services.cliente_service - INFO - Branding obtenido exitosamente para cliente_id=58f3cce8-037b-45da-91c3-497fd61f31e5
2025-12-03 21:41:02,939 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/clientes/tenant/branding 200 108.8ms
2025-12-03 21:41:02,957 - app.infrastructure.database.queries_async - WARNING - [QUERY] DEPRECATED: execute_query() recibió string SQL. Migrar a SQLAlchemy Core.
2025-12-03 21:41:02,958 - app.modules.menus.presentation.endpoints - INFO - Solicitud GET /menus/getmenu/ recibida para usuario ID: ba168eda-b78f-4596-93b9-88afc2d3a28e del cliente 58f3cce8-037b-45da-91c3-497fd61f31e5
2025-12-03 21:41:02,959 - app.modules.menus.application.services.menu_service - INFO - Obteniendo menú filtrado para usuario_id: ba168eda-b78f-4596-93b9-88afc2d3a28e
2025-12-03 21:41:02,962 - app.infrastructure.database.queries_async - WARNING - [QUERY] DEPRECATED: execute_query() recibió string SQL. Migrar a SQLAlchemy Core.
2025-12-03 21:41:02,969 - app.modules.menus.application.services.menu_helper - INFO - Árbol de menú construido con 5 items raíz.
2025-12-03 21:41:02,969 - app.modules.menus.application.services.menu_service - INFO - Árbol de menú construido para usuario ba168eda-b78f-4596-93b9-88afc2d3a28e con 5 items raíz.
2025-12-03 21:41:02,972 - app.modules.rbac.presentation.endpoints - INFO - Solicitud GET /roles/all-active/ recibida por usuario ba168eda-b78f-4596-93b9-88afc2d3a28e del cliente 58f3cce8-037b-45da-91c3-497fd61f31e5 para lista simple
2025-12-03 21:41:02,973 - app.modules.rbac.application.services.rol_service - ERROR - Error inesperado en get_all_active_roles: 'coroutine' object is not iterable
Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\modules\rbac\application\services\rol_service.py", line 799, in get_all_active_roles
    for rol_dict in resultados:
                    ^^^^^^^^^^
TypeError: 'coroutine' object is not iterable
2025-12-03 21:41:02,974 - app.modules.rbac.presentation.endpoints - ERROR - Error de servicio en endpoint /roles/all-active/ para cliente 58f3cce8-037b-45da-91c3-497fd61f31e5: Error interno al obtener roles activos
2025-12-03 21:41:02,975 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/menus/getmenu/ 200 103.5ms
2025-12-03 21:41:02,987 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/roles/all-active/ 500 108.9ms
2025-12-03 21:41:02,990 - app.modules.users.presentation.endpoints - INFO - Solicitud GET /usuarios/ recibida por usuario ba168eda-b78f-4596-93b9-88afc2d3a28e del cliente 58f3cce8-037b-45da-91c3-497fd61f31e5 - Paginación: page=1, limit=10, Búsqueda: 'None'
2025-12-03 21:41:02,990 - app.modules.users.application.services.user_service - INFO - Obteniendo usuarios paginados para cliente 58f3cce8-037b-45da-91c3-497fd61f31e5: page=1, limit=10, search='None'
2025-12-03 21:41:02,991 - app.infrastructure.database.queries_async - WARNING - [QUERY] DEPRECATED: execute_query() recibió string SQL. Migrar a SQLAlchemy Core.
2025-12-03 21:41:02,993 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/menus/getmenu/
2025-12-03 21:41:02,994 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 21:41:02,994 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': techcorp.app.local:5173
2025-12-03 21:41:02,994 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'techcorp.app.local'
2025-12-03 21:41:02,996 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:41:02,996 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'techcorp'
2025-12-03 21:41:02,996 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'techcorp.app.local'
2025-12-03 21:41:02,997 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:41:02,997 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'techcorp'
2025-12-03 21:41:03,000 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/roles/all-active/
2025-12-03 21:41:03,001 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 21:41:03,002 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': techcorp.app.local:5173
2025-12-03 21:41:03,002 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'techcorp.app.local'
2025-12-03 21:41:03,003 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:41:03,003 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'techcorp'
2025-12-03 21:41:03,004 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'techcorp.app.local'
2025-12-03 21:41:03,004 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:41:03,004 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'techcorp'
2025-12-03 21:41:03,011 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='techcorp', Código='TECH003', ID=58f3cce8-037b-45da-91c3-497fd61f31e5
2025-12-03 21:41:03,012 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 21:41:03,012 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=58f3cce8-037b-45da-91c3-497fd61f31e5, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/menus/getmenu/
2025-12-03 21:41:03,015 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='techcorp', Código='TECH003', ID=58f3cce8-037b-45da-91c3-497fd61f31e5
2025-12-03 21:41:03,015 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 21:41:03,015 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=58f3cce8-037b-45da-91c3-497fd61f31e5, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/roles/all-active/
2025-12-03 21:41:03,015 - app.infrastructure.database.queries_async - WARNING - [QUERY] DEPRECATED: execute_query() recibió string SQL. Migrar a SQLAlchemy Core.
2025-12-03 21:41:03,032 - app.modules.users.application.services.user_service - INFO - [USUARIOS-PAGINADOS] Procesados 2 usuarios únicos de 2 filas crudas
2025-12-03 21:41:03,032 - app.modules.users.application.services.user_service - INFO - Obtención paginada de usuarios completada exitosamente
2025-12-03 21:41:03,032 - app.modules.users.presentation.endpoints - INFO - Lista paginada de usuarios recuperada para cliente 58f3cce8-037b-45da-91c3-497fd61f31e5 - Total: 2, Página: 1
2025-12-03 21:41:03,042 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/usuarios/ 200 156.1ms
2025-12-03 21:41:03,047 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/usuarios/
2025-12-03 21:41:03,049 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 21:41:03,049 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': techcorp.app.local:5173
2025-12-03 21:41:03,050 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'techcorp.app.local'
2025-12-03 21:41:03,050 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:41:03,051 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'techcorp'
2025-12-03 21:41:03,051 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'techcorp.app.local'
2025-12-03 21:41:03,052 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:41:03,053 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'techcorp'
2025-12-03 21:41:03,059 - app.modules.menus.presentation.endpoints - INFO - Solicitud GET /menus/getmenu/ recibida para usuario ID: ba168eda-b78f-4596-93b9-88afc2d3a28e del cliente 58f3cce8-037b-45da-91c3-497fd61f31e5
2025-12-03 21:41:03,060 - app.modules.menus.application.services.menu_service - INFO - Obteniendo menú filtrado para usuario_id: ba168eda-b78f-4596-93b9-88afc2d3a28e
2025-12-03 21:41:03,062 - app.infrastructure.database.queries_async - WARNING - [QUERY] DEPRECATED: execute_query() recibió string SQL. Migrar a SQLAlchemy Core.
2025-12-03 21:41:03,064 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='techcorp', Código='TECH003', ID=58f3cce8-037b-45da-91c3-497fd61f31e5
2025-12-03 21:41:03,065 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 21:41:03,065 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=58f3cce8-037b-45da-91c3-497fd61f31e5, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/usuarios/
2025-12-03 21:41:03,069 - app.modules.rbac.presentation.endpoints - INFO - Solicitud GET /roles/all-active/ recibida por usuario ba168eda-b78f-4596-93b9-88afc2d3a28e del cliente 58f3cce8-037b-45da-91c3-497fd61f31e5 para lista simple
2025-12-03 21:41:03,069 - app.modules.rbac.application.services.rol_service - ERROR - Error inesperado en get_all_active_roles: 'coroutine' object is not iterable
Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\modules\rbac\application\services\rol_service.py", line 799, in get_all_active_roles
    for rol_dict in resultados:
                    ^^^^^^^^^^
TypeError: 'coroutine' object is not iterable
2025-12-03 21:41:03,071 - app.modules.rbac.presentation.endpoints - ERROR - Error de servicio en endpoint /roles/all-active/ para cliente 58f3cce8-037b-45da-91c3-497fd61f31e5: Error interno al obtener roles activos
2025-12-03 21:41:03,072 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/roles/all-active/ 500 71.5ms
2025-12-03 21:41:03,074 - app.modules.menus.application.services.menu_helper - INFO - Árbol de menú construido con 5 items raíz.
2025-12-03 21:41:03,075 - app.modules.menus.application.services.menu_service - INFO - Árbol de menú construido para usuario ba168eda-b78f-4596-93b9-88afc2d3a28e con 5 items raíz.
2025-12-03 21:41:03,080 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/menus/getmenu/ 200 87.3ms
2025-12-03 21:41:03,094 - app.infrastructure.database.queries_async - WARNING - [QUERY] DEPRECATED: execute_query() recibió string SQL. Migrar a SQLAlchemy Core.
2025-12-03 21:41:03,098 - app.modules.users.presentation.endpoints - INFO - Solicitud GET /usuarios/ recibida por usuario ba168eda-b78f-4596-93b9-88afc2d3a28e del cliente 58f3cce8-037b-45da-91c3-497fd61f31e5 - Paginación: page=1, limit=10, Búsqueda: 'None'
2025-12-03 21:41:03,098 - app.modules.users.application.services.user_service - INFO - Obteniendo usuarios paginados para cliente 58f3cce8-037b-45da-91c3-497fd61f31e5: page=1, limit=10, search='None'
2025-12-03 21:41:03,098 - app.infrastructure.database.queries_async - WARNING - [QUERY] DEPRECATED: execute_query() recibió string SQL. Migrar a SQLAlchemy Core.
2025-12-03 21:41:03,103 - app.infrastructure.database.queries_async - WARNING - [QUERY] DEPRECATED: execute_query() recibió string SQL. Migrar a SQLAlchemy Core.
2025-12-03 21:41:03,109 - app.modules.users.application.services.user_service - INFO - [USUARIOS-PAGINADOS] Procesados 2 usuarios únicos de 2 filas crudas
2025-12-03 21:41:03,109 - app.modules.users.application.services.user_service - INFO - Obtención paginada de usuarios completada exitosamente
2025-12-03 21:41:03,112 - app.modules.users.presentation.endpoints - INFO - Lista paginada de usuarios recuperada para cliente 58f3cce8-037b-45da-91c3-497fd61f31e5 - Total: 2, Página: 1
2025-12-03 21:41:03,112 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/usuarios/ 200 65.3ms
2025-12-03 21:41:10,159 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/roles/
2025-12-03 21:41:10,161 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/roles/ 200 1.4ms
2025-12-03 21:41:10,161 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/roles/
2025-12-03 21:41:10,162 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/roles/ 200 1.4ms
2025-12-03 21:41:10,166 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/roles/
2025-12-03 21:41:10,166 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 21:41:10,167 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': techcorp.app.local:5173
2025-12-03 21:41:10,167 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'techcorp.app.local'
2025-12-03 21:41:10,169 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:41:10,169 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'techcorp'
2025-12-03 21:41:10,170 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'techcorp.app.local'
2025-12-03 21:41:10,170 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:41:10,170 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'techcorp'
2025-12-03 21:41:10,175 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='techcorp', Código='TECH003', ID=58f3cce8-037b-45da-91c3-497fd61f31e5
2025-12-03 21:41:10,176 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 21:41:10,176 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=58f3cce8-037b-45da-91c3-497fd61f31e5, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/roles/
2025-12-03 21:41:10,195 - app.infrastructure.database.queries_async - WARNING - [QUERY] DEPRECATED: execute_query() recibió string SQL. Migrar a SQLAlchemy Core.
2025-12-03 21:41:10,199 - app.modules.rbac.presentation.endpoints - INFO - Solicitud GET /roles/ recibida por usuario ba168eda-b78f-4596-93b9-88afc2d3a28e del cliente 58f3cce8-037b-45da-91c3-497fd61f31e5 - Paginación: page=1, limit=10, Búsqueda: 'None'
2025-12-03 21:41:10,200 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/roles/ N/A 34.7ms
2025-12-03 21:41:10,201 - app.core.exceptions - ERROR - Error no manejado: '<=' not supported between instances of 'UUID' and 'int'
  + Exception Group Traceback (most recent call last):
  |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 76, in collapse_excgroups
  |     yield
  |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 186, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\anyio\_backends\_asyncio.py", line 815, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\errors.py", line 165, in __call__
    |     await self.app(scope, receive, _send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    |     with collapse_excgroups():
    |          ^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\app\main.py", line 223, in security_headers
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    |     raise app_exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    |     with collapse_excgroups():
    |          ^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\app\main.py", line 214, in log_requests
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    |     raise app_exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    |     with collapse_excgroups():
    |          ^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\app\main.py", line 191, in cors_middleware
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    |     raise app_exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    |     with collapse_excgroups():
    |          ^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\app\core\tenant\middleware.py", line 396, in dispatch
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    |     raise app_exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\exceptions.py", line 62, in __call__
    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 715, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 735, in app
    |     await route.handle(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 288, in handle
    |     await self.app(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 76, in app
    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 73, in app
    |     response = await f(request)
    |                ^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\fastapi\routing.py", line 301, in app
    |     raw_response = await run_endpoint_function(
    |                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\fastapi\routing.py", line 212, in run_endpoint_function
    |     return await dependant.call(**values)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\app\modules\rbac\presentation\endpoints.py", line 179, in read_roles_paginated
    |     if not current_user.cliente_id or current_user.cliente_id <= 0:
    |                                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    | TypeError: '<=' not supported between instances of 'UUID' and 'int'
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\errors.py", line 165, in __call__
    await self.app(scope, receive, _send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    with collapse_excgroups():
         ^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\main.py", line 223, in security_headers
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    raise app_exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    with collapse_excgroups():
         ^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\main.py", line 214, in log_requests
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    raise app_exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    with collapse_excgroups():
         ^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\main.py", line 191, in cors_middleware
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    raise app_exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    with collapse_excgroups():
         ^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\core\tenant\middleware.py", line 396, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    raise app_exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 715, in __call__
    await self.middleware_stack(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 735, in app
    await route.handle(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 288, in handle
    await self.app(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 76, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 73, in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\fastapi\routing.py", line 301, in app
    raw_response = await run_endpoint_function(
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\fastapi\routing.py", line 212, in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\modules\rbac\presentation\endpoints.py", line 179, in read_roles_paginated
    if not current_user.cliente_id or current_user.cliente_id <= 0:
                                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
TypeError: '<=' not supported between instances of 'UUID' and 'int'
2025-12-03 21:41:10,324 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/roles/
2025-12-03 21:41:10,325 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 21:41:10,325 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': techcorp.app.local:5173
2025-12-03 21:41:10,326 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'techcorp.app.local'
2025-12-03 21:41:10,326 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:41:10,327 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'techcorp'
2025-12-03 21:41:10,327 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'techcorp.app.local'
2025-12-03 21:41:10,328 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:41:10,328 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'techcorp'
2025-12-03 21:41:10,335 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='techcorp', Código='TECH003', ID=58f3cce8-037b-45da-91c3-497fd61f31e5
2025-12-03 21:41:10,335 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 21:41:10,336 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=58f3cce8-037b-45da-91c3-497fd61f31e5, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/roles/
2025-12-03 21:41:10,356 - app.infrastructure.database.queries_async - WARNING - [QUERY] DEPRECATED: execute_query() recibió string SQL. Migrar a SQLAlchemy Core.
2025-12-03 21:41:10,360 - app.modules.rbac.presentation.endpoints - INFO - Solicitud GET /roles/ recibida por usuario ba168eda-b78f-4596-93b9-88afc2d3a28e del cliente 58f3cce8-037b-45da-91c3-497fd61f31e5 - Paginación: page=1, limit=10, Búsqueda: 'None'
2025-12-03 21:41:10,361 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/roles/ N/A 37.0ms
2025-12-03 21:41:10,362 - app.core.exceptions - ERROR - Error no manejado: '<=' not supported between instances of 'UUID' and 'int'
  + Exception Group Traceback (most recent call last):
  |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 76, in collapse_excgroups
  |     yield
  |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 186, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\anyio\_backends\_asyncio.py", line 815, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\errors.py", line 165, in __call__
    |     await self.app(scope, receive, _send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    |     with collapse_excgroups():
    |          ^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\app\main.py", line 223, in security_headers
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    |     raise app_exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    |     with collapse_excgroups():
    |          ^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\app\main.py", line 214, in log_requests
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    |     raise app_exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    |     with collapse_excgroups():
    |          ^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\app\main.py", line 191, in cors_middleware
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    |     raise app_exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    |     with collapse_excgroups():
    |          ^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\app\core\tenant\middleware.py", line 396, in dispatch
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    |     raise app_exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\exceptions.py", line 62, in __call__
    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 715, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 735, in app
    |     await route.handle(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 288, in handle
    |     await self.app(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 76, in app
    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 73, in app
    |     response = await f(request)
    |                ^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\fastapi\routing.py", line 301, in app
    |     raw_response = await run_endpoint_function(
    |                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\fastapi\routing.py", line 212, in run_endpoint_function
    |     return await dependant.call(**values)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\app\modules\rbac\presentation\endpoints.py", line 179, in read_roles_paginated
    |     if not current_user.cliente_id or current_user.cliente_id <= 0:
    |                                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    | TypeError: '<=' not supported between instances of 'UUID' and 'int'
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\errors.py", line 165, in __call__
    await self.app(scope, receive, _send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    with collapse_excgroups():
         ^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\main.py", line 223, in security_headers
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    raise app_exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    with collapse_excgroups():
         ^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\main.py", line 214, in log_requests
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    raise app_exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    with collapse_excgroups():
         ^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\main.py", line 191, in cors_middleware
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    raise app_exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    with collapse_excgroups():
         ^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\core\tenant\middleware.py", line 396, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    raise app_exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 715, in __call__
    await self.middleware_stack(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 735, in app
    await route.handle(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 288, in handle
    await self.app(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 76, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 73, in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\fastapi\routing.py", line 301, in app
    raw_response = await run_endpoint_function(
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\fastapi\routing.py", line 212, in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\modules\rbac\presentation\endpoints.py", line 179, in read_roles_paginated
    if not current_user.cliente_id or current_user.cliente_id <= 0:
                                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
TypeError: '<=' not supported between instances of 'UUID' and 'int'
2025-12-03 21:41:10,653 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/areas/
2025-12-03 21:41:10,654 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/areas/
2025-12-03 21:41:10,654 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/areas/ 200 2.5ms
2025-12-03 21:41:10,654 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/areas/ 200 2.1ms
2025-12-03 21:41:10,654 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/areas/
2025-12-03 21:41:10,654 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 21:41:10,661 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': techcorp.app.local:5173
2025-12-03 21:41:10,661 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'techcorp.app.local'
2025-12-03 21:41:10,662 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:41:10,663 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'techcorp'
2025-12-03 21:41:10,663 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'techcorp.app.local'
2025-12-03 21:41:10,664 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:41:10,665 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'techcorp'
2025-12-03 21:41:10,671 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='techcorp', Código='TECH003', ID=58f3cce8-037b-45da-91c3-497fd61f31e5
2025-12-03 21:41:10,671 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 21:41:10,671 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=58f3cce8-037b-45da-91c3-497fd61f31e5, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/areas/
2025-12-03 21:41:10,685 - app.infrastructure.database.queries_async - WARNING - [QUERY] DEPRECATED: execute_query() recibió string SQL. Migrar a SQLAlchemy Core.
2025-12-03 21:41:10,692 - app.modules.menus.presentation.endpoints_areas - INFO - Solicitud GET /areas/ recibida por usuario ba168eda-b78f-4596-93b9-88afc2d3a28e del cliente 58f3cce8-037b-45da-91c3-497fd61f31e5 - Paginación: skip=0, limit=10, Búsqueda: 'None'
2025-12-03 21:41:10,692 - app.modules.menus.application.services.area_service - INFO - Obteniendo áreas paginadas para cliente 58f3cce8-037b-45da-91c3-497fd61f31e5: skip=0, limit=10, search='None'
2025-12-03 21:41:10,692 - app.infrastructure.database.queries_async - WARNING - [QUERY] DEPRECATED: execute_query() recibió string SQL. Migrar a SQLAlchemy Core.
2025-12-03 21:41:10,702 - app.infrastructure.database.queries_async - WARNING - [QUERY] DEPRECATED: execute_query() recibió string SQL. Migrar a SQLAlchemy Core.
2025-12-03 21:41:10,708 - app.modules.menus.application.services.area_service - ERROR - Error mapeando área: 1 validation error for AreaRead
cliente_id
  UUID input should be a string, bytes or UUID object [type=uuid_type, input_value=None, input_type=NoneType]
    For further information visit https://errors.pydantic.dev/2.10/v/uuid_type
2025-12-03 21:41:10,709 - app.modules.menus.application.services.area_service - ERROR - Error mapeando área: 1 validation error for AreaRead
cliente_id
  UUID input should be a string, bytes or UUID object [type=uuid_type, input_value=None, input_type=NoneType]
    For further information visit https://errors.pydantic.dev/2.10/v/uuid_type
2025-12-03 21:41:10,709 - app.modules.menus.application.services.area_service - ERROR - Error mapeando área: 1 validation error for AreaRead
cliente_id
  UUID input should be a string, bytes or UUID object [type=uuid_type, input_value=None, input_type=NoneType]
    For further information visit https://errors.pydantic.dev/2.10/v/uuid_type
2025-12-03 21:41:10,710 - app.modules.menus.application.services.area_service - ERROR - Error mapeando área: 1 validation error for AreaRead
cliente_id
  UUID input should be a string, bytes or UUID object [type=uuid_type, input_value=None, input_type=NoneType]
    For further information visit https://errors.pydantic.dev/2.10/v/uuid_type
2025-12-03 21:41:10,710 - app.modules.menus.application.services.area_service - INFO - Paginación completada para cliente 58f3cce8-037b-45da-91c3-497fd61f31e5: 0 áreas de 4 totales
2025-12-03 21:41:10,711 - app.modules.menus.presentation.endpoints_areas - INFO - Lista paginada de áreas recuperada para cliente 58f3cce8-037b-45da-91c3-497fd61f31e5 - Total: 4, Página: 1
2025-12-03 21:41:10,712 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/areas/ 200 52.8ms
2025-12-03 21:41:10,714 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/areas/
2025-12-03 21:41:10,715 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 21:41:10,716 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': techcorp.app.local:5173
2025-12-03 21:41:10,716 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'techcorp.app.local'
2025-12-03 21:41:10,717 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:41:10,717 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'techcorp'
2025-12-03 21:41:10,718 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'techcorp.app.local'
2025-12-03 21:41:10,718 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:41:10,718 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'techcorp'
2025-12-03 21:41:10,723 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='techcorp', Código='TECH003', ID=58f3cce8-037b-45da-91c3-497fd61f31e5
2025-12-03 21:41:10,723 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 21:41:10,723 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=58f3cce8-037b-45da-91c3-497fd61f31e5, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/areas/
2025-12-03 21:41:10,742 - app.infrastructure.database.queries_async - WARNING - [QUERY] DEPRECATED: execute_query() recibió string SQL. Migrar a SQLAlchemy Core.
2025-12-03 21:41:10,742 - app.modules.menus.presentation.endpoints_areas - INFO - Solicitud GET /areas/ recibida por usuario ba168eda-b78f-4596-93b9-88afc2d3a28e del cliente 58f3cce8-037b-45da-91c3-497fd61f31e5 - Paginación: skip=0, limit=10, Búsqueda: 'None'
2025-12-03 21:41:10,742 - app.modules.menus.application.services.area_service - INFO - Obteniendo áreas paginadas para cliente 58f3cce8-037b-45da-91c3-497fd61f31e5: skip=0, limit=10, search='None'
2025-12-03 21:41:10,742 - app.infrastructure.database.queries_async - WARNING - [QUERY] DEPRECATED: execute_query() recibió string SQL. Migrar a SQLAlchemy Core.
2025-12-03 21:41:10,751 - app.infrastructure.database.queries_async - WARNING - [QUERY] DEPRECATED: execute_query() recibió string SQL. Migrar a SQLAlchemy Core.
2025-12-03 21:41:10,756 - app.modules.menus.application.services.area_service - ERROR - Error mapeando área: 1 validation error for AreaRead
cliente_id
  UUID input should be a string, bytes or UUID object [type=uuid_type, input_value=None, input_type=NoneType]
    For further information visit https://errors.pydantic.dev/2.10/v/uuid_type
2025-12-03 21:41:10,757 - app.modules.menus.application.services.area_service - ERROR - Error mapeando área: 1 validation error for AreaRead
cliente_id
  UUID input should be a string, bytes or UUID object [type=uuid_type, input_value=None, input_type=NoneType]
    For further information visit https://errors.pydantic.dev/2.10/v/uuid_type
2025-12-03 21:41:10,757 - app.modules.menus.application.services.area_service - ERROR - Error mapeando área: 1 validation error for AreaRead
cliente_id
  UUID input should be a string, bytes or UUID object [type=uuid_type, input_value=None, input_type=NoneType]
    For further information visit https://errors.pydantic.dev/2.10/v/uuid_type
2025-12-03 21:41:10,758 - app.modules.menus.application.services.area_service - ERROR - Error mapeando área: 1 validation error for AreaRead
cliente_id
  UUID input should be a string, bytes or UUID object [type=uuid_type, input_value=None, input_type=NoneType]
    For further information visit https://errors.pydantic.dev/2.10/v/uuid_type
2025-12-03 21:41:10,758 - app.modules.menus.application.services.area_service - INFO - Paginación completada para cliente 58f3cce8-037b-45da-91c3-497fd61f31e5: 0 áreas de 4 totales
2025-12-03 21:41:10,759 - app.modules.menus.presentation.endpoints_areas - INFO - Lista paginada de áreas recuperada para cliente 58f3cce8-037b-45da-91c3-497fd61f31e5 - Total: 4, Página: 1
2025-12-03 21:41:10,760 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/areas/ 200 45.6ms
2025-12-03 21:41:11,846 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/roles/
2025-12-03 21:41:11,847 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 21:41:11,848 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': techcorp.app.local:5173
2025-12-03 21:41:11,848 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'techcorp.app.local'
2025-12-03 21:41:11,849 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:41:11,850 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'techcorp'
2025-12-03 21:41:11,850 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'techcorp.app.local'
2025-12-03 21:41:11,852 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:41:11,852 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'techcorp'
2025-12-03 21:41:11,857 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='techcorp', Código='TECH003', ID=58f3cce8-037b-45da-91c3-497fd61f31e5
2025-12-03 21:41:11,857 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 21:41:11,858 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=58f3cce8-037b-45da-91c3-497fd61f31e5, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/roles/
2025-12-03 21:41:11,874 - app.infrastructure.database.queries_async - WARNING - [QUERY] DEPRECATED: execute_query() recibió string SQL. Migrar a SQLAlchemy Core.
2025-12-03 21:41:11,879 - app.modules.rbac.presentation.endpoints - INFO - Solicitud GET /roles/ recibida por usuario ba168eda-b78f-4596-93b9-88afc2d3a28e del cliente 58f3cce8-037b-45da-91c3-497fd61f31e5 - Paginación: page=1, limit=10, Búsqueda: 'None'
2025-12-03 21:41:11,880 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/roles/ N/A 33.6ms
2025-12-03 21:41:11,881 - app.core.exceptions - ERROR - Error no manejado: '<=' not supported between instances of 'UUID' and 'int'
  + Exception Group Traceback (most recent call last):
  |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 76, in collapse_excgroups
  |     yield
  |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 186, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\anyio\_backends\_asyncio.py", line 815, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\errors.py", line 165, in __call__
    |     await self.app(scope, receive, _send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    |     with collapse_excgroups():
    |          ^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\app\main.py", line 223, in security_headers
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    |     raise app_exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    |     with collapse_excgroups():
    |          ^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\app\main.py", line 214, in log_requests
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    |     raise app_exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    |     with collapse_excgroups():
    |          ^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\app\main.py", line 191, in cors_middleware
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    |     raise app_exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    |     with collapse_excgroups():
    |          ^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\app\core\tenant\middleware.py", line 396, in dispatch
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    |     raise app_exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\exceptions.py", line 62, in __call__
    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 715, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 735, in app
    |     await route.handle(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 288, in handle
    |     await self.app(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 76, in app
    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 73, in app
    |     response = await f(request)
    |                ^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\fastapi\routing.py", line 301, in app
    |     raw_response = await run_endpoint_function(
    |                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\fastapi\routing.py", line 212, in run_endpoint_function
    |     return await dependant.call(**values)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\app\modules\rbac\presentation\endpoints.py", line 179, in read_roles_paginated
    |     if not current_user.cliente_id or current_user.cliente_id <= 0:
    |                                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    | TypeError: '<=' not supported between instances of 'UUID' and 'int'
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\errors.py", line 165, in __call__
    await self.app(scope, receive, _send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    with collapse_excgroups():
         ^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\main.py", line 223, in security_headers
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    raise app_exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    with collapse_excgroups():
         ^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\main.py", line 214, in log_requests
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    raise app_exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    with collapse_excgroups():
         ^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\main.py", line 191, in cors_middleware
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    raise app_exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    with collapse_excgroups():
         ^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\core\tenant\middleware.py", line 396, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    raise app_exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 715, in __call__
    await self.middleware_stack(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 735, in app
    await route.handle(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 288, in handle
    await self.app(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 76, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 73, in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\fastapi\routing.py", line 301, in app
    raw_response = await run_endpoint_function(
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\fastapi\routing.py", line 212, in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\modules\rbac\presentation\endpoints.py", line 179, in read_roles_paginated
    if not current_user.cliente_id or current_user.cliente_id <= 0:
                                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
TypeError: '<=' not supported between instances of 'UUID' and 'int'
2025-12-03 21:41:11,894 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/roles/
2025-12-03 21:41:11,894 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 21:41:11,896 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': techcorp.app.local:5173
2025-12-03 21:41:11,896 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'techcorp.app.local'
2025-12-03 21:41:11,896 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:41:11,896 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'techcorp'
2025-12-03 21:41:11,896 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'techcorp.app.local'
2025-12-03 21:41:11,898 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:41:11,898 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'techcorp'
2025-12-03 21:41:11,905 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='techcorp', Código='TECH003', ID=58f3cce8-037b-45da-91c3-497fd61f31e5
2025-12-03 21:41:11,905 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 21:41:11,906 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=58f3cce8-037b-45da-91c3-497fd61f31e5, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/roles/
2025-12-03 21:41:11,924 - app.infrastructure.database.queries_async - WARNING - [QUERY] DEPRECATED: execute_query() recibió string SQL. Migrar a SQLAlchemy Core.
2025-12-03 21:41:11,924 - app.modules.rbac.presentation.endpoints - INFO - Solicitud GET /roles/ recibida por usuario ba168eda-b78f-4596-93b9-88afc2d3a28e del cliente 58f3cce8-037b-45da-91c3-497fd61f31e5 - Paginación: page=1, limit=10, Búsqueda: 'None'
2025-12-03 21:41:11,924 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/roles/ N/A 33.2ms
2025-12-03 21:41:11,924 - app.core.exceptions - ERROR - Error no manejado: '<=' not supported between instances of 'UUID' and 'int'
  + Exception Group Traceback (most recent call last):
  |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 76, in collapse_excgroups
  |     yield
  |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 186, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\anyio\_backends\_asyncio.py", line 815, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\errors.py", line 165, in __call__
    |     await self.app(scope, receive, _send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    |     with collapse_excgroups():
    |          ^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\app\main.py", line 223, in security_headers
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    |     raise app_exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    |     with collapse_excgroups():
    |          ^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\app\main.py", line 214, in log_requests
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    |     raise app_exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    |     with collapse_excgroups():
    |          ^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\app\main.py", line 191, in cors_middleware
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    |     raise app_exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    |     with collapse_excgroups():
    |          ^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\app\core\tenant\middleware.py", line 396, in dispatch
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    |     raise app_exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\exceptions.py", line 62, in __call__
    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 715, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 735, in app
    |     await route.handle(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 288, in handle
    |     await self.app(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 76, in app
    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 73, in app
    |     response = await f(request)
    |                ^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\fastapi\routing.py", line 301, in app
    |     raw_response = await run_endpoint_function(
    |                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\fastapi\routing.py", line 212, in run_endpoint_function
    |     return await dependant.call(**values)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\app\modules\rbac\presentation\endpoints.py", line 179, in read_roles_paginated
    |     if not current_user.cliente_id or current_user.cliente_id <= 0:
    |                                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    | TypeError: '<=' not supported between instances of 'UUID' and 'int'
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\errors.py", line 165, in __call__
    await self.app(scope, receive, _send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    with collapse_excgroups():
         ^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\main.py", line 223, in security_headers
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    raise app_exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    with collapse_excgroups():
         ^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\main.py", line 214, in log_requests
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    raise app_exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    with collapse_excgroups():
         ^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\main.py", line 191, in cors_middleware
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    raise app_exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    with collapse_excgroups():
         ^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\core\tenant\middleware.py", line 396, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    raise app_exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 715, in __call__
    await self.middleware_stack(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 735, in app
    await route.handle(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 288, in handle
    await self.app(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 76, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 73, in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\fastapi\routing.py", line 301, in app
    raw_response = await run_endpoint_function(
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\fastapi\routing.py", line 212, in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\modules\rbac\presentation\endpoints.py", line 179, in read_roles_paginated
    if not current_user.cliente_id or current_user.cliente_id <= 0:
                                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
TypeError: '<=' not supported between instances of 'UUID' and 'int'
2025-12-03 21:41:15,950 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/auth/logout/
2025-12-03 21:41:15,951 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/auth/logout/ 200 0.9ms
2025-12-03 21:41:15,953 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/logout/
2025-12-03 21:41:15,954 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 21:41:15,954 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': techcorp.app.local:5173
2025-12-03 21:41:15,955 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'techcorp.app.local'
2025-12-03 21:41:15,957 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:41:15,957 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'techcorp'
2025-12-03 21:41:15,958 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'techcorp.app.local'
2025-12-03 21:41:15,958 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:41:15,958 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'techcorp'
2025-12-03 21:41:15,964 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='techcorp', Código='TECH003', ID=58f3cce8-037b-45da-91c3-497fd61f31e5
2025-12-03 21:41:15,964 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 21:41:15,964 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=58f3cce8-037b-45da-91c3-497fd61f31e5, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/auth/logout/
2025-12-03 21:41:15,973 - app.modules.auth.application.services.refresh_token_service - WARNING - [REVOKE-TOKEN] Token no encontrado o ya revocado - Cliente 58F3CCE8-037B-45DA-91C3-497FD61F31E5, Usuario BA168EDA-B78F-4596-93B9-88AFC2D3A28E
2025-12-03 21:41:15,973 - app.modules.auth.presentation.endpoints - INFO - [LOGOUT-WEB] Token no encontrado en BD (ya expirado/revocado) - Cliente: 58F3CCE8-037B-45DA-91C3-497FD61F31E5, Usuario: BA168EDA-B78F-4596-93B9-88AFC2D3A28E (admin_tech)
2025-12-03 21:41:15,986 - app.modules.superadmin.application.services.audit_service - INFO - [AUDIT] auth_audit_log registrado: evento=logout, cliente_id=58F3CCE8-037B-45DA-91C3-497FD61F31E5, usuario_id=BA168EDA-B78F-4596-93B9-88AFC2D3A28E, exito=True
2025-12-03 21:41:15,987 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/logout/ 200 33.8ms
2025-12-03 21:41:26,808 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/auth/login/
2025-12-03 21:41:26,809 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/auth/login/ 200 0.8ms
2025-12-03 21:41:26,811 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/login/
2025-12-03 21:41:26,811 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 21:41:26,812 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': global.app.local:5173
2025-12-03 21:41:26,812 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'global.app.local'
2025-12-03 21:41:26,814 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:41:26,814 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'global'
2025-12-03 21:41:26,814 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'global.app.local'
2025-12-03 21:41:26,815 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:41:26,815 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'global'
2025-12-03 21:41:26,821 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='global', Código='GLOBAL004', ID=6c490df5-1395-44b6-8053-6c2b67b8d4c5
2025-12-03 21:41:26,824 - app.core.tenant.routing - WARNING - [METADATA] No se encontró metadata para cliente 6c490df5-1395-44b6-8053-6c2b67b8d4c5. Usando Single-DB como fallback.
2025-12-03 21:41:26,824 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 21:41:26,825 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=6c490df5-1395-44b6-8053-6c2b67b8d4c5, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/auth/login/
2025-12-03 21:41:26,827 - app.modules.auth.presentation.endpoints - INFO - Cliente 6c490df5-1395-44b6-8053-6c2b67b8d4c5 resuelto y validado para login.
2025-12-03 21:41:26,831 - app.modules.auth.application.services.auth_service - INFO - [AUTH] Intento de login: username='admin_global', cliente_id_destino=6c490df5-1395-44b6-8053-6c2b67b8d4c5
2025-12-03 21:41:26,831 - app.modules.auth.application.services.auth_service - INFO - [AUTH] Usuario regular. Buscando en BD del cliente_id=6c490df5-1395-44b6-8053-6c2b67b8d4c5
2025-12-03 21:41:26,832 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] AsyncEngine creado para tenant_6c490df5-1395-44b6-8053-6c2b67b8d4c5
2025-12-03 21:41:27,052 - app.modules.auth.application.services.auth_service - INFO - Niveles calculados - Usuario C1ABF198-6B95-4446-9605-4B81D73E9090: level=4, super_admin=False, type=tenant_admin
2025-12-03 21:41:27,052 - app.modules.auth.application.services.auth_service - INFO - [AUTH] Login exitoso: username='admin_global', usuario_id=C1ABF198-6B95-4446-9605-4B81D73E9090, cliente_origen=6C490DF5-1395-44B6-8053-6C2B67B8D4C5, cliente_destino=N/A, access_level=4, user_type=tenant_admin
2025-12-03 21:41:27,052 - app.infrastructure.database.queries_async - WARNING - [QUERY] DEPRECATED: execute_query() recibió string SQL. Migrar a SQLAlchemy Core.
2025-12-03 21:41:27,063 - app.modules.auth.application.services.auth_service - INFO - Niveles calculados - Usuario C1ABF198-6B95-4446-9605-4B81D73E9090: level=4, super_admin=False, type=tenant_admin
2025-12-03 21:41:27,068 - app.modules.auth.application.services.refresh_token_service - INFO - [STORE-TOKEN] Token insertado exitosamente - Cliente 6c490df5-1395-44b6-8053-6c2b67b8d4c5, Usuario C1ABF198-6B95-4446-9605-4B81D73E9090, Tipo: web, Token ID: 7056DE59-82D3-4BFA-9E89-163F6B87CC88, Rotación: False
2025-12-03 21:41:27,068 - app.modules.auth.presentation.endpoints - INFO - [LOGIN-WEB] Token almacenado - ID: 7056DE59-82D3-4BFA-9E89-163F6B87CC88
2025-12-03 21:41:27,069 - app.modules.auth.presentation.endpoints - INFO - Usuario admin_global autenticado exitosamente (WEB) para cliente 6c490df5-1395-44b6-8053-6c2b67b8d4c5
2025-12-03 21:41:27,076 - app.modules.superadmin.application.services.audit_service - INFO - [AUDIT] auth_audit_log registrado: evento=login_success, cliente_id=6c490df5-1395-44b6-8053-6c2b67b8d4c5, usuario_id=C1ABF198-6B95-4446-9605-4B81D73E9090, exito=True
2025-12-03 21:41:27,077 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/login/ 200 266.0ms
2025-12-03 21:41:27,088 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/clientes/tenant/branding
2025-12-03 21:41:27,088 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/clientes/tenant/branding 200 1.0ms
2025-12-03 21:41:27,091 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/clientes/tenant/branding
2025-12-03 21:41:27,093 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 21:41:27,093 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': global.app.local:5173
2025-12-03 21:41:27,094 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'global.app.local'
2025-12-03 21:41:27,094 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:41:27,095 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'global'
2025-12-03 21:41:27,095 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'global.app.local'
2025-12-03 21:41:27,096 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:41:27,096 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'global'
2025-12-03 21:41:27,103 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='global', Código='GLOBAL004', ID=6c490df5-1395-44b6-8053-6c2b67b8d4c5
2025-12-03 21:41:27,103 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 21:41:27,103 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=6c490df5-1395-44b6-8053-6c2b67b8d4c5, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/clientes/tenant/branding
2025-12-03 21:41:27,137 - app.modules.tenant.presentation.endpoints_clientes - INFO - Solicitud GET /tenant/branding recibida para cliente_id=6c490df5-1395-44b6-8053-6c2b67b8d4c5 por usuario: admin_global
2025-12-03 21:41:27,138 - app.modules.tenant.application.services.cliente_service - INFO - Solicitando branding para cliente_id=6c490df5-1395-44b6-8053-6c2b67b8d4c5
2025-12-03 21:41:27,141 - app.modules.tenant.application.services.cliente_service - INFO - Branding obtenido exitosamente para cliente_id=6c490df5-1395-44b6-8053-6c2b67b8d4c5
2025-12-03 21:41:27,142 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/clientes/tenant/branding 200 51.2ms
2025-12-03 21:41:28,321 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/menus/getmenu/
2025-12-03 21:41:28,323 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/usuarios/
2025-12-03 21:41:28,325 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/roles/all-active/
2025-12-03 21:41:28,325 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/menus/getmenu/ 200 3.9ms
2025-12-03 21:41:28,326 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/usuarios/ 200 3.5ms
2025-12-03 21:41:28,328 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/roles/all-active/ 200 3.4ms
2025-12-03 21:41:28,328 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/roles/all-active/
2025-12-03 21:41:28,329 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/menus/getmenu/
2025-12-03 21:41:28,330 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/usuarios/
2025-12-03 21:41:28,333 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/roles/all-active/ 200 4.7ms
2025-12-03 21:41:28,335 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/menus/getmenu/ 200 4.9ms
2025-12-03 21:41:28,335 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/usuarios/ 200 4.8ms
2025-12-03 21:41:28,336 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/menus/getmenu/
2025-12-03 21:41:28,338 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 21:41:28,339 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': global.app.local:5173
2025-12-03 21:41:28,339 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'global.app.local'
2025-12-03 21:41:28,340 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:41:28,340 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'global'
2025-12-03 21:41:28,340 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'global.app.local'
2025-12-03 21:41:28,341 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:41:28,341 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'global'
2025-12-03 21:41:28,344 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/usuarios/
2025-12-03 21:41:28,345 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/roles/all-active/
2025-12-03 21:41:28,346 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 21:41:28,346 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': global.app.local:5173
2025-12-03 21:41:28,347 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'global.app.local'
2025-12-03 21:41:28,347 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:41:28,347 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'global'
2025-12-03 21:41:28,348 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'global.app.local'
2025-12-03 21:41:28,348 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:41:28,349 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'global'
2025-12-03 21:41:28,352 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 21:41:28,353 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': global.app.local:5173
2025-12-03 21:41:28,354 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'global.app.local'
2025-12-03 21:41:28,354 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:41:28,354 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'global'
2025-12-03 21:41:28,355 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'global.app.local'
2025-12-03 21:41:28,355 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:41:28,356 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'global'
2025-12-03 21:41:28,361 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='global', Código='GLOBAL004', ID=6c490df5-1395-44b6-8053-6c2b67b8d4c5
2025-12-03 21:41:28,362 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 21:41:28,363 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=6c490df5-1395-44b6-8053-6c2b67b8d4c5, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/menus/getmenu/
2025-12-03 21:41:28,365 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='global', Código='GLOBAL004', ID=6c490df5-1395-44b6-8053-6c2b67b8d4c5
2025-12-03 21:41:28,366 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 21:41:28,367 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=6c490df5-1395-44b6-8053-6c2b67b8d4c5, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/usuarios/
2025-12-03 21:41:28,369 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='global', Código='GLOBAL004', ID=6c490df5-1395-44b6-8053-6c2b67b8d4c5
2025-12-03 21:41:28,369 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 21:41:28,370 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=6c490df5-1395-44b6-8053-6c2b67b8d4c5, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/roles/all-active/
2025-12-03 21:41:28,411 - app.infrastructure.database.queries_async - WARNING - [QUERY] DEPRECATED: execute_query() recibió string SQL. Migrar a SQLAlchemy Core.
2025-12-03 21:41:28,412 - app.modules.menus.presentation.endpoints - INFO - Solicitud GET /menus/getmenu/ recibida para usuario ID: c1abf198-6b95-4446-9605-4b81d73e9090 del cliente 6c490df5-1395-44b6-8053-6c2b67b8d4c5
2025-12-03 21:41:28,414 - app.modules.menus.application.services.menu_service - INFO - Obteniendo menú filtrado para usuario_id: c1abf198-6b95-4446-9605-4b81d73e9090
2025-12-03 21:41:28,417 - app.infrastructure.database.queries_async - WARNING - [QUERY] DEPRECATED: execute_query() recibió string SQL. Migrar a SQLAlchemy Core.
2025-12-03 21:41:28,421 - app.modules.users.presentation.endpoints - INFO - Solicitud GET /usuarios/ recibida por usuario c1abf198-6b95-4446-9605-4b81d73e9090 del cliente 6c490df5-1395-44b6-8053-6c2b67b8d4c5 - Paginación: page=1, limit=10, Búsqueda: 'None'
2025-12-03 21:41:28,422 - app.modules.users.application.services.user_service - INFO - Obteniendo usuarios paginados para cliente 6c490df5-1395-44b6-8053-6c2b67b8d4c5: page=1, limit=10, search='None'
2025-12-03 21:41:28,422 - app.infrastructure.database.queries_async - WARNING - [QUERY] DEPRECATED: execute_query() recibió string SQL. Migrar a SQLAlchemy Core.
2025-12-03 21:41:28,423 - app.modules.menus.application.services.menu_helper - INFO - Árbol de menú construido con 5 items raíz.
2025-12-03 21:41:28,423 - app.modules.menus.application.services.menu_service - INFO - Árbol de menú construido para usuario c1abf198-6b95-4446-9605-4b81d73e9090 con 5 items raíz.
2025-12-03 21:41:28,423 - app.modules.rbac.presentation.endpoints - INFO - Solicitud GET /roles/all-active/ recibida por usuario c1abf198-6b95-4446-9605-4b81d73e9090 del cliente 6c490df5-1395-44b6-8053-6c2b67b8d4c5 para lista simple
2025-12-03 21:41:28,423 - app.modules.rbac.application.services.rol_service - ERROR - Error inesperado en get_all_active_roles: 'coroutine' object is not iterable
Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\modules\rbac\application\services\rol_service.py", line 799, in get_all_active_roles
    for rol_dict in resultados:
                    ^^^^^^^^^^
TypeError: 'coroutine' object is not iterable
2025-12-03 21:41:28,423 - app.modules.rbac.presentation.endpoints - ERROR - Error de servicio en endpoint /roles/all-active/ para cliente 6c490df5-1395-44b6-8053-6c2b67b8d4c5: Error interno al obtener roles activos
2025-12-03 21:41:28,430 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/menus/getmenu/ 200 94.2ms
2025-12-03 21:41:28,430 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/roles/all-active/ 500 85.1ms
2025-12-03 21:41:28,436 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/menus/getmenu/
2025-12-03 21:41:28,437 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/roles/all-active/
2025-12-03 21:41:28,439 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 21:41:28,439 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': global.app.local:5173
2025-12-03 21:41:28,440 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'global.app.local'
2025-12-03 21:41:28,440 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:41:28,441 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'global'
2025-12-03 21:41:28,441 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'global.app.local'
2025-12-03 21:41:28,441 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:41:28,442 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'global'
2025-12-03 21:41:28,444 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 21:41:28,445 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': global.app.local:5173
2025-12-03 21:41:28,446 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'global.app.local'
2025-12-03 21:41:28,446 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:41:28,447 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'global'
2025-12-03 21:41:28,447 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'global.app.local'
2025-12-03 21:41:28,448 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:41:28,448 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'global'
2025-12-03 21:41:28,453 - app.infrastructure.database.queries_async - WARNING - [QUERY] DEPRECATED: execute_query() recibió string SQL. Migrar a SQLAlchemy Core.
2025-12-03 21:41:28,460 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='global', Código='GLOBAL004', ID=6c490df5-1395-44b6-8053-6c2b67b8d4c5
2025-12-03 21:41:28,460 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 21:41:28,461 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=6c490df5-1395-44b6-8053-6c2b67b8d4c5, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/roles/all-active/
2025-12-03 21:41:28,462 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='global', Código='GLOBAL004', ID=6c490df5-1395-44b6-8053-6c2b67b8d4c5
2025-12-03 21:41:28,462 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 21:41:28,462 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=6c490df5-1395-44b6-8053-6c2b67b8d4c5, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/menus/getmenu/
2025-12-03 21:41:28,469 - app.modules.users.application.services.user_service - INFO - [USUARIOS-PAGINADOS] Procesados 2 usuarios únicos de 2 filas crudas
2025-12-03 21:41:28,470 - app.modules.users.application.services.user_service - INFO - Obtención paginada de usuarios completada exitosamente
2025-12-03 21:41:28,471 - app.modules.users.presentation.endpoints - INFO - Lista paginada de usuarios recuperada para cliente 6c490df5-1395-44b6-8053-6c2b67b8d4c5 - Total: 2, Página: 1
2025-12-03 21:41:28,471 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/usuarios/ 200 127.3ms
2025-12-03 21:41:28,475 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/usuarios/
2025-12-03 21:41:28,476 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 21:41:28,476 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': global.app.local:5173
2025-12-03 21:41:28,476 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'global.app.local'
2025-12-03 21:41:28,476 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:41:28,476 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'global'
2025-12-03 21:41:28,476 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'global.app.local'
2025-12-03 21:41:28,476 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:41:28,476 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'global'
2025-12-03 21:41:28,492 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='global', Código='GLOBAL004', ID=6c490df5-1395-44b6-8053-6c2b67b8d4c5
2025-12-03 21:41:28,492 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 21:41:28,492 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=6c490df5-1395-44b6-8053-6c2b67b8d4c5, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/usuarios/
2025-12-03 21:41:28,512 - app.modules.menus.presentation.endpoints - INFO - Solicitud GET /menus/getmenu/ recibida para usuario ID: c1abf198-6b95-4446-9605-4b81d73e9090 del cliente 6c490df5-1395-44b6-8053-6c2b67b8d4c5
2025-12-03 21:41:28,516 - app.modules.menus.application.services.menu_service - INFO - Obteniendo menú filtrado para usuario_id: c1abf198-6b95-4446-9605-4b81d73e9090
2025-12-03 21:41:28,517 - app.infrastructure.database.queries_async - WARNING - [QUERY] DEPRECATED: execute_query() recibió string SQL. Migrar a SQLAlchemy Core.
2025-12-03 21:41:28,524 - app.modules.rbac.presentation.endpoints - INFO - Solicitud GET /roles/all-active/ recibida por usuario c1abf198-6b95-4446-9605-4b81d73e9090 del cliente 6c490df5-1395-44b6-8053-6c2b67b8d4c5 para lista simple
2025-12-03 21:41:28,524 - app.modules.rbac.application.services.rol_service - ERROR - Error inesperado en get_all_active_roles: 'coroutine' object is not iterable
Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\modules\rbac\application\services\rol_service.py", line 799, in get_all_active_roles
    for rol_dict in resultados:
                    ^^^^^^^^^^
TypeError: 'coroutine' object is not iterable
2025-12-03 21:41:28,524 - app.modules.rbac.presentation.endpoints - ERROR - Error de servicio en endpoint /roles/all-active/ para cliente 6c490df5-1395-44b6-8053-6c2b67b8d4c5: Error interno al obtener roles activos
2025-12-03 21:41:28,530 - app.modules.menus.application.services.menu_helper - INFO - Árbol de menú construido con 5 items raíz.
2025-12-03 21:41:28,530 - app.modules.menus.application.services.menu_service - INFO - Árbol de menú construido para usuario c1abf198-6b95-4446-9605-4b81d73e9090 con 5 items raíz.
2025-12-03 21:41:28,531 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/roles/all-active/ 500 93.6ms
2025-12-03 21:41:28,532 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/menus/getmenu/ 200 96.2ms
2025-12-03 21:41:28,537 - app.infrastructure.database.queries_async - WARNING - [QUERY] DEPRECATED: execute_query() recibió string SQL. Migrar a SQLAlchemy Core.
2025-12-03 21:41:28,540 - app.modules.users.presentation.endpoints - INFO - Solicitud GET /usuarios/ recibida por usuario c1abf198-6b95-4446-9605-4b81d73e9090 del cliente 6c490df5-1395-44b6-8053-6c2b67b8d4c5 - Paginación: page=1, limit=10, Búsqueda: 'None'
2025-12-03 21:41:28,541 - app.modules.users.application.services.user_service - INFO - Obteniendo usuarios paginados para cliente 6c490df5-1395-44b6-8053-6c2b67b8d4c5: page=1, limit=10, search='None'
2025-12-03 21:41:28,542 - app.infrastructure.database.queries_async - WARNING - [QUERY] DEPRECATED: execute_query() recibió string SQL. Migrar a SQLAlchemy Core.
2025-12-03 21:41:28,548 - app.infrastructure.database.queries_async - WARNING - [QUERY] DEPRECATED: execute_query() recibió string SQL. Migrar a SQLAlchemy Core.
2025-12-03 21:41:28,554 - app.modules.users.application.services.user_service - INFO - [USUARIOS-PAGINADOS] Procesados 2 usuarios únicos de 2 filas crudas
2025-12-03 21:41:28,555 - app.modules.users.application.services.user_service - INFO - Obtención paginada de usuarios completada exitosamente
2025-12-03 21:41:28,556 - app.modules.users.presentation.endpoints - INFO - Lista paginada de usuarios recuperada para cliente 6c490df5-1395-44b6-8053-6c2b67b8d4c5 - Total: 2, Página: 1
2025-12-03 21:41:28,557 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/usuarios/ 200 82.2ms
2025-12-03 21:41:32,358 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/auth/logout/
2025-12-03 21:41:32,359 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/auth/logout/ 200 0.9ms
2025-12-03 21:41:32,361 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/logout/
2025-12-03 21:41:32,361 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 21:41:32,361 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': global.app.local:5173
2025-12-03 21:41:32,361 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'global.app.local'
2025-12-03 21:41:32,363 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:41:32,363 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'global'
2025-12-03 21:41:32,363 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'global.app.local'
2025-12-03 21:41:32,364 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:41:32,364 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'global'
2025-12-03 21:41:32,370 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='global', Código='GLOBAL004', ID=6c490df5-1395-44b6-8053-6c2b67b8d4c5
2025-12-03 21:41:32,370 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 21:41:32,371 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=6c490df5-1395-44b6-8053-6c2b67b8d4c5, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/auth/logout/
2025-12-03 21:41:32,377 - app.modules.auth.application.services.refresh_token_service - WARNING - [REVOKE-TOKEN] Token no encontrado o ya revocado - Cliente 6C490DF5-1395-44B6-8053-6C2B67B8D4C5, Usuario C1ABF198-6B95-4446-9605-4B81D73E9090
2025-12-03 21:41:32,377 - app.modules.auth.presentation.endpoints - INFO - [LOGOUT-WEB] Token no encontrado en BD (ya expirado/revocado) - Cliente: 6C490DF5-1395-44B6-8053-6C2B67B8D4C5, Usuario: C1ABF198-6B95-4446-9605-4B81D73E9090 (admin_global)
2025-12-03 21:41:32,388 - app.modules.superadmin.application.services.audit_service - INFO - [AUDIT] auth_audit_log registrado: evento=logout, cliente_id=6C490DF5-1395-44B6-8053-6C2B67B8D4C5, usuario_id=C1ABF198-6B95-4446-9605-4B81D73E9090, exito=True
2025-12-03 21:41:32,389 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/logout/ 200 28.5ms
2025-12-03 21:41:43,929 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/auth/login/
2025-12-03 21:41:43,930 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/auth/login/ 200 1.0ms
2025-12-03 21:41:43,931 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/login/
2025-12-03 21:41:43,933 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 21:41:43,934 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': acme.app.local:5173
2025-12-03 21:41:43,934 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 21:41:43,934 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:41:43,935 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 21:41:43,935 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 21:41:43,936 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:41:43,936 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 21:41:43,942 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 21:41:43,944 - app.core.security.encryption - ERROR - Token de encriptación inválido. Posibles causas: clave incorrecta o datos corruptos
2025-12-03 21:41:43,945 - app.core.tenant.routing - ERROR - [METADATA] Error al desencriptar credenciales para cliente ee7bfc14-995f-4209-b4b9-99c307534a43: Credencial corrupta o clave de encriptación incorrecta
2025-12-03 21:41:43,946 - app.core.tenant.routing - WARNING - [METADATA] No se encontró metadata para cliente ee7bfc14-995f-4209-b4b9-99c307534a43. Usando Single-DB como fallback.
2025-12-03 21:41:43,946 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 21:41:43,948 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/auth/login/
2025-12-03 21:41:43,953 - app.modules.auth.presentation.endpoints - INFO - Cliente ee7bfc14-995f-4209-b4b9-99c307534a43 resuelto y validado para login.
2025-12-03 21:41:43,954 - app.modules.auth.application.services.auth_service - INFO - [AUTH] Intento de login: username='admin_acme', cliente_id_destino=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 21:41:43,954 - app.modules.auth.application.services.auth_service - INFO - [AUTH] Usuario regular. Buscando en BD del cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 21:41:43,955 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] AsyncEngine creado para tenant_ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 21:41:43,968 - app.modules.auth.application.services.auth_service - WARNING - [AUTH] Usuario NO ENCONTRADO: username='admin_acme', cliente_id_buscado=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 21:41:43,974 - app.modules.superadmin.application.services.audit_service - INFO - [AUDIT] auth_audit_log registrado: evento=login_failed, cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43, usuario_id=None, exito=False
2025-12-03 21:41:43,974 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/login/ 401 44.7ms
2025-12-03 21:42:35,134 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/login/
2025-12-03 21:42:35,135 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 21:42:35,136 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': acme.app.local:5173
2025-12-03 21:42:35,136 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 21:42:35,137 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:42:35,137 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 21:42:35,138 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 21:42:35,138 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:42:35,139 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 21:42:35,145 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 21:42:35,145 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 21:42:35,145 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/auth/login/
2025-12-03 21:42:35,153 - app.modules.auth.presentation.endpoints - INFO - Cliente ee7bfc14-995f-4209-b4b9-99c307534a43 resuelto y validado para login.
2025-12-03 21:42:35,153 - app.modules.auth.application.services.auth_service - INFO - [AUTH] Intento de login: username='admin_acme', cliente_id_destino=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 21:42:35,154 - app.modules.auth.application.services.auth_service - INFO - [AUTH] Usuario regular. Buscando en BD del cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 21:42:35,159 - app.modules.auth.application.services.auth_service - WARNING - [AUTH] Usuario NO ENCONTRADO: username='admin_acme', cliente_id_buscado=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 21:42:35,166 - app.modules.superadmin.application.services.audit_service - INFO - [AUDIT] auth_audit_log registrado: evento=login_failed, cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43, usuario_id=None, exito=False
2025-12-03 21:42:35,167 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/login/ 401 33.7ms
2025-12-03 21:43:28,500 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/auth/refresh/
2025-12-03 21:43:28,501 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/auth/refresh/ 200 0.9ms
2025-12-03 21:43:28,503 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/refresh/
2025-12-03 21:43:28,504 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 21:43:28,505 - app.core.tenant.middleware - WARNING - [HOST_DETECTION] No se pudo extraer tenant real de origin/referer, usando cliente por defecto (SYSTEM)
2025-12-03 21:43:28,505 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'backend.app.local'
2025-12-03 21:43:28,505 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:43:28,506 - app.core.tenant.middleware - INFO - [SUBDOMAIN] 'backend' es infraestructura, ignorando (usando SYSTEM)
2025-12-03 21:43:28,507 - app.core.tenant.middleware - WARNING - [TENANT] Sin subdominio en Host: backend.app.local:8000. Usando Cliente ID por defecto: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7 (SYSTEM)
2025-12-03 21:43:28,507 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 21:43:28,508 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/auth/refresh/
2025-12-03 21:43:28,510 - app.modules.auth.application.services.auth_service - WARNING - [REFRESH] No se proporcionó refresh token. Cliente: web
2025-12-03 21:43:28,511 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/refresh/ 401 8.0ms
2025-12-03 21:43:45,411 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/refresh/
2025-12-03 21:43:45,411 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 21:43:45,412 - app.core.tenant.middleware - WARNING - [HOST_DETECTION] No se pudo extraer tenant real de origin/referer, usando cliente por defecto (SYSTEM)
2025-12-03 21:43:45,413 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'backend.app.local'
2025-12-03 21:43:45,414 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:43:45,414 - app.core.tenant.middleware - INFO - [SUBDOMAIN] 'backend' es infraestructura, ignorando (usando SYSTEM)
2025-12-03 21:43:45,414 - app.core.tenant.middleware - WARNING - [TENANT] Sin subdominio en Host: backend.app.local:8000. Usando Cliente ID por defecto: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7 (SYSTEM)
2025-12-03 21:43:45,415 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 21:43:45,416 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/auth/refresh/
2025-12-03 21:43:45,418 - app.modules.auth.application.services.auth_service - WARNING - [REFRESH] No se proporcionó refresh token. Cliente: web
2025-12-03 21:43:45,418 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/refresh/ 401 8.1ms
2025-12-03 21:44:03,397 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/auth/refresh/
2025-12-03 21:44:03,399 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/auth/refresh/ 200 1.1ms
2025-12-03 21:44:03,401 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/refresh/
2025-12-03 21:44:03,402 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 21:44:03,402 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': acme.app.local:5173
2025-12-03 21:44:03,404 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 21:44:03,405 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:44:03,406 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 21:44:03,406 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 21:44:03,407 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:44:03,407 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 21:44:03,417 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 21:44:03,418 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 21:44:03,419 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/auth/refresh/
2025-12-03 21:44:03,420 - app.modules.auth.application.services.auth_service - WARNING - [REFRESH] No se proporcionó refresh token. Cliente: web
2025-12-03 21:44:03,421 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/refresh/ 401 19.8ms
2025-12-03 21:44:21,225 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/login/
2025-12-03 21:44:21,226 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 21:44:21,227 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': acme.app.local:5173
2025-12-03 21:44:21,227 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 21:44:21,227 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:44:21,229 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 21:44:21,229 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 21:44:21,230 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:44:21,230 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 21:44:21,234 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 21:44:21,234 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 21:44:21,235 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/auth/login/
2025-12-03 21:44:21,243 - app.modules.auth.presentation.endpoints - INFO - Cliente ee7bfc14-995f-4209-b4b9-99c307534a43 resuelto y validado para login.
2025-12-03 21:44:21,243 - app.modules.auth.application.services.auth_service - INFO - [AUTH] Intento de login: username='admin_acme', cliente_id_destino=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 21:44:21,244 - app.modules.auth.application.services.auth_service - INFO - [AUTH] Usuario regular. Buscando en BD del cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 21:44:21,249 - app.modules.auth.application.services.auth_service - WARNING - [AUTH] Usuario NO ENCONTRADO: username='admin_acme', cliente_id_buscado=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 21:44:21,257 - app.modules.superadmin.application.services.audit_service - INFO - [AUDIT] auth_audit_log registrado: evento=login_failed, cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43, usuario_id=None, exito=False
2025-12-03 21:44:21,258 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/login/ 401 32.7ms
2025-12-03 21:57:29,894 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/auth/refresh/
2025-12-03 21:57:29,895 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/auth/refresh/ 200 1.1ms
2025-12-03 21:57:29,898 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/refresh/
2025-12-03 21:57:29,898 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 21:57:29,900 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': acme.app.local:5173
2025-12-03 21:57:29,900 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 21:57:29,901 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:57:29,901 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 21:57:29,902 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 21:57:29,903 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:57:29,903 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 21:57:29,928 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 21:57:29,939 - app.core.security.encryption - ERROR - Token de encriptación inválido. Posibles causas: clave incorrecta o datos corruptos
2025-12-03 21:57:29,939 - app.core.tenant.routing - ERROR - [METADATA] Error al desencriptar credenciales para cliente ee7bfc14-995f-4209-b4b9-99c307534a43: Credencial corrupta o clave de encriptación incorrecta
2025-12-03 21:57:29,941 - app.core.tenant.routing - WARNING - [METADATA] No se encontró metadata para cliente ee7bfc14-995f-4209-b4b9-99c307534a43. Usando Single-DB como fallback.
2025-12-03 21:57:29,941 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 21:57:29,942 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/auth/refresh/
2025-12-03 21:57:29,943 - app.modules.auth.application.services.auth_service - WARNING - [REFRESH] No se proporcionó refresh token. Cliente: web
2025-12-03 21:57:29,944 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/refresh/ 401 46.4ms
2025-12-03 21:57:46,898 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/auth/login/
2025-12-03 21:57:46,898 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/auth/login/ 200 0.8ms
2025-12-03 21:57:46,900 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/login/
2025-12-03 21:57:46,901 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 21:57:46,901 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': acme.app.local:5173
2025-12-03 21:57:46,902 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 21:57:46,903 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:57:46,903 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 21:57:46,903 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 21:57:46,904 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:57:46,904 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 21:57:46,909 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 21:57:46,910 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 21:57:46,910 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/auth/login/
2025-12-03 21:57:46,916 - app.core.application.base_service - ERROR - ERROR INESPERADO en obtener_cliente_por_id: 1 validation error for ClienteRead
tipo_instalacion
  Value error, tipo_instalacion debe ser uno de: cloud, onpremise, hybrid [type=value_error, input_value='dedicated', input_type=str]
    For further information visit https://errors.pydantic.dev/2.10/v/value_error
Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\core\application\base_service.py", line 52, in wrapper
    return await func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\modules\tenant\application\services\cliente_service.py", line 194, in obtener_cliente_por_id
    return ClienteRead(**resultado[0])
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\pydantic\main.py", line 214, in __init__
    validated_self = self.__pydantic_validator__.validate_python(data, self_instance=self)
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
pydantic_core._pydantic_core.ValidationError: 1 validation error for ClienteRead
tipo_instalacion
  Value error, tipo_instalacion debe ser uno de: cloud, onpremise, hybrid [type=value_error, input_value='dedicated', input_type=str]
    For further information visit https://errors.pydantic.dev/2.10/v/value_error
2025-12-03 21:57:46,919 - app.modules.auth.presentation.endpoints - ERROR - Error inesperado en /login/ para usuario admin_acme: Error interno del servidor en obtener_cliente_por_id
Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\core\application\base_service.py", line 52, in wrapper
    return await func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\modules\tenant\application\services\cliente_service.py", line 194, in obtener_cliente_por_id
    return ClienteRead(**resultado[0])
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\pydantic\main.py", line 214, in __init__
    validated_self = self.__pydantic_validator__.validate_python(data, self_instance=self)
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
pydantic_core._pydantic_core.ValidationError: 1 validation error for ClienteRead
tipo_instalacion
  Value error, tipo_instalacion debe ser uno de: cloud, onpremise, hybrid [type=value_error, input_value='dedicated', input_type=str]
    For further information visit https://errors.pydantic.dev/2.10/v/value_error

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\modules\auth\presentation\endpoints.py", line 134, in login
    cliente = await ClienteService.obtener_cliente_por_id(cliente_id)
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\core\application\base_service.py", line 69, in wrapper
    raise ServiceError(
app.core.exceptions.ServiceError: Error interno del servidor en obtener_cliente_por_id
2025-12-03 21:57:46,921 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/login/ 500 20.4ms
2025-12-03 21:59:35,665 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Pool ADMIN inicializado. Size=10, MaxOverflow=5
2025-12-03 21:59:35,665 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Configuración de pools de tenants: MaxPools=50, PoolSize=3, MaxOverflow=2, InactivityTimeout=3600s
2025-12-03 21:59:35,665 - app.infrastructure.database.connection_pool - INFO - ✅ Módulo de connection pooling cargado y activo
2025-12-03 21:59:35,665 - app.infrastructure.database.connection_pool - INFO -    Configuración: MaxTenantPools=50, TenantPoolSize=3, InactivityTimeout=3600s
2025-12-03 21:59:35,665 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Todos los pools cerrados
2025-12-03 21:59:35,665 - app.main - INFO - ✅ Pools de conexión cerrados correctamente
2025-12-03 21:59:35,768 - asyncio - ERROR - Unclosed connection
connection: <aioodbc.connection.Connection object at 0x00000238BCADFA70>
2025-12-03 21:59:35,768 - asyncio - ERROR - Unclosed connection
connection: <aioodbc.connection.Connection object at 0x00000238BC18ACC0>
2025-12-03 21:59:35,768 - asyncio - ERROR - Unclosed connection
connection: <aioodbc.connection.Connection object at 0x00000238BCB7D4F0>
2025-12-03 21:59:35,769 - asyncio - ERROR - Unclosed connection
connection: <aioodbc.connection.Connection object at 0x00000238BCB5FF20>
2025-12-03 21:59:35,769 - asyncio - ERROR - Unclosed connection
connection: <aioodbc.connection.Connection object at 0x00000238BCB40E60>
2025-12-03 21:59:35,770 - asyncio - ERROR - Unclosed connection
connection: <aioodbc.connection.Connection object at 0x00000238BCF592E0>
2025-12-03 21:59:35,770 - asyncio - ERROR - Unclosed connection
connection: <aioodbc.connection.Connection object at 0x00000238BCF5A7B0>
2025-12-03 21:59:35,772 - asyncio - ERROR - Unclosed connection
connection: <aioodbc.connection.Connection object at 0x00000238BCB7C380>
2025-12-03 21:59:35,772 - asyncio - ERROR - Unclosed connection
connection: <aioodbc.connection.Connection object at 0x00000238BC121580>
2025-12-03 21:59:35,773 - asyncio - ERROR - Unclosed connection
connection: <aioodbc.connection.Connection object at 0x00000238BC0FB230>
2025-12-03 21:59:35,773 - asyncio - ERROR - Unclosed connection
connection: <aioodbc.connection.Connection object at 0x00000238BC120380>
2025-12-03 21:59:38,219 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 21:59:38,424 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 21:59:38,431 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 21:59:38,434 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 21:59:38,434 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 21:59:38,435 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 21:59:38,435 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 21:59:38,436 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, DEFAULT_TYPE=single
2025-12-03 21:59:38,772 - app.core.security.rate_limiting - INFO - [RATE_LIMITING] Activado. Límites: Login=10/minute, API=200/minute
2025-12-03 21:59:38,775 - app.core.security.rate_limiting - INFO - ✅ Módulo de rate limiting cargado y activo
2025-12-03 21:59:38,844 - app.core.authorization.rbac - INFO - 🔐 Inicializando sistema de autorización...
2025-12-03 21:59:38,844 - app.core.authorization.rbac - INFO - ✅ Sistema de autorización inicializado correctamente
2025-12-03 21:59:38,844 - app.core.authorization.rbac - INFO - 📊 Permisos del sistema: 6 módulos configurados
2025-12-03 21:59:39,001 - app.core.tenant.middleware - INFO - Módulo tenant_middleware cargado (versión híbrida con soporte para proxies)
2025-12-03 21:59:39,002 - app.main - INFO - ✅ Rate limiting configurado y activo
2025-12-03 21:59:39,152 - app.core.tenant.middleware - INFO - [TENANT_MW] Inicializado - BASE_DOMAIN=app.local, SYSTEM_ID=BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, EXCLUDED_SUBDOMAINS={'www', 'api', 'static', 'cdn', 'assets', 'admin', 'backend'}
2025-12-03 21:59:41,395 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/login/
2025-12-03 21:59:41,396 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 21:59:41,398 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': acme.app.local:5173
2025-12-03 21:59:41,398 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 21:59:41,399 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:59:41,399 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 21:59:41,400 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 21:59:41,400 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 21:59:41,400 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 21:59:41,406 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] AsyncEngine creado para admin
2025-12-03 21:59:41,549 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 21:59:45,623 - app.infrastructure.cache.redis_cache - WARNING - [REDIS_CACHE] Error conectando a Redis: Error 10061 connecting to localhost:6379. No se puede establecer una conexión ya que el equipo de destino denegó expresamente dicha conexión.. Cache desactivado automáticamente (usando fallback en memoria).
2025-12-03 21:59:45,624 - app.infrastructure.cache.redis_cache - INFO - ℹ️ Módulo de Redis cache cargado pero desactivado (usando fallback en memoria)
2025-12-03 21:59:45,630 - app.core.security.encryption - ERROR - Token de encriptación inválido. Posibles causas: clave incorrecta o datos corruptos
2025-12-03 21:59:45,630 - app.core.tenant.routing - ERROR - [METADATA] Error al desencriptar credenciales para cliente ee7bfc14-995f-4209-b4b9-99c307534a43: Credencial corrupta o clave de encriptación incorrecta
2025-12-03 21:59:45,634 - app.core.tenant.routing - WARNING - [METADATA] No se encontró metadata para cliente ee7bfc14-995f-4209-b4b9-99c307534a43. Usando Single-DB como fallback.
2025-12-03 21:59:45,634 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 21:59:45,635 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/auth/login/
2025-12-03 21:59:45,643 - app.core.application.base_service - ERROR - ERROR INESPERADO en obtener_cliente_por_id: 1 validation error for ClienteRead
tipo_instalacion
  Value error, tipo_instalacion debe ser uno de: cloud, onpremise, hybrid [type=value_error, input_value='dedicated', input_type=str]
    For further information visit https://errors.pydantic.dev/2.10/v/value_error
Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\core\application\base_service.py", line 52, in wrapper
    return await func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\modules\tenant\application\services\cliente_service.py", line 194, in obtener_cliente_por_id
    return ClienteRead(**resultado[0])
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\pydantic\main.py", line 214, in __init__
    validated_self = self.__pydantic_validator__.validate_python(data, self_instance=self)
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
pydantic_core._pydantic_core.ValidationError: 1 validation error for ClienteRead
tipo_instalacion
  Value error, tipo_instalacion debe ser uno de: cloud, onpremise, hybrid [type=value_error, input_value='dedicated', input_type=str]
    For further information visit https://errors.pydantic.dev/2.10/v/value_error
2025-12-03 21:59:45,645 - app.modules.auth.presentation.endpoints - ERROR - Error inesperado en /login/ para usuario admin_acme: Error interno del servidor en obtener_cliente_por_id
Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\core\application\base_service.py", line 52, in wrapper
    return await func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\modules\tenant\application\services\cliente_service.py", line 194, in obtener_cliente_por_id
    return ClienteRead(**resultado[0])
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\pydantic\main.py", line 214, in __init__
    validated_self = self.__pydantic_validator__.validate_python(data, self_instance=self)
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
pydantic_core._pydantic_core.ValidationError: 1 validation error for ClienteRead
tipo_instalacion
  Value error, tipo_instalacion debe ser uno de: cloud, onpremise, hybrid [type=value_error, input_value='dedicated', input_type=str]
    For further information visit https://errors.pydantic.dev/2.10/v/value_error

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\modules\auth\presentation\endpoints.py", line 134, in login
    cliente = await ClienteService.obtener_cliente_por_id(cliente_id)
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\core\application\base_service.py", line 69, in wrapper
    raise ServiceError(
app.core.exceptions.ServiceError: Error interno del servidor en obtener_cliente_por_id
2025-12-03 21:59:45,647 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/login/ 500 4250.4ms
2025-12-03 22:04:37,664 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Pool ADMIN inicializado. Size=10, MaxOverflow=5
2025-12-03 22:04:37,664 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Configuración de pools de tenants: MaxPools=50, PoolSize=3, MaxOverflow=2, InactivityTimeout=3600s
2025-12-03 22:04:37,664 - app.infrastructure.database.connection_pool - INFO - ✅ Módulo de connection pooling cargado y activo
2025-12-03 22:04:37,664 - app.infrastructure.database.connection_pool - INFO -    Configuración: MaxTenantPools=50, TenantPoolSize=3, InactivityTimeout=3600s
2025-12-03 22:04:37,664 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Todos los pools cerrados
2025-12-03 22:04:37,664 - app.main - INFO - ✅ Pools de conexión cerrados correctamente
2025-12-03 22:04:37,772 - asyncio - ERROR - Unclosed connection
connection: <aioodbc.connection.Connection object at 0x0000021724513DA0>
2025-12-03 22:04:38,669 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 22:04:38,924 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 22:04:38,934 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 22:04:38,934 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 22:04:38,934 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 22:04:38,934 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 22:04:38,934 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 22:04:38,941 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, DEFAULT_TYPE=single
2025-12-03 22:04:39,400 - app.core.security.rate_limiting - INFO - [RATE_LIMITING] Activado. Límites: Login=10/minute, API=200/minute
2025-12-03 22:04:39,401 - app.core.security.rate_limiting - INFO - ✅ Módulo de rate limiting cargado y activo
2025-12-03 22:04:39,502 - app.core.authorization.rbac - INFO - 🔐 Inicializando sistema de autorización...
2025-12-03 22:04:39,502 - app.core.authorization.rbac - INFO - ✅ Sistema de autorización inicializado correctamente
2025-12-03 22:04:39,503 - app.core.authorization.rbac - INFO - 📊 Permisos del sistema: 6 módulos configurados
2025-12-03 22:04:39,694 - app.core.tenant.middleware - INFO - Módulo tenant_middleware cargado (versión híbrida con soporte para proxies)
2025-12-03 22:04:39,694 - app.main - INFO - ✅ Rate limiting configurado y activo
2025-12-03 22:04:39,912 - app.core.tenant.middleware - INFO - [TENANT_MW] Inicializado - BASE_DOMAIN=app.local, SYSTEM_ID=BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, EXCLUDED_SUBDOMAINS={'www', 'backend', 'admin', 'cdn', 'assets', 'static', 'api'}
2025-12-03 22:05:38,755 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Pool ADMIN inicializado. Size=10, MaxOverflow=5
2025-12-03 22:05:38,755 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Configuración de pools de tenants: MaxPools=50, PoolSize=3, MaxOverflow=2, InactivityTimeout=3600s
2025-12-03 22:05:38,755 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Pool ADMIN inicializado. Size=10, MaxOverflow=5
2025-12-03 22:05:38,755 - app.infrastructure.database.connection_pool - INFO - ✅ Módulo de connection pooling cargado y activo
2025-12-03 22:05:38,755 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Configuración de pools de tenants: MaxPools=50, PoolSize=3, MaxOverflow=2, InactivityTimeout=3600s
2025-12-03 22:05:38,755 - app.infrastructure.database.connection_pool - INFO -    Configuración: MaxTenantPools=50, TenantPoolSize=3, InactivityTimeout=3600s
2025-12-03 22:05:38,758 - app.infrastructure.database.connection_pool - INFO - ✅ Módulo de connection pooling cargado y activo
2025-12-03 22:05:38,758 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Todos los pools cerrados
2025-12-03 22:05:38,758 - app.infrastructure.database.connection_pool - INFO -    Configuración: MaxTenantPools=50, TenantPoolSize=3, InactivityTimeout=3600s
2025-12-03 22:05:38,758 - app.main - INFO - ✅ Pools de conexión cerrados correctamente
2025-12-03 22:05:38,759 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Todos los pools cerrados
2025-12-03 22:05:38,759 - app.main - INFO - ✅ Pools de conexión cerrados correctamente
2025-12-03 22:05:39,515 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 22:05:39,697 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 22:05:39,697 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 22:05:39,707 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 22:05:39,707 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 22:05:39,708 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 22:05:39,708 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 22:05:39,709 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, DEFAULT_TYPE=single
2025-12-03 22:05:39,763 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 22:05:40,015 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 22:05:40,025 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 22:05:40,027 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 22:05:40,028 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 22:05:40,028 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 22:05:40,030 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 22:05:40,030 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, DEFAULT_TYPE=single
2025-12-03 22:05:40,045 - app.core.security.rate_limiting - INFO - [RATE_LIMITING] Activado. Límites: Login=10/minute, API=200/minute
2025-12-03 22:05:40,053 - app.core.security.rate_limiting - INFO - ✅ Módulo de rate limiting cargado y activo
2025-12-03 22:05:40,122 - app.core.authorization.rbac - INFO - 🔐 Inicializando sistema de autorización...
2025-12-03 22:05:40,122 - app.core.authorization.rbac - INFO - ✅ Sistema de autorización inicializado correctamente
2025-12-03 22:05:40,122 - app.core.authorization.rbac - INFO - 📊 Permisos del sistema: 6 módulos configurados
2025-12-03 22:05:40,430 - app.core.security.rate_limiting - INFO - [RATE_LIMITING] Activado. Límites: Login=10/minute, API=200/minute
2025-12-03 22:05:40,430 - app.core.security.rate_limiting - INFO - ✅ Módulo de rate limiting cargado y activo
2025-12-03 22:05:40,538 - app.core.authorization.rbac - INFO - 🔐 Inicializando sistema de autorización...
2025-12-03 22:05:40,538 - app.core.authorization.rbac - INFO - ✅ Sistema de autorización inicializado correctamente
2025-12-03 22:05:40,538 - app.core.authorization.rbac - INFO - 📊 Permisos del sistema: 6 módulos configurados
2025-12-03 22:07:31,549 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 22:07:31,746 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 22:07:31,746 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 22:07:31,756 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 22:07:31,757 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 22:07:31,758 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 22:07:31,758 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 22:07:31,758 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, DEFAULT_TYPE=single
2025-12-03 22:07:32,069 - app.core.security.rate_limiting - INFO - [RATE_LIMITING] Activado. Límites: Login=10/minute, API=200/minute
2025-12-03 22:07:32,069 - app.core.security.rate_limiting - INFO - ✅ Módulo de rate limiting cargado y activo
2025-12-03 22:07:32,147 - app.core.authorization.rbac - INFO - 🔐 Inicializando sistema de autorización...
2025-12-03 22:07:32,147 - app.core.authorization.rbac - INFO - ✅ Sistema de autorización inicializado correctamente
2025-12-03 22:07:32,151 - app.core.authorization.rbac - INFO - 📊 Permisos del sistema: 6 módulos configurados
2025-12-03 22:07:50,699 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 22:07:50,887 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 22:07:50,887 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 22:07:50,905 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 22:07:50,906 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 22:07:50,907 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 22:07:50,908 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 22:07:50,908 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, DEFAULT_TYPE=single
2025-12-03 22:07:51,246 - app.core.security.rate_limiting - INFO - [RATE_LIMITING] Activado. Límites: Login=10/minute, API=200/minute
2025-12-03 22:07:51,246 - app.core.security.rate_limiting - INFO - ✅ Módulo de rate limiting cargado y activo
2025-12-03 22:07:51,337 - app.core.authorization.rbac - INFO - 🔐 Inicializando sistema de autorización...
2025-12-03 22:07:51,337 - app.core.authorization.rbac - INFO - ✅ Sistema de autorización inicializado correctamente
2025-12-03 22:07:51,338 - app.core.authorization.rbac - INFO - 📊 Permisos del sistema: 6 módulos configurados
2025-12-03 22:08:44,818 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 22:08:45,011 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 22:08:45,018 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 22:08:45,020 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 22:08:45,020 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 22:08:45,020 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 22:08:45,022 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 22:08:45,022 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, DEFAULT_TYPE=single
2025-12-03 22:08:45,203 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 22:08:45,381 - app.core.security.rate_limiting - INFO - [RATE_LIMITING] Activado. Límites: Login=10/minute, API=200/minute
2025-12-03 22:08:45,383 - app.core.security.rate_limiting - INFO - ✅ Módulo de rate limiting cargado y activo
2025-12-03 22:08:45,463 - app.core.authorization.rbac - INFO - 🔐 Inicializando sistema de autorización...
2025-12-03 22:08:45,463 - app.core.authorization.rbac - INFO - ✅ Sistema de autorización inicializado correctamente
2025-12-03 22:08:45,463 - app.core.authorization.rbac - INFO - 📊 Permisos del sistema: 6 módulos configurados
2025-12-03 22:08:45,478 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 22:08:45,488 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 22:08:45,490 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 22:08:45,492 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 22:08:45,492 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 22:08:45,493 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 22:08:45,494 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, DEFAULT_TYPE=single
2025-12-03 22:08:45,668 - app.core.tenant.middleware - INFO - Módulo tenant_middleware cargado (versión híbrida con soporte para proxies)
2025-12-03 22:08:45,668 - app.main - INFO - ✅ Rate limiting configurado y activo
2025-12-03 22:08:45,848 - app.core.tenant.middleware - INFO - [TENANT_MW] Inicializado - BASE_DOMAIN=app.local, SYSTEM_ID=BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, EXCLUDED_SUBDOMAINS={'static', 'cdn', 'backend', 'www', 'api', 'assets', 'admin'}
2025-12-03 22:08:45,968 - app.core.security.rate_limiting - INFO - [RATE_LIMITING] Activado. Límites: Login=10/minute, API=200/minute
2025-12-03 22:08:45,968 - app.core.security.rate_limiting - INFO - ✅ Módulo de rate limiting cargado y activo
2025-12-03 22:08:46,074 - app.core.authorization.rbac - INFO - 🔐 Inicializando sistema de autorización...
2025-12-03 22:08:46,074 - app.core.authorization.rbac - INFO - ✅ Sistema de autorización inicializado correctamente
2025-12-03 22:08:46,074 - app.core.authorization.rbac - INFO - 📊 Permisos del sistema: 6 módulos configurados
2025-12-03 22:08:46,273 - app.core.tenant.middleware - INFO - Módulo tenant_middleware cargado (versión híbrida con soporte para proxies)
2025-12-03 22:08:46,274 - app.main - INFO - ✅ Rate limiting configurado y activo
2025-12-03 22:08:46,420 - app.core.tenant.middleware - INFO - [TENANT_MW] Inicializado - BASE_DOMAIN=app.local, SYSTEM_ID=BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, EXCLUDED_SUBDOMAINS={'api', 'www', 'admin', 'backend', 'cdn', 'static', 'assets'}
2025-12-03 22:10:32,089 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Pool ADMIN inicializado. Size=10, MaxOverflow=5
2025-12-03 22:10:32,089 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Configuración de pools de tenants: MaxPools=50, PoolSize=3, MaxOverflow=2, InactivityTimeout=3600s
2025-12-03 22:10:32,089 - app.infrastructure.database.connection_pool - INFO - ✅ Módulo de connection pooling cargado y activo
2025-12-03 22:10:32,091 - app.infrastructure.database.connection_pool - INFO -    Configuración: MaxTenantPools=50, TenantPoolSize=3, InactivityTimeout=3600s
2025-12-03 22:10:32,091 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Todos los pools cerrados
2025-12-03 22:10:32,092 - app.main - INFO - ✅ Pools de conexión cerrados correctamente
2025-12-03 22:10:32,871 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 22:10:33,076 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 22:10:33,079 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 22:10:33,087 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 22:10:33,087 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 22:10:33,088 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 22:10:33,088 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 22:10:33,090 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, DEFAULT_TYPE=single
2025-12-03 22:10:33,426 - app.core.security.rate_limiting - INFO - [RATE_LIMITING] Activado. Límites: Login=10/minute, API=200/minute
2025-12-03 22:10:33,426 - app.core.security.rate_limiting - INFO - ✅ Módulo de rate limiting cargado y activo
2025-12-03 22:10:33,496 - app.core.authorization.rbac - INFO - 🔐 Inicializando sistema de autorización...
2025-12-03 22:10:33,499 - app.core.authorization.rbac - INFO - ✅ Sistema de autorización inicializado correctamente
2025-12-03 22:10:33,499 - app.core.authorization.rbac - INFO - 📊 Permisos del sistema: 6 módulos configurados
2025-12-03 22:10:33,672 - app.core.tenant.middleware - INFO - Módulo tenant_middleware cargado (versión híbrida con soporte para proxies)
2025-12-03 22:10:33,673 - app.main - INFO - ✅ Rate limiting configurado y activo
2025-12-03 22:10:33,813 - app.core.tenant.middleware - INFO - [TENANT_MW] Inicializado - BASE_DOMAIN=app.local, SYSTEM_ID=BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, EXCLUDED_SUBDOMAINS={'admin', 'backend', 'assets', 'api', 'cdn', 'www', 'static'}
2025-12-03 22:10:38,911 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Pool ADMIN inicializado. Size=10, MaxOverflow=5
2025-12-03 22:10:38,911 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Configuración de pools de tenants: MaxPools=50, PoolSize=3, MaxOverflow=2, InactivityTimeout=3600s
2025-12-03 22:10:38,911 - app.infrastructure.database.connection_pool - INFO - ✅ Módulo de connection pooling cargado y activo
2025-12-03 22:10:38,911 - app.infrastructure.database.connection_pool - INFO -    Configuración: MaxTenantPools=50, TenantPoolSize=3, InactivityTimeout=3600s
2025-12-03 22:10:38,911 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Todos los pools cerrados
2025-12-03 22:10:38,911 - app.main - INFO - ✅ Pools de conexión cerrados correctamente
2025-12-03 22:10:39,878 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 22:10:40,110 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 22:10:40,116 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 22:10:40,116 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 22:10:40,116 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 22:10:40,120 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 22:10:40,120 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 22:10:40,120 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, DEFAULT_TYPE=single
2025-12-03 22:10:40,506 - app.core.security.rate_limiting - INFO - [RATE_LIMITING] Activado. Límites: Login=10/minute, API=200/minute
2025-12-03 22:10:40,506 - app.core.security.rate_limiting - INFO - ✅ Módulo de rate limiting cargado y activo
2025-12-03 22:10:40,616 - app.core.authorization.rbac - INFO - 🔐 Inicializando sistema de autorización...
2025-12-03 22:10:40,616 - app.core.authorization.rbac - INFO - ✅ Sistema de autorización inicializado correctamente
2025-12-03 22:10:40,616 - app.core.authorization.rbac - INFO - 📊 Permisos del sistema: 6 módulos configurados
2025-12-03 22:10:40,870 - app.core.tenant.middleware - INFO - Módulo tenant_middleware cargado (versión híbrida con soporte para proxies)
2025-12-03 22:10:40,870 - app.main - INFO - ✅ Rate limiting configurado y activo
2025-12-03 22:10:41,066 - app.core.tenant.middleware - INFO - [TENANT_MW] Inicializado - BASE_DOMAIN=app.local, SYSTEM_ID=BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, EXCLUDED_SUBDOMAINS={'backend', 'www', 'api', 'admin', 'static', 'cdn', 'assets'}
2025-12-03 22:10:50,242 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/auth/refresh/
2025-12-03 22:10:50,243 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/auth/refresh/ 200 1.4ms
2025-12-03 22:10:50,247 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/refresh/
2025-12-03 22:10:50,249 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 22:10:50,249 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': acme.app.local:5173
2025-12-03 22:10:50,250 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 22:10:50,250 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 22:10:50,251 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 22:10:50,255 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] AsyncEngine creado para admin
2025-12-03 22:10:50,423 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 22:10:50,425 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 22:10:50,426 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 22:10:50,430 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 22:10:54,566 - app.infrastructure.cache.redis_cache - WARNING - [REDIS_CACHE] Error conectando a Redis: Error 10061 connecting to localhost:6379. No se puede establecer una conexión ya que el equipo de destino denegó expresamente dicha conexión.. Cache desactivado automáticamente (usando fallback en memoria).
2025-12-03 22:10:54,566 - app.infrastructure.cache.redis_cache - INFO - ℹ️ Módulo de Redis cache cargado pero desactivado (usando fallback en memoria)
2025-12-03 22:10:54,570 - app.core.security.encryption - ERROR - Token de encriptación inválido. Posibles causas: clave incorrecta o datos corruptos
2025-12-03 22:10:54,570 - app.core.tenant.routing - ERROR - [METADATA] Error al desencriptar credenciales para cliente ee7bfc14-995f-4209-b4b9-99c307534a43: Credencial corrupta o clave de encriptación incorrecta
2025-12-03 22:10:54,578 - app.core.tenant.routing - WARNING - [METADATA] No se encontró metadata para cliente ee7bfc14-995f-4209-b4b9-99c307534a43. Usando Single-DB como fallback.
2025-12-03 22:10:54,578 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 22:10:54,579 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/auth/refresh/
2025-12-03 22:10:54,582 - app.modules.auth.application.services.auth_service - WARNING - [REFRESH] No se proporcionó refresh token. Cliente: web
2025-12-03 22:10:54,583 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/refresh/ 401 4335.2ms
2025-12-03 22:11:27,291 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/auth/login/
2025-12-03 22:11:27,292 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/auth/login/ 200 1.0ms
2025-12-03 22:11:27,295 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/login/
2025-12-03 22:11:27,296 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 22:11:27,297 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': acme.app.local:5173
2025-12-03 22:11:27,297 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 22:11:27,298 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 22:11:27,298 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 22:11:27,303 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 22:11:27,304 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 22:11:27,304 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 22:11:27,308 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 22:11:27,309 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 22:11:27,310 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43, db_type=single, bd=bd_hybrid_sistema_central, path=/api/v1/auth/login/
2025-12-03 22:11:27,313 - app.modules.auth.presentation.endpoints - INFO - Cliente ee7bfc14-995f-4209-b4b9-99c307534a43 resuelto y validado para login.
2025-12-03 22:11:27,313 - app.modules.auth.application.services.auth_service - INFO - [AUTH] Intento de login: username='admin_acme', cliente_id_destino=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 22:11:27,313 - app.modules.auth.application.services.auth_service - INFO - [AUTH] Usuario regular. Buscando en BD del cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 22:11:27,321 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] AsyncEngine creado para tenant_ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 22:11:27,335 - app.modules.auth.application.services.auth_service - WARNING - [AUTH] Usuario NO ENCONTRADO: username='admin_acme', cliente_id_buscado=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 22:11:27,347 - app.modules.superadmin.application.services.audit_service - INFO - [AUDIT] auth_audit_log registrado: evento=login_failed, cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43, usuario_id=None, exito=False
2025-12-03 22:11:27,348 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/login/ 401 52.4ms
2025-12-03 22:27:18,086 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Pool ADMIN inicializado. Size=10, MaxOverflow=5
2025-12-03 22:27:18,086 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Configuración de pools de tenants: MaxPools=50, PoolSize=3, MaxOverflow=2, InactivityTimeout=3600s
2025-12-03 22:27:18,086 - app.infrastructure.database.connection_pool - INFO - ✅ Módulo de connection pooling cargado y activo
2025-12-03 22:27:18,086 - app.infrastructure.database.connection_pool - INFO -    Configuración: MaxTenantPools=50, TenantPoolSize=3, InactivityTimeout=3600s
2025-12-03 22:27:18,086 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Todos los pools cerrados
2025-12-03 22:27:18,086 - app.main - INFO - ✅ Pools de conexión cerrados correctamente
2025-12-03 22:27:18,187 - asyncio - ERROR - Unclosed connection
connection: <aioodbc.connection.Connection object at 0x0000020B977D70B0>
2025-12-03 22:27:18,187 - asyncio - ERROR - Unclosed connection
connection: <aioodbc.connection.Connection object at 0x0000020B99997C20>
2025-12-03 22:27:18,905 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 22:27:19,108 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 22:27:19,115 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 22:27:19,118 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 22:27:19,118 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 22:27:19,119 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 22:27:19,120 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 22:27:19,120 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, DEFAULT_TYPE=single
2025-12-03 22:27:19,435 - app.core.security.rate_limiting - INFO - [RATE_LIMITING] Activado. Límites: Login=10/minute, API=200/minute
2025-12-03 22:27:19,435 - app.core.security.rate_limiting - INFO - ✅ Módulo de rate limiting cargado y activo
2025-12-03 22:27:19,506 - app.core.authorization.rbac - INFO - 🔐 Inicializando sistema de autorización...
2025-12-03 22:27:19,506 - app.core.authorization.rbac - INFO - ✅ Sistema de autorización inicializado correctamente
2025-12-03 22:27:19,508 - app.core.authorization.rbac - INFO - 📊 Permisos del sistema: 6 módulos configurados
2025-12-03 22:27:19,666 - app.core.tenant.middleware - INFO - Módulo tenant_middleware cargado (versión híbrida con soporte para proxies)
2025-12-03 22:27:19,666 - app.main - INFO - ✅ Rate limiting configurado y activo
2025-12-03 22:27:19,808 - app.core.tenant.middleware - INFO - [TENANT_MW] Inicializado - BASE_DOMAIN=app.local, SYSTEM_ID=BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, EXCLUDED_SUBDOMAINS={'backend', 'assets', 'www', 'cdn', 'static', 'admin', 'api'}
2025-12-03 22:27:29,065 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Pool ADMIN inicializado. Size=10, MaxOverflow=5
2025-12-03 22:27:29,065 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Configuración de pools de tenants: MaxPools=50, PoolSize=3, MaxOverflow=2, InactivityTimeout=3600s
2025-12-03 22:27:29,065 - app.infrastructure.database.connection_pool - INFO - ✅ Módulo de connection pooling cargado y activo
2025-12-03 22:27:29,065 - app.infrastructure.database.connection_pool - INFO -    Configuración: MaxTenantPools=50, TenantPoolSize=3, InactivityTimeout=3600s
2025-12-03 22:27:29,065 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Todos los pools cerrados
2025-12-03 22:27:29,065 - app.main - INFO - ✅ Pools de conexión cerrados correctamente
2025-12-03 22:27:31,135 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 22:27:31,325 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 22:27:31,330 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 22:27:31,335 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 22:27:31,335 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 22:27:31,337 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 22:27:31,337 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 22:27:31,337 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, DEFAULT_TYPE=single
2025-12-03 22:27:31,658 - app.core.security.rate_limiting - INFO - [RATE_LIMITING] Activado. Límites: Login=10/minute, API=200/minute
2025-12-03 22:27:31,658 - app.core.security.rate_limiting - INFO - ✅ Módulo de rate limiting cargado y activo
2025-12-03 22:27:31,731 - app.core.authorization.rbac - INFO - 🔐 Inicializando sistema de autorización...
2025-12-03 22:27:31,732 - app.core.authorization.rbac - INFO - ✅ Sistema de autorización inicializado correctamente
2025-12-03 22:27:31,732 - app.core.authorization.rbac - INFO - 📊 Permisos del sistema: 6 módulos configurados
2025-12-03 22:27:31,885 - app.core.tenant.middleware - INFO - Módulo tenant_middleware cargado (versión híbrida con soporte para proxies)
2025-12-03 22:27:31,895 - app.main - INFO - ✅ Rate limiting configurado y activo
2025-12-03 22:27:32,052 - app.core.tenant.middleware - INFO - [TENANT_MW] Inicializado - BASE_DOMAIN=app.local, SYSTEM_ID=BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, EXCLUDED_SUBDOMAINS={'www', 'assets', 'static', 'backend', 'admin', 'cdn', 'api'}
2025-12-03 22:27:39,565 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/auth/refresh/
2025-12-03 22:27:39,568 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/auth/refresh/ 200 1.5ms
2025-12-03 22:27:39,570 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/refresh/
2025-12-03 22:27:39,571 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 22:27:39,573 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': acme.app.local:5173
2025-12-03 22:27:39,574 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 22:27:39,574 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 22:27:39,575 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 22:27:39,580 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] AsyncEngine creado para admin
2025-12-03 22:27:39,735 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 22:27:39,735 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 22:27:39,735 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 22:27:39,741 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 22:27:43,821 - app.infrastructure.cache.redis_cache - WARNING - [REDIS_CACHE] Error conectando a Redis: Error 10061 connecting to localhost:6379. No se puede establecer una conexión ya que el equipo de destino denegó expresamente dicha conexión.. Cache desactivado automáticamente (usando fallback en memoria).
2025-12-03 22:27:43,821 - app.infrastructure.cache.redis_cache - INFO - ℹ️ Módulo de Redis cache cargado pero desactivado (usando fallback en memoria)
2025-12-03 22:27:43,827 - app.core.security.encryption - ERROR - Token de encriptación inválido. Posibles causas: clave incorrecta o datos corruptos
2025-12-03 22:27:43,827 - app.core.tenant.routing - ERROR - [METADATA] Error al desencriptar credenciales para cliente ee7bfc14-995f-4209-b4b9-99c307534a43: Credencial corrupta o clave de encriptación incorrecta
2025-12-03 22:27:43,833 - app.core.tenant.routing - WARNING - [METADATA] No se encontró metadata para cliente ee7bfc14-995f-4209-b4b9-99c307534a43. Usando Single-DB como fallback.
2025-12-03 22:27:43,833 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: tipo_instalacion=cloud, db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 22:27:43,834 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43, tipo_instalacion=cloud, db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A, path=/api/v1/auth/refresh/
2025-12-03 22:27:43,836 - app.modules.auth.application.services.auth_service - WARNING - [REFRESH] No se proporcionó refresh token. Cliente: web
2025-12-03 22:27:43,837 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/refresh/ 401 4266.6ms
2025-12-03 22:28:14,030 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/auth/login/
2025-12-03 22:28:14,031 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/auth/login/ 200 1.0ms
2025-12-03 22:28:14,033 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/login/
2025-12-03 22:28:14,034 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 22:28:14,034 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': acme.app.local:5173
2025-12-03 22:28:14,036 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 22:28:14,036 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 22:28:14,037 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 22:28:14,062 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 22:28:14,062 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 22:28:14,062 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 22:28:14,066 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 22:28:14,066 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: tipo_instalacion=cloud, db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 22:28:14,066 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43, tipo_instalacion=cloud, db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A, path=/api/v1/auth/login/
2025-12-03 22:28:14,077 - app.modules.auth.presentation.endpoints - INFO - Cliente ee7bfc14-995f-4209-b4b9-99c307534a43 resuelto y validado para login.
2025-12-03 22:28:14,077 - app.modules.auth.application.services.auth_service - INFO - [AUTH] Intento de login: username='admin_acme', cliente_id_destino=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 22:28:14,078 - app.modules.auth.application.services.auth_service - INFO - [AUTH] Usuario regular. Buscando en BD del cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 22:28:14,079 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] AsyncEngine creado para tenant_ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 22:28:14,163 - app.modules.auth.application.services.auth_service - WARNING - [AUTH] Usuario NO ENCONTRADO: username='admin_acme', cliente_id_buscado=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 22:28:14,177 - app.modules.superadmin.application.services.audit_service - INFO - [AUDIT] auth_audit_log registrado: evento=login_failed, cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43, usuario_id=None, exito=False
2025-12-03 22:28:14,178 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/login/ 401 144.1ms
2025-12-03 22:30:40,254 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Pool ADMIN inicializado. Size=10, MaxOverflow=5
2025-12-03 22:30:40,255 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Configuración de pools de tenants: MaxPools=50, PoolSize=3, MaxOverflow=2, InactivityTimeout=3600s
2025-12-03 22:30:40,255 - app.infrastructure.database.connection_pool - INFO - ✅ Módulo de connection pooling cargado y activo
2025-12-03 22:30:40,256 - app.infrastructure.database.connection_pool - INFO -    Configuración: MaxTenantPools=50, TenantPoolSize=3, InactivityTimeout=3600s
2025-12-03 22:30:40,257 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Todos los pools cerrados
2025-12-03 22:30:40,257 - app.main - INFO - ✅ Pools de conexión cerrados correctamente
2025-12-03 22:30:41,147 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 22:30:41,353 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 22:30:41,360 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 22:30:41,363 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 22:30:41,363 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 22:30:41,364 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 22:30:41,365 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 22:30:41,365 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, DEFAULT_TYPE=single
2025-12-03 22:30:41,780 - app.core.security.rate_limiting - INFO - [RATE_LIMITING] Activado. Límites: Login=10/minute, API=200/minute
2025-12-03 22:30:41,780 - app.core.security.rate_limiting - INFO - ✅ Módulo de rate limiting cargado y activo
2025-12-03 22:30:41,877 - app.core.authorization.rbac - INFO - 🔐 Inicializando sistema de autorización...
2025-12-03 22:30:41,878 - app.core.authorization.rbac - INFO - ✅ Sistema de autorización inicializado correctamente
2025-12-03 22:30:41,878 - app.core.authorization.rbac - INFO - 📊 Permisos del sistema: 6 módulos configurados
2025-12-03 22:30:42,082 - app.core.tenant.middleware - INFO - Módulo tenant_middleware cargado (versión híbrida con soporte para proxies)
2025-12-03 22:30:42,083 - app.main - INFO - ✅ Rate limiting configurado y activo
2025-12-03 22:30:42,256 - app.core.tenant.middleware - INFO - [TENANT_MW] Inicializado - BASE_DOMAIN=app.local, SYSTEM_ID=BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, EXCLUDED_SUBDOMAINS={'static', 'backend', 'cdn', 'api', 'admin', 'www', 'assets'}
2025-12-03 22:32:30,584 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Pool ADMIN inicializado. Size=10, MaxOverflow=5
2025-12-03 22:32:30,584 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Configuración de pools de tenants: MaxPools=50, PoolSize=3, MaxOverflow=2, InactivityTimeout=3600s
2025-12-03 22:32:30,584 - app.infrastructure.database.connection_pool - INFO - ✅ Módulo de connection pooling cargado y activo
2025-12-03 22:32:30,584 - app.infrastructure.database.connection_pool - INFO -    Configuración: MaxTenantPools=50, TenantPoolSize=3, InactivityTimeout=3600s
2025-12-03 22:32:30,584 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Todos los pools cerrados
2025-12-03 22:32:30,584 - app.main - INFO - ✅ Pools de conexión cerrados correctamente
2025-12-03 22:32:30,676 - asyncio - ERROR - Unclosed connection
connection: <aioodbc.connection.Connection object at 0x0000020FBB145910>
2025-12-03 22:32:30,677 - asyncio - ERROR - Unclosed connection
connection: <aioodbc.connection.Connection object at 0x0000020FBBE47BC0>
2025-12-03 22:32:31,474 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 22:32:31,724 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 22:32:31,727 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 22:32:31,727 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 22:32:31,740 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 22:32:31,741 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 22:32:31,741 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 22:32:31,741 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, DEFAULT_TYPE=single
2025-12-03 22:32:32,122 - app.core.security.rate_limiting - INFO - [RATE_LIMITING] Activado. Límites: Login=10/minute, API=200/minute
2025-12-03 22:32:32,122 - app.core.security.rate_limiting - INFO - ✅ Módulo de rate limiting cargado y activo
2025-12-03 22:32:32,221 - app.core.authorization.rbac - INFO - 🔐 Inicializando sistema de autorización...
2025-12-03 22:32:32,222 - app.core.authorization.rbac - INFO - ✅ Sistema de autorización inicializado correctamente
2025-12-03 22:32:32,222 - app.core.authorization.rbac - INFO - 📊 Permisos del sistema: 6 módulos configurados
2025-12-03 22:32:32,422 - app.core.tenant.middleware - INFO - Módulo tenant_middleware cargado (versión híbrida con soporte para proxies)
2025-12-03 22:32:32,422 - app.main - INFO - ✅ Rate limiting configurado y activo
2025-12-03 22:32:32,598 - app.core.tenant.middleware - INFO - [TENANT_MW] Inicializado - BASE_DOMAIN=app.local, SYSTEM_ID=BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, EXCLUDED_SUBDOMAINS={'backend', 'cdn', 'assets', 'static', 'api', 'admin', 'www'}
2025-12-03 22:32:59,989 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Pool ADMIN inicializado. Size=10, MaxOverflow=5
2025-12-03 22:32:59,989 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Configuración de pools de tenants: MaxPools=50, PoolSize=3, MaxOverflow=2, InactivityTimeout=3600s
2025-12-03 22:32:59,990 - app.infrastructure.database.connection_pool - INFO - ✅ Módulo de connection pooling cargado y activo
2025-12-03 22:32:59,990 - app.infrastructure.database.connection_pool - INFO -    Configuración: MaxTenantPools=50, TenantPoolSize=3, InactivityTimeout=3600s
2025-12-03 22:32:59,991 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Todos los pools cerrados
2025-12-03 22:32:59,992 - app.main - INFO - ✅ Pools de conexión cerrados correctamente
2025-12-03 22:33:01,920 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 22:33:02,133 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 22:33:02,140 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 22:33:02,142 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 22:33:02,143 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 22:33:02,143 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 22:33:02,144 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 22:33:02,144 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, DEFAULT_TYPE=single
2025-12-03 22:33:02,474 - app.core.security.rate_limiting - INFO - [RATE_LIMITING] Activado. Límites: Login=10/minute, API=200/minute
2025-12-03 22:33:02,474 - app.core.security.rate_limiting - INFO - ✅ Módulo de rate limiting cargado y activo
2025-12-03 22:33:02,545 - app.core.authorization.rbac - INFO - 🔐 Inicializando sistema de autorización...
2025-12-03 22:33:02,545 - app.core.authorization.rbac - INFO - ✅ Sistema de autorización inicializado correctamente
2025-12-03 22:33:02,546 - app.core.authorization.rbac - INFO - 📊 Permisos del sistema: 6 módulos configurados
2025-12-03 22:33:02,709 - app.core.tenant.middleware - INFO - Módulo tenant_middleware cargado (versión híbrida con soporte para proxies)
2025-12-03 22:33:02,710 - app.main - INFO - ✅ Rate limiting configurado y activo
2025-12-03 22:33:02,859 - app.core.tenant.middleware - INFO - [TENANT_MW] Inicializado - BASE_DOMAIN=app.local, SYSTEM_ID=BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, EXCLUDED_SUBDOMAINS={'admin', 'assets', 'cdn', 'backend', 'www', 'static', 'api'}
2025-12-03 22:33:04,626 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/refresh/
2025-12-03 22:33:04,626 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 22:33:04,626 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': acme.app.local:5173
2025-12-03 22:33:04,626 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 22:33:04,630 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 22:33:04,630 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 22:33:04,630 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] AsyncEngine creado para admin
2025-12-03 22:33:04,792 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 22:33:04,793 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 22:33:04,793 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 22:33:04,793 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 22:33:08,938 - app.infrastructure.cache.redis_cache - WARNING - [REDIS_CACHE] Error conectando a Redis: Error 10061 connecting to localhost:6379. No se puede establecer una conexión ya que el equipo de destino denegó expresamente dicha conexión.. Cache desactivado automáticamente (usando fallback en memoria).
2025-12-03 22:33:08,938 - app.infrastructure.cache.redis_cache - INFO - ℹ️ Módulo de Redis cache cargado pero desactivado (usando fallback en memoria)
2025-12-03 22:33:08,941 - app.core.security.encryption - ERROR - Token de encriptación inválido. Posibles causas: clave incorrecta o datos corruptos
2025-12-03 22:33:08,941 - app.core.tenant.routing - ERROR - [METADATA] Error al desencriptar credenciales para cliente ee7bfc14-995f-4209-b4b9-99c307534a43: Credencial corrupta o clave de encriptación incorrecta
2025-12-03 22:33:08,952 - app.core.tenant.routing - WARNING - [METADATA] No se encontró metadata para cliente ee7bfc14-995f-4209-b4b9-99c307534a43. Usando Single-DB como fallback. tipo_instalacion=dedicated
2025-12-03 22:33:08,953 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: tipo_instalacion=dedicated, db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 22:33:08,953 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43, tipo_instalacion=dedicated, db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A, path=/api/v1/auth/refresh/
2025-12-03 22:33:08,955 - app.modules.auth.application.services.auth_service - WARNING - [REFRESH] No se proporcionó refresh token. Cliente: web
2025-12-03 22:33:08,956 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/refresh/ 401 4329.5ms
2025-12-03 22:33:46,952 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/login/
2025-12-03 22:33:46,952 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 22:33:46,952 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': acme.app.local:5173
2025-12-03 22:33:46,952 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 22:33:46,952 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 22:33:46,952 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 22:33:46,973 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 22:33:46,973 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 22:33:46,973 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 22:33:46,980 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 22:33:46,980 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: tipo_instalacion=dedicated, db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 22:33:46,980 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43, tipo_instalacion=dedicated, db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A, path=/api/v1/auth/login/
2025-12-03 22:33:46,985 - app.modules.auth.presentation.endpoints - INFO - Cliente ee7bfc14-995f-4209-b4b9-99c307534a43 resuelto y validado para login.
2025-12-03 22:33:46,989 - app.modules.auth.application.services.auth_service - INFO - [AUTH] Intento de login: username='admin_acme', cliente_id_destino=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 22:33:46,989 - app.modules.auth.application.services.auth_service - INFO - [AUTH] Usuario regular. Buscando en BD del cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 22:33:46,990 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] AsyncEngine creado para tenant_ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 22:33:47,077 - app.modules.auth.application.services.auth_service - WARNING - [AUTH] Usuario NO ENCONTRADO: username='admin_acme', cliente_id_buscado=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 22:33:47,087 - app.modules.superadmin.application.services.audit_service - INFO - [AUDIT] auth_audit_log registrado: evento=login_failed, cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43, usuario_id=None, exito=False
2025-12-03 22:33:47,088 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/login/ 401 135.9ms
2025-12-03 22:35:19,054 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/login/
2025-12-03 22:35:19,055 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 22:35:19,056 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': acme.app.local:5173
2025-12-03 22:35:19,056 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 22:35:19,056 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 22:35:19,057 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 22:35:19,066 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 22:35:19,067 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 22:35:19,067 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 22:35:19,071 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 22:35:19,071 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: tipo_instalacion=dedicated, db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 22:35:19,073 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43, tipo_instalacion=dedicated, db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A, path=/api/v1/auth/login/
2025-12-03 22:35:19,079 - app.modules.auth.presentation.endpoints - INFO - Cliente ee7bfc14-995f-4209-b4b9-99c307534a43 resuelto y validado para login.
2025-12-03 22:35:19,080 - app.modules.auth.application.services.auth_service - INFO - [AUTH] Intento de login: username='admin_acme', cliente_id_destino=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 22:35:19,080 - app.modules.auth.application.services.auth_service - INFO - [AUTH] Usuario regular. Buscando en BD del cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 22:35:19,087 - app.modules.auth.application.services.auth_service - WARNING - [AUTH] Usuario NO ENCONTRADO: username='admin_acme', cliente_id_buscado=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 22:35:19,102 - app.modules.superadmin.application.services.audit_service - INFO - [AUDIT] auth_audit_log registrado: evento=login_failed, cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43, usuario_id=None, exito=False
2025-12-03 22:35:19,102 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/login/ 401 48.7ms
2025-12-03 22:35:40,617 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Pool ADMIN inicializado. Size=10, MaxOverflow=5
2025-12-03 22:35:40,617 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Configuración de pools de tenants: MaxPools=50, PoolSize=3, MaxOverflow=2, InactivityTimeout=3600s
2025-12-03 22:35:40,617 - app.infrastructure.database.connection_pool - INFO - ✅ Módulo de connection pooling cargado y activo
2025-12-03 22:35:40,619 - app.infrastructure.database.connection_pool - INFO -    Configuración: MaxTenantPools=50, TenantPoolSize=3, InactivityTimeout=3600s
2025-12-03 22:35:40,619 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Todos los pools cerrados
2025-12-03 22:35:40,619 - app.main - INFO - ✅ Pools de conexión cerrados correctamente
2025-12-03 22:35:41,528 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 22:35:41,791 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 22:35:41,798 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 22:35:41,801 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 22:35:41,801 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 22:35:41,802 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 22:35:41,803 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 22:35:41,803 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, DEFAULT_TYPE=single
2025-12-03 22:35:42,183 - app.core.security.rate_limiting - INFO - [RATE_LIMITING] Activado. Límites: Login=10/minute, API=200/minute
2025-12-03 22:35:42,183 - app.core.security.rate_limiting - INFO - ✅ Módulo de rate limiting cargado y activo
2025-12-03 22:35:42,285 - app.core.authorization.rbac - INFO - 🔐 Inicializando sistema de autorización...
2025-12-03 22:35:42,285 - app.core.authorization.rbac - INFO - ✅ Sistema de autorización inicializado correctamente
2025-12-03 22:35:42,285 - app.core.authorization.rbac - INFO - 📊 Permisos del sistema: 6 módulos configurados
2025-12-03 22:35:42,527 - app.core.tenant.middleware - INFO - Módulo tenant_middleware cargado (versión híbrida con soporte para proxies)
2025-12-03 22:35:42,527 - app.main - INFO - ✅ Rate limiting configurado y activo
2025-12-03 22:35:42,685 - app.core.tenant.middleware - INFO - [TENANT_MW] Inicializado - BASE_DOMAIN=app.local, SYSTEM_ID=BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, EXCLUDED_SUBDOMAINS={'www', 'admin', 'cdn', 'assets', 'api', 'static', 'backend'}
2025-12-03 22:40:23,328 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Pool ADMIN inicializado. Size=10, MaxOverflow=5
2025-12-03 22:40:23,328 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Configuración de pools de tenants: MaxPools=50, PoolSize=3, MaxOverflow=2, InactivityTimeout=3600s
2025-12-03 22:40:23,329 - app.infrastructure.database.connection_pool - INFO - ✅ Módulo de connection pooling cargado y activo
2025-12-03 22:40:23,329 - app.infrastructure.database.connection_pool - INFO -    Configuración: MaxTenantPools=50, TenantPoolSize=3, InactivityTimeout=3600s
2025-12-03 22:40:23,330 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Todos los pools cerrados
2025-12-03 22:40:23,331 - app.main - INFO - ✅ Pools de conexión cerrados correctamente
2025-12-03 22:40:23,476 - asyncio - ERROR - Unclosed connection
connection: <aioodbc.connection.Connection object at 0x000001971BF3E210>
2025-12-03 22:40:23,477 - asyncio - ERROR - Unclosed connection
connection: <aioodbc.connection.Connection object at 0x000001971CD37770>
2025-12-03 22:40:24,309 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 22:40:24,547 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 22:40:24,559 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 22:40:24,567 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 22:40:24,568 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 22:40:24,568 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 22:40:24,569 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 22:40:24,569 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, DEFAULT_TYPE=single
2025-12-03 22:40:24,922 - app.core.security.rate_limiting - INFO - [RATE_LIMITING] Activado. Límites: Login=10/minute, API=200/minute
2025-12-03 22:40:24,922 - app.core.security.rate_limiting - INFO - ✅ Módulo de rate limiting cargado y activo
2025-12-03 22:40:25,009 - app.core.authorization.rbac - INFO - 🔐 Inicializando sistema de autorización...
2025-12-03 22:40:25,017 - app.core.authorization.rbac - INFO - ✅ Sistema de autorización inicializado correctamente
2025-12-03 22:40:25,017 - app.core.authorization.rbac - INFO - 📊 Permisos del sistema: 6 módulos configurados
2025-12-03 22:40:25,273 - app.core.tenant.middleware - INFO - Módulo tenant_middleware cargado (versión híbrida con soporte para proxies)
2025-12-03 22:40:25,275 - app.main - INFO - ✅ Rate limiting configurado y activo
2025-12-03 22:40:25,443 - app.core.tenant.middleware - INFO - [TENANT_MW] Inicializado - BASE_DOMAIN=app.local, SYSTEM_ID=BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, EXCLUDED_SUBDOMAINS={'api', 'static', 'admin', 'cdn', 'assets', 'www', 'backend'}
2025-12-03 22:40:27,911 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Pool ADMIN inicializado. Size=10, MaxOverflow=5
2025-12-03 22:40:27,911 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Configuración de pools de tenants: MaxPools=50, PoolSize=3, MaxOverflow=2, InactivityTimeout=3600s
2025-12-03 22:40:27,911 - app.infrastructure.database.connection_pool - INFO - ✅ Módulo de connection pooling cargado y activo
2025-12-03 22:40:27,911 - app.infrastructure.database.connection_pool - INFO -    Configuración: MaxTenantPools=50, TenantPoolSize=3, InactivityTimeout=3600s
2025-12-03 22:40:27,911 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Todos los pools cerrados
2025-12-03 22:40:27,911 - app.main - INFO - ✅ Pools de conexión cerrados correctamente
2025-12-03 22:40:29,647 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 22:40:29,851 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 22:40:29,857 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 22:40:29,858 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 22:40:29,860 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 22:40:29,861 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 22:40:29,861 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 22:40:29,862 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, DEFAULT_TYPE=single
2025-12-03 22:40:30,186 - app.core.security.rate_limiting - INFO - [RATE_LIMITING] Activado. Límites: Login=10/minute, API=200/minute
2025-12-03 22:40:30,186 - app.core.security.rate_limiting - INFO - ✅ Módulo de rate limiting cargado y activo
2025-12-03 22:40:30,256 - app.core.authorization.rbac - INFO - 🔐 Inicializando sistema de autorización...
2025-12-03 22:40:30,257 - app.core.authorization.rbac - INFO - ✅ Sistema de autorización inicializado correctamente
2025-12-03 22:40:30,257 - app.core.authorization.rbac - INFO - 📊 Permisos del sistema: 6 módulos configurados
2025-12-03 22:40:30,414 - app.core.tenant.middleware - INFO - Módulo tenant_middleware cargado (versión híbrida con soporte para proxies)
2025-12-03 22:40:30,414 - app.main - INFO - ✅ Rate limiting configurado y activo
2025-12-03 22:40:30,558 - app.core.tenant.middleware - INFO - [TENANT_MW] Inicializado - BASE_DOMAIN=app.local, SYSTEM_ID=BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, EXCLUDED_SUBDOMAINS={'www', 'api', 'static', 'cdn', 'admin', 'assets', 'backend'}
2025-12-03 22:40:32,955 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/auth/refresh/
2025-12-03 22:40:32,957 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/auth/refresh/ 200 1.4ms
2025-12-03 22:40:32,957 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/refresh/
2025-12-03 22:40:32,957 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 22:40:32,957 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': acme.app.local:5173
2025-12-03 22:40:32,963 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 22:40:32,964 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 22:40:32,964 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 22:40:32,967 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] AsyncEngine creado para admin
2025-12-03 22:40:33,137 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 22:40:33,140 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 22:40:33,140 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 22:40:33,145 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 22:40:37,238 - app.infrastructure.cache.redis_cache - WARNING - [REDIS_CACHE] Error conectando a Redis: Error 10061 connecting to localhost:6379. No se puede establecer una conexión ya que el equipo de destino denegó expresamente dicha conexión.. Cache desactivado automáticamente (usando fallback en memoria).
2025-12-03 22:40:37,238 - app.infrastructure.cache.redis_cache - INFO - ℹ️ Módulo de Redis cache cargado pero desactivado (usando fallback en memoria)
2025-12-03 22:40:37,238 - app.core.security.encryption - ERROR - Token de encriptación inválido. Posibles causas: clave incorrecta o datos corruptos
2025-12-03 22:40:37,238 - app.core.tenant.routing - ERROR - [METADATA] Error al desencriptar credenciales para cliente ee7bfc14-995f-4209-b4b9-99c307534a43: Credencial corrupta o clave de encriptación incorrecta
2025-12-03 22:40:37,255 - app.core.security.encryption - ERROR - Token de encriptación inválido. Posibles causas: clave incorrecta o datos corruptos
2025-12-03 22:40:37,256 - app.core.tenant.routing - ERROR - [METADATA] Error al desencriptar credenciales para cliente ee7bfc14-995f-4209-b4b9-99c307534a43: Credencial corrupta o clave de encriptación incorrecta
2025-12-03 22:40:37,256 - app.core.tenant.routing - WARNING - [METADATA] Cliente ee7bfc14-995f-4209-b4b9-99c307534a43 es 'dedicated' pero no tiene conexión configurada. Usando Multi-DB como fallback (requiere configuración de conexión).
2025-12-03 22:40:37,257 - app.core.tenant.routing - WARNING - [METADATA] No se encontró metadata para cliente ee7bfc14-995f-4209-b4b9-99c307534a43. Usando MULTI-DB como fallback. tipo_instalacion=dedicated
2025-12-03 22:40:37,258 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: tipo_instalacion=dedicated, db_type=multi, bd=None, servidor=N/A
2025-12-03 22:40:37,258 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43, tipo_instalacion=dedicated, db_type=multi, bd=None, servidor=N/A, path=/api/v1/auth/refresh/
2025-12-03 22:40:37,261 - app.modules.auth.application.services.auth_service - WARNING - [REFRESH] No se proporcionó refresh token. Cliente: web
2025-12-03 22:40:37,262 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/refresh/ 401 4300.5ms
2025-12-03 22:40:40,808 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Pool ADMIN inicializado. Size=10, MaxOverflow=5
2025-12-03 22:40:40,808 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Configuración de pools de tenants: MaxPools=50, PoolSize=3, MaxOverflow=2, InactivityTimeout=3600s
2025-12-03 22:40:40,808 - app.infrastructure.database.connection_pool - INFO - ✅ Módulo de connection pooling cargado y activo
2025-12-03 22:40:40,808 - app.infrastructure.database.connection_pool - INFO -    Configuración: MaxTenantPools=50, TenantPoolSize=3, InactivityTimeout=3600s
2025-12-03 22:40:40,808 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Todos los pools cerrados
2025-12-03 22:40:40,808 - app.main - INFO - ✅ Pools de conexión cerrados correctamente
2025-12-03 22:40:41,759 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 22:40:42,019 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 22:40:42,019 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 22:40:42,030 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 22:40:42,030 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 22:40:42,030 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 22:40:42,030 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 22:40:42,030 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, DEFAULT_TYPE=single
2025-12-03 22:40:42,497 - app.core.security.rate_limiting - INFO - [RATE_LIMITING] Activado. Límites: Login=10/minute, API=200/minute
2025-12-03 22:40:42,497 - app.core.security.rate_limiting - INFO - ✅ Módulo de rate limiting cargado y activo
2025-12-03 22:40:42,604 - app.core.authorization.rbac - INFO - 🔐 Inicializando sistema de autorización...
2025-12-03 22:40:42,604 - app.core.authorization.rbac - INFO - ✅ Sistema de autorización inicializado correctamente
2025-12-03 22:40:42,604 - app.core.authorization.rbac - INFO - 📊 Permisos del sistema: 6 módulos configurados
2025-12-03 22:40:42,848 - app.core.tenant.middleware - INFO - Módulo tenant_middleware cargado (versión híbrida con soporte para proxies)
2025-12-03 22:40:42,850 - app.main - INFO - ✅ Rate limiting configurado y activo
2025-12-03 22:40:43,054 - app.core.tenant.middleware - INFO - [TENANT_MW] Inicializado - BASE_DOMAIN=app.local, SYSTEM_ID=BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, EXCLUDED_SUBDOMAINS={'admin', 'api', 'cdn', 'assets', 'backend', 'static', 'www'}
2025-12-03 22:43:38,917 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/auth/login/
2025-12-03 22:43:38,918 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/auth/login/ 200 0.9ms
2025-12-03 22:43:38,920 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/login/
2025-12-03 22:43:38,921 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 22:43:38,921 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': acme.app.local:5173
2025-12-03 22:43:38,922 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 22:43:38,922 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 22:43:38,922 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 22:43:38,947 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 22:43:38,948 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 22:43:38,949 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 22:43:38,952 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 22:43:38,953 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: tipo_instalacion=dedicated, db_type=multi, bd=None, servidor=N/A
2025-12-03 22:43:38,954 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43, tipo_instalacion=dedicated, db_type=multi, bd=None, servidor=N/A, path=/api/v1/auth/login/
2025-12-03 22:43:38,961 - app.modules.auth.presentation.endpoints - INFO - Cliente ee7bfc14-995f-4209-b4b9-99c307534a43 resuelto y validado para login.
2025-12-03 22:43:38,962 - app.modules.auth.application.services.auth_service - INFO - [AUTH] Intento de login: username='admin_acme', cliente_id_destino=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 22:43:38,962 - app.modules.auth.application.services.auth_service - INFO - [AUTH] Usuario regular. Buscando en BD del cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 22:43:38,964 - app.infrastructure.database.connection_async - ERROR - [ASYNC_CONNECTION] Error creando AsyncEngine: quote_from_bytes() expected bytes
Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\connection_async.py", line 199, in _get_async_engine
    conn_str = _build_async_connection_string(connection_type, client_id, connection_metadata)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\connection_async.py", line 141, in _build_async_connection_string
    f"mssql+aioodbc://{quote_plus(usuario)}:"
                       ^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\urllib\parse.py", line 943, in quote_plus
    string = quote(string, safe + space, encoding, errors)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\urllib\parse.py", line 927, in quote
    return quote_from_bytes(string, safe)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\urllib\parse.py", line 957, in quote_from_bytes
    raise TypeError("quote_from_bytes() expected bytes")
TypeError: quote_from_bytes() expected bytes
2025-12-03 22:43:38,966 - app.modules.auth.application.services.auth_service - ERROR - [AUTH] Error en autenticación: username='admin_acme', cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43, error=DatabaseError.__init__() got an unexpected keyword argument 'status_code'
Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\modules\auth\application\services\auth_service.py", line 183, in authenticate_user
    result = await execute_query(
             ^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 126, in execute_query
    async with _get_connection_context(connection_type, client_id) as session:
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\contextlib.py", line 210, in __aenter__
    return await anext(self.gen)
           ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\core\tenant\routing.py", line 817, in get_connection_for_tenant
    async with get_db_connection(
               ^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\contextlib.py", line 210, in __aenter__
    return await anext(self.gen)
           ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\connection_async.py", line 289, in get_db_connection
    raise DatabaseError(
          ^^^^^^^^^^^^^^
TypeError: DatabaseError.__init__() got an unexpected keyword argument 'status_code'
2025-12-03 22:43:38,984 - app.modules.superadmin.application.services.audit_service - INFO - [AUDIT] auth_audit_log registrado: evento=login_failed, cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43, usuario_id=None, exito=False
2025-12-03 22:43:38,984 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/login/ 500 66.7ms
2025-12-03 22:44:03,109 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/refresh/
2025-12-03 22:44:03,111 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 22:44:03,111 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': acme.app.local:5173
2025-12-03 22:44:03,112 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 22:44:03,112 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 22:44:03,112 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 22:44:03,121 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 22:44:03,122 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 22:44:03,122 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 22:44:03,125 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 22:44:03,125 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: tipo_instalacion=dedicated, db_type=multi, bd=None, servidor=N/A
2025-12-03 22:44:03,125 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43, tipo_instalacion=dedicated, db_type=multi, bd=None, servidor=N/A, path=/api/v1/auth/refresh/
2025-12-03 22:44:03,131 - app.modules.auth.application.services.auth_service - WARNING - [REFRESH] No se proporcionó refresh token. Cliente: web
2025-12-03 22:44:03,133 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/refresh/ 401 23.5ms
2025-12-03 22:44:06,402 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Pool ADMIN inicializado. Size=10, MaxOverflow=5
2025-12-03 22:44:06,402 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Configuración de pools de tenants: MaxPools=50, PoolSize=3, MaxOverflow=2, InactivityTimeout=3600s
2025-12-03 22:44:06,402 - app.infrastructure.database.connection_pool - INFO - ✅ Módulo de connection pooling cargado y activo
2025-12-03 22:44:06,407 - app.infrastructure.database.connection_pool - INFO -    Configuración: MaxTenantPools=50, TenantPoolSize=3, InactivityTimeout=3600s
2025-12-03 22:44:06,407 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Todos los pools cerrados
2025-12-03 22:44:06,408 - app.main - INFO - ✅ Pools de conexión cerrados correctamente
2025-12-03 22:44:06,503 - asyncio - ERROR - Unclosed connection
connection: <aioodbc.connection.Connection object at 0x00000164584A3E60>
2025-12-03 22:44:08,118 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 22:44:08,314 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 22:44:08,321 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 22:44:08,324 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 22:44:08,324 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 22:44:08,325 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 22:44:08,325 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 22:44:08,326 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, DEFAULT_TYPE=single
2025-12-03 22:44:08,660 - app.core.security.rate_limiting - INFO - [RATE_LIMITING] Activado. Límites: Login=10/minute, API=200/minute
2025-12-03 22:44:08,661 - app.core.security.rate_limiting - INFO - ✅ Módulo de rate limiting cargado y activo
2025-12-03 22:44:08,730 - app.core.authorization.rbac - INFO - 🔐 Inicializando sistema de autorización...
2025-12-03 22:44:08,730 - app.core.authorization.rbac - INFO - ✅ Sistema de autorización inicializado correctamente
2025-12-03 22:44:08,730 - app.core.authorization.rbac - INFO - 📊 Permisos del sistema: 6 módulos configurados
2025-12-03 22:44:08,887 - app.core.tenant.middleware - INFO - Módulo tenant_middleware cargado (versión híbrida con soporte para proxies)
2025-12-03 22:44:08,888 - app.main - INFO - ✅ Rate limiting configurado y activo
2025-12-03 22:44:09,031 - app.core.tenant.middleware - INFO - [TENANT_MW] Inicializado - BASE_DOMAIN=app.local, SYSTEM_ID=BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, EXCLUDED_SUBDOMAINS={'api', 'assets', 'backend', 'cdn', 'admin', 'www', 'static'}
2025-12-03 22:44:19,211 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/login/
2025-12-03 22:44:19,212 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 22:44:19,213 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': acme.app.local:5173
2025-12-03 22:44:19,213 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 22:44:19,213 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 22:44:19,214 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 22:44:19,217 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] AsyncEngine creado para admin
2025-12-03 22:44:19,334 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 22:44:19,334 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 22:44:19,334 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 22:44:19,334 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 22:44:23,451 - app.infrastructure.cache.redis_cache - WARNING - [REDIS_CACHE] Error conectando a Redis: Error 10061 connecting to localhost:6379. No se puede establecer una conexión ya que el equipo de destino denegó expresamente dicha conexión.. Cache desactivado automáticamente (usando fallback en memoria).
2025-12-03 22:44:23,451 - app.infrastructure.cache.redis_cache - INFO - ℹ️ Módulo de Redis cache cargado pero desactivado (usando fallback en memoria)
2025-12-03 22:44:23,461 - app.core.security.encryption - ERROR - Token de encriptación inválido. Posibles causas: clave incorrecta o datos corruptos
2025-12-03 22:44:23,461 - app.core.tenant.routing - ERROR - [METADATA] Error al desencriptar credenciales para cliente ee7bfc14-995f-4209-b4b9-99c307534a43: Credencial corrupta o clave de encriptación incorrecta
2025-12-03 22:44:23,475 - app.core.security.encryption - ERROR - Token de encriptación inválido. Posibles causas: clave incorrecta o datos corruptos
2025-12-03 22:44:23,475 - app.core.tenant.routing - ERROR - [METADATA] Error al desencriptar credenciales para cliente ee7bfc14-995f-4209-b4b9-99c307534a43: Credencial corrupta o clave de encriptación incorrecta
2025-12-03 22:44:23,475 - app.core.tenant.routing - WARNING - [METADATA] Cliente ee7bfc14-995f-4209-b4b9-99c307534a43 es 'dedicated' pero no tiene conexión configurada. Usando Multi-DB como fallback (requiere configuración de conexión).
2025-12-03 22:44:23,477 - app.core.tenant.routing - WARNING - [METADATA] No se encontró metadata para cliente ee7bfc14-995f-4209-b4b9-99c307534a43. Usando MULTI-DB como fallback. tipo_instalacion=dedicated
2025-12-03 22:44:23,477 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: tipo_instalacion=dedicated, db_type=multi, bd=None, servidor=N/A
2025-12-03 22:44:23,477 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43, tipo_instalacion=dedicated, db_type=multi, bd=None, servidor=N/A, path=/api/v1/auth/login/
2025-12-03 22:44:23,486 - app.modules.auth.presentation.endpoints - INFO - Cliente ee7bfc14-995f-4209-b4b9-99c307534a43 resuelto y validado para login.
2025-12-03 22:44:23,487 - app.modules.auth.application.services.auth_service - INFO - [AUTH] Intento de login: username='admin_acme', cliente_id_destino=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 22:44:23,488 - app.modules.auth.application.services.auth_service - INFO - [AUTH] Usuario regular. Buscando en BD del cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 22:44:23,489 - app.infrastructure.database.connection_async - ERROR - [ASYNC_CONNECTION] Error creando AsyncEngine: quote_from_bytes() expected bytes
Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\connection_async.py", line 199, in _get_async_engine
    conn_str = _build_async_connection_string(connection_type, client_id, connection_metadata)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\connection_async.py", line 141, in _build_async_connection_string
    f"mssql+aioodbc://{quote_plus(usuario)}:"
                       ^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\urllib\parse.py", line 943, in quote_plus
    string = quote(string, safe + space, encoding, errors)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\urllib\parse.py", line 927, in quote
    return quote_from_bytes(string, safe)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\urllib\parse.py", line 957, in quote_from_bytes
    raise TypeError("quote_from_bytes() expected bytes")
TypeError: quote_from_bytes() expected bytes
2025-12-03 22:44:23,491 - app.modules.auth.application.services.auth_service - ERROR - [AUTH] Error en autenticación: username='admin_acme', cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43, error=DatabaseError.__init__() got an unexpected keyword argument 'status_code'
Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\modules\auth\application\services\auth_service.py", line 183, in authenticate_user
    result = await execute_query(
             ^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 126, in execute_query
    async with _get_connection_context(connection_type, client_id) as session:
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\contextlib.py", line 210, in __aenter__
    return await anext(self.gen)
           ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\core\tenant\routing.py", line 817, in get_connection_for_tenant
    async with get_db_connection(
               ^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\contextlib.py", line 210, in __aenter__
    return await anext(self.gen)
           ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\connection_async.py", line 289, in get_db_connection
    raise DatabaseError(
          ^^^^^^^^^^^^^^
TypeError: DatabaseError.__init__() got an unexpected keyword argument 'status_code'
2025-12-03 22:44:23,499 - app.modules.superadmin.application.services.audit_service - INFO - [AUDIT] auth_audit_log registrado: evento=login_failed, cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43, usuario_id=None, exito=False
2025-12-03 22:44:23,500 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/login/ 500 4289.4ms
2025-12-03 22:47:55,256 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Pool ADMIN inicializado. Size=10, MaxOverflow=5
2025-12-03 22:47:55,256 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Configuración de pools de tenants: MaxPools=50, PoolSize=3, MaxOverflow=2, InactivityTimeout=3600s
2025-12-03 22:47:55,256 - app.infrastructure.database.connection_pool - INFO - ✅ Módulo de connection pooling cargado y activo
2025-12-03 22:47:55,258 - app.infrastructure.database.connection_pool - INFO -    Configuración: MaxTenantPools=50, TenantPoolSize=3, InactivityTimeout=3600s
2025-12-03 22:47:55,258 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Todos los pools cerrados
2025-12-03 22:47:55,258 - app.main - INFO - ✅ Pools de conexión cerrados correctamente
2025-12-03 22:47:55,409 - asyncio - ERROR - Unclosed connection
connection: <aioodbc.connection.Connection object at 0x000002B871AA5670>
2025-12-03 22:47:56,856 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 22:47:57,206 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 22:47:57,234 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 22:48:04,474 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 22:48:04,680 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 22:48:04,687 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 22:48:48,235 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 22:48:48,445 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 22:48:48,457 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 22:48:48,465 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 22:48:48,465 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 22:48:48,466 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 22:48:48,466 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 22:48:48,468 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, DEFAULT_TYPE=single
2025-12-03 22:48:48,895 - app.core.security.rate_limiting - INFO - [RATE_LIMITING] Activado. Límites: Login=10/minute, API=200/minute
2025-12-03 22:48:48,895 - app.core.security.rate_limiting - INFO - ✅ Módulo de rate limiting cargado y activo
2025-12-03 22:48:48,991 - app.core.authorization.rbac - INFO - 🔐 Inicializando sistema de autorización...
2025-12-03 22:48:48,992 - app.core.authorization.rbac - INFO - ✅ Sistema de autorización inicializado correctamente
2025-12-03 22:48:48,992 - app.core.authorization.rbac - INFO - 📊 Permisos del sistema: 6 módulos configurados
2025-12-03 22:48:49,211 - app.core.tenant.middleware - INFO - Módulo tenant_middleware cargado (versión híbrida con soporte para proxies)
2025-12-03 22:48:49,211 - app.main - INFO - ✅ Rate limiting configurado y activo
2025-12-03 22:48:49,359 - app.core.tenant.middleware - INFO - [TENANT_MW] Inicializado - BASE_DOMAIN=app.local, SYSTEM_ID=BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, EXCLUDED_SUBDOMAINS={'backend', 'admin', 'api', 'assets', 'cdn', 'www', 'static'}
2025-12-03 22:49:01,741 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Pool ADMIN inicializado. Size=10, MaxOverflow=5
2025-12-03 22:49:01,741 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Configuración de pools de tenants: MaxPools=50, PoolSize=3, MaxOverflow=2, InactivityTimeout=3600s
2025-12-03 22:49:01,742 - app.infrastructure.database.connection_pool - INFO - ✅ Módulo de connection pooling cargado y activo
2025-12-03 22:49:01,742 - app.infrastructure.database.connection_pool - INFO -    Configuración: MaxTenantPools=50, TenantPoolSize=3, InactivityTimeout=3600s
2025-12-03 22:49:01,744 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Todos los pools cerrados
2025-12-03 22:49:01,744 - app.main - INFO - ✅ Pools de conexión cerrados correctamente
2025-12-03 22:49:02,582 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 22:49:02,778 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 22:49:02,784 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 22:49:02,791 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 22:49:02,791 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 22:49:02,791 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 22:49:02,791 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 22:49:02,795 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, DEFAULT_TYPE=single
2025-12-03 22:49:03,124 - app.core.security.rate_limiting - INFO - [RATE_LIMITING] Activado. Límites: Login=10/minute, API=200/minute
2025-12-03 22:49:03,126 - app.core.security.rate_limiting - INFO - ✅ Módulo de rate limiting cargado y activo
2025-12-03 22:49:03,195 - app.core.authorization.rbac - INFO - 🔐 Inicializando sistema de autorización...
2025-12-03 22:49:03,195 - app.core.authorization.rbac - INFO - ✅ Sistema de autorización inicializado correctamente
2025-12-03 22:49:03,195 - app.core.authorization.rbac - INFO - 📊 Permisos del sistema: 6 módulos configurados
2025-12-03 22:49:03,362 - app.core.tenant.middleware - INFO - Módulo tenant_middleware cargado (versión híbrida con soporte para proxies)
2025-12-03 22:49:03,363 - app.main - INFO - ✅ Rate limiting configurado y activo
2025-12-03 22:49:03,501 - app.core.tenant.middleware - INFO - [TENANT_MW] Inicializado - BASE_DOMAIN=app.local, SYSTEM_ID=BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, EXCLUDED_SUBDOMAINS={'www', 'assets', 'backend', 'api', 'cdn', 'admin', 'static'}
2025-12-03 22:49:06,883 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/refresh/
2025-12-03 22:49:06,883 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 22:49:06,885 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': acme.app.local:5173
2025-12-03 22:49:06,885 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 22:49:06,885 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 22:49:06,885 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 22:49:06,885 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] AsyncEngine creado para admin
2025-12-03 22:49:07,043 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 22:49:07,044 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 22:49:07,044 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 22:49:07,049 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 22:49:11,168 - app.infrastructure.cache.redis_cache - WARNING - [REDIS_CACHE] Error conectando a Redis: Error 10061 connecting to localhost:6379. No se puede establecer una conexión ya que el equipo de destino denegó expresamente dicha conexión.. Cache desactivado automáticamente (usando fallback en memoria).
2025-12-03 22:49:11,168 - app.infrastructure.cache.redis_cache - INFO - ℹ️ Módulo de Redis cache cargado pero desactivado (usando fallback en memoria)
2025-12-03 22:49:11,175 - app.core.security.encryption - ERROR - Token de encriptación inválido. Posibles causas: clave incorrecta o datos corruptos
2025-12-03 22:49:11,175 - app.core.tenant.routing - ERROR - [METADATA] Error al desencriptar credenciales para cliente ee7bfc14-995f-4209-b4b9-99c307534a43: Credencial corrupta o clave de encriptación incorrecta
2025-12-03 22:49:11,185 - app.core.security.encryption - ERROR - Token de encriptación inválido. Posibles causas: clave incorrecta o datos corruptos
2025-12-03 22:49:11,185 - app.core.tenant.routing - ERROR - [METADATA] Error al desencriptar credenciales para cliente ee7bfc14-995f-4209-b4b9-99c307534a43: Credencial corrupta o clave de encriptación incorrecta
2025-12-03 22:49:11,185 - app.core.tenant.routing - WARNING - [METADATA] Credenciales vacías o no desencriptables para cliente ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 22:49:11,188 - app.core.tenant.routing - ERROR - [METADATA] Cliente ee7bfc14-995f-4209-b4b9-99c307534a43 es 'dedicated' pero no tiene conexión válida o las credenciales no se pueden desencriptar. Usando Single-DB como fallback seguro. Verificar: 1) Registro en cliente_conexion, 2) Credenciales encriptadas correctamente, 3) ENCRYPTION_KEY correcta.
2025-12-03 22:49:11,190 - app.core.tenant.routing - WARNING - [METADATA] No se encontró metadata para cliente ee7bfc14-995f-4209-b4b9-99c307534a43. Usando SINGLE-DB como fallback. tipo_instalacion=dedicated
2025-12-03 22:49:11,190 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: tipo_instalacion=dedicated, db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 22:49:11,190 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43, tipo_instalacion=dedicated, db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A, path=/api/v1/auth/refresh/
2025-12-03 22:49:11,193 - app.modules.auth.application.services.auth_service - WARNING - [REFRESH] No se proporcionó refresh token. Cliente: web
2025-12-03 22:49:11,194 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/refresh/ 401 4310.3ms
2025-12-03 22:49:51,268 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/login/
2025-12-03 22:49:51,269 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 22:49:51,270 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': acme.app.local:5173
2025-12-03 22:49:51,270 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 22:49:51,270 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 22:49:51,271 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 22:49:51,276 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 22:49:51,277 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 22:49:51,277 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 22:49:51,281 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 22:49:51,282 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: tipo_instalacion=dedicated, db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 22:49:51,283 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43, tipo_instalacion=dedicated, db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A, path=/api/v1/auth/login/
2025-12-03 22:49:51,290 - app.modules.auth.presentation.endpoints - INFO - Cliente ee7bfc14-995f-4209-b4b9-99c307534a43 resuelto y validado para login.
2025-12-03 22:49:51,290 - app.modules.auth.application.services.auth_service - INFO - [AUTH] Intento de login: username='admin_acme', cliente_id_destino=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 22:49:51,291 - app.modules.auth.application.services.auth_service - INFO - [AUTH] Usuario regular. Buscando en BD del cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 22:49:51,291 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] AsyncEngine creado para tenant_ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 22:49:51,306 - app.modules.auth.application.services.auth_service - WARNING - [AUTH] Usuario NO ENCONTRADO: username='admin_acme', cliente_id_buscado=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 22:49:51,316 - app.modules.superadmin.application.services.audit_service - INFO - [AUDIT] auth_audit_log registrado: evento=login_failed, cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43, usuario_id=None, exito=False
2025-12-03 22:49:51,316 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/login/ 401 49.6ms
2025-12-03 22:50:41,161 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Pool ADMIN inicializado. Size=10, MaxOverflow=5
2025-12-03 22:50:41,161 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Configuración de pools de tenants: MaxPools=50, PoolSize=3, MaxOverflow=2, InactivityTimeout=3600s
2025-12-03 22:50:41,161 - app.infrastructure.database.connection_pool - INFO - ✅ Módulo de connection pooling cargado y activo
2025-12-03 22:50:41,161 - app.infrastructure.database.connection_pool - INFO -    Configuración: MaxTenantPools=50, TenantPoolSize=3, InactivityTimeout=3600s
2025-12-03 22:50:41,163 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Todos los pools cerrados
2025-12-03 22:50:41,165 - app.main - INFO - ✅ Pools de conexión cerrados correctamente
2025-12-03 22:50:42,077 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 22:50:42,301 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 22:50:42,307 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 22:50:42,307 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 22:50:42,315 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 22:50:42,315 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 22:50:42,315 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 22:50:42,317 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, DEFAULT_TYPE=single
2025-12-03 22:50:42,762 - app.core.security.rate_limiting - INFO - [RATE_LIMITING] Activado. Límites: Login=10/minute, API=200/minute
2025-12-03 22:50:42,762 - app.core.security.rate_limiting - INFO - ✅ Módulo de rate limiting cargado y activo
2025-12-03 22:50:42,857 - app.core.authorization.rbac - INFO - 🔐 Inicializando sistema de autorización...
2025-12-03 22:50:42,864 - app.core.authorization.rbac - INFO - ✅ Sistema de autorización inicializado correctamente
2025-12-03 22:50:42,864 - app.core.authorization.rbac - INFO - 📊 Permisos del sistema: 6 módulos configurados
2025-12-03 22:50:43,099 - app.core.tenant.middleware - INFO - Módulo tenant_middleware cargado (versión híbrida con soporte para proxies)
2025-12-03 22:50:43,107 - app.main - INFO - ✅ Rate limiting configurado y activo
2025-12-03 22:50:43,271 - app.core.tenant.middleware - INFO - [TENANT_MW] Inicializado - BASE_DOMAIN=app.local, SYSTEM_ID=BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, EXCLUDED_SUBDOMAINS={'www', 'api', 'admin', 'assets', 'static', 'backend', 'cdn'}
2025-12-03 22:51:22,705 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/auth/refresh/
2025-12-03 22:51:22,706 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/auth/refresh/ 200 1.1ms
2025-12-03 22:51:22,709 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/refresh/
2025-12-03 22:51:22,709 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 22:51:22,711 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': acme.app.local:5173
2025-12-03 22:51:22,711 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 22:51:22,712 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 22:51:22,713 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 22:51:22,736 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 22:51:22,736 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 22:51:22,737 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 22:51:22,742 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 22:51:22,743 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: tipo_instalacion=dedicated, db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 22:51:22,743 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43, tipo_instalacion=dedicated, db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A, path=/api/v1/auth/refresh/
2025-12-03 22:51:22,745 - app.modules.auth.application.services.auth_service - WARNING - [REFRESH] No se proporcionó refresh token. Cliente: web
2025-12-03 22:51:22,746 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/refresh/ 401 36.6ms
2025-12-03 22:52:12,408 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/auth/login/
2025-12-03 22:52:12,409 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/auth/login/ 200 0.8ms
2025-12-03 22:52:12,411 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/login/
2025-12-03 22:52:12,411 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 22:52:12,412 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': global.app.local:5173
2025-12-03 22:52:12,412 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'global.app.local'
2025-12-03 22:52:12,413 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 22:52:12,413 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'global'
2025-12-03 22:52:12,429 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'global.app.local'
2025-12-03 22:52:12,429 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 22:52:12,430 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'global'
2025-12-03 22:52:12,434 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='global', Código='GLOBAL004', ID=6c490df5-1395-44b6-8053-6c2b67b8d4c5
2025-12-03 22:52:12,445 - app.core.tenant.routing - WARNING - [METADATA] No se encontró metadata para cliente 6c490df5-1395-44b6-8053-6c2b67b8d4c5. Usando SINGLE-DB como fallback. tipo_instalacion=shared
2025-12-03 22:52:12,445 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: tipo_instalacion=shared, db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 22:52:12,446 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=6c490df5-1395-44b6-8053-6c2b67b8d4c5, tipo_instalacion=shared, db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A, path=/api/v1/auth/login/
2025-12-03 22:52:12,452 - app.modules.auth.presentation.endpoints - INFO - Cliente 6c490df5-1395-44b6-8053-6c2b67b8d4c5 resuelto y validado para login.
2025-12-03 22:52:12,452 - app.modules.auth.application.services.auth_service - INFO - [AUTH] Intento de login: username='admin_global', cliente_id_destino=6c490df5-1395-44b6-8053-6c2b67b8d4c5
2025-12-03 22:52:12,452 - app.modules.auth.application.services.auth_service - INFO - [AUTH] Usuario regular. Buscando en BD del cliente_id=6c490df5-1395-44b6-8053-6c2b67b8d4c5
2025-12-03 22:52:12,455 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] AsyncEngine creado para tenant_6c490df5-1395-44b6-8053-6c2b67b8d4c5
2025-12-03 22:52:12,784 - app.modules.auth.application.services.auth_service - INFO - Niveles calculados - Usuario C1ABF198-6B95-4446-9605-4B81D73E9090: level=4, super_admin=False, type=tenant_admin
2025-12-03 22:52:12,784 - app.modules.auth.application.services.auth_service - INFO - [AUTH] Login exitoso: username='admin_global', usuario_id=C1ABF198-6B95-4446-9605-4B81D73E9090, cliente_origen=6C490DF5-1395-44B6-8053-6C2B67B8D4C5, cliente_destino=N/A, access_level=4, user_type=tenant_admin
2025-12-03 22:52:12,784 - app.infrastructure.database.queries_async - WARNING - [QUERY] DEPRECATED: execute_query() recibió string SQL. Migrar a SQLAlchemy Core.
2025-12-03 22:52:12,822 - app.modules.auth.application.services.auth_service - INFO - Niveles calculados - Usuario C1ABF198-6B95-4446-9605-4B81D73E9090: level=4, super_admin=False, type=tenant_admin
2025-12-03 22:52:12,838 - app.modules.auth.application.services.refresh_token_service - INFO - [STORE-TOKEN] Token insertado exitosamente - Cliente 6c490df5-1395-44b6-8053-6c2b67b8d4c5, Usuario C1ABF198-6B95-4446-9605-4B81D73E9090, Tipo: web, Token ID: E8F86A1E-6D35-471C-86BE-75C38B534D73, Rotación: False
2025-12-03 22:52:12,838 - app.modules.auth.presentation.endpoints - INFO - [LOGIN-WEB] Token almacenado - ID: E8F86A1E-6D35-471C-86BE-75C38B534D73
2025-12-03 22:52:12,838 - app.modules.auth.presentation.endpoints - INFO - Usuario admin_global autenticado exitosamente (WEB) para cliente 6c490df5-1395-44b6-8053-6c2b67b8d4c5
2025-12-03 22:52:12,853 - app.modules.superadmin.application.services.audit_service - INFO - [AUDIT] auth_audit_log registrado: evento=login_success, cliente_id=6c490df5-1395-44b6-8053-6c2b67b8d4c5, usuario_id=C1ABF198-6B95-4446-9605-4B81D73E9090, exito=True
2025-12-03 22:52:12,854 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/login/ 200 443.2ms
2025-12-03 22:52:12,861 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/clientes/tenant/branding
2025-12-03 22:52:12,861 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/clientes/tenant/branding 200 1.1ms
2025-12-03 22:52:12,865 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/clientes/tenant/branding
2025-12-03 22:52:12,866 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 22:52:12,867 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': global.app.local:5173
2025-12-03 22:52:12,868 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'global.app.local'
2025-12-03 22:52:12,869 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 22:52:12,870 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'global'
2025-12-03 22:52:12,874 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/menus/getmenu/
2025-12-03 22:52:12,877 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/menus/getmenu/ 200 2.7ms
2025-12-03 22:52:12,878 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/menus/getmenu/
2025-12-03 22:52:12,879 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/roles/all-active/
2025-12-03 22:52:12,879 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/usuarios/
2025-12-03 22:52:12,880 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/usuarios/
2025-12-03 22:52:12,880 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/roles/all-active/
2025-12-03 22:52:12,882 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/menus/getmenu/ 200 5.4ms
2025-12-03 22:52:12,884 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/roles/all-active/ 200 5.5ms
2025-12-03 22:52:12,885 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/usuarios/ 200 5.6ms
2025-12-03 22:52:12,886 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/usuarios/ 200 5.6ms
2025-12-03 22:52:12,886 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/roles/all-active/ 200 5.7ms
2025-12-03 22:52:12,892 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/menus/getmenu/
2025-12-03 22:52:12,892 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 22:52:12,892 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': global.app.local:5173
2025-12-03 22:52:12,892 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'global.app.local'
2025-12-03 22:52:12,892 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 22:52:12,895 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'global'
2025-12-03 22:52:12,898 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/usuarios/
2025-12-03 22:52:12,899 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/roles/all-active/
2025-12-03 22:52:12,901 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 22:52:12,901 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': global.app.local:5173
2025-12-03 22:52:12,902 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'global.app.local'
2025-12-03 22:52:12,902 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 22:52:12,902 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'global'
2025-12-03 22:52:12,906 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 22:52:12,906 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': global.app.local:5173
2025-12-03 22:52:12,907 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'global.app.local'
2025-12-03 22:52:12,908 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 22:52:12,908 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'global'
2025-12-03 22:52:12,909 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'global.app.local'
2025-12-03 22:52:12,909 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 22:52:12,909 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'global'
2025-12-03 22:52:12,918 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'global.app.local'
2025-12-03 22:52:12,918 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 22:52:12,918 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'global'
2025-12-03 22:52:12,923 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'global.app.local'
2025-12-03 22:52:12,923 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 22:52:12,924 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'global'
2025-12-03 22:52:12,925 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'global.app.local'
2025-12-03 22:52:12,928 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 22:52:12,928 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'global'
2025-12-03 22:52:12,928 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='global', Código='GLOBAL004', ID=6c490df5-1395-44b6-8053-6c2b67b8d4c5
2025-12-03 22:52:12,931 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: tipo_instalacion=shared, db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 22:52:12,931 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=6c490df5-1395-44b6-8053-6c2b67b8d4c5, tipo_instalacion=shared, db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A, path=/api/v1/clientes/tenant/branding
2025-12-03 22:52:12,938 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='global', Código='GLOBAL004', ID=6c490df5-1395-44b6-8053-6c2b67b8d4c5
2025-12-03 22:52:12,939 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: tipo_instalacion=shared, db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 22:52:12,939 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=6c490df5-1395-44b6-8053-6c2b67b8d4c5, tipo_instalacion=shared, db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A, path=/api/v1/usuarios/
2025-12-03 22:52:12,944 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='global', Código='GLOBAL004', ID=6c490df5-1395-44b6-8053-6c2b67b8d4c5
2025-12-03 22:52:12,945 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: tipo_instalacion=shared, db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 22:52:12,946 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=6c490df5-1395-44b6-8053-6c2b67b8d4c5, tipo_instalacion=shared, db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A, path=/api/v1/menus/getmenu/
2025-12-03 22:52:12,947 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='global', Código='GLOBAL004', ID=6c490df5-1395-44b6-8053-6c2b67b8d4c5
2025-12-03 22:52:12,947 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: tipo_instalacion=shared, db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 22:52:12,948 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=6c490df5-1395-44b6-8053-6c2b67b8d4c5, tipo_instalacion=shared, db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A, path=/api/v1/roles/all-active/
2025-12-03 22:52:12,995 - app.modules.tenant.presentation.endpoints_clientes - INFO - Solicitud GET /tenant/branding recibida para cliente_id=6c490df5-1395-44b6-8053-6c2b67b8d4c5 por usuario: admin_global
2025-12-03 22:52:12,995 - app.modules.tenant.application.services.cliente_service - INFO - Solicitando branding para cliente_id=6c490df5-1395-44b6-8053-6c2b67b8d4c5
2025-12-03 22:52:13,004 - app.modules.menus.presentation.endpoints - INFO - Solicitud GET /menus/getmenu/ recibida para usuario ID: c1abf198-6b95-4446-9605-4b81d73e9090 del cliente 6c490df5-1395-44b6-8053-6c2b67b8d4c5
2025-12-03 22:52:13,005 - app.modules.menus.application.services.menu_service - INFO - Obteniendo menú filtrado para usuario_id: c1abf198-6b95-4446-9605-4b81d73e9090
2025-12-03 22:52:13,006 - app.infrastructure.database.queries_async - WARNING - [QUERY] DEPRECATED: execute_query() recibió string SQL. Migrar a SQLAlchemy Core.
2025-12-03 22:52:13,009 - app.modules.tenant.application.services.cliente_service - INFO - Branding obtenido exitosamente para cliente_id=6c490df5-1395-44b6-8053-6c2b67b8d4c5
2025-12-03 22:52:13,009 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/clientes/tenant/branding 200 144.8ms
2025-12-03 22:52:13,014 - app.infrastructure.database.queries_async - WARNING - [QUERY] DEPRECATED: execute_query() recibió string SQL. Migrar a SQLAlchemy Core.
2025-12-03 22:52:13,016 - app.modules.users.presentation.endpoints - INFO - Solicitud GET /usuarios/ recibida por usuario c1abf198-6b95-4446-9605-4b81d73e9090 del cliente 6c490df5-1395-44b6-8053-6c2b67b8d4c5 - Paginación: page=1, limit=10, Búsqueda: 'None'
2025-12-03 22:52:13,016 - app.modules.users.application.services.user_service - INFO - Obteniendo usuarios paginados para cliente 6c490df5-1395-44b6-8053-6c2b67b8d4c5: page=1, limit=10, search='None'
2025-12-03 22:52:13,018 - app.infrastructure.database.queries_async - WARNING - [QUERY] DEPRECATED: execute_query() recibió string SQL. Migrar a SQLAlchemy Core.
2025-12-03 22:52:13,021 - app.modules.menus.application.services.menu_helper - INFO - Árbol de menú construido con 5 items raíz.
2025-12-03 22:52:13,022 - app.modules.menus.application.services.menu_service - INFO - Árbol de menú construido para usuario c1abf198-6b95-4446-9605-4b81d73e9090 con 5 items raíz.
2025-12-03 22:52:13,024 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/menus/getmenu/ 200 132.1ms
2025-12-03 22:52:13,027 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/menus/getmenu/
2025-12-03 22:52:13,028 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 22:52:13,028 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': global.app.local:5173
2025-12-03 22:52:13,028 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'global.app.local'
2025-12-03 22:52:13,028 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 22:52:13,028 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'global'
2025-12-03 22:52:13,033 - app.modules.rbac.presentation.endpoints - INFO - Solicitud GET /roles/all-active/ recibida por usuario c1abf198-6b95-4446-9605-4b81d73e9090 del cliente 6c490df5-1395-44b6-8053-6c2b67b8d4c5 para lista simple
2025-12-03 22:52:13,034 - app.modules.rbac.application.services.rol_service - ERROR - Error inesperado en get_all_active_roles: 'coroutine' object is not iterable
Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\modules\rbac\application\services\rol_service.py", line 799, in get_all_active_roles
    for rol_dict in resultados:
                    ^^^^^^^^^^
TypeError: 'coroutine' object is not iterable
2025-12-03 22:52:13,052 - app.modules.rbac.presentation.endpoints - ERROR - Error de servicio en endpoint /roles/all-active/ para cliente 6c490df5-1395-44b6-8053-6c2b67b8d4c5: Error interno al obtener roles activos
2025-12-03 22:52:13,061 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/roles/all-active/ 500 165.8ms
2025-12-03 22:52:13,068 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/roles/all-active/
2025-12-03 22:52:13,069 - app.infrastructure.database.queries_async - WARNING - [QUERY] DEPRECATED: execute_query() recibió string SQL. Migrar a SQLAlchemy Core.
2025-12-03 22:52:13,071 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 22:52:13,072 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': global.app.local:5173
2025-12-03 22:52:13,072 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'global.app.local'
2025-12-03 22:52:13,073 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 22:52:13,073 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'global'
2025-12-03 22:52:13,078 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'global.app.local'
2025-12-03 22:52:13,078 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 22:52:13,078 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'global'
2025-12-03 22:52:13,083 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'global.app.local'
2025-12-03 22:52:13,084 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 22:52:13,084 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'global'
2025-12-03 22:52:13,089 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='global', Código='GLOBAL004', ID=6c490df5-1395-44b6-8053-6c2b67b8d4c5
2025-12-03 22:52:13,090 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: tipo_instalacion=shared, db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 22:52:13,090 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=6c490df5-1395-44b6-8053-6c2b67b8d4c5, tipo_instalacion=shared, db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A, path=/api/v1/menus/getmenu/
2025-12-03 22:52:13,094 - app.modules.users.application.services.user_service - INFO - [USUARIOS-PAGINADOS] Procesados 2 usuarios únicos de 2 filas crudas
2025-12-03 22:52:13,095 - app.modules.users.application.services.user_service - INFO - Obtención paginada de usuarios completada exitosamente
2025-12-03 22:52:13,095 - app.modules.users.presentation.endpoints - INFO - Lista paginada de usuarios recuperada para cliente 6c490df5-1395-44b6-8053-6c2b67b8d4c5 - Total: 2, Página: 1
2025-12-03 22:52:13,097 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/usuarios/ 200 198.3ms
2025-12-03 22:52:13,098 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='global', Código='GLOBAL004', ID=6c490df5-1395-44b6-8053-6c2b67b8d4c5
2025-12-03 22:52:13,098 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: tipo_instalacion=shared, db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 22:52:13,099 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=6c490df5-1395-44b6-8053-6c2b67b8d4c5, tipo_instalacion=shared, db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A, path=/api/v1/roles/all-active/
2025-12-03 22:52:13,102 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/usuarios/
2025-12-03 22:52:13,104 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 22:52:13,105 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': global.app.local:5173
2025-12-03 22:52:13,105 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'global.app.local'
2025-12-03 22:52:13,106 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 22:52:13,106 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'global'
2025-12-03 22:52:13,110 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'global.app.local'
2025-12-03 22:52:13,110 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 22:52:13,110 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'global'
2025-12-03 22:52:13,125 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='global', Código='GLOBAL004', ID=6c490df5-1395-44b6-8053-6c2b67b8d4c5
2025-12-03 22:52:13,125 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: tipo_instalacion=shared, db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 22:52:13,125 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=6c490df5-1395-44b6-8053-6c2b67b8d4c5, tipo_instalacion=shared, db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A, path=/api/v1/usuarios/
2025-12-03 22:52:13,148 - app.modules.menus.presentation.endpoints - INFO - Solicitud GET /menus/getmenu/ recibida para usuario ID: c1abf198-6b95-4446-9605-4b81d73e9090 del cliente 6c490df5-1395-44b6-8053-6c2b67b8d4c5
2025-12-03 22:52:13,151 - app.modules.menus.application.services.menu_service - INFO - Obteniendo menú filtrado para usuario_id: c1abf198-6b95-4446-9605-4b81d73e9090
2025-12-03 22:52:13,154 - app.infrastructure.database.queries_async - WARNING - [QUERY] DEPRECATED: execute_query() recibió string SQL. Migrar a SQLAlchemy Core.
2025-12-03 22:52:13,160 - app.modules.menus.application.services.menu_helper - INFO - Árbol de menú construido con 5 items raíz.
2025-12-03 22:52:13,160 - app.modules.menus.application.services.menu_service - INFO - Árbol de menú construido para usuario c1abf198-6b95-4446-9605-4b81d73e9090 con 5 items raíz.
2025-12-03 22:52:13,163 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/menus/getmenu/ 200 135.9ms
2025-12-03 22:52:13,168 - app.modules.rbac.presentation.endpoints - INFO - Solicitud GET /roles/all-active/ recibida por usuario c1abf198-6b95-4446-9605-4b81d73e9090 del cliente 6c490df5-1395-44b6-8053-6c2b67b8d4c5 para lista simple
2025-12-03 22:52:13,169 - app.modules.rbac.application.services.rol_service - ERROR - Error inesperado en get_all_active_roles: 'coroutine' object is not iterable
Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\modules\rbac\application\services\rol_service.py", line 799, in get_all_active_roles
    for rol_dict in resultados:
                    ^^^^^^^^^^
TypeError: 'coroutine' object is not iterable
2025-12-03 22:52:13,170 - app.modules.rbac.presentation.endpoints - ERROR - Error de servicio en endpoint /roles/all-active/ para cliente 6c490df5-1395-44b6-8053-6c2b67b8d4c5: Error interno al obtener roles activos
2025-12-03 22:52:13,172 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/roles/all-active/ 500 103.8ms
2025-12-03 22:52:13,178 - app.infrastructure.database.queries_async - WARNING - [QUERY] DEPRECATED: execute_query() recibió string SQL. Migrar a SQLAlchemy Core.
2025-12-03 22:52:13,188 - app.modules.users.presentation.endpoints - INFO - Solicitud GET /usuarios/ recibida por usuario c1abf198-6b95-4446-9605-4b81d73e9090 del cliente 6c490df5-1395-44b6-8053-6c2b67b8d4c5 - Paginación: page=1, limit=10, Búsqueda: 'None'
2025-12-03 22:52:13,188 - app.modules.users.application.services.user_service - INFO - Obteniendo usuarios paginados para cliente 6c490df5-1395-44b6-8053-6c2b67b8d4c5: page=1, limit=10, search='None'
2025-12-03 22:52:13,188 - app.infrastructure.database.queries_async - WARNING - [QUERY] DEPRECATED: execute_query() recibió string SQL. Migrar a SQLAlchemy Core.
2025-12-03 22:52:13,198 - app.infrastructure.database.queries_async - WARNING - [QUERY] DEPRECATED: execute_query() recibió string SQL. Migrar a SQLAlchemy Core.
2025-12-03 22:52:13,208 - app.modules.users.application.services.user_service - INFO - [USUARIOS-PAGINADOS] Procesados 2 usuarios únicos de 2 filas crudas
2025-12-03 22:52:13,208 - app.modules.users.application.services.user_service - INFO - Obtención paginada de usuarios completada exitosamente
2025-12-03 22:52:13,208 - app.modules.users.presentation.endpoints - INFO - Lista paginada de usuarios recuperada para cliente 6c490df5-1395-44b6-8053-6c2b67b8d4c5 - Total: 2, Página: 1
2025-12-03 22:52:13,212 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/usuarios/ 200 110.6ms
2025-12-03 22:53:06,458 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/roles/
2025-12-03 22:53:06,459 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/roles/ 200 1.1ms
2025-12-03 22:53:06,462 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/roles/
2025-12-03 22:53:06,463 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 22:53:06,465 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': global.app.local:5173
2025-12-03 22:53:06,465 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'global.app.local'
2025-12-03 22:53:06,466 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 22:53:06,466 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'global'
2025-12-03 22:53:06,475 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'global.app.local'
2025-12-03 22:53:06,475 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 22:53:06,476 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'global'
2025-12-03 22:53:06,481 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='global', Código='GLOBAL004', ID=6c490df5-1395-44b6-8053-6c2b67b8d4c5
2025-12-03 22:53:06,482 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: tipo_instalacion=shared, db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 22:53:06,482 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=6c490df5-1395-44b6-8053-6c2b67b8d4c5, tipo_instalacion=shared, db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A, path=/api/v1/roles/
2025-12-03 22:53:06,517 - app.infrastructure.database.queries_async - WARNING - [QUERY] DEPRECATED: execute_query() recibió string SQL. Migrar a SQLAlchemy Core.
2025-12-03 22:53:06,527 - app.modules.rbac.presentation.endpoints - INFO - Solicitud GET /roles/ recibida por usuario c1abf198-6b95-4446-9605-4b81d73e9090 del cliente 6c490df5-1395-44b6-8053-6c2b67b8d4c5 - Paginación: page=1, limit=10, Búsqueda: 'None'
2025-12-03 22:53:06,527 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/roles/ N/A 65.8ms
2025-12-03 22:53:06,529 - app.core.exceptions - ERROR - Error no manejado: '<=' not supported between instances of 'UUID' and 'int'
  + Exception Group Traceback (most recent call last):
  |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 76, in collapse_excgroups
  |     yield
  |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 186, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\anyio\_backends\_asyncio.py", line 815, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\errors.py", line 165, in __call__
    |     await self.app(scope, receive, _send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    |     with collapse_excgroups():
    |          ^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\app\main.py", line 223, in security_headers
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    |     raise app_exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    |     with collapse_excgroups():
    |          ^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\app\main.py", line 214, in log_requests
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    |     raise app_exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    |     with collapse_excgroups():
    |          ^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\app\main.py", line 191, in cors_middleware
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    |     raise app_exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    |     with collapse_excgroups():
    |          ^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\app\core\tenant\middleware.py", line 422, in dispatch
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    |     raise app_exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\exceptions.py", line 62, in __call__
    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 715, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 735, in app
    |     await route.handle(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 288, in handle
    |     await self.app(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 76, in app
    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 73, in app
    |     response = await f(request)
    |                ^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\fastapi\routing.py", line 301, in app
    |     raw_response = await run_endpoint_function(
    |                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\fastapi\routing.py", line 212, in run_endpoint_function
    |     return await dependant.call(**values)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\app\modules\rbac\presentation\endpoints.py", line 179, in read_roles_paginated
    |     if not current_user.cliente_id or current_user.cliente_id <= 0:
    |                                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    | TypeError: '<=' not supported between instances of 'UUID' and 'int'
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\errors.py", line 165, in __call__
    await self.app(scope, receive, _send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    with collapse_excgroups():
         ^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\main.py", line 223, in security_headers
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    raise app_exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    with collapse_excgroups():
         ^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\main.py", line 214, in log_requests
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    raise app_exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    with collapse_excgroups():
         ^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\main.py", line 191, in cors_middleware
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    raise app_exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    with collapse_excgroups():
         ^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\core\tenant\middleware.py", line 422, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    raise app_exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 715, in __call__
    await self.middleware_stack(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 735, in app
    await route.handle(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 288, in handle
    await self.app(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 76, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 73, in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\fastapi\routing.py", line 301, in app
    raw_response = await run_endpoint_function(
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\fastapi\routing.py", line 212, in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\modules\rbac\presentation\endpoints.py", line 179, in read_roles_paginated
    if not current_user.cliente_id or current_user.cliente_id <= 0:
                                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
TypeError: '<=' not supported between instances of 'UUID' and 'int'
2025-12-03 22:53:06,674 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/roles/
2025-12-03 22:53:06,676 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 22:53:06,676 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': global.app.local:5173
2025-12-03 22:53:06,677 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'global.app.local'
2025-12-03 22:53:06,677 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 22:53:06,678 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'global'
2025-12-03 22:53:06,683 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'global.app.local'
2025-12-03 22:53:06,683 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 22:53:06,684 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'global'
2025-12-03 22:53:06,688 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='global', Código='GLOBAL004', ID=6c490df5-1395-44b6-8053-6c2b67b8d4c5
2025-12-03 22:53:06,689 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: tipo_instalacion=shared, db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 22:53:06,689 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=6c490df5-1395-44b6-8053-6c2b67b8d4c5, tipo_instalacion=shared, db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A, path=/api/v1/roles/
2025-12-03 22:53:06,709 - app.infrastructure.database.queries_async - WARNING - [QUERY] DEPRECATED: execute_query() recibió string SQL. Migrar a SQLAlchemy Core.
2025-12-03 22:53:06,713 - app.modules.rbac.presentation.endpoints - INFO - Solicitud GET /roles/ recibida por usuario c1abf198-6b95-4446-9605-4b81d73e9090 del cliente 6c490df5-1395-44b6-8053-6c2b67b8d4c5 - Paginación: page=1, limit=10, Búsqueda: 'None'
2025-12-03 22:53:06,713 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/roles/ N/A 40.2ms
2025-12-03 22:53:06,715 - app.core.exceptions - ERROR - Error no manejado: '<=' not supported between instances of 'UUID' and 'int'
  + Exception Group Traceback (most recent call last):
  |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 76, in collapse_excgroups
  |     yield
  |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 186, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\anyio\_backends\_asyncio.py", line 815, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\errors.py", line 165, in __call__
    |     await self.app(scope, receive, _send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    |     with collapse_excgroups():
    |          ^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\app\main.py", line 223, in security_headers
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    |     raise app_exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    |     with collapse_excgroups():
    |          ^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\app\main.py", line 214, in log_requests
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    |     raise app_exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    |     with collapse_excgroups():
    |          ^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\app\main.py", line 191, in cors_middleware
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    |     raise app_exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    |     with collapse_excgroups():
    |          ^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\app\core\tenant\middleware.py", line 422, in dispatch
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    |     raise app_exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\exceptions.py", line 62, in __call__
    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 715, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 735, in app
    |     await route.handle(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 288, in handle
    |     await self.app(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 76, in app
    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 73, in app
    |     response = await f(request)
    |                ^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\fastapi\routing.py", line 301, in app
    |     raw_response = await run_endpoint_function(
    |                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\fastapi\routing.py", line 212, in run_endpoint_function
    |     return await dependant.call(**values)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\base_multi_tenant_fastapi\app\modules\rbac\presentation\endpoints.py", line 179, in read_roles_paginated
    |     if not current_user.cliente_id or current_user.cliente_id <= 0:
    |                                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    | TypeError: '<=' not supported between instances of 'UUID' and 'int'
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\errors.py", line 165, in __call__
    await self.app(scope, receive, _send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    with collapse_excgroups():
         ^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\main.py", line 223, in security_headers
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    raise app_exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    with collapse_excgroups():
         ^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\main.py", line 214, in log_requests
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    raise app_exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    with collapse_excgroups():
         ^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\main.py", line 191, in cors_middleware
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    raise app_exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 185, in __call__
    with collapse_excgroups():
         ^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 187, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\core\tenant\middleware.py", line 422, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 163, in call_next
    raise app_exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\base.py", line 149, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\middleware\exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 715, in __call__
    await self.middleware_stack(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 735, in app
    await route.handle(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 288, in handle
    await self.app(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 76, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\starlette\routing.py", line 73, in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\fastapi\routing.py", line 301, in app
    raw_response = await run_endpoint_function(
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\fastapi\routing.py", line 212, in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\modules\rbac\presentation\endpoints.py", line 179, in read_roles_paginated
    if not current_user.cliente_id or current_user.cliente_id <= 0:
                                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
TypeError: '<=' not supported between instances of 'UUID' and 'int'
2025-12-03 22:53:10,026 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/auth/logout/
2025-12-03 22:53:10,027 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/auth/logout/ 200 0.9ms
2025-12-03 22:53:10,029 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/logout/
2025-12-03 22:53:10,030 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 22:53:10,031 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': global.app.local:5173
2025-12-03 22:53:10,031 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'global.app.local'
2025-12-03 22:53:10,031 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 22:53:10,032 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'global'
2025-12-03 22:53:10,036 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'global.app.local'
2025-12-03 22:53:10,037 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 22:53:10,037 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'global'
2025-12-03 22:53:10,042 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='global', Código='GLOBAL004', ID=6c490df5-1395-44b6-8053-6c2b67b8d4c5
2025-12-03 22:53:10,042 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: tipo_instalacion=shared, db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 22:53:10,043 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=6c490df5-1395-44b6-8053-6c2b67b8d4c5, tipo_instalacion=shared, db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A, path=/api/v1/auth/logout/
2025-12-03 22:53:10,052 - app.modules.auth.application.services.refresh_token_service - WARNING - [REVOKE-TOKEN] Token no encontrado o ya revocado - Cliente 6C490DF5-1395-44B6-8053-6C2B67B8D4C5, Usuario C1ABF198-6B95-4446-9605-4B81D73E9090
2025-12-03 22:53:10,052 - app.modules.auth.presentation.endpoints - INFO - [LOGOUT-WEB] Token no encontrado en BD (ya expirado/revocado) - Cliente: 6C490DF5-1395-44B6-8053-6C2B67B8D4C5, Usuario: C1ABF198-6B95-4446-9605-4B81D73E9090 (admin_global)
2025-12-03 22:53:10,062 - app.modules.superadmin.application.services.audit_service - INFO - [AUDIT] auth_audit_log registrado: evento=logout, cliente_id=6C490DF5-1395-44B6-8053-6C2B67B8D4C5, usuario_id=C1ABF198-6B95-4446-9605-4B81D73E9090, exito=True
2025-12-03 22:53:10,063 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/logout/ 200 34.8ms
2025-12-03 22:53:14,235 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/auth/logout/
2025-12-03 22:53:14,236 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/auth/logout/ 200 0.9ms
2025-12-03 22:53:14,237 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/logout/
2025-12-03 22:53:14,239 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 22:53:14,240 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 22:53:14,240 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 22:53:14,240 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 22:53:14,241 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 22:53:14,241 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 22:53:14,241 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 22:53:14,242 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 22:53:14,242 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 22:53:14,243 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: tipo_instalacion=cloud, db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 22:53:14,243 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, tipo_instalacion=cloud, db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A, path=/api/v1/auth/logout/
2025-12-03 22:53:14,244 - app.modules.auth.application.services.auth_service - ERROR - Error decodificando token: Signature has expired.
2025-12-03 22:53:14,245 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/logout/ 401 6.5ms
2025-12-03 22:53:14,248 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/auth/refresh/
2025-12-03 22:53:14,249 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/auth/refresh/ 200 0.9ms
2025-12-03 22:53:14,250 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/refresh/
2025-12-03 22:53:14,251 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 22:53:14,252 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 22:53:14,252 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 22:53:14,252 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 22:53:14,253 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 22:53:14,253 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 22:53:14,254 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 22:53:14,254 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 22:53:14,254 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 22:53:14,255 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: tipo_instalacion=cloud, db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 22:53:14,255 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, tipo_instalacion=cloud, db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A, path=/api/v1/auth/refresh/
2025-12-03 22:53:14,257 - app.modules.auth.application.services.auth_service - WARNING - [REFRESH] No se proporcionó refresh token. Cliente: web
2025-12-03 22:53:14,257 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/refresh/ 401 7.1ms
2025-12-03 22:53:23,183 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/auth/login/
2025-12-03 22:53:23,185 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/auth/login/ 200 0.8ms
2025-12-03 22:53:23,187 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/login/
2025-12-03 22:53:23,187 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 22:53:23,188 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 22:53:23,188 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 22:53:23,189 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 22:53:23,189 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 22:53:23,190 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 22:53:23,190 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 22:53:23,192 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 22:53:23,192 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 22:53:23,192 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: tipo_instalacion=cloud, db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 22:53:23,193 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, tipo_instalacion=cloud, db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A, path=/api/v1/auth/login/
2025-12-03 22:53:23,199 - app.modules.auth.presentation.endpoints - INFO - Cliente bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7 resuelto y validado para login.
2025-12-03 22:53:23,199 - app.modules.auth.application.services.auth_service - INFO - [AUTH] Intento de login: username='superadmin', cliente_id_destino=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 22:53:23,199 - app.modules.auth.application.services.auth_service - INFO - [AUTH] SUPERADMIN detectado. Buscando en BD ADMIN (cliente_id=BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7), accediendo a cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 22:53:23,423 - app.modules.auth.application.services.auth_service - INFO - Niveles calculados - Usuario 154134AD-A5EB-4F45-AEF0-5F9AAA282C8E: level=5, super_admin=True, type=super_admin
2025-12-03 22:53:23,423 - app.modules.auth.application.services.auth_service - INFO - [AUTH] Login exitoso: username='superadmin', usuario_id=154134AD-A5EB-4F45-AEF0-5F9AAA282C8E, cliente_origen=BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, cliente_destino=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, access_level=5, user_type=super_admin
2025-12-03 22:53:23,423 - app.modules.auth.presentation.endpoints - INFO - [LOGIN] Superadmin accediendo a cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 22:53:23,429 - app.modules.auth.application.services.auth_service - INFO - Niveles calculados - Usuario 154134AD-A5EB-4F45-AEF0-5F9AAA282C8E: level=5, super_admin=True, type=super_admin
2025-12-03 22:53:23,441 - app.modules.auth.application.services.refresh_token_service - INFO - [STORE-TOKEN] Token insertado exitosamente - Cliente bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, Usuario 154134AD-A5EB-4F45-AEF0-5F9AAA282C8E, Tipo: web, Token ID: 25E9EB1C-CE8E-43C5-9D64-B995FB3980D5, Rotación: False
2025-12-03 22:53:23,441 - app.modules.auth.presentation.endpoints - INFO - [LOGIN-WEB] Token almacenado - ID: 25E9EB1C-CE8E-43C5-9D64-B995FB3980D5
2025-12-03 22:53:23,441 - app.modules.auth.presentation.endpoints - INFO - Usuario superadmin autenticado exitosamente (WEB) para cliente bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 22:53:23,449 - app.modules.superadmin.application.services.audit_service - INFO - [AUDIT] auth_audit_log registrado: evento=login_success, cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, usuario_id=154134AD-A5EB-4F45-AEF0-5F9AAA282C8E, exito=True
2025-12-03 22:53:23,449 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/login/ 200 264.1ms
2025-12-03 22:53:23,460 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/clientes/tenant/branding
2025-12-03 22:53:23,460 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/clientes/tenant/branding 200 1.0ms
2025-12-03 22:53:23,463 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/clientes/tenant/branding
2025-12-03 22:53:23,464 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 22:53:23,464 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 22:53:23,465 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 22:53:23,465 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 22:53:23,466 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 22:53:23,466 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 22:53:23,467 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 22:53:23,467 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 22:53:23,469 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 22:53:23,469 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: tipo_instalacion=cloud, db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 22:53:23,470 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, tipo_instalacion=cloud, db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A, path=/api/v1/clientes/tenant/branding
2025-12-03 22:53:23,473 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/menus/getmenu/
2025-12-03 22:53:23,474 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/menus/getmenu/ 200 2.1ms
2025-12-03 22:53:23,477 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/menus/getmenu/
2025-12-03 22:53:23,479 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/menus/getmenu/ 200 2.7ms
2025-12-03 22:53:23,482 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/menus/getmenu/
2025-12-03 22:53:23,482 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 22:53:23,482 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 22:53:23,482 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 22:53:23,482 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 22:53:23,482 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 22:53:23,482 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 22:53:23,482 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 22:53:23,482 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 22:53:23,487 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 22:53:23,487 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: tipo_instalacion=cloud, db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 22:53:23,488 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, tipo_instalacion=cloud, db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A, path=/api/v1/menus/getmenu/
2025-12-03 22:53:23,515 - app.modules.tenant.presentation.endpoints_clientes - INFO - Solicitud GET /tenant/branding recibida para cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7 por usuario: superadmin
2025-12-03 22:53:23,515 - app.modules.tenant.application.services.cliente_service - INFO - Solicitando branding para cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 22:53:23,519 - app.modules.menus.presentation.endpoints - INFO - Solicitud GET /menus/getmenu/ recibida para usuario ID: 154134ad-a5eb-4f45-aef0-5f9aaa282c8e del cliente bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 22:53:23,519 - app.modules.menus.application.services.menu_service - INFO - Obteniendo menú filtrado para usuario_id: 154134ad-a5eb-4f45-aef0-5f9aaa282c8e
2025-12-03 22:53:23,525 - app.modules.tenant.application.services.cliente_service - INFO - Branding obtenido exitosamente para cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 22:53:23,526 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/clientes/tenant/branding 200 62.9ms
2025-12-03 22:53:23,528 - app.modules.menus.application.services.menu_service - INFO - No se encontraron menús permitidos para el usuario ID: 154134ad-a5eb-4f45-aef0-5f9aaa282c8e.
2025-12-03 22:53:23,529 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/menus/getmenu/ 200 47.3ms
2025-12-03 22:53:23,531 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/menus/getmenu/
2025-12-03 22:53:23,531 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 22:53:23,531 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 22:53:23,533 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 22:53:23,533 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 22:53:23,534 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 22:53:23,534 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 22:53:23,535 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 22:53:23,535 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 22:53:23,535 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 22:53:23,536 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: tipo_instalacion=cloud, db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 22:53:23,536 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, tipo_instalacion=cloud, db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A, path=/api/v1/menus/getmenu/
2025-12-03 22:53:23,554 - app.modules.menus.presentation.endpoints - INFO - Solicitud GET /menus/getmenu/ recibida para usuario ID: 154134ad-a5eb-4f45-aef0-5f9aaa282c8e del cliente bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 22:53:23,555 - app.modules.menus.application.services.menu_service - INFO - Obteniendo menú filtrado para usuario_id: 154134ad-a5eb-4f45-aef0-5f9aaa282c8e
2025-12-03 22:53:23,559 - app.modules.menus.application.services.menu_service - INFO - No se encontraron menús permitidos para el usuario ID: 154134ad-a5eb-4f45-aef0-5f9aaa282c8e.
2025-12-03 22:53:23,560 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/menus/getmenu/ 200 29.3ms
2025-12-03 22:53:25,667 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/clientes/
2025-12-03 22:53:25,668 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/clientes/ 200 1.4ms
2025-12-03 22:53:25,669 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/clientes/
2025-12-03 22:53:25,671 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/clientes/ 200 1.5ms
2025-12-03 22:53:25,673 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/clientes/
2025-12-03 22:53:25,674 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 22:53:25,674 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 22:53:25,675 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 22:53:25,676 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 22:53:25,676 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 22:53:25,677 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 22:53:25,678 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 22:53:25,678 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 22:53:25,679 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 22:53:25,679 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: tipo_instalacion=cloud, db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 22:53:25,679 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, tipo_instalacion=cloud, db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A, path=/api/v1/clientes/
2025-12-03 22:53:25,701 - app.modules.tenant.presentation.endpoints_clientes - INFO - Solicitud GET /clientes/ recibida - skip: 0, limit: 10, solo_activos: True, buscar: None por usuario: superadmin
2025-12-03 22:53:25,703 - app.modules.tenant.application.services.cliente_service - INFO - Listando clientes - skip: 0, limit: 10, solo_activos: True, buscar: None
2025-12-03 22:53:25,715 - app.modules.tenant.application.services.cliente_service - INFO - Listados 5 clientes de 5 totales
2025-12-03 22:53:25,716 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/clientes/ 200 43.0ms
2025-12-03 22:53:25,718 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/clientes/
2025-12-03 22:53:25,718 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 22:53:25,719 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 22:53:25,719 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 22:53:25,721 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 22:53:25,721 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 22:53:25,722 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 22:53:25,722 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 22:53:25,723 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 22:53:25,723 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 22:53:25,723 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: tipo_instalacion=cloud, db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 22:53:25,724 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, tipo_instalacion=cloud, db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A, path=/api/v1/clientes/
2025-12-03 22:53:25,747 - app.modules.tenant.presentation.endpoints_clientes - INFO - Solicitud GET /clientes/ recibida - skip: 0, limit: 10, solo_activos: True, buscar: None por usuario: superadmin
2025-12-03 22:53:25,747 - app.modules.tenant.application.services.cliente_service - INFO - Listando clientes - skip: 0, limit: 10, solo_activos: True, buscar: None
2025-12-03 22:53:25,754 - app.modules.tenant.application.services.cliente_service - INFO - Listados 5 clientes de 5 totales
2025-12-03 22:53:25,755 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/clientes/ 200 37.6ms
2025-12-03 22:53:28,357 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/clientes/
2025-12-03 22:53:28,358 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 22:53:28,359 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 22:53:28,359 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 22:53:28,360 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 22:53:28,360 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 22:53:28,361 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 22:53:28,361 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 22:53:28,362 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 22:53:28,362 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 22:53:28,363 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: tipo_instalacion=cloud, db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 22:53:28,363 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, tipo_instalacion=cloud, db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A, path=/api/v1/clientes/
2025-12-03 22:53:28,383 - app.modules.tenant.presentation.endpoints_clientes - INFO - Solicitud GET /clientes/ recibida - skip: 0, limit: 10, solo_activos: True, buscar: None por usuario: superadmin
2025-12-03 22:53:28,383 - app.modules.tenant.application.services.cliente_service - INFO - Listando clientes - skip: 0, limit: 10, solo_activos: True, buscar: None
2025-12-03 22:53:28,387 - app.modules.tenant.application.services.cliente_service - INFO - Listados 5 clientes de 5 totales
2025-12-03 22:53:28,390 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/clientes/ 200 31.9ms
2025-12-03 22:53:28,390 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/clientes/
2025-12-03 22:53:28,392 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 22:53:28,392 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 22:53:28,393 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 22:53:28,393 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 22:53:28,394 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 22:53:28,394 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 22:53:28,395 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 22:53:28,395 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 22:53:28,396 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 22:53:28,396 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: tipo_instalacion=cloud, db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 22:53:28,396 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, tipo_instalacion=cloud, db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A, path=/api/v1/clientes/
2025-12-03 22:53:28,410 - app.modules.tenant.presentation.endpoints_clientes - INFO - Solicitud GET /clientes/ recibida - skip: 0, limit: 10, solo_activos: True, buscar: None por usuario: superadmin
2025-12-03 22:53:28,410 - app.modules.tenant.application.services.cliente_service - INFO - Listando clientes - skip: 0, limit: 10, solo_activos: True, buscar: None
2025-12-03 22:53:28,418 - app.modules.tenant.application.services.cliente_service - INFO - Listados 5 clientes de 5 totales
2025-12-03 22:53:28,419 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/clientes/ 200 27.6ms
2025-12-03 22:53:37,837 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/logout/
2025-12-03 22:53:37,838 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 22:53:37,838 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 22:53:37,838 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 22:53:37,839 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 22:53:37,839 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 22:53:37,840 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 22:53:37,840 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 22:53:37,841 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 22:53:37,841 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 22:53:37,841 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: tipo_instalacion=cloud, db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 22:53:37,842 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, tipo_instalacion=cloud, db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A, path=/api/v1/auth/logout/
2025-12-03 22:53:37,854 - app.modules.auth.application.services.refresh_token_service - WARNING - [REVOKE-TOKEN] Token no encontrado o ya revocado - Cliente BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, Usuario 154134AD-A5EB-4F45-AEF0-5F9AAA282C8E
2025-12-03 22:53:37,855 - app.modules.auth.presentation.endpoints - INFO - [LOGOUT-WEB] Token no encontrado en BD (ya expirado/revocado) - Cliente: BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, Usuario: 154134AD-A5EB-4F45-AEF0-5F9AAA282C8E (superadmin)
2025-12-03 22:53:37,862 - app.modules.superadmin.application.services.audit_service - INFO - [AUDIT] auth_audit_log registrado: evento=logout, cliente_id=BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, usuario_id=154134AD-A5EB-4F45-AEF0-5F9AAA282C8E, exito=True
2025-12-03 22:53:37,862 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/logout/ 200 27.3ms
2025-12-03 22:58:03,866 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Pool ADMIN inicializado. Size=10, MaxOverflow=5
2025-12-03 22:58:03,867 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Configuración de pools de tenants: MaxPools=50, PoolSize=3, MaxOverflow=2, InactivityTimeout=3600s
2025-12-03 22:58:03,867 - app.infrastructure.database.connection_pool - INFO - ✅ Módulo de connection pooling cargado y activo
2025-12-03 22:58:03,868 - app.infrastructure.database.connection_pool - INFO -    Configuración: MaxTenantPools=50, TenantPoolSize=3, InactivityTimeout=3600s
2025-12-03 22:58:03,868 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Todos los pools cerrados
2025-12-03 22:58:03,869 - app.main - INFO - ✅ Pools de conexión cerrados correctamente
2025-12-03 22:58:03,971 - asyncio - ERROR - Unclosed connection
connection: <aioodbc.connection.Connection object at 0x0000019ABC8B24E0>
2025-12-03 22:58:03,972 - asyncio - ERROR - Unclosed connection
connection: <aioodbc.connection.Connection object at 0x0000019ABD250BF0>
2025-12-03 22:58:03,972 - asyncio - ERROR - Unclosed connection
connection: <aioodbc.connection.Connection object at 0x0000019ABD270320>
2025-12-03 22:58:03,974 - asyncio - ERROR - Unclosed connection
connection: <aioodbc.connection.Connection object at 0x0000019ABD29CBC0>
2025-12-03 22:58:03,974 - asyncio - ERROR - Unclosed connection
connection: <aioodbc.connection.Connection object at 0x0000019ABD29FC50>
2025-12-03 22:58:03,975 - asyncio - ERROR - Unclosed connection
connection: <aioodbc.connection.Connection object at 0x0000019ABD2C3200>
2025-12-03 22:58:03,975 - asyncio - ERROR - Unclosed connection
connection: <aioodbc.connection.Connection object at 0x0000019ABD2903E0>
2025-12-03 22:58:03,976 - asyncio - ERROR - Unclosed connection
connection: <aioodbc.connection.Connection object at 0x0000019ABD29FE00>
2025-12-03 22:58:03,976 - asyncio - ERROR - Unclosed connection
connection: <aioodbc.connection.Connection object at 0x0000019ABD2E43B0>
2025-12-03 22:58:04,801 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 22:58:05,042 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 22:58:05,049 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 22:58:05,058 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 22:58:05,059 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 22:58:05,060 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 22:58:05,060 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 22:58:05,061 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, DEFAULT_TYPE=single
2025-12-03 22:58:05,442 - app.core.security.rate_limiting - INFO - [RATE_LIMITING] Activado. Límites: Login=10/minute, API=200/minute
2025-12-03 22:58:05,442 - app.core.security.rate_limiting - INFO - ✅ Módulo de rate limiting cargado y activo
2025-12-03 22:58:05,541 - app.core.authorization.rbac - INFO - 🔐 Inicializando sistema de autorización...
2025-12-03 22:58:05,541 - app.core.authorization.rbac - INFO - ✅ Sistema de autorización inicializado correctamente
2025-12-03 22:58:05,542 - app.core.authorization.rbac - INFO - 📊 Permisos del sistema: 6 módulos configurados
2025-12-03 22:58:05,759 - app.core.tenant.middleware - INFO - Módulo tenant_middleware cargado (versión híbrida con soporte para proxies)
2025-12-03 22:58:05,760 - app.main - INFO - ✅ Rate limiting configurado y activo
2025-12-03 22:58:05,918 - app.core.tenant.middleware - INFO - [TENANT_MW] Inicializado - BASE_DOMAIN=app.local, SYSTEM_ID=BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, EXCLUDED_SUBDOMAINS={'backend', 'www', 'admin', 'assets', 'api', 'cdn', 'static'}
2025-12-03 23:00:41,520 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Pool ADMIN inicializado. Size=10, MaxOverflow=5
2025-12-03 23:00:41,520 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Configuración de pools de tenants: MaxPools=50, PoolSize=3, MaxOverflow=2, InactivityTimeout=3600s
2025-12-03 23:00:41,520 - app.infrastructure.database.connection_pool - INFO - ✅ Módulo de connection pooling cargado y activo
2025-12-03 23:00:41,520 - app.infrastructure.database.connection_pool - INFO -    Configuración: MaxTenantPools=50, TenantPoolSize=3, InactivityTimeout=3600s
2025-12-03 23:00:41,524 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Todos los pools cerrados
2025-12-03 23:00:41,524 - app.main - INFO - ✅ Pools de conexión cerrados correctamente
2025-12-03 23:00:41,722 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Pool ADMIN inicializado. Size=10, MaxOverflow=5
2025-12-03 23:00:41,722 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Configuración de pools de tenants: MaxPools=50, PoolSize=3, MaxOverflow=2, InactivityTimeout=3600s
2025-12-03 23:00:41,722 - app.infrastructure.database.connection_pool - INFO - ✅ Módulo de connection pooling cargado y activo
2025-12-03 23:00:41,726 - app.infrastructure.database.connection_pool - INFO -    Configuración: MaxTenantPools=50, TenantPoolSize=3, InactivityTimeout=3600s
2025-12-03 23:00:41,726 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Todos los pools cerrados
2025-12-03 23:00:41,726 - app.main - INFO - ✅ Pools de conexión cerrados correctamente
2025-12-03 23:00:42,323 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 23:00:42,500 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 23:00:42,506 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 23:00:42,516 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 23:00:42,517 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 23:00:42,517 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 23:00:42,518 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 23:00:42,518 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, DEFAULT_TYPE=single
2025-12-03 23:00:42,656 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 23:00:42,842 - app.core.security.rate_limiting - INFO - [RATE_LIMITING] Activado. Límites: Login=10/minute, API=200/minute
2025-12-03 23:00:42,842 - app.core.security.rate_limiting - INFO - ✅ Módulo de rate limiting cargado y activo
2025-12-03 23:00:42,912 - app.core.authorization.rbac - INFO - 🔐 Inicializando sistema de autorización...
2025-12-03 23:00:42,912 - app.core.authorization.rbac - INFO - ✅ Sistema de autorización inicializado correctamente
2025-12-03 23:00:42,912 - app.core.authorization.rbac - INFO - 📊 Permisos del sistema: 6 módulos configurados
2025-12-03 23:00:42,916 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 23:00:42,916 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 23:00:42,916 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 23:00:42,928 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 23:00:42,929 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 23:00:42,929 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 23:00:42,930 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, DEFAULT_TYPE=single
2025-12-03 23:00:43,072 - app.core.tenant.middleware - INFO - Módulo tenant_middleware cargado (versión híbrida con soporte para proxies)
2025-12-03 23:00:43,072 - app.main - INFO - ✅ Rate limiting configurado y activo
2025-12-03 23:00:43,236 - app.core.tenant.middleware - INFO - [TENANT_MW] Inicializado - BASE_DOMAIN=app.local, SYSTEM_ID=BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, EXCLUDED_SUBDOMAINS={'api', 'assets', 'www', 'static', 'cdn', 'backend', 'admin'}
2025-12-03 23:00:43,293 - app.core.security.rate_limiting - INFO - [RATE_LIMITING] Activado. Límites: Login=10/minute, API=200/minute
2025-12-03 23:00:43,293 - app.core.security.rate_limiting - INFO - ✅ Módulo de rate limiting cargado y activo
2025-12-03 23:00:43,392 - app.core.authorization.rbac - INFO - 🔐 Inicializando sistema de autorización...
2025-12-03 23:00:43,392 - app.core.authorization.rbac - INFO - ✅ Sistema de autorización inicializado correctamente
2025-12-03 23:00:43,393 - app.core.authorization.rbac - INFO - 📊 Permisos del sistema: 6 módulos configurados
2025-12-03 23:00:43,636 - app.core.tenant.middleware - INFO - Módulo tenant_middleware cargado (versión híbrida con soporte para proxies)
2025-12-03 23:00:43,636 - app.main - INFO - ✅ Rate limiting configurado y activo
2025-12-03 23:00:43,838 - app.core.tenant.middleware - INFO - [TENANT_MW] Inicializado - BASE_DOMAIN=app.local, SYSTEM_ID=BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, EXCLUDED_SUBDOMAINS={'assets', 'admin', 'static', 'api', 'www', 'cdn', 'backend'}
2025-12-03 23:00:54,352 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Pool ADMIN inicializado. Size=10, MaxOverflow=5
2025-12-03 23:00:54,352 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Configuración de pools de tenants: MaxPools=50, PoolSize=3, MaxOverflow=2, InactivityTimeout=3600s
2025-12-03 23:00:54,352 - app.infrastructure.database.connection_pool - INFO - ✅ Módulo de connection pooling cargado y activo
2025-12-03 23:00:54,352 - app.infrastructure.database.connection_pool - INFO -    Configuración: MaxTenantPools=50, TenantPoolSize=3, InactivityTimeout=3600s
2025-12-03 23:00:54,356 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Todos los pools cerrados
2025-12-03 23:00:54,356 - app.main - INFO - ✅ Pools de conexión cerrados correctamente
2025-12-03 23:00:55,943 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 23:00:56,199 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 23:00:56,208 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 23:00:56,211 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 23:00:56,212 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 23:00:56,213 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 23:00:56,213 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 23:00:56,214 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, DEFAULT_TYPE=single
2025-12-03 23:00:56,609 - app.core.security.rate_limiting - INFO - [RATE_LIMITING] Activado. Límites: Login=10/minute, API=200/minute
2025-12-03 23:00:56,611 - app.core.security.rate_limiting - INFO - ✅ Módulo de rate limiting cargado y activo
2025-12-03 23:00:56,689 - app.core.authorization.rbac - INFO - 🔐 Inicializando sistema de autorización...
2025-12-03 23:00:56,689 - app.core.authorization.rbac - INFO - ✅ Sistema de autorización inicializado correctamente
2025-12-03 23:00:56,690 - app.core.authorization.rbac - INFO - 📊 Permisos del sistema: 6 módulos configurados
2025-12-03 23:00:56,868 - app.core.tenant.middleware - INFO - Módulo tenant_middleware cargado (versión híbrida con soporte para proxies)
2025-12-03 23:00:56,869 - app.main - INFO - ✅ Rate limiting configurado y activo
2025-12-03 23:00:57,006 - app.core.tenant.middleware - INFO - [TENANT_MW] Inicializado - BASE_DOMAIN=app.local, SYSTEM_ID=BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, EXCLUDED_SUBDOMAINS={'api', 'www', 'admin', 'backend', 'cdn', 'static', 'assets'}
2025-12-03 23:00:59,236 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/refresh/
2025-12-03 23:00:59,236 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 23:00:59,236 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 23:00:59,236 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 23:00:59,236 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:00:59,240 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 23:00:59,240 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 23:00:59,241 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:00:59,241 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 23:00:59,242 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 23:00:59,243 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: tipo_instalacion=cloud, db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 23:00:59,243 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, tipo_instalacion=cloud, db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A, path=/api/v1/auth/refresh/
2025-12-03 23:00:59,246 - app.modules.auth.application.services.auth_service - WARNING - [REFRESH] No se proporcionó refresh token. Cliente: web
2025-12-03 23:00:59,247 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/refresh/ 401 11.3ms
2025-12-03 23:01:13,706 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/refresh/
2025-12-03 23:01:13,708 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 23:01:13,708 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': acme.app.local:5173
2025-12-03 23:01:13,709 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:01:13,709 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:01:13,710 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:01:13,712 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] AsyncEngine creado para admin
2025-12-03 23:01:13,867 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:01:13,867 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:01:13,867 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:01:13,874 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:01:17,960 - app.infrastructure.cache.redis_cache - WARNING - [REDIS_CACHE] Error conectando a Redis: Error 10061 connecting to localhost:6379. No se puede establecer una conexión ya que el equipo de destino denegó expresamente dicha conexión.. Cache desactivado automáticamente (usando fallback en memoria).
2025-12-03 23:01:17,960 - app.infrastructure.cache.redis_cache - INFO - ℹ️ Módulo de Redis cache cargado pero desactivado (usando fallback en memoria)
2025-12-03 23:01:17,968 - app.core.security.encryption - ERROR - Token de encriptación inválido. Posibles causas: clave incorrecta o datos corruptos
2025-12-03 23:01:17,969 - app.core.tenant.routing - ERROR - [METADATA] Error al desencriptar credenciales para cliente ee7bfc14-995f-4209-b4b9-99c307534a43: Credencial corrupta o clave de encriptación incorrecta
2025-12-03 23:01:17,978 - app.core.security.encryption - ERROR - Token de encriptación inválido. Posibles causas: clave incorrecta o datos corruptos
2025-12-03 23:01:17,978 - app.core.tenant.routing - ERROR - [METADATA] Error al desencriptar credenciales para cliente ee7bfc14-995f-4209-b4b9-99c307534a43: Credencial corrupta o clave de encriptación incorrecta
2025-12-03 23:01:17,979 - app.core.tenant.routing - WARNING - [METADATA] Credenciales vacías o no desencriptables para cliente ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:01:17,980 - app.core.tenant.routing - ERROR - [METADATA] ⚠️ CRÍTICO: Cliente ee7bfc14-995f-4209-b4b9-99c307534a43 es 'dedicated' pero: 1) No tiene conexión activa en cliente_conexion, O 2) Las credenciales no se pueden desencriptar. El sistema intentará usar Multi-DB pero fallará sin credenciales válidas. Verificar: 1) Registro en cliente_conexion con es_activo=1, 2) Credenciales encriptadas correctamente, 3) ENCRYPTION_KEY correcta en .env
2025-12-03 23:01:17,980 - app.core.tenant.routing - WARNING - [METADATA] No se encontró metadata para cliente ee7bfc14-995f-4209-b4b9-99c307534a43. Usando MULTI-DB como fallback. tipo_instalacion=dedicated
2025-12-03 23:01:17,981 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: tipo_instalacion=dedicated, db_type=multi, bd=None, servidor=N/A
2025-12-03 23:01:17,981 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43, tipo_instalacion=dedicated, db_type=multi, bd=None, servidor=N/A, path=/api/v1/auth/refresh/
2025-12-03 23:01:17,981 - app.modules.auth.application.services.auth_service - WARNING - [REFRESH] No se proporcionó refresh token. Cliente: web
2025-12-03 23:01:17,984 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/refresh/ 401 4277.6ms
2025-12-03 23:02:52,767 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/auth/login/
2025-12-03 23:02:52,767 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/auth/login/ 200 0.8ms
2025-12-03 23:02:52,769 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/login/
2025-12-03 23:02:52,769 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 23:02:52,770 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': acme.app.local:5173
2025-12-03 23:02:52,770 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:02:52,771 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:02:52,771 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:02:52,794 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:02:52,794 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:02:52,795 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:02:52,799 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:02:52,799 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: tipo_instalacion=dedicated, db_type=multi, bd=None, servidor=N/A
2025-12-03 23:02:52,799 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43, tipo_instalacion=dedicated, db_type=multi, bd=None, servidor=N/A, path=/api/v1/auth/login/
2025-12-03 23:02:52,806 - app.modules.auth.presentation.endpoints - INFO - Cliente ee7bfc14-995f-4209-b4b9-99c307534a43 resuelto y validado para login.
2025-12-03 23:02:52,807 - app.modules.auth.application.services.auth_service - INFO - [AUTH] Intento de login: username='admin_acme', cliente_id_destino=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:02:52,807 - app.modules.auth.application.services.auth_service - INFO - [AUTH] Usuario regular. Buscando en BD del cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:02:52,808 - app.infrastructure.database.connection_async - ERROR - [CONN_STR] Metadata Multi-DB incompleta: servidor=None, bd=None, usuario=None, password=None
2025-12-03 23:02:52,808 - app.infrastructure.database.connection_async - WARNING - [CONN_STR] Fallback a Single-DB por metadata Multi-DB incompleta
2025-12-03 23:02:52,808 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] AsyncEngine creado para tenant_ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:02:52,898 - app.modules.auth.application.services.auth_service - WARNING - [AUTH] Usuario NO ENCONTRADO: username='admin_acme', cliente_id_buscado=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:02:52,911 - app.modules.superadmin.application.services.audit_service - INFO - [AUDIT] auth_audit_log registrado: evento=login_failed, cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43, usuario_id=None, exito=False
2025-12-03 23:02:52,911 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/login/ 401 143.3ms
2025-12-03 23:03:59,864 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/auth/refresh/
2025-12-03 23:03:59,865 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/auth/refresh/ 200 1.0ms
2025-12-03 23:03:59,865 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/refresh/
2025-12-03 23:03:59,868 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 23:03:59,869 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': acme.app.local:5173
2025-12-03 23:03:59,869 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:03:59,869 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:03:59,871 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:03:59,893 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:03:59,893 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:03:59,894 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:03:59,900 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:03:59,901 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: tipo_instalacion=dedicated, db_type=multi, bd=None, servidor=N/A
2025-12-03 23:03:59,901 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43, tipo_instalacion=dedicated, db_type=multi, bd=None, servidor=N/A, path=/api/v1/auth/refresh/
2025-12-03 23:03:59,902 - app.modules.auth.application.services.auth_service - WARNING - [REFRESH] No se proporcionó refresh token. Cliente: web
2025-12-03 23:03:59,903 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/refresh/ 401 35.4ms
2025-12-03 23:04:11,980 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/refresh/
2025-12-03 23:04:11,981 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 23:04:11,982 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': acme.app.local:5173
2025-12-03 23:04:11,983 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:04:11,983 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:04:11,983 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:04:11,989 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:04:11,990 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:04:11,990 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:04:11,996 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:04:11,996 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: tipo_instalacion=dedicated, db_type=multi, bd=None, servidor=N/A
2025-12-03 23:04:11,997 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43, tipo_instalacion=dedicated, db_type=multi, bd=None, servidor=N/A, path=/api/v1/auth/refresh/
2025-12-03 23:04:11,998 - app.modules.auth.application.services.auth_service - WARNING - [REFRESH] No se proporcionó refresh token. Cliente: web
2025-12-03 23:04:11,999 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/refresh/ 401 19.4ms
2025-12-03 23:04:20,413 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Pool ADMIN inicializado. Size=10, MaxOverflow=5
2025-12-03 23:04:20,413 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Configuración de pools de tenants: MaxPools=50, PoolSize=3, MaxOverflow=2, InactivityTimeout=3600s
2025-12-03 23:04:20,413 - app.infrastructure.database.connection_pool - INFO - ✅ Módulo de connection pooling cargado y activo
2025-12-03 23:04:20,413 - app.infrastructure.database.connection_pool - INFO -    Configuración: MaxTenantPools=50, TenantPoolSize=3, InactivityTimeout=3600s
2025-12-03 23:04:20,413 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Todos los pools cerrados
2025-12-03 23:04:20,419 - app.main - INFO - ✅ Pools de conexión cerrados correctamente
2025-12-03 23:04:20,519 - asyncio - ERROR - Unclosed connection
connection: <aioodbc.connection.Connection object at 0x0000014A0EAB5F70>
2025-12-03 23:04:20,519 - asyncio - ERROR - Unclosed connection
connection: <aioodbc.connection.Connection object at 0x0000014A0F419F70>
2025-12-03 23:04:22,149 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 23:04:22,349 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 23:04:22,349 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 23:04:22,358 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 23:04:22,359 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 23:04:22,360 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 23:04:22,361 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 23:04:22,361 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, DEFAULT_TYPE=single
2025-12-03 23:04:22,679 - app.core.security.rate_limiting - INFO - [RATE_LIMITING] Activado. Límites: Login=10/minute, API=200/minute
2025-12-03 23:04:22,679 - app.core.security.rate_limiting - INFO - ✅ Módulo de rate limiting cargado y activo
2025-12-03 23:04:22,759 - app.core.authorization.rbac - INFO - 🔐 Inicializando sistema de autorización...
2025-12-03 23:04:22,761 - app.core.authorization.rbac - INFO - ✅ Sistema de autorización inicializado correctamente
2025-12-03 23:04:22,761 - app.core.authorization.rbac - INFO - 📊 Permisos del sistema: 6 módulos configurados
2025-12-03 23:04:22,921 - app.core.tenant.middleware - INFO - Módulo tenant_middleware cargado (versión híbrida con soporte para proxies)
2025-12-03 23:04:22,924 - app.main - INFO - ✅ Rate limiting configurado y activo
2025-12-03 23:04:23,069 - app.core.tenant.middleware - INFO - [TENANT_MW] Inicializado - BASE_DOMAIN=app.local, SYSTEM_ID=BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, EXCLUDED_SUBDOMAINS={'assets', 'cdn', 'static', 'www', 'api', 'admin', 'backend'}
2025-12-03 23:04:32,981 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/login/
2025-12-03 23:04:32,983 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 23:04:32,984 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': acme.app.local:5173
2025-12-03 23:04:32,984 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:04:32,984 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:04:32,985 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:04:32,988 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] AsyncEngine creado para admin
2025-12-03 23:04:33,139 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:04:33,139 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:04:33,143 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:04:33,144 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:04:37,247 - app.infrastructure.cache.redis_cache - WARNING - [REDIS_CACHE] Error conectando a Redis: Error 10061 connecting to localhost:6379. No se puede establecer una conexión ya que el equipo de destino denegó expresamente dicha conexión.. Cache desactivado automáticamente (usando fallback en memoria).
2025-12-03 23:04:37,247 - app.infrastructure.cache.redis_cache - INFO - ℹ️ Módulo de Redis cache cargado pero desactivado (usando fallback en memoria)
2025-12-03 23:04:37,253 - app.core.security.encryption - ERROR - Token de encriptación inválido. Posibles causas: clave incorrecta o datos corruptos
2025-12-03 23:04:37,253 - app.core.tenant.routing - ERROR - [METADATA] Error al desencriptar credenciales para cliente ee7bfc14-995f-4209-b4b9-99c307534a43: Credencial corrupta o clave de encriptación incorrecta
2025-12-03 23:04:37,267 - app.core.security.encryption - ERROR - Token de encriptación inválido. Posibles causas: clave incorrecta o datos corruptos
2025-12-03 23:04:37,267 - app.core.tenant.routing - ERROR - [METADATA] Error al desencriptar credenciales para cliente ee7bfc14-995f-4209-b4b9-99c307534a43: Credencial corrupta o clave de encriptación incorrecta
2025-12-03 23:04:37,268 - app.core.tenant.routing - WARNING - [METADATA] Credenciales vacías o no desencriptables para cliente ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:04:37,268 - app.core.tenant.routing - ERROR - [METADATA] ⚠️ CRÍTICO: Cliente ee7bfc14-995f-4209-b4b9-99c307534a43 es 'dedicated' pero: 1) No tiene conexión activa en cliente_conexion, O 2) Las credenciales no se pueden desencriptar. El sistema intentará usar Multi-DB pero fallará sin credenciales válidas. Verificar: 1) Registro en cliente_conexion con es_activo=1, 2) Credenciales encriptadas correctamente, 3) ENCRYPTION_KEY correcta en .env
2025-12-03 23:04:37,270 - app.core.tenant.routing - WARNING - [METADATA] No se encontró metadata para cliente ee7bfc14-995f-4209-b4b9-99c307534a43. Usando MULTI-DB como fallback. tipo_instalacion=dedicated
2025-12-03 23:04:37,270 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: tipo_instalacion=dedicated, db_type=multi, bd=None, servidor=N/A
2025-12-03 23:04:37,271 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43, tipo_instalacion=dedicated, db_type=multi, bd=None, servidor=N/A, path=/api/v1/auth/login/
2025-12-03 23:04:37,272 - app.modules.auth.presentation.endpoints - INFO - Cliente ee7bfc14-995f-4209-b4b9-99c307534a43 resuelto y validado para login.
2025-12-03 23:04:37,272 - app.modules.auth.application.services.auth_service - INFO - [AUTH] Intento de login: username='admin_acme', cliente_id_destino=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:04:37,272 - app.modules.auth.application.services.auth_service - INFO - [AUTH] Usuario regular. Buscando en BD del cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:04:37,280 - app.infrastructure.database.connection_async - ERROR - [CONN_STR] Metadata Multi-DB incompleta: servidor=None, bd=None, usuario=None, password=None
2025-12-03 23:04:37,280 - app.infrastructure.database.connection_async - WARNING - [CONN_STR] Fallback a Single-DB por metadata Multi-DB incompleta
2025-12-03 23:04:37,281 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] AsyncEngine creado para tenant_ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:04:37,293 - app.modules.auth.application.services.auth_service - WARNING - [AUTH] Usuario NO ENCONTRADO: username='admin_acme', cliente_id_buscado=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:04:37,302 - app.modules.superadmin.application.services.audit_service - INFO - [AUDIT] auth_audit_log registrado: evento=login_failed, cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43, usuario_id=None, exito=False
2025-12-03 23:04:37,309 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/login/ 401 4327.3ms
2025-12-03 23:06:52,390 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Pool ADMIN inicializado. Size=10, MaxOverflow=5
2025-12-03 23:06:52,391 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Configuración de pools de tenants: MaxPools=50, PoolSize=3, MaxOverflow=2, InactivityTimeout=3600s
2025-12-03 23:06:52,392 - app.infrastructure.database.connection_pool - INFO - ✅ Módulo de connection pooling cargado y activo
2025-12-03 23:06:52,392 - app.infrastructure.database.connection_pool - INFO -    Configuración: MaxTenantPools=50, TenantPoolSize=3, InactivityTimeout=3600s
2025-12-03 23:06:52,393 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Todos los pools cerrados
2025-12-03 23:06:52,394 - app.main - INFO - ✅ Pools de conexión cerrados correctamente
2025-12-03 23:06:52,522 - asyncio - ERROR - Unclosed connection
connection: <aioodbc.connection.Connection object at 0x000002C4B9619D30>
2025-12-03 23:06:52,523 - asyncio - ERROR - Unclosed connection
connection: <aioodbc.connection.Connection object at 0x000002C4BA2F0410>
2025-12-03 23:06:53,276 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 23:06:53,475 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 23:06:53,482 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 23:06:53,488 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 23:06:53,488 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 23:06:53,488 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 23:06:53,492 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 23:06:53,492 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, DEFAULT_TYPE=single
2025-12-03 23:06:53,814 - app.core.security.rate_limiting - INFO - [RATE_LIMITING] Activado. Límites: Login=10/minute, API=200/minute
2025-12-03 23:06:53,815 - app.core.security.rate_limiting - INFO - ✅ Módulo de rate limiting cargado y activo
2025-12-03 23:06:53,886 - app.core.authorization.rbac - INFO - 🔐 Inicializando sistema de autorización...
2025-12-03 23:06:53,887 - app.core.authorization.rbac - INFO - ✅ Sistema de autorización inicializado correctamente
2025-12-03 23:06:53,887 - app.core.authorization.rbac - INFO - 📊 Permisos del sistema: 6 módulos configurados
2025-12-03 23:06:54,042 - app.core.tenant.middleware - INFO - Módulo tenant_middleware cargado (versión híbrida con soporte para proxies)
2025-12-03 23:06:54,042 - app.main - INFO - ✅ Rate limiting configurado y activo
2025-12-03 23:06:54,182 - app.core.tenant.middleware - INFO - [TENANT_MW] Inicializado - BASE_DOMAIN=app.local, SYSTEM_ID=BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, EXCLUDED_SUBDOMAINS={'assets', 'static', 'www', 'api', 'backend', 'admin', 'cdn'}
2025-12-03 23:06:56,089 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Pool ADMIN inicializado. Size=10, MaxOverflow=5
2025-12-03 23:06:56,092 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Configuración de pools de tenants: MaxPools=50, PoolSize=3, MaxOverflow=2, InactivityTimeout=3600s
2025-12-03 23:06:56,092 - app.infrastructure.database.connection_pool - INFO - ✅ Módulo de connection pooling cargado y activo
2025-12-03 23:06:56,092 - app.infrastructure.database.connection_pool - INFO -    Configuración: MaxTenantPools=50, TenantPoolSize=3, InactivityTimeout=3600s
2025-12-03 23:06:56,092 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Todos los pools cerrados
2025-12-03 23:06:56,092 - app.main - INFO - ✅ Pools de conexión cerrados correctamente
2025-12-03 23:06:57,912 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 23:06:58,101 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 23:06:58,106 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 23:06:58,109 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 23:06:58,110 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 23:06:58,111 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 23:06:58,111 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 23:06:58,112 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, DEFAULT_TYPE=single
2025-12-03 23:06:58,468 - app.core.security.rate_limiting - INFO - [RATE_LIMITING] Activado. Límites: Login=10/minute, API=200/minute
2025-12-03 23:06:58,469 - app.core.security.rate_limiting - INFO - ✅ Módulo de rate limiting cargado y activo
2025-12-03 23:06:58,542 - app.core.authorization.rbac - INFO - 🔐 Inicializando sistema de autorización...
2025-12-03 23:06:58,542 - app.core.authorization.rbac - INFO - ✅ Sistema de autorización inicializado correctamente
2025-12-03 23:06:58,542 - app.core.authorization.rbac - INFO - 📊 Permisos del sistema: 6 módulos configurados
2025-12-03 23:06:58,703 - app.core.tenant.middleware - INFO - Módulo tenant_middleware cargado (versión híbrida con soporte para proxies)
2025-12-03 23:06:58,704 - app.main - INFO - ✅ Rate limiting configurado y activo
2025-12-03 23:06:58,859 - app.core.tenant.middleware - INFO - [TENANT_MW] Inicializado - BASE_DOMAIN=app.local, SYSTEM_ID=BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, EXCLUDED_SUBDOMAINS={'assets', 'api', 'admin', 'backend', 'cdn', 'static', 'www'}
2025-12-03 23:07:01,557 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/login/
2025-12-03 23:07:01,558 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 23:07:01,558 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': acme.app.local:5173
2025-12-03 23:07:01,559 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:07:01,559 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:07:01,559 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:07:01,562 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] AsyncEngine creado para admin
2025-12-03 23:07:01,703 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:07:01,703 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:07:01,703 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:07:01,703 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:07:05,799 - app.infrastructure.cache.redis_cache - WARNING - [REDIS_CACHE] Error conectando a Redis: Error 10061 connecting to localhost:6379. No se puede establecer una conexión ya que el equipo de destino denegó expresamente dicha conexión.. Cache desactivado automáticamente (usando fallback en memoria).
2025-12-03 23:07:05,800 - app.infrastructure.cache.redis_cache - INFO - ℹ️ Módulo de Redis cache cargado pero desactivado (usando fallback en memoria)
2025-12-03 23:07:05,803 - app.core.security.encryption - ERROR - Token de encriptación inválido. Posibles causas: clave incorrecta o datos corruptos
2025-12-03 23:07:05,803 - app.core.tenant.routing - ERROR - [METADATA] Error al desencriptar credenciales para cliente ee7bfc14-995f-4209-b4b9-99c307534a43: Credencial corrupta o clave de encriptación incorrecta
2025-12-03 23:07:05,817 - app.core.security.encryption - ERROR - Token de encriptación inválido. Posibles causas: clave incorrecta o datos corruptos
2025-12-03 23:07:05,818 - app.core.tenant.routing - ERROR - [METADATA] Error al desencriptar credenciales para cliente ee7bfc14-995f-4209-b4b9-99c307534a43: Credencial corrupta o clave de encriptación incorrecta
2025-12-03 23:07:05,818 - app.core.tenant.routing - WARNING - [METADATA] Credenciales vacías o no desencriptables para cliente ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:07:05,819 - app.core.tenant.routing - ERROR - [METADATA] ⚠️ CRÍTICO: Cliente ee7bfc14-995f-4209-b4b9-99c307534a43 es 'dedicated' pero: 1) No tiene conexión activa en cliente_conexion, O 2) Las credenciales no se pueden desencriptar. El sistema intentará usar Multi-DB pero fallará sin credenciales válidas. Verificar: 1) Registro en cliente_conexion con es_activo=1, 2) Credenciales encriptadas correctamente, 3) ENCRYPTION_KEY correcta en .env
2025-12-03 23:07:05,820 - app.core.tenant.routing - WARNING - [METADATA] No se encontró metadata para cliente ee7bfc14-995f-4209-b4b9-99c307534a43. Usando MULTI-DB como fallback. tipo_instalacion=dedicated
2025-12-03 23:07:05,820 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: tipo_instalacion=dedicated, db_type=multi, bd=None, servidor=N/A
2025-12-03 23:07:05,820 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43, tipo_instalacion=dedicated, db_type=multi, bd=None, servidor=N/A, path=/api/v1/auth/login/
2025-12-03 23:07:05,824 - app.modules.auth.presentation.endpoints - INFO - Cliente ee7bfc14-995f-4209-b4b9-99c307534a43 resuelto y validado para login.
2025-12-03 23:07:05,824 - app.modules.auth.application.services.auth_service - INFO - [AUTH] Intento de login: username='admin_acme', cliente_id_destino=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:07:05,824 - app.modules.auth.application.services.auth_service - INFO - [AUTH] Usuario regular. Buscando en BD del cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:07:05,829 - app.infrastructure.database.connection_async - ERROR - [CONN_STR] Cliente ee7bfc14-995f-4209-b4b9-99c307534a43 es 'dedicated' (requiere BD dedicada) pero las credenciales de conexión no están disponibles o no se pueden desencriptar. Verificar: 1) Registro en cliente_conexion con es_activo=1, 2) Credenciales encriptadas correctamente, 3) ENCRYPTION_KEY correcta en .env
2025-12-03 23:07:05,829 - app.infrastructure.database.connection_async - ERROR - [CONN_STR] Metadata recibida: servidor=None, bd=None, usuario=None, password=None
2025-12-03 23:07:05,829 - app.infrastructure.database.connection_async - ERROR - [ASYNC_CONNECTION] Error creando AsyncEngine: Cliente ee7bfc14-995f-4209-b4b9-99c307534a43 es 'dedicated' (requiere BD dedicada) pero las credenciales de conexión no están disponibles o no se pueden desencriptar. Verificar: 1) Registro en cliente_conexion con es_activo=1, 2) Credenciales encriptadas correctamente, 3) ENCRYPTION_KEY correcta en .env
Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\connection_async.py", line 222, in _get_async_engine
    conn_str = _build_async_connection_string(connection_type, client_id, connection_metadata)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\connection_async.py", line 158, in _build_async_connection_string
    raise DatabaseError(
app.core.exceptions.DatabaseError: Cliente ee7bfc14-995f-4209-b4b9-99c307534a43 es 'dedicated' (requiere BD dedicada) pero las credenciales de conexión no están disponibles o no se pueden desencriptar. Verificar: 1) Registro en cliente_conexion con es_activo=1, 2) Credenciales encriptadas correctamente, 3) ENCRYPTION_KEY correcta en .env
2025-12-03 23:07:05,830 - app.modules.auth.application.services.auth_service - ERROR - [AUTH] Error en autenticación: username='admin_acme', cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43, error=No se pudo crear AsyncEngine para la conexión
Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\modules\auth\application\services\auth_service.py", line 183, in authenticate_user
    result = await execute_query(
             ^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 126, in execute_query
    async with _get_connection_context(connection_type, client_id) as session:
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\contextlib.py", line 210, in __aenter__
    return await anext(self.gen)
           ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\core\tenant\routing.py", line 864, in get_connection_for_tenant
    async with get_db_connection(
               ^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\contextlib.py", line 210, in __aenter__
    return await anext(self.gen)
           ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\connection_async.py", line 312, in get_db_connection
    raise DatabaseError(
app.core.exceptions.DatabaseError: No se pudo crear AsyncEngine para la conexión
2025-12-03 23:07:05,857 - app.modules.superadmin.application.services.audit_service - INFO - [AUDIT] auth_audit_log registrado: evento=login_failed, cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43, usuario_id=None, exito=False
2025-12-03 23:07:05,859 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/login/ 500 4301.5ms
2025-12-03 23:10:41,890 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Pool ADMIN inicializado. Size=10, MaxOverflow=5
2025-12-03 23:10:41,890 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Configuración de pools de tenants: MaxPools=50, PoolSize=3, MaxOverflow=2, InactivityTimeout=3600s
2025-12-03 23:10:41,890 - app.infrastructure.database.connection_pool - INFO - ✅ Módulo de connection pooling cargado y activo
2025-12-03 23:10:41,891 - app.infrastructure.database.connection_pool - INFO -    Configuración: MaxTenantPools=50, TenantPoolSize=3, InactivityTimeout=3600s
2025-12-03 23:10:41,891 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Todos los pools cerrados
2025-12-03 23:10:41,891 - app.main - INFO - ✅ Pools de conexión cerrados correctamente
2025-12-03 23:10:42,424 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Pool ADMIN inicializado. Size=10, MaxOverflow=5
2025-12-03 23:10:42,425 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Configuración de pools de tenants: MaxPools=50, PoolSize=3, MaxOverflow=2, InactivityTimeout=3600s
2025-12-03 23:10:42,425 - app.infrastructure.database.connection_pool - INFO - ✅ Módulo de connection pooling cargado y activo
2025-12-03 23:10:42,426 - app.infrastructure.database.connection_pool - INFO -    Configuración: MaxTenantPools=50, TenantPoolSize=3, InactivityTimeout=3600s
2025-12-03 23:10:42,427 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Todos los pools cerrados
2025-12-03 23:10:42,427 - app.main - INFO - ✅ Pools de conexión cerrados correctamente
2025-12-03 23:10:42,544 - asyncio - ERROR - Unclosed connection
connection: <aioodbc.connection.Connection object at 0x0000022F7951C830>
2025-12-03 23:10:42,692 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 23:10:42,885 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 23:10:42,894 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 23:10:42,896 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 23:10:42,896 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 23:10:42,897 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 23:10:42,898 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 23:10:42,899 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, DEFAULT_TYPE=single
2025-12-03 23:10:43,227 - app.core.security.rate_limiting - INFO - [RATE_LIMITING] Activado. Límites: Login=10/minute, API=200/minute
2025-12-03 23:10:43,227 - app.core.security.rate_limiting - INFO - ✅ Módulo de rate limiting cargado y activo
2025-12-03 23:10:43,308 - app.core.authorization.rbac - INFO - 🔐 Inicializando sistema de autorización...
2025-12-03 23:10:43,308 - app.core.authorization.rbac - INFO - ✅ Sistema de autorización inicializado correctamente
2025-12-03 23:10:43,309 - app.core.authorization.rbac - INFO - 📊 Permisos del sistema: 6 módulos configurados
2025-12-03 23:10:43,490 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 23:10:43,499 - app.core.tenant.middleware - INFO - Módulo tenant_middleware cargado (versión híbrida con soporte para proxies)
2025-12-03 23:10:43,499 - app.main - INFO - ✅ Rate limiting configurado y activo
2025-12-03 23:10:43,667 - app.core.tenant.middleware - INFO - [TENANT_MW] Inicializado - BASE_DOMAIN=app.local, SYSTEM_ID=BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, EXCLUDED_SUBDOMAINS={'api', 'assets', 'cdn', 'backend', 'static', 'admin', 'www'}
2025-12-03 23:10:43,732 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 23:10:43,741 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 23:10:43,743 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 23:10:43,743 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 23:10:43,746 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 23:10:43,746 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 23:10:43,746 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, DEFAULT_TYPE=single
2025-12-03 23:10:44,192 - app.core.security.rate_limiting - INFO - [RATE_LIMITING] Activado. Límites: Login=10/minute, API=200/minute
2025-12-03 23:10:44,194 - app.core.security.rate_limiting - INFO - ✅ Módulo de rate limiting cargado y activo
2025-12-03 23:10:44,302 - app.core.authorization.rbac - INFO - 🔐 Inicializando sistema de autorización...
2025-12-03 23:10:44,302 - app.core.authorization.rbac - INFO - ✅ Sistema de autorización inicializado correctamente
2025-12-03 23:10:44,303 - app.core.authorization.rbac - INFO - 📊 Permisos del sistema: 6 módulos configurados
2025-12-03 23:10:44,553 - app.core.tenant.middleware - INFO - Módulo tenant_middleware cargado (versión híbrida con soporte para proxies)
2025-12-03 23:10:44,555 - app.main - INFO - ✅ Rate limiting configurado y activo
2025-12-03 23:10:44,698 - app.core.tenant.middleware - INFO - [TENANT_MW] Inicializado - BASE_DOMAIN=app.local, SYSTEM_ID=BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, EXCLUDED_SUBDOMAINS={'backend', 'api', 'cdn', 'www', 'static', 'admin', 'assets'}
2025-12-03 23:11:52,982 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Pool ADMIN inicializado. Size=10, MaxOverflow=5
2025-12-03 23:11:52,982 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Configuración de pools de tenants: MaxPools=50, PoolSize=3, MaxOverflow=2, InactivityTimeout=3600s
2025-12-03 23:11:52,982 - app.infrastructure.database.connection_pool - INFO - ✅ Módulo de connection pooling cargado y activo
2025-12-03 23:11:52,983 - app.infrastructure.database.connection_pool - INFO -    Configuración: MaxTenantPools=50, TenantPoolSize=3, InactivityTimeout=3600s
2025-12-03 23:11:52,984 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Todos los pools cerrados
2025-12-03 23:11:52,985 - app.main - INFO - ✅ Pools de conexión cerrados correctamente
2025-12-03 23:11:54,695 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 23:11:54,911 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 23:11:54,917 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 23:11:54,921 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 23:11:54,921 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 23:11:54,922 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 23:11:54,923 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 23:11:54,923 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, DEFAULT_TYPE=single
2025-12-03 23:11:55,256 - app.core.security.rate_limiting - INFO - [RATE_LIMITING] Activado. Límites: Login=10/minute, API=200/minute
2025-12-03 23:11:55,256 - app.core.security.rate_limiting - INFO - ✅ Módulo de rate limiting cargado y activo
2025-12-03 23:11:55,330 - app.core.authorization.rbac - INFO - 🔐 Inicializando sistema de autorización...
2025-12-03 23:11:55,330 - app.core.authorization.rbac - INFO - ✅ Sistema de autorización inicializado correctamente
2025-12-03 23:11:55,330 - app.core.authorization.rbac - INFO - 📊 Permisos del sistema: 6 módulos configurados
2025-12-03 23:11:55,486 - app.core.tenant.middleware - INFO - Módulo tenant_middleware cargado (versión híbrida con soporte para proxies)
2025-12-03 23:11:55,486 - app.main - INFO - ✅ Rate limiting configurado y activo
2025-12-03 23:11:55,628 - app.core.tenant.middleware - INFO - [TENANT_MW] Inicializado - BASE_DOMAIN=app.local, SYSTEM_ID=BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, EXCLUDED_SUBDOMAINS={'cdn', 'backend', 'static', 'www', 'api', 'assets', 'admin'}
2025-12-03 23:11:58,074 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/login/
2025-12-03 23:11:58,074 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 23:11:58,075 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': acme.app.local:5173
2025-12-03 23:11:58,075 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:11:58,075 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:11:58,076 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:11:58,079 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] AsyncEngine creado para admin
2025-12-03 23:11:58,236 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:11:58,236 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:11:58,236 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:11:58,246 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:12:02,323 - app.infrastructure.cache.redis_cache - WARNING - [REDIS_CACHE] Error conectando a Redis: Error 10061 connecting to localhost:6379. No se puede establecer una conexión ya que el equipo de destino denegó expresamente dicha conexión.. Cache desactivado automáticamente (usando fallback en memoria).
2025-12-03 23:12:02,323 - app.infrastructure.cache.redis_cache - INFO - ℹ️ Módulo de Redis cache cargado pero desactivado (usando fallback en memoria)
2025-12-03 23:12:03,039 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC
2025-12-03 23:12:03,039 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43, tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC, path=/api/v1/auth/login/
2025-12-03 23:12:03,047 - app.modules.auth.presentation.endpoints - INFO - Cliente ee7bfc14-995f-4209-b4b9-99c307534a43 resuelto y validado para login.
2025-12-03 23:12:03,047 - app.modules.auth.application.services.auth_service - INFO - [AUTH] Intento de login: username='admin_acme', cliente_id_destino=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:12:03,047 - app.modules.auth.application.services.auth_service - INFO - [AUTH] Usuario regular. Buscando en BD del cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:12:03,050 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] AsyncEngine creado para tenant_ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:12:03,259 - app.modules.auth.application.services.auth_service - WARNING - [AUTH] Usuario NO ENCONTRADO: username='admin_acme', cliente_id_buscado=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:12:03,274 - app.modules.superadmin.application.services.audit_service - INFO - [AUDIT] auth_audit_log registrado: evento=login_failed, cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43, usuario_id=None, exito=False
2025-12-03 23:12:03,275 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/login/ 401 5202.0ms
2025-12-03 23:12:10,640 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/refresh/
2025-12-03 23:12:10,640 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 23:12:10,640 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': acme.app.local:5173
2025-12-03 23:12:10,644 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:12:10,644 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:12:10,644 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:12:10,651 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:12:10,652 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:12:10,652 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:12:10,657 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:12:10,657 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC
2025-12-03 23:12:10,657 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43, tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC, path=/api/v1/auth/refresh/
2025-12-03 23:12:10,661 - app.modules.auth.application.services.auth_service - WARNING - [REFRESH] No se proporcionó refresh token. Cliente: web
2025-12-03 23:12:10,662 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/refresh/ 401 21.5ms
2025-12-03 23:12:49,735 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Pool ADMIN inicializado. Size=10, MaxOverflow=5
2025-12-03 23:12:49,735 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Configuración de pools de tenants: MaxPools=50, PoolSize=3, MaxOverflow=2, InactivityTimeout=3600s
2025-12-03 23:12:49,735 - app.infrastructure.database.connection_pool - INFO - ✅ Módulo de connection pooling cargado y activo
2025-12-03 23:12:49,737 - app.infrastructure.database.connection_pool - INFO -    Configuración: MaxTenantPools=50, TenantPoolSize=3, InactivityTimeout=3600s
2025-12-03 23:12:49,737 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Todos los pools cerrados
2025-12-03 23:12:49,737 - app.main - INFO - ✅ Pools de conexión cerrados correctamente
2025-12-03 23:12:49,834 - asyncio - ERROR - Unclosed connection
connection: <aioodbc.connection.Connection object at 0x0000025D7107A630>
2025-12-03 23:12:49,834 - asyncio - ERROR - Unclosed connection
connection: <aioodbc.connection.Connection object at 0x0000025D71C5A660>
2025-12-03 23:12:53,484 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 23:12:53,677 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 23:12:53,681 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 23:12:53,686 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 23:12:53,686 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 23:12:53,687 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 23:12:53,687 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 23:12:53,688 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, DEFAULT_TYPE=single
2025-12-03 23:12:54,023 - app.core.security.rate_limiting - INFO - [RATE_LIMITING] Activado. Límites: Login=10/minute, API=200/minute
2025-12-03 23:12:54,023 - app.core.security.rate_limiting - INFO - ✅ Módulo de rate limiting cargado y activo
2025-12-03 23:12:54,096 - app.core.authorization.rbac - INFO - 🔐 Inicializando sistema de autorización...
2025-12-03 23:12:54,097 - app.core.authorization.rbac - INFO - ✅ Sistema de autorización inicializado correctamente
2025-12-03 23:12:54,097 - app.core.authorization.rbac - INFO - 📊 Permisos del sistema: 6 módulos configurados
2025-12-03 23:12:54,262 - app.core.tenant.middleware - INFO - Módulo tenant_middleware cargado (versión híbrida con soporte para proxies)
2025-12-03 23:12:54,263 - app.main - INFO - ✅ Rate limiting configurado y activo
2025-12-03 23:12:54,413 - app.core.tenant.middleware - INFO - [TENANT_MW] Inicializado - BASE_DOMAIN=app.local, SYSTEM_ID=BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, EXCLUDED_SUBDOMAINS={'cdn', 'static', 'backend', 'assets', 'www', 'admin', 'api'}
2025-12-03 23:12:56,978 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/refresh/
2025-12-03 23:12:56,979 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 23:12:56,979 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': acme.app.local:5173
2025-12-03 23:12:56,981 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:12:56,981 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:12:56,981 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:12:56,986 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] AsyncEngine creado para admin
2025-12-03 23:12:57,082 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:12:57,083 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:12:57,084 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:12:57,089 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:13:01,180 - app.infrastructure.cache.redis_cache - WARNING - [REDIS_CACHE] Error conectando a Redis: Error 10061 connecting to localhost:6379. No se puede establecer una conexión ya que el equipo de destino denegó expresamente dicha conexión.. Cache desactivado automáticamente (usando fallback en memoria).
2025-12-03 23:13:01,180 - app.infrastructure.cache.redis_cache - INFO - ℹ️ Módulo de Redis cache cargado pero desactivado (usando fallback en memoria)
2025-12-03 23:13:01,187 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC
2025-12-03 23:13:01,187 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43, tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC, path=/api/v1/auth/refresh/
2025-12-03 23:13:01,193 - app.modules.auth.application.services.auth_service - WARNING - [REFRESH] No se proporcionó refresh token. Cliente: web
2025-12-03 23:13:01,193 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/refresh/ 401 4215.8ms
2025-12-03 23:13:10,127 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/auth/login/
2025-12-03 23:13:10,128 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/auth/login/ 200 0.9ms
2025-12-03 23:13:10,129 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/login/
2025-12-03 23:13:10,130 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 23:13:10,131 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': acme.app.local:5173
2025-12-03 23:13:10,131 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:13:10,132 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:13:10,132 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:13:10,140 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:13:10,141 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:13:10,141 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:13:10,146 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:13:10,147 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC
2025-12-03 23:13:10,148 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43, tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC, path=/api/v1/auth/login/
2025-12-03 23:13:10,154 - app.modules.auth.presentation.endpoints - INFO - Cliente ee7bfc14-995f-4209-b4b9-99c307534a43 resuelto y validado para login.
2025-12-03 23:13:10,156 - app.modules.auth.application.services.auth_service - INFO - [AUTH] Intento de login: username='admin_acme', cliente_id_destino=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:13:10,156 - app.modules.auth.application.services.auth_service - INFO - [AUTH] Usuario regular. Buscando en BD del cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:13:10,159 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] AsyncEngine creado para tenant_ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:13:10,218 - app.modules.auth.application.services.auth_service - WARNING - [AUTH] Usuario NO ENCONTRADO: username='admin_acme', cliente_id_buscado=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:13:10,228 - app.modules.superadmin.application.services.audit_service - INFO - [AUDIT] auth_audit_log registrado: evento=login_failed, cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43, usuario_id=None, exito=False
2025-12-03 23:13:10,228 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/login/ 401 100.7ms
2025-12-03 23:15:49,318 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/auth/login/
2025-12-03 23:15:49,319 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/auth/login/ 200 0.9ms
2025-12-03 23:15:49,322 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/login/
2025-12-03 23:15:49,323 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 23:15:49,323 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 23:15:49,323 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 23:15:49,324 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:15:49,324 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 23:15:49,325 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 23:15:49,325 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:15:49,325 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 23:15:49,326 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 23:15:49,327 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: tipo_instalacion=cloud, db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 23:15:49,327 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, tipo_instalacion=cloud, db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A, path=/api/v1/auth/login/
2025-12-03 23:15:49,347 - app.modules.auth.presentation.endpoints - INFO - Cliente bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7 resuelto y validado para login.
2025-12-03 23:15:49,347 - app.modules.auth.application.services.auth_service - INFO - [AUTH] Intento de login: username='superadmin', cliente_id_destino=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 23:15:49,347 - app.modules.auth.application.services.auth_service - INFO - [AUTH] SUPERADMIN detectado. Buscando en BD ADMIN (cliente_id=BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7), accediendo a cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 23:15:49,604 - app.modules.auth.application.services.auth_service - INFO - Niveles calculados - Usuario 154134AD-A5EB-4F45-AEF0-5F9AAA282C8E: level=5, super_admin=True, type=super_admin
2025-12-03 23:15:49,604 - app.modules.auth.application.services.auth_service - INFO - [AUTH] Login exitoso: username='superadmin', usuario_id=154134AD-A5EB-4F45-AEF0-5F9AAA282C8E, cliente_origen=BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, cliente_destino=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, access_level=5, user_type=super_admin
2025-12-03 23:15:49,604 - app.modules.auth.presentation.endpoints - INFO - [LOGIN] Superadmin accediendo a cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 23:15:49,614 - app.modules.auth.application.services.auth_service - INFO - Niveles calculados - Usuario 154134AD-A5EB-4F45-AEF0-5F9AAA282C8E: level=5, super_admin=True, type=super_admin
2025-12-03 23:15:49,623 - app.modules.auth.application.services.refresh_token_service - INFO - [STORE-TOKEN] Token insertado exitosamente - Cliente bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, Usuario 154134AD-A5EB-4F45-AEF0-5F9AAA282C8E, Tipo: web, Token ID: 13F31C99-66C6-40F6-8FD4-269CDBE0BCB5, Rotación: False
2025-12-03 23:15:49,630 - app.modules.auth.presentation.endpoints - INFO - [LOGIN-WEB] Token almacenado - ID: 13F31C99-66C6-40F6-8FD4-269CDBE0BCB5
2025-12-03 23:15:49,630 - app.modules.auth.presentation.endpoints - INFO - Usuario superadmin autenticado exitosamente (WEB) para cliente bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 23:15:49,643 - app.modules.superadmin.application.services.audit_service - INFO - [AUDIT] auth_audit_log registrado: evento=login_success, cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, usuario_id=154134AD-A5EB-4F45-AEF0-5F9AAA282C8E, exito=True
2025-12-03 23:15:49,644 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/login/ 200 322.5ms
2025-12-03 23:15:49,654 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/clientes/tenant/branding
2025-12-03 23:15:49,655 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/clientes/tenant/branding 200 1.1ms
2025-12-03 23:15:49,659 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/clientes/tenant/branding
2025-12-03 23:15:49,660 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 23:15:49,660 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 23:15:49,661 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 23:15:49,661 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:15:49,662 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 23:15:49,662 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 23:15:49,663 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:15:49,663 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 23:15:49,664 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 23:15:49,664 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: tipo_instalacion=cloud, db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 23:15:49,666 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, tipo_instalacion=cloud, db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A, path=/api/v1/clientes/tenant/branding
2025-12-03 23:15:49,686 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/menus/getmenu/
2025-12-03 23:15:49,688 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/menus/getmenu/ 200 1.8ms
2025-12-03 23:15:49,690 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/menus/getmenu/
2025-12-03 23:15:49,692 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/menus/getmenu/ 200 1.6ms
2025-12-03 23:15:49,694 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/menus/getmenu/
2025-12-03 23:15:49,695 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 23:15:49,696 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 23:15:49,697 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 23:15:49,697 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:15:49,697 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 23:15:49,698 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 23:15:49,699 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:15:49,699 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 23:15:49,700 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 23:15:49,701 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: tipo_instalacion=cloud, db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 23:15:49,701 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, tipo_instalacion=cloud, db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A, path=/api/v1/menus/getmenu/
2025-12-03 23:15:49,720 - app.modules.tenant.presentation.endpoints_clientes - INFO - Solicitud GET /tenant/branding recibida para cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7 por usuario: superadmin
2025-12-03 23:15:49,721 - app.modules.tenant.application.services.cliente_service - INFO - Solicitando branding para cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 23:15:49,729 - app.modules.tenant.application.services.cliente_service - INFO - Branding obtenido exitosamente para cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 23:15:49,730 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/clientes/tenant/branding 200 71.3ms
2025-12-03 23:15:49,740 - app.modules.menus.presentation.endpoints - INFO - Solicitud GET /menus/getmenu/ recibida para usuario ID: 154134ad-a5eb-4f45-aef0-5f9aaa282c8e del cliente bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 23:15:49,741 - app.modules.menus.application.services.menu_service - INFO - Obteniendo menú filtrado para usuario_id: 154134ad-a5eb-4f45-aef0-5f9aaa282c8e
2025-12-03 23:15:49,743 - app.modules.menus.application.services.menu_service - INFO - No se encontraron menús permitidos para el usuario ID: 154134ad-a5eb-4f45-aef0-5f9aaa282c8e.
2025-12-03 23:15:49,743 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/menus/getmenu/ 200 54.8ms
2025-12-03 23:15:49,751 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/menus/getmenu/
2025-12-03 23:15:49,752 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 23:15:49,753 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 23:15:49,753 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 23:15:49,753 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:15:49,755 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 23:15:49,756 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 23:15:49,756 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:15:49,756 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 23:15:49,757 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 23:15:49,757 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: tipo_instalacion=cloud, db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 23:15:49,758 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, tipo_instalacion=cloud, db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A, path=/api/v1/menus/getmenu/
2025-12-03 23:15:49,780 - app.modules.menus.presentation.endpoints - INFO - Solicitud GET /menus/getmenu/ recibida para usuario ID: 154134ad-a5eb-4f45-aef0-5f9aaa282c8e del cliente bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 23:15:49,780 - app.modules.menus.application.services.menu_service - INFO - Obteniendo menú filtrado para usuario_id: 154134ad-a5eb-4f45-aef0-5f9aaa282c8e
2025-12-03 23:15:49,785 - app.modules.menus.application.services.menu_service - INFO - No se encontraron menús permitidos para el usuario ID: 154134ad-a5eb-4f45-aef0-5f9aaa282c8e.
2025-12-03 23:15:49,786 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/menus/getmenu/ 200 34.1ms
2025-12-03 23:16:42,272 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/auth/logout/
2025-12-03 23:16:42,273 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/auth/logout/ 200 0.9ms
2025-12-03 23:16:42,275 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/logout/
2025-12-03 23:16:42,276 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 23:16:42,276 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 23:16:42,277 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 23:16:42,277 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:16:42,277 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 23:16:42,278 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 23:16:42,278 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:16:42,279 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 23:16:42,279 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 23:16:42,280 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: tipo_instalacion=cloud, db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 23:16:42,280 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, tipo_instalacion=cloud, db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A, path=/api/v1/auth/logout/
2025-12-03 23:16:42,301 - app.modules.auth.application.services.refresh_token_service - WARNING - [REVOKE-TOKEN] Token no encontrado o ya revocado - Cliente BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, Usuario 154134AD-A5EB-4F45-AEF0-5F9AAA282C8E
2025-12-03 23:16:42,301 - app.modules.auth.presentation.endpoints - INFO - [LOGOUT-WEB] Token no encontrado en BD (ya expirado/revocado) - Cliente: BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, Usuario: 154134AD-A5EB-4F45-AEF0-5F9AAA282C8E (superadmin)
2025-12-03 23:16:42,321 - app.modules.superadmin.application.services.audit_service - INFO - [AUDIT] auth_audit_log registrado: evento=logout, cliente_id=BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, usuario_id=154134AD-A5EB-4F45-AEF0-5F9AAA282C8E, exito=True
2025-12-03 23:16:42,321 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/logout/ 200 48.3ms
2025-12-03 23:16:45,991 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/auth/refresh/
2025-12-03 23:16:45,995 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/auth/refresh/ 200 1.3ms
2025-12-03 23:16:45,997 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/refresh/
2025-12-03 23:16:45,998 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 23:16:45,998 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': acme.app.local:5173
2025-12-03 23:16:45,998 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:16:46,000 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:16:46,001 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:16:46,007 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:16:46,007 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:16:46,007 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:16:46,017 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:16:46,017 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC
2025-12-03 23:16:46,018 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43, tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC, path=/api/v1/auth/refresh/
2025-12-03 23:16:46,020 - app.modules.auth.application.services.auth_service - WARNING - [REFRESH] No se proporcionó refresh token. Cliente: web
2025-12-03 23:16:46,021 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/refresh/ 401 23.6ms
2025-12-03 23:16:50,516 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Pool ADMIN inicializado. Size=10, MaxOverflow=5
2025-12-03 23:16:50,516 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Configuración de pools de tenants: MaxPools=50, PoolSize=3, MaxOverflow=2, InactivityTimeout=3600s
2025-12-03 23:16:50,516 - app.infrastructure.database.connection_pool - INFO - ✅ Módulo de connection pooling cargado y activo
2025-12-03 23:16:50,516 - app.infrastructure.database.connection_pool - INFO -    Configuración: MaxTenantPools=50, TenantPoolSize=3, InactivityTimeout=3600s
2025-12-03 23:16:50,516 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Todos los pools cerrados
2025-12-03 23:16:50,516 - app.main - INFO - ✅ Pools de conexión cerrados correctamente
2025-12-03 23:16:50,624 - asyncio - ERROR - Unclosed connection
connection: <aioodbc.connection.Connection object at 0x000001ABD3DC1850>
2025-12-03 23:16:50,625 - asyncio - ERROR - Unclosed connection
connection: <aioodbc.connection.Connection object at 0x000001ABD5F07B60>
2025-12-03 23:16:50,626 - asyncio - ERROR - Unclosed connection
connection: <aioodbc.connection.Connection object at 0x000001ABD5F5ACC0>
2025-12-03 23:16:55,571 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 23:16:55,781 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 23:16:55,788 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 23:16:55,791 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 23:16:55,792 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 23:16:55,793 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 23:16:55,793 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 23:16:55,794 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, DEFAULT_TYPE=single
2025-12-03 23:16:56,129 - app.core.security.rate_limiting - INFO - [RATE_LIMITING] Activado. Límites: Login=10/minute, API=200/minute
2025-12-03 23:16:56,130 - app.core.security.rate_limiting - INFO - ✅ Módulo de rate limiting cargado y activo
2025-12-03 23:16:56,201 - app.core.authorization.rbac - INFO - 🔐 Inicializando sistema de autorización...
2025-12-03 23:16:56,201 - app.core.authorization.rbac - INFO - ✅ Sistema de autorización inicializado correctamente
2025-12-03 23:16:56,201 - app.core.authorization.rbac - INFO - 📊 Permisos del sistema: 6 módulos configurados
2025-12-03 23:16:56,397 - app.core.tenant.middleware - INFO - Módulo tenant_middleware cargado (versión híbrida con soporte para proxies)
2025-12-03 23:16:56,401 - app.main - INFO - ✅ Rate limiting configurado y activo
2025-12-03 23:16:56,564 - app.core.tenant.middleware - INFO - [TENANT_MW] Inicializado - BASE_DOMAIN=app.local, SYSTEM_ID=BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, EXCLUDED_SUBDOMAINS={'backend', 'api', 'www', 'admin', 'static', 'assets', 'cdn'}
2025-12-03 23:17:05,769 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/login/
2025-12-03 23:17:05,770 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 23:17:05,770 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': acme.app.local:5173
2025-12-03 23:17:05,771 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:17:05,771 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:17:05,771 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:17:05,775 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] AsyncEngine creado para admin
2025-12-03 23:17:05,901 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:17:05,901 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:17:05,901 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:17:05,911 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:17:09,986 - app.infrastructure.cache.redis_cache - WARNING - [REDIS_CACHE] Error conectando a Redis: Error 10061 connecting to localhost:6379. No se puede establecer una conexión ya que el equipo de destino denegó expresamente dicha conexión.. Cache desactivado automáticamente (usando fallback en memoria).
2025-12-03 23:17:09,986 - app.infrastructure.cache.redis_cache - INFO - ℹ️ Módulo de Redis cache cargado pero desactivado (usando fallback en memoria)
2025-12-03 23:17:09,991 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC
2025-12-03 23:17:09,991 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43, tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC, path=/api/v1/auth/login/
2025-12-03 23:17:10,006 - app.modules.auth.presentation.endpoints - INFO - Cliente ee7bfc14-995f-4209-b4b9-99c307534a43 resuelto y validado para login.
2025-12-03 23:17:10,006 - app.modules.auth.application.services.auth_service - INFO - [AUTH] Intento de login: username='admin_acme', cliente_id_destino=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:17:10,006 - app.modules.auth.application.services.auth_service - INFO - [AUTH] Usuario regular. Buscando en BD del cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:17:10,010 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] AsyncEngine creado para tenant_ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:17:10,081 - app.modules.auth.application.services.auth_service - WARNING - [AUTH] Usuario NO ENCONTRADO: username='admin_acme', cliente_id_buscado=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:17:10,088 - app.modules.superadmin.application.services.audit_service - INFO - [AUDIT] auth_audit_log registrado: evento=login_failed, cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43, usuario_id=None, exito=False
2025-12-03 23:17:10,089 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/login/ 401 4319.8ms
2025-12-03 23:17:35,244 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Pool ADMIN inicializado. Size=10, MaxOverflow=5
2025-12-03 23:17:35,244 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Configuración de pools de tenants: MaxPools=50, PoolSize=3, MaxOverflow=2, InactivityTimeout=3600s
2025-12-03 23:17:35,244 - app.infrastructure.database.connection_pool - INFO - ✅ Módulo de connection pooling cargado y activo
2025-12-03 23:17:35,244 - app.infrastructure.database.connection_pool - INFO -    Configuración: MaxTenantPools=50, TenantPoolSize=3, InactivityTimeout=3600s
2025-12-03 23:17:35,244 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Todos los pools cerrados
2025-12-03 23:17:35,244 - app.main - INFO - ✅ Pools de conexión cerrados correctamente
2025-12-03 23:17:35,346 - asyncio - ERROR - Unclosed connection
connection: <aioodbc.connection.Connection object at 0x00000192910A6720>
2025-12-03 23:17:35,347 - asyncio - ERROR - Unclosed connection
connection: <aioodbc.connection.Connection object at 0x0000019291A1A5D0>
2025-12-03 23:17:36,954 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 23:17:37,155 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 23:17:37,161 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 23:17:37,164 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 23:17:37,165 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 23:17:37,166 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 23:17:37,166 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 23:17:37,167 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, DEFAULT_TYPE=single
2025-12-03 23:17:37,507 - app.core.security.rate_limiting - INFO - [RATE_LIMITING] Activado. Límites: Login=10/minute, API=200/minute
2025-12-03 23:17:37,507 - app.core.security.rate_limiting - INFO - ✅ Módulo de rate limiting cargado y activo
2025-12-03 23:17:37,583 - app.core.authorization.rbac - INFO - 🔐 Inicializando sistema de autorización...
2025-12-03 23:17:37,583 - app.core.authorization.rbac - INFO - ✅ Sistema de autorización inicializado correctamente
2025-12-03 23:17:37,584 - app.core.authorization.rbac - INFO - 📊 Permisos del sistema: 6 módulos configurados
2025-12-03 23:17:37,763 - app.core.tenant.middleware - INFO - Módulo tenant_middleware cargado (versión híbrida con soporte para proxies)
2025-12-03 23:17:37,764 - app.main - INFO - ✅ Rate limiting configurado y activo
2025-12-03 23:17:37,904 - app.core.tenant.middleware - INFO - [TENANT_MW] Inicializado - BASE_DOMAIN=app.local, SYSTEM_ID=BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, EXCLUDED_SUBDOMAINS={'api', 'cdn', 'static', 'admin', 'www', 'assets', 'backend'}
2025-12-03 23:17:40,122 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/login/
2025-12-03 23:17:40,123 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 23:17:40,123 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': acme.app.local:5173
2025-12-03 23:17:40,123 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:17:40,124 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:17:40,124 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:17:40,126 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] AsyncEngine creado para admin
2025-12-03 23:17:40,257 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:17:40,257 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:17:40,257 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:17:40,262 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:17:44,337 - app.infrastructure.cache.redis_cache - WARNING - [REDIS_CACHE] Error conectando a Redis: Error 10061 connecting to localhost:6379. No se puede establecer una conexión ya que el equipo de destino denegó expresamente dicha conexión.. Cache desactivado automáticamente (usando fallback en memoria).
2025-12-03 23:17:44,338 - app.infrastructure.cache.redis_cache - INFO - ℹ️ Módulo de Redis cache cargado pero desactivado (usando fallback en memoria)
2025-12-03 23:17:44,344 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC
2025-12-03 23:17:44,344 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43, tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC, path=/api/v1/auth/login/
2025-12-03 23:17:44,357 - app.modules.auth.presentation.endpoints - INFO - Cliente ee7bfc14-995f-4209-b4b9-99c307534a43 resuelto y validado para login.
2025-12-03 23:17:44,357 - app.modules.auth.application.services.auth_service - INFO - [AUTH] Intento de login: username='admin_acme', cliente_id_destino=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:17:44,357 - app.modules.auth.application.services.auth_service - INFO - [AUTH] Usuario regular. Buscando en BD del cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:17:44,361 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] AsyncEngine creado para tenant_ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:17:44,423 - app.modules.auth.application.services.auth_service - WARNING - [AUTH] Usuario NO ENCONTRADO: username='admin_acme', cliente_id_buscado=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:17:44,432 - app.modules.superadmin.application.services.audit_service - INFO - [AUDIT] auth_audit_log registrado: evento=login_failed, cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43, usuario_id=None, exito=False
2025-12-03 23:17:44,439 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/login/ 401 4317.1ms
2025-12-03 23:20:25,855 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Pool ADMIN inicializado. Size=10, MaxOverflow=5
2025-12-03 23:20:25,855 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Configuración de pools de tenants: MaxPools=50, PoolSize=3, MaxOverflow=2, InactivityTimeout=3600s
2025-12-03 23:20:25,855 - app.infrastructure.database.connection_pool - INFO - ✅ Módulo de connection pooling cargado y activo
2025-12-03 23:20:25,855 - app.infrastructure.database.connection_pool - INFO -    Configuración: MaxTenantPools=50, TenantPoolSize=3, InactivityTimeout=3600s
2025-12-03 23:20:25,855 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Todos los pools cerrados
2025-12-03 23:20:25,855 - app.main - INFO - ✅ Pools de conexión cerrados correctamente
2025-12-03 23:20:25,984 - asyncio - ERROR - Unclosed connection
connection: <aioodbc.connection.Connection object at 0x000001FA81152210>
2025-12-03 23:20:25,985 - asyncio - ERROR - Unclosed connection
connection: <aioodbc.connection.Connection object at 0x000001FA8316A7E0>
2025-12-03 23:20:26,762 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 23:20:26,972 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 23:20:26,975 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 23:20:26,982 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 23:20:26,983 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 23:20:26,983 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 23:20:26,983 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 23:20:26,984 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, DEFAULT_TYPE=single
2025-12-03 23:20:27,364 - app.core.security.rate_limiting - INFO - [RATE_LIMITING] Activado. Límites: Login=10/minute, API=200/minute
2025-12-03 23:20:27,364 - app.core.security.rate_limiting - INFO - ✅ Módulo de rate limiting cargado y activo
2025-12-03 23:20:27,489 - app.core.authorization.rbac - INFO - 🔐 Inicializando sistema de autorización...
2025-12-03 23:20:27,489 - app.core.authorization.rbac - INFO - ✅ Sistema de autorización inicializado correctamente
2025-12-03 23:20:27,492 - app.core.authorization.rbac - INFO - 📊 Permisos del sistema: 6 módulos configurados
2025-12-03 23:20:27,684 - app.core.tenant.middleware - INFO - Módulo tenant_middleware cargado (versión híbrida con soporte para proxies)
2025-12-03 23:20:27,685 - app.main - INFO - ✅ Rate limiting configurado y activo
2025-12-03 23:20:27,838 - app.core.tenant.middleware - INFO - [TENANT_MW] Inicializado - BASE_DOMAIN=app.local, SYSTEM_ID=BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, EXCLUDED_SUBDOMAINS={'static', 'assets', 'backend', 'admin', 'api', 'cdn', 'www'}
2025-12-03 23:20:29,223 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Pool ADMIN inicializado. Size=10, MaxOverflow=5
2025-12-03 23:20:29,225 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Configuración de pools de tenants: MaxPools=50, PoolSize=3, MaxOverflow=2, InactivityTimeout=3600s
2025-12-03 23:20:29,225 - app.infrastructure.database.connection_pool - INFO - ✅ Módulo de connection pooling cargado y activo
2025-12-03 23:20:29,225 - app.infrastructure.database.connection_pool - INFO -    Configuración: MaxTenantPools=50, TenantPoolSize=3, InactivityTimeout=3600s
2025-12-03 23:20:29,225 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Todos los pools cerrados
2025-12-03 23:20:29,225 - app.main - INFO - ✅ Pools de conexión cerrados correctamente
2025-12-03 23:20:30,964 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 23:20:31,182 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 23:20:31,188 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 23:20:31,190 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 23:20:31,191 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 23:20:31,192 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 23:20:31,192 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 23:20:31,193 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, DEFAULT_TYPE=single
2025-12-03 23:20:31,528 - app.core.security.rate_limiting - INFO - [RATE_LIMITING] Activado. Límites: Login=10/minute, API=200/minute
2025-12-03 23:20:31,529 - app.core.security.rate_limiting - INFO - ✅ Módulo de rate limiting cargado y activo
2025-12-03 23:20:31,598 - app.core.authorization.rbac - INFO - 🔐 Inicializando sistema de autorización...
2025-12-03 23:20:31,599 - app.core.authorization.rbac - INFO - ✅ Sistema de autorización inicializado correctamente
2025-12-03 23:20:31,599 - app.core.authorization.rbac - INFO - 📊 Permisos del sistema: 6 módulos configurados
2025-12-03 23:20:31,756 - app.core.tenant.middleware - INFO - Módulo tenant_middleware cargado (versión híbrida con soporte para proxies)
2025-12-03 23:20:31,757 - app.main - INFO - ✅ Rate limiting configurado y activo
2025-12-03 23:20:31,905 - app.core.tenant.middleware - INFO - [TENANT_MW] Inicializado - BASE_DOMAIN=app.local, SYSTEM_ID=BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, EXCLUDED_SUBDOMAINS={'static', 'assets', 'api', 'www', 'admin', 'backend', 'cdn'}
2025-12-03 23:20:33,609 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/login/
2025-12-03 23:20:33,609 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 23:20:33,610 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': acme.app.local:5173
2025-12-03 23:20:33,610 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:20:33,611 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:20:33,612 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:20:33,617 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] AsyncEngine creado para admin
2025-12-03 23:20:33,755 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:20:33,755 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:20:33,755 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:20:33,764 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:20:37,848 - app.infrastructure.cache.redis_cache - WARNING - [REDIS_CACHE] Error conectando a Redis: Error 10061 connecting to localhost:6379. No se puede establecer una conexión ya que el equipo de destino denegó expresamente dicha conexión.. Cache desactivado automáticamente (usando fallback en memoria).
2025-12-03 23:20:37,849 - app.infrastructure.cache.redis_cache - INFO - ℹ️ Módulo de Redis cache cargado pero desactivado (usando fallback en memoria)
2025-12-03 23:20:37,855 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC
2025-12-03 23:20:37,855 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43, tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC, path=/api/v1/auth/login/
2025-12-03 23:20:37,867 - app.modules.auth.presentation.endpoints - INFO - Cliente ee7bfc14-995f-4209-b4b9-99c307534a43 resuelto y validado para login.
2025-12-03 23:20:37,868 - app.modules.auth.application.services.auth_service - INFO - [AUTH] Intento de login: username='admin_acme', cliente_id_destino=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:20:37,869 - app.modules.auth.application.services.auth_service - INFO - [AUTH] Usuario regular. Buscando en BD del cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:20:37,869 - app.modules.auth.application.services.auth_service - ERROR - [AUTH] Error en autenticación: username='admin_acme', cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43, error=cannot import name 'get_current_tenant_context' from 'app.core.tenant.context' (D:\base_multi_tenant_fastapi\app\core\tenant\context.py)
Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\modules\auth\application\services\auth_service.py", line 160, in authenticate_user
    from app.core.tenant.context import get_current_tenant_context
ImportError: cannot import name 'get_current_tenant_context' from 'app.core.tenant.context' (D:\base_multi_tenant_fastapi\app\core\tenant\context.py)
2025-12-03 23:20:37,879 - app.modules.superadmin.application.services.audit_service - INFO - [AUDIT] auth_audit_log registrado: evento=login_failed, cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43, usuario_id=None, exito=False
2025-12-03 23:20:37,879 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/login/ 500 4272.3ms
2025-12-03 23:20:42,270 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Pool ADMIN inicializado. Size=10, MaxOverflow=5
2025-12-03 23:20:42,270 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Configuración de pools de tenants: MaxPools=50, PoolSize=3, MaxOverflow=2, InactivityTimeout=3600s
2025-12-03 23:20:42,270 - app.infrastructure.database.connection_pool - INFO - ✅ Módulo de connection pooling cargado y activo
2025-12-03 23:20:42,270 - app.infrastructure.database.connection_pool - INFO -    Configuración: MaxTenantPools=50, TenantPoolSize=3, InactivityTimeout=3600s
2025-12-03 23:20:42,270 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Todos los pools cerrados
2025-12-03 23:20:42,270 - app.main - INFO - ✅ Pools de conexión cerrados correctamente
2025-12-03 23:20:43,210 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 23:20:43,464 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 23:20:43,474 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 23:20:43,474 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 23:20:43,474 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 23:20:43,479 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 23:20:43,479 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 23:20:43,479 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, DEFAULT_TYPE=single
2025-12-03 23:20:43,876 - app.core.security.rate_limiting - INFO - [RATE_LIMITING] Activado. Límites: Login=10/minute, API=200/minute
2025-12-03 23:20:43,876 - app.core.security.rate_limiting - INFO - ✅ Módulo de rate limiting cargado y activo
2025-12-03 23:20:43,969 - app.core.authorization.rbac - INFO - 🔐 Inicializando sistema de autorización...
2025-12-03 23:20:43,969 - app.core.authorization.rbac - INFO - ✅ Sistema de autorización inicializado correctamente
2025-12-03 23:20:43,969 - app.core.authorization.rbac - INFO - 📊 Permisos del sistema: 6 módulos configurados
2025-12-03 23:20:44,211 - app.core.tenant.middleware - INFO - Módulo tenant_middleware cargado (versión híbrida con soporte para proxies)
2025-12-03 23:20:44,211 - app.main - INFO - ✅ Rate limiting configurado y activo
2025-12-03 23:20:44,380 - app.core.tenant.middleware - INFO - [TENANT_MW] Inicializado - BASE_DOMAIN=app.local, SYSTEM_ID=BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, EXCLUDED_SUBDOMAINS={'www', 'backend', 'static', 'api', 'cdn', 'admin', 'assets'}
2025-12-03 23:22:19,672 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Pool ADMIN inicializado. Size=10, MaxOverflow=5
2025-12-03 23:22:19,672 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Configuración de pools de tenants: MaxPools=50, PoolSize=3, MaxOverflow=2, InactivityTimeout=3600s
2025-12-03 23:22:19,673 - app.infrastructure.database.connection_pool - INFO - ✅ Módulo de connection pooling cargado y activo
2025-12-03 23:22:19,673 - app.infrastructure.database.connection_pool - INFO -    Configuración: MaxTenantPools=50, TenantPoolSize=3, InactivityTimeout=3600s
2025-12-03 23:22:19,674 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Todos los pools cerrados
2025-12-03 23:22:19,674 - app.main - INFO - ✅ Pools de conexión cerrados correctamente
2025-12-03 23:22:19,799 - asyncio - ERROR - Unclosed connection
connection: <aioodbc.connection.Connection object at 0x0000025037F86330>
2025-12-03 23:22:20,571 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 23:22:20,762 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 23:22:20,767 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 23:22:20,773 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 23:22:20,773 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 23:22:20,774 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 23:22:20,774 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 23:22:20,775 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, DEFAULT_TYPE=single
2025-12-03 23:22:21,102 - app.core.security.rate_limiting - INFO - [RATE_LIMITING] Activado. Límites: Login=10/minute, API=200/minute
2025-12-03 23:22:21,103 - app.core.security.rate_limiting - INFO - ✅ Módulo de rate limiting cargado y activo
2025-12-03 23:22:21,176 - app.core.authorization.rbac - INFO - 🔐 Inicializando sistema de autorización...
2025-12-03 23:22:21,176 - app.core.authorization.rbac - INFO - ✅ Sistema de autorización inicializado correctamente
2025-12-03 23:22:21,176 - app.core.authorization.rbac - INFO - 📊 Permisos del sistema: 6 módulos configurados
2025-12-03 23:22:21,333 - app.core.tenant.middleware - INFO - Módulo tenant_middleware cargado (versión híbrida con soporte para proxies)
2025-12-03 23:22:21,334 - app.main - INFO - ✅ Rate limiting configurado y activo
2025-12-03 23:22:21,479 - app.core.tenant.middleware - INFO - [TENANT_MW] Inicializado - BASE_DOMAIN=app.local, SYSTEM_ID=BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, EXCLUDED_SUBDOMAINS={'backend', 'static', 'assets', 'cdn', 'api', 'admin', 'www'}
2025-12-03 23:22:23,724 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Pool ADMIN inicializado. Size=10, MaxOverflow=5
2025-12-03 23:22:23,726 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Configuración de pools de tenants: MaxPools=50, PoolSize=3, MaxOverflow=2, InactivityTimeout=3600s
2025-12-03 23:22:23,726 - app.infrastructure.database.connection_pool - INFO - ✅ Módulo de connection pooling cargado y activo
2025-12-03 23:22:23,726 - app.infrastructure.database.connection_pool - INFO -    Configuración: MaxTenantPools=50, TenantPoolSize=3, InactivityTimeout=3600s
2025-12-03 23:22:23,726 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Todos los pools cerrados
2025-12-03 23:22:23,726 - app.main - INFO - ✅ Pools de conexión cerrados correctamente
2025-12-03 23:22:25,803 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 23:22:25,996 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 23:22:25,996 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 23:22:26,005 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 23:22:26,005 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 23:22:26,006 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 23:22:26,007 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 23:22:26,008 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, DEFAULT_TYPE=single
2025-12-03 23:22:26,350 - app.core.security.rate_limiting - INFO - [RATE_LIMITING] Activado. Límites: Login=10/minute, API=200/minute
2025-12-03 23:22:26,351 - app.core.security.rate_limiting - INFO - ✅ Módulo de rate limiting cargado y activo
2025-12-03 23:22:26,423 - app.core.authorization.rbac - INFO - 🔐 Inicializando sistema de autorización...
2025-12-03 23:22:26,423 - app.core.authorization.rbac - INFO - ✅ Sistema de autorización inicializado correctamente
2025-12-03 23:22:26,424 - app.core.authorization.rbac - INFO - 📊 Permisos del sistema: 6 módulos configurados
2025-12-03 23:22:26,587 - app.core.tenant.middleware - INFO - Módulo tenant_middleware cargado (versión híbrida con soporte para proxies)
2025-12-03 23:22:26,589 - app.main - INFO - ✅ Rate limiting configurado y activo
2025-12-03 23:22:26,739 - app.core.tenant.middleware - INFO - [TENANT_MW] Inicializado - BASE_DOMAIN=app.local, SYSTEM_ID=BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, EXCLUDED_SUBDOMAINS={'admin', 'api', 'assets', 'static', 'backend', 'cdn', 'www'}
2025-12-03 23:22:30,089 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/login/
2025-12-03 23:22:30,090 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 23:22:30,090 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': acme.app.local:5173
2025-12-03 23:22:30,091 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:22:30,091 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:22:30,091 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:22:30,095 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] AsyncEngine creado para admin
2025-12-03 23:22:30,232 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:22:30,232 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:22:30,232 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:22:30,232 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:22:34,336 - app.infrastructure.cache.redis_cache - WARNING - [REDIS_CACHE] Error conectando a Redis: Error 10061 connecting to localhost:6379. No se puede establecer una conexión ya que el equipo de destino denegó expresamente dicha conexión.. Cache desactivado automáticamente (usando fallback en memoria).
2025-12-03 23:22:34,336 - app.infrastructure.cache.redis_cache - INFO - ℹ️ Módulo de Redis cache cargado pero desactivado (usando fallback en memoria)
2025-12-03 23:22:34,345 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC
2025-12-03 23:22:34,346 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43, tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC, path=/api/v1/auth/login/
2025-12-03 23:22:34,355 - app.modules.auth.presentation.endpoints - INFO - Cliente ee7bfc14-995f-4209-b4b9-99c307534a43 resuelto y validado para login.
2025-12-03 23:22:34,355 - app.modules.auth.application.services.auth_service - INFO - [AUTH] Intento de login: username='admin_acme', cliente_id_destino=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:22:34,355 - app.modules.auth.application.services.auth_service - INFO - [AUTH] Usuario regular. Buscando en BD del cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:22:34,356 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] AsyncEngine creado para tenant_ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:22:34,652 - app.modules.auth.application.services.auth_service - INFO - Niveles calculados - Usuario 2458D1EA-816B-4C3C-8D13-B90271F59558: level=4, super_admin=False, type=tenant_admin
2025-12-03 23:22:34,652 - app.modules.auth.application.services.auth_service - INFO - [AUTH] Login exitoso: username='admin_acme', usuario_id=2458D1EA-816B-4C3C-8D13-B90271F59558, cliente_origen=00000000-0000-0000-0000-000000000000, cliente_destino=N/A, access_level=4, user_type=tenant_admin
2025-12-03 23:22:34,652 - app.infrastructure.database.queries_async - WARNING - [QUERY] DEPRECATED: execute_query() recibió string SQL. Migrar a SQLAlchemy Core.
2025-12-03 23:22:34,672 - app.modules.auth.application.services.auth_service - INFO - Niveles calculados - Usuario 2458D1EA-816B-4C3C-8D13-B90271F59558: level=1, super_admin=False, type=user
2025-12-03 23:22:34,686 - app.modules.auth.application.services.refresh_token_service - INFO - [STORE-TOKEN] Token insertado exitosamente - Cliente ee7bfc14-995f-4209-b4b9-99c307534a43, Usuario 2458D1EA-816B-4C3C-8D13-B90271F59558, Tipo: web, Token ID: 03EF44CD-2BAE-4E95-A340-D8F28B062AB4, Rotación: False
2025-12-03 23:22:34,686 - app.modules.auth.presentation.endpoints - INFO - [LOGIN-WEB] Token almacenado - ID: 03EF44CD-2BAE-4E95-A340-D8F28B062AB4
2025-12-03 23:22:34,686 - app.modules.auth.presentation.endpoints - INFO - Usuario admin_acme autenticado exitosamente (WEB) para cliente ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:22:34,706 - app.infrastructure.database.queries_async - ERROR - Error en execute_insert async (TextClause): (pyodbc.IntegrityError) ('23000', '[23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The INSERT statement conflicted with the FOREIGN KEY constraint "FK_audit_usuario". The conflict occurred in database "bd_hybrid_sistema_central", table "dbo.usuario", column \'usuario_id\'. (547) (SQLExecDirectW); [23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The statement has been terminated. (3621)')
[SQL: 
INSERT INTO auth_audit_log (
    cliente_id,
    usuario_id,
    evento,
    nombre_usuario_intento,
    descripcion,
    exito,
    codigo_error,
    ip_address,
    user_agent,
    device_info,
    geolocation,
    metadata_json
)
OUTPUT INSERTED.log_id, INSERTED.fecha_evento
VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);
]
[parameters: (UUID('ee7bfc14-995f-4209-b4b9-99c307534a43'), UUID('2458d1ea-816b-4c3c-8d13-b90271f59558'), 'login_success', 'admin_acme', 'Login exitoso', 1, None, '127.0.0.1', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36', None, None, '{"client_type": "web", "es_superadmin": false, "auth_method": "password"}')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-12-03 23:22:34,708 - app.infrastructure.database.connection_async - ERROR - [ASYNC_CONNECTION] Error en sesión async: Error en la inserción: (pyodbc.IntegrityError) ('23000', '[23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The INSERT statement conflicted with the FOREIGN KEY constraint "FK_audit_usuario". The conflict occurred in database "bd_hybrid_sistema_central", table "dbo.usuario", column \'usuario_id\'. (547) (SQLExecDirectW); [23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The statement has been terminated. (3621)')
[SQL: 
INSERT INTO auth_audit_log (
    cliente_id,
    usuario_id,
    evento,
    nombre_usuario_intento,
    descripcion,
    exito,
    codigo_error,
    ip_address,
    user_agent,
    device_info,
    geolocation,
    metadata_json
)
OUTPUT INSERTED.log_id, INSERTED.fecha_evento
VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);
]
[parameters: (UUID('ee7bfc14-995f-4209-b4b9-99c307534a43'), UUID('2458d1ea-816b-4c3c-8d13-b90271f59558'), 'login_success', 'admin_acme', 'Login exitoso', 1, None, '127.0.0.1', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36', None, None, '{"client_type": "web", "es_superadmin": false, "auth_method": "password"}')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 230, in execute
    self._adapt_connection._handle_exception(error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 368, in _handle_exception
    raise error.with_traceback(exc_info[2])
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 228, in execute
    return self.await_(self._execute_async(operation, parameters))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 251, in _execute_async
    result = await self._cursor.execute(operation, parameters)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 132, in execute
    await self._run_operation(self._impl.execute, sql, *params)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 30, in _run_operation
    result = await self._conn._execute(func, *args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\concurrent\futures\thread.py", line 59, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
pyodbc.IntegrityError: ('23000', '[23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The INSERT statement conflicted with the FOREIGN KEY constraint "FK_audit_usuario". The conflict occurred in database "bd_hybrid_sistema_central", table "dbo.usuario", column \'usuario_id\'. (547) (SQLExecDirectW); [23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The statement has been terminated. (3621)')

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 366, in execute_insert
    result = await session.execute(query)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 449, in execute
    result = await greenlet_spawn(
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 203, in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2351, in execute
    return self._execute_internal(
           ^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2258, in _execute_internal
    result = conn.execute(
             ^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1419, in execute
    return meth(
           ^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\sql\elements.py", line 526, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1641, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1846, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1986, in _exec_single_context
    self._handle_dbapi_exception(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 2355, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 230, in execute
    self._adapt_connection._handle_exception(error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 368, in _handle_exception
    raise error.with_traceback(exc_info[2])
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 228, in execute
    return self.await_(self._execute_async(operation, parameters))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 251, in _execute_async
    result = await self._cursor.execute(operation, parameters)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 132, in execute
    await self._run_operation(self._impl.execute, sql, *params)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 30, in _run_operation
    result = await self._conn._execute(func, *args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\concurrent\futures\thread.py", line 59, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
sqlalchemy.exc.IntegrityError: (pyodbc.IntegrityError) ('23000', '[23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The INSERT statement conflicted with the FOREIGN KEY constraint "FK_audit_usuario". The conflict occurred in database "bd_hybrid_sistema_central", table "dbo.usuario", column \'usuario_id\'. (547) (SQLExecDirectW); [23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The statement has been terminated. (3621)')
[SQL: 
INSERT INTO auth_audit_log (
    cliente_id,
    usuario_id,
    evento,
    nombre_usuario_intento,
    descripcion,
    exito,
    codigo_error,
    ip_address,
    user_agent,
    device_info,
    geolocation,
    metadata_json
)
OUTPUT INSERTED.log_id, INSERTED.fecha_evento
VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);
]
[parameters: (UUID('ee7bfc14-995f-4209-b4b9-99c307534a43'), UUID('2458d1ea-816b-4c3c-8d13-b90271f59558'), 'login_success', 'admin_acme', 'Login exitoso', 1, None, '127.0.0.1', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36', None, None, '{"client_type": "web", "es_superadmin": false, "auth_method": "password"}')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\connection_async.py", line 326, in get_db_connection
    yield session
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 382, in execute_insert
    raise DatabaseError(
app.core.exceptions.DatabaseError: Error en la inserción: (pyodbc.IntegrityError) ('23000', '[23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The INSERT statement conflicted with the FOREIGN KEY constraint "FK_audit_usuario". The conflict occurred in database "bd_hybrid_sistema_central", table "dbo.usuario", column \'usuario_id\'. (547) (SQLExecDirectW); [23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The statement has been terminated. (3621)')
[SQL: 
INSERT INTO auth_audit_log (
    cliente_id,
    usuario_id,
    evento,
    nombre_usuario_intento,
    descripcion,
    exito,
    codigo_error,
    ip_address,
    user_agent,
    device_info,
    geolocation,
    metadata_json
)
OUTPUT INSERTED.log_id, INSERTED.fecha_evento
VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);
]
[parameters: (UUID('ee7bfc14-995f-4209-b4b9-99c307534a43'), UUID('2458d1ea-816b-4c3c-8d13-b90271f59558'), 'login_success', 'admin_acme', 'Login exitoso', 1, None, '127.0.0.1', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36', None, None, '{"client_type": "web", "es_superadmin": false, "auth_method": "password"}')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-12-03 23:22:34,800 - app.core.application.base_service - ERROR - DatabaseError en registrar_auth_event: Error en la inserción: (pyodbc.IntegrityError) ('23000', '[23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The INSERT statement conflicted with the FOREIGN KEY constraint "FK_audit_usuario". The conflict occurred in database "bd_hybrid_sistema_central", table "dbo.usuario", column \'usuario_id\'. (547) (SQLExecDirectW); [23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The statement has been terminated. (3621)')
[SQL: 
INSERT INTO auth_audit_log (
    cliente_id,
    usuario_id,
    evento,
    nombre_usuario_intento,
    descripcion,
    exito,
    codigo_error,
    ip_address,
    user_agent,
    device_info,
    geolocation,
    metadata_json
)
OUTPUT INSERTED.log_id, INSERTED.fecha_evento
VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);
]
[parameters: (UUID('ee7bfc14-995f-4209-b4b9-99c307534a43'), UUID('2458d1ea-816b-4c3c-8d13-b90271f59558'), 'login_success', 'admin_acme', 'Login exitoso', 1, None, '127.0.0.1', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36', None, None, '{"client_type": "web", "es_superadmin": false, "auth_method": "password"}')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 230, in execute
    self._adapt_connection._handle_exception(error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 368, in _handle_exception
    raise error.with_traceback(exc_info[2])
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 228, in execute
    return self.await_(self._execute_async(operation, parameters))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 251, in _execute_async
    result = await self._cursor.execute(operation, parameters)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 132, in execute
    await self._run_operation(self._impl.execute, sql, *params)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 30, in _run_operation
    result = await self._conn._execute(func, *args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\concurrent\futures\thread.py", line 59, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
pyodbc.IntegrityError: ('23000', '[23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The INSERT statement conflicted with the FOREIGN KEY constraint "FK_audit_usuario". The conflict occurred in database "bd_hybrid_sistema_central", table "dbo.usuario", column \'usuario_id\'. (547) (SQLExecDirectW); [23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The statement has been terminated. (3621)')

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 366, in execute_insert
    result = await session.execute(query)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 449, in execute
    result = await greenlet_spawn(
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 203, in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2351, in execute
    return self._execute_internal(
           ^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2258, in _execute_internal
    result = conn.execute(
             ^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1419, in execute
    return meth(
           ^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\sql\elements.py", line 526, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1641, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1846, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1986, in _exec_single_context
    self._handle_dbapi_exception(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 2355, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 230, in execute
    self._adapt_connection._handle_exception(error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 368, in _handle_exception
    raise error.with_traceback(exc_info[2])
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 228, in execute
    return self.await_(self._execute_async(operation, parameters))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 251, in _execute_async
    result = await self._cursor.execute(operation, parameters)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 132, in execute
    await self._run_operation(self._impl.execute, sql, *params)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 30, in _run_operation
    result = await self._conn._execute(func, *args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\concurrent\futures\thread.py", line 59, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
sqlalchemy.exc.IntegrityError: (pyodbc.IntegrityError) ('23000', '[23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The INSERT statement conflicted with the FOREIGN KEY constraint "FK_audit_usuario". The conflict occurred in database "bd_hybrid_sistema_central", table "dbo.usuario", column \'usuario_id\'. (547) (SQLExecDirectW); [23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The statement has been terminated. (3621)')
[SQL: 
INSERT INTO auth_audit_log (
    cliente_id,
    usuario_id,
    evento,
    nombre_usuario_intento,
    descripcion,
    exito,
    codigo_error,
    ip_address,
    user_agent,
    device_info,
    geolocation,
    metadata_json
)
OUTPUT INSERTED.log_id, INSERTED.fecha_evento
VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);
]
[parameters: (UUID('ee7bfc14-995f-4209-b4b9-99c307534a43'), UUID('2458d1ea-816b-4c3c-8d13-b90271f59558'), 'login_success', 'admin_acme', 'Login exitoso', 1, None, '127.0.0.1', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36', None, None, '{"client_type": "web", "es_superadmin": false, "auth_method": "password"}')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\core\application\base_service.py", line 52, in wrapper
    return await func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\modules\superadmin\application\services\audit_service.py", line 130, in registrar_auth_event
    result = await execute_insert(
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 382, in execute_insert
    raise DatabaseError(
app.core.exceptions.DatabaseError: Error en la inserción: (pyodbc.IntegrityError) ('23000', '[23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The INSERT statement conflicted with the FOREIGN KEY constraint "FK_audit_usuario". The conflict occurred in database "bd_hybrid_sistema_central", table "dbo.usuario", column \'usuario_id\'. (547) (SQLExecDirectW); [23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The statement has been terminated. (3621)')
[SQL: 
INSERT INTO auth_audit_log (
    cliente_id,
    usuario_id,
    evento,
    nombre_usuario_intento,
    descripcion,
    exito,
    codigo_error,
    ip_address,
    user_agent,
    device_info,
    geolocation,
    metadata_json
)
OUTPUT INSERTED.log_id, INSERTED.fecha_evento
VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);
]
[parameters: (UUID('ee7bfc14-995f-4209-b4b9-99c307534a43'), UUID('2458d1ea-816b-4c3c-8d13-b90271f59558'), 'login_success', 'admin_acme', 'Login exitoso', 1, None, '127.0.0.1', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36', None, None, '{"client_type": "web", "es_superadmin": false, "auth_method": "password"}')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-12-03 23:22:34,803 - app.modules.auth.presentation.endpoints - ERROR - [AUDIT] Error registrando evento login_success (no crítico)
Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 230, in execute
    self._adapt_connection._handle_exception(error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 368, in _handle_exception
    raise error.with_traceback(exc_info[2])
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 228, in execute
    return self.await_(self._execute_async(operation, parameters))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 251, in _execute_async
    result = await self._cursor.execute(operation, parameters)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 132, in execute
    await self._run_operation(self._impl.execute, sql, *params)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 30, in _run_operation
    result = await self._conn._execute(func, *args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\concurrent\futures\thread.py", line 59, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
pyodbc.IntegrityError: ('23000', '[23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The INSERT statement conflicted with the FOREIGN KEY constraint "FK_audit_usuario". The conflict occurred in database "bd_hybrid_sistema_central", table "dbo.usuario", column \'usuario_id\'. (547) (SQLExecDirectW); [23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The statement has been terminated. (3621)')

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 366, in execute_insert
    result = await session.execute(query)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 449, in execute
    result = await greenlet_spawn(
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 203, in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2351, in execute
    return self._execute_internal(
           ^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2258, in _execute_internal
    result = conn.execute(
             ^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1419, in execute
    return meth(
           ^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\sql\elements.py", line 526, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1641, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1846, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1986, in _exec_single_context
    self._handle_dbapi_exception(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 2355, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 230, in execute
    self._adapt_connection._handle_exception(error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 368, in _handle_exception
    raise error.with_traceback(exc_info[2])
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 228, in execute
    return self.await_(self._execute_async(operation, parameters))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 251, in _execute_async
    result = await self._cursor.execute(operation, parameters)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 132, in execute
    await self._run_operation(self._impl.execute, sql, *params)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 30, in _run_operation
    result = await self._conn._execute(func, *args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\concurrent\futures\thread.py", line 59, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
sqlalchemy.exc.IntegrityError: (pyodbc.IntegrityError) ('23000', '[23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The INSERT statement conflicted with the FOREIGN KEY constraint "FK_audit_usuario". The conflict occurred in database "bd_hybrid_sistema_central", table "dbo.usuario", column \'usuario_id\'. (547) (SQLExecDirectW); [23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The statement has been terminated. (3621)')
[SQL: 
INSERT INTO auth_audit_log (
    cliente_id,
    usuario_id,
    evento,
    nombre_usuario_intento,
    descripcion,
    exito,
    codigo_error,
    ip_address,
    user_agent,
    device_info,
    geolocation,
    metadata_json
)
OUTPUT INSERTED.log_id, INSERTED.fecha_evento
VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);
]
[parameters: (UUID('ee7bfc14-995f-4209-b4b9-99c307534a43'), UUID('2458d1ea-816b-4c3c-8d13-b90271f59558'), 'login_success', 'admin_acme', 'Login exitoso', 1, None, '127.0.0.1', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36', None, None, '{"client_type": "web", "es_superadmin": false, "auth_method": "password"}')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\modules\auth\presentation\endpoints.py", line 255, in login
    await AuditService.registrar_auth_event(
  File "D:\base_multi_tenant_fastapi\app\core\application\base_service.py", line 52, in wrapper
    return await func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\modules\superadmin\application\services\audit_service.py", line 130, in registrar_auth_event
    result = await execute_insert(
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 382, in execute_insert
    raise DatabaseError(
app.core.exceptions.DatabaseError: Error en la inserción: (pyodbc.IntegrityError) ('23000', '[23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The INSERT statement conflicted with the FOREIGN KEY constraint "FK_audit_usuario". The conflict occurred in database "bd_hybrid_sistema_central", table "dbo.usuario", column \'usuario_id\'. (547) (SQLExecDirectW); [23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The statement has been terminated. (3621)')
[SQL: 
INSERT INTO auth_audit_log (
    cliente_id,
    usuario_id,
    evento,
    nombre_usuario_intento,
    descripcion,
    exito,
    codigo_error,
    ip_address,
    user_agent,
    device_info,
    geolocation,
    metadata_json
)
OUTPUT INSERTED.log_id, INSERTED.fecha_evento
VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);
]
[parameters: (UUID('ee7bfc14-995f-4209-b4b9-99c307534a43'), UUID('2458d1ea-816b-4c3c-8d13-b90271f59558'), 'login_success', 'admin_acme', 'Login exitoso', 1, None, '127.0.0.1', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36', None, None, '{"client_type": "web", "es_superadmin": false, "auth_method": "password"}')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-12-03 23:22:34,809 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/login/ 200 4720.3ms
2025-12-03 23:22:34,824 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/clientes/tenant/branding
2025-12-03 23:22:34,824 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/clientes/tenant/branding 200 1.1ms
2025-12-03 23:22:34,827 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/clientes/tenant/branding
2025-12-03 23:22:34,828 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 23:22:34,829 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': acme.app.local:5173
2025-12-03 23:22:34,829 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:22:34,829 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:22:34,830 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:22:34,837 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:22:34,838 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:22:34,838 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:22:34,844 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:22:34,844 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC
2025-12-03 23:22:34,846 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43, tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC, path=/api/v1/clientes/tenant/branding
2025-12-03 23:22:34,855 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/menus/getmenu/
2025-12-03 23:22:34,857 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/menus/getmenu/ 200 2.4ms
2025-12-03 23:22:34,858 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/menus/getmenu/
2025-12-03 23:22:34,860 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/areas/
2025-12-03 23:22:34,860 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/areas/
2025-12-03 23:22:34,861 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/menus/getmenu/ 200 4.3ms
2025-12-03 23:22:34,863 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/areas/ 200 3.7ms
2025-12-03 23:22:34,864 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/areas/ 200 3.5ms
2025-12-03 23:22:34,869 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/menus/getmenu/
2025-12-03 23:22:34,870 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 23:22:34,872 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': acme.app.local:5173
2025-12-03 23:22:34,873 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:22:34,873 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:22:34,874 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:22:34,876 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/areas/
2025-12-03 23:22:34,878 - app.core.auth.user_context - WARNING - Usuario 'admin_acme' no encontrado en BD
2025-12-03 23:22:34,878 - app.api.deps - WARNING - Usuario 'admin_acme' no encontrado o inactivo
2025-12-03 23:22:34,879 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 23:22:34,880 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': acme.app.local:5173
2025-12-03 23:22:34,880 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:22:34,881 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:22:34,881 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:22:34,884 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/clientes/tenant/branding 401 56.7ms
2025-12-03 23:22:34,890 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/refresh/
2025-12-03 23:22:34,891 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 23:22:34,893 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': acme.app.local:5173
2025-12-03 23:22:34,893 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:22:34,894 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:22:34,894 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:22:34,896 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:22:34,897 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:22:34,897 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:22:34,901 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:22:34,902 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:22:34,903 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:22:34,908 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:22:34,909 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:22:34,910 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:22:34,913 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:22:34,914 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC
2025-12-03 23:22:34,915 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43, tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC, path=/api/v1/menus/getmenu/
2025-12-03 23:22:34,918 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:22:34,918 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC
2025-12-03 23:22:34,919 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43, tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC, path=/api/v1/areas/
2025-12-03 23:22:34,925 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:22:34,925 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC
2025-12-03 23:22:34,925 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43, tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC, path=/api/v1/auth/refresh/
2025-12-03 23:22:34,927 - app.core.auth.user_context - WARNING - Usuario 'admin_acme' no encontrado en BD
2025-12-03 23:22:34,927 - app.api.deps - WARNING - Usuario 'admin_acme' no encontrado o inactivo
2025-12-03 23:22:34,928 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/menus/getmenu/ 401 62.8ms
2025-12-03 23:22:34,935 - app.core.auth.user_context - WARNING - Usuario 'admin_acme' no encontrado en BD
2025-12-03 23:22:34,935 - app.api.deps - WARNING - Usuario 'admin_acme' no encontrado o inactivo
2025-12-03 23:22:34,936 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/menus/getmenu/
2025-12-03 23:22:34,937 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 23:22:34,939 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': acme.app.local:5173
2025-12-03 23:22:34,939 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:22:34,939 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:22:34,941 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:22:34,943 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/areas/ 401 66.2ms
2025-12-03 23:22:34,945 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/areas/
2025-12-03 23:22:34,946 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 23:22:34,946 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': acme.app.local:5173
2025-12-03 23:22:34,948 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:22:34,948 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:22:34,949 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:22:34,952 - app.modules.auth.application.services.refresh_token_service - INFO - [VALIDATE-TOKEN] Token válido - Cliente EE7BFC14-995F-4209-B4B9-99C307534A43, Usuario 2458D1EA-816B-4C3C-8D13-B90271F59558, Tipo: web
2025-12-03 23:22:34,957 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:22:34,957 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:22:34,958 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:22:34,961 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:22:34,962 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:22:34,962 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:22:34,967 - app.modules.auth.application.services.auth_service - INFO - [REFRESH] Token validado exitosamente (BD OK) para usuario: admin_acme (Cliente: 00000000-0000-0000-0000-000000000000, Level: 1, Type: user)
2025-12-03 23:22:34,970 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:22:34,970 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC
2025-12-03 23:22:34,971 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43, tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC, path=/api/v1/menus/getmenu/
2025-12-03 23:22:34,973 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:22:34,973 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC
2025-12-03 23:22:34,976 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43, tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC, path=/api/v1/areas/
2025-12-03 23:22:34,979 - app.modules.auth.application.services.auth_service - INFO - Niveles calculados - Usuario 2458D1EA-816B-4C3C-8D13-B90271F59558: level=4, super_admin=False, type=tenant_admin
2025-12-03 23:22:34,981 - app.core.auth.user_context - WARNING - Usuario 'admin_acme' no encontrado en BD
2025-12-03 23:22:34,982 - app.api.deps - WARNING - Usuario 'admin_acme' no encontrado o inactivo
2025-12-03 23:22:34,982 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/menus/getmenu/ 401 46.7ms
2025-12-03 23:22:34,986 - app.core.auth.user_context - WARNING - Usuario 'admin_acme' no encontrado en BD
2025-12-03 23:22:34,986 - app.api.deps - WARNING - Usuario 'admin_acme' no encontrado o inactivo
2025-12-03 23:22:34,987 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/areas/ 401 42.3ms
2025-12-03 23:22:34,996 - app.modules.auth.application.services.refresh_token_service - INFO - [STORE-TOKEN] Token insertado exitosamente - Cliente 00000000-0000-0000-0000-000000000000, Usuario 2458D1EA-816B-4C3C-8D13-B90271F59558, Tipo: web, Token ID: FAAF209F-6186-4B2C-B261-539D78C32D56, Rotación: True
2025-12-03 23:22:35,005 - app.modules.auth.application.services.refresh_token_service - WARNING - [REVOKE-TOKEN] Token no encontrado o ya revocado - Cliente 00000000-0000-0000-0000-000000000000, Usuario 2458D1EA-816B-4C3C-8D13-B90271F59558
2025-12-03 23:22:35,005 - app.modules.auth.presentation.endpoints - WARNING - [REFRESH] Token antiguo no encontrado para revocar (no crítico)
2025-12-03 23:22:35,006 - app.modules.auth.presentation.endpoints - INFO - [REFRESH-WEB] Token rotado exitosamente - ID: FAAF209F-6186-4B2C-B261-539D78C32D56
2025-12-03 23:22:35,006 - app.modules.auth.presentation.endpoints - INFO - [REFRESH-WEB] Token refrescado exitosamente - Usuario: admin_acme
2025-12-03 23:22:35,011 - app.infrastructure.database.queries_async - ERROR - Error en execute_insert async (TextClause): (pyodbc.IntegrityError) ('23000', '[23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The INSERT statement conflicted with the FOREIGN KEY constraint "FK_audit_cliente". The conflict occurred in database "bd_hybrid_sistema_central", table "dbo.cliente", column \'cliente_id\'. (547) (SQLExecDirectW); [23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The statement has been terminated. (3621)')
[SQL: 
INSERT INTO auth_audit_log (
    cliente_id,
    usuario_id,
    evento,
    nombre_usuario_intento,
    descripcion,
    exito,
    codigo_error,
    ip_address,
    user_agent,
    device_info,
    geolocation,
    metadata_json
)
OUTPUT INSERTED.log_id, INSERTED.fecha_evento
VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);
]
[parameters: (UUID('00000000-0000-0000-0000-000000000000'), UUID('2458d1ea-816b-4c3c-8d13-b90271f59558'), 'token_refresh', 'admin_acme', 'Refresh de token exitoso', 1, None, '127.0.0.1', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36', None, None, '{"client_type": "web"}')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-12-03 23:22:35,011 - app.infrastructure.database.connection_async - ERROR - [ASYNC_CONNECTION] Error en sesión async: Error en la inserción: (pyodbc.IntegrityError) ('23000', '[23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The INSERT statement conflicted with the FOREIGN KEY constraint "FK_audit_cliente". The conflict occurred in database "bd_hybrid_sistema_central", table "dbo.cliente", column \'cliente_id\'. (547) (SQLExecDirectW); [23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The statement has been terminated. (3621)')
[SQL: 
INSERT INTO auth_audit_log (
    cliente_id,
    usuario_id,
    evento,
    nombre_usuario_intento,
    descripcion,
    exito,
    codigo_error,
    ip_address,
    user_agent,
    device_info,
    geolocation,
    metadata_json
)
OUTPUT INSERTED.log_id, INSERTED.fecha_evento
VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);
]
[parameters: (UUID('00000000-0000-0000-0000-000000000000'), UUID('2458d1ea-816b-4c3c-8d13-b90271f59558'), 'token_refresh', 'admin_acme', 'Refresh de token exitoso', 1, None, '127.0.0.1', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36', None, None, '{"client_type": "web"}')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 230, in execute
    self._adapt_connection._handle_exception(error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 368, in _handle_exception
    raise error.with_traceback(exc_info[2])
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 228, in execute
    return self.await_(self._execute_async(operation, parameters))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 251, in _execute_async
    result = await self._cursor.execute(operation, parameters)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 132, in execute
    await self._run_operation(self._impl.execute, sql, *params)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 30, in _run_operation
    result = await self._conn._execute(func, *args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\concurrent\futures\thread.py", line 59, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
pyodbc.IntegrityError: ('23000', '[23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The INSERT statement conflicted with the FOREIGN KEY constraint "FK_audit_cliente". The conflict occurred in database "bd_hybrid_sistema_central", table "dbo.cliente", column \'cliente_id\'. (547) (SQLExecDirectW); [23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The statement has been terminated. (3621)')

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 366, in execute_insert
    result = await session.execute(query)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 449, in execute
    result = await greenlet_spawn(
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 203, in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2351, in execute
    return self._execute_internal(
           ^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2258, in _execute_internal
    result = conn.execute(
             ^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1419, in execute
    return meth(
           ^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\sql\elements.py", line 526, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1641, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1846, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1986, in _exec_single_context
    self._handle_dbapi_exception(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 2355, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 230, in execute
    self._adapt_connection._handle_exception(error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 368, in _handle_exception
    raise error.with_traceback(exc_info[2])
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 228, in execute
    return self.await_(self._execute_async(operation, parameters))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 251, in _execute_async
    result = await self._cursor.execute(operation, parameters)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 132, in execute
    await self._run_operation(self._impl.execute, sql, *params)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 30, in _run_operation
    result = await self._conn._execute(func, *args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\concurrent\futures\thread.py", line 59, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
sqlalchemy.exc.IntegrityError: (pyodbc.IntegrityError) ('23000', '[23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The INSERT statement conflicted with the FOREIGN KEY constraint "FK_audit_cliente". The conflict occurred in database "bd_hybrid_sistema_central", table "dbo.cliente", column \'cliente_id\'. (547) (SQLExecDirectW); [23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The statement has been terminated. (3621)')
[SQL: 
INSERT INTO auth_audit_log (
    cliente_id,
    usuario_id,
    evento,
    nombre_usuario_intento,
    descripcion,
    exito,
    codigo_error,
    ip_address,
    user_agent,
    device_info,
    geolocation,
    metadata_json
)
OUTPUT INSERTED.log_id, INSERTED.fecha_evento
VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);
]
[parameters: (UUID('00000000-0000-0000-0000-000000000000'), UUID('2458d1ea-816b-4c3c-8d13-b90271f59558'), 'token_refresh', 'admin_acme', 'Refresh de token exitoso', 1, None, '127.0.0.1', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36', None, None, '{"client_type": "web"}')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\connection_async.py", line 326, in get_db_connection
    yield session
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 382, in execute_insert
    raise DatabaseError(
app.core.exceptions.DatabaseError: Error en la inserción: (pyodbc.IntegrityError) ('23000', '[23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The INSERT statement conflicted with the FOREIGN KEY constraint "FK_audit_cliente". The conflict occurred in database "bd_hybrid_sistema_central", table "dbo.cliente", column \'cliente_id\'. (547) (SQLExecDirectW); [23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The statement has been terminated. (3621)')
[SQL: 
INSERT INTO auth_audit_log (
    cliente_id,
    usuario_id,
    evento,
    nombre_usuario_intento,
    descripcion,
    exito,
    codigo_error,
    ip_address,
    user_agent,
    device_info,
    geolocation,
    metadata_json
)
OUTPUT INSERTED.log_id, INSERTED.fecha_evento
VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);
]
[parameters: (UUID('00000000-0000-0000-0000-000000000000'), UUID('2458d1ea-816b-4c3c-8d13-b90271f59558'), 'token_refresh', 'admin_acme', 'Refresh de token exitoso', 1, None, '127.0.0.1', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36', None, None, '{"client_type": "web"}')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-12-03 23:22:35,020 - app.core.application.base_service - ERROR - DatabaseError en registrar_auth_event: Error en la inserción: (pyodbc.IntegrityError) ('23000', '[23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The INSERT statement conflicted with the FOREIGN KEY constraint "FK_audit_cliente". The conflict occurred in database "bd_hybrid_sistema_central", table "dbo.cliente", column \'cliente_id\'. (547) (SQLExecDirectW); [23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The statement has been terminated. (3621)')
[SQL: 
INSERT INTO auth_audit_log (
    cliente_id,
    usuario_id,
    evento,
    nombre_usuario_intento,
    descripcion,
    exito,
    codigo_error,
    ip_address,
    user_agent,
    device_info,
    geolocation,
    metadata_json
)
OUTPUT INSERTED.log_id, INSERTED.fecha_evento
VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);
]
[parameters: (UUID('00000000-0000-0000-0000-000000000000'), UUID('2458d1ea-816b-4c3c-8d13-b90271f59558'), 'token_refresh', 'admin_acme', 'Refresh de token exitoso', 1, None, '127.0.0.1', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36', None, None, '{"client_type": "web"}')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 230, in execute
    self._adapt_connection._handle_exception(error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 368, in _handle_exception
    raise error.with_traceback(exc_info[2])
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 228, in execute
    return self.await_(self._execute_async(operation, parameters))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 251, in _execute_async
    result = await self._cursor.execute(operation, parameters)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 132, in execute
    await self._run_operation(self._impl.execute, sql, *params)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 30, in _run_operation
    result = await self._conn._execute(func, *args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\concurrent\futures\thread.py", line 59, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
pyodbc.IntegrityError: ('23000', '[23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The INSERT statement conflicted with the FOREIGN KEY constraint "FK_audit_cliente". The conflict occurred in database "bd_hybrid_sistema_central", table "dbo.cliente", column \'cliente_id\'. (547) (SQLExecDirectW); [23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The statement has been terminated. (3621)')

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 366, in execute_insert
    result = await session.execute(query)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 449, in execute
    result = await greenlet_spawn(
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 203, in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2351, in execute
    return self._execute_internal(
           ^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2258, in _execute_internal
    result = conn.execute(
             ^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1419, in execute
    return meth(
           ^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\sql\elements.py", line 526, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1641, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1846, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1986, in _exec_single_context
    self._handle_dbapi_exception(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 2355, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 230, in execute
    self._adapt_connection._handle_exception(error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 368, in _handle_exception
    raise error.with_traceback(exc_info[2])
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 228, in execute
    return self.await_(self._execute_async(operation, parameters))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 251, in _execute_async
    result = await self._cursor.execute(operation, parameters)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 132, in execute
    await self._run_operation(self._impl.execute, sql, *params)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 30, in _run_operation
    result = await self._conn._execute(func, *args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\concurrent\futures\thread.py", line 59, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
sqlalchemy.exc.IntegrityError: (pyodbc.IntegrityError) ('23000', '[23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The INSERT statement conflicted with the FOREIGN KEY constraint "FK_audit_cliente". The conflict occurred in database "bd_hybrid_sistema_central", table "dbo.cliente", column \'cliente_id\'. (547) (SQLExecDirectW); [23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The statement has been terminated. (3621)')
[SQL: 
INSERT INTO auth_audit_log (
    cliente_id,
    usuario_id,
    evento,
    nombre_usuario_intento,
    descripcion,
    exito,
    codigo_error,
    ip_address,
    user_agent,
    device_info,
    geolocation,
    metadata_json
)
OUTPUT INSERTED.log_id, INSERTED.fecha_evento
VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);
]
[parameters: (UUID('00000000-0000-0000-0000-000000000000'), UUID('2458d1ea-816b-4c3c-8d13-b90271f59558'), 'token_refresh', 'admin_acme', 'Refresh de token exitoso', 1, None, '127.0.0.1', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36', None, None, '{"client_type": "web"}')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\core\application\base_service.py", line 52, in wrapper
    return await func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\modules\superadmin\application\services\audit_service.py", line 130, in registrar_auth_event
    result = await execute_insert(
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 382, in execute_insert
    raise DatabaseError(
app.core.exceptions.DatabaseError: Error en la inserción: (pyodbc.IntegrityError) ('23000', '[23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The INSERT statement conflicted with the FOREIGN KEY constraint "FK_audit_cliente". The conflict occurred in database "bd_hybrid_sistema_central", table "dbo.cliente", column \'cliente_id\'. (547) (SQLExecDirectW); [23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The statement has been terminated. (3621)')
[SQL: 
INSERT INTO auth_audit_log (
    cliente_id,
    usuario_id,
    evento,
    nombre_usuario_intento,
    descripcion,
    exito,
    codigo_error,
    ip_address,
    user_agent,
    device_info,
    geolocation,
    metadata_json
)
OUTPUT INSERTED.log_id, INSERTED.fecha_evento
VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);
]
[parameters: (UUID('00000000-0000-0000-0000-000000000000'), UUID('2458d1ea-816b-4c3c-8d13-b90271f59558'), 'token_refresh', 'admin_acme', 'Refresh de token exitoso', 1, None, '127.0.0.1', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36', None, None, '{"client_type": "web"}')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-12-03 23:22:35,025 - app.modules.auth.presentation.endpoints - ERROR - [AUDIT] Error registrando evento token_refresh (no crítico)
Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 230, in execute
    self._adapt_connection._handle_exception(error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 368, in _handle_exception
    raise error.with_traceback(exc_info[2])
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 228, in execute
    return self.await_(self._execute_async(operation, parameters))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 251, in _execute_async
    result = await self._cursor.execute(operation, parameters)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 132, in execute
    await self._run_operation(self._impl.execute, sql, *params)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 30, in _run_operation
    result = await self._conn._execute(func, *args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\concurrent\futures\thread.py", line 59, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
pyodbc.IntegrityError: ('23000', '[23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The INSERT statement conflicted with the FOREIGN KEY constraint "FK_audit_cliente". The conflict occurred in database "bd_hybrid_sistema_central", table "dbo.cliente", column \'cliente_id\'. (547) (SQLExecDirectW); [23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The statement has been terminated. (3621)')

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 366, in execute_insert
    result = await session.execute(query)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 449, in execute
    result = await greenlet_spawn(
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 203, in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2351, in execute
    return self._execute_internal(
           ^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2258, in _execute_internal
    result = conn.execute(
             ^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1419, in execute
    return meth(
           ^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\sql\elements.py", line 526, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1641, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1846, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1986, in _exec_single_context
    self._handle_dbapi_exception(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 2355, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 230, in execute
    self._adapt_connection._handle_exception(error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 368, in _handle_exception
    raise error.with_traceback(exc_info[2])
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 228, in execute
    return self.await_(self._execute_async(operation, parameters))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 251, in _execute_async
    result = await self._cursor.execute(operation, parameters)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 132, in execute
    await self._run_operation(self._impl.execute, sql, *params)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 30, in _run_operation
    result = await self._conn._execute(func, *args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\concurrent\futures\thread.py", line 59, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
sqlalchemy.exc.IntegrityError: (pyodbc.IntegrityError) ('23000', '[23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The INSERT statement conflicted with the FOREIGN KEY constraint "FK_audit_cliente". The conflict occurred in database "bd_hybrid_sistema_central", table "dbo.cliente", column \'cliente_id\'. (547) (SQLExecDirectW); [23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The statement has been terminated. (3621)')
[SQL: 
INSERT INTO auth_audit_log (
    cliente_id,
    usuario_id,
    evento,
    nombre_usuario_intento,
    descripcion,
    exito,
    codigo_error,
    ip_address,
    user_agent,
    device_info,
    geolocation,
    metadata_json
)
OUTPUT INSERTED.log_id, INSERTED.fecha_evento
VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);
]
[parameters: (UUID('00000000-0000-0000-0000-000000000000'), UUID('2458d1ea-816b-4c3c-8d13-b90271f59558'), 'token_refresh', 'admin_acme', 'Refresh de token exitoso', 1, None, '127.0.0.1', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36', None, None, '{"client_type": "web"}')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\modules\auth\presentation\endpoints.py", line 503, in refresh_access_token
    await AuditService.registrar_auth_event(
  File "D:\base_multi_tenant_fastapi\app\core\application\base_service.py", line 52, in wrapper
    return await func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\modules\superadmin\application\services\audit_service.py", line 130, in registrar_auth_event
    result = await execute_insert(
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 382, in execute_insert
    raise DatabaseError(
app.core.exceptions.DatabaseError: Error en la inserción: (pyodbc.IntegrityError) ('23000', '[23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The INSERT statement conflicted with the FOREIGN KEY constraint "FK_audit_cliente". The conflict occurred in database "bd_hybrid_sistema_central", table "dbo.cliente", column \'cliente_id\'. (547) (SQLExecDirectW); [23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The statement has been terminated. (3621)')
[SQL: 
INSERT INTO auth_audit_log (
    cliente_id,
    usuario_id,
    evento,
    nombre_usuario_intento,
    descripcion,
    exito,
    codigo_error,
    ip_address,
    user_agent,
    device_info,
    geolocation,
    metadata_json
)
OUTPUT INSERTED.log_id, INSERTED.fecha_evento
VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);
]
[parameters: (UUID('00000000-0000-0000-0000-000000000000'), UUID('2458d1ea-816b-4c3c-8d13-b90271f59558'), 'token_refresh', 'admin_acme', 'Refresh de token exitoso', 1, None, '127.0.0.1', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36', None, None, '{"client_type": "web"}')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-12-03 23:22:35,027 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/refresh/ 200 139.6ms
2025-12-03 23:22:35,034 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/menus/getmenu/
2025-12-03 23:22:35,036 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/areas/
2025-12-03 23:22:35,036 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 23:22:35,037 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': acme.app.local:5173
2025-12-03 23:22:35,037 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:22:35,039 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:22:35,039 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:22:35,042 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 23:22:35,043 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': acme.app.local:5173
2025-12-03 23:22:35,044 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:22:35,044 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:22:35,045 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:22:35,047 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/clientes/tenant/branding
2025-12-03 23:22:35,048 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 23:22:35,048 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': acme.app.local:5173
2025-12-03 23:22:35,049 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:22:35,049 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:22:35,050 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:22:35,056 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:22:35,057 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:22:35,058 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:22:35,059 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:22:35,060 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:22:35,060 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:22:35,061 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:22:35,061 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:22:35,061 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:22:35,069 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:22:35,070 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC
2025-12-03 23:22:35,072 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43, tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC, path=/api/v1/menus/getmenu/
2025-12-03 23:22:35,073 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:22:35,073 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC
2025-12-03 23:22:35,074 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43, tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC, path=/api/v1/areas/
2025-12-03 23:22:35,076 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:22:35,076 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC
2025-12-03 23:22:35,077 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43, tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC, path=/api/v1/clientes/tenant/branding
2025-12-03 23:22:35,083 - app.core.auth.user_context - WARNING - Usuario 'admin_acme' no encontrado en BD
2025-12-03 23:22:35,083 - app.api.deps - WARNING - Usuario 'admin_acme' no encontrado o inactivo
2025-12-03 23:22:35,085 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/areas/ 401 49.8ms
2025-12-03 23:22:35,085 - app.core.auth.user_context - WARNING - Usuario 'admin_acme' no encontrado en BD
2025-12-03 23:22:35,086 - app.api.deps - WARNING - Usuario 'admin_acme' no encontrado o inactivo
2025-12-03 23:22:35,089 - app.core.auth.user_context - WARNING - Usuario 'admin_acme' no encontrado en BD
2025-12-03 23:22:35,089 - app.api.deps - WARNING - Usuario 'admin_acme' no encontrado o inactivo
2025-12-03 23:22:35,090 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/menus/getmenu/ 401 56.1ms
2025-12-03 23:22:35,092 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/areas/
2025-12-03 23:22:35,093 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/clientes/tenant/branding 401 47.1ms
2025-12-03 23:22:35,093 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 23:22:35,093 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': acme.app.local:5173
2025-12-03 23:22:35,096 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:22:35,096 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:22:35,096 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:22:35,096 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/menus/getmenu/
2025-12-03 23:22:35,096 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 23:22:35,096 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': acme.app.local:5173
2025-12-03 23:22:35,096 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:22:35,102 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:22:35,102 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:22:35,108 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:22:35,108 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:22:35,108 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:22:35,113 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:22:35,114 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:22:35,114 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:22:35,119 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:22:35,120 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC
2025-12-03 23:22:35,121 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43, tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC, path=/api/v1/areas/
2025-12-03 23:22:35,124 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:22:35,125 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC
2025-12-03 23:22:35,125 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43, tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC, path=/api/v1/menus/getmenu/
2025-12-03 23:22:35,131 - app.core.auth.user_context - WARNING - Usuario 'admin_acme' no encontrado en BD
2025-12-03 23:22:35,131 - app.api.deps - WARNING - Usuario 'admin_acme' no encontrado o inactivo
2025-12-03 23:22:35,132 - app.core.auth.user_context - WARNING - Usuario 'admin_acme' no encontrado en BD
2025-12-03 23:22:35,132 - app.api.deps - WARNING - Usuario 'admin_acme' no encontrado o inactivo
2025-12-03 23:22:35,133 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/areas/ 401 40.0ms
2025-12-03 23:22:35,133 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/menus/getmenu/ 401 34.4ms
2025-12-03 23:22:42,982 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/auth/logout/
2025-12-03 23:22:42,983 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/auth/logout/ 200 0.8ms
2025-12-03 23:22:42,985 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/logout/
2025-12-03 23:22:42,985 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 23:22:42,985 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': acme.app.local:5173
2025-12-03 23:22:42,986 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:22:42,986 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:22:42,987 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:22:42,992 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:22:42,993 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:22:42,993 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:22:42,997 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:22:42,998 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC
2025-12-03 23:22:42,998 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43, tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC, path=/api/v1/auth/logout/
2025-12-03 23:22:42,999 - app.modules.auth.application.services.auth_service - WARNING - [SECURITY] Token de tenant 00000000-0000-0000-0000-000000000000 usado en tenant ee7bfc14-995f-4209-b4b9-99c307534a43. Usuario: admin_acme
2025-12-03 23:22:43,000 - app.modules.auth.application.services.auth_service - ERROR - Error procesando payload del token: 403: Token no válido para este tenant. Por favor, inicie sesión nuevamente.
2025-12-03 23:22:43,001 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/logout/ 401 16.1ms
2025-12-03 23:22:43,003 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/refresh/
2025-12-03 23:22:43,004 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 23:22:43,005 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': acme.app.local:5173
2025-12-03 23:22:43,005 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:22:43,006 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:22:43,006 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:22:43,011 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:22:43,011 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:22:43,012 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:22:43,016 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:22:43,016 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC
2025-12-03 23:22:43,017 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43, tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC, path=/api/v1/auth/refresh/
2025-12-03 23:22:43,021 - app.modules.auth.application.services.refresh_token_service - WARNING - [VALIDATE-TOKEN] Token no encontrado, revocado o expirado - Cliente ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:22:43,022 - app.modules.auth.application.services.auth_service - WARNING - [REFRESH] Token JWT válido, pero inactivo/revocado en BD. Usuario: admin_acme
2025-12-03 23:22:43,028 - app.infrastructure.database.queries_async - ERROR - Error en execute_insert async (TextClause): (pyodbc.IntegrityError) ('23000', '[23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The INSERT statement conflicted with the FOREIGN KEY constraint "FK_audit_cliente". The conflict occurred in database "bd_hybrid_sistema_central", table "dbo.cliente", column \'cliente_id\'. (547) (SQLExecDirectW); [23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The statement has been terminated. (3621)')
[SQL: 
INSERT INTO auth_audit_log (
    cliente_id,
    usuario_id,
    evento,
    nombre_usuario_intento,
    descripcion,
    exito,
    codigo_error,
    ip_address,
    user_agent,
    device_info,
    geolocation,
    metadata_json
)
OUTPUT INSERTED.log_id, INSERTED.fecha_evento
VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);
]
[parameters: (UUID('00000000-0000-0000-0000-000000000000'), None, 'token_invalid_or_revoked', 'admin_acme', 'Refresh token inválido, expirado o revocado en base de datos', 0, 'REFRESH_TOKEN_INVALID_DB', '127.0.0.1', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36', None, None, '{"client_type": "web"}')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-12-03 23:22:43,030 - app.infrastructure.database.connection_async - ERROR - [ASYNC_CONNECTION] Error en sesión async: Error en la inserción: (pyodbc.IntegrityError) ('23000', '[23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The INSERT statement conflicted with the FOREIGN KEY constraint "FK_audit_cliente". The conflict occurred in database "bd_hybrid_sistema_central", table "dbo.cliente", column \'cliente_id\'. (547) (SQLExecDirectW); [23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The statement has been terminated. (3621)')
[SQL: 
INSERT INTO auth_audit_log (
    cliente_id,
    usuario_id,
    evento,
    nombre_usuario_intento,
    descripcion,
    exito,
    codigo_error,
    ip_address,
    user_agent,
    device_info,
    geolocation,
    metadata_json
)
OUTPUT INSERTED.log_id, INSERTED.fecha_evento
VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);
]
[parameters: (UUID('00000000-0000-0000-0000-000000000000'), None, 'token_invalid_or_revoked', 'admin_acme', 'Refresh token inválido, expirado o revocado en base de datos', 0, 'REFRESH_TOKEN_INVALID_DB', '127.0.0.1', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36', None, None, '{"client_type": "web"}')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 230, in execute
    self._adapt_connection._handle_exception(error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 368, in _handle_exception
    raise error.with_traceback(exc_info[2])
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 228, in execute
    return self.await_(self._execute_async(operation, parameters))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 251, in _execute_async
    result = await self._cursor.execute(operation, parameters)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 132, in execute
    await self._run_operation(self._impl.execute, sql, *params)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 30, in _run_operation
    result = await self._conn._execute(func, *args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\concurrent\futures\thread.py", line 59, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
pyodbc.IntegrityError: ('23000', '[23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The INSERT statement conflicted with the FOREIGN KEY constraint "FK_audit_cliente". The conflict occurred in database "bd_hybrid_sistema_central", table "dbo.cliente", column \'cliente_id\'. (547) (SQLExecDirectW); [23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The statement has been terminated. (3621)')

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 366, in execute_insert
    result = await session.execute(query)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 449, in execute
    result = await greenlet_spawn(
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 203, in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2351, in execute
    return self._execute_internal(
           ^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2258, in _execute_internal
    result = conn.execute(
             ^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1419, in execute
    return meth(
           ^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\sql\elements.py", line 526, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1641, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1846, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1986, in _exec_single_context
    self._handle_dbapi_exception(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 2355, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 230, in execute
    self._adapt_connection._handle_exception(error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 368, in _handle_exception
    raise error.with_traceback(exc_info[2])
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 228, in execute
    return self.await_(self._execute_async(operation, parameters))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 251, in _execute_async
    result = await self._cursor.execute(operation, parameters)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 132, in execute
    await self._run_operation(self._impl.execute, sql, *params)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 30, in _run_operation
    result = await self._conn._execute(func, *args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\concurrent\futures\thread.py", line 59, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
sqlalchemy.exc.IntegrityError: (pyodbc.IntegrityError) ('23000', '[23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The INSERT statement conflicted with the FOREIGN KEY constraint "FK_audit_cliente". The conflict occurred in database "bd_hybrid_sistema_central", table "dbo.cliente", column \'cliente_id\'. (547) (SQLExecDirectW); [23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The statement has been terminated. (3621)')
[SQL: 
INSERT INTO auth_audit_log (
    cliente_id,
    usuario_id,
    evento,
    nombre_usuario_intento,
    descripcion,
    exito,
    codigo_error,
    ip_address,
    user_agent,
    device_info,
    geolocation,
    metadata_json
)
OUTPUT INSERTED.log_id, INSERTED.fecha_evento
VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);
]
[parameters: (UUID('00000000-0000-0000-0000-000000000000'), None, 'token_invalid_or_revoked', 'admin_acme', 'Refresh token inválido, expirado o revocado en base de datos', 0, 'REFRESH_TOKEN_INVALID_DB', '127.0.0.1', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36', None, None, '{"client_type": "web"}')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\connection_async.py", line 326, in get_db_connection
    yield session
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 382, in execute_insert
    raise DatabaseError(
app.core.exceptions.DatabaseError: Error en la inserción: (pyodbc.IntegrityError) ('23000', '[23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The INSERT statement conflicted with the FOREIGN KEY constraint "FK_audit_cliente". The conflict occurred in database "bd_hybrid_sistema_central", table "dbo.cliente", column \'cliente_id\'. (547) (SQLExecDirectW); [23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The statement has been terminated. (3621)')
[SQL: 
INSERT INTO auth_audit_log (
    cliente_id,
    usuario_id,
    evento,
    nombre_usuario_intento,
    descripcion,
    exito,
    codigo_error,
    ip_address,
    user_agent,
    device_info,
    geolocation,
    metadata_json
)
OUTPUT INSERTED.log_id, INSERTED.fecha_evento
VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);
]
[parameters: (UUID('00000000-0000-0000-0000-000000000000'), None, 'token_invalid_or_revoked', 'admin_acme', 'Refresh token inválido, expirado o revocado en base de datos', 0, 'REFRESH_TOKEN_INVALID_DB', '127.0.0.1', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36', None, None, '{"client_type": "web"}')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-12-03 23:22:43,035 - app.core.application.base_service - ERROR - DatabaseError en registrar_auth_event: Error en la inserción: (pyodbc.IntegrityError) ('23000', '[23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The INSERT statement conflicted with the FOREIGN KEY constraint "FK_audit_cliente". The conflict occurred in database "bd_hybrid_sistema_central", table "dbo.cliente", column \'cliente_id\'. (547) (SQLExecDirectW); [23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The statement has been terminated. (3621)')
[SQL: 
INSERT INTO auth_audit_log (
    cliente_id,
    usuario_id,
    evento,
    nombre_usuario_intento,
    descripcion,
    exito,
    codigo_error,
    ip_address,
    user_agent,
    device_info,
    geolocation,
    metadata_json
)
OUTPUT INSERTED.log_id, INSERTED.fecha_evento
VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);
]
[parameters: (UUID('00000000-0000-0000-0000-000000000000'), None, 'token_invalid_or_revoked', 'admin_acme', 'Refresh token inválido, expirado o revocado en base de datos', 0, 'REFRESH_TOKEN_INVALID_DB', '127.0.0.1', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36', None, None, '{"client_type": "web"}')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 230, in execute
    self._adapt_connection._handle_exception(error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 368, in _handle_exception
    raise error.with_traceback(exc_info[2])
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 228, in execute
    return self.await_(self._execute_async(operation, parameters))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 251, in _execute_async
    result = await self._cursor.execute(operation, parameters)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 132, in execute
    await self._run_operation(self._impl.execute, sql, *params)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 30, in _run_operation
    result = await self._conn._execute(func, *args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\concurrent\futures\thread.py", line 59, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
pyodbc.IntegrityError: ('23000', '[23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The INSERT statement conflicted with the FOREIGN KEY constraint "FK_audit_cliente". The conflict occurred in database "bd_hybrid_sistema_central", table "dbo.cliente", column \'cliente_id\'. (547) (SQLExecDirectW); [23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The statement has been terminated. (3621)')

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 366, in execute_insert
    result = await session.execute(query)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 449, in execute
    result = await greenlet_spawn(
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 203, in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2351, in execute
    return self._execute_internal(
           ^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2258, in _execute_internal
    result = conn.execute(
             ^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1419, in execute
    return meth(
           ^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\sql\elements.py", line 526, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1641, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1846, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1986, in _exec_single_context
    self._handle_dbapi_exception(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 2355, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 230, in execute
    self._adapt_connection._handle_exception(error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 368, in _handle_exception
    raise error.with_traceback(exc_info[2])
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 228, in execute
    return self.await_(self._execute_async(operation, parameters))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 251, in _execute_async
    result = await self._cursor.execute(operation, parameters)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 132, in execute
    await self._run_operation(self._impl.execute, sql, *params)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 30, in _run_operation
    result = await self._conn._execute(func, *args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\concurrent\futures\thread.py", line 59, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
sqlalchemy.exc.IntegrityError: (pyodbc.IntegrityError) ('23000', '[23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The INSERT statement conflicted with the FOREIGN KEY constraint "FK_audit_cliente". The conflict occurred in database "bd_hybrid_sistema_central", table "dbo.cliente", column \'cliente_id\'. (547) (SQLExecDirectW); [23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The statement has been terminated. (3621)')
[SQL: 
INSERT INTO auth_audit_log (
    cliente_id,
    usuario_id,
    evento,
    nombre_usuario_intento,
    descripcion,
    exito,
    codigo_error,
    ip_address,
    user_agent,
    device_info,
    geolocation,
    metadata_json
)
OUTPUT INSERTED.log_id, INSERTED.fecha_evento
VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);
]
[parameters: (UUID('00000000-0000-0000-0000-000000000000'), None, 'token_invalid_or_revoked', 'admin_acme', 'Refresh token inválido, expirado o revocado en base de datos', 0, 'REFRESH_TOKEN_INVALID_DB', '127.0.0.1', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36', None, None, '{"client_type": "web"}')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\core\application\base_service.py", line 52, in wrapper
    return await func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\modules\superadmin\application\services\audit_service.py", line 130, in registrar_auth_event
    result = await execute_insert(
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 382, in execute_insert
    raise DatabaseError(
app.core.exceptions.DatabaseError: Error en la inserción: (pyodbc.IntegrityError) ('23000', '[23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The INSERT statement conflicted with the FOREIGN KEY constraint "FK_audit_cliente". The conflict occurred in database "bd_hybrid_sistema_central", table "dbo.cliente", column \'cliente_id\'. (547) (SQLExecDirectW); [23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The statement has been terminated. (3621)')
[SQL: 
INSERT INTO auth_audit_log (
    cliente_id,
    usuario_id,
    evento,
    nombre_usuario_intento,
    descripcion,
    exito,
    codigo_error,
    ip_address,
    user_agent,
    device_info,
    geolocation,
    metadata_json
)
OUTPUT INSERTED.log_id, INSERTED.fecha_evento
VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);
]
[parameters: (UUID('00000000-0000-0000-0000-000000000000'), None, 'token_invalid_or_revoked', 'admin_acme', 'Refresh token inválido, expirado o revocado en base de datos', 0, 'REFRESH_TOKEN_INVALID_DB', '127.0.0.1', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36', None, None, '{"client_type": "web"}')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-12-03 23:22:43,040 - app.modules.auth.application.services.auth_service - ERROR - [AUDIT] Error registrando evento token_invalid_or_revoked (no crítico)
Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 230, in execute
    self._adapt_connection._handle_exception(error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 368, in _handle_exception
    raise error.with_traceback(exc_info[2])
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 228, in execute
    return self.await_(self._execute_async(operation, parameters))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 251, in _execute_async
    result = await self._cursor.execute(operation, parameters)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 132, in execute
    await self._run_operation(self._impl.execute, sql, *params)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 30, in _run_operation
    result = await self._conn._execute(func, *args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\concurrent\futures\thread.py", line 59, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
pyodbc.IntegrityError: ('23000', '[23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The INSERT statement conflicted with the FOREIGN KEY constraint "FK_audit_cliente". The conflict occurred in database "bd_hybrid_sistema_central", table "dbo.cliente", column \'cliente_id\'. (547) (SQLExecDirectW); [23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The statement has been terminated. (3621)')

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 366, in execute_insert
    result = await session.execute(query)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 449, in execute
    result = await greenlet_spawn(
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 203, in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2351, in execute
    return self._execute_internal(
           ^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2258, in _execute_internal
    result = conn.execute(
             ^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1419, in execute
    return meth(
           ^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\sql\elements.py", line 526, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1641, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1846, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1986, in _exec_single_context
    self._handle_dbapi_exception(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 2355, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 230, in execute
    self._adapt_connection._handle_exception(error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 368, in _handle_exception
    raise error.with_traceback(exc_info[2])
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 228, in execute
    return self.await_(self._execute_async(operation, parameters))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 251, in _execute_async
    result = await self._cursor.execute(operation, parameters)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 132, in execute
    await self._run_operation(self._impl.execute, sql, *params)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 30, in _run_operation
    result = await self._conn._execute(func, *args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\concurrent\futures\thread.py", line 59, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
sqlalchemy.exc.IntegrityError: (pyodbc.IntegrityError) ('23000', '[23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The INSERT statement conflicted with the FOREIGN KEY constraint "FK_audit_cliente". The conflict occurred in database "bd_hybrid_sistema_central", table "dbo.cliente", column \'cliente_id\'. (547) (SQLExecDirectW); [23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The statement has been terminated. (3621)')
[SQL: 
INSERT INTO auth_audit_log (
    cliente_id,
    usuario_id,
    evento,
    nombre_usuario_intento,
    descripcion,
    exito,
    codigo_error,
    ip_address,
    user_agent,
    device_info,
    geolocation,
    metadata_json
)
OUTPUT INSERTED.log_id, INSERTED.fecha_evento
VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);
]
[parameters: (UUID('00000000-0000-0000-0000-000000000000'), None, 'token_invalid_or_revoked', 'admin_acme', 'Refresh token inválido, expirado o revocado en base de datos', 0, 'REFRESH_TOKEN_INVALID_DB', '127.0.0.1', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36', None, None, '{"client_type": "web"}')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\modules\auth\application\services\auth_service.py", line 534, in get_current_user_from_refresh
    await AuditService.registrar_auth_event(
  File "D:\base_multi_tenant_fastapi\app\core\application\base_service.py", line 52, in wrapper
    return await func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\modules\superadmin\application\services\audit_service.py", line 130, in registrar_auth_event
    result = await execute_insert(
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 382, in execute_insert
    raise DatabaseError(
app.core.exceptions.DatabaseError: Error en la inserción: (pyodbc.IntegrityError) ('23000', '[23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The INSERT statement conflicted with the FOREIGN KEY constraint "FK_audit_cliente". The conflict occurred in database "bd_hybrid_sistema_central", table "dbo.cliente", column \'cliente_id\'. (547) (SQLExecDirectW); [23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The statement has been terminated. (3621)')
[SQL: 
INSERT INTO auth_audit_log (
    cliente_id,
    usuario_id,
    evento,
    nombre_usuario_intento,
    descripcion,
    exito,
    codigo_error,
    ip_address,
    user_agent,
    device_info,
    geolocation,
    metadata_json
)
OUTPUT INSERTED.log_id, INSERTED.fecha_evento
VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);
]
[parameters: (UUID('00000000-0000-0000-0000-000000000000'), None, 'token_invalid_or_revoked', 'admin_acme', 'Refresh token inválido, expirado o revocado en base de datos', 0, 'REFRESH_TOKEN_INVALID_DB', '127.0.0.1', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36', None, None, '{"client_type": "web"}')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-12-03 23:22:43,046 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/refresh/ 401 41.7ms
2025-12-03 23:22:48,648 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Pool ADMIN inicializado. Size=10, MaxOverflow=5
2025-12-03 23:22:48,648 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Configuración de pools de tenants: MaxPools=50, PoolSize=3, MaxOverflow=2, InactivityTimeout=3600s
2025-12-03 23:22:48,648 - app.infrastructure.database.connection_pool - INFO - ✅ Módulo de connection pooling cargado y activo
2025-12-03 23:22:48,648 - app.infrastructure.database.connection_pool - INFO -    Configuración: MaxTenantPools=50, TenantPoolSize=3, InactivityTimeout=3600s
2025-12-03 23:22:48,648 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Todos los pools cerrados
2025-12-03 23:22:48,648 - app.main - INFO - ✅ Pools de conexión cerrados correctamente
2025-12-03 23:22:48,753 - asyncio - ERROR - Unclosed connection
connection: <aioodbc.connection.Connection object at 0x000001CE74838650>
2025-12-03 23:22:48,754 - asyncio - ERROR - Unclosed connection
connection: <aioodbc.connection.Connection object at 0x000001CE75479AC0>
2025-12-03 23:22:48,754 - asyncio - ERROR - Unclosed connection
connection: <aioodbc.connection.Connection object at 0x000001CE754792E0>
2025-12-03 23:22:48,755 - asyncio - ERROR - Unclosed connection
connection: <aioodbc.connection.Connection object at 0x000001CE752567B0>
2025-12-03 23:22:48,755 - asyncio - ERROR - Unclosed connection
connection: <aioodbc.connection.Connection object at 0x000001CE75461D90>
2025-12-03 23:22:48,755 - asyncio - ERROR - Unclosed connection
connection: <aioodbc.connection.Connection object at 0x000001CE754B4410>
2025-12-03 23:22:51,737 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 23:22:51,936 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 23:22:51,936 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 23:22:51,945 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 23:22:51,947 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 23:22:51,947 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 23:22:51,948 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 23:22:51,948 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, DEFAULT_TYPE=single
2025-12-03 23:22:52,262 - app.core.security.rate_limiting - INFO - [RATE_LIMITING] Activado. Límites: Login=10/minute, API=200/minute
2025-12-03 23:22:52,262 - app.core.security.rate_limiting - INFO - ✅ Módulo de rate limiting cargado y activo
2025-12-03 23:22:52,338 - app.core.authorization.rbac - INFO - 🔐 Inicializando sistema de autorización...
2025-12-03 23:22:52,338 - app.core.authorization.rbac - INFO - ✅ Sistema de autorización inicializado correctamente
2025-12-03 23:22:52,338 - app.core.authorization.rbac - INFO - 📊 Permisos del sistema: 6 módulos configurados
2025-12-03 23:22:52,491 - app.core.tenant.middleware - INFO - Módulo tenant_middleware cargado (versión híbrida con soporte para proxies)
2025-12-03 23:22:52,491 - app.main - INFO - ✅ Rate limiting configurado y activo
2025-12-03 23:22:52,649 - app.core.tenant.middleware - INFO - [TENANT_MW] Inicializado - BASE_DOMAIN=app.local, SYSTEM_ID=BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, EXCLUDED_SUBDOMAINS={'admin', 'static', 'backend', 'cdn', 'api', 'www', 'assets'}
2025-12-03 23:23:03,478 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/login/
2025-12-03 23:23:03,479 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 23:23:03,479 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': acme.app.local:5173
2025-12-03 23:23:03,480 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:23:03,480 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:23:03,481 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:23:03,484 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] AsyncEngine creado para admin
2025-12-03 23:23:03,617 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:23:03,617 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:23:03,617 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:23:03,633 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:23:07,720 - app.infrastructure.cache.redis_cache - WARNING - [REDIS_CACHE] Error conectando a Redis: Error 10061 connecting to localhost:6379. No se puede establecer una conexión ya que el equipo de destino denegó expresamente dicha conexión.. Cache desactivado automáticamente (usando fallback en memoria).
2025-12-03 23:23:07,720 - app.infrastructure.cache.redis_cache - INFO - ℹ️ Módulo de Redis cache cargado pero desactivado (usando fallback en memoria)
2025-12-03 23:23:07,727 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC
2025-12-03 23:23:07,727 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43, tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC, path=/api/v1/auth/login/
2025-12-03 23:23:07,737 - app.modules.auth.presentation.endpoints - INFO - Cliente ee7bfc14-995f-4209-b4b9-99c307534a43 resuelto y validado para login.
2025-12-03 23:23:07,737 - app.modules.auth.application.services.auth_service - INFO - [AUTH] Intento de login: username='admin_acme', cliente_id_destino=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:23:07,737 - app.modules.auth.application.services.auth_service - INFO - [AUTH] Usuario regular. Buscando en BD del cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:23:07,740 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] AsyncEngine creado para tenant_ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:23:08,045 - app.modules.auth.application.services.auth_service - INFO - Niveles calculados - Usuario 2458D1EA-816B-4C3C-8D13-B90271F59558: level=4, super_admin=False, type=tenant_admin
2025-12-03 23:23:08,047 - app.modules.auth.application.services.auth_service - INFO - [AUTH] Login exitoso: username='admin_acme', usuario_id=2458D1EA-816B-4C3C-8D13-B90271F59558, cliente_origen=00000000-0000-0000-0000-000000000000, cliente_destino=N/A, access_level=4, user_type=tenant_admin
2025-12-03 23:23:08,047 - app.infrastructure.database.queries_async - WARNING - [QUERY] DEPRECATED: execute_query() recibió string SQL. Migrar a SQLAlchemy Core.
2025-12-03 23:23:08,059 - app.modules.auth.application.services.auth_service - INFO - Niveles calculados - Usuario 2458D1EA-816B-4C3C-8D13-B90271F59558: level=1, super_admin=False, type=user
2025-12-03 23:23:08,067 - app.modules.auth.application.services.refresh_token_service - INFO - [STORE-TOKEN] Token insertado exitosamente - Cliente ee7bfc14-995f-4209-b4b9-99c307534a43, Usuario 2458D1EA-816B-4C3C-8D13-B90271F59558, Tipo: web, Token ID: 9CB71D3A-B54A-4E3B-92DB-ABDD77AFDA3B, Rotación: False
2025-12-03 23:23:08,067 - app.modules.auth.presentation.endpoints - INFO - [LOGIN-WEB] Token almacenado - ID: 9CB71D3A-B54A-4E3B-92DB-ABDD77AFDA3B
2025-12-03 23:23:08,067 - app.modules.auth.presentation.endpoints - INFO - Usuario admin_acme autenticado exitosamente (WEB) para cliente ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:23:08,077 - app.infrastructure.database.queries_async - ERROR - Error en execute_insert async (TextClause): (pyodbc.IntegrityError) ('23000', '[23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The INSERT statement conflicted with the FOREIGN KEY constraint "FK_audit_usuario". The conflict occurred in database "bd_hybrid_sistema_central", table "dbo.usuario", column \'usuario_id\'. (547) (SQLExecDirectW); [23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The statement has been terminated. (3621)')
[SQL: 
INSERT INTO auth_audit_log (
    cliente_id,
    usuario_id,
    evento,
    nombre_usuario_intento,
    descripcion,
    exito,
    codigo_error,
    ip_address,
    user_agent,
    device_info,
    geolocation,
    metadata_json
)
OUTPUT INSERTED.log_id, INSERTED.fecha_evento
VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);
]
[parameters: (UUID('ee7bfc14-995f-4209-b4b9-99c307534a43'), UUID('2458d1ea-816b-4c3c-8d13-b90271f59558'), 'login_success', 'admin_acme', 'Login exitoso', 1, None, '127.0.0.1', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36', None, None, '{"client_type": "web", "es_superadmin": false, "auth_method": "password"}')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-12-03 23:23:08,077 - app.infrastructure.database.connection_async - ERROR - [ASYNC_CONNECTION] Error en sesión async: Error en la inserción: (pyodbc.IntegrityError) ('23000', '[23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The INSERT statement conflicted with the FOREIGN KEY constraint "FK_audit_usuario". The conflict occurred in database "bd_hybrid_sistema_central", table "dbo.usuario", column \'usuario_id\'. (547) (SQLExecDirectW); [23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The statement has been terminated. (3621)')
[SQL: 
INSERT INTO auth_audit_log (
    cliente_id,
    usuario_id,
    evento,
    nombre_usuario_intento,
    descripcion,
    exito,
    codigo_error,
    ip_address,
    user_agent,
    device_info,
    geolocation,
    metadata_json
)
OUTPUT INSERTED.log_id, INSERTED.fecha_evento
VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);
]
[parameters: (UUID('ee7bfc14-995f-4209-b4b9-99c307534a43'), UUID('2458d1ea-816b-4c3c-8d13-b90271f59558'), 'login_success', 'admin_acme', 'Login exitoso', 1, None, '127.0.0.1', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36', None, None, '{"client_type": "web", "es_superadmin": false, "auth_method": "password"}')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 230, in execute
    self._adapt_connection._handle_exception(error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 368, in _handle_exception
    raise error.with_traceback(exc_info[2])
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 228, in execute
    return self.await_(self._execute_async(operation, parameters))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 251, in _execute_async
    result = await self._cursor.execute(operation, parameters)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 132, in execute
    await self._run_operation(self._impl.execute, sql, *params)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 30, in _run_operation
    result = await self._conn._execute(func, *args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\concurrent\futures\thread.py", line 59, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
pyodbc.IntegrityError: ('23000', '[23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The INSERT statement conflicted with the FOREIGN KEY constraint "FK_audit_usuario". The conflict occurred in database "bd_hybrid_sistema_central", table "dbo.usuario", column \'usuario_id\'. (547) (SQLExecDirectW); [23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The statement has been terminated. (3621)')

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 366, in execute_insert
    result = await session.execute(query)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 449, in execute
    result = await greenlet_spawn(
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 203, in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2351, in execute
    return self._execute_internal(
           ^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2258, in _execute_internal
    result = conn.execute(
             ^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1419, in execute
    return meth(
           ^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\sql\elements.py", line 526, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1641, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1846, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1986, in _exec_single_context
    self._handle_dbapi_exception(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 2355, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 230, in execute
    self._adapt_connection._handle_exception(error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 368, in _handle_exception
    raise error.with_traceback(exc_info[2])
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 228, in execute
    return self.await_(self._execute_async(operation, parameters))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 251, in _execute_async
    result = await self._cursor.execute(operation, parameters)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 132, in execute
    await self._run_operation(self._impl.execute, sql, *params)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 30, in _run_operation
    result = await self._conn._execute(func, *args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\concurrent\futures\thread.py", line 59, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
sqlalchemy.exc.IntegrityError: (pyodbc.IntegrityError) ('23000', '[23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The INSERT statement conflicted with the FOREIGN KEY constraint "FK_audit_usuario". The conflict occurred in database "bd_hybrid_sistema_central", table "dbo.usuario", column \'usuario_id\'. (547) (SQLExecDirectW); [23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The statement has been terminated. (3621)')
[SQL: 
INSERT INTO auth_audit_log (
    cliente_id,
    usuario_id,
    evento,
    nombre_usuario_intento,
    descripcion,
    exito,
    codigo_error,
    ip_address,
    user_agent,
    device_info,
    geolocation,
    metadata_json
)
OUTPUT INSERTED.log_id, INSERTED.fecha_evento
VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);
]
[parameters: (UUID('ee7bfc14-995f-4209-b4b9-99c307534a43'), UUID('2458d1ea-816b-4c3c-8d13-b90271f59558'), 'login_success', 'admin_acme', 'Login exitoso', 1, None, '127.0.0.1', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36', None, None, '{"client_type": "web", "es_superadmin": false, "auth_method": "password"}')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\connection_async.py", line 326, in get_db_connection
    yield session
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 382, in execute_insert
    raise DatabaseError(
app.core.exceptions.DatabaseError: Error en la inserción: (pyodbc.IntegrityError) ('23000', '[23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The INSERT statement conflicted with the FOREIGN KEY constraint "FK_audit_usuario". The conflict occurred in database "bd_hybrid_sistema_central", table "dbo.usuario", column \'usuario_id\'. (547) (SQLExecDirectW); [23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The statement has been terminated. (3621)')
[SQL: 
INSERT INTO auth_audit_log (
    cliente_id,
    usuario_id,
    evento,
    nombre_usuario_intento,
    descripcion,
    exito,
    codigo_error,
    ip_address,
    user_agent,
    device_info,
    geolocation,
    metadata_json
)
OUTPUT INSERTED.log_id, INSERTED.fecha_evento
VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);
]
[parameters: (UUID('ee7bfc14-995f-4209-b4b9-99c307534a43'), UUID('2458d1ea-816b-4c3c-8d13-b90271f59558'), 'login_success', 'admin_acme', 'Login exitoso', 1, None, '127.0.0.1', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36', None, None, '{"client_type": "web", "es_superadmin": false, "auth_method": "password"}')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-12-03 23:23:08,090 - app.core.application.base_service - ERROR - DatabaseError en registrar_auth_event: Error en la inserción: (pyodbc.IntegrityError) ('23000', '[23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The INSERT statement conflicted with the FOREIGN KEY constraint "FK_audit_usuario". The conflict occurred in database "bd_hybrid_sistema_central", table "dbo.usuario", column \'usuario_id\'. (547) (SQLExecDirectW); [23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The statement has been terminated. (3621)')
[SQL: 
INSERT INTO auth_audit_log (
    cliente_id,
    usuario_id,
    evento,
    nombre_usuario_intento,
    descripcion,
    exito,
    codigo_error,
    ip_address,
    user_agent,
    device_info,
    geolocation,
    metadata_json
)
OUTPUT INSERTED.log_id, INSERTED.fecha_evento
VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);
]
[parameters: (UUID('ee7bfc14-995f-4209-b4b9-99c307534a43'), UUID('2458d1ea-816b-4c3c-8d13-b90271f59558'), 'login_success', 'admin_acme', 'Login exitoso', 1, None, '127.0.0.1', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36', None, None, '{"client_type": "web", "es_superadmin": false, "auth_method": "password"}')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 230, in execute
    self._adapt_connection._handle_exception(error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 368, in _handle_exception
    raise error.with_traceback(exc_info[2])
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 228, in execute
    return self.await_(self._execute_async(operation, parameters))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 251, in _execute_async
    result = await self._cursor.execute(operation, parameters)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 132, in execute
    await self._run_operation(self._impl.execute, sql, *params)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 30, in _run_operation
    result = await self._conn._execute(func, *args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\concurrent\futures\thread.py", line 59, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
pyodbc.IntegrityError: ('23000', '[23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The INSERT statement conflicted with the FOREIGN KEY constraint "FK_audit_usuario". The conflict occurred in database "bd_hybrid_sistema_central", table "dbo.usuario", column \'usuario_id\'. (547) (SQLExecDirectW); [23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The statement has been terminated. (3621)')

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 366, in execute_insert
    result = await session.execute(query)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 449, in execute
    result = await greenlet_spawn(
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 203, in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2351, in execute
    return self._execute_internal(
           ^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2258, in _execute_internal
    result = conn.execute(
             ^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1419, in execute
    return meth(
           ^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\sql\elements.py", line 526, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1641, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1846, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1986, in _exec_single_context
    self._handle_dbapi_exception(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 2355, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 230, in execute
    self._adapt_connection._handle_exception(error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 368, in _handle_exception
    raise error.with_traceback(exc_info[2])
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 228, in execute
    return self.await_(self._execute_async(operation, parameters))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 251, in _execute_async
    result = await self._cursor.execute(operation, parameters)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 132, in execute
    await self._run_operation(self._impl.execute, sql, *params)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 30, in _run_operation
    result = await self._conn._execute(func, *args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\concurrent\futures\thread.py", line 59, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
sqlalchemy.exc.IntegrityError: (pyodbc.IntegrityError) ('23000', '[23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The INSERT statement conflicted with the FOREIGN KEY constraint "FK_audit_usuario". The conflict occurred in database "bd_hybrid_sistema_central", table "dbo.usuario", column \'usuario_id\'. (547) (SQLExecDirectW); [23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The statement has been terminated. (3621)')
[SQL: 
INSERT INTO auth_audit_log (
    cliente_id,
    usuario_id,
    evento,
    nombre_usuario_intento,
    descripcion,
    exito,
    codigo_error,
    ip_address,
    user_agent,
    device_info,
    geolocation,
    metadata_json
)
OUTPUT INSERTED.log_id, INSERTED.fecha_evento
VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);
]
[parameters: (UUID('ee7bfc14-995f-4209-b4b9-99c307534a43'), UUID('2458d1ea-816b-4c3c-8d13-b90271f59558'), 'login_success', 'admin_acme', 'Login exitoso', 1, None, '127.0.0.1', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36', None, None, '{"client_type": "web", "es_superadmin": false, "auth_method": "password"}')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\core\application\base_service.py", line 52, in wrapper
    return await func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\modules\superadmin\application\services\audit_service.py", line 130, in registrar_auth_event
    result = await execute_insert(
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 382, in execute_insert
    raise DatabaseError(
app.core.exceptions.DatabaseError: Error en la inserción: (pyodbc.IntegrityError) ('23000', '[23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The INSERT statement conflicted with the FOREIGN KEY constraint "FK_audit_usuario". The conflict occurred in database "bd_hybrid_sistema_central", table "dbo.usuario", column \'usuario_id\'. (547) (SQLExecDirectW); [23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The statement has been terminated. (3621)')
[SQL: 
INSERT INTO auth_audit_log (
    cliente_id,
    usuario_id,
    evento,
    nombre_usuario_intento,
    descripcion,
    exito,
    codigo_error,
    ip_address,
    user_agent,
    device_info,
    geolocation,
    metadata_json
)
OUTPUT INSERTED.log_id, INSERTED.fecha_evento
VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);
]
[parameters: (UUID('ee7bfc14-995f-4209-b4b9-99c307534a43'), UUID('2458d1ea-816b-4c3c-8d13-b90271f59558'), 'login_success', 'admin_acme', 'Login exitoso', 1, None, '127.0.0.1', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36', None, None, '{"client_type": "web", "es_superadmin": false, "auth_method": "password"}')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-12-03 23:23:08,101 - app.modules.auth.presentation.endpoints - ERROR - [AUDIT] Error registrando evento login_success (no crítico)
Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 230, in execute
    self._adapt_connection._handle_exception(error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 368, in _handle_exception
    raise error.with_traceback(exc_info[2])
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 228, in execute
    return self.await_(self._execute_async(operation, parameters))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 251, in _execute_async
    result = await self._cursor.execute(operation, parameters)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 132, in execute
    await self._run_operation(self._impl.execute, sql, *params)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 30, in _run_operation
    result = await self._conn._execute(func, *args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\concurrent\futures\thread.py", line 59, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
pyodbc.IntegrityError: ('23000', '[23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The INSERT statement conflicted with the FOREIGN KEY constraint "FK_audit_usuario". The conflict occurred in database "bd_hybrid_sistema_central", table "dbo.usuario", column \'usuario_id\'. (547) (SQLExecDirectW); [23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The statement has been terminated. (3621)')

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 366, in execute_insert
    result = await session.execute(query)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 449, in execute
    result = await greenlet_spawn(
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 203, in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2351, in execute
    return self._execute_internal(
           ^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2258, in _execute_internal
    result = conn.execute(
             ^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1419, in execute
    return meth(
           ^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\sql\elements.py", line 526, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1641, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1846, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1986, in _exec_single_context
    self._handle_dbapi_exception(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 2355, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 230, in execute
    self._adapt_connection._handle_exception(error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 368, in _handle_exception
    raise error.with_traceback(exc_info[2])
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 228, in execute
    return self.await_(self._execute_async(operation, parameters))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 251, in _execute_async
    result = await self._cursor.execute(operation, parameters)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 132, in execute
    await self._run_operation(self._impl.execute, sql, *params)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 30, in _run_operation
    result = await self._conn._execute(func, *args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\concurrent\futures\thread.py", line 59, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
sqlalchemy.exc.IntegrityError: (pyodbc.IntegrityError) ('23000', '[23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The INSERT statement conflicted with the FOREIGN KEY constraint "FK_audit_usuario". The conflict occurred in database "bd_hybrid_sistema_central", table "dbo.usuario", column \'usuario_id\'. (547) (SQLExecDirectW); [23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The statement has been terminated. (3621)')
[SQL: 
INSERT INTO auth_audit_log (
    cliente_id,
    usuario_id,
    evento,
    nombre_usuario_intento,
    descripcion,
    exito,
    codigo_error,
    ip_address,
    user_agent,
    device_info,
    geolocation,
    metadata_json
)
OUTPUT INSERTED.log_id, INSERTED.fecha_evento
VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);
]
[parameters: (UUID('ee7bfc14-995f-4209-b4b9-99c307534a43'), UUID('2458d1ea-816b-4c3c-8d13-b90271f59558'), 'login_success', 'admin_acme', 'Login exitoso', 1, None, '127.0.0.1', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36', None, None, '{"client_type": "web", "es_superadmin": false, "auth_method": "password"}')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\modules\auth\presentation\endpoints.py", line 255, in login
    await AuditService.registrar_auth_event(
  File "D:\base_multi_tenant_fastapi\app\core\application\base_service.py", line 52, in wrapper
    return await func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\modules\superadmin\application\services\audit_service.py", line 130, in registrar_auth_event
    result = await execute_insert(
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 382, in execute_insert
    raise DatabaseError(
app.core.exceptions.DatabaseError: Error en la inserción: (pyodbc.IntegrityError) ('23000', '[23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The INSERT statement conflicted with the FOREIGN KEY constraint "FK_audit_usuario". The conflict occurred in database "bd_hybrid_sistema_central", table "dbo.usuario", column \'usuario_id\'. (547) (SQLExecDirectW); [23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The statement has been terminated. (3621)')
[SQL: 
INSERT INTO auth_audit_log (
    cliente_id,
    usuario_id,
    evento,
    nombre_usuario_intento,
    descripcion,
    exito,
    codigo_error,
    ip_address,
    user_agent,
    device_info,
    geolocation,
    metadata_json
)
OUTPUT INSERTED.log_id, INSERTED.fecha_evento
VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);
]
[parameters: (UUID('ee7bfc14-995f-4209-b4b9-99c307534a43'), UUID('2458d1ea-816b-4c3c-8d13-b90271f59558'), 'login_success', 'admin_acme', 'Login exitoso', 1, None, '127.0.0.1', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36', None, None, '{"client_type": "web", "es_superadmin": false, "auth_method": "password"}')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-12-03 23:23:08,104 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/login/ 200 4627.9ms
2025-12-03 23:23:08,113 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/clientes/tenant/branding
2025-12-03 23:23:08,113 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 23:23:08,113 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': acme.app.local:5173
2025-12-03 23:23:08,113 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:23:08,113 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:23:08,117 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:23:08,121 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/menus/getmenu/
2025-12-03 23:23:08,122 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 23:23:08,124 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': acme.app.local:5173
2025-12-03 23:23:08,124 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:23:08,125 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:23:08,125 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:23:08,127 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/areas/
2025-12-03 23:23:08,130 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 23:23:08,131 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': acme.app.local:5173
2025-12-03 23:23:08,133 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:23:08,133 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:23:08,134 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:23:08,139 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:23:08,139 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:23:08,141 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:23:08,143 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:23:08,143 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:23:08,144 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:23:08,147 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:23:08,147 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:23:08,147 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:23:08,153 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:23:08,154 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC
2025-12-03 23:23:08,154 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43, tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC, path=/api/v1/clientes/tenant/branding
2025-12-03 23:23:08,157 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:23:08,157 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC
2025-12-03 23:23:08,158 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43, tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC, path=/api/v1/menus/getmenu/
2025-12-03 23:23:08,164 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:23:08,164 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC
2025-12-03 23:23:08,165 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43, tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC, path=/api/v1/areas/
2025-12-03 23:23:08,169 - app.core.auth.user_context - WARNING - Usuario 'admin_acme' no encontrado en BD
2025-12-03 23:23:08,169 - app.api.deps - WARNING - Usuario 'admin_acme' no encontrado o inactivo
2025-12-03 23:23:08,170 - app.core.auth.user_context - WARNING - Usuario 'admin_acme' no encontrado en BD
2025-12-03 23:23:08,170 - app.api.deps - WARNING - Usuario 'admin_acme' no encontrado o inactivo
2025-12-03 23:23:08,172 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/clientes/tenant/branding 401 58.8ms
2025-12-03 23:23:08,172 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/menus/getmenu/ 401 51.8ms
2025-12-03 23:23:08,177 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/menus/getmenu/
2025-12-03 23:23:08,177 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/refresh/
2025-12-03 23:23:08,179 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 23:23:08,179 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': acme.app.local:5173
2025-12-03 23:23:08,180 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:23:08,180 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:23:08,181 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:23:08,183 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 23:23:08,183 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': acme.app.local:5173
2025-12-03 23:23:08,184 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:23:08,185 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:23:08,185 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:23:08,187 - app.core.auth.user_context - WARNING - Usuario 'admin_acme' no encontrado en BD
2025-12-03 23:23:08,187 - app.api.deps - WARNING - Usuario 'admin_acme' no encontrado o inactivo
2025-12-03 23:23:08,189 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/areas/ 401 60.5ms
2025-12-03 23:23:08,192 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/areas/
2025-12-03 23:23:08,193 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 23:23:08,193 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': acme.app.local:5173
2025-12-03 23:23:08,194 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:23:08,194 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:23:08,195 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:23:08,198 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:23:08,198 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:23:08,199 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:23:08,201 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:23:08,201 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:23:08,201 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:23:08,207 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:23:08,207 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:23:08,207 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:23:08,211 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:23:08,212 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC
2025-12-03 23:23:08,212 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43, tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC, path=/api/v1/menus/getmenu/
2025-12-03 23:23:08,213 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:23:08,214 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC
2025-12-03 23:23:08,214 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43, tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC, path=/api/v1/auth/refresh/
2025-12-03 23:23:08,220 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:23:08,221 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC
2025-12-03 23:23:08,221 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43, tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC, path=/api/v1/areas/
2025-12-03 23:23:08,224 - app.core.auth.user_context - WARNING - Usuario 'admin_acme' no encontrado en BD
2025-12-03 23:23:08,224 - app.api.deps - WARNING - Usuario 'admin_acme' no encontrado o inactivo
2025-12-03 23:23:08,227 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/menus/getmenu/ 401 49.4ms
2025-12-03 23:23:08,230 - app.core.auth.user_context - WARNING - Usuario 'admin_acme' no encontrado en BD
2025-12-03 23:23:08,230 - app.api.deps - WARNING - Usuario 'admin_acme' no encontrado o inactivo
2025-12-03 23:23:08,231 - app.modules.auth.application.services.refresh_token_service - INFO - [VALIDATE-TOKEN] Token válido - Cliente EE7BFC14-995F-4209-B4B9-99C307534A43, Usuario 2458D1EA-816B-4C3C-8D13-B90271F59558, Tipo: web
2025-12-03 23:23:08,232 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/areas/ 401 39.8ms
2025-12-03 23:23:08,237 - app.modules.auth.application.services.auth_service - INFO - [REFRESH] Token validado exitosamente (BD OK) para usuario: admin_acme (Cliente: 00000000-0000-0000-0000-000000000000, Level: 1, Type: user)
2025-12-03 23:23:08,241 - app.modules.auth.application.services.auth_service - INFO - Niveles calculados - Usuario 2458D1EA-816B-4C3C-8D13-B90271F59558: level=4, super_admin=False, type=tenant_admin
2025-12-03 23:23:08,247 - app.modules.auth.application.services.refresh_token_service - INFO - [STORE-TOKEN] Token insertado exitosamente - Cliente 00000000-0000-0000-0000-000000000000, Usuario 2458D1EA-816B-4C3C-8D13-B90271F59558, Tipo: web, Token ID: 8E1C096C-425F-473B-A1E9-46AB907BD413, Rotación: True
2025-12-03 23:23:08,257 - app.modules.auth.application.services.refresh_token_service - WARNING - [REVOKE-TOKEN] Token no encontrado o ya revocado - Cliente 00000000-0000-0000-0000-000000000000, Usuario 2458D1EA-816B-4C3C-8D13-B90271F59558
2025-12-03 23:23:08,257 - app.modules.auth.presentation.endpoints - WARNING - [REFRESH] Token antiguo no encontrado para revocar (no crítico)
2025-12-03 23:23:08,257 - app.modules.auth.presentation.endpoints - INFO - [REFRESH-WEB] Token rotado exitosamente - ID: 8E1C096C-425F-473B-A1E9-46AB907BD413
2025-12-03 23:23:08,257 - app.modules.auth.presentation.endpoints - INFO - [REFRESH-WEB] Token refrescado exitosamente - Usuario: admin_acme
2025-12-03 23:23:08,257 - app.infrastructure.database.queries_async - ERROR - Error en execute_insert async (TextClause): (pyodbc.IntegrityError) ('23000', '[23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The INSERT statement conflicted with the FOREIGN KEY constraint "FK_audit_cliente". The conflict occurred in database "bd_hybrid_sistema_central", table "dbo.cliente", column \'cliente_id\'. (547) (SQLExecDirectW); [23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The statement has been terminated. (3621)')
[SQL: 
INSERT INTO auth_audit_log (
    cliente_id,
    usuario_id,
    evento,
    nombre_usuario_intento,
    descripcion,
    exito,
    codigo_error,
    ip_address,
    user_agent,
    device_info,
    geolocation,
    metadata_json
)
OUTPUT INSERTED.log_id, INSERTED.fecha_evento
VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);
]
[parameters: (UUID('00000000-0000-0000-0000-000000000000'), UUID('2458d1ea-816b-4c3c-8d13-b90271f59558'), 'token_refresh', 'admin_acme', 'Refresh de token exitoso', 1, None, '127.0.0.1', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36', None, None, '{"client_type": "web"}')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-12-03 23:23:08,265 - app.infrastructure.database.connection_async - ERROR - [ASYNC_CONNECTION] Error en sesión async: Error en la inserción: (pyodbc.IntegrityError) ('23000', '[23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The INSERT statement conflicted with the FOREIGN KEY constraint "FK_audit_cliente". The conflict occurred in database "bd_hybrid_sistema_central", table "dbo.cliente", column \'cliente_id\'. (547) (SQLExecDirectW); [23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The statement has been terminated. (3621)')
[SQL: 
INSERT INTO auth_audit_log (
    cliente_id,
    usuario_id,
    evento,
    nombre_usuario_intento,
    descripcion,
    exito,
    codigo_error,
    ip_address,
    user_agent,
    device_info,
    geolocation,
    metadata_json
)
OUTPUT INSERTED.log_id, INSERTED.fecha_evento
VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);
]
[parameters: (UUID('00000000-0000-0000-0000-000000000000'), UUID('2458d1ea-816b-4c3c-8d13-b90271f59558'), 'token_refresh', 'admin_acme', 'Refresh de token exitoso', 1, None, '127.0.0.1', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36', None, None, '{"client_type": "web"}')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 230, in execute
    self._adapt_connection._handle_exception(error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 368, in _handle_exception
    raise error.with_traceback(exc_info[2])
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 228, in execute
    return self.await_(self._execute_async(operation, parameters))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 251, in _execute_async
    result = await self._cursor.execute(operation, parameters)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 132, in execute
    await self._run_operation(self._impl.execute, sql, *params)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 30, in _run_operation
    result = await self._conn._execute(func, *args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\concurrent\futures\thread.py", line 59, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
pyodbc.IntegrityError: ('23000', '[23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The INSERT statement conflicted with the FOREIGN KEY constraint "FK_audit_cliente". The conflict occurred in database "bd_hybrid_sistema_central", table "dbo.cliente", column \'cliente_id\'. (547) (SQLExecDirectW); [23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The statement has been terminated. (3621)')

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 366, in execute_insert
    result = await session.execute(query)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 449, in execute
    result = await greenlet_spawn(
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 203, in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2351, in execute
    return self._execute_internal(
           ^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2258, in _execute_internal
    result = conn.execute(
             ^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1419, in execute
    return meth(
           ^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\sql\elements.py", line 526, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1641, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1846, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1986, in _exec_single_context
    self._handle_dbapi_exception(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 2355, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 230, in execute
    self._adapt_connection._handle_exception(error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 368, in _handle_exception
    raise error.with_traceback(exc_info[2])
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 228, in execute
    return self.await_(self._execute_async(operation, parameters))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 251, in _execute_async
    result = await self._cursor.execute(operation, parameters)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 132, in execute
    await self._run_operation(self._impl.execute, sql, *params)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 30, in _run_operation
    result = await self._conn._execute(func, *args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\concurrent\futures\thread.py", line 59, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
sqlalchemy.exc.IntegrityError: (pyodbc.IntegrityError) ('23000', '[23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The INSERT statement conflicted with the FOREIGN KEY constraint "FK_audit_cliente". The conflict occurred in database "bd_hybrid_sistema_central", table "dbo.cliente", column \'cliente_id\'. (547) (SQLExecDirectW); [23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The statement has been terminated. (3621)')
[SQL: 
INSERT INTO auth_audit_log (
    cliente_id,
    usuario_id,
    evento,
    nombre_usuario_intento,
    descripcion,
    exito,
    codigo_error,
    ip_address,
    user_agent,
    device_info,
    geolocation,
    metadata_json
)
OUTPUT INSERTED.log_id, INSERTED.fecha_evento
VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);
]
[parameters: (UUID('00000000-0000-0000-0000-000000000000'), UUID('2458d1ea-816b-4c3c-8d13-b90271f59558'), 'token_refresh', 'admin_acme', 'Refresh de token exitoso', 1, None, '127.0.0.1', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36', None, None, '{"client_type": "web"}')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\connection_async.py", line 326, in get_db_connection
    yield session
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 382, in execute_insert
    raise DatabaseError(
app.core.exceptions.DatabaseError: Error en la inserción: (pyodbc.IntegrityError) ('23000', '[23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The INSERT statement conflicted with the FOREIGN KEY constraint "FK_audit_cliente". The conflict occurred in database "bd_hybrid_sistema_central", table "dbo.cliente", column \'cliente_id\'. (547) (SQLExecDirectW); [23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The statement has been terminated. (3621)')
[SQL: 
INSERT INTO auth_audit_log (
    cliente_id,
    usuario_id,
    evento,
    nombre_usuario_intento,
    descripcion,
    exito,
    codigo_error,
    ip_address,
    user_agent,
    device_info,
    geolocation,
    metadata_json
)
OUTPUT INSERTED.log_id, INSERTED.fecha_evento
VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);
]
[parameters: (UUID('00000000-0000-0000-0000-000000000000'), UUID('2458d1ea-816b-4c3c-8d13-b90271f59558'), 'token_refresh', 'admin_acme', 'Refresh de token exitoso', 1, None, '127.0.0.1', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36', None, None, '{"client_type": "web"}')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-12-03 23:23:08,269 - app.core.application.base_service - ERROR - DatabaseError en registrar_auth_event: Error en la inserción: (pyodbc.IntegrityError) ('23000', '[23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The INSERT statement conflicted with the FOREIGN KEY constraint "FK_audit_cliente". The conflict occurred in database "bd_hybrid_sistema_central", table "dbo.cliente", column \'cliente_id\'. (547) (SQLExecDirectW); [23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The statement has been terminated. (3621)')
[SQL: 
INSERT INTO auth_audit_log (
    cliente_id,
    usuario_id,
    evento,
    nombre_usuario_intento,
    descripcion,
    exito,
    codigo_error,
    ip_address,
    user_agent,
    device_info,
    geolocation,
    metadata_json
)
OUTPUT INSERTED.log_id, INSERTED.fecha_evento
VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);
]
[parameters: (UUID('00000000-0000-0000-0000-000000000000'), UUID('2458d1ea-816b-4c3c-8d13-b90271f59558'), 'token_refresh', 'admin_acme', 'Refresh de token exitoso', 1, None, '127.0.0.1', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36', None, None, '{"client_type": "web"}')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 230, in execute
    self._adapt_connection._handle_exception(error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 368, in _handle_exception
    raise error.with_traceback(exc_info[2])
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 228, in execute
    return self.await_(self._execute_async(operation, parameters))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 251, in _execute_async
    result = await self._cursor.execute(operation, parameters)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 132, in execute
    await self._run_operation(self._impl.execute, sql, *params)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 30, in _run_operation
    result = await self._conn._execute(func, *args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\concurrent\futures\thread.py", line 59, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
pyodbc.IntegrityError: ('23000', '[23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The INSERT statement conflicted with the FOREIGN KEY constraint "FK_audit_cliente". The conflict occurred in database "bd_hybrid_sistema_central", table "dbo.cliente", column \'cliente_id\'. (547) (SQLExecDirectW); [23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The statement has been terminated. (3621)')

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 366, in execute_insert
    result = await session.execute(query)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 449, in execute
    result = await greenlet_spawn(
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 203, in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2351, in execute
    return self._execute_internal(
           ^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2258, in _execute_internal
    result = conn.execute(
             ^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1419, in execute
    return meth(
           ^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\sql\elements.py", line 526, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1641, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1846, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1986, in _exec_single_context
    self._handle_dbapi_exception(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 2355, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 230, in execute
    self._adapt_connection._handle_exception(error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 368, in _handle_exception
    raise error.with_traceback(exc_info[2])
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 228, in execute
    return self.await_(self._execute_async(operation, parameters))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 251, in _execute_async
    result = await self._cursor.execute(operation, parameters)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 132, in execute
    await self._run_operation(self._impl.execute, sql, *params)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 30, in _run_operation
    result = await self._conn._execute(func, *args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\concurrent\futures\thread.py", line 59, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
sqlalchemy.exc.IntegrityError: (pyodbc.IntegrityError) ('23000', '[23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The INSERT statement conflicted with the FOREIGN KEY constraint "FK_audit_cliente". The conflict occurred in database "bd_hybrid_sistema_central", table "dbo.cliente", column \'cliente_id\'. (547) (SQLExecDirectW); [23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The statement has been terminated. (3621)')
[SQL: 
INSERT INTO auth_audit_log (
    cliente_id,
    usuario_id,
    evento,
    nombre_usuario_intento,
    descripcion,
    exito,
    codigo_error,
    ip_address,
    user_agent,
    device_info,
    geolocation,
    metadata_json
)
OUTPUT INSERTED.log_id, INSERTED.fecha_evento
VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);
]
[parameters: (UUID('00000000-0000-0000-0000-000000000000'), UUID('2458d1ea-816b-4c3c-8d13-b90271f59558'), 'token_refresh', 'admin_acme', 'Refresh de token exitoso', 1, None, '127.0.0.1', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36', None, None, '{"client_type": "web"}')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\core\application\base_service.py", line 52, in wrapper
    return await func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\modules\superadmin\application\services\audit_service.py", line 130, in registrar_auth_event
    result = await execute_insert(
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 382, in execute_insert
    raise DatabaseError(
app.core.exceptions.DatabaseError: Error en la inserción: (pyodbc.IntegrityError) ('23000', '[23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The INSERT statement conflicted with the FOREIGN KEY constraint "FK_audit_cliente". The conflict occurred in database "bd_hybrid_sistema_central", table "dbo.cliente", column \'cliente_id\'. (547) (SQLExecDirectW); [23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The statement has been terminated. (3621)')
[SQL: 
INSERT INTO auth_audit_log (
    cliente_id,
    usuario_id,
    evento,
    nombre_usuario_intento,
    descripcion,
    exito,
    codigo_error,
    ip_address,
    user_agent,
    device_info,
    geolocation,
    metadata_json
)
OUTPUT INSERTED.log_id, INSERTED.fecha_evento
VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);
]
[parameters: (UUID('00000000-0000-0000-0000-000000000000'), UUID('2458d1ea-816b-4c3c-8d13-b90271f59558'), 'token_refresh', 'admin_acme', 'Refresh de token exitoso', 1, None, '127.0.0.1', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36', None, None, '{"client_type": "web"}')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-12-03 23:23:08,272 - app.modules.auth.presentation.endpoints - ERROR - [AUDIT] Error registrando evento token_refresh (no crítico)
Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 230, in execute
    self._adapt_connection._handle_exception(error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 368, in _handle_exception
    raise error.with_traceback(exc_info[2])
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 228, in execute
    return self.await_(self._execute_async(operation, parameters))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 251, in _execute_async
    result = await self._cursor.execute(operation, parameters)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 132, in execute
    await self._run_operation(self._impl.execute, sql, *params)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 30, in _run_operation
    result = await self._conn._execute(func, *args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\concurrent\futures\thread.py", line 59, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
pyodbc.IntegrityError: ('23000', '[23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The INSERT statement conflicted with the FOREIGN KEY constraint "FK_audit_cliente". The conflict occurred in database "bd_hybrid_sistema_central", table "dbo.cliente", column \'cliente_id\'. (547) (SQLExecDirectW); [23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The statement has been terminated. (3621)')

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 366, in execute_insert
    result = await session.execute(query)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 449, in execute
    result = await greenlet_spawn(
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 203, in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2351, in execute
    return self._execute_internal(
           ^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2258, in _execute_internal
    result = conn.execute(
             ^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1419, in execute
    return meth(
           ^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\sql\elements.py", line 526, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1641, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1846, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1986, in _exec_single_context
    self._handle_dbapi_exception(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 2355, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 230, in execute
    self._adapt_connection._handle_exception(error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 368, in _handle_exception
    raise error.with_traceback(exc_info[2])
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 228, in execute
    return self.await_(self._execute_async(operation, parameters))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 251, in _execute_async
    result = await self._cursor.execute(operation, parameters)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 132, in execute
    await self._run_operation(self._impl.execute, sql, *params)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 30, in _run_operation
    result = await self._conn._execute(func, *args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\concurrent\futures\thread.py", line 59, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
sqlalchemy.exc.IntegrityError: (pyodbc.IntegrityError) ('23000', '[23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The INSERT statement conflicted with the FOREIGN KEY constraint "FK_audit_cliente". The conflict occurred in database "bd_hybrid_sistema_central", table "dbo.cliente", column \'cliente_id\'. (547) (SQLExecDirectW); [23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The statement has been terminated. (3621)')
[SQL: 
INSERT INTO auth_audit_log (
    cliente_id,
    usuario_id,
    evento,
    nombre_usuario_intento,
    descripcion,
    exito,
    codigo_error,
    ip_address,
    user_agent,
    device_info,
    geolocation,
    metadata_json
)
OUTPUT INSERTED.log_id, INSERTED.fecha_evento
VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);
]
[parameters: (UUID('00000000-0000-0000-0000-000000000000'), UUID('2458d1ea-816b-4c3c-8d13-b90271f59558'), 'token_refresh', 'admin_acme', 'Refresh de token exitoso', 1, None, '127.0.0.1', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36', None, None, '{"client_type": "web"}')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\modules\auth\presentation\endpoints.py", line 503, in refresh_access_token
    await AuditService.registrar_auth_event(
  File "D:\base_multi_tenant_fastapi\app\core\application\base_service.py", line 52, in wrapper
    return await func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\modules\superadmin\application\services\audit_service.py", line 130, in registrar_auth_event
    result = await execute_insert(
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 382, in execute_insert
    raise DatabaseError(
app.core.exceptions.DatabaseError: Error en la inserción: (pyodbc.IntegrityError) ('23000', '[23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The INSERT statement conflicted with the FOREIGN KEY constraint "FK_audit_cliente". The conflict occurred in database "bd_hybrid_sistema_central", table "dbo.cliente", column \'cliente_id\'. (547) (SQLExecDirectW); [23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The statement has been terminated. (3621)')
[SQL: 
INSERT INTO auth_audit_log (
    cliente_id,
    usuario_id,
    evento,
    nombre_usuario_intento,
    descripcion,
    exito,
    codigo_error,
    ip_address,
    user_agent,
    device_info,
    geolocation,
    metadata_json
)
OUTPUT INSERTED.log_id, INSERTED.fecha_evento
VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);
]
[parameters: (UUID('00000000-0000-0000-0000-000000000000'), UUID('2458d1ea-816b-4c3c-8d13-b90271f59558'), 'token_refresh', 'admin_acme', 'Refresh de token exitoso', 1, None, '127.0.0.1', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36', None, None, '{"client_type": "web"}')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-12-03 23:23:08,277 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/refresh/ 200 99.8ms
2025-12-03 23:23:08,283 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/menus/getmenu/
2025-12-03 23:23:08,284 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/areas/
2025-12-03 23:23:08,285 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 23:23:08,286 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': acme.app.local:5173
2025-12-03 23:23:08,287 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:23:08,287 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:23:08,288 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:23:08,290 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/clientes/tenant/branding
2025-12-03 23:23:08,290 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 23:23:08,291 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': acme.app.local:5173
2025-12-03 23:23:08,292 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:23:08,292 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:23:08,292 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:23:08,294 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 23:23:08,295 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': acme.app.local:5173
2025-12-03 23:23:08,296 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:23:08,296 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:23:08,297 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:23:08,298 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:23:08,298 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:23:08,303 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:23:08,305 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:23:08,306 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:23:08,307 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:23:08,309 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:23:08,309 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:23:08,310 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:23:08,315 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:23:08,315 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC
2025-12-03 23:23:08,316 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43, tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC, path=/api/v1/areas/
2025-12-03 23:23:08,317 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:23:08,317 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC
2025-12-03 23:23:08,317 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43, tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC, path=/api/v1/menus/getmenu/
2025-12-03 23:23:08,320 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:23:08,321 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC
2025-12-03 23:23:08,321 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43, tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC, path=/api/v1/clientes/tenant/branding
2025-12-03 23:23:08,329 - app.core.auth.user_context - WARNING - Usuario 'admin_acme' no encontrado en BD
2025-12-03 23:23:08,329 - app.api.deps - WARNING - Usuario 'admin_acme' no encontrado o inactivo
2025-12-03 23:23:08,331 - app.core.auth.user_context - WARNING - Usuario 'admin_acme' no encontrado en BD
2025-12-03 23:23:08,331 - app.api.deps - WARNING - Usuario 'admin_acme' no encontrado o inactivo
2025-12-03 23:23:08,332 - app.core.auth.user_context - WARNING - Usuario 'admin_acme' no encontrado en BD
2025-12-03 23:23:08,332 - app.api.deps - WARNING - Usuario 'admin_acme' no encontrado o inactivo
2025-12-03 23:23:08,333 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/areas/ 401 49.6ms
2025-12-03 23:23:08,334 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/menus/getmenu/ 401 52.2ms
2025-12-03 23:23:08,334 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/clientes/tenant/branding 401 45.1ms
2025-12-03 23:23:08,337 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/areas/
2025-12-03 23:23:08,338 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 23:23:08,339 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': acme.app.local:5173
2025-12-03 23:23:08,340 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:23:08,340 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:23:08,341 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:23:08,343 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/menus/getmenu/
2025-12-03 23:23:08,344 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 23:23:08,344 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': acme.app.local:5173
2025-12-03 23:23:08,345 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:23:08,346 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:23:08,346 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:23:08,347 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:23:08,347 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:23:08,353 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:23:08,355 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:23:08,357 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:23:08,357 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:23:08,361 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:23:08,361 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC
2025-12-03 23:23:08,361 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43, tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC, path=/api/v1/areas/
2025-12-03 23:23:08,365 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:23:08,366 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC
2025-12-03 23:23:08,366 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43, tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC, path=/api/v1/menus/getmenu/
2025-12-03 23:23:08,372 - app.core.auth.user_context - WARNING - Usuario 'admin_acme' no encontrado en BD
2025-12-03 23:23:08,372 - app.api.deps - WARNING - Usuario 'admin_acme' no encontrado o inactivo
2025-12-03 23:23:08,373 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/areas/ 401 36.6ms
2025-12-03 23:23:08,374 - app.core.auth.user_context - WARNING - Usuario 'admin_acme' no encontrado en BD
2025-12-03 23:23:08,375 - app.api.deps - WARNING - Usuario 'admin_acme' no encontrado o inactivo
2025-12-03 23:23:08,375 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/menus/getmenu/ 401 33.4ms
2025-12-03 23:24:21,517 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/refresh/
2025-12-03 23:24:21,518 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 23:24:21,518 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': acme.app.local:5173
2025-12-03 23:24:21,519 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:24:21,520 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:24:21,520 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:24:21,538 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:24:21,538 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:24:21,538 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:24:21,548 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:24:21,549 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC
2025-12-03 23:24:21,549 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43, tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC, path=/api/v1/auth/refresh/
2025-12-03 23:24:21,570 - app.modules.auth.application.services.refresh_token_service - WARNING - [VALIDATE-TOKEN] Token no encontrado, revocado o expirado - Cliente ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:24:21,570 - app.modules.auth.application.services.auth_service - WARNING - [REFRESH] Token JWT válido, pero inactivo/revocado en BD. Usuario: admin_acme
2025-12-03 23:24:21,588 - app.infrastructure.database.queries_async - ERROR - Error en execute_insert async (TextClause): (pyodbc.IntegrityError) ('23000', '[23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The INSERT statement conflicted with the FOREIGN KEY constraint "FK_audit_cliente". The conflict occurred in database "bd_hybrid_sistema_central", table "dbo.cliente", column \'cliente_id\'. (547) (SQLExecDirectW); [23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The statement has been terminated. (3621)')
[SQL: 
INSERT INTO auth_audit_log (
    cliente_id,
    usuario_id,
    evento,
    nombre_usuario_intento,
    descripcion,
    exito,
    codigo_error,
    ip_address,
    user_agent,
    device_info,
    geolocation,
    metadata_json
)
OUTPUT INSERTED.log_id, INSERTED.fecha_evento
VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);
]
[parameters: (UUID('00000000-0000-0000-0000-000000000000'), None, 'token_invalid_or_revoked', 'admin_acme', 'Refresh token inválido, expirado o revocado en base de datos', 0, 'REFRESH_TOKEN_INVALID_DB', '127.0.0.1', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36', None, None, '{"client_type": "web"}')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-12-03 23:24:21,589 - app.infrastructure.database.connection_async - ERROR - [ASYNC_CONNECTION] Error en sesión async: Error en la inserción: (pyodbc.IntegrityError) ('23000', '[23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The INSERT statement conflicted with the FOREIGN KEY constraint "FK_audit_cliente". The conflict occurred in database "bd_hybrid_sistema_central", table "dbo.cliente", column \'cliente_id\'. (547) (SQLExecDirectW); [23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The statement has been terminated. (3621)')
[SQL: 
INSERT INTO auth_audit_log (
    cliente_id,
    usuario_id,
    evento,
    nombre_usuario_intento,
    descripcion,
    exito,
    codigo_error,
    ip_address,
    user_agent,
    device_info,
    geolocation,
    metadata_json
)
OUTPUT INSERTED.log_id, INSERTED.fecha_evento
VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);
]
[parameters: (UUID('00000000-0000-0000-0000-000000000000'), None, 'token_invalid_or_revoked', 'admin_acme', 'Refresh token inválido, expirado o revocado en base de datos', 0, 'REFRESH_TOKEN_INVALID_DB', '127.0.0.1', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36', None, None, '{"client_type": "web"}')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 230, in execute
    self._adapt_connection._handle_exception(error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 368, in _handle_exception
    raise error.with_traceback(exc_info[2])
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 228, in execute
    return self.await_(self._execute_async(operation, parameters))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 251, in _execute_async
    result = await self._cursor.execute(operation, parameters)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 132, in execute
    await self._run_operation(self._impl.execute, sql, *params)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 30, in _run_operation
    result = await self._conn._execute(func, *args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\concurrent\futures\thread.py", line 59, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
pyodbc.IntegrityError: ('23000', '[23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The INSERT statement conflicted with the FOREIGN KEY constraint "FK_audit_cliente". The conflict occurred in database "bd_hybrid_sistema_central", table "dbo.cliente", column \'cliente_id\'. (547) (SQLExecDirectW); [23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The statement has been terminated. (3621)')

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 366, in execute_insert
    result = await session.execute(query)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 449, in execute
    result = await greenlet_spawn(
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 203, in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2351, in execute
    return self._execute_internal(
           ^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2258, in _execute_internal
    result = conn.execute(
             ^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1419, in execute
    return meth(
           ^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\sql\elements.py", line 526, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1641, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1846, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1986, in _exec_single_context
    self._handle_dbapi_exception(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 2355, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 230, in execute
    self._adapt_connection._handle_exception(error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 368, in _handle_exception
    raise error.with_traceback(exc_info[2])
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 228, in execute
    return self.await_(self._execute_async(operation, parameters))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 251, in _execute_async
    result = await self._cursor.execute(operation, parameters)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 132, in execute
    await self._run_operation(self._impl.execute, sql, *params)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 30, in _run_operation
    result = await self._conn._execute(func, *args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\concurrent\futures\thread.py", line 59, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
sqlalchemy.exc.IntegrityError: (pyodbc.IntegrityError) ('23000', '[23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The INSERT statement conflicted with the FOREIGN KEY constraint "FK_audit_cliente". The conflict occurred in database "bd_hybrid_sistema_central", table "dbo.cliente", column \'cliente_id\'. (547) (SQLExecDirectW); [23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The statement has been terminated. (3621)')
[SQL: 
INSERT INTO auth_audit_log (
    cliente_id,
    usuario_id,
    evento,
    nombre_usuario_intento,
    descripcion,
    exito,
    codigo_error,
    ip_address,
    user_agent,
    device_info,
    geolocation,
    metadata_json
)
OUTPUT INSERTED.log_id, INSERTED.fecha_evento
VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);
]
[parameters: (UUID('00000000-0000-0000-0000-000000000000'), None, 'token_invalid_or_revoked', 'admin_acme', 'Refresh token inválido, expirado o revocado en base de datos', 0, 'REFRESH_TOKEN_INVALID_DB', '127.0.0.1', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36', None, None, '{"client_type": "web"}')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\connection_async.py", line 326, in get_db_connection
    yield session
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 382, in execute_insert
    raise DatabaseError(
app.core.exceptions.DatabaseError: Error en la inserción: (pyodbc.IntegrityError) ('23000', '[23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The INSERT statement conflicted with the FOREIGN KEY constraint "FK_audit_cliente". The conflict occurred in database "bd_hybrid_sistema_central", table "dbo.cliente", column \'cliente_id\'. (547) (SQLExecDirectW); [23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The statement has been terminated. (3621)')
[SQL: 
INSERT INTO auth_audit_log (
    cliente_id,
    usuario_id,
    evento,
    nombre_usuario_intento,
    descripcion,
    exito,
    codigo_error,
    ip_address,
    user_agent,
    device_info,
    geolocation,
    metadata_json
)
OUTPUT INSERTED.log_id, INSERTED.fecha_evento
VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);
]
[parameters: (UUID('00000000-0000-0000-0000-000000000000'), None, 'token_invalid_or_revoked', 'admin_acme', 'Refresh token inválido, expirado o revocado en base de datos', 0, 'REFRESH_TOKEN_INVALID_DB', '127.0.0.1', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36', None, None, '{"client_type": "web"}')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-12-03 23:24:21,593 - app.core.application.base_service - ERROR - DatabaseError en registrar_auth_event: Error en la inserción: (pyodbc.IntegrityError) ('23000', '[23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The INSERT statement conflicted with the FOREIGN KEY constraint "FK_audit_cliente". The conflict occurred in database "bd_hybrid_sistema_central", table "dbo.cliente", column \'cliente_id\'. (547) (SQLExecDirectW); [23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The statement has been terminated. (3621)')
[SQL: 
INSERT INTO auth_audit_log (
    cliente_id,
    usuario_id,
    evento,
    nombre_usuario_intento,
    descripcion,
    exito,
    codigo_error,
    ip_address,
    user_agent,
    device_info,
    geolocation,
    metadata_json
)
OUTPUT INSERTED.log_id, INSERTED.fecha_evento
VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);
]
[parameters: (UUID('00000000-0000-0000-0000-000000000000'), None, 'token_invalid_or_revoked', 'admin_acme', 'Refresh token inválido, expirado o revocado en base de datos', 0, 'REFRESH_TOKEN_INVALID_DB', '127.0.0.1', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36', None, None, '{"client_type": "web"}')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 230, in execute
    self._adapt_connection._handle_exception(error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 368, in _handle_exception
    raise error.with_traceback(exc_info[2])
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 228, in execute
    return self.await_(self._execute_async(operation, parameters))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 251, in _execute_async
    result = await self._cursor.execute(operation, parameters)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 132, in execute
    await self._run_operation(self._impl.execute, sql, *params)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 30, in _run_operation
    result = await self._conn._execute(func, *args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\concurrent\futures\thread.py", line 59, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
pyodbc.IntegrityError: ('23000', '[23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The INSERT statement conflicted with the FOREIGN KEY constraint "FK_audit_cliente". The conflict occurred in database "bd_hybrid_sistema_central", table "dbo.cliente", column \'cliente_id\'. (547) (SQLExecDirectW); [23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The statement has been terminated. (3621)')

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 366, in execute_insert
    result = await session.execute(query)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 449, in execute
    result = await greenlet_spawn(
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 203, in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2351, in execute
    return self._execute_internal(
           ^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2258, in _execute_internal
    result = conn.execute(
             ^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1419, in execute
    return meth(
           ^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\sql\elements.py", line 526, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1641, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1846, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1986, in _exec_single_context
    self._handle_dbapi_exception(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 2355, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 230, in execute
    self._adapt_connection._handle_exception(error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 368, in _handle_exception
    raise error.with_traceback(exc_info[2])
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 228, in execute
    return self.await_(self._execute_async(operation, parameters))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 251, in _execute_async
    result = await self._cursor.execute(operation, parameters)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 132, in execute
    await self._run_operation(self._impl.execute, sql, *params)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 30, in _run_operation
    result = await self._conn._execute(func, *args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\concurrent\futures\thread.py", line 59, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
sqlalchemy.exc.IntegrityError: (pyodbc.IntegrityError) ('23000', '[23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The INSERT statement conflicted with the FOREIGN KEY constraint "FK_audit_cliente". The conflict occurred in database "bd_hybrid_sistema_central", table "dbo.cliente", column \'cliente_id\'. (547) (SQLExecDirectW); [23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The statement has been terminated. (3621)')
[SQL: 
INSERT INTO auth_audit_log (
    cliente_id,
    usuario_id,
    evento,
    nombre_usuario_intento,
    descripcion,
    exito,
    codigo_error,
    ip_address,
    user_agent,
    device_info,
    geolocation,
    metadata_json
)
OUTPUT INSERTED.log_id, INSERTED.fecha_evento
VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);
]
[parameters: (UUID('00000000-0000-0000-0000-000000000000'), None, 'token_invalid_or_revoked', 'admin_acme', 'Refresh token inválido, expirado o revocado en base de datos', 0, 'REFRESH_TOKEN_INVALID_DB', '127.0.0.1', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36', None, None, '{"client_type": "web"}')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\core\application\base_service.py", line 52, in wrapper
    return await func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\modules\superadmin\application\services\audit_service.py", line 130, in registrar_auth_event
    result = await execute_insert(
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 382, in execute_insert
    raise DatabaseError(
app.core.exceptions.DatabaseError: Error en la inserción: (pyodbc.IntegrityError) ('23000', '[23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The INSERT statement conflicted with the FOREIGN KEY constraint "FK_audit_cliente". The conflict occurred in database "bd_hybrid_sistema_central", table "dbo.cliente", column \'cliente_id\'. (547) (SQLExecDirectW); [23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The statement has been terminated. (3621)')
[SQL: 
INSERT INTO auth_audit_log (
    cliente_id,
    usuario_id,
    evento,
    nombre_usuario_intento,
    descripcion,
    exito,
    codigo_error,
    ip_address,
    user_agent,
    device_info,
    geolocation,
    metadata_json
)
OUTPUT INSERTED.log_id, INSERTED.fecha_evento
VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);
]
[parameters: (UUID('00000000-0000-0000-0000-000000000000'), None, 'token_invalid_or_revoked', 'admin_acme', 'Refresh token inválido, expirado o revocado en base de datos', 0, 'REFRESH_TOKEN_INVALID_DB', '127.0.0.1', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36', None, None, '{"client_type": "web"}')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-12-03 23:24:21,598 - app.modules.auth.application.services.auth_service - ERROR - [AUDIT] Error registrando evento token_invalid_or_revoked (no crítico)
Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 230, in execute
    self._adapt_connection._handle_exception(error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 368, in _handle_exception
    raise error.with_traceback(exc_info[2])
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 228, in execute
    return self.await_(self._execute_async(operation, parameters))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 251, in _execute_async
    result = await self._cursor.execute(operation, parameters)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 132, in execute
    await self._run_operation(self._impl.execute, sql, *params)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 30, in _run_operation
    result = await self._conn._execute(func, *args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\concurrent\futures\thread.py", line 59, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
pyodbc.IntegrityError: ('23000', '[23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The INSERT statement conflicted with the FOREIGN KEY constraint "FK_audit_cliente". The conflict occurred in database "bd_hybrid_sistema_central", table "dbo.cliente", column \'cliente_id\'. (547) (SQLExecDirectW); [23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The statement has been terminated. (3621)')

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 366, in execute_insert
    result = await session.execute(query)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 449, in execute
    result = await greenlet_spawn(
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 203, in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2351, in execute
    return self._execute_internal(
           ^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2258, in _execute_internal
    result = conn.execute(
             ^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1419, in execute
    return meth(
           ^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\sql\elements.py", line 526, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1641, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1846, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1986, in _exec_single_context
    self._handle_dbapi_exception(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 2355, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 230, in execute
    self._adapt_connection._handle_exception(error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 368, in _handle_exception
    raise error.with_traceback(exc_info[2])
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 228, in execute
    return self.await_(self._execute_async(operation, parameters))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 251, in _execute_async
    result = await self._cursor.execute(operation, parameters)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 132, in execute
    await self._run_operation(self._impl.execute, sql, *params)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 30, in _run_operation
    result = await self._conn._execute(func, *args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\concurrent\futures\thread.py", line 59, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
sqlalchemy.exc.IntegrityError: (pyodbc.IntegrityError) ('23000', '[23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The INSERT statement conflicted with the FOREIGN KEY constraint "FK_audit_cliente". The conflict occurred in database "bd_hybrid_sistema_central", table "dbo.cliente", column \'cliente_id\'. (547) (SQLExecDirectW); [23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The statement has been terminated. (3621)')
[SQL: 
INSERT INTO auth_audit_log (
    cliente_id,
    usuario_id,
    evento,
    nombre_usuario_intento,
    descripcion,
    exito,
    codigo_error,
    ip_address,
    user_agent,
    device_info,
    geolocation,
    metadata_json
)
OUTPUT INSERTED.log_id, INSERTED.fecha_evento
VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);
]
[parameters: (UUID('00000000-0000-0000-0000-000000000000'), None, 'token_invalid_or_revoked', 'admin_acme', 'Refresh token inválido, expirado o revocado en base de datos', 0, 'REFRESH_TOKEN_INVALID_DB', '127.0.0.1', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36', None, None, '{"client_type": "web"}')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\modules\auth\application\services\auth_service.py", line 534, in get_current_user_from_refresh
    await AuditService.registrar_auth_event(
  File "D:\base_multi_tenant_fastapi\app\core\application\base_service.py", line 52, in wrapper
    return await func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\modules\superadmin\application\services\audit_service.py", line 130, in registrar_auth_event
    result = await execute_insert(
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 382, in execute_insert
    raise DatabaseError(
app.core.exceptions.DatabaseError: Error en la inserción: (pyodbc.IntegrityError) ('23000', '[23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The INSERT statement conflicted with the FOREIGN KEY constraint "FK_audit_cliente". The conflict occurred in database "bd_hybrid_sistema_central", table "dbo.cliente", column \'cliente_id\'. (547) (SQLExecDirectW); [23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The statement has been terminated. (3621)')
[SQL: 
INSERT INTO auth_audit_log (
    cliente_id,
    usuario_id,
    evento,
    nombre_usuario_intento,
    descripcion,
    exito,
    codigo_error,
    ip_address,
    user_agent,
    device_info,
    geolocation,
    metadata_json
)
OUTPUT INSERTED.log_id, INSERTED.fecha_evento
VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);
]
[parameters: (UUID('00000000-0000-0000-0000-000000000000'), None, 'token_invalid_or_revoked', 'admin_acme', 'Refresh token inválido, expirado o revocado en base de datos', 0, 'REFRESH_TOKEN_INVALID_DB', '127.0.0.1', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36', None, None, '{"client_type": "web"}')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-12-03 23:24:21,604 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/refresh/ 401 87.9ms
2025-12-03 23:25:42,622 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Pool ADMIN inicializado. Size=10, MaxOverflow=5
2025-12-03 23:25:42,623 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Configuración de pools de tenants: MaxPools=50, PoolSize=3, MaxOverflow=2, InactivityTimeout=3600s
2025-12-03 23:25:42,623 - app.infrastructure.database.connection_pool - INFO - ✅ Módulo de connection pooling cargado y activo
2025-12-03 23:25:42,624 - app.infrastructure.database.connection_pool - INFO -    Configuración: MaxTenantPools=50, TenantPoolSize=3, InactivityTimeout=3600s
2025-12-03 23:25:42,624 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Todos los pools cerrados
2025-12-03 23:25:42,625 - app.main - INFO - ✅ Pools de conexión cerrados correctamente
2025-12-03 23:25:43,554 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 23:25:43,791 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 23:25:43,797 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 23:25:43,799 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 23:25:43,800 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 23:25:43,801 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 23:25:43,801 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 23:25:43,802 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, DEFAULT_TYPE=single
2025-12-03 23:25:43,826 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Pool ADMIN inicializado. Size=10, MaxOverflow=5
2025-12-03 23:25:43,827 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Configuración de pools de tenants: MaxPools=50, PoolSize=3, MaxOverflow=2, InactivityTimeout=3600s
2025-12-03 23:25:43,827 - app.infrastructure.database.connection_pool - INFO - ✅ Módulo de connection pooling cargado y activo
2025-12-03 23:25:43,828 - app.infrastructure.database.connection_pool - INFO -    Configuración: MaxTenantPools=50, TenantPoolSize=3, InactivityTimeout=3600s
2025-12-03 23:25:43,828 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Todos los pools cerrados
2025-12-03 23:25:43,828 - app.main - INFO - ✅ Pools de conexión cerrados correctamente
2025-12-03 23:25:43,958 - asyncio - ERROR - Unclosed connection
connection: <aioodbc.connection.Connection object at 0x000001665FEAA4B0>
2025-12-03 23:25:43,960 - asyncio - ERROR - Unclosed connection
connection: <aioodbc.connection.Connection object at 0x0000016660EC98B0>
2025-12-03 23:25:43,960 - asyncio - ERROR - Unclosed connection
connection: <aioodbc.connection.Connection object at 0x0000016660E4AFF0>
2025-12-03 23:25:43,961 - asyncio - ERROR - Unclosed connection
connection: <aioodbc.connection.Connection object at 0x0000016660ECB4D0>
2025-12-03 23:25:43,961 - asyncio - ERROR - Unclosed connection
connection: <aioodbc.connection.Connection object at 0x0000016660CAA9F0>
2025-12-03 23:25:43,962 - asyncio - ERROR - Unclosed connection
connection: <aioodbc.connection.Connection object at 0x0000016660EEDA60>
2025-12-03 23:25:44,262 - app.core.security.rate_limiting - INFO - [RATE_LIMITING] Activado. Límites: Login=10/minute, API=200/minute
2025-12-03 23:25:44,262 - app.core.security.rate_limiting - INFO - ✅ Módulo de rate limiting cargado y activo
2025-12-03 23:25:44,370 - app.core.authorization.rbac - INFO - 🔐 Inicializando sistema de autorización...
2025-12-03 23:25:44,371 - app.core.authorization.rbac - INFO - ✅ Sistema de autorización inicializado correctamente
2025-12-03 23:25:44,371 - app.core.authorization.rbac - INFO - 📊 Permisos del sistema: 6 módulos configurados
2025-12-03 23:25:44,607 - app.core.tenant.middleware - INFO - Módulo tenant_middleware cargado (versión híbrida con soporte para proxies)
2025-12-03 23:25:44,607 - app.main - INFO - ✅ Rate limiting configurado y activo
2025-12-03 23:25:44,792 - app.core.tenant.middleware - INFO - [TENANT_MW] Inicializado - BASE_DOMAIN=app.local, SYSTEM_ID=BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, EXCLUDED_SUBDOMAINS={'admin', 'cdn', 'www', 'backend', 'static', 'api', 'assets'}
2025-12-03 23:25:44,978 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 23:25:45,237 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 23:25:45,244 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 23:25:45,248 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 23:25:45,249 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 23:25:45,250 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 23:25:45,251 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 23:25:45,251 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, DEFAULT_TYPE=single
2025-12-03 23:25:45,721 - app.core.security.rate_limiting - INFO - [RATE_LIMITING] Activado. Límites: Login=10/minute, API=200/minute
2025-12-03 23:25:45,721 - app.core.security.rate_limiting - INFO - ✅ Módulo de rate limiting cargado y activo
2025-12-03 23:25:45,826 - app.core.authorization.rbac - INFO - 🔐 Inicializando sistema de autorización...
2025-12-03 23:25:45,827 - app.core.authorization.rbac - INFO - ✅ Sistema de autorización inicializado correctamente
2025-12-03 23:25:45,827 - app.core.authorization.rbac - INFO - 📊 Permisos del sistema: 6 módulos configurados
2025-12-03 23:25:46,058 - app.core.tenant.middleware - INFO - Módulo tenant_middleware cargado (versión híbrida con soporte para proxies)
2025-12-03 23:25:46,059 - app.main - INFO - ✅ Rate limiting configurado y activo
2025-12-03 23:25:46,271 - app.core.tenant.middleware - INFO - [TENANT_MW] Inicializado - BASE_DOMAIN=app.local, SYSTEM_ID=BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, EXCLUDED_SUBDOMAINS={'assets', 'api', 'backend', 'cdn', 'www', 'static', 'admin'}
2025-12-03 23:27:51,212 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Pool ADMIN inicializado. Size=10, MaxOverflow=5
2025-12-03 23:27:51,212 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Configuración de pools de tenants: MaxPools=50, PoolSize=3, MaxOverflow=2, InactivityTimeout=3600s
2025-12-03 23:27:51,212 - app.infrastructure.database.connection_pool - INFO - ✅ Módulo de connection pooling cargado y activo
2025-12-03 23:27:51,212 - app.infrastructure.database.connection_pool - INFO -    Configuración: MaxTenantPools=50, TenantPoolSize=3, InactivityTimeout=3600s
2025-12-03 23:27:51,212 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Todos los pools cerrados
2025-12-03 23:27:51,212 - app.main - INFO - ✅ Pools de conexión cerrados correctamente
2025-12-03 23:27:52,191 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 23:27:52,431 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 23:27:52,431 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 23:27:52,444 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 23:27:52,445 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 23:27:52,445 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 23:27:52,445 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 23:27:52,445 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, DEFAULT_TYPE=single
2025-12-03 23:27:53,555 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 23:27:53,806 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 23:27:53,813 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 23:27:53,816 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 23:27:53,816 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 23:27:53,816 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 23:27:53,816 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 23:27:53,816 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, DEFAULT_TYPE=single
2025-12-03 23:28:06,022 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 23:28:06,239 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 23:28:06,242 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 23:28:06,242 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 23:28:06,242 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 23:28:06,252 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 23:28:06,252 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 23:28:06,252 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, DEFAULT_TYPE=single
2025-12-03 23:29:20,928 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 23:29:21,126 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 23:29:21,126 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 23:29:21,135 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 23:29:21,135 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 23:29:21,136 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 23:29:21,136 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 23:29:21,136 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, DEFAULT_TYPE=single
2025-12-03 23:30:02,013 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 23:30:02,261 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 23:30:02,266 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 23:30:02,266 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 23:30:02,266 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 23:30:02,266 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 23:30:02,266 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 23:30:02,266 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, DEFAULT_TYPE=single
2025-12-03 23:30:02,736 - app.core.security.rate_limiting - INFO - [RATE_LIMITING] Activado. Límites: Login=10/minute, API=200/minute
2025-12-03 23:30:02,736 - app.core.security.rate_limiting - INFO - ✅ Módulo de rate limiting cargado y activo
2025-12-03 23:30:02,823 - app.core.authorization.rbac - INFO - 🔐 Inicializando sistema de autorización...
2025-12-03 23:30:02,823 - app.core.authorization.rbac - INFO - ✅ Sistema de autorización inicializado correctamente
2025-12-03 23:30:02,824 - app.core.authorization.rbac - INFO - 📊 Permisos del sistema: 6 módulos configurados
2025-12-03 23:30:03,056 - app.core.tenant.middleware - INFO - Módulo tenant_middleware cargado (versión híbrida con soporte para proxies)
2025-12-03 23:30:03,056 - app.main - INFO - ✅ Rate limiting configurado y activo
2025-12-03 23:30:03,213 - app.core.tenant.middleware - INFO - [TENANT_MW] Inicializado - BASE_DOMAIN=app.local, SYSTEM_ID=BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, EXCLUDED_SUBDOMAINS={'api', 'admin', 'cdn', 'assets', 'backend', 'www', 'static'}
2025-12-03 23:30:43,019 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Pool ADMIN inicializado. Size=10, MaxOverflow=5
2025-12-03 23:30:43,019 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Configuración de pools de tenants: MaxPools=50, PoolSize=3, MaxOverflow=2, InactivityTimeout=3600s
2025-12-03 23:30:43,019 - app.infrastructure.database.connection_pool - INFO - ✅ Módulo de connection pooling cargado y activo
2025-12-03 23:30:43,019 - app.infrastructure.database.connection_pool - INFO -    Configuración: MaxTenantPools=50, TenantPoolSize=3, InactivityTimeout=3600s
2025-12-03 23:30:43,023 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Todos los pools cerrados
2025-12-03 23:30:43,023 - app.main - INFO - ✅ Pools de conexión cerrados correctamente
2025-12-03 23:30:43,747 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 23:30:43,964 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 23:30:43,972 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 23:30:43,974 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 23:30:43,975 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 23:30:43,976 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 23:30:43,976 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 23:30:43,977 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, DEFAULT_TYPE=single
2025-12-03 23:30:44,004 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Pool ADMIN inicializado. Size=10, MaxOverflow=5
2025-12-03 23:30:44,004 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Configuración de pools de tenants: MaxPools=50, PoolSize=3, MaxOverflow=2, InactivityTimeout=3600s
2025-12-03 23:30:44,004 - app.infrastructure.database.connection_pool - INFO - ✅ Módulo de connection pooling cargado y activo
2025-12-03 23:30:44,006 - app.infrastructure.database.connection_pool - INFO -    Configuración: MaxTenantPools=50, TenantPoolSize=3, InactivityTimeout=3600s
2025-12-03 23:30:44,007 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Todos los pools cerrados
2025-12-03 23:30:44,007 - app.main - INFO - ✅ Pools de conexión cerrados correctamente
2025-12-03 23:30:44,543 - app.core.security.rate_limiting - INFO - [RATE_LIMITING] Activado. Límites: Login=10/minute, API=200/minute
2025-12-03 23:30:44,543 - app.core.security.rate_limiting - INFO - ✅ Módulo de rate limiting cargado y activo
2025-12-03 23:30:44,645 - app.core.authorization.rbac - INFO - 🔐 Inicializando sistema de autorización...
2025-12-03 23:30:44,646 - app.core.authorization.rbac - INFO - ✅ Sistema de autorización inicializado correctamente
2025-12-03 23:30:44,646 - app.core.authorization.rbac - INFO - 📊 Permisos del sistema: 6 módulos configurados
2025-12-03 23:30:44,858 - app.core.tenant.middleware - INFO - Módulo tenant_middleware cargado (versión híbrida con soporte para proxies)
2025-12-03 23:30:44,858 - app.main - INFO - ✅ Rate limiting configurado y activo
2025-12-03 23:30:45,009 - app.core.tenant.middleware - INFO - [TENANT_MW] Inicializado - BASE_DOMAIN=app.local, SYSTEM_ID=BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, EXCLUDED_SUBDOMAINS={'admin', 'api', 'static', 'cdn', 'assets', 'backend', 'www'}
2025-12-03 23:30:45,287 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 23:30:45,482 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 23:30:45,488 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 23:30:45,492 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 23:30:45,492 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 23:30:45,494 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 23:30:45,494 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 23:30:45,494 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, DEFAULT_TYPE=single
2025-12-03 23:30:45,975 - app.core.security.rate_limiting - INFO - [RATE_LIMITING] Activado. Límites: Login=10/minute, API=200/minute
2025-12-03 23:30:45,976 - app.core.security.rate_limiting - INFO - ✅ Módulo de rate limiting cargado y activo
2025-12-03 23:30:46,081 - app.core.authorization.rbac - INFO - 🔐 Inicializando sistema de autorización...
2025-12-03 23:30:46,082 - app.core.authorization.rbac - INFO - ✅ Sistema de autorización inicializado correctamente
2025-12-03 23:30:46,082 - app.core.authorization.rbac - INFO - 📊 Permisos del sistema: 6 módulos configurados
2025-12-03 23:30:46,296 - app.core.tenant.middleware - INFO - Módulo tenant_middleware cargado (versión híbrida con soporte para proxies)
2025-12-03 23:30:46,304 - app.main - INFO - ✅ Rate limiting configurado y activo
2025-12-03 23:30:46,446 - app.core.tenant.middleware - INFO - [TENANT_MW] Inicializado - BASE_DOMAIN=app.local, SYSTEM_ID=BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, EXCLUDED_SUBDOMAINS={'www', 'admin', 'static', 'backend', 'cdn', 'api', 'assets'}
2025-12-03 23:31:08,917 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/auth/login/
2025-12-03 23:31:08,918 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/auth/login/ 200 1.1ms
2025-12-03 23:31:08,921 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/login/
2025-12-03 23:31:08,921 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 23:31:08,921 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': acme.app.local:5173
2025-12-03 23:31:08,921 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:31:08,921 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:31:08,924 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:31:08,925 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] AsyncEngine creado para admin
2025-12-03 23:31:09,096 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:31:09,097 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:31:09,097 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:31:09,097 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:31:13,167 - app.infrastructure.cache.redis_cache - WARNING - [REDIS_CACHE] Error conectando a Redis: Error 10061 connecting to localhost:6379. No se puede establecer una conexión ya que el equipo de destino denegó expresamente dicha conexión.. Cache desactivado automáticamente (usando fallback en memoria).
2025-12-03 23:31:13,167 - app.infrastructure.cache.redis_cache - INFO - ℹ️ Módulo de Redis cache cargado pero desactivado (usando fallback en memoria)
2025-12-03 23:31:13,174 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC
2025-12-03 23:31:13,174 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43, tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC, path=/api/v1/auth/login/
2025-12-03 23:31:13,187 - app.modules.auth.presentation.endpoints - INFO - Cliente ee7bfc14-995f-4209-b4b9-99c307534a43 resuelto y validado para login.
2025-12-03 23:31:13,187 - app.modules.auth.application.services.auth_service - INFO - [AUTH] Intento de login: username='admin_acme', cliente_id_destino=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:31:13,188 - app.modules.auth.application.services.auth_service - INFO - [AUTH] Usuario regular. Buscando en BD del cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:31:13,189 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] AsyncEngine creado para tenant_ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:31:13,494 - app.modules.auth.application.services.auth_service - INFO - Niveles calculados - Usuario 2458D1EA-816B-4C3C-8D13-B90271F59558: level=4, super_admin=False, type=tenant_admin
2025-12-03 23:31:13,494 - app.modules.auth.application.services.auth_service - INFO - [AUTH] Login exitoso: username='admin_acme', usuario_id=2458D1EA-816B-4C3C-8D13-B90271F59558, cliente_origen=00000000-0000-0000-0000-000000000000, cliente_destino=N/A, access_level=4, user_type=tenant_admin
2025-12-03 23:31:13,494 - app.infrastructure.database.queries_async - WARNING - [QUERY] DEPRECATED: execute_query() recibió string SQL. Migrar a SQLAlchemy Core.
2025-12-03 23:31:13,509 - app.modules.auth.application.services.auth_service - INFO - Niveles calculados - Usuario 2458D1EA-816B-4C3C-8D13-B90271F59558: level=1, super_admin=False, type=user
2025-12-03 23:31:13,518 - app.modules.auth.application.services.refresh_token_service - INFO - [STORE-TOKEN] Token insertado exitosamente - Cliente ee7bfc14-995f-4209-b4b9-99c307534a43, Usuario 2458D1EA-816B-4C3C-8D13-B90271F59558, Tipo: web, Token ID: 8A13702F-3802-4192-87A0-9CB5969820B6, Rotación: False
2025-12-03 23:31:13,520 - app.modules.auth.presentation.endpoints - INFO - [LOGIN-WEB] Token almacenado - ID: 8A13702F-3802-4192-87A0-9CB5969820B6
2025-12-03 23:31:13,520 - app.modules.auth.presentation.endpoints - INFO - Usuario admin_acme autenticado exitosamente (WEB) para cliente ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:31:13,527 - app.modules.superadmin.application.services.audit_service - INFO - [AUDIT] auth_audit_log registrado: evento=login_success, cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43, usuario_id=2458D1EA-816B-4C3C-8D13-B90271F59558, exito=True
2025-12-03 23:31:13,527 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/login/ 200 4609.2ms
2025-12-03 23:31:13,544 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/clientes/tenant/branding
2025-12-03 23:31:13,544 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 23:31:13,544 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': acme.app.local:5173
2025-12-03 23:31:13,544 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:31:13,544 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:31:13,544 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:31:13,555 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:31:13,556 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:31:13,556 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:31:13,560 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/areas/
2025-12-03 23:31:13,560 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/menus/getmenu/
2025-12-03 23:31:13,563 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 23:31:13,563 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': acme.app.local:5173
2025-12-03 23:31:13,563 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:31:13,564 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:31:13,564 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:31:13,567 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 23:31:13,569 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': acme.app.local:5173
2025-12-03 23:31:13,570 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:31:13,570 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:31:13,571 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:31:13,579 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:31:13,579 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC
2025-12-03 23:31:13,580 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43, tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC, path=/api/v1/clientes/tenant/branding
2025-12-03 23:31:13,581 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:31:13,581 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:31:13,582 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:31:13,591 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:31:13,594 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:31:13,594 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:31:13,601 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:31:13,601 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC
2025-12-03 23:31:13,603 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43, tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC, path=/api/v1/areas/
2025-12-03 23:31:13,609 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:31:13,609 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC
2025-12-03 23:31:13,609 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43, tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC, path=/api/v1/menus/getmenu/
2025-12-03 23:31:13,623 - app.api.deps - WARNING - [SECURITY] Acceso denegado: usuario 'admin_acme' (cliente 00000000-0000-0000-0000-000000000000) intentó acceder a cliente ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:31:13,625 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/clientes/tenant/branding 403 81.3ms
2025-12-03 23:31:13,632 - app.api.deps - WARNING - [SECURITY] Acceso denegado: usuario 'admin_acme' (cliente 00000000-0000-0000-0000-000000000000) intentó acceder a cliente ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:31:13,633 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/areas/ 403 72.6ms
2025-12-03 23:31:13,638 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/areas/
2025-12-03 23:31:13,639 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 23:31:13,639 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': acme.app.local:5173
2025-12-03 23:31:13,639 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:31:13,641 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:31:13,641 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:31:13,645 - app.api.deps - WARNING - [SECURITY] Acceso denegado: usuario 'admin_acme' (cliente 00000000-0000-0000-0000-000000000000) intentó acceder a cliente ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:31:13,646 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/menus/getmenu/ 403 85.2ms
2025-12-03 23:31:13,649 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/menus/getmenu/
2025-12-03 23:31:13,649 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 23:31:13,651 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': acme.app.local:5173
2025-12-03 23:31:13,651 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:31:13,652 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:31:13,652 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:31:13,655 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:31:13,656 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:31:13,656 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:31:13,659 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:31:13,659 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:31:13,659 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:31:13,665 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:31:13,665 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC
2025-12-03 23:31:13,665 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43, tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC, path=/api/v1/areas/
2025-12-03 23:31:13,673 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:31:13,674 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC
2025-12-03 23:31:13,674 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43, tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC, path=/api/v1/menus/getmenu/
2025-12-03 23:31:13,686 - app.api.deps - WARNING - [SECURITY] Acceso denegado: usuario 'admin_acme' (cliente 00000000-0000-0000-0000-000000000000) intentó acceder a cliente ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:31:13,688 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/areas/ 403 50.2ms
2025-12-03 23:31:13,691 - app.api.deps - WARNING - [SECURITY] Acceso denegado: usuario 'admin_acme' (cliente 00000000-0000-0000-0000-000000000000) intentó acceder a cliente ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:31:13,693 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/menus/getmenu/ 403 43.3ms
2025-12-03 23:31:34,987 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/auth/refresh/
2025-12-03 23:31:34,987 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/auth/refresh/ 200 0.9ms
2025-12-03 23:31:34,991 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/refresh/
2025-12-03 23:31:34,991 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 23:31:34,991 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': acme.app.local:5173
2025-12-03 23:31:34,991 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:31:34,994 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:31:34,994 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:31:35,000 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:31:35,001 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:31:35,001 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:31:35,006 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:31:35,007 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC
2025-12-03 23:31:35,008 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43, tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC, path=/api/v1/auth/refresh/
2025-12-03 23:31:35,015 - app.modules.auth.application.services.refresh_token_service - INFO - [VALIDATE-TOKEN] Token válido - Cliente EE7BFC14-995F-4209-B4B9-99C307534A43, Usuario 2458D1EA-816B-4C3C-8D13-B90271F59558, Tipo: web
2025-12-03 23:31:35,020 - app.modules.auth.application.services.auth_service - INFO - [REFRESH] Token validado exitosamente (BD OK) para usuario: admin_acme (Cliente: 00000000-0000-0000-0000-000000000000, Level: 1, Type: user)
2025-12-03 23:31:35,023 - app.modules.auth.application.services.auth_service - INFO - Niveles calculados - Usuario 2458D1EA-816B-4C3C-8D13-B90271F59558: level=4, super_admin=False, type=tenant_admin
2025-12-03 23:31:35,035 - app.modules.auth.application.services.refresh_token_service - INFO - [STORE-TOKEN] Token insertado exitosamente - Cliente 00000000-0000-0000-0000-000000000000, Usuario 2458D1EA-816B-4C3C-8D13-B90271F59558, Tipo: web, Token ID: DFECEE9E-D93E-4C31-B2C8-C0B3B60FFDC0, Rotación: True
2025-12-03 23:31:35,040 - app.modules.auth.application.services.refresh_token_service - WARNING - [REVOKE-TOKEN] Token no encontrado o ya revocado - Cliente 00000000-0000-0000-0000-000000000000, Usuario 2458D1EA-816B-4C3C-8D13-B90271F59558
2025-12-03 23:31:35,041 - app.modules.auth.presentation.endpoints - WARNING - [REFRESH] Token antiguo no encontrado para revocar (no crítico)
2025-12-03 23:31:35,042 - app.modules.auth.presentation.endpoints - INFO - [REFRESH-WEB] Token rotado exitosamente - ID: DFECEE9E-D93E-4C31-B2C8-C0B3B60FFDC0
2025-12-03 23:31:35,042 - app.modules.auth.presentation.endpoints - INFO - [REFRESH-WEB] Token refrescado exitosamente - Usuario: admin_acme
2025-12-03 23:31:35,049 - app.core.tenant.routing - WARNING - [METADATA] No se encontró metadata para cliente 00000000-0000-0000-0000-000000000000. Usando SINGLE-DB como fallback. tipo_instalacion=shared
2025-12-03 23:31:35,050 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] AsyncEngine creado para tenant_00000000-0000-0000-0000-000000000000
2025-12-03 23:31:35,066 - app.infrastructure.database.queries_async - ERROR - Error en execute_insert async (TextClause): (pyodbc.IntegrityError) ('23000', '[23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The INSERT statement conflicted with the FOREIGN KEY constraint "FK_audit_cliente". The conflict occurred in database "bd_hybrid_sistema_central", table "dbo.cliente", column \'cliente_id\'. (547) (SQLExecDirectW); [23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The statement has been terminated. (3621)')
[SQL: 
INSERT INTO auth_audit_log (
    cliente_id,
    usuario_id,
    evento,
    nombre_usuario_intento,
    descripcion,
    exito,
    codigo_error,
    ip_address,
    user_agent,
    device_info,
    geolocation,
    metadata_json
)
OUTPUT INSERTED.log_id, INSERTED.fecha_evento
VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);
]
[parameters: (UUID('00000000-0000-0000-0000-000000000000'), UUID('2458d1ea-816b-4c3c-8d13-b90271f59558'), 'token_refresh', 'admin_acme', 'Refresh de token exitoso', 1, None, '127.0.0.1', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36', None, None, '{"client_type": "web"}')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-12-03 23:31:35,066 - app.infrastructure.database.connection_async - ERROR - [ASYNC_CONNECTION] Error en sesión async: Error en la inserción: (pyodbc.IntegrityError) ('23000', '[23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The INSERT statement conflicted with the FOREIGN KEY constraint "FK_audit_cliente". The conflict occurred in database "bd_hybrid_sistema_central", table "dbo.cliente", column \'cliente_id\'. (547) (SQLExecDirectW); [23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The statement has been terminated. (3621)')
[SQL: 
INSERT INTO auth_audit_log (
    cliente_id,
    usuario_id,
    evento,
    nombre_usuario_intento,
    descripcion,
    exito,
    codigo_error,
    ip_address,
    user_agent,
    device_info,
    geolocation,
    metadata_json
)
OUTPUT INSERTED.log_id, INSERTED.fecha_evento
VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);
]
[parameters: (UUID('00000000-0000-0000-0000-000000000000'), UUID('2458d1ea-816b-4c3c-8d13-b90271f59558'), 'token_refresh', 'admin_acme', 'Refresh de token exitoso', 1, None, '127.0.0.1', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36', None, None, '{"client_type": "web"}')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 230, in execute
    self._adapt_connection._handle_exception(error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 368, in _handle_exception
    raise error.with_traceback(exc_info[2])
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 228, in execute
    return self.await_(self._execute_async(operation, parameters))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 251, in _execute_async
    result = await self._cursor.execute(operation, parameters)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 132, in execute
    await self._run_operation(self._impl.execute, sql, *params)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 30, in _run_operation
    result = await self._conn._execute(func, *args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\concurrent\futures\thread.py", line 59, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
pyodbc.IntegrityError: ('23000', '[23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The INSERT statement conflicted with the FOREIGN KEY constraint "FK_audit_cliente". The conflict occurred in database "bd_hybrid_sistema_central", table "dbo.cliente", column \'cliente_id\'. (547) (SQLExecDirectW); [23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The statement has been terminated. (3621)')

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 366, in execute_insert
    result = await session.execute(query)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 449, in execute
    result = await greenlet_spawn(
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 203, in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2351, in execute
    return self._execute_internal(
           ^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2258, in _execute_internal
    result = conn.execute(
             ^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1419, in execute
    return meth(
           ^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\sql\elements.py", line 526, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1641, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1846, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1986, in _exec_single_context
    self._handle_dbapi_exception(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 2355, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 230, in execute
    self._adapt_connection._handle_exception(error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 368, in _handle_exception
    raise error.with_traceback(exc_info[2])
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 228, in execute
    return self.await_(self._execute_async(operation, parameters))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 251, in _execute_async
    result = await self._cursor.execute(operation, parameters)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 132, in execute
    await self._run_operation(self._impl.execute, sql, *params)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 30, in _run_operation
    result = await self._conn._execute(func, *args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\concurrent\futures\thread.py", line 59, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
sqlalchemy.exc.IntegrityError: (pyodbc.IntegrityError) ('23000', '[23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The INSERT statement conflicted with the FOREIGN KEY constraint "FK_audit_cliente". The conflict occurred in database "bd_hybrid_sistema_central", table "dbo.cliente", column \'cliente_id\'. (547) (SQLExecDirectW); [23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The statement has been terminated. (3621)')
[SQL: 
INSERT INTO auth_audit_log (
    cliente_id,
    usuario_id,
    evento,
    nombre_usuario_intento,
    descripcion,
    exito,
    codigo_error,
    ip_address,
    user_agent,
    device_info,
    geolocation,
    metadata_json
)
OUTPUT INSERTED.log_id, INSERTED.fecha_evento
VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);
]
[parameters: (UUID('00000000-0000-0000-0000-000000000000'), UUID('2458d1ea-816b-4c3c-8d13-b90271f59558'), 'token_refresh', 'admin_acme', 'Refresh de token exitoso', 1, None, '127.0.0.1', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36', None, None, '{"client_type": "web"}')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\connection_async.py", line 326, in get_db_connection
    yield session
  File "D:\base_multi_tenant_fastapi\app\core\tenant\routing.py", line 877, in get_connection_for_tenant
    yield session
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 382, in execute_insert
    raise DatabaseError(
app.core.exceptions.DatabaseError: Error en la inserción: (pyodbc.IntegrityError) ('23000', '[23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The INSERT statement conflicted with the FOREIGN KEY constraint "FK_audit_cliente". The conflict occurred in database "bd_hybrid_sistema_central", table "dbo.cliente", column \'cliente_id\'. (547) (SQLExecDirectW); [23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The statement has been terminated. (3621)')
[SQL: 
INSERT INTO auth_audit_log (
    cliente_id,
    usuario_id,
    evento,
    nombre_usuario_intento,
    descripcion,
    exito,
    codigo_error,
    ip_address,
    user_agent,
    device_info,
    geolocation,
    metadata_json
)
OUTPUT INSERTED.log_id, INSERTED.fecha_evento
VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);
]
[parameters: (UUID('00000000-0000-0000-0000-000000000000'), UUID('2458d1ea-816b-4c3c-8d13-b90271f59558'), 'token_refresh', 'admin_acme', 'Refresh de token exitoso', 1, None, '127.0.0.1', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36', None, None, '{"client_type": "web"}')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-12-03 23:31:35,075 - app.core.application.base_service - ERROR - DatabaseError en registrar_auth_event: Error en la inserción: (pyodbc.IntegrityError) ('23000', '[23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The INSERT statement conflicted with the FOREIGN KEY constraint "FK_audit_cliente". The conflict occurred in database "bd_hybrid_sistema_central", table "dbo.cliente", column \'cliente_id\'. (547) (SQLExecDirectW); [23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The statement has been terminated. (3621)')
[SQL: 
INSERT INTO auth_audit_log (
    cliente_id,
    usuario_id,
    evento,
    nombre_usuario_intento,
    descripcion,
    exito,
    codigo_error,
    ip_address,
    user_agent,
    device_info,
    geolocation,
    metadata_json
)
OUTPUT INSERTED.log_id, INSERTED.fecha_evento
VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);
]
[parameters: (UUID('00000000-0000-0000-0000-000000000000'), UUID('2458d1ea-816b-4c3c-8d13-b90271f59558'), 'token_refresh', 'admin_acme', 'Refresh de token exitoso', 1, None, '127.0.0.1', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36', None, None, '{"client_type": "web"}')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 230, in execute
    self._adapt_connection._handle_exception(error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 368, in _handle_exception
    raise error.with_traceback(exc_info[2])
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 228, in execute
    return self.await_(self._execute_async(operation, parameters))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 251, in _execute_async
    result = await self._cursor.execute(operation, parameters)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 132, in execute
    await self._run_operation(self._impl.execute, sql, *params)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 30, in _run_operation
    result = await self._conn._execute(func, *args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\concurrent\futures\thread.py", line 59, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
pyodbc.IntegrityError: ('23000', '[23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The INSERT statement conflicted with the FOREIGN KEY constraint "FK_audit_cliente". The conflict occurred in database "bd_hybrid_sistema_central", table "dbo.cliente", column \'cliente_id\'. (547) (SQLExecDirectW); [23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The statement has been terminated. (3621)')

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 366, in execute_insert
    result = await session.execute(query)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 449, in execute
    result = await greenlet_spawn(
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 203, in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2351, in execute
    return self._execute_internal(
           ^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2258, in _execute_internal
    result = conn.execute(
             ^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1419, in execute
    return meth(
           ^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\sql\elements.py", line 526, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1641, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1846, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1986, in _exec_single_context
    self._handle_dbapi_exception(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 2355, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 230, in execute
    self._adapt_connection._handle_exception(error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 368, in _handle_exception
    raise error.with_traceback(exc_info[2])
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 228, in execute
    return self.await_(self._execute_async(operation, parameters))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 251, in _execute_async
    result = await self._cursor.execute(operation, parameters)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 132, in execute
    await self._run_operation(self._impl.execute, sql, *params)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 30, in _run_operation
    result = await self._conn._execute(func, *args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\concurrent\futures\thread.py", line 59, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
sqlalchemy.exc.IntegrityError: (pyodbc.IntegrityError) ('23000', '[23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The INSERT statement conflicted with the FOREIGN KEY constraint "FK_audit_cliente". The conflict occurred in database "bd_hybrid_sistema_central", table "dbo.cliente", column \'cliente_id\'. (547) (SQLExecDirectW); [23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The statement has been terminated. (3621)')
[SQL: 
INSERT INTO auth_audit_log (
    cliente_id,
    usuario_id,
    evento,
    nombre_usuario_intento,
    descripcion,
    exito,
    codigo_error,
    ip_address,
    user_agent,
    device_info,
    geolocation,
    metadata_json
)
OUTPUT INSERTED.log_id, INSERTED.fecha_evento
VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);
]
[parameters: (UUID('00000000-0000-0000-0000-000000000000'), UUID('2458d1ea-816b-4c3c-8d13-b90271f59558'), 'token_refresh', 'admin_acme', 'Refresh de token exitoso', 1, None, '127.0.0.1', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36', None, None, '{"client_type": "web"}')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\core\application\base_service.py", line 52, in wrapper
    return await func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\modules\superadmin\application\services\audit_service.py", line 161, in registrar_auth_event
    result = await execute_insert(
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 382, in execute_insert
    raise DatabaseError(
app.core.exceptions.DatabaseError: Error en la inserción: (pyodbc.IntegrityError) ('23000', '[23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The INSERT statement conflicted with the FOREIGN KEY constraint "FK_audit_cliente". The conflict occurred in database "bd_hybrid_sistema_central", table "dbo.cliente", column \'cliente_id\'. (547) (SQLExecDirectW); [23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The statement has been terminated. (3621)')
[SQL: 
INSERT INTO auth_audit_log (
    cliente_id,
    usuario_id,
    evento,
    nombre_usuario_intento,
    descripcion,
    exito,
    codigo_error,
    ip_address,
    user_agent,
    device_info,
    geolocation,
    metadata_json
)
OUTPUT INSERTED.log_id, INSERTED.fecha_evento
VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);
]
[parameters: (UUID('00000000-0000-0000-0000-000000000000'), UUID('2458d1ea-816b-4c3c-8d13-b90271f59558'), 'token_refresh', 'admin_acme', 'Refresh de token exitoso', 1, None, '127.0.0.1', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36', None, None, '{"client_type": "web"}')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-12-03 23:31:35,086 - app.modules.auth.presentation.endpoints - ERROR - [AUDIT] Error registrando evento token_refresh (no crítico)
Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 230, in execute
    self._adapt_connection._handle_exception(error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 368, in _handle_exception
    raise error.with_traceback(exc_info[2])
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 228, in execute
    return self.await_(self._execute_async(operation, parameters))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 251, in _execute_async
    result = await self._cursor.execute(operation, parameters)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 132, in execute
    await self._run_operation(self._impl.execute, sql, *params)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 30, in _run_operation
    result = await self._conn._execute(func, *args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\concurrent\futures\thread.py", line 59, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
pyodbc.IntegrityError: ('23000', '[23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The INSERT statement conflicted with the FOREIGN KEY constraint "FK_audit_cliente". The conflict occurred in database "bd_hybrid_sistema_central", table "dbo.cliente", column \'cliente_id\'. (547) (SQLExecDirectW); [23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The statement has been terminated. (3621)')

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 366, in execute_insert
    result = await session.execute(query)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 449, in execute
    result = await greenlet_spawn(
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 203, in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2351, in execute
    return self._execute_internal(
           ^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2258, in _execute_internal
    result = conn.execute(
             ^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1419, in execute
    return meth(
           ^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\sql\elements.py", line 526, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1641, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1846, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1986, in _exec_single_context
    self._handle_dbapi_exception(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 2355, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 230, in execute
    self._adapt_connection._handle_exception(error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 368, in _handle_exception
    raise error.with_traceback(exc_info[2])
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 228, in execute
    return self.await_(self._execute_async(operation, parameters))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 251, in _execute_async
    result = await self._cursor.execute(operation, parameters)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 132, in execute
    await self._run_operation(self._impl.execute, sql, *params)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 30, in _run_operation
    result = await self._conn._execute(func, *args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\concurrent\futures\thread.py", line 59, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
sqlalchemy.exc.IntegrityError: (pyodbc.IntegrityError) ('23000', '[23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The INSERT statement conflicted with the FOREIGN KEY constraint "FK_audit_cliente". The conflict occurred in database "bd_hybrid_sistema_central", table "dbo.cliente", column \'cliente_id\'. (547) (SQLExecDirectW); [23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The statement has been terminated. (3621)')
[SQL: 
INSERT INTO auth_audit_log (
    cliente_id,
    usuario_id,
    evento,
    nombre_usuario_intento,
    descripcion,
    exito,
    codigo_error,
    ip_address,
    user_agent,
    device_info,
    geolocation,
    metadata_json
)
OUTPUT INSERTED.log_id, INSERTED.fecha_evento
VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);
]
[parameters: (UUID('00000000-0000-0000-0000-000000000000'), UUID('2458d1ea-816b-4c3c-8d13-b90271f59558'), 'token_refresh', 'admin_acme', 'Refresh de token exitoso', 1, None, '127.0.0.1', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36', None, None, '{"client_type": "web"}')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\modules\auth\presentation\endpoints.py", line 515, in refresh_access_token
    await AuditService.registrar_auth_event(
  File "D:\base_multi_tenant_fastapi\app\core\application\base_service.py", line 52, in wrapper
    return await func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\modules\superadmin\application\services\audit_service.py", line 161, in registrar_auth_event
    result = await execute_insert(
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 382, in execute_insert
    raise DatabaseError(
app.core.exceptions.DatabaseError: Error en la inserción: (pyodbc.IntegrityError) ('23000', '[23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The INSERT statement conflicted with the FOREIGN KEY constraint "FK_audit_cliente". The conflict occurred in database "bd_hybrid_sistema_central", table "dbo.cliente", column \'cliente_id\'. (547) (SQLExecDirectW); [23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The statement has been terminated. (3621)')
[SQL: 
INSERT INTO auth_audit_log (
    cliente_id,
    usuario_id,
    evento,
    nombre_usuario_intento,
    descripcion,
    exito,
    codigo_error,
    ip_address,
    user_agent,
    device_info,
    geolocation,
    metadata_json
)
OUTPUT INSERTED.log_id, INSERTED.fecha_evento
VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);
]
[parameters: (UUID('00000000-0000-0000-0000-000000000000'), UUID('2458d1ea-816b-4c3c-8d13-b90271f59558'), 'token_refresh', 'admin_acme', 'Refresh de token exitoso', 1, None, '127.0.0.1', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36', None, None, '{"client_type": "web"}')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-12-03 23:31:35,093 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/refresh/ 200 102.4ms
2025-12-03 23:31:35,096 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/auth/me/
2025-12-03 23:31:35,098 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/auth/me/ 200 0.9ms
2025-12-03 23:31:35,100 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/auth/me/
2025-12-03 23:31:35,100 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 23:31:35,102 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': acme.app.local:5173
2025-12-03 23:31:35,102 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:31:35,102 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:31:35,102 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:31:35,110 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:31:35,111 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:31:35,111 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:31:35,116 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:31:35,117 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC
2025-12-03 23:31:35,118 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43, tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC, path=/api/v1/auth/me/
2025-12-03 23:31:35,119 - app.modules.auth.application.services.auth_service - WARNING - [SECURITY] Token de tenant 00000000-0000-0000-0000-000000000000 usado en tenant ee7bfc14-995f-4209-b4b9-99c307534a43. Usuario: admin_acme
2025-12-03 23:31:35,119 - app.modules.auth.application.services.auth_service - ERROR - Error procesando payload del token: 403: Token no válido para este tenant. Por favor, inicie sesión nuevamente.
2025-12-03 23:31:35,120 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/auth/me/ 401 19.7ms
2025-12-03 23:31:35,125 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/refresh/
2025-12-03 23:31:35,125 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 23:31:35,127 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': acme.app.local:5173
2025-12-03 23:31:35,127 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:31:35,128 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:31:35,128 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:31:35,134 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:31:35,135 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:31:35,135 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:31:35,140 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:31:35,141 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC
2025-12-03 23:31:35,142 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43, tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC, path=/api/v1/auth/refresh/
2025-12-03 23:31:35,147 - app.modules.auth.application.services.refresh_token_service - WARNING - [VALIDATE-TOKEN] Token no encontrado, revocado o expirado - Cliente ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:31:35,148 - app.modules.auth.application.services.auth_service - WARNING - [REFRESH] Token JWT válido, pero inactivo/revocado en BD. Usuario: admin_acme
2025-12-03 23:31:35,156 - app.infrastructure.database.queries_async - ERROR - Error en execute_insert async (TextClause): (pyodbc.IntegrityError) ('23000', '[23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The INSERT statement conflicted with the FOREIGN KEY constraint "FK_audit_cliente". The conflict occurred in database "bd_hybrid_sistema_central", table "dbo.cliente", column \'cliente_id\'. (547) (SQLExecDirectW); [23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The statement has been terminated. (3621)')
[SQL: 
INSERT INTO auth_audit_log (
    cliente_id,
    usuario_id,
    evento,
    nombre_usuario_intento,
    descripcion,
    exito,
    codigo_error,
    ip_address,
    user_agent,
    device_info,
    geolocation,
    metadata_json
)
OUTPUT INSERTED.log_id, INSERTED.fecha_evento
VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);
]
[parameters: (UUID('00000000-0000-0000-0000-000000000000'), None, 'token_invalid_or_revoked', 'admin_acme', 'Refresh token inválido, expirado o revocado en base de datos', 0, 'REFRESH_TOKEN_INVALID_DB', '127.0.0.1', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36', None, None, '{"client_type": "web"}')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-12-03 23:31:35,157 - app.infrastructure.database.connection_async - ERROR - [ASYNC_CONNECTION] Error en sesión async: Error en la inserción: (pyodbc.IntegrityError) ('23000', '[23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The INSERT statement conflicted with the FOREIGN KEY constraint "FK_audit_cliente". The conflict occurred in database "bd_hybrid_sistema_central", table "dbo.cliente", column \'cliente_id\'. (547) (SQLExecDirectW); [23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The statement has been terminated. (3621)')
[SQL: 
INSERT INTO auth_audit_log (
    cliente_id,
    usuario_id,
    evento,
    nombre_usuario_intento,
    descripcion,
    exito,
    codigo_error,
    ip_address,
    user_agent,
    device_info,
    geolocation,
    metadata_json
)
OUTPUT INSERTED.log_id, INSERTED.fecha_evento
VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);
]
[parameters: (UUID('00000000-0000-0000-0000-000000000000'), None, 'token_invalid_or_revoked', 'admin_acme', 'Refresh token inválido, expirado o revocado en base de datos', 0, 'REFRESH_TOKEN_INVALID_DB', '127.0.0.1', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36', None, None, '{"client_type": "web"}')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 230, in execute
    self._adapt_connection._handle_exception(error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 368, in _handle_exception
    raise error.with_traceback(exc_info[2])
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 228, in execute
    return self.await_(self._execute_async(operation, parameters))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 251, in _execute_async
    result = await self._cursor.execute(operation, parameters)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 132, in execute
    await self._run_operation(self._impl.execute, sql, *params)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 30, in _run_operation
    result = await self._conn._execute(func, *args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\concurrent\futures\thread.py", line 59, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
pyodbc.IntegrityError: ('23000', '[23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The INSERT statement conflicted with the FOREIGN KEY constraint "FK_audit_cliente". The conflict occurred in database "bd_hybrid_sistema_central", table "dbo.cliente", column \'cliente_id\'. (547) (SQLExecDirectW); [23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The statement has been terminated. (3621)')

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 366, in execute_insert
    result = await session.execute(query)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 449, in execute
    result = await greenlet_spawn(
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 203, in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2351, in execute
    return self._execute_internal(
           ^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2258, in _execute_internal
    result = conn.execute(
             ^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1419, in execute
    return meth(
           ^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\sql\elements.py", line 526, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1641, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1846, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1986, in _exec_single_context
    self._handle_dbapi_exception(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 2355, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 230, in execute
    self._adapt_connection._handle_exception(error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 368, in _handle_exception
    raise error.with_traceback(exc_info[2])
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 228, in execute
    return self.await_(self._execute_async(operation, parameters))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 251, in _execute_async
    result = await self._cursor.execute(operation, parameters)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 132, in execute
    await self._run_operation(self._impl.execute, sql, *params)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 30, in _run_operation
    result = await self._conn._execute(func, *args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\concurrent\futures\thread.py", line 59, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
sqlalchemy.exc.IntegrityError: (pyodbc.IntegrityError) ('23000', '[23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The INSERT statement conflicted with the FOREIGN KEY constraint "FK_audit_cliente". The conflict occurred in database "bd_hybrid_sistema_central", table "dbo.cliente", column \'cliente_id\'. (547) (SQLExecDirectW); [23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The statement has been terminated. (3621)')
[SQL: 
INSERT INTO auth_audit_log (
    cliente_id,
    usuario_id,
    evento,
    nombre_usuario_intento,
    descripcion,
    exito,
    codigo_error,
    ip_address,
    user_agent,
    device_info,
    geolocation,
    metadata_json
)
OUTPUT INSERTED.log_id, INSERTED.fecha_evento
VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);
]
[parameters: (UUID('00000000-0000-0000-0000-000000000000'), None, 'token_invalid_or_revoked', 'admin_acme', 'Refresh token inválido, expirado o revocado en base de datos', 0, 'REFRESH_TOKEN_INVALID_DB', '127.0.0.1', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36', None, None, '{"client_type": "web"}')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\connection_async.py", line 326, in get_db_connection
    yield session
  File "D:\base_multi_tenant_fastapi\app\core\tenant\routing.py", line 877, in get_connection_for_tenant
    yield session
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 382, in execute_insert
    raise DatabaseError(
app.core.exceptions.DatabaseError: Error en la inserción: (pyodbc.IntegrityError) ('23000', '[23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The INSERT statement conflicted with the FOREIGN KEY constraint "FK_audit_cliente". The conflict occurred in database "bd_hybrid_sistema_central", table "dbo.cliente", column \'cliente_id\'. (547) (SQLExecDirectW); [23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The statement has been terminated. (3621)')
[SQL: 
INSERT INTO auth_audit_log (
    cliente_id,
    usuario_id,
    evento,
    nombre_usuario_intento,
    descripcion,
    exito,
    codigo_error,
    ip_address,
    user_agent,
    device_info,
    geolocation,
    metadata_json
)
OUTPUT INSERTED.log_id, INSERTED.fecha_evento
VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);
]
[parameters: (UUID('00000000-0000-0000-0000-000000000000'), None, 'token_invalid_or_revoked', 'admin_acme', 'Refresh token inválido, expirado o revocado en base de datos', 0, 'REFRESH_TOKEN_INVALID_DB', '127.0.0.1', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36', None, None, '{"client_type": "web"}')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-12-03 23:31:35,163 - app.core.application.base_service - ERROR - DatabaseError en registrar_auth_event: Error en la inserción: (pyodbc.IntegrityError) ('23000', '[23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The INSERT statement conflicted with the FOREIGN KEY constraint "FK_audit_cliente". The conflict occurred in database "bd_hybrid_sistema_central", table "dbo.cliente", column \'cliente_id\'. (547) (SQLExecDirectW); [23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The statement has been terminated. (3621)')
[SQL: 
INSERT INTO auth_audit_log (
    cliente_id,
    usuario_id,
    evento,
    nombre_usuario_intento,
    descripcion,
    exito,
    codigo_error,
    ip_address,
    user_agent,
    device_info,
    geolocation,
    metadata_json
)
OUTPUT INSERTED.log_id, INSERTED.fecha_evento
VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);
]
[parameters: (UUID('00000000-0000-0000-0000-000000000000'), None, 'token_invalid_or_revoked', 'admin_acme', 'Refresh token inválido, expirado o revocado en base de datos', 0, 'REFRESH_TOKEN_INVALID_DB', '127.0.0.1', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36', None, None, '{"client_type": "web"}')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 230, in execute
    self._adapt_connection._handle_exception(error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 368, in _handle_exception
    raise error.with_traceback(exc_info[2])
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 228, in execute
    return self.await_(self._execute_async(operation, parameters))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 251, in _execute_async
    result = await self._cursor.execute(operation, parameters)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 132, in execute
    await self._run_operation(self._impl.execute, sql, *params)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 30, in _run_operation
    result = await self._conn._execute(func, *args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\concurrent\futures\thread.py", line 59, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
pyodbc.IntegrityError: ('23000', '[23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The INSERT statement conflicted with the FOREIGN KEY constraint "FK_audit_cliente". The conflict occurred in database "bd_hybrid_sistema_central", table "dbo.cliente", column \'cliente_id\'. (547) (SQLExecDirectW); [23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The statement has been terminated. (3621)')

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 366, in execute_insert
    result = await session.execute(query)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 449, in execute
    result = await greenlet_spawn(
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 203, in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2351, in execute
    return self._execute_internal(
           ^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2258, in _execute_internal
    result = conn.execute(
             ^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1419, in execute
    return meth(
           ^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\sql\elements.py", line 526, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1641, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1846, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1986, in _exec_single_context
    self._handle_dbapi_exception(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 2355, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 230, in execute
    self._adapt_connection._handle_exception(error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 368, in _handle_exception
    raise error.with_traceback(exc_info[2])
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 228, in execute
    return self.await_(self._execute_async(operation, parameters))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 251, in _execute_async
    result = await self._cursor.execute(operation, parameters)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 132, in execute
    await self._run_operation(self._impl.execute, sql, *params)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 30, in _run_operation
    result = await self._conn._execute(func, *args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\concurrent\futures\thread.py", line 59, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
sqlalchemy.exc.IntegrityError: (pyodbc.IntegrityError) ('23000', '[23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The INSERT statement conflicted with the FOREIGN KEY constraint "FK_audit_cliente". The conflict occurred in database "bd_hybrid_sistema_central", table "dbo.cliente", column \'cliente_id\'. (547) (SQLExecDirectW); [23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The statement has been terminated. (3621)')
[SQL: 
INSERT INTO auth_audit_log (
    cliente_id,
    usuario_id,
    evento,
    nombre_usuario_intento,
    descripcion,
    exito,
    codigo_error,
    ip_address,
    user_agent,
    device_info,
    geolocation,
    metadata_json
)
OUTPUT INSERTED.log_id, INSERTED.fecha_evento
VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);
]
[parameters: (UUID('00000000-0000-0000-0000-000000000000'), None, 'token_invalid_or_revoked', 'admin_acme', 'Refresh token inválido, expirado o revocado en base de datos', 0, 'REFRESH_TOKEN_INVALID_DB', '127.0.0.1', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36', None, None, '{"client_type": "web"}')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\core\application\base_service.py", line 52, in wrapper
    return await func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\modules\superadmin\application\services\audit_service.py", line 161, in registrar_auth_event
    result = await execute_insert(
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 382, in execute_insert
    raise DatabaseError(
app.core.exceptions.DatabaseError: Error en la inserción: (pyodbc.IntegrityError) ('23000', '[23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The INSERT statement conflicted with the FOREIGN KEY constraint "FK_audit_cliente". The conflict occurred in database "bd_hybrid_sistema_central", table "dbo.cliente", column \'cliente_id\'. (547) (SQLExecDirectW); [23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The statement has been terminated. (3621)')
[SQL: 
INSERT INTO auth_audit_log (
    cliente_id,
    usuario_id,
    evento,
    nombre_usuario_intento,
    descripcion,
    exito,
    codigo_error,
    ip_address,
    user_agent,
    device_info,
    geolocation,
    metadata_json
)
OUTPUT INSERTED.log_id, INSERTED.fecha_evento
VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);
]
[parameters: (UUID('00000000-0000-0000-0000-000000000000'), None, 'token_invalid_or_revoked', 'admin_acme', 'Refresh token inválido, expirado o revocado en base de datos', 0, 'REFRESH_TOKEN_INVALID_DB', '127.0.0.1', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36', None, None, '{"client_type": "web"}')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-12-03 23:31:35,165 - app.modules.auth.application.services.auth_service - ERROR - [AUDIT] Error registrando evento token_invalid_or_revoked (no crítico)
Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 230, in execute
    self._adapt_connection._handle_exception(error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 368, in _handle_exception
    raise error.with_traceback(exc_info[2])
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 228, in execute
    return self.await_(self._execute_async(operation, parameters))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 251, in _execute_async
    result = await self._cursor.execute(operation, parameters)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 132, in execute
    await self._run_operation(self._impl.execute, sql, *params)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 30, in _run_operation
    result = await self._conn._execute(func, *args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\concurrent\futures\thread.py", line 59, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
pyodbc.IntegrityError: ('23000', '[23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The INSERT statement conflicted with the FOREIGN KEY constraint "FK_audit_cliente". The conflict occurred in database "bd_hybrid_sistema_central", table "dbo.cliente", column \'cliente_id\'. (547) (SQLExecDirectW); [23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The statement has been terminated. (3621)')

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 366, in execute_insert
    result = await session.execute(query)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 449, in execute
    result = await greenlet_spawn(
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 203, in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2351, in execute
    return self._execute_internal(
           ^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2258, in _execute_internal
    result = conn.execute(
             ^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1419, in execute
    return meth(
           ^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\sql\elements.py", line 526, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1641, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1846, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1986, in _exec_single_context
    self._handle_dbapi_exception(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 2355, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 230, in execute
    self._adapt_connection._handle_exception(error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 368, in _handle_exception
    raise error.with_traceback(exc_info[2])
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 228, in execute
    return self.await_(self._execute_async(operation, parameters))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 251, in _execute_async
    result = await self._cursor.execute(operation, parameters)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 132, in execute
    await self._run_operation(self._impl.execute, sql, *params)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 30, in _run_operation
    result = await self._conn._execute(func, *args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\concurrent\futures\thread.py", line 59, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
sqlalchemy.exc.IntegrityError: (pyodbc.IntegrityError) ('23000', '[23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The INSERT statement conflicted with the FOREIGN KEY constraint "FK_audit_cliente". The conflict occurred in database "bd_hybrid_sistema_central", table "dbo.cliente", column \'cliente_id\'. (547) (SQLExecDirectW); [23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The statement has been terminated. (3621)')
[SQL: 
INSERT INTO auth_audit_log (
    cliente_id,
    usuario_id,
    evento,
    nombre_usuario_intento,
    descripcion,
    exito,
    codigo_error,
    ip_address,
    user_agent,
    device_info,
    geolocation,
    metadata_json
)
OUTPUT INSERTED.log_id, INSERTED.fecha_evento
VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);
]
[parameters: (UUID('00000000-0000-0000-0000-000000000000'), None, 'token_invalid_or_revoked', 'admin_acme', 'Refresh token inválido, expirado o revocado en base de datos', 0, 'REFRESH_TOKEN_INVALID_DB', '127.0.0.1', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36', None, None, '{"client_type": "web"}')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\modules\auth\application\services\auth_service.py", line 542, in get_current_user_from_refresh
    await AuditService.registrar_auth_event(
  File "D:\base_multi_tenant_fastapi\app\core\application\base_service.py", line 52, in wrapper
    return await func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\modules\superadmin\application\services\audit_service.py", line 161, in registrar_auth_event
    result = await execute_insert(
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 382, in execute_insert
    raise DatabaseError(
app.core.exceptions.DatabaseError: Error en la inserción: (pyodbc.IntegrityError) ('23000', '[23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The INSERT statement conflicted with the FOREIGN KEY constraint "FK_audit_cliente". The conflict occurred in database "bd_hybrid_sistema_central", table "dbo.cliente", column \'cliente_id\'. (547) (SQLExecDirectW); [23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The statement has been terminated. (3621)')
[SQL: 
INSERT INTO auth_audit_log (
    cliente_id,
    usuario_id,
    evento,
    nombre_usuario_intento,
    descripcion,
    exito,
    codigo_error,
    ip_address,
    user_agent,
    device_info,
    geolocation,
    metadata_json
)
OUTPUT INSERTED.log_id, INSERTED.fecha_evento
VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);
]
[parameters: (UUID('00000000-0000-0000-0000-000000000000'), None, 'token_invalid_or_revoked', 'admin_acme', 'Refresh token inválido, expirado o revocado en base de datos', 0, 'REFRESH_TOKEN_INVALID_DB', '127.0.0.1', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36', None, None, '{"client_type": "web"}')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-12-03 23:31:35,173 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/refresh/ 401 47.9ms
2025-12-03 23:31:40,295 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Pool ADMIN inicializado. Size=10, MaxOverflow=5
2025-12-03 23:31:40,295 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Configuración de pools de tenants: MaxPools=50, PoolSize=3, MaxOverflow=2, InactivityTimeout=3600s
2025-12-03 23:31:40,295 - app.infrastructure.database.connection_pool - INFO - ✅ Módulo de connection pooling cargado y activo
2025-12-03 23:31:40,299 - app.infrastructure.database.connection_pool - INFO -    Configuración: MaxTenantPools=50, TenantPoolSize=3, InactivityTimeout=3600s
2025-12-03 23:31:40,300 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Todos los pools cerrados
2025-12-03 23:31:40,300 - app.main - INFO - ✅ Pools de conexión cerrados correctamente
2025-12-03 23:31:40,399 - asyncio - ERROR - Unclosed connection
connection: <aioodbc.connection.Connection object at 0x000001F32A71F0B0>
2025-12-03 23:31:40,399 - asyncio - ERROR - Unclosed connection
connection: <aioodbc.connection.Connection object at 0x000001F32B09EE40>
2025-12-03 23:31:40,401 - asyncio - ERROR - Unclosed connection
connection: <aioodbc.connection.Connection object at 0x000001F32B0D1A00>
2025-12-03 23:31:40,401 - asyncio - ERROR - Unclosed connection
connection: <aioodbc.connection.Connection object at 0x000001F32B0D2CC0>
2025-12-03 23:31:40,402 - asyncio - ERROR - Unclosed connection
connection: <aioodbc.connection.Connection object at 0x000001F32B0F6AE0>
2025-12-03 23:31:40,402 - asyncio - ERROR - Unclosed connection
connection: <aioodbc.connection.Connection object at 0x000001F32B0F75C0>
2025-12-03 23:31:40,403 - asyncio - ERROR - Unclosed connection
connection: <aioodbc.connection.Connection object at 0x000001F32B110AD0>
2025-12-03 23:31:43,355 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 23:31:43,550 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 23:31:43,556 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 23:31:43,559 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 23:31:43,559 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 23:31:43,560 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 23:31:43,561 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 23:31:43,561 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, DEFAULT_TYPE=single
2025-12-03 23:31:43,916 - app.core.security.rate_limiting - INFO - [RATE_LIMITING] Activado. Límites: Login=10/minute, API=200/minute
2025-12-03 23:31:43,917 - app.core.security.rate_limiting - INFO - ✅ Módulo de rate limiting cargado y activo
2025-12-03 23:31:44,007 - app.core.authorization.rbac - INFO - 🔐 Inicializando sistema de autorización...
2025-12-03 23:31:44,008 - app.core.authorization.rbac - INFO - ✅ Sistema de autorización inicializado correctamente
2025-12-03 23:31:44,008 - app.core.authorization.rbac - INFO - 📊 Permisos del sistema: 6 módulos configurados
2025-12-03 23:31:44,180 - app.core.tenant.middleware - INFO - Módulo tenant_middleware cargado (versión híbrida con soporte para proxies)
2025-12-03 23:31:44,181 - app.main - INFO - ✅ Rate limiting configurado y activo
2025-12-03 23:31:44,338 - app.core.tenant.middleware - INFO - [TENANT_MW] Inicializado - BASE_DOMAIN=app.local, SYSTEM_ID=BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, EXCLUDED_SUBDOMAINS={'admin', 'backend', 'cdn', 'api', 'static', 'www', 'assets'}
2025-12-03 23:31:54,785 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/login/
2025-12-03 23:31:54,787 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 23:31:54,788 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': acme.app.local:5173
2025-12-03 23:31:54,788 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:31:54,788 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:31:54,788 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:31:54,792 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] AsyncEngine creado para admin
2025-12-03 23:31:54,945 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:31:54,945 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:31:54,945 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:31:54,945 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:31:59,014 - app.infrastructure.cache.redis_cache - WARNING - [REDIS_CACHE] Error conectando a Redis: Error 10061 connecting to localhost:6379. No se puede establecer una conexión ya que el equipo de destino denegó expresamente dicha conexión.. Cache desactivado automáticamente (usando fallback en memoria).
2025-12-03 23:31:59,014 - app.infrastructure.cache.redis_cache - INFO - ℹ️ Módulo de Redis cache cargado pero desactivado (usando fallback en memoria)
2025-12-03 23:31:59,015 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC
2025-12-03 23:31:59,025 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43, tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC, path=/api/v1/auth/login/
2025-12-03 23:31:59,035 - app.modules.auth.presentation.endpoints - INFO - Cliente ee7bfc14-995f-4209-b4b9-99c307534a43 resuelto y validado para login.
2025-12-03 23:31:59,037 - app.modules.auth.application.services.auth_service - INFO - [AUTH] Intento de login: username='admin_acme', cliente_id_destino=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:31:59,037 - app.modules.auth.application.services.auth_service - INFO - [AUTH] Usuario regular. Buscando en BD del cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:31:59,037 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] AsyncEngine creado para tenant_ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:31:59,348 - app.modules.auth.application.services.auth_service - INFO - Niveles calculados - Usuario 2458D1EA-816B-4C3C-8D13-B90271F59558: level=4, super_admin=False, type=tenant_admin
2025-12-03 23:31:59,348 - app.modules.auth.application.services.auth_service - INFO - [AUTH] Login exitoso: username='admin_acme', usuario_id=2458D1EA-816B-4C3C-8D13-B90271F59558, cliente_origen=00000000-0000-0000-0000-000000000000, cliente_destino=N/A, access_level=4, user_type=tenant_admin
2025-12-03 23:31:59,348 - app.infrastructure.database.queries_async - WARNING - [QUERY] DEPRECATED: execute_query() recibió string SQL. Migrar a SQLAlchemy Core.
2025-12-03 23:31:59,355 - app.modules.auth.application.services.auth_service - INFO - Niveles calculados - Usuario 2458D1EA-816B-4C3C-8D13-B90271F59558: level=1, super_admin=False, type=user
2025-12-03 23:31:59,368 - app.modules.auth.application.services.refresh_token_service - INFO - [STORE-TOKEN] Token insertado exitosamente - Cliente ee7bfc14-995f-4209-b4b9-99c307534a43, Usuario 2458D1EA-816B-4C3C-8D13-B90271F59558, Tipo: web, Token ID: A82EBAC4-0802-4167-8D12-7606B8C20789, Rotación: False
2025-12-03 23:31:59,368 - app.modules.auth.presentation.endpoints - INFO - [LOGIN-WEB] Token almacenado - ID: A82EBAC4-0802-4167-8D12-7606B8C20789
2025-12-03 23:31:59,368 - app.modules.auth.presentation.endpoints - INFO - Usuario admin_acme autenticado exitosamente (WEB) para cliente ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:31:59,377 - app.modules.superadmin.application.services.audit_service - INFO - [AUDIT] auth_audit_log registrado: evento=login_success, cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43, usuario_id=2458D1EA-816B-4C3C-8D13-B90271F59558, exito=True
2025-12-03 23:31:59,381 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/login/ 200 4594.3ms
2025-12-03 23:31:59,387 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/clientes/tenant/branding
2025-12-03 23:31:59,387 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 23:31:59,387 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': acme.app.local:5173
2025-12-03 23:31:59,391 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:31:59,391 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:31:59,392 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:31:59,396 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:31:59,398 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:31:59,399 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:31:59,405 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/menus/getmenu/
2025-12-03 23:31:59,405 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/areas/
2025-12-03 23:31:59,406 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 23:31:59,407 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': acme.app.local:5173
2025-12-03 23:31:59,407 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:31:59,408 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:31:59,408 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:31:59,411 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 23:31:59,411 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': acme.app.local:5173
2025-12-03 23:31:59,412 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:31:59,412 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:31:59,413 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:31:59,418 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:31:59,418 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC
2025-12-03 23:31:59,418 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43, tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC, path=/api/v1/clientes/tenant/branding
2025-12-03 23:31:59,425 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:31:59,425 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:31:59,425 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:31:59,431 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:31:59,431 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:31:59,432 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:31:59,435 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:31:59,435 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC
2025-12-03 23:31:59,435 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43, tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC, path=/api/v1/menus/getmenu/
2025-12-03 23:31:59,444 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:31:59,445 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC
2025-12-03 23:31:59,445 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43, tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC, path=/api/v1/areas/
2025-12-03 23:31:59,449 - app.api.deps - WARNING - [SECURITY] Acceso denegado: usuario 'admin_acme' (cliente 00000000-0000-0000-0000-000000000000) intentó acceder a cliente ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:31:59,450 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/clientes/tenant/branding 403 61.6ms
2025-12-03 23:31:59,461 - app.api.deps - WARNING - [SECURITY] Acceso denegado: usuario 'admin_acme' (cliente 00000000-0000-0000-0000-000000000000) intentó acceder a cliente ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:31:59,463 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/menus/getmenu/ 403 58.0ms
2025-12-03 23:31:59,466 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/menus/getmenu/
2025-12-03 23:31:59,467 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 23:31:59,468 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': acme.app.local:5173
2025-12-03 23:31:59,468 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:31:59,469 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:31:59,469 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:31:59,471 - app.api.deps - WARNING - [SECURITY] Acceso denegado: usuario 'admin_acme' (cliente 00000000-0000-0000-0000-000000000000) intentó acceder a cliente ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:31:59,473 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/areas/ 403 67.6ms
2025-12-03 23:31:59,475 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/areas/
2025-12-03 23:31:59,477 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 23:31:59,478 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': acme.app.local:5173
2025-12-03 23:31:59,478 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:31:59,478 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:31:59,479 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:31:59,481 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:31:59,482 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:31:59,483 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:31:59,488 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:31:59,488 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:31:59,489 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:31:59,491 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:31:59,491 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC
2025-12-03 23:31:59,493 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43, tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC, path=/api/v1/menus/getmenu/
2025-12-03 23:31:59,495 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:31:59,495 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC
2025-12-03 23:31:59,495 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43, tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC, path=/api/v1/areas/
2025-12-03 23:31:59,505 - app.api.deps - WARNING - [SECURITY] Acceso denegado: usuario 'admin_acme' (cliente 00000000-0000-0000-0000-000000000000) intentó acceder a cliente ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:31:59,505 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/menus/getmenu/ 403 44.9ms
2025-12-03 23:31:59,514 - app.api.deps - WARNING - [SECURITY] Acceso denegado: usuario 'admin_acme' (cliente 00000000-0000-0000-0000-000000000000) intentó acceder a cliente ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:31:59,515 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/areas/ 403 38.9ms
2025-12-03 23:32:51,509 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/refresh/
2025-12-03 23:32:51,510 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 23:32:51,510 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': acme.app.local:5173
2025-12-03 23:32:51,511 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:32:51,511 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:32:51,511 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:32:51,517 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:32:51,518 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:32:51,519 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:32:51,522 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:32:51,522 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC
2025-12-03 23:32:51,526 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43, tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC, path=/api/v1/auth/refresh/
2025-12-03 23:32:51,535 - app.modules.auth.application.services.refresh_token_service - INFO - [VALIDATE-TOKEN] Token válido - Cliente EE7BFC14-995F-4209-B4B9-99C307534A43, Usuario 2458D1EA-816B-4C3C-8D13-B90271F59558, Tipo: web
2025-12-03 23:32:51,541 - app.modules.auth.application.services.auth_service - INFO - [REFRESH] Token validado exitosamente (BD OK) para usuario: admin_acme (Cliente: 00000000-0000-0000-0000-000000000000, Level: 1, Type: user)
2025-12-03 23:32:51,544 - app.modules.auth.application.services.auth_service - INFO - Niveles calculados - Usuario 2458D1EA-816B-4C3C-8D13-B90271F59558: level=4, super_admin=False, type=tenant_admin
2025-12-03 23:32:51,557 - app.modules.auth.application.services.refresh_token_service - INFO - [STORE-TOKEN] Token insertado exitosamente - Cliente 00000000-0000-0000-0000-000000000000, Usuario 2458D1EA-816B-4C3C-8D13-B90271F59558, Tipo: web, Token ID: 7DBCC16A-A4B5-4B7D-BDDD-047654535A23, Rotación: True
2025-12-03 23:32:51,560 - app.modules.auth.application.services.refresh_token_service - WARNING - [REVOKE-TOKEN] Token no encontrado o ya revocado - Cliente 00000000-0000-0000-0000-000000000000, Usuario 2458D1EA-816B-4C3C-8D13-B90271F59558
2025-12-03 23:32:51,560 - app.modules.auth.presentation.endpoints - WARNING - [REFRESH] Token antiguo no encontrado para revocar (no crítico)
2025-12-03 23:32:51,560 - app.modules.auth.presentation.endpoints - INFO - [REFRESH-WEB] Token rotado exitosamente - ID: 7DBCC16A-A4B5-4B7D-BDDD-047654535A23
2025-12-03 23:32:51,565 - app.modules.auth.presentation.endpoints - INFO - [REFRESH-WEB] Token refrescado exitosamente - Usuario: admin_acme
2025-12-03 23:32:51,573 - app.core.tenant.routing - WARNING - [METADATA] No se encontró metadata para cliente 00000000-0000-0000-0000-000000000000. Usando SINGLE-DB como fallback. tipo_instalacion=shared
2025-12-03 23:32:51,574 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] AsyncEngine creado para tenant_00000000-0000-0000-0000-000000000000
2025-12-03 23:32:51,609 - app.infrastructure.database.queries_async - ERROR - Error en execute_insert async (TextClause): (pyodbc.IntegrityError) ('23000', '[23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The INSERT statement conflicted with the FOREIGN KEY constraint "FK_audit_cliente". The conflict occurred in database "bd_hybrid_sistema_central", table "dbo.cliente", column \'cliente_id\'. (547) (SQLExecDirectW); [23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The statement has been terminated. (3621)')
[SQL: 
INSERT INTO auth_audit_log (
    cliente_id,
    usuario_id,
    evento,
    nombre_usuario_intento,
    descripcion,
    exito,
    codigo_error,
    ip_address,
    user_agent,
    device_info,
    geolocation,
    metadata_json
)
OUTPUT INSERTED.log_id, INSERTED.fecha_evento
VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);
]
[parameters: (UUID('00000000-0000-0000-0000-000000000000'), UUID('2458d1ea-816b-4c3c-8d13-b90271f59558'), 'token_refresh', 'admin_acme', 'Refresh de token exitoso', 1, None, '127.0.0.1', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36', None, None, '{"client_type": "web"}')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-12-03 23:32:51,616 - app.infrastructure.database.connection_async - ERROR - [ASYNC_CONNECTION] Error en sesión async: Error en la inserción: (pyodbc.IntegrityError) ('23000', '[23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The INSERT statement conflicted with the FOREIGN KEY constraint "FK_audit_cliente". The conflict occurred in database "bd_hybrid_sistema_central", table "dbo.cliente", column \'cliente_id\'. (547) (SQLExecDirectW); [23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The statement has been terminated. (3621)')
[SQL: 
INSERT INTO auth_audit_log (
    cliente_id,
    usuario_id,
    evento,
    nombre_usuario_intento,
    descripcion,
    exito,
    codigo_error,
    ip_address,
    user_agent,
    device_info,
    geolocation,
    metadata_json
)
OUTPUT INSERTED.log_id, INSERTED.fecha_evento
VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);
]
[parameters: (UUID('00000000-0000-0000-0000-000000000000'), UUID('2458d1ea-816b-4c3c-8d13-b90271f59558'), 'token_refresh', 'admin_acme', 'Refresh de token exitoso', 1, None, '127.0.0.1', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36', None, None, '{"client_type": "web"}')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 230, in execute
    self._adapt_connection._handle_exception(error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 368, in _handle_exception
    raise error.with_traceback(exc_info[2])
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 228, in execute
    return self.await_(self._execute_async(operation, parameters))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 251, in _execute_async
    result = await self._cursor.execute(operation, parameters)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 132, in execute
    await self._run_operation(self._impl.execute, sql, *params)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 30, in _run_operation
    result = await self._conn._execute(func, *args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\concurrent\futures\thread.py", line 59, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
pyodbc.IntegrityError: ('23000', '[23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The INSERT statement conflicted with the FOREIGN KEY constraint "FK_audit_cliente". The conflict occurred in database "bd_hybrid_sistema_central", table "dbo.cliente", column \'cliente_id\'. (547) (SQLExecDirectW); [23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The statement has been terminated. (3621)')

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 366, in execute_insert
    result = await session.execute(query)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 449, in execute
    result = await greenlet_spawn(
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 203, in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2351, in execute
    return self._execute_internal(
           ^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2258, in _execute_internal
    result = conn.execute(
             ^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1419, in execute
    return meth(
           ^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\sql\elements.py", line 526, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1641, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1846, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1986, in _exec_single_context
    self._handle_dbapi_exception(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 2355, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 230, in execute
    self._adapt_connection._handle_exception(error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 368, in _handle_exception
    raise error.with_traceback(exc_info[2])
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 228, in execute
    return self.await_(self._execute_async(operation, parameters))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 251, in _execute_async
    result = await self._cursor.execute(operation, parameters)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 132, in execute
    await self._run_operation(self._impl.execute, sql, *params)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 30, in _run_operation
    result = await self._conn._execute(func, *args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\concurrent\futures\thread.py", line 59, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
sqlalchemy.exc.IntegrityError: (pyodbc.IntegrityError) ('23000', '[23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The INSERT statement conflicted with the FOREIGN KEY constraint "FK_audit_cliente". The conflict occurred in database "bd_hybrid_sistema_central", table "dbo.cliente", column \'cliente_id\'. (547) (SQLExecDirectW); [23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The statement has been terminated. (3621)')
[SQL: 
INSERT INTO auth_audit_log (
    cliente_id,
    usuario_id,
    evento,
    nombre_usuario_intento,
    descripcion,
    exito,
    codigo_error,
    ip_address,
    user_agent,
    device_info,
    geolocation,
    metadata_json
)
OUTPUT INSERTED.log_id, INSERTED.fecha_evento
VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);
]
[parameters: (UUID('00000000-0000-0000-0000-000000000000'), UUID('2458d1ea-816b-4c3c-8d13-b90271f59558'), 'token_refresh', 'admin_acme', 'Refresh de token exitoso', 1, None, '127.0.0.1', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36', None, None, '{"client_type": "web"}')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\connection_async.py", line 326, in get_db_connection
    yield session
  File "D:\base_multi_tenant_fastapi\app\core\tenant\routing.py", line 877, in get_connection_for_tenant
    yield session
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 382, in execute_insert
    raise DatabaseError(
app.core.exceptions.DatabaseError: Error en la inserción: (pyodbc.IntegrityError) ('23000', '[23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The INSERT statement conflicted with the FOREIGN KEY constraint "FK_audit_cliente". The conflict occurred in database "bd_hybrid_sistema_central", table "dbo.cliente", column \'cliente_id\'. (547) (SQLExecDirectW); [23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The statement has been terminated. (3621)')
[SQL: 
INSERT INTO auth_audit_log (
    cliente_id,
    usuario_id,
    evento,
    nombre_usuario_intento,
    descripcion,
    exito,
    codigo_error,
    ip_address,
    user_agent,
    device_info,
    geolocation,
    metadata_json
)
OUTPUT INSERTED.log_id, INSERTED.fecha_evento
VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);
]
[parameters: (UUID('00000000-0000-0000-0000-000000000000'), UUID('2458d1ea-816b-4c3c-8d13-b90271f59558'), 'token_refresh', 'admin_acme', 'Refresh de token exitoso', 1, None, '127.0.0.1', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36', None, None, '{"client_type": "web"}')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-12-03 23:32:51,626 - app.core.application.base_service - ERROR - DatabaseError en registrar_auth_event: Error en la inserción: (pyodbc.IntegrityError) ('23000', '[23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The INSERT statement conflicted with the FOREIGN KEY constraint "FK_audit_cliente". The conflict occurred in database "bd_hybrid_sistema_central", table "dbo.cliente", column \'cliente_id\'. (547) (SQLExecDirectW); [23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The statement has been terminated. (3621)')
[SQL: 
INSERT INTO auth_audit_log (
    cliente_id,
    usuario_id,
    evento,
    nombre_usuario_intento,
    descripcion,
    exito,
    codigo_error,
    ip_address,
    user_agent,
    device_info,
    geolocation,
    metadata_json
)
OUTPUT INSERTED.log_id, INSERTED.fecha_evento
VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);
]
[parameters: (UUID('00000000-0000-0000-0000-000000000000'), UUID('2458d1ea-816b-4c3c-8d13-b90271f59558'), 'token_refresh', 'admin_acme', 'Refresh de token exitoso', 1, None, '127.0.0.1', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36', None, None, '{"client_type": "web"}')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 230, in execute
    self._adapt_connection._handle_exception(error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 368, in _handle_exception
    raise error.with_traceback(exc_info[2])
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 228, in execute
    return self.await_(self._execute_async(operation, parameters))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 251, in _execute_async
    result = await self._cursor.execute(operation, parameters)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 132, in execute
    await self._run_operation(self._impl.execute, sql, *params)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 30, in _run_operation
    result = await self._conn._execute(func, *args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\concurrent\futures\thread.py", line 59, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
pyodbc.IntegrityError: ('23000', '[23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The INSERT statement conflicted with the FOREIGN KEY constraint "FK_audit_cliente". The conflict occurred in database "bd_hybrid_sistema_central", table "dbo.cliente", column \'cliente_id\'. (547) (SQLExecDirectW); [23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The statement has been terminated. (3621)')

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 366, in execute_insert
    result = await session.execute(query)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 449, in execute
    result = await greenlet_spawn(
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 203, in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2351, in execute
    return self._execute_internal(
           ^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2258, in _execute_internal
    result = conn.execute(
             ^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1419, in execute
    return meth(
           ^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\sql\elements.py", line 526, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1641, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1846, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1986, in _exec_single_context
    self._handle_dbapi_exception(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 2355, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 230, in execute
    self._adapt_connection._handle_exception(error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 368, in _handle_exception
    raise error.with_traceback(exc_info[2])
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 228, in execute
    return self.await_(self._execute_async(operation, parameters))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 251, in _execute_async
    result = await self._cursor.execute(operation, parameters)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 132, in execute
    await self._run_operation(self._impl.execute, sql, *params)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 30, in _run_operation
    result = await self._conn._execute(func, *args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\concurrent\futures\thread.py", line 59, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
sqlalchemy.exc.IntegrityError: (pyodbc.IntegrityError) ('23000', '[23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The INSERT statement conflicted with the FOREIGN KEY constraint "FK_audit_cliente". The conflict occurred in database "bd_hybrid_sistema_central", table "dbo.cliente", column \'cliente_id\'. (547) (SQLExecDirectW); [23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The statement has been terminated. (3621)')
[SQL: 
INSERT INTO auth_audit_log (
    cliente_id,
    usuario_id,
    evento,
    nombre_usuario_intento,
    descripcion,
    exito,
    codigo_error,
    ip_address,
    user_agent,
    device_info,
    geolocation,
    metadata_json
)
OUTPUT INSERTED.log_id, INSERTED.fecha_evento
VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);
]
[parameters: (UUID('00000000-0000-0000-0000-000000000000'), UUID('2458d1ea-816b-4c3c-8d13-b90271f59558'), 'token_refresh', 'admin_acme', 'Refresh de token exitoso', 1, None, '127.0.0.1', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36', None, None, '{"client_type": "web"}')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\core\application\base_service.py", line 52, in wrapper
    return await func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\modules\superadmin\application\services\audit_service.py", line 161, in registrar_auth_event
    result = await execute_insert(
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 382, in execute_insert
    raise DatabaseError(
app.core.exceptions.DatabaseError: Error en la inserción: (pyodbc.IntegrityError) ('23000', '[23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The INSERT statement conflicted with the FOREIGN KEY constraint "FK_audit_cliente". The conflict occurred in database "bd_hybrid_sistema_central", table "dbo.cliente", column \'cliente_id\'. (547) (SQLExecDirectW); [23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The statement has been terminated. (3621)')
[SQL: 
INSERT INTO auth_audit_log (
    cliente_id,
    usuario_id,
    evento,
    nombre_usuario_intento,
    descripcion,
    exito,
    codigo_error,
    ip_address,
    user_agent,
    device_info,
    geolocation,
    metadata_json
)
OUTPUT INSERTED.log_id, INSERTED.fecha_evento
VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);
]
[parameters: (UUID('00000000-0000-0000-0000-000000000000'), UUID('2458d1ea-816b-4c3c-8d13-b90271f59558'), 'token_refresh', 'admin_acme', 'Refresh de token exitoso', 1, None, '127.0.0.1', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36', None, None, '{"client_type": "web"}')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-12-03 23:32:51,628 - app.modules.auth.presentation.endpoints - ERROR - [AUDIT] Error registrando evento token_refresh (no crítico)
Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 230, in execute
    self._adapt_connection._handle_exception(error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 368, in _handle_exception
    raise error.with_traceback(exc_info[2])
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 228, in execute
    return self.await_(self._execute_async(operation, parameters))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 251, in _execute_async
    result = await self._cursor.execute(operation, parameters)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 132, in execute
    await self._run_operation(self._impl.execute, sql, *params)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 30, in _run_operation
    result = await self._conn._execute(func, *args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\concurrent\futures\thread.py", line 59, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
pyodbc.IntegrityError: ('23000', '[23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The INSERT statement conflicted with the FOREIGN KEY constraint "FK_audit_cliente". The conflict occurred in database "bd_hybrid_sistema_central", table "dbo.cliente", column \'cliente_id\'. (547) (SQLExecDirectW); [23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The statement has been terminated. (3621)')

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 366, in execute_insert
    result = await session.execute(query)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 449, in execute
    result = await greenlet_spawn(
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 203, in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2351, in execute
    return self._execute_internal(
           ^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2258, in _execute_internal
    result = conn.execute(
             ^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1419, in execute
    return meth(
           ^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\sql\elements.py", line 526, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1641, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1846, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1986, in _exec_single_context
    self._handle_dbapi_exception(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 2355, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 230, in execute
    self._adapt_connection._handle_exception(error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 368, in _handle_exception
    raise error.with_traceback(exc_info[2])
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 228, in execute
    return self.await_(self._execute_async(operation, parameters))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 251, in _execute_async
    result = await self._cursor.execute(operation, parameters)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 132, in execute
    await self._run_operation(self._impl.execute, sql, *params)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 30, in _run_operation
    result = await self._conn._execute(func, *args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\concurrent\futures\thread.py", line 59, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
sqlalchemy.exc.IntegrityError: (pyodbc.IntegrityError) ('23000', '[23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The INSERT statement conflicted with the FOREIGN KEY constraint "FK_audit_cliente". The conflict occurred in database "bd_hybrid_sistema_central", table "dbo.cliente", column \'cliente_id\'. (547) (SQLExecDirectW); [23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The statement has been terminated. (3621)')
[SQL: 
INSERT INTO auth_audit_log (
    cliente_id,
    usuario_id,
    evento,
    nombre_usuario_intento,
    descripcion,
    exito,
    codigo_error,
    ip_address,
    user_agent,
    device_info,
    geolocation,
    metadata_json
)
OUTPUT INSERTED.log_id, INSERTED.fecha_evento
VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);
]
[parameters: (UUID('00000000-0000-0000-0000-000000000000'), UUID('2458d1ea-816b-4c3c-8d13-b90271f59558'), 'token_refresh', 'admin_acme', 'Refresh de token exitoso', 1, None, '127.0.0.1', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36', None, None, '{"client_type": "web"}')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\modules\auth\presentation\endpoints.py", line 515, in refresh_access_token
    await AuditService.registrar_auth_event(
  File "D:\base_multi_tenant_fastapi\app\core\application\base_service.py", line 52, in wrapper
    return await func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\modules\superadmin\application\services\audit_service.py", line 161, in registrar_auth_event
    result = await execute_insert(
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 382, in execute_insert
    raise DatabaseError(
app.core.exceptions.DatabaseError: Error en la inserción: (pyodbc.IntegrityError) ('23000', '[23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The INSERT statement conflicted with the FOREIGN KEY constraint "FK_audit_cliente". The conflict occurred in database "bd_hybrid_sistema_central", table "dbo.cliente", column \'cliente_id\'. (547) (SQLExecDirectW); [23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The statement has been terminated. (3621)')
[SQL: 
INSERT INTO auth_audit_log (
    cliente_id,
    usuario_id,
    evento,
    nombre_usuario_intento,
    descripcion,
    exito,
    codigo_error,
    ip_address,
    user_agent,
    device_info,
    geolocation,
    metadata_json
)
OUTPUT INSERTED.log_id, INSERTED.fecha_evento
VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);
]
[parameters: (UUID('00000000-0000-0000-0000-000000000000'), UUID('2458d1ea-816b-4c3c-8d13-b90271f59558'), 'token_refresh', 'admin_acme', 'Refresh de token exitoso', 1, None, '127.0.0.1', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36', None, None, '{"client_type": "web"}')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-12-03 23:32:51,635 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/refresh/ 200 125.9ms
2025-12-03 23:32:51,639 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/auth/me/
2025-12-03 23:32:51,639 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 23:32:51,639 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': acme.app.local:5173
2025-12-03 23:32:51,639 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:32:51,639 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:32:51,639 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:32:51,646 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:32:51,646 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:32:51,646 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:32:51,654 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:32:51,654 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC
2025-12-03 23:32:51,654 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43, tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC, path=/api/v1/auth/me/
2025-12-03 23:32:51,656 - app.modules.auth.application.services.auth_service - WARNING - [SECURITY] Token de tenant 00000000-0000-0000-0000-000000000000 usado en tenant ee7bfc14-995f-4209-b4b9-99c307534a43. Usuario: admin_acme
2025-12-03 23:32:51,656 - app.modules.auth.application.services.auth_service - ERROR - Error procesando payload del token: 403: Token no válido para este tenant. Por favor, inicie sesión nuevamente.
2025-12-03 23:32:51,657 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/auth/me/ 401 17.5ms
2025-12-03 23:32:51,661 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/refresh/
2025-12-03 23:32:51,661 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 23:32:51,661 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': acme.app.local:5173
2025-12-03 23:32:51,663 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:32:51,663 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:32:51,664 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:32:51,668 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:32:51,669 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:32:51,670 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:32:51,674 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:32:51,675 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC
2025-12-03 23:32:51,675 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43, tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC, path=/api/v1/auth/refresh/
2025-12-03 23:32:51,679 - app.modules.auth.application.services.refresh_token_service - WARNING - [VALIDATE-TOKEN] Token no encontrado, revocado o expirado - Cliente ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:32:51,680 - app.modules.auth.application.services.auth_service - WARNING - [REFRESH] Token JWT válido, pero inactivo/revocado en BD. Usuario: admin_acme
2025-12-03 23:32:51,689 - app.infrastructure.database.queries_async - ERROR - Error en execute_insert async (TextClause): (pyodbc.IntegrityError) ('23000', '[23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The INSERT statement conflicted with the FOREIGN KEY constraint "FK_audit_cliente". The conflict occurred in database "bd_hybrid_sistema_central", table "dbo.cliente", column \'cliente_id\'. (547) (SQLExecDirectW); [23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The statement has been terminated. (3621)')
[SQL: 
INSERT INTO auth_audit_log (
    cliente_id,
    usuario_id,
    evento,
    nombre_usuario_intento,
    descripcion,
    exito,
    codigo_error,
    ip_address,
    user_agent,
    device_info,
    geolocation,
    metadata_json
)
OUTPUT INSERTED.log_id, INSERTED.fecha_evento
VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);
]
[parameters: (UUID('00000000-0000-0000-0000-000000000000'), None, 'token_invalid_or_revoked', 'admin_acme', 'Refresh token inválido, expirado o revocado en base de datos', 0, 'REFRESH_TOKEN_INVALID_DB', '127.0.0.1', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36', None, None, '{"client_type": "web"}')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-12-03 23:32:51,689 - app.infrastructure.database.connection_async - ERROR - [ASYNC_CONNECTION] Error en sesión async: Error en la inserción: (pyodbc.IntegrityError) ('23000', '[23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The INSERT statement conflicted with the FOREIGN KEY constraint "FK_audit_cliente". The conflict occurred in database "bd_hybrid_sistema_central", table "dbo.cliente", column \'cliente_id\'. (547) (SQLExecDirectW); [23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The statement has been terminated. (3621)')
[SQL: 
INSERT INTO auth_audit_log (
    cliente_id,
    usuario_id,
    evento,
    nombre_usuario_intento,
    descripcion,
    exito,
    codigo_error,
    ip_address,
    user_agent,
    device_info,
    geolocation,
    metadata_json
)
OUTPUT INSERTED.log_id, INSERTED.fecha_evento
VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);
]
[parameters: (UUID('00000000-0000-0000-0000-000000000000'), None, 'token_invalid_or_revoked', 'admin_acme', 'Refresh token inválido, expirado o revocado en base de datos', 0, 'REFRESH_TOKEN_INVALID_DB', '127.0.0.1', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36', None, None, '{"client_type": "web"}')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 230, in execute
    self._adapt_connection._handle_exception(error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 368, in _handle_exception
    raise error.with_traceback(exc_info[2])
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 228, in execute
    return self.await_(self._execute_async(operation, parameters))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 251, in _execute_async
    result = await self._cursor.execute(operation, parameters)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 132, in execute
    await self._run_operation(self._impl.execute, sql, *params)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 30, in _run_operation
    result = await self._conn._execute(func, *args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\concurrent\futures\thread.py", line 59, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
pyodbc.IntegrityError: ('23000', '[23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The INSERT statement conflicted with the FOREIGN KEY constraint "FK_audit_cliente". The conflict occurred in database "bd_hybrid_sistema_central", table "dbo.cliente", column \'cliente_id\'. (547) (SQLExecDirectW); [23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The statement has been terminated. (3621)')

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 366, in execute_insert
    result = await session.execute(query)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 449, in execute
    result = await greenlet_spawn(
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 203, in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2351, in execute
    return self._execute_internal(
           ^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2258, in _execute_internal
    result = conn.execute(
             ^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1419, in execute
    return meth(
           ^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\sql\elements.py", line 526, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1641, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1846, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1986, in _exec_single_context
    self._handle_dbapi_exception(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 2355, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 230, in execute
    self._adapt_connection._handle_exception(error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 368, in _handle_exception
    raise error.with_traceback(exc_info[2])
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 228, in execute
    return self.await_(self._execute_async(operation, parameters))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 251, in _execute_async
    result = await self._cursor.execute(operation, parameters)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 132, in execute
    await self._run_operation(self._impl.execute, sql, *params)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 30, in _run_operation
    result = await self._conn._execute(func, *args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\concurrent\futures\thread.py", line 59, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
sqlalchemy.exc.IntegrityError: (pyodbc.IntegrityError) ('23000', '[23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The INSERT statement conflicted with the FOREIGN KEY constraint "FK_audit_cliente". The conflict occurred in database "bd_hybrid_sistema_central", table "dbo.cliente", column \'cliente_id\'. (547) (SQLExecDirectW); [23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The statement has been terminated. (3621)')
[SQL: 
INSERT INTO auth_audit_log (
    cliente_id,
    usuario_id,
    evento,
    nombre_usuario_intento,
    descripcion,
    exito,
    codigo_error,
    ip_address,
    user_agent,
    device_info,
    geolocation,
    metadata_json
)
OUTPUT INSERTED.log_id, INSERTED.fecha_evento
VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);
]
[parameters: (UUID('00000000-0000-0000-0000-000000000000'), None, 'token_invalid_or_revoked', 'admin_acme', 'Refresh token inválido, expirado o revocado en base de datos', 0, 'REFRESH_TOKEN_INVALID_DB', '127.0.0.1', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36', None, None, '{"client_type": "web"}')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\connection_async.py", line 326, in get_db_connection
    yield session
  File "D:\base_multi_tenant_fastapi\app\core\tenant\routing.py", line 877, in get_connection_for_tenant
    yield session
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 382, in execute_insert
    raise DatabaseError(
app.core.exceptions.DatabaseError: Error en la inserción: (pyodbc.IntegrityError) ('23000', '[23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The INSERT statement conflicted with the FOREIGN KEY constraint "FK_audit_cliente". The conflict occurred in database "bd_hybrid_sistema_central", table "dbo.cliente", column \'cliente_id\'. (547) (SQLExecDirectW); [23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The statement has been terminated. (3621)')
[SQL: 
INSERT INTO auth_audit_log (
    cliente_id,
    usuario_id,
    evento,
    nombre_usuario_intento,
    descripcion,
    exito,
    codigo_error,
    ip_address,
    user_agent,
    device_info,
    geolocation,
    metadata_json
)
OUTPUT INSERTED.log_id, INSERTED.fecha_evento
VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);
]
[parameters: (UUID('00000000-0000-0000-0000-000000000000'), None, 'token_invalid_or_revoked', 'admin_acme', 'Refresh token inválido, expirado o revocado en base de datos', 0, 'REFRESH_TOKEN_INVALID_DB', '127.0.0.1', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36', None, None, '{"client_type": "web"}')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-12-03 23:32:51,693 - app.core.application.base_service - ERROR - DatabaseError en registrar_auth_event: Error en la inserción: (pyodbc.IntegrityError) ('23000', '[23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The INSERT statement conflicted with the FOREIGN KEY constraint "FK_audit_cliente". The conflict occurred in database "bd_hybrid_sistema_central", table "dbo.cliente", column \'cliente_id\'. (547) (SQLExecDirectW); [23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The statement has been terminated. (3621)')
[SQL: 
INSERT INTO auth_audit_log (
    cliente_id,
    usuario_id,
    evento,
    nombre_usuario_intento,
    descripcion,
    exito,
    codigo_error,
    ip_address,
    user_agent,
    device_info,
    geolocation,
    metadata_json
)
OUTPUT INSERTED.log_id, INSERTED.fecha_evento
VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);
]
[parameters: (UUID('00000000-0000-0000-0000-000000000000'), None, 'token_invalid_or_revoked', 'admin_acme', 'Refresh token inválido, expirado o revocado en base de datos', 0, 'REFRESH_TOKEN_INVALID_DB', '127.0.0.1', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36', None, None, '{"client_type": "web"}')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 230, in execute
    self._adapt_connection._handle_exception(error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 368, in _handle_exception
    raise error.with_traceback(exc_info[2])
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 228, in execute
    return self.await_(self._execute_async(operation, parameters))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 251, in _execute_async
    result = await self._cursor.execute(operation, parameters)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 132, in execute
    await self._run_operation(self._impl.execute, sql, *params)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 30, in _run_operation
    result = await self._conn._execute(func, *args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\concurrent\futures\thread.py", line 59, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
pyodbc.IntegrityError: ('23000', '[23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The INSERT statement conflicted with the FOREIGN KEY constraint "FK_audit_cliente". The conflict occurred in database "bd_hybrid_sistema_central", table "dbo.cliente", column \'cliente_id\'. (547) (SQLExecDirectW); [23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The statement has been terminated. (3621)')

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 366, in execute_insert
    result = await session.execute(query)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 449, in execute
    result = await greenlet_spawn(
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 203, in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2351, in execute
    return self._execute_internal(
           ^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2258, in _execute_internal
    result = conn.execute(
             ^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1419, in execute
    return meth(
           ^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\sql\elements.py", line 526, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1641, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1846, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1986, in _exec_single_context
    self._handle_dbapi_exception(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 2355, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 230, in execute
    self._adapt_connection._handle_exception(error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 368, in _handle_exception
    raise error.with_traceback(exc_info[2])
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 228, in execute
    return self.await_(self._execute_async(operation, parameters))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 251, in _execute_async
    result = await self._cursor.execute(operation, parameters)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 132, in execute
    await self._run_operation(self._impl.execute, sql, *params)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 30, in _run_operation
    result = await self._conn._execute(func, *args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\concurrent\futures\thread.py", line 59, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
sqlalchemy.exc.IntegrityError: (pyodbc.IntegrityError) ('23000', '[23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The INSERT statement conflicted with the FOREIGN KEY constraint "FK_audit_cliente". The conflict occurred in database "bd_hybrid_sistema_central", table "dbo.cliente", column \'cliente_id\'. (547) (SQLExecDirectW); [23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The statement has been terminated. (3621)')
[SQL: 
INSERT INTO auth_audit_log (
    cliente_id,
    usuario_id,
    evento,
    nombre_usuario_intento,
    descripcion,
    exito,
    codigo_error,
    ip_address,
    user_agent,
    device_info,
    geolocation,
    metadata_json
)
OUTPUT INSERTED.log_id, INSERTED.fecha_evento
VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);
]
[parameters: (UUID('00000000-0000-0000-0000-000000000000'), None, 'token_invalid_or_revoked', 'admin_acme', 'Refresh token inválido, expirado o revocado en base de datos', 0, 'REFRESH_TOKEN_INVALID_DB', '127.0.0.1', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36', None, None, '{"client_type": "web"}')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\core\application\base_service.py", line 52, in wrapper
    return await func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\modules\superadmin\application\services\audit_service.py", line 161, in registrar_auth_event
    result = await execute_insert(
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 382, in execute_insert
    raise DatabaseError(
app.core.exceptions.DatabaseError: Error en la inserción: (pyodbc.IntegrityError) ('23000', '[23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The INSERT statement conflicted with the FOREIGN KEY constraint "FK_audit_cliente". The conflict occurred in database "bd_hybrid_sistema_central", table "dbo.cliente", column \'cliente_id\'. (547) (SQLExecDirectW); [23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The statement has been terminated. (3621)')
[SQL: 
INSERT INTO auth_audit_log (
    cliente_id,
    usuario_id,
    evento,
    nombre_usuario_intento,
    descripcion,
    exito,
    codigo_error,
    ip_address,
    user_agent,
    device_info,
    geolocation,
    metadata_json
)
OUTPUT INSERTED.log_id, INSERTED.fecha_evento
VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);
]
[parameters: (UUID('00000000-0000-0000-0000-000000000000'), None, 'token_invalid_or_revoked', 'admin_acme', 'Refresh token inválido, expirado o revocado en base de datos', 0, 'REFRESH_TOKEN_INVALID_DB', '127.0.0.1', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36', None, None, '{"client_type": "web"}')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-12-03 23:32:51,696 - app.modules.auth.application.services.auth_service - ERROR - [AUDIT] Error registrando evento token_invalid_or_revoked (no crítico)
Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 230, in execute
    self._adapt_connection._handle_exception(error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 368, in _handle_exception
    raise error.with_traceback(exc_info[2])
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 228, in execute
    return self.await_(self._execute_async(operation, parameters))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 251, in _execute_async
    result = await self._cursor.execute(operation, parameters)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 132, in execute
    await self._run_operation(self._impl.execute, sql, *params)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 30, in _run_operation
    result = await self._conn._execute(func, *args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\concurrent\futures\thread.py", line 59, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
pyodbc.IntegrityError: ('23000', '[23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The INSERT statement conflicted with the FOREIGN KEY constraint "FK_audit_cliente". The conflict occurred in database "bd_hybrid_sistema_central", table "dbo.cliente", column \'cliente_id\'. (547) (SQLExecDirectW); [23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The statement has been terminated. (3621)')

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 366, in execute_insert
    result = await session.execute(query)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 449, in execute
    result = await greenlet_spawn(
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 203, in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2351, in execute
    return self._execute_internal(
           ^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2258, in _execute_internal
    result = conn.execute(
             ^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1419, in execute
    return meth(
           ^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\sql\elements.py", line 526, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1641, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1846, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1986, in _exec_single_context
    self._handle_dbapi_exception(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 2355, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\engine\default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 230, in execute
    self._adapt_connection._handle_exception(error)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 368, in _handle_exception
    raise error.with_traceback(exc_info[2])
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 228, in execute
    return self.await_(self._execute_async(operation, parameters))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\sqlalchemy\connectors\asyncio.py", line 251, in _execute_async
    result = await self._cursor.execute(operation, parameters)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 132, in execute
    await self._run_operation(self._impl.execute, sql, *params)
  File "D:\base_multi_tenant_fastapi\venv\Lib\site-packages\aioodbc\cursor.py", line 30, in _run_operation
    result = await self._conn._execute(func, *args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Carlos\AppData\Local\Programs\Python\Python312\Lib\concurrent\futures\thread.py", line 59, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
sqlalchemy.exc.IntegrityError: (pyodbc.IntegrityError) ('23000', '[23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The INSERT statement conflicted with the FOREIGN KEY constraint "FK_audit_cliente". The conflict occurred in database "bd_hybrid_sistema_central", table "dbo.cliente", column \'cliente_id\'. (547) (SQLExecDirectW); [23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The statement has been terminated. (3621)')
[SQL: 
INSERT INTO auth_audit_log (
    cliente_id,
    usuario_id,
    evento,
    nombre_usuario_intento,
    descripcion,
    exito,
    codigo_error,
    ip_address,
    user_agent,
    device_info,
    geolocation,
    metadata_json
)
OUTPUT INSERTED.log_id, INSERTED.fecha_evento
VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);
]
[parameters: (UUID('00000000-0000-0000-0000-000000000000'), None, 'token_invalid_or_revoked', 'admin_acme', 'Refresh token inválido, expirado o revocado en base de datos', 0, 'REFRESH_TOKEN_INVALID_DB', '127.0.0.1', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36', None, None, '{"client_type": "web"}')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\base_multi_tenant_fastapi\app\modules\auth\application\services\auth_service.py", line 542, in get_current_user_from_refresh
    await AuditService.registrar_auth_event(
  File "D:\base_multi_tenant_fastapi\app\core\application\base_service.py", line 52, in wrapper
    return await func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\modules\superadmin\application\services\audit_service.py", line 161, in registrar_auth_event
    result = await execute_insert(
             ^^^^^^^^^^^^^^^^^^^^^
  File "D:\base_multi_tenant_fastapi\app\infrastructure\database\queries_async.py", line 382, in execute_insert
    raise DatabaseError(
app.core.exceptions.DatabaseError: Error en la inserción: (pyodbc.IntegrityError) ('23000', '[23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The INSERT statement conflicted with the FOREIGN KEY constraint "FK_audit_cliente". The conflict occurred in database "bd_hybrid_sistema_central", table "dbo.cliente", column \'cliente_id\'. (547) (SQLExecDirectW); [23000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The statement has been terminated. (3621)')
[SQL: 
INSERT INTO auth_audit_log (
    cliente_id,
    usuario_id,
    evento,
    nombre_usuario_intento,
    descripcion,
    exito,
    codigo_error,
    ip_address,
    user_agent,
    device_info,
    geolocation,
    metadata_json
)
OUTPUT INSERTED.log_id, INSERTED.fecha_evento
VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);
]
[parameters: (UUID('00000000-0000-0000-0000-000000000000'), None, 'token_invalid_or_revoked', 'admin_acme', 'Refresh token inválido, expirado o revocado en base de datos', 0, 'REFRESH_TOKEN_INVALID_DB', '127.0.0.1', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36', None, None, '{"client_type": "web"}')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-12-03 23:32:51,702 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/refresh/ 401 41.6ms
2025-12-03 23:36:42,787 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Pool ADMIN inicializado. Size=10, MaxOverflow=5
2025-12-03 23:36:42,787 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Configuración de pools de tenants: MaxPools=50, PoolSize=3, MaxOverflow=2, InactivityTimeout=3600s
2025-12-03 23:36:42,788 - app.infrastructure.database.connection_pool - INFO - ✅ Módulo de connection pooling cargado y activo
2025-12-03 23:36:42,788 - app.infrastructure.database.connection_pool - INFO -    Configuración: MaxTenantPools=50, TenantPoolSize=3, InactivityTimeout=3600s
2025-12-03 23:36:42,789 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Todos los pools cerrados
2025-12-03 23:36:42,789 - app.main - INFO - ✅ Pools de conexión cerrados correctamente
2025-12-03 23:36:42,899 - asyncio - ERROR - Unclosed connection
connection: <aioodbc.connection.Connection object at 0x00000172334C3650>
2025-12-03 23:36:42,899 - asyncio - ERROR - Unclosed connection
connection: <aioodbc.connection.Connection object at 0x0000017233D46060>
2025-12-03 23:36:42,899 - asyncio - ERROR - Unclosed connection
connection: <aioodbc.connection.Connection object at 0x0000017233D47140>
2025-12-03 23:36:42,899 - asyncio - ERROR - Unclosed connection
connection: <aioodbc.connection.Connection object at 0x0000017233D0A660>
2025-12-03 23:36:42,904 - asyncio - ERROR - Unclosed connection
connection: <aioodbc.connection.Connection object at 0x0000017233D67AA0>
2025-12-03 23:36:42,905 - asyncio - ERROR - Unclosed connection
connection: <aioodbc.connection.Connection object at 0x0000017233D67FE0>
2025-12-03 23:36:42,905 - asyncio - ERROR - Unclosed connection
connection: <aioodbc.connection.Connection object at 0x0000017233D844D0>
2025-12-03 23:36:43,753 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 23:36:44,000 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 23:36:44,007 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 23:36:44,011 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 23:36:44,011 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 23:36:44,012 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 23:36:44,012 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 23:36:44,014 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, DEFAULT_TYPE=single
2025-12-03 23:36:44,419 - app.core.security.rate_limiting - INFO - [RATE_LIMITING] Activado. Límites: Login=10/minute, API=200/minute
2025-12-03 23:36:44,423 - app.core.security.rate_limiting - INFO - ✅ Módulo de rate limiting cargado y activo
2025-12-03 23:36:44,528 - app.core.authorization.rbac - INFO - 🔐 Inicializando sistema de autorización...
2025-12-03 23:36:44,528 - app.core.authorization.rbac - INFO - ✅ Sistema de autorización inicializado correctamente
2025-12-03 23:36:44,529 - app.core.authorization.rbac - INFO - 📊 Permisos del sistema: 6 módulos configurados
2025-12-03 23:36:44,761 - app.core.tenant.middleware - INFO - Módulo tenant_middleware cargado (versión híbrida con soporte para proxies)
2025-12-03 23:36:44,762 - app.main - INFO - ✅ Rate limiting configurado y activo
2025-12-03 23:36:44,910 - app.core.tenant.middleware - INFO - [TENANT_MW] Inicializado - BASE_DOMAIN=app.local, SYSTEM_ID=BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, EXCLUDED_SUBDOMAINS={'backend', 'api', 'www', 'cdn', 'static', 'admin', 'assets'}
2025-12-03 23:37:37,947 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Pool ADMIN inicializado. Size=10, MaxOverflow=5
2025-12-03 23:37:37,948 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Configuración de pools de tenants: MaxPools=50, PoolSize=3, MaxOverflow=2, InactivityTimeout=3600s
2025-12-03 23:37:37,949 - app.infrastructure.database.connection_pool - INFO - ✅ Módulo de connection pooling cargado y activo
2025-12-03 23:37:37,949 - app.infrastructure.database.connection_pool - INFO -    Configuración: MaxTenantPools=50, TenantPoolSize=3, InactivityTimeout=3600s
2025-12-03 23:37:37,949 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Todos los pools cerrados
2025-12-03 23:37:37,951 - app.main - INFO - ✅ Pools de conexión cerrados correctamente
2025-12-03 23:37:38,786 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 23:37:38,980 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 23:37:38,980 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 23:37:38,989 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 23:37:38,989 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 23:37:38,991 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 23:37:38,991 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 23:37:38,992 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, DEFAULT_TYPE=single
2025-12-03 23:37:39,312 - app.core.security.rate_limiting - INFO - [RATE_LIMITING] Activado. Límites: Login=10/minute, API=200/minute
2025-12-03 23:37:39,312 - app.core.security.rate_limiting - INFO - ✅ Módulo de rate limiting cargado y activo
2025-12-03 23:37:39,381 - app.core.authorization.rbac - INFO - 🔐 Inicializando sistema de autorización...
2025-12-03 23:37:39,381 - app.core.authorization.rbac - INFO - ✅ Sistema de autorización inicializado correctamente
2025-12-03 23:37:39,381 - app.core.authorization.rbac - INFO - 📊 Permisos del sistema: 6 módulos configurados
2025-12-03 23:37:39,537 - app.core.tenant.middleware - INFO - Módulo tenant_middleware cargado (versión híbrida con soporte para proxies)
2025-12-03 23:37:39,540 - app.main - INFO - ✅ Rate limiting configurado y activo
2025-12-03 23:37:39,687 - app.core.tenant.middleware - INFO - [TENANT_MW] Inicializado - BASE_DOMAIN=app.local, SYSTEM_ID=BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, EXCLUDED_SUBDOMAINS={'static', 'assets', 'admin', 'www', 'cdn', 'backend', 'api'}
2025-12-03 23:37:40,664 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Pool ADMIN inicializado. Size=10, MaxOverflow=5
2025-12-03 23:37:40,664 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Configuración de pools de tenants: MaxPools=50, PoolSize=3, MaxOverflow=2, InactivityTimeout=3600s
2025-12-03 23:37:40,664 - app.infrastructure.database.connection_pool - INFO - ✅ Módulo de connection pooling cargado y activo
2025-12-03 23:37:40,664 - app.infrastructure.database.connection_pool - INFO -    Configuración: MaxTenantPools=50, TenantPoolSize=3, InactivityTimeout=3600s
2025-12-03 23:37:40,664 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Todos los pools cerrados
2025-12-03 23:37:40,664 - app.main - INFO - ✅ Pools de conexión cerrados correctamente
2025-12-03 23:37:42,601 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 23:37:42,804 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 23:37:42,811 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 23:37:42,813 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 23:37:42,813 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 23:37:42,814 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 23:37:42,815 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 23:37:42,815 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, DEFAULT_TYPE=single
2025-12-03 23:37:43,197 - app.core.security.rate_limiting - INFO - [RATE_LIMITING] Activado. Límites: Login=10/minute, API=200/minute
2025-12-03 23:37:43,198 - app.core.security.rate_limiting - INFO - ✅ Módulo de rate limiting cargado y activo
2025-12-03 23:37:43,273 - app.core.authorization.rbac - INFO - 🔐 Inicializando sistema de autorización...
2025-12-03 23:37:43,274 - app.core.authorization.rbac - INFO - ✅ Sistema de autorización inicializado correctamente
2025-12-03 23:37:43,274 - app.core.authorization.rbac - INFO - 📊 Permisos del sistema: 6 módulos configurados
2025-12-03 23:37:43,435 - app.core.tenant.middleware - INFO - Módulo tenant_middleware cargado (versión híbrida con soporte para proxies)
2025-12-03 23:37:43,436 - app.main - INFO - ✅ Rate limiting configurado y activo
2025-12-03 23:37:43,582 - app.core.tenant.middleware - INFO - [TENANT_MW] Inicializado - BASE_DOMAIN=app.local, SYSTEM_ID=BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, EXCLUDED_SUBDOMAINS={'assets', 'static', 'www', 'backend', 'cdn', 'admin', 'api'}
2025-12-03 23:37:53,145 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/login/
2025-12-03 23:37:53,145 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 23:37:53,147 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': acme.app.local:5173
2025-12-03 23:37:53,147 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:37:53,148 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:37:53,148 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:37:53,151 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] AsyncEngine creado para admin
2025-12-03 23:37:53,300 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:37:53,300 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:37:53,300 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:37:53,300 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:37:57,413 - app.infrastructure.cache.redis_cache - WARNING - [REDIS_CACHE] Error conectando a Redis: Error 10061 connecting to localhost:6379. No se puede establecer una conexión ya que el equipo de destino denegó expresamente dicha conexión.. Cache desactivado automáticamente (usando fallback en memoria).
2025-12-03 23:37:57,413 - app.infrastructure.cache.redis_cache - INFO - ℹ️ Módulo de Redis cache cargado pero desactivado (usando fallback en memoria)
2025-12-03 23:37:57,420 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC
2025-12-03 23:37:57,420 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43, tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC, path=/api/v1/auth/login/
2025-12-03 23:37:57,433 - app.modules.auth.presentation.endpoints - INFO - Cliente ee7bfc14-995f-4209-b4b9-99c307534a43 resuelto y validado para login.
2025-12-03 23:37:57,434 - app.modules.auth.application.services.auth_service - INFO - [AUTH] Intento de login: username='admin_acme', cliente_id_destino=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:37:57,434 - app.modules.auth.application.services.auth_service - INFO - [AUTH] Usuario regular. Buscando en BD del cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:37:57,435 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] AsyncEngine creado para tenant_ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:37:57,751 - app.modules.auth.application.services.auth_service - INFO - Niveles calculados - Usuario 2458D1EA-816B-4C3C-8D13-B90271F59558: level=4, super_admin=False, type=tenant_admin
2025-12-03 23:37:57,751 - app.modules.auth.application.services.auth_service - INFO - [AUTH] Login exitoso: username='admin_acme', usuario_id=2458D1EA-816B-4C3C-8D13-B90271F59558, cliente_origen=00000000-0000-0000-0000-000000000000, cliente_destino=N/A, access_level=4, user_type=tenant_admin
2025-12-03 23:37:57,751 - app.infrastructure.database.queries_async - WARNING - [QUERY] DEPRECATED: execute_query() recibió string SQL. Migrar a SQLAlchemy Core.
2025-12-03 23:37:57,768 - app.modules.auth.application.services.auth_service - INFO - Niveles calculados - Usuario 2458D1EA-816B-4C3C-8D13-B90271F59558: level=4, super_admin=False, type=tenant_admin
2025-12-03 23:37:57,772 - app.modules.auth.application.services.refresh_token_service - INFO - [STORE-TOKEN] Token insertado exitosamente - Cliente 00000000-0000-0000-0000-000000000000, Usuario 2458D1EA-816B-4C3C-8D13-B90271F59558, Tipo: web, Token ID: 322EDA4D-F250-42B3-9911-0092DF7633C5, Rotación: False
2025-12-03 23:37:57,772 - app.modules.auth.presentation.endpoints - INFO - [LOGIN-WEB] Token almacenado - ID: 322EDA4D-F250-42B3-9911-0092DF7633C5
2025-12-03 23:37:57,772 - app.modules.auth.presentation.endpoints - INFO - Usuario admin_acme autenticado exitosamente (WEB) para cliente ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:37:57,786 - app.modules.superadmin.application.services.audit_service - INFO - [AUDIT] auth_audit_log registrado: evento=login_success, cliente_id=00000000-0000-0000-0000-000000000000, usuario_id=2458D1EA-816B-4C3C-8D13-B90271F59558, exito=True
2025-12-03 23:37:57,787 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/login/ 200 4642.5ms
2025-12-03 23:37:57,803 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/clientes/tenant/branding
2025-12-03 23:37:57,803 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/clientes/tenant/branding 200 1.1ms
2025-12-03 23:37:57,806 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/clientes/tenant/branding
2025-12-03 23:37:57,807 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 23:37:57,808 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': acme.app.local:5173
2025-12-03 23:37:57,808 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:37:57,809 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:37:57,809 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:37:57,818 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/menus/getmenu/
2025-12-03 23:37:57,820 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/menus/getmenu/ 200 2.4ms
2025-12-03 23:37:57,822 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:37:57,823 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:37:57,823 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:37:57,826 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/areas/
2025-12-03 23:37:57,828 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/menus/getmenu/
2025-12-03 23:37:57,829 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/areas/
2025-12-03 23:37:57,829 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/areas/ 200 4.3ms
2025-12-03 23:37:57,830 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/menus/getmenu/ 200 3.1ms
2025-12-03 23:37:57,832 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/areas/ 200 3.1ms
2025-12-03 23:37:57,836 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/menus/getmenu/
2025-12-03 23:37:57,839 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 23:37:57,839 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': acme.app.local:5173
2025-12-03 23:37:57,840 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:37:57,840 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:37:57,841 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:37:57,841 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/areas/
2025-12-03 23:37:57,841 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 23:37:57,841 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': acme.app.local:5173
2025-12-03 23:37:57,841 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:37:57,841 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:37:57,847 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:37:57,853 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:37:57,853 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC
2025-12-03 23:37:57,854 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43, tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC, path=/api/v1/clientes/tenant/branding
2025-12-03 23:37:57,861 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:37:57,861 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:37:57,861 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:37:57,866 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:37:57,867 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:37:57,867 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:37:57,876 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:37:57,877 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC
2025-12-03 23:37:57,877 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43, tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC, path=/api/v1/menus/getmenu/
2025-12-03 23:37:57,882 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:37:57,883 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC
2025-12-03 23:37:57,884 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43, tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC, path=/api/v1/areas/
2025-12-03 23:37:57,892 - app.api.deps - WARNING - [SECURITY] Acceso denegado: usuario 'admin_acme' (cliente 00000000-0000-0000-0000-000000000000) intentó acceder a cliente ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:37:57,892 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/clientes/tenant/branding 403 89.4ms
2025-12-03 23:37:57,902 - app.api.deps - WARNING - [SECURITY] Acceso denegado: usuario 'admin_acme' (cliente 00000000-0000-0000-0000-000000000000) intentó acceder a cliente ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:37:57,903 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/menus/getmenu/ 403 67.3ms
2025-12-03 23:37:57,905 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/menus/getmenu/
2025-12-03 23:37:57,906 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 23:37:57,907 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': acme.app.local:5173
2025-12-03 23:37:57,907 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:37:57,908 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:37:57,908 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:37:57,912 - app.api.deps - WARNING - [SECURITY] Acceso denegado: usuario 'admin_acme' (cliente 00000000-0000-0000-0000-000000000000) intentó acceder a cliente ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:37:57,913 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/areas/ 403 69.9ms
2025-12-03 23:37:57,915 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/areas/
2025-12-03 23:37:57,917 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 23:37:57,918 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': acme.app.local:5173
2025-12-03 23:37:57,918 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:37:57,919 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:37:57,919 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:37:57,922 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:37:57,923 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:37:57,923 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:37:57,928 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:37:57,928 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:37:57,929 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:37:57,931 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:37:57,932 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC
2025-12-03 23:37:57,932 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43, tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC, path=/api/v1/menus/getmenu/
2025-12-03 23:37:57,939 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:37:57,939 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC
2025-12-03 23:37:57,940 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43, tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC, path=/api/v1/areas/
2025-12-03 23:37:57,951 - app.api.deps - WARNING - [SECURITY] Acceso denegado: usuario 'admin_acme' (cliente 00000000-0000-0000-0000-000000000000) intentó acceder a cliente ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:37:57,952 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/menus/getmenu/ 403 46.6ms
2025-12-03 23:37:57,956 - app.api.deps - WARNING - [SECURITY] Acceso denegado: usuario 'admin_acme' (cliente 00000000-0000-0000-0000-000000000000) intentó acceder a cliente ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:37:57,957 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/areas/ 403 41.2ms
2025-12-03 23:38:02,633 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/auth/logout/
2025-12-03 23:38:02,634 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/auth/logout/ 200 0.9ms
2025-12-03 23:38:02,636 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/logout/
2025-12-03 23:38:02,636 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 23:38:02,636 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': acme.app.local:5173
2025-12-03 23:38:02,636 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:38:02,638 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:38:02,638 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:38:02,643 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:38:02,643 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:38:02,644 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:38:02,647 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:38:02,648 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC
2025-12-03 23:38:02,648 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43, tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC, path=/api/v1/auth/logout/
2025-12-03 23:38:02,649 - app.modules.auth.application.services.auth_service - WARNING - [SECURITY] Token de tenant 00000000-0000-0000-0000-000000000000 usado en tenant ee7bfc14-995f-4209-b4b9-99c307534a43. Usuario: admin_acme
2025-12-03 23:38:02,649 - app.modules.auth.application.services.auth_service - ERROR - Error procesando payload del token: 403: Token no válido para este tenant. Por favor, inicie sesión nuevamente.
2025-12-03 23:38:02,651 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/logout/ 401 15.3ms
2025-12-03 23:38:02,654 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/refresh/
2025-12-03 23:38:02,655 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 23:38:02,655 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': acme.app.local:5173
2025-12-03 23:38:02,656 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:38:02,656 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:38:02,657 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:38:02,662 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:38:02,662 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:38:02,662 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:38:02,667 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:38:02,667 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC
2025-12-03 23:38:02,668 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43, tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC, path=/api/v1/auth/refresh/
2025-12-03 23:38:02,677 - app.modules.auth.application.services.refresh_token_service - WARNING - [VALIDATE-TOKEN] Token no encontrado, revocado o expirado - Cliente ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:38:02,677 - app.modules.auth.application.services.auth_service - WARNING - [REFRESH] Token JWT válido, pero inactivo/revocado en BD. Usuario: admin_acme
2025-12-03 23:38:02,685 - app.modules.superadmin.application.services.audit_service - INFO - [AUDIT] auth_audit_log registrado: evento=token_invalid_or_revoked, cliente_id=00000000-0000-0000-0000-000000000000, usuario_id=None, exito=False
2025-12-03 23:38:02,688 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/refresh/ 401 33.5ms
2025-12-03 23:38:17,545 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/auth/login/
2025-12-03 23:38:17,548 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/auth/login/ 200 0.9ms
2025-12-03 23:38:17,550 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/login/
2025-12-03 23:38:17,550 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 23:38:17,551 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 23:38:17,551 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 23:38:17,552 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:38:17,552 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 23:38:17,554 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 23:38:17,554 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:38:17,555 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 23:38:17,555 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 23:38:17,556 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: tipo_instalacion=cloud, db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 23:38:17,556 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, tipo_instalacion=cloud, db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A, path=/api/v1/auth/login/
2025-12-03 23:38:17,561 - app.modules.auth.presentation.endpoints - INFO - Cliente bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7 resuelto y validado para login.
2025-12-03 23:38:17,561 - app.modules.auth.application.services.auth_service - INFO - [AUTH] Intento de login: username='superadmin', cliente_id_destino=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 23:38:17,561 - app.modules.auth.application.services.auth_service - INFO - [AUTH] SUPERADMIN detectado. Buscando en BD ADMIN (cliente_id=BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7), accediendo a cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 23:38:17,791 - app.modules.auth.application.services.auth_service - INFO - Niveles calculados - Usuario 154134AD-A5EB-4F45-AEF0-5F9AAA282C8E: level=5, super_admin=True, type=super_admin
2025-12-03 23:38:17,791 - app.modules.auth.application.services.auth_service - INFO - [AUTH] Login exitoso: username='superadmin', usuario_id=154134AD-A5EB-4F45-AEF0-5F9AAA282C8E, cliente_origen=BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, cliente_destino=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, access_level=5, user_type=super_admin
2025-12-03 23:38:17,791 - app.modules.auth.presentation.endpoints - INFO - [LOGIN] Superadmin accediendo a cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 23:38:17,797 - app.modules.auth.application.services.auth_service - INFO - Niveles calculados - Usuario 154134AD-A5EB-4F45-AEF0-5F9AAA282C8E: level=5, super_admin=True, type=super_admin
2025-12-03 23:38:17,806 - app.modules.auth.application.services.refresh_token_service - INFO - [STORE-TOKEN] Token insertado exitosamente - Cliente bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, Usuario 154134AD-A5EB-4F45-AEF0-5F9AAA282C8E, Tipo: web, Token ID: 08467050-3B07-451A-891B-EF12A081E9DB, Rotación: False
2025-12-03 23:38:17,806 - app.modules.auth.presentation.endpoints - INFO - [LOGIN-WEB] Token almacenado - ID: 08467050-3B07-451A-891B-EF12A081E9DB
2025-12-03 23:38:17,806 - app.modules.auth.presentation.endpoints - INFO - Usuario superadmin autenticado exitosamente (WEB) para cliente bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 23:38:17,817 - app.modules.superadmin.application.services.audit_service - INFO - [AUDIT] auth_audit_log registrado: evento=login_success, cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, usuario_id=154134AD-A5EB-4F45-AEF0-5F9AAA282C8E, exito=True
2025-12-03 23:38:17,819 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/login/ 200 270.0ms
2025-12-03 23:38:17,827 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/clientes/tenant/branding
2025-12-03 23:38:17,827 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/clientes/tenant/branding 200 1.1ms
2025-12-03 23:38:17,831 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/clientes/tenant/branding
2025-12-03 23:38:17,832 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 23:38:17,832 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 23:38:17,833 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 23:38:17,833 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:38:17,834 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 23:38:17,834 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 23:38:17,836 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:38:17,836 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 23:38:17,837 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 23:38:17,837 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: tipo_instalacion=cloud, db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 23:38:17,838 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, tipo_instalacion=cloud, db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A, path=/api/v1/clientes/tenant/branding
2025-12-03 23:38:17,843 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/menus/getmenu/
2025-12-03 23:38:17,845 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/menus/getmenu/ 200 1.5ms
2025-12-03 23:38:17,845 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/menus/getmenu/
2025-12-03 23:38:17,848 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/menus/getmenu/ 200 1.9ms
2025-12-03 23:38:17,850 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/menus/getmenu/
2025-12-03 23:38:17,851 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 23:38:17,851 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 23:38:17,852 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 23:38:17,852 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:38:17,854 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 23:38:17,855 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 23:38:17,855 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:38:17,856 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 23:38:17,856 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 23:38:17,856 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: tipo_instalacion=cloud, db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 23:38:17,857 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, tipo_instalacion=cloud, db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A, path=/api/v1/menus/getmenu/
2025-12-03 23:38:17,885 - app.modules.tenant.presentation.endpoints_clientes - INFO - Solicitud GET /tenant/branding recibida para cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7 por usuario: superadmin
2025-12-03 23:38:17,886 - app.modules.tenant.application.services.cliente_service - INFO - Solicitando branding para cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 23:38:17,888 - app.modules.menus.presentation.endpoints - INFO - Solicitud GET /menus/getmenu/ recibida para usuario ID: 154134ad-a5eb-4f45-aef0-5f9aaa282c8e del cliente bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 23:38:17,888 - app.modules.menus.application.services.menu_service - INFO - Obteniendo menú filtrado para usuario_id: 154134ad-a5eb-4f45-aef0-5f9aaa282c8e
2025-12-03 23:38:17,893 - app.modules.tenant.application.services.cliente_service - INFO - Branding obtenido exitosamente para cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 23:38:17,893 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/clientes/tenant/branding 200 62.6ms
2025-12-03 23:38:17,897 - app.modules.menus.application.services.menu_service - INFO - No se encontraron menús permitidos para el usuario ID: 154134ad-a5eb-4f45-aef0-5f9aaa282c8e.
2025-12-03 23:38:17,897 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/menus/getmenu/ 200 48.1ms
2025-12-03 23:38:17,901 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/menus/getmenu/
2025-12-03 23:38:17,902 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 23:38:17,902 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 23:38:17,903 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 23:38:17,903 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:38:17,904 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 23:38:17,904 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 23:38:17,905 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:38:17,905 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 23:38:17,906 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 23:38:17,906 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: tipo_instalacion=cloud, db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 23:38:17,906 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, tipo_instalacion=cloud, db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A, path=/api/v1/menus/getmenu/
2025-12-03 23:38:17,921 - app.modules.menus.presentation.endpoints - INFO - Solicitud GET /menus/getmenu/ recibida para usuario ID: 154134ad-a5eb-4f45-aef0-5f9aaa282c8e del cliente bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 23:38:17,921 - app.modules.menus.application.services.menu_service - INFO - Obteniendo menú filtrado para usuario_id: 154134ad-a5eb-4f45-aef0-5f9aaa282c8e
2025-12-03 23:38:17,929 - app.modules.menus.application.services.menu_service - INFO - No se encontraron menús permitidos para el usuario ID: 154134ad-a5eb-4f45-aef0-5f9aaa282c8e.
2025-12-03 23:38:17,930 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/menus/getmenu/ 200 29.0ms
2025-12-03 23:38:20,469 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/auth/refresh/
2025-12-03 23:38:20,471 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/auth/refresh/ 200 0.9ms
2025-12-03 23:38:20,473 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/refresh/
2025-12-03 23:38:20,474 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 23:38:20,474 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 23:38:20,475 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 23:38:20,475 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:38:20,475 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 23:38:20,477 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 23:38:20,478 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:38:20,478 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 23:38:20,479 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 23:38:20,479 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: tipo_instalacion=cloud, db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 23:38:20,479 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, tipo_instalacion=cloud, db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A, path=/api/v1/auth/refresh/
2025-12-03 23:38:20,489 - app.modules.auth.application.services.refresh_token_service - INFO - [VALIDATE-TOKEN] Token válido - Cliente BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, Usuario 154134AD-A5EB-4F45-AEF0-5F9AAA282C8E, Tipo: web
2025-12-03 23:38:20,495 - app.modules.auth.application.services.auth_service - INFO - [REFRESH] Token validado exitosamente (BD OK) para usuario: superadmin (Cliente: BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, Level: 5, Type: super_admin)
2025-12-03 23:38:20,499 - app.modules.auth.application.services.auth_service - INFO - Niveles calculados - Usuario 154134AD-A5EB-4F45-AEF0-5F9AAA282C8E: level=5, super_admin=True, type=super_admin
2025-12-03 23:38:20,512 - app.modules.auth.application.services.refresh_token_service - INFO - [STORE-TOKEN] Token insertado exitosamente - Cliente BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, Usuario 154134AD-A5EB-4F45-AEF0-5F9AAA282C8E, Tipo: web, Token ID: 25F7AE4E-F0F4-42A6-B522-36DC61EB0E33, Rotación: True
2025-12-03 23:38:20,519 - app.modules.auth.application.services.refresh_token_service - WARNING - [REVOKE-TOKEN] Token no encontrado o ya revocado - Cliente BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, Usuario 154134AD-A5EB-4F45-AEF0-5F9AAA282C8E
2025-12-03 23:38:20,519 - app.modules.auth.presentation.endpoints - WARNING - [REFRESH] Token antiguo no encontrado para revocar (no crítico)
2025-12-03 23:38:20,519 - app.modules.auth.presentation.endpoints - INFO - [REFRESH-WEB] Token rotado exitosamente - ID: 25F7AE4E-F0F4-42A6-B522-36DC61EB0E33
2025-12-03 23:38:20,521 - app.modules.auth.presentation.endpoints - INFO - [REFRESH-WEB] Token refrescado exitosamente - Usuario: superadmin
2025-12-03 23:38:20,527 - app.modules.superadmin.application.services.audit_service - INFO - [AUDIT] auth_audit_log registrado: evento=token_refresh, cliente_id=BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, usuario_id=154134AD-A5EB-4F45-AEF0-5F9AAA282C8E, exito=True
2025-12-03 23:38:20,528 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/refresh/ 200 55.9ms
2025-12-03 23:38:20,532 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/auth/me/
2025-12-03 23:38:20,533 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/auth/me/ 200 0.8ms
2025-12-03 23:38:20,535 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/auth/me/
2025-12-03 23:38:20,536 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 23:38:20,536 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 23:38:20,536 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 23:38:20,537 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:38:20,537 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 23:38:20,537 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 23:38:20,538 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:38:20,538 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 23:38:20,540 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 23:38:20,540 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: tipo_instalacion=cloud, db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 23:38:20,540 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, tipo_instalacion=cloud, db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A, path=/api/v1/auth/me/
2025-12-03 23:38:20,546 - app.modules.auth.presentation.endpoints - INFO - Solicitud /me/ recibida para usuario: superadmin
2025-12-03 23:38:20,546 - app.modules.auth.presentation.endpoints - INFO - [ME] Niveles desde token - Level: 5, Super Admin: True, Type: super_admin
2025-12-03 23:38:20,547 - app.modules.users.application.services.user_service - INFO - Obteniendo usuario completo ID 154134AD-A5EB-4F45-AEF0-5F9AAA282C8E para cliente BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7
2025-12-03 23:38:20,547 - app.infrastructure.database.queries_async - WARNING - [QUERY] DEPRECATED: execute_query() recibió string SQL. Migrar a SQLAlchemy Core.
2025-12-03 23:38:20,567 - app.modules.users.application.services.user_service - INFO - Usuario completo obtenido exitosamente: ID 154134AD-A5EB-4F45-AEF0-5F9AAA282C8E con 1 roles activos
2025-12-03 23:38:20,567 - app.modules.auth.presentation.endpoints - INFO - [ME] Datos completos enviados - Usuario: superadmin, Type: super_admin, Level: 5, Super Admin: True, Roles: 1
2025-12-03 23:38:20,570 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/auth/me/ 200 34.5ms
2025-12-03 23:38:20,574 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/clientes/tenant/branding
2025-12-03 23:38:20,574 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 23:38:20,576 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 23:38:20,576 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 23:38:20,576 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:38:20,576 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 23:38:20,576 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 23:38:20,576 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:38:20,576 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 23:38:20,576 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 23:38:20,576 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: tipo_instalacion=cloud, db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 23:38:20,576 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, tipo_instalacion=cloud, db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A, path=/api/v1/clientes/tenant/branding
2025-12-03 23:38:20,596 - app.modules.tenant.presentation.endpoints_clientes - INFO - Solicitud GET /tenant/branding recibida para cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7 por usuario: superadmin
2025-12-03 23:38:20,596 - app.modules.tenant.application.services.cliente_service - INFO - Solicitando branding para cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 23:38:20,601 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/menus/getmenu/
2025-12-03 23:38:20,602 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 23:38:20,602 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 23:38:20,603 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 23:38:20,603 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:38:20,604 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 23:38:20,604 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 23:38:20,605 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:38:20,605 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 23:38:20,606 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 23:38:20,606 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: tipo_instalacion=cloud, db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 23:38:20,606 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, tipo_instalacion=cloud, db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A, path=/api/v1/menus/getmenu/
2025-12-03 23:38:20,612 - app.modules.tenant.application.services.cliente_service - INFO - Branding obtenido exitosamente para cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 23:38:20,613 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/clientes/tenant/branding 200 38.7ms
2025-12-03 23:38:20,628 - app.modules.menus.presentation.endpoints - INFO - Solicitud GET /menus/getmenu/ recibida para usuario ID: 154134ad-a5eb-4f45-aef0-5f9aaa282c8e del cliente bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 23:38:20,628 - app.modules.menus.application.services.menu_service - INFO - Obteniendo menú filtrado para usuario_id: 154134ad-a5eb-4f45-aef0-5f9aaa282c8e
2025-12-03 23:38:20,632 - app.modules.menus.application.services.menu_service - INFO - No se encontraron menús permitidos para el usuario ID: 154134ad-a5eb-4f45-aef0-5f9aaa282c8e.
2025-12-03 23:38:20,633 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/menus/getmenu/ 200 32.0ms
2025-12-03 23:38:20,635 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/menus/getmenu/
2025-12-03 23:38:20,636 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 23:38:20,636 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 23:38:20,637 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 23:38:20,637 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:38:20,638 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 23:38:20,638 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 23:38:20,639 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:38:20,639 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 23:38:20,640 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 23:38:20,640 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: tipo_instalacion=cloud, db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 23:38:20,640 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, tipo_instalacion=cloud, db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A, path=/api/v1/menus/getmenu/
2025-12-03 23:38:20,658 - app.modules.menus.presentation.endpoints - INFO - Solicitud GET /menus/getmenu/ recibida para usuario ID: 154134ad-a5eb-4f45-aef0-5f9aaa282c8e del cliente bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 23:38:20,659 - app.modules.menus.application.services.menu_service - INFO - Obteniendo menú filtrado para usuario_id: 154134ad-a5eb-4f45-aef0-5f9aaa282c8e
2025-12-03 23:38:20,662 - app.modules.menus.application.services.menu_service - INFO - No se encontraron menús permitidos para el usuario ID: 154134ad-a5eb-4f45-aef0-5f9aaa282c8e.
2025-12-03 23:38:20,663 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/menus/getmenu/ 200 28.3ms
2025-12-03 23:38:22,442 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/auth/logout/
2025-12-03 23:38:22,442 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/auth/logout/ 200 0.9ms
2025-12-03 23:38:22,444 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/logout/
2025-12-03 23:38:22,445 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 23:38:22,445 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': platform.app.local:5173
2025-12-03 23:38:22,447 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 23:38:22,447 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:38:22,448 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 23:38:22,448 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'platform.app.local'
2025-12-03 23:38:22,449 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:38:22,449 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'platform'
2025-12-03 23:38:22,450 - app.core.tenant.middleware - INFO - [TENANT] Subdominio SUPERADMIN: platform -> Cliente ID: bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7
2025-12-03 23:38:22,450 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: tipo_instalacion=cloud, db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A
2025-12-03 23:38:22,450 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, tipo_instalacion=cloud, db_type=single, bd=bd_hybrid_sistema_central, servidor=N/A, path=/api/v1/auth/logout/
2025-12-03 23:38:22,459 - app.modules.auth.application.services.refresh_token_service - WARNING - [REVOKE-TOKEN] Token no encontrado o ya revocado - Cliente BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, Usuario 154134AD-A5EB-4F45-AEF0-5F9AAA282C8E
2025-12-03 23:38:22,460 - app.modules.auth.presentation.endpoints - INFO - [LOGOUT-WEB] Token no encontrado en BD (ya expirado/revocado) - Cliente: BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, Usuario: 154134AD-A5EB-4F45-AEF0-5F9AAA282C8E (superadmin)
2025-12-03 23:38:22,469 - app.modules.superadmin.application.services.audit_service - INFO - [AUDIT] auth_audit_log registrado: evento=logout, cliente_id=BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, usuario_id=154134AD-A5EB-4F45-AEF0-5F9AAA282C8E, exito=True
2025-12-03 23:38:22,470 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/logout/ 200 24.7ms
2025-12-03 23:38:34,173 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/login/
2025-12-03 23:38:34,174 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 23:38:34,174 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': acme.app.local:5173
2025-12-03 23:38:34,174 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:38:34,175 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:38:34,175 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:38:34,194 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:38:34,195 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:38:34,195 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:38:34,199 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:38:34,199 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC
2025-12-03 23:38:34,200 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43, tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC, path=/api/v1/auth/login/
2025-12-03 23:38:34,205 - app.modules.auth.presentation.endpoints - INFO - Cliente ee7bfc14-995f-4209-b4b9-99c307534a43 resuelto y validado para login.
2025-12-03 23:38:34,205 - app.modules.auth.application.services.auth_service - INFO - [AUTH] Intento de login: username='admin_acme', cliente_id_destino=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:38:34,205 - app.modules.auth.application.services.auth_service - INFO - [AUTH] Usuario regular. Buscando en BD del cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:38:34,437 - app.modules.auth.application.services.auth_service - INFO - Niveles calculados - Usuario 2458D1EA-816B-4C3C-8D13-B90271F59558: level=4, super_admin=False, type=tenant_admin
2025-12-03 23:38:34,437 - app.modules.auth.application.services.auth_service - INFO - [AUTH] Login exitoso: username='admin_acme', usuario_id=2458D1EA-816B-4C3C-8D13-B90271F59558, cliente_origen=00000000-0000-0000-0000-000000000000, cliente_destino=N/A, access_level=4, user_type=tenant_admin
2025-12-03 23:38:34,437 - app.infrastructure.database.queries_async - WARNING - [QUERY] DEPRECATED: execute_query() recibió string SQL. Migrar a SQLAlchemy Core.
2025-12-03 23:38:34,441 - app.modules.auth.application.services.auth_service - INFO - Niveles calculados - Usuario 2458D1EA-816B-4C3C-8D13-B90271F59558: level=4, super_admin=False, type=tenant_admin
2025-12-03 23:38:34,455 - app.modules.auth.application.services.refresh_token_service - INFO - [STORE-TOKEN] Token insertado exitosamente - Cliente 00000000-0000-0000-0000-000000000000, Usuario 2458D1EA-816B-4C3C-8D13-B90271F59558, Tipo: web, Token ID: B5C3F0D8-EC97-456D-BC54-A5F2B9B4B452, Rotación: False
2025-12-03 23:38:34,455 - app.modules.auth.presentation.endpoints - INFO - [LOGIN-WEB] Token almacenado - ID: B5C3F0D8-EC97-456D-BC54-A5F2B9B4B452
2025-12-03 23:38:34,455 - app.modules.auth.presentation.endpoints - INFO - Usuario admin_acme autenticado exitosamente (WEB) para cliente ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:38:34,466 - app.modules.superadmin.application.services.audit_service - INFO - [AUDIT] auth_audit_log registrado: evento=login_success, cliente_id=00000000-0000-0000-0000-000000000000, usuario_id=2458D1EA-816B-4C3C-8D13-B90271F59558, exito=True
2025-12-03 23:38:34,469 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/login/ 200 296.9ms
2025-12-03 23:38:34,478 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/clientes/tenant/branding
2025-12-03 23:38:34,478 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 23:38:34,478 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': acme.app.local:5173
2025-12-03 23:38:34,481 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:38:34,481 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:38:34,481 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:38:34,485 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/menus/getmenu/
2025-12-03 23:38:34,487 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 23:38:34,488 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': acme.app.local:5173
2025-12-03 23:38:34,489 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:38:34,490 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:38:34,490 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:38:34,494 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/areas/
2025-12-03 23:38:34,495 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 23:38:34,496 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': acme.app.local:5173
2025-12-03 23:38:34,497 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:38:34,497 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:38:34,498 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:38:34,504 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:38:34,505 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:38:34,505 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:38:34,508 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:38:34,509 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:38:34,509 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:38:34,511 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:38:34,511 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:38:34,511 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:38:34,519 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:38:34,519 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC
2025-12-03 23:38:34,521 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43, tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC, path=/api/v1/clientes/tenant/branding
2025-12-03 23:38:34,524 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:38:34,524 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC
2025-12-03 23:38:34,525 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43, tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC, path=/api/v1/menus/getmenu/
2025-12-03 23:38:34,528 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:38:34,528 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC
2025-12-03 23:38:34,528 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43, tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC, path=/api/v1/areas/
2025-12-03 23:38:34,548 - app.api.deps - WARNING - [SECURITY] Acceso denegado: usuario 'admin_acme' (cliente 00000000-0000-0000-0000-000000000000) intentó acceder a cliente ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:38:34,549 - app.api.deps - WARNING - [SECURITY] Acceso denegado: usuario 'admin_acme' (cliente 00000000-0000-0000-0000-000000000000) intentó acceder a cliente ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:38:34,549 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/clientes/tenant/branding 403 71.4ms
2025-12-03 23:38:34,551 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/areas/ 403 57.5ms
2025-12-03 23:38:34,553 - app.api.deps - WARNING - [SECURITY] Acceso denegado: usuario 'admin_acme' (cliente 00000000-0000-0000-0000-000000000000) intentó acceder a cliente ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:38:34,555 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/areas/
2025-12-03 23:38:34,556 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 23:38:34,557 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': acme.app.local:5173
2025-12-03 23:38:34,557 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:38:34,558 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:38:34,558 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:38:34,560 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/menus/getmenu/ 403 75.4ms
2025-12-03 23:38:34,561 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/menus/getmenu/
2025-12-03 23:38:34,561 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 23:38:34,561 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': acme.app.local:5173
2025-12-03 23:38:34,561 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:38:34,566 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:38:34,566 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:38:34,570 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:38:34,571 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:38:34,572 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:38:34,577 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:38:34,577 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:38:34,578 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:38:34,582 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:38:34,582 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC
2025-12-03 23:38:34,583 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43, tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC, path=/api/v1/areas/
2025-12-03 23:38:34,586 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:38:34,587 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC
2025-12-03 23:38:34,587 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43, tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC, path=/api/v1/menus/getmenu/
2025-12-03 23:38:34,600 - app.api.deps - WARNING - [SECURITY] Acceso denegado: usuario 'admin_acme' (cliente 00000000-0000-0000-0000-000000000000) intentó acceder a cliente ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:38:34,601 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/areas/ 403 46.5ms
2025-12-03 23:38:34,604 - app.api.deps - WARNING - [SECURITY] Acceso denegado: usuario 'admin_acme' (cliente 00000000-0000-0000-0000-000000000000) intentó acceder a cliente ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:38:34,605 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/menus/getmenu/ 403 43.1ms
2025-12-03 23:38:49,441 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/refresh/
2025-12-03 23:38:49,443 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 23:38:49,443 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': acme.app.local:5173
2025-12-03 23:38:49,444 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:38:49,444 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:38:49,445 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:38:49,450 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:38:49,451 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:38:49,451 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:38:49,454 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:38:49,454 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC
2025-12-03 23:38:49,454 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43, tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC, path=/api/v1/auth/refresh/
2025-12-03 23:38:49,464 - app.modules.auth.application.services.refresh_token_service - WARNING - [VALIDATE-TOKEN] Token no encontrado, revocado o expirado - Cliente ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:38:49,464 - app.modules.auth.application.services.auth_service - WARNING - [REFRESH] Token JWT válido, pero inactivo/revocado en BD. Usuario: admin_acme
2025-12-03 23:38:49,472 - app.modules.superadmin.application.services.audit_service - INFO - [AUDIT] auth_audit_log registrado: evento=token_invalid_or_revoked, cliente_id=00000000-0000-0000-0000-000000000000, usuario_id=None, exito=False
2025-12-03 23:38:49,472 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/refresh/ 401 31.4ms
2025-12-03 23:38:59,582 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Pool ADMIN inicializado. Size=10, MaxOverflow=5
2025-12-03 23:38:59,582 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Configuración de pools de tenants: MaxPools=50, PoolSize=3, MaxOverflow=2, InactivityTimeout=3600s
2025-12-03 23:38:59,583 - app.infrastructure.database.connection_pool - INFO - ✅ Módulo de connection pooling cargado y activo
2025-12-03 23:38:59,583 - app.infrastructure.database.connection_pool - INFO -    Configuración: MaxTenantPools=50, TenantPoolSize=3, InactivityTimeout=3600s
2025-12-03 23:38:59,584 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Todos los pools cerrados
2025-12-03 23:38:59,584 - app.main - INFO - ✅ Pools de conexión cerrados correctamente
2025-12-03 23:38:59,694 - asyncio - ERROR - Unclosed connection
connection: <aioodbc.connection.Connection object at 0x000001F4E0E33320>
2025-12-03 23:38:59,695 - asyncio - ERROR - Unclosed connection
connection: <aioodbc.connection.Connection object at 0x000001F4E1C16B40>
2025-12-03 23:38:59,696 - asyncio - ERROR - Unclosed connection
connection: <aioodbc.connection.Connection object at 0x000001F4E1C18380>
2025-12-03 23:38:59,696 - asyncio - ERROR - Unclosed connection
connection: <aioodbc.connection.Connection object at 0x000001F4E1C4CE30>
2025-12-03 23:38:59,696 - asyncio - ERROR - Unclosed connection
connection: <aioodbc.connection.Connection object at 0x000001F4E1BC67E0>
2025-12-03 23:38:59,696 - asyncio - ERROR - Unclosed connection
connection: <aioodbc.connection.Connection object at 0x000001F4E1C4C740>
2025-12-03 23:39:04,727 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 23:39:04,922 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 23:39:04,922 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 23:39:04,934 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 23:39:04,934 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 23:39:04,935 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 23:39:04,936 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 23:39:04,937 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, DEFAULT_TYPE=single
2025-12-03 23:39:05,256 - app.core.security.rate_limiting - INFO - [RATE_LIMITING] Activado. Límites: Login=10/minute, API=200/minute
2025-12-03 23:39:05,257 - app.core.security.rate_limiting - INFO - ✅ Módulo de rate limiting cargado y activo
2025-12-03 23:39:05,322 - app.core.authorization.rbac - INFO - 🔐 Inicializando sistema de autorización...
2025-12-03 23:39:05,322 - app.core.authorization.rbac - INFO - ✅ Sistema de autorización inicializado correctamente
2025-12-03 23:39:05,322 - app.core.authorization.rbac - INFO - 📊 Permisos del sistema: 6 módulos configurados
2025-12-03 23:39:05,501 - app.core.tenant.middleware - INFO - Módulo tenant_middleware cargado (versión híbrida con soporte para proxies)
2025-12-03 23:39:05,502 - app.main - INFO - ✅ Rate limiting configurado y activo
2025-12-03 23:39:05,665 - app.core.tenant.middleware - INFO - [TENANT_MW] Inicializado - BASE_DOMAIN=app.local, SYSTEM_ID=BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, EXCLUDED_SUBDOMAINS={'static', 'www', 'backend', 'api', 'cdn', 'assets', 'admin'}
2025-12-03 23:39:17,020 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/login/
2025-12-03 23:39:17,021 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 23:39:17,022 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': acme.app.local:5173
2025-12-03 23:39:17,022 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:39:17,022 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:39:17,023 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:39:17,025 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] AsyncEngine creado para admin
2025-12-03 23:39:17,142 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:39:17,142 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:39:17,147 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:39:17,148 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:39:21,234 - app.infrastructure.cache.redis_cache - WARNING - [REDIS_CACHE] Error conectando a Redis: Error 10061 connecting to localhost:6379. No se puede establecer una conexión ya que el equipo de destino denegó expresamente dicha conexión.. Cache desactivado automáticamente (usando fallback en memoria).
2025-12-03 23:39:21,235 - app.infrastructure.cache.redis_cache - INFO - ℹ️ Módulo de Redis cache cargado pero desactivado (usando fallback en memoria)
2025-12-03 23:39:21,246 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC
2025-12-03 23:39:21,246 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43, tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC, path=/api/v1/auth/login/
2025-12-03 23:39:21,253 - app.modules.auth.presentation.endpoints - INFO - Cliente ee7bfc14-995f-4209-b4b9-99c307534a43 resuelto y validado para login.
2025-12-03 23:39:21,254 - app.modules.auth.application.services.auth_service - INFO - [AUTH] Intento de login: username='admin_acme', cliente_id_destino=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:39:21,254 - app.modules.auth.application.services.auth_service - INFO - [AUTH] Usuario regular. Buscando en BD del cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:39:21,255 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] AsyncEngine creado para tenant_ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:39:21,541 - app.modules.auth.application.services.auth_service - INFO - Niveles calculados - Usuario 2458D1EA-816B-4C3C-8D13-B90271F59558: level=4, super_admin=False, type=tenant_admin
2025-12-03 23:39:21,541 - app.modules.auth.application.services.auth_service - INFO - [AUTH] Login exitoso: username='admin_acme', usuario_id=2458D1EA-816B-4C3C-8D13-B90271F59558, cliente_origen=00000000-0000-0000-0000-000000000000, cliente_destino=N/A, access_level=4, user_type=tenant_admin
2025-12-03 23:39:21,542 - app.infrastructure.database.queries_async - WARNING - [QUERY] DEPRECATED: execute_query() recibió string SQL. Migrar a SQLAlchemy Core.
2025-12-03 23:39:21,548 - app.modules.auth.application.services.auth_service - INFO - Niveles calculados - Usuario 2458D1EA-816B-4C3C-8D13-B90271F59558: level=4, super_admin=False, type=tenant_admin
2025-12-03 23:39:21,554 - app.modules.auth.application.services.refresh_token_service - INFO - [STORE-TOKEN] Token insertado exitosamente - Cliente 00000000-0000-0000-0000-000000000000, Usuario 2458D1EA-816B-4C3C-8D13-B90271F59558, Tipo: web, Token ID: A82C2A2E-18CB-48C2-B766-1319FE3A9844, Rotación: False
2025-12-03 23:39:21,554 - app.modules.auth.presentation.endpoints - INFO - [LOGIN-WEB] Token almacenado - ID: A82C2A2E-18CB-48C2-B766-1319FE3A9844
2025-12-03 23:39:21,554 - app.modules.auth.presentation.endpoints - INFO - Usuario admin_acme autenticado exitosamente (WEB) para cliente ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:39:21,562 - app.modules.superadmin.application.services.audit_service - INFO - [AUDIT] auth_audit_log registrado: evento=login_success, cliente_id=00000000-0000-0000-0000-000000000000, usuario_id=2458D1EA-816B-4C3C-8D13-B90271F59558, exito=True
2025-12-03 23:39:21,564 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/login/ 200 4543.2ms
2025-12-03 23:39:21,577 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/clientes/tenant/branding
2025-12-03 23:39:21,578 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 23:39:21,578 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': acme.app.local:5173
2025-12-03 23:39:21,578 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:39:21,578 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:39:21,578 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:39:21,588 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:39:21,588 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:39:21,589 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:39:21,594 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/menus/getmenu/
2025-12-03 23:39:21,594 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/areas/
2025-12-03 23:39:21,597 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 23:39:21,598 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': acme.app.local:5173
2025-12-03 23:39:21,598 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:39:21,598 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:39:21,599 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:39:21,602 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 23:39:21,603 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': acme.app.local:5173
2025-12-03 23:39:21,604 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:39:21,605 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:39:21,605 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:39:21,611 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:39:21,612 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC
2025-12-03 23:39:21,613 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43, tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC, path=/api/v1/clientes/tenant/branding
2025-12-03 23:39:21,617 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:39:21,618 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:39:21,618 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:39:21,626 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:39:21,626 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:39:21,627 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:39:21,655 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:39:21,656 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC
2025-12-03 23:39:21,657 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43, tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC, path=/api/v1/menus/getmenu/
2025-12-03 23:39:21,658 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:39:21,658 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC
2025-12-03 23:39:21,662 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43, tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC, path=/api/v1/areas/
2025-12-03 23:39:21,667 - app.api.deps - WARNING - [SECURITY] Acceso denegado: usuario 'admin_acme' (cliente 00000000-0000-0000-0000-000000000000) intentó acceder a cliente ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:39:21,671 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/clientes/tenant/branding 403 93.8ms
2025-12-03 23:39:21,676 - app.api.deps - WARNING - [SECURITY] Acceso denegado: usuario 'admin_acme' (cliente 00000000-0000-0000-0000-000000000000) intentó acceder a cliente ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:39:21,676 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/menus/getmenu/ 403 84.0ms
2025-12-03 23:39:21,682 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/menus/getmenu/
2025-12-03 23:39:21,683 - app.api.deps - WARNING - [SECURITY] Acceso denegado: usuario 'admin_acme' (cliente 00000000-0000-0000-0000-000000000000) intentó acceder a cliente ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:39:21,683 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 23:39:21,683 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': acme.app.local:5173
2025-12-03 23:39:21,684 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:39:21,684 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:39:21,685 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:39:21,687 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/areas/ 403 91.5ms
2025-12-03 23:39:21,690 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/areas/
2025-12-03 23:39:21,692 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 23:39:21,692 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': acme.app.local:5173
2025-12-03 23:39:21,693 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:39:21,693 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:39:21,693 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:39:21,698 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:39:21,698 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:39:21,699 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:39:21,702 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:39:21,702 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:39:21,704 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:39:21,707 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:39:21,708 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC
2025-12-03 23:39:21,708 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43, tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC, path=/api/v1/menus/getmenu/
2025-12-03 23:39:21,712 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:39:21,712 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC
2025-12-03 23:39:21,712 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43, tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC, path=/api/v1/areas/
2025-12-03 23:39:21,723 - app.api.deps - WARNING - [SECURITY] Acceso denegado: usuario 'admin_acme' (cliente 00000000-0000-0000-0000-000000000000) intentó acceder a cliente ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:39:21,724 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/menus/getmenu/ 403 43.3ms
2025-12-03 23:39:21,726 - app.api.deps - WARNING - [SECURITY] Acceso denegado: usuario 'admin_acme' (cliente 00000000-0000-0000-0000-000000000000) intentó acceder a cliente ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:39:21,726 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/areas/ 403 37.6ms
2025-12-03 23:40:24,590 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/refresh/
2025-12-03 23:40:24,591 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 23:40:24,591 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': acme.app.local:5173
2025-12-03 23:40:24,591 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:40:24,593 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:40:24,593 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:40:24,613 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:40:24,613 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:40:24,615 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:40:24,616 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:40:24,616 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC
2025-12-03 23:40:24,616 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43, tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC, path=/api/v1/auth/refresh/
2025-12-03 23:40:24,643 - app.modules.auth.application.services.refresh_token_service - WARNING - [VALIDATE-TOKEN] Token no encontrado, revocado o expirado - Cliente ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:40:24,643 - app.modules.auth.application.services.auth_service - WARNING - [REFRESH] Token JWT válido, pero inactivo/revocado en BD. Usuario: admin_acme
2025-12-03 23:40:24,657 - app.modules.superadmin.application.services.audit_service - INFO - [AUDIT] auth_audit_log registrado: evento=token_invalid_or_revoked, cliente_id=00000000-0000-0000-0000-000000000000, usuario_id=None, exito=False
2025-12-03 23:40:24,658 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/refresh/ 401 68.4ms
2025-12-03 23:40:43,334 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Pool ADMIN inicializado. Size=10, MaxOverflow=5
2025-12-03 23:40:43,336 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Configuración de pools de tenants: MaxPools=50, PoolSize=3, MaxOverflow=2, InactivityTimeout=3600s
2025-12-03 23:40:43,336 - app.infrastructure.database.connection_pool - INFO - ✅ Módulo de connection pooling cargado y activo
2025-12-03 23:40:43,336 - app.infrastructure.database.connection_pool - INFO -    Configuración: MaxTenantPools=50, TenantPoolSize=3, InactivityTimeout=3600s
2025-12-03 23:40:43,338 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Todos los pools cerrados
2025-12-03 23:40:43,338 - app.main - INFO - ✅ Pools de conexión cerrados correctamente
2025-12-03 23:40:44,110 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 23:40:44,314 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 23:40:44,320 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 23:40:44,322 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 23:40:44,322 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 23:40:44,323 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 23:40:44,323 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 23:40:44,325 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, DEFAULT_TYPE=single
2025-12-03 23:40:44,637 - app.core.security.rate_limiting - INFO - [RATE_LIMITING] Activado. Límites: Login=10/minute, API=200/minute
2025-12-03 23:40:44,637 - app.core.security.rate_limiting - INFO - ✅ Módulo de rate limiting cargado y activo
2025-12-03 23:40:44,703 - app.core.authorization.rbac - INFO - 🔐 Inicializando sistema de autorización...
2025-12-03 23:40:44,703 - app.core.authorization.rbac - INFO - ✅ Sistema de autorización inicializado correctamente
2025-12-03 23:40:44,703 - app.core.authorization.rbac - INFO - 📊 Permisos del sistema: 6 módulos configurados
2025-12-03 23:40:44,861 - app.core.tenant.middleware - INFO - Módulo tenant_middleware cargado (versión híbrida con soporte para proxies)
2025-12-03 23:40:44,863 - app.main - INFO - ✅ Rate limiting configurado y activo
2025-12-03 23:40:45,013 - app.core.tenant.middleware - INFO - [TENANT_MW] Inicializado - BASE_DOMAIN=app.local, SYSTEM_ID=BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, EXCLUDED_SUBDOMAINS={'admin', 'www', 'api', 'static', 'cdn', 'assets', 'backend'}
2025-12-03 23:44:04,079 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Pool ADMIN inicializado. Size=10, MaxOverflow=5
2025-12-03 23:44:04,080 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Configuración de pools de tenants: MaxPools=50, PoolSize=3, MaxOverflow=2, InactivityTimeout=3600s
2025-12-03 23:44:04,080 - app.infrastructure.database.connection_pool - INFO - ✅ Módulo de connection pooling cargado y activo
2025-12-03 23:44:04,080 - app.infrastructure.database.connection_pool - INFO -    Configuración: MaxTenantPools=50, TenantPoolSize=3, InactivityTimeout=3600s
2025-12-03 23:44:04,081 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Todos los pools cerrados
2025-12-03 23:44:04,081 - app.main - INFO - ✅ Pools de conexión cerrados correctamente
2025-12-03 23:44:04,186 - asyncio - ERROR - Unclosed connection
connection: <aioodbc.connection.Connection object at 0x0000018EADD5F350>
2025-12-03 23:44:04,186 - asyncio - ERROR - Unclosed connection
connection: <aioodbc.connection.Connection object at 0x0000018EAFFD6600>
2025-12-03 23:44:04,188 - asyncio - ERROR - Unclosed connection
connection: <aioodbc.connection.Connection object at 0x0000018EB00165D0>
2025-12-03 23:44:04,188 - asyncio - ERROR - Unclosed connection
connection: <aioodbc.connection.Connection object at 0x0000018EB00355B0>
2025-12-03 23:44:04,189 - asyncio - ERROR - Unclosed connection
connection: <aioodbc.connection.Connection object at 0x0000018EB0015310>
2025-12-03 23:44:04,189 - asyncio - ERROR - Unclosed connection
connection: <aioodbc.connection.Connection object at 0x0000018EB00369F0>
2025-12-03 23:44:05,089 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 23:44:05,323 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 23:44:05,329 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 23:44:05,332 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 23:44:05,332 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 23:44:05,333 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 23:44:05,335 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 23:44:05,335 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, DEFAULT_TYPE=single
2025-12-03 23:44:05,780 - app.core.security.rate_limiting - INFO - [RATE_LIMITING] Activado. Límites: Login=10/minute, API=200/minute
2025-12-03 23:44:05,780 - app.core.security.rate_limiting - INFO - ✅ Módulo de rate limiting cargado y activo
2025-12-03 23:44:05,880 - app.core.authorization.rbac - INFO - 🔐 Inicializando sistema de autorización...
2025-12-03 23:44:05,881 - app.core.authorization.rbac - INFO - ✅ Sistema de autorización inicializado correctamente
2025-12-03 23:44:05,881 - app.core.authorization.rbac - INFO - 📊 Permisos del sistema: 6 módulos configurados
2025-12-03 23:44:06,110 - app.core.tenant.middleware - INFO - Módulo tenant_middleware cargado (versión híbrida con soporte para proxies)
2025-12-03 23:44:06,111 - app.main - INFO - ✅ Rate limiting configurado y activo
2025-12-03 23:44:06,273 - app.core.tenant.middleware - INFO - [TENANT_MW] Inicializado - BASE_DOMAIN=app.local, SYSTEM_ID=BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, EXCLUDED_SUBDOMAINS={'api', 'assets', 'backend', 'www', 'static', 'cdn', 'admin'}
2025-12-03 23:44:57,377 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Pool ADMIN inicializado. Size=10, MaxOverflow=5
2025-12-03 23:44:57,377 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Pool ADMIN inicializado. Size=10, MaxOverflow=5
2025-12-03 23:44:57,377 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Configuración de pools de tenants: MaxPools=50, PoolSize=3, MaxOverflow=2, InactivityTimeout=3600s
2025-12-03 23:44:57,377 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Configuración de pools de tenants: MaxPools=50, PoolSize=3, MaxOverflow=2, InactivityTimeout=3600s
2025-12-03 23:44:57,377 - app.infrastructure.database.connection_pool - INFO - ✅ Módulo de connection pooling cargado y activo
2025-12-03 23:44:57,377 - app.infrastructure.database.connection_pool - INFO - ✅ Módulo de connection pooling cargado y activo
2025-12-03 23:44:57,377 - app.infrastructure.database.connection_pool - INFO -    Configuración: MaxTenantPools=50, TenantPoolSize=3, InactivityTimeout=3600s
2025-12-03 23:44:57,381 - app.infrastructure.database.connection_pool - INFO -    Configuración: MaxTenantPools=50, TenantPoolSize=3, InactivityTimeout=3600s
2025-12-03 23:44:57,381 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Todos los pools cerrados
2025-12-03 23:44:57,381 - app.main - INFO - ✅ Pools de conexión cerrados correctamente
2025-12-03 23:44:57,381 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Todos los pools cerrados
2025-12-03 23:44:57,382 - app.main - INFO - ✅ Pools de conexión cerrados correctamente
2025-12-03 23:44:58,159 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 23:44:58,357 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 23:44:58,367 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 23:44:58,370 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 23:44:58,370 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 23:44:58,371 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 23:44:58,371 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 23:44:58,372 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, DEFAULT_TYPE=single
2025-12-03 23:44:58,372 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 23:44:58,607 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 23:44:58,614 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 23:44:58,617 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 23:44:58,618 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 23:44:58,619 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 23:44:58,619 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 23:44:58,620 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, DEFAULT_TYPE=single
2025-12-03 23:44:58,708 - app.core.security.rate_limiting - INFO - [RATE_LIMITING] Activado. Límites: Login=10/minute, API=200/minute
2025-12-03 23:44:58,708 - app.core.security.rate_limiting - INFO - ✅ Módulo de rate limiting cargado y activo
2025-12-03 23:44:58,779 - app.core.authorization.rbac - INFO - 🔐 Inicializando sistema de autorización...
2025-12-03 23:44:58,779 - app.core.authorization.rbac - INFO - ✅ Sistema de autorización inicializado correctamente
2025-12-03 23:44:58,779 - app.core.authorization.rbac - INFO - 📊 Permisos del sistema: 6 módulos configurados
2025-12-03 23:44:58,955 - app.core.tenant.middleware - INFO - Módulo tenant_middleware cargado (versión híbrida con soporte para proxies)
2025-12-03 23:44:58,955 - app.main - INFO - ✅ Rate limiting configurado y activo
2025-12-03 23:44:59,019 - app.core.security.rate_limiting - INFO - [RATE_LIMITING] Activado. Límites: Login=10/minute, API=200/minute
2025-12-03 23:44:59,027 - app.core.security.rate_limiting - INFO - ✅ Módulo de rate limiting cargado y activo
2025-12-03 23:44:59,114 - app.core.tenant.middleware - INFO - [TENANT_MW] Inicializado - BASE_DOMAIN=app.local, SYSTEM_ID=BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, EXCLUDED_SUBDOMAINS={'www', 'admin', 'api', 'backend', 'assets', 'cdn', 'static'}
2025-12-03 23:44:59,133 - app.core.authorization.rbac - INFO - 🔐 Inicializando sistema de autorización...
2025-12-03 23:44:59,133 - app.core.authorization.rbac - INFO - ✅ Sistema de autorización inicializado correctamente
2025-12-03 23:44:59,134 - app.core.authorization.rbac - INFO - 📊 Permisos del sistema: 6 módulos configurados
2025-12-03 23:44:59,382 - app.core.tenant.middleware - INFO - Módulo tenant_middleware cargado (versión híbrida con soporte para proxies)
2025-12-03 23:44:59,382 - app.main - INFO - ✅ Rate limiting configurado y activo
2025-12-03 23:44:59,557 - app.core.tenant.middleware - INFO - [TENANT_MW] Inicializado - BASE_DOMAIN=app.local, SYSTEM_ID=BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, EXCLUDED_SUBDOMAINS={'cdn', 'admin', 'backend', 'assets', 'www', 'api', 'static'}
2025-12-03 23:45:34,903 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Pool ADMIN inicializado. Size=10, MaxOverflow=5
2025-12-03 23:45:34,903 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Configuración de pools de tenants: MaxPools=50, PoolSize=3, MaxOverflow=2, InactivityTimeout=3600s
2025-12-03 23:45:34,904 - app.infrastructure.database.connection_pool - INFO - ✅ Módulo de connection pooling cargado y activo
2025-12-03 23:45:34,904 - app.infrastructure.database.connection_pool - INFO -    Configuración: MaxTenantPools=50, TenantPoolSize=3, InactivityTimeout=3600s
2025-12-03 23:45:34,905 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Todos los pools cerrados
2025-12-03 23:45:34,905 - app.main - INFO - ✅ Pools de conexión cerrados correctamente
2025-12-03 23:45:36,608 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 23:45:36,839 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 23:45:36,846 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 23:45:36,848 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 23:45:36,849 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 23:45:36,849 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 23:45:36,850 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 23:45:36,850 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, DEFAULT_TYPE=single
2025-12-03 23:45:37,204 - app.core.security.rate_limiting - INFO - [RATE_LIMITING] Activado. Límites: Login=10/minute, API=200/minute
2025-12-03 23:45:37,204 - app.core.security.rate_limiting - INFO - ✅ Módulo de rate limiting cargado y activo
2025-12-03 23:45:37,279 - app.core.authorization.rbac - INFO - 🔐 Inicializando sistema de autorización...
2025-12-03 23:45:37,280 - app.core.authorization.rbac - INFO - ✅ Sistema de autorización inicializado correctamente
2025-12-03 23:45:37,280 - app.core.authorization.rbac - INFO - 📊 Permisos del sistema: 6 módulos configurados
2025-12-03 23:45:37,474 - app.core.tenant.middleware - INFO - Módulo tenant_middleware cargado (versión híbrida con soporte para proxies)
2025-12-03 23:45:37,476 - app.main - INFO - ✅ Rate limiting configurado y activo
2025-12-03 23:45:37,668 - app.core.tenant.middleware - INFO - [TENANT_MW] Inicializado - BASE_DOMAIN=app.local, SYSTEM_ID=BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, EXCLUDED_SUBDOMAINS={'backend', 'admin', 'static', 'assets', 'www', 'api', 'cdn'}
2025-12-03 23:45:46,001 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/auth/login/
2025-12-03 23:45:46,001 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/auth/login/ 200 1.0ms
2025-12-03 23:45:46,004 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/login/
2025-12-03 23:45:46,004 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 23:45:46,005 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': acme.app.local:5173
2025-12-03 23:45:46,005 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:45:46,006 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:45:46,006 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:45:46,010 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] AsyncEngine creado para admin
2025-12-03 23:45:46,168 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:45:46,168 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:45:46,168 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:45:46,168 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:45:50,268 - app.infrastructure.cache.redis_cache - WARNING - [REDIS_CACHE] Error conectando a Redis: Error 10061 connecting to localhost:6379. No se puede establecer una conexión ya que el equipo de destino denegó expresamente dicha conexión.. Cache desactivado automáticamente (usando fallback en memoria).
2025-12-03 23:45:50,268 - app.infrastructure.cache.redis_cache - INFO - ℹ️ Módulo de Redis cache cargado pero desactivado (usando fallback en memoria)
2025-12-03 23:45:50,278 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC
2025-12-03 23:45:50,278 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43, tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC, path=/api/v1/auth/login/
2025-12-03 23:45:50,288 - app.modules.auth.presentation.endpoints - INFO - Cliente ee7bfc14-995f-4209-b4b9-99c307534a43 resuelto y validado para login.
2025-12-03 23:45:50,289 - app.modules.auth.application.services.auth_service - INFO - [AUTH] Intento de login: username='admin_acme', cliente_id_destino=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:45:50,290 - app.modules.auth.application.services.auth_service - INFO - [AUTH] Usuario regular. Buscando en BD del cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:45:50,291 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] AsyncEngine creado para tenant_ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:45:50,608 - app.modules.auth.application.services.auth_service - INFO - Niveles calculados - Usuario 2458D1EA-816B-4C3C-8D13-B90271F59558: level=1, super_admin=False, type=user
2025-12-03 23:45:50,608 - app.modules.auth.application.services.auth_service - INFO - [AUTH] Login exitoso: username='admin_acme', usuario_id=2458D1EA-816B-4C3C-8D13-B90271F59558, cliente_origen=ee7bfc14-995f-4209-b4b9-99c307534a43, cliente_destino=N/A, access_level=1, user_type=user
2025-12-03 23:45:50,608 - app.infrastructure.database.queries_async - WARNING - [QUERY] DEPRECATED: execute_query() recibió string SQL. Migrar a SQLAlchemy Core.
2025-12-03 23:45:50,618 - app.modules.auth.application.services.auth_service - INFO - Niveles calculados - Usuario 2458D1EA-816B-4C3C-8D13-B90271F59558: level=1, super_admin=False, type=user
2025-12-03 23:45:50,631 - app.modules.auth.application.services.refresh_token_service - INFO - [STORE-TOKEN] Token insertado exitosamente - Cliente ee7bfc14-995f-4209-b4b9-99c307534a43, Usuario 2458D1EA-816B-4C3C-8D13-B90271F59558, Tipo: web, Token ID: 80266B5A-ECE9-4932-8FAF-6853CD191D88, Rotación: False
2025-12-03 23:45:50,633 - app.modules.auth.presentation.endpoints - INFO - [LOGIN-WEB] Token almacenado - ID: 80266B5A-ECE9-4932-8FAF-6853CD191D88
2025-12-03 23:45:50,634 - app.modules.auth.presentation.endpoints - INFO - Usuario admin_acme autenticado exitosamente (WEB) para cliente ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:45:50,640 - app.modules.superadmin.application.services.audit_service - INFO - [AUDIT] auth_audit_log registrado: evento=login_success, cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43, usuario_id=2458D1EA-816B-4C3C-8D13-B90271F59558, exito=True
2025-12-03 23:45:50,640 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/login/ 200 4640.0ms
2025-12-03 23:45:50,654 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/clientes/tenant/branding
2025-12-03 23:45:50,655 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 23:45:50,656 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': acme.app.local:5173
2025-12-03 23:45:50,656 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:45:50,656 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:45:50,658 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:45:50,661 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:45:50,665 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:45:50,665 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:45:50,672 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:45:50,672 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC
2025-12-03 23:45:50,674 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43, tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC, path=/api/v1/clientes/tenant/branding
2025-12-03 23:45:50,697 - app.api.deps - WARNING - [SECURITY] Acceso denegado: usuario 'admin_acme' (cliente 00000000-0000-0000-0000-000000000000) intentó acceder a cliente ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:45:50,698 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/clientes/tenant/branding 403 43.7ms
2025-12-03 23:46:15,671 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/menus/getmenu/
2025-12-03 23:46:15,672 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 23:46:15,672 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': acme.app.local:5173
2025-12-03 23:46:15,673 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:46:15,673 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:46:15,674 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:46:15,698 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:46:15,698 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:46:15,699 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:46:15,703 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:46:15,704 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC
2025-12-03 23:46:15,704 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43, tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC, path=/api/v1/menus/getmenu/
2025-12-03 23:46:15,732 - app.api.deps - WARNING - [SECURITY] Acceso denegado: usuario 'admin_acme' (cliente 00000000-0000-0000-0000-000000000000) intentó acceder a cliente ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:46:15,733 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/menus/getmenu/ 403 62.7ms
2025-12-03 23:46:15,735 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/menus/getmenu/
2025-12-03 23:46:15,736 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 23:46:15,736 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': acme.app.local:5173
2025-12-03 23:46:15,736 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:46:15,738 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:46:15,738 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:46:15,742 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:46:15,744 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:46:15,744 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:46:15,748 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:46:15,749 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC
2025-12-03 23:46:15,749 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43, tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC, path=/api/v1/menus/getmenu/
2025-12-03 23:46:15,759 - app.api.deps - WARNING - [SECURITY] Acceso denegado: usuario 'admin_acme' (cliente 00000000-0000-0000-0000-000000000000) intentó acceder a cliente ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:46:15,760 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/menus/getmenu/ 403 24.3ms
2025-12-03 23:46:21,642 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/logout/
2025-12-03 23:46:21,643 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 23:46:21,643 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': acme.app.local:5173
2025-12-03 23:46:21,644 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:46:21,644 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:46:21,645 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:46:21,650 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:46:21,650 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:46:21,651 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:46:21,655 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:46:21,656 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC
2025-12-03 23:46:21,656 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43, tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC, path=/api/v1/auth/logout/
2025-12-03 23:46:21,671 - app.modules.auth.application.services.refresh_token_service - WARNING - [REVOKE-TOKEN] Token no encontrado o ya revocado - Cliente ee7bfc14-995f-4209-b4b9-99c307534a43, Usuario 2458D1EA-816B-4C3C-8D13-B90271F59558
2025-12-03 23:46:21,671 - app.modules.auth.presentation.endpoints - INFO - [LOGOUT-WEB] Token no encontrado en BD (ya expirado/revocado) - Cliente: ee7bfc14-995f-4209-b4b9-99c307534a43, Usuario: 2458D1EA-816B-4C3C-8D13-B90271F59558 (admin_acme)
2025-12-03 23:46:21,690 - app.modules.superadmin.application.services.audit_service - INFO - [AUDIT] auth_audit_log registrado: evento=logout, cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43, usuario_id=2458D1EA-816B-4C3C-8D13-B90271F59558, exito=True
2025-12-03 23:46:21,690 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/logout/ 200 50.3ms
2025-12-03 23:46:31,667 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/login/
2025-12-03 23:46:31,669 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 23:46:31,669 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': acme.app.local:5173
2025-12-03 23:46:31,669 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:46:31,669 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:46:31,669 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:46:31,676 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:46:31,676 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:46:31,677 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:46:31,681 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:46:31,682 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC
2025-12-03 23:46:31,682 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43, tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC, path=/api/v1/auth/login/
2025-12-03 23:46:31,689 - app.modules.auth.presentation.endpoints - INFO - Cliente ee7bfc14-995f-4209-b4b9-99c307534a43 resuelto y validado para login.
2025-12-03 23:46:31,689 - app.modules.auth.application.services.auth_service - INFO - [AUTH] Intento de login: username='admin_acme', cliente_id_destino=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:46:31,692 - app.modules.auth.application.services.auth_service - INFO - [AUTH] Usuario regular. Buscando en BD del cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:46:31,909 - app.modules.auth.application.services.auth_service - INFO - Niveles calculados - Usuario 2458D1EA-816B-4C3C-8D13-B90271F59558: level=1, super_admin=False, type=user
2025-12-03 23:46:31,909 - app.modules.auth.application.services.auth_service - INFO - [AUTH] Login exitoso: username='admin_acme', usuario_id=2458D1EA-816B-4C3C-8D13-B90271F59558, cliente_origen=ee7bfc14-995f-4209-b4b9-99c307534a43, cliente_destino=N/A, access_level=1, user_type=user
2025-12-03 23:46:31,909 - app.infrastructure.database.queries_async - WARNING - [QUERY] DEPRECATED: execute_query() recibió string SQL. Migrar a SQLAlchemy Core.
2025-12-03 23:46:31,909 - app.modules.auth.application.services.auth_service - INFO - Niveles calculados - Usuario 2458D1EA-816B-4C3C-8D13-B90271F59558: level=1, super_admin=False, type=user
2025-12-03 23:46:31,925 - app.modules.auth.application.services.refresh_token_service - INFO - [STORE-TOKEN] Token insertado exitosamente - Cliente ee7bfc14-995f-4209-b4b9-99c307534a43, Usuario 2458D1EA-816B-4C3C-8D13-B90271F59558, Tipo: web, Token ID: A4A044C9-B0F6-4561-BDA1-014FDA39A5A7, Rotación: False
2025-12-03 23:46:31,925 - app.modules.auth.presentation.endpoints - INFO - [LOGIN-WEB] Token almacenado - ID: A4A044C9-B0F6-4561-BDA1-014FDA39A5A7
2025-12-03 23:46:31,926 - app.modules.auth.presentation.endpoints - INFO - Usuario admin_acme autenticado exitosamente (WEB) para cliente ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:46:31,932 - app.modules.superadmin.application.services.audit_service - INFO - [AUDIT] auth_audit_log registrado: evento=login_success, cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43, usuario_id=2458D1EA-816B-4C3C-8D13-B90271F59558, exito=True
2025-12-03 23:46:31,933 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/login/ 200 265.2ms
2025-12-03 23:46:31,940 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/clientes/tenant/branding
2025-12-03 23:46:31,940 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 23:46:31,942 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': acme.app.local:5173
2025-12-03 23:46:31,942 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:46:31,943 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:46:31,943 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:46:31,947 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/menus/getmenu/
2025-12-03 23:46:31,949 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 23:46:31,950 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': acme.app.local:5173
2025-12-03 23:46:31,950 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:46:31,951 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:46:31,951 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:46:31,955 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:46:31,955 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:46:31,955 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:46:31,962 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:46:31,963 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC
2025-12-03 23:46:31,963 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43, tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC, path=/api/v1/clientes/tenant/branding
2025-12-03 23:46:31,966 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:46:31,968 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:46:31,968 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:46:31,970 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:46:31,976 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC
2025-12-03 23:46:31,976 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43, tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC, path=/api/v1/menus/getmenu/
2025-12-03 23:46:31,979 - app.api.deps - WARNING - [SECURITY] Acceso denegado: usuario 'admin_acme' (cliente 00000000-0000-0000-0000-000000000000) intentó acceder a cliente ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:46:31,981 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/clientes/tenant/branding 403 40.5ms
2025-12-03 23:46:31,988 - app.api.deps - WARNING - [SECURITY] Acceso denegado: usuario 'admin_acme' (cliente 00000000-0000-0000-0000-000000000000) intentó acceder a cliente ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:46:31,989 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/menus/getmenu/ 403 42.1ms
2025-12-03 23:46:31,991 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/menus/getmenu/
2025-12-03 23:46:31,993 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 23:46:31,993 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': acme.app.local:5173
2025-12-03 23:46:31,994 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:46:31,994 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:46:31,995 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:46:31,999 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:46:32,000 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:46:32,000 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:46:32,004 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:46:32,004 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC
2025-12-03 23:46:32,005 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43, tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC, path=/api/v1/menus/getmenu/
2025-12-03 23:46:32,014 - app.api.deps - WARNING - [SECURITY] Acceso denegado: usuario 'admin_acme' (cliente 00000000-0000-0000-0000-000000000000) intentó acceder a cliente ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:46:32,015 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/menus/getmenu/ 403 23.5ms
2025-12-03 23:46:56,745 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/logout/
2025-12-03 23:46:56,746 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 23:46:56,746 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': acme.app.local:5173
2025-12-03 23:46:56,747 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:46:56,747 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:46:56,748 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:46:56,754 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:46:56,754 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:46:56,755 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:46:56,760 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:46:56,760 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC
2025-12-03 23:46:56,761 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43, tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC, path=/api/v1/auth/logout/
2025-12-03 23:46:56,770 - app.modules.auth.application.services.refresh_token_service - WARNING - [REVOKE-TOKEN] Token no encontrado o ya revocado - Cliente ee7bfc14-995f-4209-b4b9-99c307534a43, Usuario 2458D1EA-816B-4C3C-8D13-B90271F59558
2025-12-03 23:46:56,770 - app.modules.auth.presentation.endpoints - INFO - [LOGOUT-WEB] Token no encontrado en BD (ya expirado/revocado) - Cliente: ee7bfc14-995f-4209-b4b9-99c307534a43, Usuario: 2458D1EA-816B-4C3C-8D13-B90271F59558 (admin_acme)
2025-12-03 23:46:56,770 - app.modules.superadmin.application.services.audit_service - INFO - [AUDIT] auth_audit_log registrado: evento=logout, cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43, usuario_id=2458D1EA-816B-4C3C-8D13-B90271F59558, exito=True
2025-12-03 23:46:56,770 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/logout/ 200 31.3ms
2025-12-03 23:47:06,957 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/login/
2025-12-03 23:47:06,958 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 23:47:06,959 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': acme.app.local:5173
2025-12-03 23:47:06,959 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:47:06,960 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:47:06,960 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:47:06,965 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:47:06,966 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:47:06,966 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:47:06,970 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:47:06,970 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC
2025-12-03 23:47:06,970 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43, tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC, path=/api/v1/auth/login/
2025-12-03 23:47:06,970 - app.modules.auth.presentation.endpoints - INFO - Cliente ee7bfc14-995f-4209-b4b9-99c307534a43 resuelto y validado para login.
2025-12-03 23:47:06,978 - app.modules.auth.application.services.auth_service - INFO - [AUTH] Intento de login: username='admin_acme', cliente_id_destino=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:47:06,979 - app.modules.auth.application.services.auth_service - INFO - [AUTH] Usuario regular. Buscando en BD del cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:47:07,197 - app.modules.auth.application.services.auth_service - INFO - Niveles calculados - Usuario 2458D1EA-816B-4C3C-8D13-B90271F59558: level=1, super_admin=False, type=user
2025-12-03 23:47:07,198 - app.modules.auth.application.services.auth_service - INFO - [AUTH] Login exitoso: username='admin_acme', usuario_id=2458D1EA-816B-4C3C-8D13-B90271F59558, cliente_origen=ee7bfc14-995f-4209-b4b9-99c307534a43, cliente_destino=N/A, access_level=1, user_type=user
2025-12-03 23:47:07,198 - app.infrastructure.database.queries_async - WARNING - [QUERY] DEPRECATED: execute_query() recibió string SQL. Migrar a SQLAlchemy Core.
2025-12-03 23:47:07,204 - app.modules.auth.application.services.auth_service - INFO - Niveles calculados - Usuario 2458D1EA-816B-4C3C-8D13-B90271F59558: level=1, super_admin=False, type=user
2025-12-03 23:47:07,208 - app.modules.auth.application.services.refresh_token_service - INFO - [STORE-TOKEN] Token insertado exitosamente - Cliente ee7bfc14-995f-4209-b4b9-99c307534a43, Usuario 2458D1EA-816B-4C3C-8D13-B90271F59558, Tipo: web, Token ID: 83FBFF9F-4343-49F2-B899-92C09262F40F, Rotación: False
2025-12-03 23:47:07,209 - app.modules.auth.presentation.endpoints - INFO - [LOGIN-WEB] Token almacenado - ID: 83FBFF9F-4343-49F2-B899-92C09262F40F
2025-12-03 23:47:07,209 - app.modules.auth.presentation.endpoints - INFO - Usuario admin_acme autenticado exitosamente (WEB) para cliente ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:47:07,215 - app.modules.superadmin.application.services.audit_service - INFO - [AUDIT] auth_audit_log registrado: evento=login_success, cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43, usuario_id=2458D1EA-816B-4C3C-8D13-B90271F59558, exito=True
2025-12-03 23:47:07,216 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/login/ 200 258.1ms
2025-12-03 23:47:07,223 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/clientes/tenant/branding
2025-12-03 23:47:07,225 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 23:47:07,226 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': acme.app.local:5173
2025-12-03 23:47:07,227 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:47:07,227 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:47:07,227 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:47:07,234 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/menus/getmenu/
2025-12-03 23:47:07,234 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 23:47:07,236 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': acme.app.local:5173
2025-12-03 23:47:07,236 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:47:07,236 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:47:07,236 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:47:07,240 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:47:07,240 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:47:07,245 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:47:07,249 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:47:07,249 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:47:07,249 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:47:07,257 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:47:07,258 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC
2025-12-03 23:47:07,259 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43, tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC, path=/api/v1/clientes/tenant/branding
2025-12-03 23:47:07,261 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:47:07,262 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC
2025-12-03 23:47:07,262 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43, tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC, path=/api/v1/menus/getmenu/
2025-12-03 23:47:07,276 - app.api.deps - WARNING - [SECURITY] Acceso denegado: usuario 'admin_acme' (cliente 00000000-0000-0000-0000-000000000000) intentó acceder a cliente ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:47:07,277 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/clientes/tenant/branding 403 53.3ms
2025-12-03 23:47:07,277 - app.api.deps - WARNING - [SECURITY] Acceso denegado: usuario 'admin_acme' (cliente 00000000-0000-0000-0000-000000000000) intentó acceder a cliente ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:47:07,279 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/menus/getmenu/ 403 45.4ms
2025-12-03 23:47:07,281 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/menus/getmenu/
2025-12-03 23:47:07,281 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 23:47:07,285 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': acme.app.local:5173
2025-12-03 23:47:07,285 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:47:07,285 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:47:07,286 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:47:07,290 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:47:07,291 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:47:07,292 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:47:07,297 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:47:07,298 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC
2025-12-03 23:47:07,299 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43, tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC, path=/api/v1/menus/getmenu/
2025-12-03 23:47:07,299 - app.api.deps - WARNING - [SECURITY] Acceso denegado: usuario 'admin_acme' (cliente 00000000-0000-0000-0000-000000000000) intentó acceder a cliente ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:47:07,299 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/menus/getmenu/ 403 26.2ms
2025-12-03 23:47:09,202 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/auth/refresh/
2025-12-03 23:47:09,202 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/auth/refresh/ 200 1.0ms
2025-12-03 23:47:09,202 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/refresh/
2025-12-03 23:47:09,202 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 23:47:09,202 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': acme.app.local:5173
2025-12-03 23:47:09,202 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:47:09,202 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:47:09,202 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:47:09,219 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:47:09,219 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:47:09,219 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:47:09,219 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:47:09,219 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC
2025-12-03 23:47:09,219 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43, tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC, path=/api/v1/auth/refresh/
2025-12-03 23:47:09,233 - app.modules.auth.application.services.refresh_token_service - INFO - [VALIDATE-TOKEN] Token válido - Cliente EE7BFC14-995F-4209-B4B9-99C307534A43, Usuario 2458D1EA-816B-4C3C-8D13-B90271F59558, Tipo: web
2025-12-03 23:47:09,233 - app.modules.auth.application.services.auth_service - INFO - [REFRESH] Token validado exitosamente (BD OK) para usuario: admin_acme (Cliente: ee7bfc14-995f-4209-b4b9-99c307534a43, Level: 1, Type: user)
2025-12-03 23:47:09,233 - app.modules.auth.application.services.auth_service - INFO - Niveles calculados - Usuario 2458D1EA-816B-4C3C-8D13-B90271F59558: level=1, super_admin=False, type=user
2025-12-03 23:47:09,252 - app.modules.auth.application.services.refresh_token_service - INFO - [STORE-TOKEN] Token insertado exitosamente - Cliente ee7bfc14-995f-4209-b4b9-99c307534a43, Usuario 2458D1EA-816B-4C3C-8D13-B90271F59558, Tipo: web, Token ID: 9661948E-A77D-4E4D-9243-1CBB3AFBC0AD, Rotación: True
2025-12-03 23:47:09,252 - app.modules.auth.application.services.refresh_token_service - WARNING - [REVOKE-TOKEN] Token no encontrado o ya revocado - Cliente ee7bfc14-995f-4209-b4b9-99c307534a43, Usuario 2458D1EA-816B-4C3C-8D13-B90271F59558
2025-12-03 23:47:09,252 - app.modules.auth.presentation.endpoints - WARNING - [REFRESH] Token antiguo no encontrado para revocar (no crítico)
2025-12-03 23:47:09,252 - app.modules.auth.presentation.endpoints - INFO - [REFRESH-WEB] Token rotado exitosamente - ID: 9661948E-A77D-4E4D-9243-1CBB3AFBC0AD
2025-12-03 23:47:09,252 - app.modules.auth.presentation.endpoints - INFO - [REFRESH-WEB] Token refrescado exitosamente - Usuario: admin_acme
2025-12-03 23:47:09,264 - app.modules.superadmin.application.services.audit_service - INFO - [AUDIT] auth_audit_log registrado: evento=token_refresh, cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43, usuario_id=2458D1EA-816B-4C3C-8D13-B90271F59558, exito=True
2025-12-03 23:47:09,265 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/refresh/ 200 55.1ms
2025-12-03 23:47:09,271 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/auth/me/
2025-12-03 23:47:09,272 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/auth/me/ 200 0.9ms
2025-12-03 23:47:09,273 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/auth/me/
2025-12-03 23:47:09,275 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 23:47:09,275 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': acme.app.local:5173
2025-12-03 23:47:09,275 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:47:09,275 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:47:09,276 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:47:09,280 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:47:09,280 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:47:09,281 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:47:09,285 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:47:09,287 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC
2025-12-03 23:47:09,287 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43, tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC, path=/api/v1/auth/me/
2025-12-03 23:47:09,291 - app.modules.auth.presentation.endpoints - INFO - Solicitud /me/ recibida para usuario: admin_acme
2025-12-03 23:47:09,291 - app.modules.auth.presentation.endpoints - INFO - [ME] Niveles desde token - Level: 1, Super Admin: False, Type: user
2025-12-03 23:47:09,293 - app.modules.users.application.services.user_service - INFO - Obteniendo usuario completo ID 2458D1EA-816B-4C3C-8D13-B90271F59558 para cliente ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:47:09,293 - app.infrastructure.database.queries_async - WARNING - [QUERY] DEPRECATED: execute_query() recibió string SQL. Migrar a SQLAlchemy Core.
2025-12-03 23:47:09,302 - app.modules.users.application.services.user_service - WARNING - Usuario ID 2458D1EA-816B-4C3C-8D13-B90271F59558 no encontrado en cliente ee7bfc14-995f-4209-b4b9-99c307534a43 o está eliminado
2025-12-03 23:47:09,302 - app.modules.auth.presentation.endpoints - ERROR - Usuario 2458D1EA-816B-4C3C-8D13-B90271F59558 no encontrado en cliente ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:47:09,302 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/auth/me/ 404 30.0ms
2025-12-03 23:48:05,623 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Pool ADMIN inicializado. Size=10, MaxOverflow=5
2025-12-03 23:48:05,623 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Configuración de pools de tenants: MaxPools=50, PoolSize=3, MaxOverflow=2, InactivityTimeout=3600s
2025-12-03 23:48:05,623 - app.infrastructure.database.connection_pool - INFO - ✅ Módulo de connection pooling cargado y activo
2025-12-03 23:48:05,623 - app.infrastructure.database.connection_pool - INFO -    Configuración: MaxTenantPools=50, TenantPoolSize=3, InactivityTimeout=3600s
2025-12-03 23:48:05,623 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Todos los pools cerrados
2025-12-03 23:48:05,623 - app.main - INFO - ✅ Pools de conexión cerrados correctamente
2025-12-03 23:48:05,730 - asyncio - ERROR - Unclosed connection
connection: <aioodbc.connection.Connection object at 0x000001AA900F8CB0>
2025-12-03 23:48:05,730 - asyncio - ERROR - Unclosed connection
connection: <aioodbc.connection.Connection object at 0x000001AA90C7EFF0>
2025-12-03 23:48:05,730 - asyncio - ERROR - Unclosed connection
connection: <aioodbc.connection.Connection object at 0x000001AA90E03290>
2025-12-03 23:48:05,730 - asyncio - ERROR - Unclosed connection
connection: <aioodbc.connection.Connection object at 0x000001AA90E440B0>
2025-12-03 23:48:06,482 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 23:48:06,690 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 23:48:06,694 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 23:48:06,699 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 23:48:06,699 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 23:48:06,700 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 23:48:06,701 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 23:48:06,701 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, DEFAULT_TYPE=single
2025-12-03 23:48:07,037 - app.core.security.rate_limiting - INFO - [RATE_LIMITING] Activado. Límites: Login=10/minute, API=200/minute
2025-12-03 23:48:07,038 - app.core.security.rate_limiting - INFO - ✅ Módulo de rate limiting cargado y activo
2025-12-03 23:48:07,111 - app.core.authorization.rbac - INFO - 🔐 Inicializando sistema de autorización...
2025-12-03 23:48:07,111 - app.core.authorization.rbac - INFO - ✅ Sistema de autorización inicializado correctamente
2025-12-03 23:48:07,111 - app.core.authorization.rbac - INFO - 📊 Permisos del sistema: 6 módulos configurados
2025-12-03 23:48:07,308 - app.core.tenant.middleware - INFO - Módulo tenant_middleware cargado (versión híbrida con soporte para proxies)
2025-12-03 23:48:07,310 - app.main - INFO - ✅ Rate limiting configurado y activo
2025-12-03 23:48:07,456 - app.core.tenant.middleware - INFO - [TENANT_MW] Inicializado - BASE_DOMAIN=app.local, SYSTEM_ID=BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, EXCLUDED_SUBDOMAINS={'backend', 'api', 'www', 'cdn', 'static', 'assets', 'admin'}
2025-12-03 23:48:09,144 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Pool ADMIN inicializado. Size=10, MaxOverflow=5
2025-12-03 23:48:09,144 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Configuración de pools de tenants: MaxPools=50, PoolSize=3, MaxOverflow=2, InactivityTimeout=3600s
2025-12-03 23:48:09,145 - app.infrastructure.database.connection_pool - INFO - ✅ Módulo de connection pooling cargado y activo
2025-12-03 23:48:09,145 - app.infrastructure.database.connection_pool - INFO -    Configuración: MaxTenantPools=50, TenantPoolSize=3, InactivityTimeout=3600s
2025-12-03 23:48:09,146 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Todos los pools cerrados
2025-12-03 23:48:09,146 - app.main - INFO - ✅ Pools de conexión cerrados correctamente
2025-12-03 23:48:10,770 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 23:48:10,988 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 23:48:10,995 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 23:48:10,997 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 23:48:10,998 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 23:48:10,998 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 23:48:10,998 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 23:48:11,000 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, DEFAULT_TYPE=single
2025-12-03 23:48:11,338 - app.core.security.rate_limiting - INFO - [RATE_LIMITING] Activado. Límites: Login=10/minute, API=200/minute
2025-12-03 23:48:11,338 - app.core.security.rate_limiting - INFO - ✅ Módulo de rate limiting cargado y activo
2025-12-03 23:48:11,430 - app.core.authorization.rbac - INFO - 🔐 Inicializando sistema de autorización...
2025-12-03 23:48:11,430 - app.core.authorization.rbac - INFO - ✅ Sistema de autorización inicializado correctamente
2025-12-03 23:48:11,431 - app.core.authorization.rbac - INFO - 📊 Permisos del sistema: 6 módulos configurados
2025-12-03 23:48:11,650 - app.core.tenant.middleware - INFO - Módulo tenant_middleware cargado (versión híbrida con soporte para proxies)
2025-12-03 23:48:11,650 - app.main - INFO - ✅ Rate limiting configurado y activo
2025-12-03 23:48:11,800 - app.core.tenant.middleware - INFO - [TENANT_MW] Inicializado - BASE_DOMAIN=app.local, SYSTEM_ID=BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, EXCLUDED_SUBDOMAINS={'www', 'backend', 'assets', 'api', 'static', 'admin', 'cdn'}
2025-12-03 23:48:19,812 - app.main - INFO - [SYSTEM] 127.0.0.1 -> POST /api/v1/auth/login/
2025-12-03 23:48:19,813 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 23:48:19,814 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': acme.app.local:5173
2025-12-03 23:48:19,814 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:48:19,814 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:48:19,815 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:48:19,817 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] AsyncEngine creado para admin
2025-12-03 23:48:19,952 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:48:19,952 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:48:19,952 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:48:19,954 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:48:24,051 - app.infrastructure.cache.redis_cache - WARNING - [REDIS_CACHE] Error conectando a Redis: Error 10061 connecting to localhost:6379. No se puede establecer una conexión ya que el equipo de destino denegó expresamente dicha conexión.. Cache desactivado automáticamente (usando fallback en memoria).
2025-12-03 23:48:24,051 - app.infrastructure.cache.redis_cache - INFO - ℹ️ Módulo de Redis cache cargado pero desactivado (usando fallback en memoria)
2025-12-03 23:48:24,067 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC
2025-12-03 23:48:24,067 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43, tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC, path=/api/v1/auth/login/
2025-12-03 23:48:24,075 - app.modules.auth.presentation.endpoints - INFO - Cliente ee7bfc14-995f-4209-b4b9-99c307534a43 resuelto y validado para login.
2025-12-03 23:48:24,076 - app.modules.auth.application.services.auth_service - INFO - [AUTH] Intento de login: username='admin_acme', cliente_id_destino=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:48:24,076 - app.modules.auth.application.services.auth_service - INFO - [AUTH] Usuario regular. Buscando en BD del cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:48:24,078 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] AsyncEngine creado para tenant_ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:48:24,391 - app.modules.auth.application.services.auth_service - INFO - Niveles calculados - Usuario 2458D1EA-816B-4C3C-8D13-B90271F59558: level=1, super_admin=False, type=user
2025-12-03 23:48:24,391 - app.modules.auth.application.services.auth_service - INFO - [AUTH] Login exitoso: username='admin_acme', usuario_id=2458D1EA-816B-4C3C-8D13-B90271F59558, cliente_origen=ee7bfc14-995f-4209-b4b9-99c307534a43, cliente_destino=N/A, access_level=1, user_type=user
2025-12-03 23:48:24,391 - app.infrastructure.database.queries_async - WARNING - [QUERY] DEPRECATED: execute_query() recibió string SQL. Migrar a SQLAlchemy Core.
2025-12-03 23:48:24,400 - app.modules.auth.application.services.auth_service - INFO - Niveles calculados - Usuario 2458D1EA-816B-4C3C-8D13-B90271F59558: level=1, super_admin=False, type=user
2025-12-03 23:48:24,410 - app.modules.auth.application.services.refresh_token_service - INFO - [STORE-TOKEN] Token insertado exitosamente - Cliente ee7bfc14-995f-4209-b4b9-99c307534a43, Usuario 2458D1EA-816B-4C3C-8D13-B90271F59558, Tipo: web, Token ID: E5728CE0-9033-40C6-9C12-78E15E015EF1, Rotación: False
2025-12-03 23:48:24,410 - app.modules.auth.presentation.endpoints - INFO - [LOGIN-WEB] Token almacenado - ID: E5728CE0-9033-40C6-9C12-78E15E015EF1
2025-12-03 23:48:24,410 - app.modules.auth.presentation.endpoints - INFO - Usuario admin_acme autenticado exitosamente (WEB) para cliente ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:48:24,420 - app.modules.superadmin.application.services.audit_service - INFO - [AUDIT] auth_audit_log registrado: evento=login_success, cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43, usuario_id=2458D1EA-816B-4C3C-8D13-B90271F59558, exito=True
2025-12-03 23:48:24,420 - app.main - INFO - [SYSTEM] 127.0.0.1 <- POST /api/v1/auth/login/ 200 4609.3ms
2025-12-03 23:48:24,430 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/clientes/tenant/branding
2025-12-03 23:48:24,430 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/clientes/tenant/branding 200 0.9ms
2025-12-03 23:48:24,439 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/clientes/tenant/branding
2025-12-03 23:48:24,440 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 23:48:24,441 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': acme.app.local:5173
2025-12-03 23:48:24,444 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:48:24,444 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:48:24,445 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:48:24,448 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/menus/getmenu/
2025-12-03 23:48:24,450 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/menus/getmenu/ 200 1.5ms
2025-12-03 23:48:24,450 - app.main - INFO - [SYSTEM] 127.0.0.1 -> OPTIONS /api/v1/menus/getmenu/
2025-12-03 23:48:24,453 - app.main - INFO - [SYSTEM] 127.0.0.1 <- OPTIONS /api/v1/menus/getmenu/ 200 1.5ms
2025-12-03 23:48:24,456 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/menus/getmenu/
2025-12-03 23:48:24,458 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 23:48:24,459 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': acme.app.local:5173
2025-12-03 23:48:24,459 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:48:24,460 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:48:24,461 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:48:24,465 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:48:24,466 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:48:24,467 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:48:24,472 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:48:24,473 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:48:24,473 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:48:24,479 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:48:24,479 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC
2025-12-03 23:48:24,480 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43, tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC, path=/api/v1/clientes/tenant/branding
2025-12-03 23:48:24,487 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:48:24,487 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC
2025-12-03 23:48:24,488 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43, tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC, path=/api/v1/menus/getmenu/
2025-12-03 23:48:24,515 - app.api.deps - ERROR - Error construyendo objeto completo para usuario 'admin_acme'
2025-12-03 23:48:24,515 - app.api.deps - ERROR - Error construyendo objeto completo para usuario 'admin_acme'
2025-12-03 23:48:24,515 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/menus/getmenu/ 500 60.7ms
2025-12-03 23:48:24,515 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/clientes/tenant/branding 500 78.2ms
2025-12-03 23:48:24,520 - app.main - INFO - [SYSTEM] 127.0.0.1 -> GET /api/v1/menus/getmenu/
2025-12-03 23:48:24,520 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Host 'backend.app.local:8000' es localhost/infraestructura, buscando tenant real en origin/referer
2025-12-03 23:48:24,523 - app.core.tenant.middleware - INFO - [HOST_DETECTION] Desarrollo: Tenant extraído de 'origin': acme.app.local:5173
2025-12-03 23:48:24,523 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:48:24,524 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:48:24,524 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:48:24,531 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Procesando host: 'acme.app.local'
2025-12-03 23:48:24,532 - app.core.tenant.middleware - INFO - [SUBDOMAIN] BASE_DOMAIN: 'app.local'
2025-12-03 23:48:24,532 - app.core.tenant.middleware - INFO - [SUBDOMAIN] Detectado: 'acme'
2025-12-03 23:48:24,536 - app.core.tenant.middleware - INFO - [TENANT] Cliente resuelto: Subdominio='acme', Código='ACME001', ID=ee7bfc14-995f-4209-b4b9-99c307534a43
2025-12-03 23:48:24,536 - app.core.tenant.middleware - INFO - [TENANT] Metadata cargada: tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC
2025-12-03 23:48:24,536 - app.core.tenant.middleware - INFO - [TENANT] CONTEXTO ESTABLECIDO: cliente_id=ee7bfc14-995f-4209-b4b9-99c307534a43, tipo_instalacion=dedicated, db_type=multi, bd=bd_cliente_acme, servidor=CARLOSPC, path=/api/v1/menus/getmenu/
2025-12-03 23:48:24,551 - app.api.deps - ERROR - Error construyendo objeto completo para usuario 'admin_acme'
2025-12-03 23:48:24,551 - app.main - INFO - [SYSTEM] 127.0.0.1 <- GET /api/v1/menus/getmenu/ 500 31.6ms
2025-12-03 23:48:39,790 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Pool ADMIN inicializado. Size=10, MaxOverflow=5
2025-12-03 23:48:39,791 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Configuración de pools de tenants: MaxPools=50, PoolSize=3, MaxOverflow=2, InactivityTimeout=3600s
2025-12-03 23:48:39,791 - app.infrastructure.database.connection_pool - INFO - ✅ Módulo de connection pooling cargado y activo
2025-12-03 23:48:39,792 - app.infrastructure.database.connection_pool - INFO -    Configuración: MaxTenantPools=50, TenantPoolSize=3, InactivityTimeout=3600s
2025-12-03 23:48:39,792 - app.infrastructure.database.connection_pool - INFO - [CONNECTION_POOL] Todos los pools cerrados
2025-12-03 23:48:39,793 - app.main - INFO - ✅ Pools de conexión cerrados correctamente
2025-12-03 23:48:40,723 - app.core.tenant.context - INFO - Módulo tenant_context cargado (versión híbrida)
2025-12-03 23:48:40,911 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] SQLAlchemy async disponible
2025-12-03 23:48:40,925 - app.infrastructure.database.connection_async - INFO - [ASYNC_CONNECTION] aioodbc disponible
2025-12-03 23:48:40,925 - app.core.security.encryption - INFO - EncryptionManager inicializado correctamente
2025-12-03 23:48:40,931 - app.core.security.encryption - INFO - Módulo de encriptación cargado correctamente
2025-12-03 23:48:40,931 - app.core.tenant.cache - INFO - ✅ ConnectionMetadataCache inicializado (TTL: 300s)
2025-12-03 23:48:40,931 - app.core.tenant.cache - INFO - Módulo connection_cache cargado. Cache global: ConnectionMetadataCache(size=0, ttl=300.0s)
2025-12-03 23:48:40,931 - app.core.tenant.routing - INFO - Módulo multi_db cargado. SYSTEM_CLIENT_ID=bba6fbad-4090-4ab8-b44a-4e8f5bc0bdb7, DEFAULT_TYPE=single
2025-12-03 23:48:41,303 - app.core.security.rate_limiting - INFO - [RATE_LIMITING] Activado. Límites: Login=10/minute, API=200/minute
2025-12-03 23:48:41,303 - app.core.security.rate_limiting - INFO - ✅ Módulo de rate limiting cargado y activo
2025-12-03 23:48:41,390 - app.core.authorization.rbac - INFO - 🔐 Inicializando sistema de autorización...
2025-12-03 23:48:41,390 - app.core.authorization.rbac - INFO - ✅ Sistema de autorización inicializado correctamente
2025-12-03 23:48:41,390 - app.core.authorization.rbac - INFO - 📊 Permisos del sistema: 6 módulos configurados
2025-12-03 23:48:41,591 - app.core.tenant.middleware - INFO - Módulo tenant_middleware cargado (versión híbrida con soporte para proxies)
2025-12-03 23:48:41,591 - app.main - INFO - ✅ Rate limiting configurado y activo
2025-12-03 23:48:41,750 - app.core.tenant.middleware - INFO - [TENANT_MW] Inicializado - BASE_DOMAIN=app.local, SYSTEM_ID=BBA6FBAD-4090-4AB8-B44A-4E8F5BC0BDB7, EXCLUDED_SUBDOMAINS={'cdn', 'assets', 'admin', 'www', 'api', 'backend', 'static'}
