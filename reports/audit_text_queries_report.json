[
  {
    "file": "app\\main.py",
    "line": 179,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "                        \"Access-Control-Allow-Origin\": origin,\n                        \"Access-Control-Allow-Methods\": \"GET, POST, PUT, DELETE, OPTIONS, PATCH\",\n                        # ✅ CORRECCIÓN CRÍTICA: Agregar X-Client-Type explícitamente\n                        \"Access-Control-Allow-Headers\": \"Content-Type, Authorization, X-Client-Type, Accept, Origin\",\n                        \"Access-Control-Allow-Credentials\": \"true\",\n                        \"Access-Control-Max-Age\": \"600\",\n           ",
    "type": "sql_string"
  },
  {
    "file": "app\\api\\deps.py",
    "line": 8,
    "issue": "Query con text() toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "- Lógica pesada movida a servicios dedicados\n- get_user_auth_context() para contexto mínimo\n- build_user_with_roles() para objetos completos cuando se necesiten\n\"\"\"\nfrom fastapi import Depends, HTTPException, status, Request\nfrom fastapi.security import OAuth2PasswordBearer\nfrom jose import JWTError, jwt\nfrom typing import List, Dict, Any\n\nfrom app.core.config import settings\nfrom app.core.auth import oauth2_scheme\nfrom app.core.auth.user_context import get_user_auth_context, validate_tenant_acc",
    "type": "text()"
  },
  {
    "file": "app\\api\\deps.py",
    "line": 8,
    "issue": "Query con text() toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "- Lógica pesada movida a servicios dedicados\n- get_user_auth_context() para contexto mínimo\n- build_user_with_roles() para objetos completos cuando se necesiten\n\"\"\"\nfrom fastapi import Depends, HTTPException, status, Request\nfrom fastapi.security import OAuth2PasswordBearer\nfrom jose import JWTError, jwt\nfrom typing import List, Dict, Any\n\nfrom app.core.config import settings\nfrom app.core.auth import oauth2_scheme\nfrom app.core.auth.user_context import get_user_auth_context, validate_tenant_acc",
    "type": "text()"
  },
  {
    "file": "app\\api\\deps.py",
    "line": 131,
    "issue": "Query con text() toca tabla usuario (verificar uso de cliente_id)",
    "severity": "medium",
    "tabla": "usuario",
    "context": "        # 2. Obtener contexto mínimo (validación rápida)\n        context = await get_user_auth_context(username, request_cliente_id)\n        \n        if not context:\n            logger.warning(f\"Usuario '{username}' no encontrado o inactivo\")\n            raise credentials_exception\n        \n        if not context.es_activo:\n            raise inactive_user_exception\n        \n        # 3. Validar acceso al tenant\n        if not await validate_tenant_access(context, request_cliente_id):\n           ",
    "type": "text() - tiene cliente_id"
  },
  {
    "file": "app\\api\\deps_backup.py",
    "line": 72,
    "issue": "Query con text() toca tabla rol (verificar uso de cliente_id)",
    "severity": "medium",
    "tabla": "rol",
    "context": "        \n        # ✅ FASE 4B: Usar parámetros nombrados con text().bindparams()\n        result = await execute_query(\n            text(GET_USER_MAX_ACCESS_LEVEL).bindparams(\n                usuario_id=usuario_id,\n                cliente_id=cliente_id\n            ),\n            client_id=cliente_id\n        )\n        \n        if result and len(result) > 0:\n            max_level = result[0].get('max_level', 1)\n            logger.debug(f\"Nivel máximo calculado para usuario {usuario_id}: {max_level}\"",
    "type": "text() - tiene cliente_id"
  },
  {
    "file": "app\\api\\deps_backup.py",
    "line": 72,
    "issue": "Query con text() toca tabla usuario (verificar uso de cliente_id)",
    "severity": "medium",
    "tabla": "usuario",
    "context": "        \n        # ✅ FASE 4B: Usar parámetros nombrados con text().bindparams()\n        result = await execute_query(\n            text(GET_USER_MAX_ACCESS_LEVEL).bindparams(\n                usuario_id=usuario_id,\n                cliente_id=cliente_id\n            ),\n            client_id=cliente_id\n        )\n        \n        if result and len(result) > 0:\n            max_level = result[0].get('max_level', 1)\n            logger.debug(f\"Nivel máximo calculado para usuario {usuario_id}: {max_level}\"",
    "type": "text() - tiene cliente_id"
  },
  {
    "file": "app\\api\\deps_backup.py",
    "line": 74,
    "issue": "Query con text() toca tabla rol (verificar uso de cliente_id)",
    "severity": "medium",
    "tabla": "rol",
    "context": "        result = await execute_query(\n            text(GET_USER_MAX_ACCESS_LEVEL).bindparams(\n                usuario_id=usuario_id,\n                cliente_id=cliente_id\n            ),\n            client_id=cliente_id\n        )\n        \n        if result and len(result) > 0:\n            max_level = result[0].get('max_level', 1)\n            logger.debug(f\"Nivel máximo calculado para usuario {usuario_id}: {max_level}\")\n            return max_level\n        else:\n            logger.warning(f\"No se ",
    "type": "text() - tiene cliente_id"
  },
  {
    "file": "app\\api\\deps_backup.py",
    "line": 74,
    "issue": "Query con text() toca tabla usuario (verificar uso de cliente_id)",
    "severity": "medium",
    "tabla": "usuario",
    "context": "        result = await execute_query(\n            text(GET_USER_MAX_ACCESS_LEVEL).bindparams(\n                usuario_id=usuario_id,\n                cliente_id=cliente_id\n            ),\n            client_id=cliente_id\n        )\n        \n        if result and len(result) > 0:\n            max_level = result[0].get('max_level', 1)\n            logger.debug(f\"Nivel máximo calculado para usuario {usuario_id}: {max_level}\")\n            return max_level\n        else:\n            logger.warning(f\"No se ",
    "type": "text() - tiene cliente_id"
  },
  {
    "file": "app\\api\\deps_backup.py",
    "line": 102,
    "issue": "Query con text() toca tabla rol (verificar uso de cliente_id)",
    "severity": "medium",
    "tabla": "rol",
    "context": "        \n        # ✅ FASE 4B: Usar parámetros nombrados con text().bindparams()\n        result = await execute_query(\n            text(GET_USER_ACCESS_LEVEL_INFO_COMPLETE).bindparams(\n                usuario_id=usuario_id,\n                cliente_id=cliente_id\n            ),\n            client_id=cliente_id\n        )\n        \n        if result and len(result) > 0:\n            level_info = result[0]\n            logger.info(f\"DIAGNÓSTICO NIVELES - Usuario {usuario_id}: {level_info}\")\n            r",
    "type": "text() - tiene cliente_id"
  },
  {
    "file": "app\\api\\deps_backup.py",
    "line": 102,
    "issue": "Query con text() toca tabla usuario (verificar uso de cliente_id)",
    "severity": "medium",
    "tabla": "usuario",
    "context": "        \n        # ✅ FASE 4B: Usar parámetros nombrados con text().bindparams()\n        result = await execute_query(\n            text(GET_USER_ACCESS_LEVEL_INFO_COMPLETE).bindparams(\n                usuario_id=usuario_id,\n                cliente_id=cliente_id\n            ),\n            client_id=cliente_id\n        )\n        \n        if result and len(result) > 0:\n            level_info = result[0]\n            logger.info(f\"DIAGNÓSTICO NIVELES - Usuario {usuario_id}: {level_info}\")\n            r",
    "type": "text() - tiene cliente_id"
  },
  {
    "file": "app\\api\\deps_backup.py",
    "line": 104,
    "issue": "Query con text() toca tabla rol (verificar uso de cliente_id)",
    "severity": "medium",
    "tabla": "rol",
    "context": "        result = await execute_query(\n            text(GET_USER_ACCESS_LEVEL_INFO_COMPLETE).bindparams(\n                usuario_id=usuario_id,\n                cliente_id=cliente_id\n            ),\n            client_id=cliente_id\n        )\n        \n        if result and len(result) > 0:\n            level_info = result[0]\n            logger.info(f\"DIAGNÓSTICO NIVELES - Usuario {usuario_id}: {level_info}\")\n            return level_info\n        else:\n            logger.warning(f\"DIAGNÓSTICO NIVELES ",
    "type": "text() - tiene cliente_id"
  },
  {
    "file": "app\\api\\deps_backup.py",
    "line": 104,
    "issue": "Query con text() toca tabla usuario (verificar uso de cliente_id)",
    "severity": "medium",
    "tabla": "usuario",
    "context": "        result = await execute_query(\n            text(GET_USER_ACCESS_LEVEL_INFO_COMPLETE).bindparams(\n                usuario_id=usuario_id,\n                cliente_id=cliente_id\n            ),\n            client_id=cliente_id\n        )\n        \n        if result and len(result) > 0:\n            level_info = result[0]\n            logger.info(f\"DIAGNÓSTICO NIVELES - Usuario {usuario_id}: {level_info}\")\n            return level_info\n        else:\n            logger.warning(f\"DIAGNÓSTICO NIVELES ",
    "type": "text() - tiene cliente_id"
  },
  {
    "file": "app\\api\\deps_backup.py",
    "line": 131,
    "issue": "Query con text() toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "        \n        # ✅ FASE 4B: Usar parámetros nombrados con text().bindparams()\n        result = await execute_query(\n            text(IS_USER_SUPER_ADMIN).bindparams(\n                usuario_id=usuario_id\n            )\n        )\n        \n        if result and len(result) > 0:\n            is_super_admin = result[0].get('is_super_admin', 0) > 0\n            logger.debug(f\"Usuario {usuario_id} es super admin: {is_super_admin}\")\n            return is_super_admin\n        else:\n            return Fals",
    "type": "text()"
  },
  {
    "file": "app\\api\\deps_backup.py",
    "line": 133,
    "issue": "Query con text() toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "        result = await execute_query(\n            text(IS_USER_SUPER_ADMIN).bindparams(\n                usuario_id=usuario_id\n            )\n        )\n        \n        if result and len(result) > 0:\n            is_super_admin = result[0].get('is_super_admin', 0) > 0\n            logger.debug(f\"Usuario {usuario_id} es super admin: {is_super_admin}\")\n            return is_super_admin\n        else:\n            return False\n            \n    except Exception as e:\n        logger.error(f\"Error al verifi",
    "type": "text()"
  },
  {
    "file": "app\\core\\auth\\user_builder.py",
    "line": 34,
    "issue": "Query con text() toca tabla rol (verificar uso de cliente_id)",
    "severity": "medium",
    "tabla": "rol",
    "context": "    Esta función se usa cuando se necesita el objeto completo, no solo el contexto.\n    Para validación rápida, usar get_user_auth_context() en su lugar.\n    \n    Args:\n        username: Nombre de usuario\n        request_cliente_id: ID del cliente del request\n    \n    Returns:\n        UsuarioReadWithRoles si existe, None en caso contrario\n    \"\"\"\n    try:\n        # ✅ Obtener database_type del contexto para determinar si es BD dedicada\n        from app.core.tenant.context import try_get_tenant_co",
    "type": "text() - tiene cliente_id"
  },
  {
    "file": "app\\core\\auth\\user_builder.py",
    "line": 34,
    "issue": "Query con text() toca tabla usuario (verificar uso de cliente_id)",
    "severity": "medium",
    "tabla": "usuario",
    "context": "    Esta función se usa cuando se necesita el objeto completo, no solo el contexto.\n    Para validación rápida, usar get_user_auth_context() en su lugar.\n    \n    Args:\n        username: Nombre de usuario\n        request_cliente_id: ID del cliente del request\n    \n    Returns:\n        UsuarioReadWithRoles si existe, None en caso contrario\n    \"\"\"\n    try:\n        # ✅ Obtener database_type del contexto para determinar si es BD dedicada\n        from app.core.tenant.context import try_get_tenant_co",
    "type": "text() - tiene cliente_id"
  },
  {
    "file": "app\\core\\auth\\user_builder.py",
    "line": 47,
    "issue": "Query con text() toca tabla usuario (verificar uso de cliente_id)",
    "severity": "medium",
    "tabla": "usuario",
    "context": "        \n        tenant_context = try_get_tenant_context()\n        database_type = tenant_context.database_type if tenant_context else \"single\"\n        \n        # 1. Obtener usuario básico\n        # ✅ Para BD dedicadas, no filtrar por cliente_id (todos los usuarios pertenecen al mismo cliente)\n        if database_type == \"multi\":\n            # BD dedicada: buscar solo por nombre_usuario\n            user_query = select(UsuarioTable).where(\n                and_(\n                    UsuarioTable.c.",
    "type": "text() - tiene cliente_id"
  },
  {
    "file": "app\\core\\auth\\user_builder.py",
    "line": 84,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "            # Fallback: buscar sin filtro de cliente (para casos edge)\n            user_query = select(UsuarioTable).where(\n                and_(\n                    UsuarioTable.c.nombre_usuario == username,\n                    UsuarioTable.c.es_eliminado == False\n                )\n            )\n            user_result = await execute_auth_query(user_query)\n        \n        if not user_result:\n            return None\n        ",
    "type": "sql_string"
  },
  {
    "file": "app\\core\\auth\\user_context.py",
    "line": 16,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "from app.infrastructure.database.tables import UsuarioTable, UsuarioRolTable, RolTable\nfrom sqlalchemy import select, func, and_, or_\n\nlogger = logging.getLogger(__name__)\n\n\n@dataclass\nclass CurrentUserContext:\n    \"\"\"\n    Contexto mínimo del usuario autenticado.\n    \n    Contiene solo la información esencial necesaria para autorización",
    "type": "sql_string"
  },
  {
    "file": "app\\core\\auth\\user_context.py",
    "line": 16,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "from app.infrastructure.database.tables import UsuarioTable, UsuarioRolTable, RolTable\nfrom sqlalchemy import select, func, and_, or_\n\nlogger = logging.getLogger(__name__)\n\n\n@dataclass\nclass CurrentUserContext:\n    \"\"\"\n    Contexto mínimo del usuario autenticado.\n    \n    Contiene solo la información esencial necesaria para autorización",
    "type": "sql_string"
  },
  {
    "file": "app\\core\\auth\\user_context.py",
    "line": 38,
    "issue": "Query con text() toca tabla rol (verificar uso de cliente_id)",
    "severity": "medium",
    "tabla": "rol",
    "context": "\nasync def get_user_auth_context(\n    username: str,\n    request_cliente_id: Optional[UUID] = None\n) -> Optional[CurrentUserContext]:\n    \"\"\"\n    Obtiene el contexto mínimo del usuario autenticado.\n    \n    Esta función es optimizada y retorna solo la información esencial:\n    - usuario_id, cliente_id, nombre_usuario, es_activo\n    - is_superadmin, nivel_acceso\n    - roles (solo nombres)\n    \n    No construye objetos Pydantic completos ni objetos de dominio.\n    \n    Args:\n        username: Nomb",
    "type": "text() - tiene cliente_id"
  },
  {
    "file": "app\\core\\auth\\user_context.py",
    "line": 38,
    "issue": "Query con text() toca tabla usuario (verificar uso de cliente_id)",
    "severity": "medium",
    "tabla": "usuario",
    "context": "\nasync def get_user_auth_context(\n    username: str,\n    request_cliente_id: Optional[UUID] = None\n) -> Optional[CurrentUserContext]:\n    \"\"\"\n    Obtiene el contexto mínimo del usuario autenticado.\n    \n    Esta función es optimizada y retorna solo la información esencial:\n    - usuario_id, cliente_id, nombre_usuario, es_activo\n    - is_superadmin, nivel_acceso\n    - roles (solo nombres)\n    \n    No construye objetos Pydantic completos ni objetos de dominio.\n    \n    Args:\n        username: Nomb",
    "type": "text() - tiene cliente_id"
  },
  {
    "file": "app\\core\\auth\\user_context.py",
    "line": 66,
    "issue": "Query con text() toca tabla usuario (verificar uso de cliente_id)",
    "severity": "medium",
    "tabla": "usuario",
    "context": "        \n        tenant_context = try_get_tenant_context()\n        database_type = tenant_context.database_type if tenant_context else \"single\"\n        \n        # 1. Obtener usuario básico\n        # ✅ Para BD dedicadas, no filtrar por cliente_id (todos los usuarios pertenecen al mismo cliente)\n        if database_type == \"multi\":\n            # BD dedicada: buscar solo por nombre_usuario\n            user_query = select(UsuarioTable).where(\n                and_(\n                    UsuarioTable.c.",
    "type": "text() - tiene cliente_id"
  },
  {
    "file": "app\\core\\auth\\user_context.py",
    "line": 104,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "            # Fallback: buscar sin filtro de cliente (para casos edge)\n            user_query = select(UsuarioTable).where(\n                and_(\n                    UsuarioTable.c.nombre_usuario == username,\n                    UsuarioTable.c.es_eliminado == False\n                )\n            )\n            user_result = await execute_auth_query(user_query)\n        \n        if not user_result:\n            logger.warning(f\"Usuario '{username}' no encontrado en BD\")\n            return None",
    "type": "sql_string"
  },
  {
    "file": "app\\core\\auth\\user_context.py",
    "line": 186,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "            \n            roles_query = select(\n                RolTable.c.rol_id,\n                RolTable.c.nombre,\n                RolTable.c.nivel_acceso,\n                RolTable.c.codigo_rol\n            ).select_from(\n                UsuarioRolTable.join(RolTable, UsuarioRolTable.c.rol_id == RolTable.c.rol_id)\n            ).where(\n                and_(\n                    UsuarioRolTable.c.usuario_id == usuario_id,\n                    UsuarioRolTable.c.es_activo == True,",
    "type": "sql_string"
  },
  {
    "file": "app\\core\\auth\\user_context.py",
    "line": 186,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "            \n            roles_query = select(\n                RolTable.c.rol_id,\n                RolTable.c.nombre,\n                RolTable.c.nivel_acceso,\n                RolTable.c.codigo_rol\n            ).select_from(\n                UsuarioRolTable.join(RolTable, UsuarioRolTable.c.rol_id == RolTable.c.rol_id)\n            ).where(\n                and_(\n                    UsuarioRolTable.c.usuario_id == usuario_id,\n                    UsuarioRolTable.c.es_activo == True,",
    "type": "sql_string"
  },
  {
    "file": "app\\core\\auth\\user_context.py",
    "line": 237,
    "issue": "Query con text() toca tabla rol (verificar uso de cliente_id)",
    "severity": "medium",
    "tabla": "rol",
    "context": "        # 4. Construir y retornar contexto\n        context = CurrentUserContext(\n            usuario_id=usuario_id,\n            cliente_id=cliente_id,\n            nombre_usuario=username,\n            es_activo=es_activo,\n            is_superadmin=is_superadmin,\n            nivel_acceso=nivel_acceso,\n            roles=roles_list\n        )\n        \n        logger.debug(\n            f\"Contexto de usuario obtenido: {username}, \"\n            f\"cliente_id={cliente_id}, nivel={nivel_acceso}, \"\n        ",
    "type": "text() - tiene cliente_id"
  },
  {
    "file": "app\\core\\auth\\user_context.py",
    "line": 237,
    "issue": "Query con text() toca tabla usuario (verificar uso de cliente_id)",
    "severity": "medium",
    "tabla": "usuario",
    "context": "        # 4. Construir y retornar contexto\n        context = CurrentUserContext(\n            usuario_id=usuario_id,\n            cliente_id=cliente_id,\n            nombre_usuario=username,\n            es_activo=es_activo,\n            is_superadmin=is_superadmin,\n            nivel_acceso=nivel_acceso,\n            roles=roles_list\n        )\n        \n        logger.debug(\n            f\"Contexto de usuario obtenido: {username}, \"\n            f\"cliente_id={cliente_id}, nivel={nivel_acceso}, \"\n        ",
    "type": "text() - tiene cliente_id"
  },
  {
    "file": "app\\core\\security\\query_auditor.py",
    "line": 34,
    "issue": "Query con text() toca tabla rol (verificar uso de cliente_id)",
    "severity": "medium",
    "tabla": "rol",
    "context": "    Características:\n    - Valida queries SQLAlchemy Core, TextClause y strings\n    - Reconoce tablas globales que no requieren filtro de tenant\n    - Bloquea queries inseguras en producción (si ENABLE_QUERY_TENANT_VALIDATION=True)\n    - Genera advertencias en desarrollo para facilitar debugging\n    \n    Uso:\n        Normalmente no se usa directamente, se integra automáticamente en execute_query().\n        Para uso manual:\n        \n        ```python\n        from sqlalchemy import select\n        ",
    "type": "text() - tiene cliente_id"
  },
  {
    "file": "app\\core\\security\\query_auditor.py",
    "line": 34,
    "issue": "Query con text() toca tabla usuario (verificar uso de cliente_id)",
    "severity": "medium",
    "tabla": "usuario",
    "context": "    Características:\n    - Valida queries SQLAlchemy Core, TextClause y strings\n    - Reconoce tablas globales que no requieren filtro de tenant\n    - Bloquea queries inseguras en producción (si ENABLE_QUERY_TENANT_VALIDATION=True)\n    - Genera advertencias en desarrollo para facilitar debugging\n    \n    Uso:\n        Normalmente no se usa directamente, se integra automáticamente en execute_query().\n        Para uso manual:\n        \n        ```python\n        from sqlalchemy import select\n        ",
    "type": "text() - tiene cliente_id"
  },
  {
    "file": "app\\core\\security\\query_auditor.py",
    "line": 352,
    "issue": "Query con text() toca tabla usuario (verificar uso de cliente_id)",
    "severity": "medium",
    "tabla": "usuario",
    "context": "def validate_query_tenant_filter(\n    query: Union[str, ClauseElement, TextClause],\n    table_name: Optional[str] = None,\n    client_id: Optional[Any] = None,\n    skip_validation: bool = False\n) -> bool:\n    \"\"\"\n    Función helper para validar filtro de tenant en queries.\n    \n    Uso:\n        from app.core.security.query_auditor import validate_query_tenant_filter\n        \n        if not validate_query_tenant_filter(query, table_name=\"usuario\"):\n            raise SecurityError(\"Query sin filtro",
    "type": "text() - tiene cliente_id"
  },
  {
    "file": "app\\core\\tenant\\routing.py",
    "line": 87,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "    from app.infrastructure.database.tables import ClienteConexionTable, ClienteTable\n    from sqlalchemy import select, text\n    \n    # Query para obtener metadata de conexión usando SQLAlchemy Core\n    query = select(\n        ClienteConexionTable.c.conexion_id,\n        ClienteConexionTable.c.servidor,\n        ClienteConexionTable.c.puerto,\n        ClienteConexionTable.c.nombre_bd,\n        ClienteConexionTable.c.usuario_encriptado,\n        ClienteConexionTable.c.password_encriptado,\n        Cli",
    "type": "sql_string"
  },
  {
    "file": "app\\core\\tenant\\routing.py",
    "line": 90,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "    # Query para obtener metadata de conexión usando SQLAlchemy Core\n    query = select(\n        ClienteConexionTable.c.conexion_id,\n        ClienteConexionTable.c.servidor,\n        ClienteConexionTable.c.puerto,\n        ClienteConexionTable.c.nombre_bd,\n        ClienteConexionTable.c.usuario_encriptado,\n        ClienteConexionTable.c.password_encriptado,\n        ClienteConexionTable.c.tipo_bd,\n        ClienteConexionTable.c.usa_ssl,\n        ClienteTable.c.tipo_instalacion,\n        ClienteTable.",
    "type": "sql_string"
  },
  {
    "file": "app\\core\\tenant\\routing.py",
    "line": 343,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "                    from app.infrastructure.database.tables import ClienteConexionTable\n                    query_conexion = select(\n                        ClienteConexionTable.c.conexion_id,\n                        ClienteConexionTable.c.servidor,\n                        ClienteConexionTable.c.puerto,\n                        ClienteConexionTable.c.nombre_bd,\n                        ClienteConexionTable.c.usuario_encriptado,\n                        ClienteConexionTable.c.password_encriptado,\n  ",
    "type": "sql_string"
  },
  {
    "file": "app\\infrastructure\\database\\connection_async.py",
    "line": 12,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "    async with get_db_connection() as session:\n        result = await session.execute(select(UsuarioTable))\n        rows = result.fetchall()\n\"\"\"\n\nimport logging\nfrom typing import AsyncIterator, Optional, Union\nfrom contextlib import asynccontextmanager\nfrom enum import Enum\nfrom uuid import UUID\n\nfrom app.core.config import settings",
    "type": "sql_string"
  },
  {
    "file": "app\\infrastructure\\database\\connection_async.py",
    "line": 270,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "        async with get_db_connection() as session:\n            result = await session.execute(select(UsuarioTable))\n            rows = result.fetchall()\n    \"\"\"\n    if not ASYNC_AVAILABLE or not AIOODBC_AVAILABLE:\n        raise ImportError(\n            \"Dependencias async no disponibles. \"\n            \"Instalar: pip install 'sqlalchemy[asyncio]' aioodbc\"\n        )\n    \n    # ✅ FASE 5: Si no se proporciona metadata y es DEFAULT, obtenerla del routing\n    if connection_type == DatabaseConnection.D",
    "type": "sql_string"
  },
  {
    "file": "app\\infrastructure\\database\\queries.py",
    "line": 285,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "IS_USER_SUPER_ADMIN = \"\"\"\nSELECT COUNT(*) as is_super_admin\nFROM usuario_rol ur\nINNER JOIN rol r ON ur.rol_id = r.rol_id\nWHERE ur.usuario_id = ? \n  AND ur.es_activo = 1\n  AND r.es_activo = 1\n  AND r.codigo_rol = 'SUPER_ADMIN'\n  AND r.nivel_acceso = 5\n\"\"\"\n\n# Query para obtener el nivel mínimo requerido por una lista de roles",
    "type": "sql_string"
  },
  {
    "file": "app\\infrastructure\\database\\queries.py",
    "line": 285,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "IS_USER_SUPER_ADMIN = \"\"\"\nSELECT COUNT(*) as is_super_admin\nFROM usuario_rol ur\nINNER JOIN rol r ON ur.rol_id = r.rol_id\nWHERE ur.usuario_id = ? \n  AND ur.es_activo = 1\n  AND r.es_activo = 1\n  AND r.codigo_rol = 'SUPER_ADMIN'\n  AND r.nivel_acceso = 5\n\"\"\"\n\n# Query para obtener el nivel mínimo requerido por una lista de roles",
    "type": "sql_string"
  },
  {
    "file": "app\\infrastructure\\database\\queries.py",
    "line": 285,
    "issue": "Query SQL directa toca tabla usuario_rol sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario_rol",
    "context": "IS_USER_SUPER_ADMIN = \"\"\"\nSELECT COUNT(*) as is_super_admin\nFROM usuario_rol ur\nINNER JOIN rol r ON ur.rol_id = r.rol_id\nWHERE ur.usuario_id = ? \n  AND ur.es_activo = 1\n  AND r.es_activo = 1\n  AND r.codigo_rol = 'SUPER_ADMIN'\n  AND r.nivel_acceso = 5\n\"\"\"\n\n# Query para obtener el nivel mínimo requerido por una lista de roles",
    "type": "sql_string"
  },
  {
    "file": "app\\infrastructure\\database\\queries.py",
    "line": 297,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "GET_MIN_REQUIRED_ACCESS_LEVEL = \"\"\"\nSELECT MIN(nivel_acceso) as min_required_level\nFROM rol \nWHERE nombre IN ({}) \n  AND es_activo = 1\n\"\"\"\n\n# NUEVA QUERY: Obtener información completa de niveles (MÁS ROBUSTA)\nGET_USER_ACCESS_LEVEL_INFO_COMPLETE = \"\"\"\nSELECT \n    ISNULL(MAX(r.nivel_acceso), 1) as max_level,\n    COUNT(CASE WHEN r.codigo_rol = 'SUPER_ADMIN' AND r.nivel_acceso = 5 THEN 1 END) as super_admin_count,",
    "type": "sql_string"
  },
  {
    "file": "app\\infrastructure\\database\\queries.py",
    "line": 319,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "GET_USER_ROLES_WITH_LEVELS = \"\"\"\nSELECT \n    r.rol_id,\n    r.nombre,\n    r.descripcion,\n    r.nivel_acceso,\n    r.codigo_rol,\n    r.es_activo\nFROM usuario_rol ur\nINNER JOIN rol r ON ur.rol_id = r.rol_id\nWHERE ur.usuario_id = ? \n  AND ur.es_activo = 1",
    "type": "sql_string"
  },
  {
    "file": "app\\infrastructure\\database\\queries.py",
    "line": 319,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "GET_USER_ROLES_WITH_LEVELS = \"\"\"\nSELECT \n    r.rol_id,\n    r.nombre,\n    r.descripcion,\n    r.nivel_acceso,\n    r.codigo_rol,\n    r.es_activo\nFROM usuario_rol ur\nINNER JOIN rol r ON ur.rol_id = r.rol_id\nWHERE ur.usuario_id = ? \n  AND ur.es_activo = 1",
    "type": "sql_string"
  },
  {
    "file": "app\\infrastructure\\database\\queries.py",
    "line": 319,
    "issue": "Query SQL directa toca tabla usuario_rol sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario_rol",
    "context": "GET_USER_ROLES_WITH_LEVELS = \"\"\"\nSELECT \n    r.rol_id,\n    r.nombre,\n    r.descripcion,\n    r.nivel_acceso,\n    r.codigo_rol,\n    r.es_activo\nFROM usuario_rol ur\nINNER JOIN rol r ON ur.rol_id = r.rol_id\nWHERE ur.usuario_id = ? \n  AND ur.es_activo = 1",
    "type": "sql_string"
  },
  {
    "file": "app\\infrastructure\\database\\queries.py",
    "line": 577,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "WITH UserRoles AS (\n    SELECT\n        u.usuario_id,\n        u.nombre_usuario,\n        u.correo,\n        u.contrasena, \n        u.nombre,\n        u.apellido,\n        u.es_activo,\n        u.correo_confirmado,\n        u.fecha_creacion,\n        u.fecha_ultimo_acceso,",
    "type": "sql_string"
  },
  {
    "file": "app\\infrastructure\\database\\queries.py",
    "line": 577,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "WITH UserRoles AS (\n    SELECT\n        u.usuario_id,\n        u.nombre_usuario,\n        u.correo,\n        u.contrasena, \n        u.nombre,\n        u.apellido,\n        u.es_activo,\n        u.correo_confirmado,\n        u.fecha_creacion,\n        u.fecha_ultimo_acceso,",
    "type": "sql_string"
  },
  {
    "file": "app\\infrastructure\\database\\queries.py",
    "line": 1101,
    "issue": "Query SQL directa toca tabla log_sincronizacion_usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "log_sincronizacion_usuario",
    "context": ")\nOUTPUT INSERTED.log_id, INSERTED.fecha_evento\nVALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);\n\"\"\"\n\nINSERT_LOG_SINCRONIZACION_USUARIO = \"\"\"\nINSERT INTO log_sincronizacion_usuario (\n    cliente_origen_id,\n    cliente_destino_id,\n    usuario_id,\n    tipo_sincronizacion,\n    direccion,",
    "type": "sql_string"
  },
  {
    "file": "app\\infrastructure\\database\\queries.py",
    "line": 1101,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": ")\nOUTPUT INSERTED.log_id, INSERTED.fecha_evento\nVALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);\n\"\"\"\n\nINSERT_LOG_SINCRONIZACION_USUARIO = \"\"\"\nINSERT INTO log_sincronizacion_usuario (\n    cliente_origen_id,\n    cliente_destino_id,\n    usuario_id,\n    tipo_sincronizacion,\n    direccion,",
    "type": "sql_string"
  },
  {
    "file": "app\\infrastructure\\database\\queries.py",
    "line": 1105,
    "issue": "Query SQL directa toca tabla log_sincronizacion_usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "log_sincronizacion_usuario",
    "context": "\nINSERT_LOG_SINCRONIZACION_USUARIO = \"\"\"\nINSERT INTO log_sincronizacion_usuario (\n    cliente_origen_id,\n    cliente_destino_id,\n    usuario_id,\n    tipo_sincronizacion,\n    direccion,\n    operacion,\n    estado,\n    mensaje_error,\n    campos_sincronizados,",
    "type": "sql_string"
  },
  {
    "file": "app\\infrastructure\\database\\queries.py",
    "line": 1105,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "\nINSERT_LOG_SINCRONIZACION_USUARIO = \"\"\"\nINSERT INTO log_sincronizacion_usuario (\n    cliente_origen_id,\n    cliente_destino_id,\n    usuario_id,\n    tipo_sincronizacion,\n    direccion,\n    operacion,\n    estado,\n    mensaje_error,\n    campos_sincronizados,",
    "type": "sql_string"
  },
  {
    "file": "app\\infrastructure\\database\\queries.py",
    "line": 1106,
    "issue": "Query SQL directa toca tabla log_sincronizacion_usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "log_sincronizacion_usuario",
    "context": "INSERT_LOG_SINCRONIZACION_USUARIO = \"\"\"\nINSERT INTO log_sincronizacion_usuario (\n    cliente_origen_id,\n    cliente_destino_id,\n    usuario_id,\n    tipo_sincronizacion,\n    direccion,\n    operacion,\n    estado,\n    mensaje_error,\n    campos_sincronizados,\n    cambios_detectados,",
    "type": "sql_string"
  },
  {
    "file": "app\\infrastructure\\database\\queries.py",
    "line": 1106,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "INSERT_LOG_SINCRONIZACION_USUARIO = \"\"\"\nINSERT INTO log_sincronizacion_usuario (\n    cliente_origen_id,\n    cliente_destino_id,\n    usuario_id,\n    tipo_sincronizacion,\n    direccion,\n    operacion,\n    estado,\n    mensaje_error,\n    campos_sincronizados,\n    cambios_detectados,",
    "type": "sql_string"
  },
  {
    "file": "app\\infrastructure\\database\\queries.py",
    "line": 1256,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "\nSELECT_CLIENT_CONNECTION_METADATA = \"\"\"\nSELECT \n    cc.conexion_id,\n    cc.servidor,\n    cc.puerto,\n    cc.nombre_bd,\n    cc.usuario_encriptado,\n    cc.password_encriptado,\n    cc.tipo_bd,\n    cc.usa_ssl,\n    c.tipo_instalacion,",
    "type": "sql_string"
  },
  {
    "file": "app\\infrastructure\\database\\queries.py",
    "line": 1257,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "SELECT_CLIENT_CONNECTION_METADATA = \"\"\"\nSELECT \n    cc.conexion_id,\n    cc.servidor,\n    cc.puerto,\n    cc.nombre_bd,\n    cc.usuario_encriptado,\n    cc.password_encriptado,\n    cc.tipo_bd,\n    cc.usa_ssl,\n    c.tipo_instalacion,\n    c.metadata_json",
    "type": "sql_string"
  },
  {
    "file": "app\\infrastructure\\database\\queries_async.py",
    "line": 8,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "- Usa SQLAlchemy AsyncSession\n- Acepta objetos SQLAlchemy Core (Select, Update, Delete, Insert)\n- Aplica filtro de tenant automáticamente\n\nUSO:\n    from app.infrastructure.database.queries_async import execute_query\n    \n    query = select(UsuarioTable).where(UsuarioTable.c.nombre_usuario == username)\n    results = await execute_query(query)\n\"\"\"\n\nfrom typing import List, Dict, Any, Optional, Union, Tuple",
    "type": "sql_string"
  },
  {
    "file": "app\\infrastructure\\database\\queries_async.py",
    "line": 14,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "    \n    query = select(UsuarioTable).where(UsuarioTable.c.nombre_usuario == username)\n    results = await execute_query(query)\n\"\"\"\n\nfrom typing import List, Dict, Any, Optional, Union, Tuple\nfrom uuid import UUID\nfrom sqlalchemy import Select, Update, Delete, Insert, text, TextClause\nfrom sqlalchemy.sql import ClauseElement\nfrom sqlalchemy.ext.asyncio import AsyncSession\n\nfrom app.infrastructure.database.connection_async import get_db_connection, DatabaseConnection",
    "type": "sql_string"
  },
  {
    "file": "app\\infrastructure\\database\\queries_async.py",
    "line": 115,
    "issue": "Query con text() toca tabla usuario (verificar uso de cliente_id)",
    "severity": "medium",
    "tabla": "usuario",
    "context": "        \n        # Query con text() para casos complejos\n        from sqlalchemy import text\n        query = text(\"SELECT * FROM usuario WHERE cliente_id = :cliente_id\").bindparams(\n            cliente_id=current_client_id\n        )\n        results = await execute_query(query, client_id=current_client_id)\n        ```\n    \n    Note:\n        - Para queries string (deprecated), se aplica análisis estático para detectar\n          filtros de tenant, pero es menos seguro que SQLAlchemy Core.\n        -",
    "type": "text() - tiene cliente_id"
  },
  {
    "file": "app\\infrastructure\\database\\queries_async.py",
    "line": 117,
    "issue": "Query con text() toca tabla usuario (verificar uso de cliente_id)",
    "severity": "medium",
    "tabla": "usuario",
    "context": "        from sqlalchemy import text\n        query = text(\"SELECT * FROM usuario WHERE cliente_id = :cliente_id\").bindparams(\n            cliente_id=current_client_id\n        )\n        results = await execute_query(query, client_id=current_client_id)\n        ```\n    \n    Note:\n        - Para queries string (deprecated), se aplica análisis estático para detectar\n          filtros de tenant, pero es menos seguro que SQLAlchemy Core.\n        - Se recomienda migrar todas las queries a SQLAlchemy Core",
    "type": "text() - tiene cliente_id"
  },
  {
    "file": "app\\infrastructure\\database\\queries_async.py",
    "line": 185,
    "issue": "Query con text() toca tabla rol (verificar uso de cliente_id)",
    "severity": "medium",
    "tabla": "rol",
    "context": "        # ✅ FASE 5: Usar routing centralizado\n        async with _get_connection_context(connection_type, client_id) as session:\n            try:\n                result = await session.execute(query)\n                \n                # Si es SELECT, obtener resultados\n                if isinstance(query, Select):\n                    rows = result.fetchall()\n                    columns = result.keys()\n                    return [dict(zip(columns, row)) for row in rows]\n                else:\n      ",
    "type": "text() - tiene cliente_id"
  },
  {
    "file": "app\\infrastructure\\database\\queries_async.py",
    "line": 190,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "                # Si es SELECT, obtener resultados\n                if isinstance(query, Select):\n                    rows = result.fetchall()\n                    columns = result.keys()\n                    return [dict(zip(columns, row)) for row in rows]\n                else:\n                    # UPDATE/DELETE/INSERT: retornar información de filas afectadas\n                    await session.commit()\n                    return [{\"rows_affected\": result.rowcount}]\n                    \n           ",
    "type": "sql_string"
  },
  {
    "file": "app\\infrastructure\\database\\queries_async.py",
    "line": 207,
    "issue": "Query con text() toca tabla rol (verificar uso de cliente_id)",
    "severity": "medium",
    "tabla": "rol",
    "context": "    \n    elif isinstance(query, TextClause):\n        # ✅ Aceptar TextClause (resultado de text().bindparams())\n        # ✅ FASE 5: Usar routing centralizado\n        async with _get_connection_context(connection_type, client_id) as session:\n            try:\n                result = await session.execute(query)\n                rows = result.fetchall()\n                columns = result.keys()\n                return [dict(zip(columns, row)) for row in rows]\n            except Exception as e:\n        ",
    "type": "text() - tiene cliente_id"
  },
  {
    "file": "app\\infrastructure\\database\\queries_async.py",
    "line": 208,
    "issue": "Query con text() toca tabla rol (verificar uso de cliente_id)",
    "severity": "medium",
    "tabla": "rol",
    "context": "    elif isinstance(query, TextClause):\n        # ✅ Aceptar TextClause (resultado de text().bindparams())\n        # ✅ FASE 5: Usar routing centralizado\n        async with _get_connection_context(connection_type, client_id) as session:\n            try:\n                result = await session.execute(query)\n                rows = result.fetchall()\n                columns = result.keys()\n                return [dict(zip(columns, row)) for row in rows]\n            except Exception as e:\n             ",
    "type": "text() - tiene cliente_id"
  },
  {
    "file": "app\\infrastructure\\database\\queries_async.py",
    "line": 210,
    "issue": "Query con text() toca tabla rol (verificar uso de cliente_id)",
    "severity": "medium",
    "tabla": "rol",
    "context": "        # ✅ FASE 5: Usar routing centralizado\n        async with _get_connection_context(connection_type, client_id) as session:\n            try:\n                result = await session.execute(query)\n                rows = result.fetchall()\n                columns = result.keys()\n                return [dict(zip(columns, row)) for row in rows]\n            except Exception as e:\n                await session.rollback()\n                logger.error(f\"Error en execute_query async (TextClause): {str",
    "type": "text() - tiene cliente_id"
  },
  {
    "file": "app\\infrastructure\\database\\queries_async.py",
    "line": 218,
    "issue": "Query con text() toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "                await session.rollback()\n                logger.error(f\"Error en execute_query async (TextClause): {str(e)}\")\n                raise DatabaseError(\n                    detail=f\"Error en la consulta: {str(e)}\",\n                    internal_code=\"DB_QUERY_ERROR\"\n                )\n    \n    elif isinstance(query, str):\n        # ⚠️ DEPRECATED: Queries string (mantener compatibilidad temporal)\n        logger.warning(\n            \"[QUERY] DEPRECATED: execute_query() recibió string SQL. ",
    "type": "text()"
  },
  {
    "file": "app\\infrastructure\\database\\queries_async.py",
    "line": 287,
    "issue": "Query con text() toca tabla rol (verificar uso de cliente_id)",
    "severity": "medium",
    "tabla": "rol",
    "context": "                            query_text = query_text.replace(\"?\", f\":{key}\", 1)\n                        query = text(query_text).bindparams(**params)\n                else:\n                    logger.warning(f\"execute_query recibió params de tipo inesperado: {type(params)}, ejecutando query sin parámetros\")\n                    query = text(query)\n            else:\n                query = text(query)\n        else:\n            query = text(query)\n        \n        # ✅ FASE 5: Usar routing centralizad",
    "type": "text() - tiene cliente_id"
  },
  {
    "file": "app\\infrastructure\\database\\queries_async.py",
    "line": 290,
    "issue": "Query con text() toca tabla rol (verificar uso de cliente_id)",
    "severity": "medium",
    "tabla": "rol",
    "context": "                    logger.warning(f\"execute_query recibió params de tipo inesperado: {type(params)}, ejecutando query sin parámetros\")\n                    query = text(query)\n            else:\n                query = text(query)\n        else:\n            query = text(query)\n        \n        # ✅ FASE 5: Usar routing centralizado\n        async with _get_connection_context(connection_type, client_id) as session:\n            try:\n                result = await session.execute(query)\n               ",
    "type": "text() - tiene cliente_id"
  },
  {
    "file": "app\\infrastructure\\database\\queries_async.py",
    "line": 292,
    "issue": "Query con text() toca tabla rol (verificar uso de cliente_id)",
    "severity": "medium",
    "tabla": "rol",
    "context": "            else:\n                query = text(query)\n        else:\n            query = text(query)\n        \n        # ✅ FASE 5: Usar routing centralizado\n        async with _get_connection_context(connection_type, client_id) as session:\n            try:\n                result = await session.execute(query)\n                rows = result.fetchall()\n                columns = result.keys()\n                return [dict(zip(columns, row)) for row in rows]\n            except Exception as e:\n          ",
    "type": "text() - tiene cliente_id"
  },
  {
    "file": "app\\infrastructure\\database\\queries_async.py",
    "line": 294,
    "issue": "Query con text() toca tabla rol (verificar uso de cliente_id)",
    "severity": "medium",
    "tabla": "rol",
    "context": "        else:\n            query = text(query)\n        \n        # ✅ FASE 5: Usar routing centralizado\n        async with _get_connection_context(connection_type, client_id) as session:\n            try:\n                result = await session.execute(query)\n                rows = result.fetchall()\n                columns = result.keys()\n                return [dict(zip(columns, row)) for row in rows]\n            except Exception as e:\n                await session.rollback()\n                logger.",
    "type": "text() - tiene cliente_id"
  },
  {
    "file": "app\\infrastructure\\database\\queries_async.py",
    "line": 297,
    "issue": "Query con text() toca tabla rol (verificar uso de cliente_id)",
    "severity": "medium",
    "tabla": "rol",
    "context": "        # ✅ FASE 5: Usar routing centralizado\n        async with _get_connection_context(connection_type, client_id) as session:\n            try:\n                result = await session.execute(query)\n                rows = result.fetchall()\n                columns = result.keys()\n                return [dict(zip(columns, row)) for row in rows]\n            except Exception as e:\n                await session.rollback()\n                logger.error(f\"Error en execute_query async (string): {str(e)}",
    "type": "text() - tiene cliente_id"
  },
  {
    "file": "app\\infrastructure\\database\\queries_async.py",
    "line": 327,
    "issue": "Query con text() toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "    Args:\n        query: Consulta SQL (string), objeto SQLAlchemy Core (Select), o TextClause\n        params: Parámetros opcionales (tupla o dict). Si es tupla y query tiene '?', se convierte a parámetros nombrados.\n        connection_type: Tipo de conexión (DEFAULT o ADMIN)\n    \n    Returns:\n        Diccionario con el registro o None si no existe\n    \"\"\"\n    if isinstance(query, Select):\n        # ✅ FASE 5: Usar routing centralizado\n        async with _get_connection_context(connection_type) as",
    "type": "text()"
  },
  {
    "file": "app\\infrastructure\\database\\queries_async.py",
    "line": 336,
    "issue": "Query con text() toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "        # ✅ FASE 5: Usar routing centralizado\n        async with _get_connection_context(connection_type) as session:\n            try:\n                result = await session.execute(query)\n                row = result.fetchone()\n                \n                if row:\n                    columns = result.keys()\n                    return dict(zip(columns, row))\n                return None\n            except Exception as e:\n                await session.rollback()\n                logger.error(f\"",
    "type": "text()"
  },
  {
    "file": "app\\infrastructure\\database\\queries_async.py",
    "line": 353,
    "issue": "Query con text() toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "    \n    elif isinstance(query, TextClause):\n        # ✅ Aceptar TextClause (resultado de text().bindparams())\n        async with _get_connection_context(connection_type) as session:\n            try:\n                result = await session.execute(query)\n                row = result.fetchone()\n                \n                if row:\n                    columns = result.keys()\n                    return dict(zip(columns, row))\n                return None\n            except Exception as e:\n       ",
    "type": "text()"
  },
  {
    "file": "app\\infrastructure\\database\\queries_async.py",
    "line": 354,
    "issue": "Query con text() toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "    elif isinstance(query, TextClause):\n        # ✅ Aceptar TextClause (resultado de text().bindparams())\n        async with _get_connection_context(connection_type) as session:\n            try:\n                result = await session.execute(query)\n                row = result.fetchone()\n                \n                if row:\n                    columns = result.keys()\n                    return dict(zip(columns, row))\n                return None\n            except Exception as e:\n            ",
    "type": "text()"
  },
  {
    "file": "app\\infrastructure\\database\\queries_async.py",
    "line": 355,
    "issue": "Query con text() toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "        # ✅ Aceptar TextClause (resultado de text().bindparams())\n        async with _get_connection_context(connection_type) as session:\n            try:\n                result = await session.execute(query)\n                row = result.fetchone()\n                \n                if row:\n                    columns = result.keys()\n                    return dict(zip(columns, row))\n                return None\n            except Exception as e:\n                await session.rollback()\n           ",
    "type": "text()"
  },
  {
    "file": "app\\infrastructure\\database\\queries_async.py",
    "line": 366,
    "issue": "Query con text() toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "                await session.rollback()\n                logger.error(f\"Error en execute_auth_query async (TextClause): {str(e)}\")\n                raise DatabaseError(\n                    detail=f\"Error en la autenticación: {str(e)}\",\n                    internal_code=\"DB_AUTH_ERROR\"\n                )\n    \n    elif isinstance(query, str):\n        # String SQL - convertir ? a parámetros nombrados si hay params\n        if params is not None:\n            # Contar cuántos ? hay en la query\n         ",
    "type": "text()"
  },
  {
    "file": "app\\infrastructure\\database\\queries_async.py",
    "line": 400,
    "issue": "Query con text() toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "                            query_text = query_text.replace(\"?\", f\":{key}\", 1)\n                        query = text(query_text).bindparams(**params)\n                else:\n                    logger.warning(f\"execute_auth_query recibió params de tipo inesperado: {type(params)}, ejecutando query sin parámetros\")\n                    query = text(query)\n            else:\n                query = text(query)\n        else:\n            query = text(query)\n        \n        async with _get_connection_cont",
    "type": "text()"
  },
  {
    "file": "app\\infrastructure\\database\\queries_async.py",
    "line": 403,
    "issue": "Query con text() toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "                    logger.warning(f\"execute_auth_query recibió params de tipo inesperado: {type(params)}, ejecutando query sin parámetros\")\n                    query = text(query)\n            else:\n                query = text(query)\n        else:\n            query = text(query)\n        \n        async with _get_connection_context(connection_type) as session:\n            try:\n                result = await session.execute(query)\n                row = result.fetchone()\n                \n          ",
    "type": "text()"
  },
  {
    "file": "app\\infrastructure\\database\\queries_async.py",
    "line": 405,
    "issue": "Query con text() toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "            else:\n                query = text(query)\n        else:\n            query = text(query)\n        \n        async with _get_connection_context(connection_type) as session:\n            try:\n                result = await session.execute(query)\n                row = result.fetchone()\n                \n                if row:\n                    columns = result.keys()\n                    return dict(zip(columns, row))\n                return None\n            except Exception as e:\n         ",
    "type": "text()"
  },
  {
    "file": "app\\infrastructure\\database\\queries_async.py",
    "line": 407,
    "issue": "Query con text() toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "        else:\n            query = text(query)\n        \n        async with _get_connection_context(connection_type) as session:\n            try:\n                result = await session.execute(query)\n                row = result.fetchone()\n                \n                if row:\n                    columns = result.keys()\n                    return dict(zip(columns, row))\n                return None\n            except Exception as e:\n                await session.rollback()\n                logger",
    "type": "text()"
  },
  {
    "file": "app\\infrastructure\\database\\queries_async.py",
    "line": 409,
    "issue": "Query con text() toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "        \n        async with _get_connection_context(connection_type) as session:\n            try:\n                result = await session.execute(query)\n                row = result.fetchone()\n                \n                if row:\n                    columns = result.keys()\n                    return dict(zip(columns, row))\n                return None\n            except Exception as e:\n                await session.rollback()\n                logger.error(f\"Error en execute_auth_query async (st",
    "type": "text()"
  },
  {
    "file": "app\\infrastructure\\database\\queries_async.py",
    "line": 452,
    "issue": "Query con text() toca tabla rol (verificar uso de cliente_id)",
    "severity": "medium",
    "tabla": "rol",
    "context": "    if isinstance(query, Insert):\n        async with _get_connection_context(connection_type, client_id) as session:\n            try:\n                result = await session.execute(query)\n                await session.commit()\n                \n                # Obtener datos insertados si hay OUTPUT\n                if result.returns_rows:\n                    row = result.fetchone()\n                    if row:\n                        columns = result.keys()\n                        data = dict(zip",
    "type": "text() - tiene cliente_id"
  },
  {
    "file": "app\\infrastructure\\database\\queries_async.py",
    "line": 476,
    "issue": "Query con text() toca tabla rol (verificar uso de cliente_id)",
    "severity": "medium",
    "tabla": "rol",
    "context": "    \n    elif isinstance(query, TextClause):\n        # ✅ Aceptar TextClause (resultado de text().bindparams())\n        async with _get_connection_context(connection_type, client_id) as session:\n            try:\n                result = await session.execute(query)\n                await session.commit()\n                \n                if result.returns_rows:\n                    row = result.fetchone()\n                    if row:\n                        columns = result.keys()\n                   ",
    "type": "text() - tiene cliente_id"
  },
  {
    "file": "app\\infrastructure\\database\\queries_async.py",
    "line": 477,
    "issue": "Query con text() toca tabla rol (verificar uso de cliente_id)",
    "severity": "medium",
    "tabla": "rol",
    "context": "    elif isinstance(query, TextClause):\n        # ✅ Aceptar TextClause (resultado de text().bindparams())\n        async with _get_connection_context(connection_type, client_id) as session:\n            try:\n                result = await session.execute(query)\n                await session.commit()\n                \n                if result.returns_rows:\n                    row = result.fetchone()\n                    if row:\n                        columns = result.keys()\n                        ",
    "type": "text() - tiene cliente_id"
  },
  {
    "file": "app\\infrastructure\\database\\queries_async.py",
    "line": 478,
    "issue": "Query con text() toca tabla rol (verificar uso de cliente_id)",
    "severity": "medium",
    "tabla": "rol",
    "context": "        # ✅ Aceptar TextClause (resultado de text().bindparams())\n        async with _get_connection_context(connection_type, client_id) as session:\n            try:\n                result = await session.execute(query)\n                await session.commit()\n                \n                if result.returns_rows:\n                    row = result.fetchone()\n                    if row:\n                        columns = result.keys()\n                        data = dict(zip(columns, row))\n         ",
    "type": "text() - tiene cliente_id"
  },
  {
    "file": "app\\infrastructure\\database\\queries_async.py",
    "line": 495,
    "issue": "Query con text() toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "                await session.rollback()\n                logger.error(f\"Error en execute_insert async (TextClause): {str(e)}\")\n                raise DatabaseError(\n                    detail=f\"Error en la inserción: {str(e)}\",\n                    internal_code=\"DB_INSERT_ERROR\"\n                )\n    \n    elif isinstance(query, str):\n        # String SQL - convertir ? a parámetros nombrados si hay params\n        if params is not None:\n            # Contar cuántos ? hay en la query\n            que",
    "type": "text()"
  },
  {
    "file": "app\\infrastructure\\database\\queries_async.py",
    "line": 495,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "                await session.rollback()\n                logger.error(f\"Error en execute_insert async (TextClause): {str(e)}\")\n                raise DatabaseError(\n                    detail=f\"Error en la inserción: {str(e)}\",\n                    internal_code=\"DB_INSERT_ERROR\"\n                )\n    \n    elif isinstance(query, str):\n        # String SQL - convertir ? a parámetros nombrados si hay params\n        if params is not None:\n            # Contar cuántos ? hay en la query\n            que",
    "type": "sql_string"
  },
  {
    "file": "app\\infrastructure\\database\\queries_async.py",
    "line": 524,
    "issue": "Query con text() toca tabla rol (verificar uso de cliente_id)",
    "severity": "medium",
    "tabla": "rol",
    "context": "            else:\n                query = text(query)\n        else:\n            query = text(query)\n        \n        async with _get_connection_context(connection_type, client_id) as session:\n            try:\n                result = await session.execute(query)\n                await session.commit()\n                \n                if result.returns_rows:\n                    row = result.fetchone()\n                    if row:\n                        columns = result.keys()\n                     ",
    "type": "text() - tiene cliente_id"
  },
  {
    "file": "app\\infrastructure\\database\\queries_async.py",
    "line": 526,
    "issue": "Query con text() toca tabla rol (verificar uso de cliente_id)",
    "severity": "medium",
    "tabla": "rol",
    "context": "        else:\n            query = text(query)\n        \n        async with _get_connection_context(connection_type, client_id) as session:\n            try:\n                result = await session.execute(query)\n                await session.commit()\n                \n                if result.returns_rows:\n                    row = result.fetchone()\n                    if row:\n                        columns = result.keys()\n                        data = dict(zip(columns, row))\n                    ",
    "type": "text() - tiene cliente_id"
  },
  {
    "file": "app\\infrastructure\\database\\queries_async.py",
    "line": 528,
    "issue": "Query con text() toca tabla rol (verificar uso de cliente_id)",
    "severity": "medium",
    "tabla": "rol",
    "context": "        \n        async with _get_connection_context(connection_type, client_id) as session:\n            try:\n                result = await session.execute(query)\n                await session.commit()\n                \n                if result.returns_rows:\n                    row = result.fetchone()\n                    if row:\n                        columns = result.keys()\n                        data = dict(zip(columns, row))\n                        data[\"rows_affected\"] = result.rowcount\n  ",
    "type": "text() - tiene cliente_id"
  },
  {
    "file": "app\\infrastructure\\database\\queries_async.py",
    "line": 545,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "                await session.rollback()\n                logger.error(f\"Error en execute_insert async (string): {str(e)}\")\n                raise DatabaseError(\n                    detail=f\"Error en la inserción: {str(e)}\",\n                    internal_code=\"DB_INSERT_ERROR\"\n                )\n    else:\n        raise ValueError(\n            f\"query debe ser string SQL, objeto SQLAlchemy Core (Insert), o TextClause, recibido: {type(query)}\"\n        )\n\n",
    "type": "sql_string"
  },
  {
    "file": "app\\infrastructure\\database\\queries_async.py",
    "line": 577,
    "issue": "Query con text() toca tabla rol (verificar uso de cliente_id)",
    "severity": "medium",
    "tabla": "rol",
    "context": "    if isinstance(query, Update):\n        async with _get_connection_context(connection_type, client_id) as session:\n            try:\n                result = await session.execute(query)\n                await session.commit()\n                \n                if result.returns_rows:\n                    row = result.fetchone()\n                    if row:\n                        columns = result.keys()\n                        data = dict(zip(columns, row))\n                        data[\"rows_affect",
    "type": "text() - tiene cliente_id"
  },
  {
    "file": "app\\infrastructure\\database\\queries_async.py",
    "line": 600,
    "issue": "Query con text() toca tabla rol (verificar uso de cliente_id)",
    "severity": "medium",
    "tabla": "rol",
    "context": "    \n    elif isinstance(query, TextClause):\n        # ✅ Aceptar TextClause (resultado de text().bindparams())\n        async with _get_connection_context(connection_type, client_id) as session:\n            try:\n                result = await session.execute(query)\n                await session.commit()\n                \n                if result.returns_rows:\n                    row = result.fetchone()\n                    if row:\n                        columns = result.keys()\n                   ",
    "type": "text() - tiene cliente_id"
  },
  {
    "file": "app\\infrastructure\\database\\queries_async.py",
    "line": 601,
    "issue": "Query con text() toca tabla rol (verificar uso de cliente_id)",
    "severity": "medium",
    "tabla": "rol",
    "context": "    elif isinstance(query, TextClause):\n        # ✅ Aceptar TextClause (resultado de text().bindparams())\n        async with _get_connection_context(connection_type, client_id) as session:\n            try:\n                result = await session.execute(query)\n                await session.commit()\n                \n                if result.returns_rows:\n                    row = result.fetchone()\n                    if row:\n                        columns = result.keys()\n                        ",
    "type": "text() - tiene cliente_id"
  },
  {
    "file": "app\\infrastructure\\database\\queries_async.py",
    "line": 602,
    "issue": "Query con text() toca tabla rol (verificar uso de cliente_id)",
    "severity": "medium",
    "tabla": "rol",
    "context": "        # ✅ Aceptar TextClause (resultado de text().bindparams())\n        async with _get_connection_context(connection_type, client_id) as session:\n            try:\n                result = await session.execute(query)\n                await session.commit()\n                \n                if result.returns_rows:\n                    row = result.fetchone()\n                    if row:\n                        columns = result.keys()\n                        data = dict(zip(columns, row))\n         ",
    "type": "text() - tiene cliente_id"
  },
  {
    "file": "app\\infrastructure\\database\\queries_async.py",
    "line": 619,
    "issue": "Query con text() toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "                await session.rollback()\n                logger.error(f\"Error en execute_update async (TextClause): {str(e)}\")\n                raise DatabaseError(\n                    detail=f\"Error en la actualización: {str(e)}\",\n                    internal_code=\"DB_UPDATE_ERROR\"\n                )\n    \n    elif isinstance(query, str):\n        # String SQL - convertir ? a parámetros nombrados si hay params\n        if params is not None:\n            # Contar cuántos ? hay en la query\n           ",
    "type": "text()"
  },
  {
    "file": "app\\infrastructure\\database\\queries_async.py",
    "line": 619,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "                await session.rollback()\n                logger.error(f\"Error en execute_update async (TextClause): {str(e)}\")\n                raise DatabaseError(\n                    detail=f\"Error en la actualización: {str(e)}\",\n                    internal_code=\"DB_UPDATE_ERROR\"\n                )\n    \n    elif isinstance(query, str):\n        # String SQL - convertir ? a parámetros nombrados si hay params\n        if params is not None:\n            # Contar cuántos ? hay en la query\n           ",
    "type": "sql_string"
  },
  {
    "file": "app\\infrastructure\\database\\queries_async.py",
    "line": 648,
    "issue": "Query con text() toca tabla rol (verificar uso de cliente_id)",
    "severity": "medium",
    "tabla": "rol",
    "context": "            else:\n                query = text(query)\n        else:\n            query = text(query)\n        \n        async with _get_connection_context(connection_type, client_id) as session:\n            try:\n                result = await session.execute(query)\n                await session.commit()\n                \n                if result.returns_rows:\n                    row = result.fetchone()\n                    if row:\n                        columns = result.keys()\n                     ",
    "type": "text() - tiene cliente_id"
  },
  {
    "file": "app\\infrastructure\\database\\queries_async.py",
    "line": 650,
    "issue": "Query con text() toca tabla rol (verificar uso de cliente_id)",
    "severity": "medium",
    "tabla": "rol",
    "context": "        else:\n            query = text(query)\n        \n        async with _get_connection_context(connection_type, client_id) as session:\n            try:\n                result = await session.execute(query)\n                await session.commit()\n                \n                if result.returns_rows:\n                    row = result.fetchone()\n                    if row:\n                        columns = result.keys()\n                        data = dict(zip(columns, row))\n                    ",
    "type": "text() - tiene cliente_id"
  },
  {
    "file": "app\\infrastructure\\database\\queries_async.py",
    "line": 652,
    "issue": "Query con text() toca tabla rol (verificar uso de cliente_id)",
    "severity": "medium",
    "tabla": "rol",
    "context": "        \n        async with _get_connection_context(connection_type, client_id) as session:\n            try:\n                result = await session.execute(query)\n                await session.commit()\n                \n                if result.returns_rows:\n                    row = result.fetchone()\n                    if row:\n                        columns = result.keys()\n                        data = dict(zip(columns, row))\n                        data[\"rows_affected\"] = result.rowcount\n  ",
    "type": "text() - tiene cliente_id"
  },
  {
    "file": "app\\infrastructure\\database\\queries_async.py",
    "line": 669,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "                await session.rollback()\n                logger.error(f\"Error en execute_update async (string): {str(e)}\")\n                raise DatabaseError(\n                    detail=f\"Error en la actualización: {str(e)}\",\n                    internal_code=\"DB_UPDATE_ERROR\"\n                )\n    else:\n        raise ValueError(\n            f\"query debe ser string SQL, objeto SQLAlchemy Core (Update), o TextClause, recibido: {type(query)}\"\n        )\n\n",
    "type": "sql_string"
  },
  {
    "file": "app\\infrastructure\\database\\queries_async.py",
    "line": 698,
    "issue": "Query con text() toca tabla rol (verificar uso de cliente_id)",
    "severity": "medium",
    "tabla": "rol",
    "context": "    \"\"\"\n    async with _get_connection_context(connection_type, client_id) as session:\n        try:\n            # Ejecutar stored procedure usando text() con formato SQL Server\n            query = text(f\"EXEC {procedure_name}\")\n            result = await session.execute(query)\n            rows = result.fetchall()\n            columns = result.keys()\n            return [dict(zip(columns, row)) for row in rows]\n        except Exception as e:\n            await session.rollback()\n            logger.e",
    "type": "text() - tiene cliente_id"
  },
  {
    "file": "app\\infrastructure\\database\\queries_async.py",
    "line": 700,
    "issue": "Query con text() toca tabla rol (verificar uso de cliente_id)",
    "severity": "medium",
    "tabla": "rol",
    "context": "        try:\n            # Ejecutar stored procedure usando text() con formato SQL Server\n            query = text(f\"EXEC {procedure_name}\")\n            result = await session.execute(query)\n            rows = result.fetchall()\n            columns = result.keys()\n            return [dict(zip(columns, row)) for row in rows]\n        except Exception as e:\n            await session.rollback()\n            logger.error(f\"Error en execute_procedure async: {str(e)}\")\n            raise DatabaseError(\n  ",
    "type": "text() - tiene cliente_id"
  },
  {
    "file": "app\\infrastructure\\database\\queries_async.py",
    "line": 701,
    "issue": "Query con text() toca tabla rol (verificar uso de cliente_id)",
    "severity": "medium",
    "tabla": "rol",
    "context": "            # Ejecutar stored procedure usando text() con formato SQL Server\n            query = text(f\"EXEC {procedure_name}\")\n            result = await session.execute(query)\n            rows = result.fetchall()\n            columns = result.keys()\n            return [dict(zip(columns, row)) for row in rows]\n        except Exception as e:\n            await session.rollback()\n            logger.error(f\"Error en execute_procedure async: {str(e)}\")\n            raise DatabaseError(\n               ",
    "type": "text() - tiene cliente_id"
  },
  {
    "file": "app\\infrastructure\\database\\query_builder.py",
    "line": 16,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "    where_clause, params = SafeQueryBuilder.build_where_clause(filters)\n    query = f\"SELECT * FROM usuarios WHERE {where_clause}\"\n    results = execute_query(query, params)\n\"\"\"\n\nimport re\nimport logging\nfrom typing import Dict, Any, List, Tuple, Optional\n\nlogger = logging.getLogger(__name__)\n\n",
    "type": "sql_string"
  },
  {
    "file": "app\\infrastructure\\database\\query_optimizer.py",
    "line": 256,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "    from app.infrastructure.database.queries_async import execute_query\n    from sqlalchemy import select\n    \n    if not usuario_ids:\n        return {}\n    \n    # Query única con JOIN para todos los usuarios\n    query = (\n        select(\n            UsuarioRolTable.c.usuario_id,\n            RolTable.c.rol_id,\n            RolTable.c.nombre,",
    "type": "sql_string"
  },
  {
    "file": "app\\infrastructure\\database\\query_optimizer.py",
    "line": 256,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "    from app.infrastructure.database.queries_async import execute_query\n    from sqlalchemy import select\n    \n    if not usuario_ids:\n        return {}\n    \n    # Query única con JOIN para todos los usuarios\n    query = (\n        select(\n            UsuarioRolTable.c.usuario_id,\n            RolTable.c.rol_id,\n            RolTable.c.nombre,",
    "type": "sql_string"
  },
  {
    "file": "app\\infrastructure\\database\\query_optimizer.py",
    "line": 263,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "    query = (\n        select(\n            UsuarioRolTable.c.usuario_id,\n            RolTable.c.rol_id,\n            RolTable.c.nombre,\n            RolTable.c.descripcion,\n            RolTable.c.nivel_acceso,\n            RolTable.c.codigo_rol,\n            RolTable.c.es_activo\n        )\n        .select_from(\n            UsuarioRolTable.join(RolTable, UsuarioRolTable.c.rol_id == RolTable.c.rol_id)",
    "type": "sql_string"
  },
  {
    "file": "app\\infrastructure\\database\\query_optimizer.py",
    "line": 263,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "    query = (\n        select(\n            UsuarioRolTable.c.usuario_id,\n            RolTable.c.rol_id,\n            RolTable.c.nombre,\n            RolTable.c.descripcion,\n            RolTable.c.nivel_acceso,\n            RolTable.c.codigo_rol,\n            RolTable.c.es_activo\n        )\n        .select_from(\n            UsuarioRolTable.join(RolTable, UsuarioRolTable.c.rol_id == RolTable.c.rol_id)",
    "type": "sql_string"
  },
  {
    "file": "app\\infrastructure\\database\\sql_constants.py",
    "line": 8,
    "issue": "Query SQL directa toca tabla auth_audit_log sin cliente_id visible",
    "severity": "high",
    "tabla": "auth_audit_log",
    "context": "- GET_USER_ACCESS_LEVEL_INFO_COMPLETE → queries.auth.auth_queries\n- SELECT_USUARIOS_PAGINATED → queries.users.user_queries\n- SELECT_ROLES_PAGINATED → queries.rbac.rbac_queries\n- GET_AREAS_PAGINATED_QUERY → queries.menus.menu_queries\n- INSERT_AUTH_AUDIT_LOG → queries.audit.audit_queries\n- ... (ver docs/MIGRACION_QUERIES.md para mapeo completo)\n\nEste archivo será eliminado en FASE 3 después de migración completa.\n\nConstantes SQL para queries comunes.\n\nFASE 4B: Modulo centralizado para constantes S",
    "type": "sql_string"
  },
  {
    "file": "app\\infrastructure\\database\\sql_constants.py",
    "line": 8,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "- GET_USER_ACCESS_LEVEL_INFO_COMPLETE → queries.auth.auth_queries\n- SELECT_USUARIOS_PAGINATED → queries.users.user_queries\n- SELECT_ROLES_PAGINATED → queries.rbac.rbac_queries\n- GET_AREAS_PAGINATED_QUERY → queries.menus.menu_queries\n- INSERT_AUTH_AUDIT_LOG → queries.audit.audit_queries\n- ... (ver docs/MIGRACION_QUERIES.md para mapeo completo)\n\nEste archivo será eliminado en FASE 3 después de migración completa.\n\nConstantes SQL para queries comunes.\n\nFASE 4B: Modulo centralizado para constantes S",
    "type": "sql_string"
  },
  {
    "file": "app\\infrastructure\\database\\sql_constants.py",
    "line": 8,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "- GET_USER_ACCESS_LEVEL_INFO_COMPLETE → queries.auth.auth_queries\n- SELECT_USUARIOS_PAGINATED → queries.users.user_queries\n- SELECT_ROLES_PAGINATED → queries.rbac.rbac_queries\n- GET_AREAS_PAGINATED_QUERY → queries.menus.menu_queries\n- INSERT_AUTH_AUDIT_LOG → queries.audit.audit_queries\n- ... (ver docs/MIGRACION_QUERIES.md para mapeo completo)\n\nEste archivo será eliminado en FASE 3 después de migración completa.\n\nConstantes SQL para queries comunes.\n\nFASE 4B: Modulo centralizado para constantes S",
    "type": "sql_string"
  },
  {
    "file": "app\\infrastructure\\database\\sql_constants.py",
    "line": 9,
    "issue": "Query SQL directa toca tabla auth_audit_log sin cliente_id visible",
    "severity": "high",
    "tabla": "auth_audit_log",
    "context": "- SELECT_USUARIOS_PAGINATED → queries.users.user_queries\n- SELECT_ROLES_PAGINATED → queries.rbac.rbac_queries\n- GET_AREAS_PAGINATED_QUERY → queries.menus.menu_queries\n- INSERT_AUTH_AUDIT_LOG → queries.audit.audit_queries\n- ... (ver docs/MIGRACION_QUERIES.md para mapeo completo)\n\nEste archivo será eliminado en FASE 3 después de migración completa.\n\nConstantes SQL para queries comunes.\n\nFASE 4B: Modulo centralizado para constantes SQL.\nEste modulo contiene todas las queries SQL como strings que se",
    "type": "sql_string"
  },
  {
    "file": "app\\infrastructure\\database\\sql_constants.py",
    "line": 9,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "- SELECT_USUARIOS_PAGINATED → queries.users.user_queries\n- SELECT_ROLES_PAGINATED → queries.rbac.rbac_queries\n- GET_AREAS_PAGINATED_QUERY → queries.menus.menu_queries\n- INSERT_AUTH_AUDIT_LOG → queries.audit.audit_queries\n- ... (ver docs/MIGRACION_QUERIES.md para mapeo completo)\n\nEste archivo será eliminado en FASE 3 después de migración completa.\n\nConstantes SQL para queries comunes.\n\nFASE 4B: Modulo centralizado para constantes SQL.\nEste modulo contiene todas las queries SQL como strings que se",
    "type": "sql_string"
  },
  {
    "file": "app\\infrastructure\\database\\sql_constants.py",
    "line": 9,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "- SELECT_USUARIOS_PAGINATED → queries.users.user_queries\n- SELECT_ROLES_PAGINATED → queries.rbac.rbac_queries\n- GET_AREAS_PAGINATED_QUERY → queries.menus.menu_queries\n- INSERT_AUTH_AUDIT_LOG → queries.audit.audit_queries\n- ... (ver docs/MIGRACION_QUERIES.md para mapeo completo)\n\nEste archivo será eliminado en FASE 3 después de migración completa.\n\nConstantes SQL para queries comunes.\n\nFASE 4B: Modulo centralizado para constantes SQL.\nEste modulo contiene todas las queries SQL como strings que se",
    "type": "sql_string"
  },
  {
    "file": "app\\infrastructure\\database\\sql_constants.py",
    "line": 11,
    "issue": "Query SQL directa toca tabla auth_audit_log sin cliente_id visible",
    "severity": "high",
    "tabla": "auth_audit_log",
    "context": "- GET_AREAS_PAGINATED_QUERY → queries.menus.menu_queries\n- INSERT_AUTH_AUDIT_LOG → queries.audit.audit_queries\n- ... (ver docs/MIGRACION_QUERIES.md para mapeo completo)\n\nEste archivo será eliminado en FASE 3 después de migración completa.\n\nConstantes SQL para queries comunes.\n\nFASE 4B: Modulo centralizado para constantes SQL.\nEste modulo contiene todas las queries SQL como strings que se usan en el sistema.\nLas queries deben usarse con text().bindparams() para seguridad y validacion de tenant.\n\"",
    "type": "sql_string"
  },
  {
    "file": "app\\infrastructure\\database\\sql_constants.py",
    "line": 56,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "from app.infrastructure.database.queries.users import (\n    SELECT_USUARIOS_PAGINATED,\n    COUNT_USUARIOS_PAGINATED,\n    SELECT_USUARIOS_PAGINATED_MULTI_DB,\n    COUNT_USUARIOS_PAGINATED_MULTI_DB,\n    GET_USER_COMPLETE_OPTIMIZED_JSON,\n    GET_USER_COMPLETE_OPTIMIZED_XML,\n)\n\n# ============================================\n# ✅ FASE 2: RE-EXPORTS DESDE queries.rbac (COMPATIBILIDAD)\n# ============================================",
    "type": "sql_string"
  },
  {
    "file": "app\\infrastructure\\database\\sql_constants.py",
    "line": 58,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "    COUNT_USUARIOS_PAGINATED,\n    SELECT_USUARIOS_PAGINATED_MULTI_DB,\n    COUNT_USUARIOS_PAGINATED_MULTI_DB,\n    GET_USER_COMPLETE_OPTIMIZED_JSON,\n    GET_USER_COMPLETE_OPTIMIZED_XML,\n)\n\n# ============================================\n# ✅ FASE 2: RE-EXPORTS DESDE queries.rbac (COMPATIBILIDAD)\n# ============================================\n\nfrom app.infrastructure.database.queries.rbac import (",
    "type": "sql_string"
  },
  {
    "file": "app\\infrastructure\\database\\sql_constants.py",
    "line": 69,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "from app.infrastructure.database.queries.rbac import (\n    SELECT_ROLES_PAGINATED,\n    COUNT_ROLES_PAGINATED,\n    SELECT_PERMISOS_POR_ROL,\n    DEACTIVATE_ROL,\n    REACTIVATE_ROL,\n    DELETE_PERMISOS_POR_ROL,\n    INSERT_PERMISO_ROL,\n)\n\n# ============================================\n# ✅ FASE 2: RE-EXPORTS DESDE queries.auth (REFRESH TOKENS)",
    "type": "sql_string"
  },
  {
    "file": "app\\infrastructure\\database\\sql_constants.py",
    "line": 71,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "    COUNT_ROLES_PAGINATED,\n    SELECT_PERMISOS_POR_ROL,\n    DEACTIVATE_ROL,\n    REACTIVATE_ROL,\n    DELETE_PERMISOS_POR_ROL,\n    INSERT_PERMISO_ROL,\n)\n\n# ============================================\n# ✅ FASE 2: RE-EXPORTS DESDE queries.auth (REFRESH TOKENS)\n# ============================================\n",
    "type": "sql_string"
  },
  {
    "file": "app\\infrastructure\\database\\sql_constants.py",
    "line": 74,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "    REACTIVATE_ROL,\n    DELETE_PERMISOS_POR_ROL,\n    INSERT_PERMISO_ROL,\n)\n\n# ============================================\n# ✅ FASE 2: RE-EXPORTS DESDE queries.auth (REFRESH TOKENS)\n# ============================================\n\nfrom app.infrastructure.database.queries.auth import (\n    INSERT_REFRESH_TOKEN,\n    GET_REFRESH_TOKEN_BY_HASH,",
    "type": "sql_string"
  },
  {
    "file": "app\\infrastructure\\database\\sql_constants.py",
    "line": 75,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "    DELETE_PERMISOS_POR_ROL,\n    INSERT_PERMISO_ROL,\n)\n\n# ============================================\n# ✅ FASE 2: RE-EXPORTS DESDE queries.auth (REFRESH TOKENS)\n# ============================================\n\nfrom app.infrastructure.database.queries.auth import (\n    INSERT_REFRESH_TOKEN,\n    GET_REFRESH_TOKEN_BY_HASH,\n    REVOKE_REFRESH_TOKEN,",
    "type": "sql_string"
  },
  {
    "file": "app\\infrastructure\\database\\sql_constants.py",
    "line": 99,
    "issue": "Query SQL directa toca tabla auth_audit_log sin cliente_id visible",
    "severity": "high",
    "tabla": "auth_audit_log",
    "context": "from app.infrastructure.database.queries.audit import (\n    INSERT_AUTH_AUDIT_LOG,\n    INSERT_LOG_SINCRONIZACION_USUARIO,\n)\n\n# ============================================\n# ✅ FASE 2: RE-EXPORTS DESDE queries.menus (COMPATIBILIDAD)\n# ============================================\n\nfrom app.infrastructure.database.queries.menus import (\n    GET_AREAS_PAGINATED_QUERY,\n    COUNT_AREAS_QUERY,",
    "type": "sql_string"
  },
  {
    "file": "app\\infrastructure\\database\\sql_constants.py",
    "line": 99,
    "issue": "Query SQL directa toca tabla log_sincronizacion_usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "log_sincronizacion_usuario",
    "context": "from app.infrastructure.database.queries.audit import (\n    INSERT_AUTH_AUDIT_LOG,\n    INSERT_LOG_SINCRONIZACION_USUARIO,\n)\n\n# ============================================\n# ✅ FASE 2: RE-EXPORTS DESDE queries.menus (COMPATIBILIDAD)\n# ============================================\n\nfrom app.infrastructure.database.queries.menus import (\n    GET_AREAS_PAGINATED_QUERY,\n    COUNT_AREAS_QUERY,",
    "type": "sql_string"
  },
  {
    "file": "app\\infrastructure\\database\\sql_constants.py",
    "line": 99,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "from app.infrastructure.database.queries.audit import (\n    INSERT_AUTH_AUDIT_LOG,\n    INSERT_LOG_SINCRONIZACION_USUARIO,\n)\n\n# ============================================\n# ✅ FASE 2: RE-EXPORTS DESDE queries.menus (COMPATIBILIDAD)\n# ============================================\n\nfrom app.infrastructure.database.queries.menus import (\n    GET_AREAS_PAGINATED_QUERY,\n    COUNT_AREAS_QUERY,",
    "type": "sql_string"
  },
  {
    "file": "app\\infrastructure\\database\\sql_constants.py",
    "line": 100,
    "issue": "Query SQL directa toca tabla auth_audit_log sin cliente_id visible",
    "severity": "high",
    "tabla": "auth_audit_log",
    "context": "    INSERT_AUTH_AUDIT_LOG,\n    INSERT_LOG_SINCRONIZACION_USUARIO,\n)\n\n# ============================================\n# ✅ FASE 2: RE-EXPORTS DESDE queries.menus (COMPATIBILIDAD)\n# ============================================\n\nfrom app.infrastructure.database.queries.menus import (\n    GET_AREAS_PAGINATED_QUERY,\n    COUNT_AREAS_QUERY,\n    GET_AREA_BY_ID_QUERY,",
    "type": "sql_string"
  },
  {
    "file": "app\\infrastructure\\database\\sql_constants.py",
    "line": 100,
    "issue": "Query SQL directa toca tabla log_sincronizacion_usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "log_sincronizacion_usuario",
    "context": "    INSERT_AUTH_AUDIT_LOG,\n    INSERT_LOG_SINCRONIZACION_USUARIO,\n)\n\n# ============================================\n# ✅ FASE 2: RE-EXPORTS DESDE queries.menus (COMPATIBILIDAD)\n# ============================================\n\nfrom app.infrastructure.database.queries.menus import (\n    GET_AREAS_PAGINATED_QUERY,\n    COUNT_AREAS_QUERY,\n    GET_AREA_BY_ID_QUERY,",
    "type": "sql_string"
  },
  {
    "file": "app\\infrastructure\\database\\sql_constants.py",
    "line": 100,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "    INSERT_AUTH_AUDIT_LOG,\n    INSERT_LOG_SINCRONIZACION_USUARIO,\n)\n\n# ============================================\n# ✅ FASE 2: RE-EXPORTS DESDE queries.menus (COMPATIBILIDAD)\n# ============================================\n\nfrom app.infrastructure.database.queries.menus import (\n    GET_AREAS_PAGINATED_QUERY,\n    COUNT_AREAS_QUERY,\n    GET_AREA_BY_ID_QUERY,",
    "type": "sql_string"
  },
  {
    "file": "app\\infrastructure\\database\\tables.py",
    "line": 13,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "    \n    query = select(UsuarioTable).where(UsuarioTable.c.nombre_usuario == username)\n    result = await execute_query(query)\n\"\"\"\n\nfrom sqlalchemy import (\n    Table, Column, Integer, String, Boolean, DateTime, Date, \n    ForeignKey, Text, Index, UniqueConstraint, CheckConstraint,\n    MetaData, Numeric\n)\nfrom sqlalchemy.dialects.mssql import UNIQUEIDENTIFIER\nfrom sqlalchemy.sql import func",
    "type": "sql_string"
  },
  {
    "file": "app\\infrastructure\\database\\tables.py",
    "line": 231,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "    Column('rol_id', UNIQUEIDENTIFIER, ForeignKey('rol.rol_id', ondelete='CASCADE'), nullable=False),\n    Column('menu_id', UNIQUEIDENTIFIER, ForeignKey('modulo_menu.menu_id', ondelete='CASCADE'), nullable=False),\n    \n    # Permisos granulares\n    Column('puede_ver', Boolean, nullable=False, server_default='1'),\n    Column('puede_crear', Boolean, nullable=True, server_default='0'),\n    Column('puede_editar', Boolean, nullable=True, server_default='0'),\n    Column('puede_eliminar', Boolean, null",
    "type": "sql_string"
  },
  {
    "file": "app\\infrastructure\\database\\tables_modulos.py",
    "line": 196,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "    Column('plantilla_id', UNIQUEIDENTIFIER, primary_key=True),\n    Column('modulo_id', UNIQUEIDENTIFIER, ForeignKey('modulo.modulo_id', ondelete='CASCADE'), nullable=False),\n    \n    # Definición del rol\n    Column('nombre_rol', String(50), nullable=False),\n    Column('descripcion', String(255), nullable=True),\n    Column('nivel_acceso', Integer, nullable=True, server_default='1'),\n    \n    # Permisos por defecto\n    Column('permisos_json', Text, nullable=True),  # JSON\n    \n    # Control",
    "type": "sql_string"
  },
  {
    "file": "app\\infrastructure\\database\\queries\\__init__.py",
    "line": 37,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "    REVOKE_ALL_USER_TOKENS,\n    DELETE_EXPIRED_TOKENS,\n    GET_ACTIVE_SESSIONS_BY_USER,\n    GET_ALL_ACTIVE_SESSIONS,\n    REVOKE_REFRESH_TOKEN_BY_ID,\n)\n\nfrom .users import (\n    SELECT_USUARIOS_PAGINATED,\n    COUNT_USUARIOS_PAGINATED,\n    SELECT_USUARIOS_PAGINATED_MULTI_DB,\n    COUNT_USUARIOS_PAGINATED_MULTI_DB,",
    "type": "sql_string"
  },
  {
    "file": "app\\infrastructure\\database\\queries\\__init__.py",
    "line": 44,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "from .users import (\n    SELECT_USUARIOS_PAGINATED,\n    COUNT_USUARIOS_PAGINATED,\n    SELECT_USUARIOS_PAGINATED_MULTI_DB,\n    COUNT_USUARIOS_PAGINATED_MULTI_DB,\n    GET_USER_COMPLETE_OPTIMIZED_JSON,\n    GET_USER_COMPLETE_OPTIMIZED_XML,\n)\n\nfrom .rbac import (\n    SELECT_ROLES_PAGINATED,\n    COUNT_ROLES_PAGINATED,",
    "type": "sql_string"
  },
  {
    "file": "app\\infrastructure\\database\\queries\\__init__.py",
    "line": 44,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "from .users import (\n    SELECT_USUARIOS_PAGINATED,\n    COUNT_USUARIOS_PAGINATED,\n    SELECT_USUARIOS_PAGINATED_MULTI_DB,\n    COUNT_USUARIOS_PAGINATED_MULTI_DB,\n    GET_USER_COMPLETE_OPTIMIZED_JSON,\n    GET_USER_COMPLETE_OPTIMIZED_XML,\n)\n\nfrom .rbac import (\n    SELECT_ROLES_PAGINATED,\n    COUNT_ROLES_PAGINATED,",
    "type": "sql_string"
  },
  {
    "file": "app\\infrastructure\\database\\queries\\__init__.py",
    "line": 46,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "    COUNT_USUARIOS_PAGINATED,\n    SELECT_USUARIOS_PAGINATED_MULTI_DB,\n    COUNT_USUARIOS_PAGINATED_MULTI_DB,\n    GET_USER_COMPLETE_OPTIMIZED_JSON,\n    GET_USER_COMPLETE_OPTIMIZED_XML,\n)\n\nfrom .rbac import (\n    SELECT_ROLES_PAGINATED,\n    COUNT_ROLES_PAGINATED,\n    SELECT_PERMISOS_POR_ROL,\n    DEACTIVATE_ROL,",
    "type": "sql_string"
  },
  {
    "file": "app\\infrastructure\\database\\queries\\__init__.py",
    "line": 46,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "    COUNT_USUARIOS_PAGINATED,\n    SELECT_USUARIOS_PAGINATED_MULTI_DB,\n    COUNT_USUARIOS_PAGINATED_MULTI_DB,\n    GET_USER_COMPLETE_OPTIMIZED_JSON,\n    GET_USER_COMPLETE_OPTIMIZED_XML,\n)\n\nfrom .rbac import (\n    SELECT_ROLES_PAGINATED,\n    COUNT_ROLES_PAGINATED,\n    SELECT_PERMISOS_POR_ROL,\n    DEACTIVATE_ROL,",
    "type": "sql_string"
  },
  {
    "file": "app\\infrastructure\\database\\queries\\__init__.py",
    "line": 53,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "from .rbac import (\n    SELECT_ROLES_PAGINATED,\n    COUNT_ROLES_PAGINATED,\n    SELECT_PERMISOS_POR_ROL,\n    DEACTIVATE_ROL,\n    REACTIVATE_ROL,\n    DELETE_PERMISOS_POR_ROL,\n    INSERT_PERMISO_ROL,\n)\n\nfrom .menus import (\n    GET_AREAS_PAGINATED_QUERY,",
    "type": "sql_string"
  },
  {
    "file": "app\\infrastructure\\database\\queries\\__init__.py",
    "line": 55,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "    COUNT_ROLES_PAGINATED,\n    SELECT_PERMISOS_POR_ROL,\n    DEACTIVATE_ROL,\n    REACTIVATE_ROL,\n    DELETE_PERMISOS_POR_ROL,\n    INSERT_PERMISO_ROL,\n)\n\nfrom .menus import (\n    GET_AREAS_PAGINATED_QUERY,\n    COUNT_AREAS_QUERY,\n    GET_AREA_BY_ID_QUERY,",
    "type": "sql_string"
  },
  {
    "file": "app\\infrastructure\\database\\queries\\__init__.py",
    "line": 58,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "    REACTIVATE_ROL,\n    DELETE_PERMISOS_POR_ROL,\n    INSERT_PERMISO_ROL,\n)\n\nfrom .menus import (\n    GET_AREAS_PAGINATED_QUERY,\n    COUNT_AREAS_QUERY,\n    GET_AREA_BY_ID_QUERY,\n    CHECK_AREA_EXISTS_BY_NAME_QUERY,\n    CREATE_AREA_QUERY,\n    UPDATE_AREA_BASE_QUERY_TEMPLATE,",
    "type": "sql_string"
  },
  {
    "file": "app\\infrastructure\\database\\queries\\__init__.py",
    "line": 59,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "    DELETE_PERMISOS_POR_ROL,\n    INSERT_PERMISO_ROL,\n)\n\nfrom .menus import (\n    GET_AREAS_PAGINATED_QUERY,\n    COUNT_AREAS_QUERY,\n    GET_AREA_BY_ID_QUERY,\n    CHECK_AREA_EXISTS_BY_NAME_QUERY,\n    CREATE_AREA_QUERY,\n    UPDATE_AREA_BASE_QUERY_TEMPLATE,\n    TOGGLE_AREA_STATUS_QUERY,",
    "type": "sql_string"
  },
  {
    "file": "app\\infrastructure\\database\\queries\\__init__.py",
    "line": 85,
    "issue": "Query SQL directa toca tabla auth_audit_log sin cliente_id visible",
    "severity": "high",
    "tabla": "auth_audit_log",
    "context": "from .audit import (\n    INSERT_AUTH_AUDIT_LOG,\n    INSERT_LOG_SINCRONIZACION_USUARIO,\n)\n\n__all__ = [\n    # Auth\n    \"GET_USER_MAX_ACCESS_LEVEL\",\n    \"IS_USER_SUPER_ADMIN\",\n    \"GET_USER_ACCESS_LEVEL_INFO_COMPLETE\",\n    \"INSERT_REFRESH_TOKEN\",\n    \"GET_REFRESH_TOKEN_BY_HASH\",",
    "type": "sql_string"
  },
  {
    "file": "app\\infrastructure\\database\\queries\\__init__.py",
    "line": 85,
    "issue": "Query SQL directa toca tabla log_sincronizacion_usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "log_sincronizacion_usuario",
    "context": "from .audit import (\n    INSERT_AUTH_AUDIT_LOG,\n    INSERT_LOG_SINCRONIZACION_USUARIO,\n)\n\n__all__ = [\n    # Auth\n    \"GET_USER_MAX_ACCESS_LEVEL\",\n    \"IS_USER_SUPER_ADMIN\",\n    \"GET_USER_ACCESS_LEVEL_INFO_COMPLETE\",\n    \"INSERT_REFRESH_TOKEN\",\n    \"GET_REFRESH_TOKEN_BY_HASH\",",
    "type": "sql_string"
  },
  {
    "file": "app\\infrastructure\\database\\queries\\__init__.py",
    "line": 85,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "from .audit import (\n    INSERT_AUTH_AUDIT_LOG,\n    INSERT_LOG_SINCRONIZACION_USUARIO,\n)\n\n__all__ = [\n    # Auth\n    \"GET_USER_MAX_ACCESS_LEVEL\",\n    \"IS_USER_SUPER_ADMIN\",\n    \"GET_USER_ACCESS_LEVEL_INFO_COMPLETE\",\n    \"INSERT_REFRESH_TOKEN\",\n    \"GET_REFRESH_TOKEN_BY_HASH\",",
    "type": "sql_string"
  },
  {
    "file": "app\\infrastructure\\database\\queries\\__init__.py",
    "line": 86,
    "issue": "Query SQL directa toca tabla auth_audit_log sin cliente_id visible",
    "severity": "high",
    "tabla": "auth_audit_log",
    "context": "    INSERT_AUTH_AUDIT_LOG,\n    INSERT_LOG_SINCRONIZACION_USUARIO,\n)\n\n__all__ = [\n    # Auth\n    \"GET_USER_MAX_ACCESS_LEVEL\",\n    \"IS_USER_SUPER_ADMIN\",\n    \"GET_USER_ACCESS_LEVEL_INFO_COMPLETE\",\n    \"INSERT_REFRESH_TOKEN\",\n    \"GET_REFRESH_TOKEN_BY_HASH\",\n    \"REVOKE_REFRESH_TOKEN\",",
    "type": "sql_string"
  },
  {
    "file": "app\\infrastructure\\database\\queries\\__init__.py",
    "line": 86,
    "issue": "Query SQL directa toca tabla log_sincronizacion_usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "log_sincronizacion_usuario",
    "context": "    INSERT_AUTH_AUDIT_LOG,\n    INSERT_LOG_SINCRONIZACION_USUARIO,\n)\n\n__all__ = [\n    # Auth\n    \"GET_USER_MAX_ACCESS_LEVEL\",\n    \"IS_USER_SUPER_ADMIN\",\n    \"GET_USER_ACCESS_LEVEL_INFO_COMPLETE\",\n    \"INSERT_REFRESH_TOKEN\",\n    \"GET_REFRESH_TOKEN_BY_HASH\",\n    \"REVOKE_REFRESH_TOKEN\",",
    "type": "sql_string"
  },
  {
    "file": "app\\infrastructure\\database\\queries\\__init__.py",
    "line": 86,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "    INSERT_AUTH_AUDIT_LOG,\n    INSERT_LOG_SINCRONIZACION_USUARIO,\n)\n\n__all__ = [\n    # Auth\n    \"GET_USER_MAX_ACCESS_LEVEL\",\n    \"IS_USER_SUPER_ADMIN\",\n    \"GET_USER_ACCESS_LEVEL_INFO_COMPLETE\",\n    \"INSERT_REFRESH_TOKEN\",\n    \"GET_REFRESH_TOKEN_BY_HASH\",\n    \"REVOKE_REFRESH_TOKEN\",",
    "type": "sql_string"
  },
  {
    "file": "app\\infrastructure\\database\\queries\\__init__.py",
    "line": 94,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "    \"GET_USER_ACCESS_LEVEL_INFO_COMPLETE\",\n    \"INSERT_REFRESH_TOKEN\",\n    \"GET_REFRESH_TOKEN_BY_HASH\",\n    \"REVOKE_REFRESH_TOKEN\",\n    \"REVOKE_REFRESH_TOKEN_BY_USER\",\n    \"REVOKE_ALL_USER_TOKENS\",\n    \"DELETE_EXPIRED_TOKENS\",\n    \"GET_ACTIVE_SESSIONS_BY_USER\",\n    \"GET_ALL_ACTIVE_SESSIONS\",\n    \"REVOKE_REFRESH_TOKEN_BY_ID\",\n    # Users\n    \"SELECT_USUARIOS_PAGINATED\",",
    "type": "sql_string"
  },
  {
    "file": "app\\infrastructure\\database\\queries\\__init__.py",
    "line": 99,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "    \"REVOKE_ALL_USER_TOKENS\",\n    \"DELETE_EXPIRED_TOKENS\",\n    \"GET_ACTIVE_SESSIONS_BY_USER\",\n    \"GET_ALL_ACTIVE_SESSIONS\",\n    \"REVOKE_REFRESH_TOKEN_BY_ID\",\n    # Users\n    \"SELECT_USUARIOS_PAGINATED\",\n    \"COUNT_USUARIOS_PAGINATED\",\n    \"SELECT_USUARIOS_PAGINATED_MULTI_DB\",\n    \"COUNT_USUARIOS_PAGINATED_MULTI_DB\",\n    \"GET_USER_COMPLETE_OPTIMIZED_JSON\",\n    \"GET_USER_COMPLETE_OPTIMIZED_XML\",",
    "type": "sql_string"
  },
  {
    "file": "app\\infrastructure\\database\\queries\\__init__.py",
    "line": 104,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "    # Users\n    \"SELECT_USUARIOS_PAGINATED\",\n    \"COUNT_USUARIOS_PAGINATED\",\n    \"SELECT_USUARIOS_PAGINATED_MULTI_DB\",\n    \"COUNT_USUARIOS_PAGINATED_MULTI_DB\",\n    \"GET_USER_COMPLETE_OPTIMIZED_JSON\",\n    \"GET_USER_COMPLETE_OPTIMIZED_XML\",\n    # RBAC\n    \"SELECT_ROLES_PAGINATED\",\n    \"COUNT_ROLES_PAGINATED\",\n    \"SELECT_PERMISOS_POR_ROL\",\n    \"DEACTIVATE_ROL\",",
    "type": "sql_string"
  },
  {
    "file": "app\\infrastructure\\database\\queries\\__init__.py",
    "line": 104,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "    # Users\n    \"SELECT_USUARIOS_PAGINATED\",\n    \"COUNT_USUARIOS_PAGINATED\",\n    \"SELECT_USUARIOS_PAGINATED_MULTI_DB\",\n    \"COUNT_USUARIOS_PAGINATED_MULTI_DB\",\n    \"GET_USER_COMPLETE_OPTIMIZED_JSON\",\n    \"GET_USER_COMPLETE_OPTIMIZED_XML\",\n    # RBAC\n    \"SELECT_ROLES_PAGINATED\",\n    \"COUNT_ROLES_PAGINATED\",\n    \"SELECT_PERMISOS_POR_ROL\",\n    \"DEACTIVATE_ROL\",",
    "type": "sql_string"
  },
  {
    "file": "app\\infrastructure\\database\\queries\\__init__.py",
    "line": 106,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "    \"COUNT_USUARIOS_PAGINATED\",\n    \"SELECT_USUARIOS_PAGINATED_MULTI_DB\",\n    \"COUNT_USUARIOS_PAGINATED_MULTI_DB\",\n    \"GET_USER_COMPLETE_OPTIMIZED_JSON\",\n    \"GET_USER_COMPLETE_OPTIMIZED_XML\",\n    # RBAC\n    \"SELECT_ROLES_PAGINATED\",\n    \"COUNT_ROLES_PAGINATED\",\n    \"SELECT_PERMISOS_POR_ROL\",\n    \"DEACTIVATE_ROL\",\n    \"REACTIVATE_ROL\",\n    \"DELETE_PERMISOS_POR_ROL\",",
    "type": "sql_string"
  },
  {
    "file": "app\\infrastructure\\database\\queries\\__init__.py",
    "line": 106,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "    \"COUNT_USUARIOS_PAGINATED\",\n    \"SELECT_USUARIOS_PAGINATED_MULTI_DB\",\n    \"COUNT_USUARIOS_PAGINATED_MULTI_DB\",\n    \"GET_USER_COMPLETE_OPTIMIZED_JSON\",\n    \"GET_USER_COMPLETE_OPTIMIZED_XML\",\n    # RBAC\n    \"SELECT_ROLES_PAGINATED\",\n    \"COUNT_ROLES_PAGINATED\",\n    \"SELECT_PERMISOS_POR_ROL\",\n    \"DEACTIVATE_ROL\",\n    \"REACTIVATE_ROL\",\n    \"DELETE_PERMISOS_POR_ROL\",",
    "type": "sql_string"
  },
  {
    "file": "app\\infrastructure\\database\\queries\\__init__.py",
    "line": 111,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "    # RBAC\n    \"SELECT_ROLES_PAGINATED\",\n    \"COUNT_ROLES_PAGINATED\",\n    \"SELECT_PERMISOS_POR_ROL\",\n    \"DEACTIVATE_ROL\",\n    \"REACTIVATE_ROL\",\n    \"DELETE_PERMISOS_POR_ROL\",\n    \"INSERT_PERMISO_ROL\",\n    # Menus\n    \"GET_AREAS_PAGINATED_QUERY\",\n    \"COUNT_AREAS_QUERY\",\n    \"GET_AREA_BY_ID_QUERY\",",
    "type": "sql_string"
  },
  {
    "file": "app\\infrastructure\\database\\queries\\__init__.py",
    "line": 113,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "    \"COUNT_ROLES_PAGINATED\",\n    \"SELECT_PERMISOS_POR_ROL\",\n    \"DEACTIVATE_ROL\",\n    \"REACTIVATE_ROL\",\n    \"DELETE_PERMISOS_POR_ROL\",\n    \"INSERT_PERMISO_ROL\",\n    # Menus\n    \"GET_AREAS_PAGINATED_QUERY\",\n    \"COUNT_AREAS_QUERY\",\n    \"GET_AREA_BY_ID_QUERY\",\n    \"CHECK_AREA_EXISTS_BY_NAME_QUERY\",\n    \"CREATE_AREA_QUERY\",",
    "type": "sql_string"
  },
  {
    "file": "app\\infrastructure\\database\\queries\\__init__.py",
    "line": 116,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "    \"REACTIVATE_ROL\",\n    \"DELETE_PERMISOS_POR_ROL\",\n    \"INSERT_PERMISO_ROL\",\n    # Menus\n    \"GET_AREAS_PAGINATED_QUERY\",\n    \"COUNT_AREAS_QUERY\",\n    \"GET_AREA_BY_ID_QUERY\",\n    \"CHECK_AREA_EXISTS_BY_NAME_QUERY\",\n    \"CREATE_AREA_QUERY\",\n    \"UPDATE_AREA_BASE_QUERY_TEMPLATE\",\n    \"TOGGLE_AREA_STATUS_QUERY\",\n    \"GET_ACTIVE_AREAS_SIMPLE_LIST_QUERY\",",
    "type": "sql_string"
  },
  {
    "file": "app\\infrastructure\\database\\queries\\__init__.py",
    "line": 117,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "    \"DELETE_PERMISOS_POR_ROL\",\n    \"INSERT_PERMISO_ROL\",\n    # Menus\n    \"GET_AREAS_PAGINATED_QUERY\",\n    \"COUNT_AREAS_QUERY\",\n    \"GET_AREA_BY_ID_QUERY\",\n    \"CHECK_AREA_EXISTS_BY_NAME_QUERY\",\n    \"CREATE_AREA_QUERY\",\n    \"UPDATE_AREA_BASE_QUERY_TEMPLATE\",\n    \"TOGGLE_AREA_STATUS_QUERY\",\n    \"GET_ACTIVE_AREAS_SIMPLE_LIST_QUERY\",\n    \"INSERT_MENU\",",
    "type": "sql_string"
  },
  {
    "file": "app\\infrastructure\\database\\queries\\__init__.py",
    "line": 129,
    "issue": "Query SQL directa toca tabla auth_audit_log sin cliente_id visible",
    "severity": "high",
    "tabla": "auth_audit_log",
    "context": "    \"SELECT_MENU_BY_ID\",\n    \"UPDATE_MENU_TEMPLATE\",\n    \"DEACTIVATE_MENU\",\n    \"REACTIVATE_MENU\",\n    \"CHECK_MENU_EXISTS\",\n    \"CHECK_AREA_EXISTS\",\n    \"GET_MENUS_BY_AREA_FOR_TREE_QUERY\",\n    \"GET_MAX_ORDEN_FOR_SIBLINGS\",\n    \"GET_MAX_ORDEN_FOR_ROOT\",\n    \"GET_ALL_MENUS_ADMIN\",\n    # Audit\n    \"INSERT_AUTH_AUDIT_LOG\",",
    "type": "sql_string"
  },
  {
    "file": "app\\infrastructure\\database\\queries\\__init__.py",
    "line": 139,
    "issue": "Query SQL directa toca tabla auth_audit_log sin cliente_id visible",
    "severity": "high",
    "tabla": "auth_audit_log",
    "context": "    # Audit\n    \"INSERT_AUTH_AUDIT_LOG\",\n    \"INSERT_LOG_SINCRONIZACION_USUARIO\",\n]\n",
    "type": "sql_string"
  },
  {
    "file": "app\\infrastructure\\database\\queries\\__init__.py",
    "line": 139,
    "issue": "Query SQL directa toca tabla log_sincronizacion_usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "log_sincronizacion_usuario",
    "context": "    # Audit\n    \"INSERT_AUTH_AUDIT_LOG\",\n    \"INSERT_LOG_SINCRONIZACION_USUARIO\",\n]\n",
    "type": "sql_string"
  },
  {
    "file": "app\\infrastructure\\database\\queries\\__init__.py",
    "line": 139,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "    # Audit\n    \"INSERT_AUTH_AUDIT_LOG\",\n    \"INSERT_LOG_SINCRONIZACION_USUARIO\",\n]\n",
    "type": "sql_string"
  },
  {
    "file": "app\\infrastructure\\database\\queries\\__init__.py",
    "line": 140,
    "issue": "Query SQL directa toca tabla auth_audit_log sin cliente_id visible",
    "severity": "high",
    "tabla": "auth_audit_log",
    "context": "    \"INSERT_AUTH_AUDIT_LOG\",\n    \"INSERT_LOG_SINCRONIZACION_USUARIO\",\n]\n",
    "type": "sql_string"
  },
  {
    "file": "app\\infrastructure\\database\\queries\\__init__.py",
    "line": 140,
    "issue": "Query SQL directa toca tabla log_sincronizacion_usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "log_sincronizacion_usuario",
    "context": "    \"INSERT_AUTH_AUDIT_LOG\",\n    \"INSERT_LOG_SINCRONIZACION_USUARIO\",\n]\n",
    "type": "sql_string"
  },
  {
    "file": "app\\infrastructure\\database\\queries\\__init__.py",
    "line": 140,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "    \"INSERT_AUTH_AUDIT_LOG\",\n    \"INSERT_LOG_SINCRONIZACION_USUARIO\",\n]\n",
    "type": "sql_string"
  },
  {
    "file": "app\\infrastructure\\database\\queries\\audit\\audit_queries.py",
    "line": 47,
    "issue": "Query SQL directa toca tabla log_sincronizacion_usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "log_sincronizacion_usuario",
    "context": "\nINSERT_LOG_SINCRONIZACION_USUARIO = \"\"\"\nINSERT INTO log_sincronizacion_usuario (\n    cliente_origen_id,\n    cliente_destino_id,\n    usuario_id,\n    tipo_sincronizacion,\n    direccion,\n    operacion,\n    estado,\n    mensaje_error,\n    campos_sincronizados,",
    "type": "sql_string"
  },
  {
    "file": "app\\infrastructure\\database\\queries\\audit\\audit_queries.py",
    "line": 47,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "\nINSERT_LOG_SINCRONIZACION_USUARIO = \"\"\"\nINSERT INTO log_sincronizacion_usuario (\n    cliente_origen_id,\n    cliente_destino_id,\n    usuario_id,\n    tipo_sincronizacion,\n    direccion,\n    operacion,\n    estado,\n    mensaje_error,\n    campos_sincronizados,",
    "type": "sql_string"
  },
  {
    "file": "app\\infrastructure\\database\\queries\\audit\\audit_queries.py",
    "line": 48,
    "issue": "Query SQL directa toca tabla log_sincronizacion_usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "log_sincronizacion_usuario",
    "context": "INSERT_LOG_SINCRONIZACION_USUARIO = \"\"\"\nINSERT INTO log_sincronizacion_usuario (\n    cliente_origen_id,\n    cliente_destino_id,\n    usuario_id,\n    tipo_sincronizacion,\n    direccion,\n    operacion,\n    estado,\n    mensaje_error,\n    campos_sincronizados,\n    cambios_detectados,",
    "type": "sql_string"
  },
  {
    "file": "app\\infrastructure\\database\\queries\\audit\\audit_queries.py",
    "line": 48,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "INSERT_LOG_SINCRONIZACION_USUARIO = \"\"\"\nINSERT INTO log_sincronizacion_usuario (\n    cliente_origen_id,\n    cliente_destino_id,\n    usuario_id,\n    tipo_sincronizacion,\n    direccion,\n    operacion,\n    estado,\n    mensaje_error,\n    campos_sincronizados,\n    cambios_detectados,",
    "type": "sql_string"
  },
  {
    "file": "app\\infrastructure\\database\\queries\\audit\\audit_queries.py",
    "line": 65,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": ")\nOUTPUT INSERTED.log_id, INSERTED.fecha_sincronizacion\nVALUES (\n    :cliente_origen_id,\n    :cliente_destino_id,\n    :usuario_id,\n    :tipo_sincronizacion,\n    :direccion,\n    :operacion,\n    :estado,\n    :mensaje_error,\n    :campos_sincronizados,",
    "type": "sql_string"
  },
  {
    "file": "app\\infrastructure\\database\\queries\\audit\\audit_queries.py",
    "line": 86,
    "issue": "Query SQL directa toca tabla auth_audit_log sin cliente_id visible",
    "severity": "high",
    "tabla": "auth_audit_log",
    "context": "__all__ = [\n    \"INSERT_AUTH_AUDIT_LOG\",\n    \"INSERT_LOG_SINCRONIZACION_USUARIO\",\n]\n",
    "type": "sql_string"
  },
  {
    "file": "app\\infrastructure\\database\\queries\\audit\\audit_queries.py",
    "line": 86,
    "issue": "Query SQL directa toca tabla log_sincronizacion_usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "log_sincronizacion_usuario",
    "context": "__all__ = [\n    \"INSERT_AUTH_AUDIT_LOG\",\n    \"INSERT_LOG_SINCRONIZACION_USUARIO\",\n]\n",
    "type": "sql_string"
  },
  {
    "file": "app\\infrastructure\\database\\queries\\audit\\audit_queries.py",
    "line": 86,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "__all__ = [\n    \"INSERT_AUTH_AUDIT_LOG\",\n    \"INSERT_LOG_SINCRONIZACION_USUARIO\",\n]\n",
    "type": "sql_string"
  },
  {
    "file": "app\\infrastructure\\database\\queries\\audit\\audit_queries.py",
    "line": 87,
    "issue": "Query SQL directa toca tabla auth_audit_log sin cliente_id visible",
    "severity": "high",
    "tabla": "auth_audit_log",
    "context": "    \"INSERT_AUTH_AUDIT_LOG\",\n    \"INSERT_LOG_SINCRONIZACION_USUARIO\",\n]\n",
    "type": "sql_string"
  },
  {
    "file": "app\\infrastructure\\database\\queries\\audit\\audit_queries.py",
    "line": 87,
    "issue": "Query SQL directa toca tabla log_sincronizacion_usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "log_sincronizacion_usuario",
    "context": "    \"INSERT_AUTH_AUDIT_LOG\",\n    \"INSERT_LOG_SINCRONIZACION_USUARIO\",\n]\n",
    "type": "sql_string"
  },
  {
    "file": "app\\infrastructure\\database\\queries\\audit\\audit_queries.py",
    "line": 87,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "    \"INSERT_AUTH_AUDIT_LOG\",\n    \"INSERT_LOG_SINCRONIZACION_USUARIO\",\n]\n",
    "type": "sql_string"
  },
  {
    "file": "app\\infrastructure\\database\\queries\\audit\\__init__.py",
    "line": 13,
    "issue": "Query SQL directa toca tabla auth_audit_log sin cliente_id visible",
    "severity": "high",
    "tabla": "auth_audit_log",
    "context": "from .audit_queries import (\n    INSERT_AUTH_AUDIT_LOG,\n    INSERT_LOG_SINCRONIZACION_USUARIO,\n)\n\n__all__ = [\n    \"INSERT_AUTH_AUDIT_LOG\",\n    \"INSERT_LOG_SINCRONIZACION_USUARIO\",\n]\n",
    "type": "sql_string"
  },
  {
    "file": "app\\infrastructure\\database\\queries\\audit\\__init__.py",
    "line": 13,
    "issue": "Query SQL directa toca tabla log_sincronizacion_usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "log_sincronizacion_usuario",
    "context": "from .audit_queries import (\n    INSERT_AUTH_AUDIT_LOG,\n    INSERT_LOG_SINCRONIZACION_USUARIO,\n)\n\n__all__ = [\n    \"INSERT_AUTH_AUDIT_LOG\",\n    \"INSERT_LOG_SINCRONIZACION_USUARIO\",\n]\n",
    "type": "sql_string"
  },
  {
    "file": "app\\infrastructure\\database\\queries\\audit\\__init__.py",
    "line": 13,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "from .audit_queries import (\n    INSERT_AUTH_AUDIT_LOG,\n    INSERT_LOG_SINCRONIZACION_USUARIO,\n)\n\n__all__ = [\n    \"INSERT_AUTH_AUDIT_LOG\",\n    \"INSERT_LOG_SINCRONIZACION_USUARIO\",\n]\n",
    "type": "sql_string"
  },
  {
    "file": "app\\infrastructure\\database\\queries\\audit\\__init__.py",
    "line": 14,
    "issue": "Query SQL directa toca tabla auth_audit_log sin cliente_id visible",
    "severity": "high",
    "tabla": "auth_audit_log",
    "context": "    INSERT_AUTH_AUDIT_LOG,\n    INSERT_LOG_SINCRONIZACION_USUARIO,\n)\n\n__all__ = [\n    \"INSERT_AUTH_AUDIT_LOG\",\n    \"INSERT_LOG_SINCRONIZACION_USUARIO\",\n]\n",
    "type": "sql_string"
  },
  {
    "file": "app\\infrastructure\\database\\queries\\audit\\__init__.py",
    "line": 14,
    "issue": "Query SQL directa toca tabla log_sincronizacion_usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "log_sincronizacion_usuario",
    "context": "    INSERT_AUTH_AUDIT_LOG,\n    INSERT_LOG_SINCRONIZACION_USUARIO,\n)\n\n__all__ = [\n    \"INSERT_AUTH_AUDIT_LOG\",\n    \"INSERT_LOG_SINCRONIZACION_USUARIO\",\n]\n",
    "type": "sql_string"
  },
  {
    "file": "app\\infrastructure\\database\\queries\\audit\\__init__.py",
    "line": 14,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "    INSERT_AUTH_AUDIT_LOG,\n    INSERT_LOG_SINCRONIZACION_USUARIO,\n)\n\n__all__ = [\n    \"INSERT_AUTH_AUDIT_LOG\",\n    \"INSERT_LOG_SINCRONIZACION_USUARIO\",\n]\n",
    "type": "sql_string"
  },
  {
    "file": "app\\infrastructure\\database\\queries\\audit\\__init__.py",
    "line": 18,
    "issue": "Query SQL directa toca tabla auth_audit_log sin cliente_id visible",
    "severity": "high",
    "tabla": "auth_audit_log",
    "context": "__all__ = [\n    \"INSERT_AUTH_AUDIT_LOG\",\n    \"INSERT_LOG_SINCRONIZACION_USUARIO\",\n]\n",
    "type": "sql_string"
  },
  {
    "file": "app\\infrastructure\\database\\queries\\audit\\__init__.py",
    "line": 18,
    "issue": "Query SQL directa toca tabla log_sincronizacion_usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "log_sincronizacion_usuario",
    "context": "__all__ = [\n    \"INSERT_AUTH_AUDIT_LOG\",\n    \"INSERT_LOG_SINCRONIZACION_USUARIO\",\n]\n",
    "type": "sql_string"
  },
  {
    "file": "app\\infrastructure\\database\\queries\\audit\\__init__.py",
    "line": 18,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "__all__ = [\n    \"INSERT_AUTH_AUDIT_LOG\",\n    \"INSERT_LOG_SINCRONIZACION_USUARIO\",\n]\n",
    "type": "sql_string"
  },
  {
    "file": "app\\infrastructure\\database\\queries\\audit\\__init__.py",
    "line": 19,
    "issue": "Query SQL directa toca tabla auth_audit_log sin cliente_id visible",
    "severity": "high",
    "tabla": "auth_audit_log",
    "context": "    \"INSERT_AUTH_AUDIT_LOG\",\n    \"INSERT_LOG_SINCRONIZACION_USUARIO\",\n]\n",
    "type": "sql_string"
  },
  {
    "file": "app\\infrastructure\\database\\queries\\audit\\__init__.py",
    "line": 19,
    "issue": "Query SQL directa toca tabla log_sincronizacion_usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "log_sincronizacion_usuario",
    "context": "    \"INSERT_AUTH_AUDIT_LOG\",\n    \"INSERT_LOG_SINCRONIZACION_USUARIO\",\n]\n",
    "type": "sql_string"
  },
  {
    "file": "app\\infrastructure\\database\\queries\\audit\\__init__.py",
    "line": 19,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "    \"INSERT_AUTH_AUDIT_LOG\",\n    \"INSERT_LOG_SINCRONIZACION_USUARIO\",\n]\n",
    "type": "sql_string"
  },
  {
    "file": "app\\infrastructure\\database\\queries\\auth\\auth_queries.py",
    "line": 22,
    "issue": "Query con text() toca tabla rol (verificar uso de cliente_id)",
    "severity": "medium",
    "tabla": "rol",
    "context": "- Parámetros nombrados (:param) para seguridad\n- text().bindparams() para ejecución\n- Filtros de tenant automáticos\n\"\"\"\n\n# ============================================\n# QUERIES PARA SISTEMA DE NIVELES LBAC\n# ============================================\n\nGET_USER_MAX_ACCESS_LEVEL = \"\"\"\nSELECT ISNULL(MAX(r.nivel_acceso), 1) as max_level\nFROM usuario_rol ur\nINNER JOIN rol r ON ur.rol_id = r.rol_id\nWHERE ur.usuario_id = :usuario_id \n  AND ur.es_activo = 1\n  AND r.es_activo = 1\n  AND (r.cliente_id =",
    "type": "text() - tiene cliente_id"
  },
  {
    "file": "app\\infrastructure\\database\\queries\\auth\\auth_queries.py",
    "line": 22,
    "issue": "Query con text() toca tabla usuario (verificar uso de cliente_id)",
    "severity": "medium",
    "tabla": "usuario",
    "context": "- Parámetros nombrados (:param) para seguridad\n- text().bindparams() para ejecución\n- Filtros de tenant automáticos\n\"\"\"\n\n# ============================================\n# QUERIES PARA SISTEMA DE NIVELES LBAC\n# ============================================\n\nGET_USER_MAX_ACCESS_LEVEL = \"\"\"\nSELECT ISNULL(MAX(r.nivel_acceso), 1) as max_level\nFROM usuario_rol ur\nINNER JOIN rol r ON ur.rol_id = r.rol_id\nWHERE ur.usuario_id = :usuario_id \n  AND ur.es_activo = 1\n  AND r.es_activo = 1\n  AND (r.cliente_id =",
    "type": "text() - tiene cliente_id"
  },
  {
    "file": "app\\infrastructure\\database\\queries\\auth\\auth_queries.py",
    "line": 22,
    "issue": "Query con text() toca tabla usuario_rol (verificar uso de cliente_id)",
    "severity": "medium",
    "tabla": "usuario_rol",
    "context": "- Parámetros nombrados (:param) para seguridad\n- text().bindparams() para ejecución\n- Filtros de tenant automáticos\n\"\"\"\n\n# ============================================\n# QUERIES PARA SISTEMA DE NIVELES LBAC\n# ============================================\n\nGET_USER_MAX_ACCESS_LEVEL = \"\"\"\nSELECT ISNULL(MAX(r.nivel_acceso), 1) as max_level\nFROM usuario_rol ur\nINNER JOIN rol r ON ur.rol_id = r.rol_id\nWHERE ur.usuario_id = :usuario_id \n  AND ur.es_activo = 1\n  AND r.es_activo = 1\n  AND (r.cliente_id =",
    "type": "text() - tiene cliente_id"
  },
  {
    "file": "app\\infrastructure\\database\\queries\\auth\\auth_queries.py",
    "line": 41,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "IS_USER_SUPER_ADMIN = \"\"\"\nSELECT COUNT(*) as is_super_admin\nFROM usuario_rol ur\nINNER JOIN rol r ON ur.rol_id = r.rol_id\nWHERE ur.usuario_id = :usuario_id \n  AND ur.es_activo = 1\n  AND r.es_activo = 1\n  AND r.codigo_rol = 'SUPER_ADMIN'\n  AND r.nivel_acceso = 5\n\"\"\"\n\nGET_USER_ACCESS_LEVEL_INFO_COMPLETE = \"\"\"",
    "type": "sql_string"
  },
  {
    "file": "app\\infrastructure\\database\\queries\\auth\\auth_queries.py",
    "line": 41,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "IS_USER_SUPER_ADMIN = \"\"\"\nSELECT COUNT(*) as is_super_admin\nFROM usuario_rol ur\nINNER JOIN rol r ON ur.rol_id = r.rol_id\nWHERE ur.usuario_id = :usuario_id \n  AND ur.es_activo = 1\n  AND r.es_activo = 1\n  AND r.codigo_rol = 'SUPER_ADMIN'\n  AND r.nivel_acceso = 5\n\"\"\"\n\nGET_USER_ACCESS_LEVEL_INFO_COMPLETE = \"\"\"",
    "type": "sql_string"
  },
  {
    "file": "app\\infrastructure\\database\\queries\\auth\\auth_queries.py",
    "line": 41,
    "issue": "Query SQL directa toca tabla usuario_rol sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario_rol",
    "context": "IS_USER_SUPER_ADMIN = \"\"\"\nSELECT COUNT(*) as is_super_admin\nFROM usuario_rol ur\nINNER JOIN rol r ON ur.rol_id = r.rol_id\nWHERE ur.usuario_id = :usuario_id \n  AND ur.es_activo = 1\n  AND r.es_activo = 1\n  AND r.codigo_rol = 'SUPER_ADMIN'\n  AND r.nivel_acceso = 5\n\"\"\"\n\nGET_USER_ACCESS_LEVEL_INFO_COMPLETE = \"\"\"",
    "type": "sql_string"
  },
  {
    "file": "app\\infrastructure\\database\\queries\\rbac\\rbac_queries.py",
    "line": 7,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "QUERIES INCLUIDAS:\n- SELECT_ROLES_PAGINATED\n- COUNT_ROLES_PAGINATED\n- SELECT_PERMISOS_POR_ROL\n- DEACTIVATE_ROL\n- REACTIVATE_ROL\n- DELETE_PERMISOS_POR_ROL\n- INSERT_PERMISO_ROL\n\"\"\"\n\n# ============================================\n# QUERIES PARA ROLES (MULTI-TENANT)",
    "type": "sql_string"
  },
  {
    "file": "app\\infrastructure\\database\\queries\\rbac\\rbac_queries.py",
    "line": 9,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "- COUNT_ROLES_PAGINATED\n- SELECT_PERMISOS_POR_ROL\n- DEACTIVATE_ROL\n- REACTIVATE_ROL\n- DELETE_PERMISOS_POR_ROL\n- INSERT_PERMISO_ROL\n\"\"\"\n\n# ============================================\n# QUERIES PARA ROLES (MULTI-TENANT)\n# ============================================\n",
    "type": "sql_string"
  },
  {
    "file": "app\\infrastructure\\database\\queries\\rbac\\rbac_queries.py",
    "line": 12,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "- REACTIVATE_ROL\n- DELETE_PERMISOS_POR_ROL\n- INSERT_PERMISO_ROL\n\"\"\"\n\n# ============================================\n# QUERIES PARA ROLES (MULTI-TENANT)\n# ============================================\n\nSELECT_ROLES_PAGINATED = \"\"\"\nSELECT \n    r.rol_id,",
    "type": "sql_string"
  },
  {
    "file": "app\\infrastructure\\database\\queries\\rbac\\rbac_queries.py",
    "line": 13,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "- DELETE_PERMISOS_POR_ROL\n- INSERT_PERMISO_ROL\n\"\"\"\n\n# ============================================\n# QUERIES PARA ROLES (MULTI-TENANT)\n# ============================================\n\nSELECT_ROLES_PAGINATED = \"\"\"\nSELECT \n    r.rol_id,\n    r.nombre,",
    "type": "sql_string"
  },
  {
    "file": "app\\infrastructure\\database\\queries\\rbac\\rbac_queries.py",
    "line": 124,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "__all__ = [\n    \"SELECT_ROLES_PAGINATED\",\n    \"COUNT_ROLES_PAGINATED\",\n    \"SELECT_PERMISOS_POR_ROL\",\n    \"DEACTIVATE_ROL\",\n    \"REACTIVATE_ROL\",\n    \"DELETE_PERMISOS_POR_ROL\",\n    \"INSERT_PERMISO_ROL\",\n]\n",
    "type": "sql_string"
  },
  {
    "file": "app\\infrastructure\\database\\queries\\rbac\\rbac_queries.py",
    "line": 126,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "    \"COUNT_ROLES_PAGINATED\",\n    \"SELECT_PERMISOS_POR_ROL\",\n    \"DEACTIVATE_ROL\",\n    \"REACTIVATE_ROL\",\n    \"DELETE_PERMISOS_POR_ROL\",\n    \"INSERT_PERMISO_ROL\",\n]\n",
    "type": "sql_string"
  },
  {
    "file": "app\\infrastructure\\database\\queries\\rbac\\rbac_queries.py",
    "line": 129,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "    \"REACTIVATE_ROL\",\n    \"DELETE_PERMISOS_POR_ROL\",\n    \"INSERT_PERMISO_ROL\",\n]\n",
    "type": "sql_string"
  },
  {
    "file": "app\\infrastructure\\database\\queries\\rbac\\rbac_queries.py",
    "line": 130,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "    \"DELETE_PERMISOS_POR_ROL\",\n    \"INSERT_PERMISO_ROL\",\n]\n",
    "type": "sql_string"
  },
  {
    "file": "app\\infrastructure\\database\\queries\\rbac\\__init__.py",
    "line": 13,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "from .rbac_queries import (\n    SELECT_ROLES_PAGINATED,\n    COUNT_ROLES_PAGINATED,\n    SELECT_PERMISOS_POR_ROL,\n    DEACTIVATE_ROL,\n    REACTIVATE_ROL,\n    DELETE_PERMISOS_POR_ROL,\n    INSERT_PERMISO_ROL,\n)\n\n__all__ = [\n    \"SELECT_ROLES_PAGINATED\",",
    "type": "sql_string"
  },
  {
    "file": "app\\infrastructure\\database\\queries\\rbac\\__init__.py",
    "line": 15,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "    COUNT_ROLES_PAGINATED,\n    SELECT_PERMISOS_POR_ROL,\n    DEACTIVATE_ROL,\n    REACTIVATE_ROL,\n    DELETE_PERMISOS_POR_ROL,\n    INSERT_PERMISO_ROL,\n)\n\n__all__ = [\n    \"SELECT_ROLES_PAGINATED\",\n    \"COUNT_ROLES_PAGINATED\",\n    \"SELECT_PERMISOS_POR_ROL\",",
    "type": "sql_string"
  },
  {
    "file": "app\\infrastructure\\database\\queries\\rbac\\__init__.py",
    "line": 18,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "    REACTIVATE_ROL,\n    DELETE_PERMISOS_POR_ROL,\n    INSERT_PERMISO_ROL,\n)\n\n__all__ = [\n    \"SELECT_ROLES_PAGINATED\",\n    \"COUNT_ROLES_PAGINATED\",\n    \"SELECT_PERMISOS_POR_ROL\",\n    \"DEACTIVATE_ROL\",\n    \"REACTIVATE_ROL\",\n    \"DELETE_PERMISOS_POR_ROL\",",
    "type": "sql_string"
  },
  {
    "file": "app\\infrastructure\\database\\queries\\rbac\\__init__.py",
    "line": 19,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "    DELETE_PERMISOS_POR_ROL,\n    INSERT_PERMISO_ROL,\n)\n\n__all__ = [\n    \"SELECT_ROLES_PAGINATED\",\n    \"COUNT_ROLES_PAGINATED\",\n    \"SELECT_PERMISOS_POR_ROL\",\n    \"DEACTIVATE_ROL\",\n    \"REACTIVATE_ROL\",\n    \"DELETE_PERMISOS_POR_ROL\",\n    \"INSERT_PERMISO_ROL\",",
    "type": "sql_string"
  },
  {
    "file": "app\\infrastructure\\database\\queries\\rbac\\__init__.py",
    "line": 23,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "__all__ = [\n    \"SELECT_ROLES_PAGINATED\",\n    \"COUNT_ROLES_PAGINATED\",\n    \"SELECT_PERMISOS_POR_ROL\",\n    \"DEACTIVATE_ROL\",\n    \"REACTIVATE_ROL\",\n    \"DELETE_PERMISOS_POR_ROL\",\n    \"INSERT_PERMISO_ROL\",\n]\n",
    "type": "sql_string"
  },
  {
    "file": "app\\infrastructure\\database\\queries\\rbac\\__init__.py",
    "line": 25,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "    \"COUNT_ROLES_PAGINATED\",\n    \"SELECT_PERMISOS_POR_ROL\",\n    \"DEACTIVATE_ROL\",\n    \"REACTIVATE_ROL\",\n    \"DELETE_PERMISOS_POR_ROL\",\n    \"INSERT_PERMISO_ROL\",\n]\n",
    "type": "sql_string"
  },
  {
    "file": "app\\infrastructure\\database\\queries\\rbac\\__init__.py",
    "line": 28,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "    \"REACTIVATE_ROL\",\n    \"DELETE_PERMISOS_POR_ROL\",\n    \"INSERT_PERMISO_ROL\",\n]\n",
    "type": "sql_string"
  },
  {
    "file": "app\\infrastructure\\database\\queries\\rbac\\__init__.py",
    "line": 29,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "    \"DELETE_PERMISOS_POR_ROL\",\n    \"INSERT_PERMISO_ROL\",\n]\n",
    "type": "sql_string"
  },
  {
    "file": "app\\infrastructure\\database\\queries\\users\\user_queries.py",
    "line": 7,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "QUERIES INCLUIDAS:\n- SELECT_USUARIOS_PAGINATED\n- COUNT_USUARIOS_PAGINATED\n- SELECT_USUARIOS_PAGINATED_MULTI_DB\n- COUNT_USUARIOS_PAGINATED_MULTI_DB\n- GET_USER_COMPLETE_OPTIMIZED_JSON\n- GET_USER_COMPLETE_OPTIMIZED_XML\n\"\"\"\n\n# ============================================\n# QUERIES PARA USUARIOS (MULTI-TENANT)\n# ============================================",
    "type": "sql_string"
  },
  {
    "file": "app\\infrastructure\\database\\queries\\users\\user_queries.py",
    "line": 9,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "- COUNT_USUARIOS_PAGINATED\n- SELECT_USUARIOS_PAGINATED_MULTI_DB\n- COUNT_USUARIOS_PAGINATED_MULTI_DB\n- GET_USER_COMPLETE_OPTIMIZED_JSON\n- GET_USER_COMPLETE_OPTIMIZED_XML\n\"\"\"\n\n# ============================================\n# QUERIES PARA USUARIOS (MULTI-TENANT)\n# ============================================\n\nSELECT_USUARIOS_PAGINATED = \"\"\"",
    "type": "sql_string"
  },
  {
    "file": "app\\infrastructure\\database\\queries\\users\\user_queries.py",
    "line": 19,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "\nSELECT_USUARIOS_PAGINATED = \"\"\"\nWITH UserRoles AS (\n    SELECT\n        u.usuario_id,\n        u.nombre_usuario,\n        u.correo,\n        u.contrasena, \n        u.nombre,\n        u.apellido,\n        u.es_activo,\n        u.correo_confirmado,",
    "type": "sql_string"
  },
  {
    "file": "app\\infrastructure\\database\\queries\\users\\user_queries.py",
    "line": 19,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "\nSELECT_USUARIOS_PAGINATED = \"\"\"\nWITH UserRoles AS (\n    SELECT\n        u.usuario_id,\n        u.nombre_usuario,\n        u.correo,\n        u.contrasena, \n        u.nombre,\n        u.apellido,\n        u.es_activo,\n        u.correo_confirmado,",
    "type": "sql_string"
  },
  {
    "file": "app\\infrastructure\\database\\queries\\users\\user_queries.py",
    "line": 21,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "WITH UserRoles AS (\n    SELECT\n        u.usuario_id,\n        u.nombre_usuario,\n        u.correo,\n        u.contrasena, \n        u.nombre,\n        u.apellido,\n        u.es_activo,\n        u.correo_confirmado,\n        u.fecha_creacion,\n        u.fecha_ultimo_acceso,",
    "type": "sql_string"
  },
  {
    "file": "app\\infrastructure\\database\\queries\\users\\user_queries.py",
    "line": 21,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "WITH UserRoles AS (\n    SELECT\n        u.usuario_id,\n        u.nombre_usuario,\n        u.correo,\n        u.contrasena, \n        u.nombre,\n        u.apellido,\n        u.es_activo,\n        u.correo_confirmado,\n        u.fecha_creacion,\n        u.fecha_ultimo_acceso,",
    "type": "sql_string"
  },
  {
    "file": "app\\infrastructure\\database\\queries\\users\\user_queries.py",
    "line": 88,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "WITH UserRoles AS (\n    SELECT\n        u.usuario_id,\n        u.nombre_usuario,\n        u.correo,\n        u.contrasena, \n        u.nombre,\n        u.apellido,\n        u.es_activo,\n        u.correo_confirmado,\n        u.fecha_creacion,\n        u.fecha_ultimo_acceso,",
    "type": "sql_string"
  },
  {
    "file": "app\\infrastructure\\database\\queries\\users\\user_queries.py",
    "line": 88,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "WITH UserRoles AS (\n    SELECT\n        u.usuario_id,\n        u.nombre_usuario,\n        u.correo,\n        u.contrasena, \n        u.nombre,\n        u.apellido,\n        u.es_activo,\n        u.correo_confirmado,\n        u.fecha_creacion,\n        u.fecha_ultimo_acceso,",
    "type": "sql_string"
  },
  {
    "file": "app\\infrastructure\\database\\queries\\users\\user_queries.py",
    "line": 139,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "COUNT_USUARIOS_PAGINATED_MULTI_DB = \"\"\"\nSELECT COUNT(DISTINCT u.usuario_id)\nFROM usuario u\nWHERE\n    u.es_eliminado = 0\n    AND (:buscar IS NULL OR (\n        u.nombre_usuario LIKE :buscar_pattern OR\n        u.correo LIKE :buscar_pattern OR\n        u.nombre LIKE :buscar_pattern OR\n        u.apellido LIKE :buscar_pattern\n    ));\n\"\"\"",
    "type": "sql_string"
  },
  {
    "file": "app\\infrastructure\\database\\queries\\users\\user_queries.py",
    "line": 279,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "__all__ = [\n    \"SELECT_USUARIOS_PAGINATED\",\n    \"COUNT_USUARIOS_PAGINATED\",\n    \"SELECT_USUARIOS_PAGINATED_MULTI_DB\",\n    \"COUNT_USUARIOS_PAGINATED_MULTI_DB\",\n    \"GET_USER_COMPLETE_OPTIMIZED_JSON\",\n    \"GET_USER_COMPLETE_OPTIMIZED_XML\",\n]\n",
    "type": "sql_string"
  },
  {
    "file": "app\\infrastructure\\database\\queries\\users\\user_queries.py",
    "line": 281,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "    \"COUNT_USUARIOS_PAGINATED\",\n    \"SELECT_USUARIOS_PAGINATED_MULTI_DB\",\n    \"COUNT_USUARIOS_PAGINATED_MULTI_DB\",\n    \"GET_USER_COMPLETE_OPTIMIZED_JSON\",\n    \"GET_USER_COMPLETE_OPTIMIZED_XML\",\n]\n",
    "type": "sql_string"
  },
  {
    "file": "app\\infrastructure\\database\\queries\\users\\__init__.py",
    "line": 13,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "from .user_queries import (\n    SELECT_USUARIOS_PAGINATED,\n    COUNT_USUARIOS_PAGINATED,\n    SELECT_USUARIOS_PAGINATED_MULTI_DB,\n    COUNT_USUARIOS_PAGINATED_MULTI_DB,\n    GET_USER_COMPLETE_OPTIMIZED_JSON,\n    GET_USER_COMPLETE_OPTIMIZED_XML,\n)\n\n__all__ = [\n    \"SELECT_USUARIOS_PAGINATED\",\n    \"COUNT_USUARIOS_PAGINATED\",",
    "type": "sql_string"
  },
  {
    "file": "app\\infrastructure\\database\\queries\\users\\__init__.py",
    "line": 15,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "    COUNT_USUARIOS_PAGINATED,\n    SELECT_USUARIOS_PAGINATED_MULTI_DB,\n    COUNT_USUARIOS_PAGINATED_MULTI_DB,\n    GET_USER_COMPLETE_OPTIMIZED_JSON,\n    GET_USER_COMPLETE_OPTIMIZED_XML,\n)\n\n__all__ = [\n    \"SELECT_USUARIOS_PAGINATED\",\n    \"COUNT_USUARIOS_PAGINATED\",\n    \"SELECT_USUARIOS_PAGINATED_MULTI_DB\",\n    \"COUNT_USUARIOS_PAGINATED_MULTI_DB\",",
    "type": "sql_string"
  },
  {
    "file": "app\\infrastructure\\database\\queries\\users\\__init__.py",
    "line": 22,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "__all__ = [\n    \"SELECT_USUARIOS_PAGINATED\",\n    \"COUNT_USUARIOS_PAGINATED\",\n    \"SELECT_USUARIOS_PAGINATED_MULTI_DB\",\n    \"COUNT_USUARIOS_PAGINATED_MULTI_DB\",\n    \"GET_USER_COMPLETE_OPTIMIZED_JSON\",\n    \"GET_USER_COMPLETE_OPTIMIZED_XML\",\n]\n",
    "type": "sql_string"
  },
  {
    "file": "app\\infrastructure\\database\\queries\\users\\__init__.py",
    "line": 24,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "    \"COUNT_USUARIOS_PAGINATED\",\n    \"SELECT_USUARIOS_PAGINATED_MULTI_DB\",\n    \"COUNT_USUARIOS_PAGINATED_MULTI_DB\",\n    \"GET_USER_COMPLETE_OPTIMIZED_JSON\",\n    \"GET_USER_COMPLETE_OPTIMIZED_XML\",\n]\n",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\auth\\presentation\\endpoints_auth_config.py",
    "line": 19,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "\nfrom app.modules.auth.presentation.schemas import AuthConfigRead, AuthConfigUpdate\nfrom app.modules.auth.application.services.auth_config_service import AuthConfigService\nfrom app.api.deps import RoleChecker\n\nlogger = logging.getLogger(__name__)\n\nrouter = APIRouter()\n\n# Dependencia para requerir rol SUPER_ADMIN\nrequire_super_admin = RoleChecker([\"SUPER_ADMIN\"])\n",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\auth\\presentation\\endpoints_sso.py",
    "line": 48,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "    SsoProvider, SSOConfigAzure, SSOConfigGoogle,\n    FederacionBase, FederacionCreate, FederacionUpdate, FederacionRead\n)\n\nlogger = logging.getLogger(__name__)\n\nrouter = APIRouter()\n\n# Dependencia para requerir rol ADMIN o SUPER_ADMIN\nrequire_admin = RoleChecker([\"ADMIN\", \"SUPER_ADMIN\"])\n\n",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\auth\\presentation\\endpoints_sso.py",
    "line": 178,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "\n@router.delete(\n    \"/{provider_id}/\",\n    summary=\"Eliminar proveedor SSO\",\n    description=\"\"\"\n    Elimina (desactiva) un proveedor de identidad configurado.\n    \n    **Permisos requeridos:**\n    - Rol 'ADMIN' o 'SUPER_ADMIN'\n    \n    **Parámetros de ruta:**\n    - provider_id: ID del proveedor a eliminar",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\auth\\application\\services\\auth_service.py",
    "line": 116,
    "issue": "Query con text() toca tabla rol (verificar uso de cliente_id)",
    "severity": "medium",
    "tabla": "rol",
    "context": "            # ✅ Obtener database_type del contexto para determinar si es BD dedicada\n            tenant_context = try_get_tenant_context()\n            database_type = tenant_context.database_type if tenant_context else \"single\"\n            \n            # ✅ Para BD dedicadas, no filtrar por cliente_id (todos los roles pertenecen al mismo tenant)\n            if database_type == \"multi\":\n                query = \"\"\"\n                SELECT \n                    ISNULL(MAX(r.nivel_acceso), 1) as max_le",
    "type": "text() - tiene cliente_id"
  },
  {
    "file": "app\\modules\\auth\\application\\services\\auth_service.py",
    "line": 116,
    "issue": "Query con text() toca tabla usuario (verificar uso de cliente_id)",
    "severity": "medium",
    "tabla": "usuario",
    "context": "            # ✅ Obtener database_type del contexto para determinar si es BD dedicada\n            tenant_context = try_get_tenant_context()\n            database_type = tenant_context.database_type if tenant_context else \"single\"\n            \n            # ✅ Para BD dedicadas, no filtrar por cliente_id (todos los roles pertenecen al mismo tenant)\n            if database_type == \"multi\":\n                query = \"\"\"\n                SELECT \n                    ISNULL(MAX(r.nivel_acceso), 1) as max_le",
    "type": "text() - tiene cliente_id"
  },
  {
    "file": "app\\modules\\auth\\application\\services\\auth_service.py",
    "line": 116,
    "issue": "Query con text() toca tabla usuario_rol (verificar uso de cliente_id)",
    "severity": "medium",
    "tabla": "usuario_rol",
    "context": "            # ✅ Obtener database_type del contexto para determinar si es BD dedicada\n            tenant_context = try_get_tenant_context()\n            database_type = tenant_context.database_type if tenant_context else \"single\"\n            \n            # ✅ Para BD dedicadas, no filtrar por cliente_id (todos los roles pertenecen al mismo tenant)\n            if database_type == \"multi\":\n                query = \"\"\"\n                SELECT \n                    ISNULL(MAX(r.nivel_acceso), 1) as max_le",
    "type": "text() - tiene cliente_id"
  },
  {
    "file": "app\\modules\\auth\\application\\services\\auth_service.py",
    "line": 122,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "                query = \"\"\"\n                SELECT \n                    ISNULL(MAX(r.nivel_acceso), 1) as max_level,\n                    COUNT(CASE WHEN r.codigo_rol = 'SUPER_ADMIN' AND r.nivel_acceso = 5 THEN 1 END) as super_admin_count,\n                    COUNT(*) as total_roles\n                FROM usuario_rol ur\n                INNER JOIN rol r ON ur.rol_id = r.rol_id\n                WHERE ur.usuario_id = :usuario_id \n                  AND ur.es_activo = 1\n                  AND r.es_activo ",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\auth\\application\\services\\auth_service.py",
    "line": 122,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "                query = \"\"\"\n                SELECT \n                    ISNULL(MAX(r.nivel_acceso), 1) as max_level,\n                    COUNT(CASE WHEN r.codigo_rol = 'SUPER_ADMIN' AND r.nivel_acceso = 5 THEN 1 END) as super_admin_count,\n                    COUNT(*) as total_roles\n                FROM usuario_rol ur\n                INNER JOIN rol r ON ur.rol_id = r.rol_id\n                WHERE ur.usuario_id = :usuario_id \n                  AND ur.es_activo = 1\n                  AND r.es_activo ",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\auth\\application\\services\\auth_service.py",
    "line": 122,
    "issue": "Query SQL directa toca tabla usuario_rol sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario_rol",
    "context": "                query = \"\"\"\n                SELECT \n                    ISNULL(MAX(r.nivel_acceso), 1) as max_level,\n                    COUNT(CASE WHEN r.codigo_rol = 'SUPER_ADMIN' AND r.nivel_acceso = 5 THEN 1 END) as super_admin_count,\n                    COUNT(*) as total_roles\n                FROM usuario_rol ur\n                INNER JOIN rol r ON ur.rol_id = r.rol_id\n                WHERE ur.usuario_id = :usuario_id \n                  AND ur.es_activo = 1\n                  AND r.es_activo ",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\auth\\application\\services\\auth_service.py",
    "line": 132,
    "issue": "Query con text() toca tabla usuario (verificar uso de cliente_id)",
    "severity": "medium",
    "tabla": "usuario",
    "context": "                \"\"\"\n                # ✅ FASE 2: Usar execute_query async con text().bindparams() - solo usuario_id para BD dedicadas\n                result = await execute_query(\n                    text(query).bindparams(usuario_id=usuario_id),\n                    connection_type=DatabaseConnection.DEFAULT,\n                    client_id=cliente_id\n                )\n            else:\n                # BD compartida: filtrar por cliente_id\n                # ✅ FASE 4B: Usar constante desde sql_con",
    "type": "text() - tiene cliente_id"
  },
  {
    "file": "app\\modules\\auth\\application\\services\\auth_service.py",
    "line": 134,
    "issue": "Query con text() toca tabla usuario (verificar uso de cliente_id)",
    "severity": "medium",
    "tabla": "usuario",
    "context": "                result = await execute_query(\n                    text(query).bindparams(usuario_id=usuario_id),\n                    connection_type=DatabaseConnection.DEFAULT,\n                    client_id=cliente_id\n                )\n            else:\n                # BD compartida: filtrar por cliente_id\n                # ✅ FASE 4B: Usar constante desde sql_constants con parámetros nombrados\n                result = await execute_query(\n                    text(GET_USER_ACCESS_LEVEL_INFO_COM",
    "type": "text() - tiene cliente_id"
  },
  {
    "file": "app\\modules\\auth\\application\\services\\auth_service.py",
    "line": 142,
    "issue": "Query con text() toca tabla usuario (verificar uso de cliente_id)",
    "severity": "medium",
    "tabla": "usuario",
    "context": "                result = await execute_query(\n                    text(GET_USER_ACCESS_LEVEL_INFO_COMPLETE).bindparams(\n                        usuario_id=usuario_id,\n                        cliente_id=cliente_id\n                    ),\n                    connection_type=DatabaseConnection.DEFAULT,\n                    client_id=cliente_id\n                )\n            \n            if result and len(result) > 0:\n                level_data = result[0]\n                access_level = level_data.get(",
    "type": "text() - tiene cliente_id"
  },
  {
    "file": "app\\modules\\auth\\application\\services\\auth_service.py",
    "line": 234,
    "issue": "Query con text() toca tabla usuario (verificar uso de cliente_id)",
    "severity": "medium",
    "tabla": "usuario",
    "context": "            try:\n                tenant_context = get_tenant_context()\n                database_type = tenant_context.database_type if tenant_context else \"single\"\n            except RuntimeError:\n                # Sin contexto, intentar obtener sin lanzar excepción\n                tenant_context = try_get_tenant_context()\n                database_type = tenant_context.database_type if tenant_context else \"single\"\n            \n            # ✅ CORRECCIÓN: Para BD dedicadas (multi), no filtrar por",
    "type": "text() - tiene cliente_id"
  },
  {
    "file": "app\\modules\\auth\\application\\services\\auth_service.py",
    "line": 238,
    "issue": "Query con text() toca tabla usuario (verificar uso de cliente_id)",
    "severity": "medium",
    "tabla": "usuario",
    "context": "                # Sin contexto, intentar obtener sin lanzar excepción\n                tenant_context = try_get_tenant_context()\n                database_type = tenant_context.database_type if tenant_context else \"single\"\n            \n            # ✅ CORRECCIÓN: Para BD dedicadas (multi), no filtrar por cliente_id\n            # porque todos los usuarios en esa BD pertenecen al mismo cliente\n            if database_type == \"multi\":\n                query = \"\"\"\n                SELECT usuario_id, cli",
    "type": "text() - tiene cliente_id"
  },
  {
    "file": "app\\modules\\auth\\application\\services\\auth_service.py",
    "line": 267,
    "issue": "Query con text() toca tabla usuario (verificar uso de cliente_id)",
    "severity": "medium",
    "tabla": "usuario",
    "context": "            # ✅ CORRECCIÓN CRÍTICA: Usar BD apropiada según tipo de usuario\n            # ✅ FASE 2: Usar execute_query async con text().bindparams()\n            \n            if is_superadmin:\n                # Superadmin: SIEMPRE usar BD ADMIN\n                logger.debug(f\"[AUTH] Ejecutando en BD ADMIN: cliente_id={search_cliente_id}, username='{username}'\")\n                \n                result = await execute_query(\n                    text(query).bindparams(cliente_id=search_cliente_id, no",
    "type": "text() - tiene cliente_id"
  },
  {
    "file": "app\\modules\\auth\\application\\services\\auth_service.py",
    "line": 274,
    "issue": "Query con text() toca tabla usuario (verificar uso de cliente_id)",
    "severity": "medium",
    "tabla": "usuario",
    "context": "                result = await execute_query(\n                    text(query).bindparams(cliente_id=search_cliente_id, nombre_usuario=username),\n                    connection_type=DatabaseConnection.ADMIN,\n                    client_id=None\n                )\n                user = result[0] if result else None\n            else:\n                # Usuario regular: Usar BD del contexto (tenant-aware)\n                logger.debug(f\"[AUTH] Ejecutando en BD tenant: cliente_id={search_cliente_id}, use",
    "type": "text() - tiene cliente_id"
  },
  {
    "file": "app\\modules\\auth\\application\\services\\auth_service.py",
    "line": 286,
    "issue": "Query con text() toca tabla usuario (verificar uso de cliente_id)",
    "severity": "medium",
    "tabla": "usuario",
    "context": "                    result = await execute_query(\n                        text(query).bindparams(nombre_usuario=username),\n                        connection_type=DatabaseConnection.DEFAULT,\n                        client_id=search_cliente_id\n                    )\n                else:\n                    # BD compartida: pasar cliente_id en bindparams\n                    result = await execute_query(\n                        text(query).bindparams(cliente_id=search_cliente_id, nombre_usuario=use",
    "type": "text() - tiene cliente_id"
  },
  {
    "file": "app\\modules\\auth\\application\\services\\auth_service.py",
    "line": 293,
    "issue": "Query con text() toca tabla usuario (verificar uso de cliente_id)",
    "severity": "medium",
    "tabla": "usuario",
    "context": "                    result = await execute_query(\n                        text(query).bindparams(cliente_id=search_cliente_id, nombre_usuario=username),\n                        connection_type=DatabaseConnection.DEFAULT,\n                        client_id=search_cliente_id\n                    )\n                user = result[0] if result else None\n\n            if not user:\n                logger.warning(\n                    f\"[AUTH] Usuario NO ENCONTRADO: \"\n                    f\"username='{usernam",
    "type": "text() - tiene cliente_id"
  },
  {
    "file": "app\\modules\\auth\\application\\services\\auth_service.py",
    "line": 579,
    "issue": "Query con text() toca tabla usuario (verificar uso de cliente_id)",
    "severity": "medium",
    "tabla": "usuario",
    "context": "        \n        tenant_context = try_get_tenant_context()\n        database_type = tenant_context.database_type if tenant_context else \"single\"\n        \n        # Query base (sin filtro de cliente_id para BD dedicadas)\n        query = \"\"\"\n        SELECT usuario_id, cliente_id, nombre_usuario, correo, nombre, apellido, es_activo\n        FROM usuario\n        WHERE nombre_usuario = ? AND es_eliminado = 0\n        \"\"\"\n        \n        # ✅ FASE 2: Usar await\n        if es_superadmin:\n            # Sup",
    "type": "text() - tiene cliente_id"
  },
  {
    "file": "app\\modules\\auth\\application\\services\\auth_service.py",
    "line": 593,
    "issue": "Query con text() toca tabla usuario (verificar uso de cliente_id)",
    "severity": "medium",
    "tabla": "usuario",
    "context": "            result = await execute_query(\n                text(query.replace(\"?\", \":username\")).bindparams(username=username),\n                connection_type=DatabaseConnection.ADMIN,\n                client_id=None\n            )\n            user = result[0] if result else None\n            \n            # Agregar contexto multi-tenant\n            if user:\n                user['target_cliente_id'] = target_cliente_id\n                user['es_superadmin'] = True\n        else:\n            # Usuario ",
    "type": "text() - tiene cliente_id"
  },
  {
    "file": "app\\modules\\auth\\application\\services\\auth_service.py",
    "line": 754,
    "issue": "Query con text() toca tabla usuario (verificar uso de cliente_id)",
    "severity": "medium",
    "tabla": "usuario",
    "context": "            \n            tenant_context = try_get_tenant_context()\n            database_type = tenant_context.database_type if tenant_context else \"single\"\n            \n            # Query base (sin filtro de cliente_id para BD dedicadas)\n            query = \"\"\"\n            SELECT usuario_id, cliente_id, nombre_usuario, correo, nombre, apellido, es_activo\n            FROM usuario\n            WHERE nombre_usuario = ? AND es_eliminado = 0\n            \"\"\"\n            # ✅ FASE 2: Usar await\n        ",
    "type": "text() - tiene cliente_id"
  },
  {
    "file": "app\\modules\\auth\\application\\services\\refresh_token_service.py",
    "line": 90,
    "issue": "Query con text() toca tabla usuario (verificar uso de cliente_id)",
    "severity": "medium",
    "tabla": "usuario",
    "context": "                    existing = await execute_query(\n                        text(GET_REFRESH_TOKEN_BY_HASH).bindparams(\n                            token_hash=token_hash, cliente_id=cliente_id\n                        )\n                    )\n                    if existing and len(existing) > 0:\n                        token_data = existing[0]\n                        logger.info(\n                            f\"[STORE-TOKEN-ROTATION] Token ya existe en BD (doble refresh detectado) - \"\n             ",
    "type": "text() - tiene cliente_id"
  },
  {
    "file": "app\\modules\\auth\\application\\services\\refresh_token_service.py",
    "line": 110,
    "issue": "Query con text() toca tabla usuario (verificar uso de cliente_id)",
    "severity": "medium",
    "tabla": "usuario",
    "context": "            \n            # ✅ FASE 4B: Usar parámetros nombrados con text().bindparams()\n            # Intentar insertar\n            result = await execute_insert(\n                text(INSERT_REFRESH_TOKEN).bindparams(\n                    usuario_id=usuario_id,\n                    token_hash=token_hash,\n                    expires_at=expires_at,\n                    client_type=client_type,\n                    ip_address=ip_address,\n                    user_agent=user_agent[:500] if user_agent els",
    "type": "text() - tiene cliente_id"
  },
  {
    "file": "app\\modules\\auth\\application\\services\\refresh_token_service.py",
    "line": 113,
    "issue": "Query con text() toca tabla usuario (verificar uso de cliente_id)",
    "severity": "medium",
    "tabla": "usuario",
    "context": "            result = await execute_insert(\n                text(INSERT_REFRESH_TOKEN).bindparams(\n                    usuario_id=usuario_id,\n                    token_hash=token_hash,\n                    expires_at=expires_at,\n                    client_type=client_type,\n                    ip_address=ip_address,\n                    user_agent=user_agent[:500] if user_agent else None,\n                    cliente_id=cliente_id\n                ),\n                connection_type=DatabaseConnection.",
    "type": "text() - tiene cliente_id"
  },
  {
    "file": "app\\modules\\auth\\application\\services\\refresh_token_service.py",
    "line": 225,
    "issue": "Query con text() toca tabla usuario (verificar uso de cliente_id)",
    "severity": "medium",
    "tabla": "usuario",
    "context": "            result = await execute_query(\n                text(GET_REFRESH_TOKEN_BY_HASH).bindparams(\n                    token_hash=token_hash, cliente_id=cliente_id\n                )\n            )\n            \n            if not result or len(result) == 0:\n                logger.warning(\n                    f\"[VALIDATE-TOKEN] Token no encontrado, revocado o expirado - Cliente {cliente_id}\"\n                )\n                return None\n            \n            token_data = result[0]\n           ",
    "type": "text() - tiene cliente_id"
  },
  {
    "file": "app\\modules\\auth\\application\\services\\refresh_token_service.py",
    "line": 267,
    "issue": "Query con text() toca tabla usuario (verificar uso de cliente_id)",
    "severity": "medium",
    "tabla": "usuario",
    "context": "            result = await execute_update(\n                text(REVOKE_REFRESH_TOKEN).bindparams(\n                    token_hash=token_hash,\n                    cliente_id=cliente_id\n                ),\n                client_id=cliente_id\n            )\n            \n            rows_affected = result.get('rows_affected', 0)\n            \n            if rows_affected > 0:\n                logger.info(\n                    f\"[REVOKE-TOKEN] Token específico revocado exitosamente - \"\n                   ",
    "type": "text() - tiene cliente_id"
  },
  {
    "file": "app\\modules\\auth\\application\\services\\refresh_token_service.py",
    "line": 307,
    "issue": "Query con text() toca tabla usuario (verificar uso de cliente_id)",
    "severity": "medium",
    "tabla": "usuario",
    "context": "        try:\n            # ✅ FASE 4B: Usar parámetros nombrados con text().bindparams()\n            result = await execute_update(\n                text(REVOKE_ALL_USER_TOKENS).bindparams(\n                    usuario_id=usuario_id,\n                    cliente_id=cliente_id\n                ),\n                client_id=cliente_id\n            )\n            rows_affected = result.get('rows_affected', 0)\n            \n            logger.info(\n                f\"[REVOKE-ALL] {rows_affected} tokens revoca",
    "type": "text() - tiene cliente_id"
  },
  {
    "file": "app\\modules\\auth\\application\\services\\refresh_token_service.py",
    "line": 309,
    "issue": "Query con text() toca tabla usuario (verificar uso de cliente_id)",
    "severity": "medium",
    "tabla": "usuario",
    "context": "            result = await execute_update(\n                text(REVOKE_ALL_USER_TOKENS).bindparams(\n                    usuario_id=usuario_id,\n                    cliente_id=cliente_id\n                ),\n                client_id=cliente_id\n            )\n            rows_affected = result.get('rows_affected', 0)\n            \n            logger.info(\n                f\"[REVOKE-ALL] {rows_affected} tokens revocados - Cliente {cliente_id}, Usuario {usuario_id}\"\n            )\n            \n           ",
    "type": "text() - tiene cliente_id"
  },
  {
    "file": "app\\modules\\auth\\application\\services\\refresh_token_service.py",
    "line": 344,
    "issue": "Query con text() toca tabla usuario (verificar uso de cliente_id)",
    "severity": "medium",
    "tabla": "usuario",
    "context": "            sessions = await execute_query(\n                text(GET_ACTIVE_SESSIONS_BY_USER).bindparams(\n                    usuario_id=usuario_id, cliente_id=cliente_id\n                )\n            )\n            \n            logger.info(\n                f\"[SESSIONS] Cliente {cliente_id}, Usuario {usuario_id} tiene {len(sessions)} sesiones activas\"\n            )\n            \n            return sessions\n        \n        except CustomException:\n            raise\n        except Exception as e:\n  ",
    "type": "text() - tiene cliente_id"
  },
  {
    "file": "app\\modules\\auth\\application\\services\\refresh_token_service.py",
    "line": 426,
    "issue": "Query con text() toca tabla usuario (verificar uso de cliente_id)",
    "severity": "medium",
    "tabla": "usuario",
    "context": "        try:\n            # ✅ FASE 4B: Usar parámetros nombrados con text().bindparams()\n            result = await execute_update(\n                text(REVOKE_REFRESH_TOKEN_BY_ID).bindparams(\n                    token_id=token_id\n                )\n            )\n            \n            if result and result.get('token_id'):\n                logger.info(\n                    f\"[ADMIN-REVOKE] Token ID {token_id} revocado - \"\n                    f\"Cliente: {result.get('cliente_id')}, Usuario: {result.",
    "type": "text() - tiene cliente_id"
  },
  {
    "file": "app\\modules\\auth\\application\\services\\refresh_token_service.py",
    "line": 428,
    "issue": "Query con text() toca tabla usuario (verificar uso de cliente_id)",
    "severity": "medium",
    "tabla": "usuario",
    "context": "            result = await execute_update(\n                text(REVOKE_REFRESH_TOKEN_BY_ID).bindparams(\n                    token_id=token_id\n                )\n            )\n            \n            if result and result.get('token_id'):\n                logger.info(\n                    f\"[ADMIN-REVOKE] Token ID {token_id} revocado - \"\n                    f\"Cliente: {result.get('cliente_id')}, Usuario: {result.get('usuario_id')}\"\n                )\n                return True\n            \n         ",
    "type": "text() - tiene cliente_id"
  },
  {
    "file": "app\\modules\\auth\\infrastructure\\repositories\\usuario_repository.py",
    "line": 69,
    "issue": "Query con text() toca tabla usuario (verificar uso de cliente_id)",
    "severity": "medium",
    "tabla": "usuario",
    "context": "            results = await execute_query(\n                text(query).bindparams(**bind_params),\n                connection_type=self.connection_type,\n                client_id=client_id\n            )\n            return results[0] if results else None\n        except Exception as e:\n            logger.error(f\"Error en find_by_username_or_email: {str(e)}\")\n            raise\n    \n    async def find_by_username(\n        self,\n        username: str,\n        client_id: Optional[int] = None\n    ) -> O",
    "type": "text() - tiene cliente_id"
  },
  {
    "file": "app\\modules\\auth\\infrastructure\\repositories\\usuario_repository.py",
    "line": 108,
    "issue": "Query con text() toca tabla rol (verificar uso de cliente_id)",
    "severity": "medium",
    "tabla": "rol",
    "context": "            results = await execute_query(\n                text(query).bindparams(**bind_params),\n                connection_type=self.connection_type,\n                client_id=client_id\n            )\n            return results[0] if results else None\n        except Exception as e:\n            logger.error(f\"Error en find_by_username: {str(e)}\")\n            raise\n    \n    async def find_with_roles(\n        self,\n        usuario_id: int,\n        client_id: Optional[int] = None\n    ) -> Optional[",
    "type": "text() - tiene cliente_id"
  },
  {
    "file": "app\\modules\\auth\\infrastructure\\repositories\\usuario_repository.py",
    "line": 108,
    "issue": "Query con text() toca tabla usuario (verificar uso de cliente_id)",
    "severity": "medium",
    "tabla": "usuario",
    "context": "            results = await execute_query(\n                text(query).bindparams(**bind_params),\n                connection_type=self.connection_type,\n                client_id=client_id\n            )\n            return results[0] if results else None\n        except Exception as e:\n            logger.error(f\"Error en find_by_username: {str(e)}\")\n            raise\n    \n    async def find_with_roles(\n        self,\n        usuario_id: int,\n        client_id: Optional[int] = None\n    ) -> Optional[",
    "type": "text() - tiene cliente_id"
  },
  {
    "file": "app\\modules\\auth\\infrastructure\\repositories\\usuario_repository.py",
    "line": 141,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "        query_roles = \"\"\"\n            SELECT \n                r.rol_id,\n                r.codigo_rol,\n                r.nombre_rol,\n                r.descripcion,\n                r.es_activo,\n                ur.es_activo as asignacion_activa\n            FROM rol r\n            INNER JOIN usuario_rol ur ON r.rol_id = ur.rol_id\n            WHERE ur.usuario_id = :usuario_id\n            AND ur.es_activo = 1",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\auth\\infrastructure\\repositories\\usuario_repository.py",
    "line": 141,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "        query_roles = \"\"\"\n            SELECT \n                r.rol_id,\n                r.codigo_rol,\n                r.nombre_rol,\n                r.descripcion,\n                r.es_activo,\n                ur.es_activo as asignacion_activa\n            FROM rol r\n            INNER JOIN usuario_rol ur ON r.rol_id = ur.rol_id\n            WHERE ur.usuario_id = :usuario_id\n            AND ur.es_activo = 1",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\auth\\infrastructure\\repositories\\usuario_repository.py",
    "line": 141,
    "issue": "Query SQL directa toca tabla usuario_rol sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario_rol",
    "context": "        query_roles = \"\"\"\n            SELECT \n                r.rol_id,\n                r.codigo_rol,\n                r.nombre_rol,\n                r.descripcion,\n                r.es_activo,\n                ur.es_activo as asignacion_activa\n            FROM rol r\n            INNER JOIN usuario_rol ur ON r.rol_id = ur.rol_id\n            WHERE ur.usuario_id = :usuario_id\n            AND ur.es_activo = 1",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\auth\\infrastructure\\repositories\\usuario_repository.py",
    "line": 162,
    "issue": "Query con text() toca tabla rol (verificar uso de cliente_id)",
    "severity": "medium",
    "tabla": "rol",
    "context": "            roles = await execute_query(\n                text(query_roles).bindparams(**bind_params_roles),\n                connection_type=self.connection_type,\n                client_id=client_id\n            )\n            usuario['roles'] = roles\n            return usuario\n        except Exception as e:\n            logger.error(f\"Error en find_with_roles: {str(e)}\")\n            # Retornar usuario sin roles si falla la query de roles\n            usuario['roles'] = []\n            return usuario\n",
    "type": "text() - tiene cliente_id"
  },
  {
    "file": "app\\modules\\auth\\infrastructure\\repositories\\usuario_repository.py",
    "line": 162,
    "issue": "Query con text() toca tabla usuario (verificar uso de cliente_id)",
    "severity": "medium",
    "tabla": "usuario",
    "context": "            roles = await execute_query(\n                text(query_roles).bindparams(**bind_params_roles),\n                connection_type=self.connection_type,\n                client_id=client_id\n            )\n            usuario['roles'] = roles\n            return usuario\n        except Exception as e:\n            logger.error(f\"Error en find_with_roles: {str(e)}\")\n            # Retornar usuario sin roles si falla la query de roles\n            usuario['roles'] = []\n            return usuario\n",
    "type": "text() - tiene cliente_id"
  },
  {
    "file": "app\\modules\\menus\\presentation\\endpoints.py",
    "line": 24,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "from app.modules.menus.presentation.schemas import (\n    MenuResponse, MenuCreate, MenuUpdate, MenuReadSingle, MenuItem\n)\nfrom app.modules.users.presentation.schemas import UsuarioReadWithRoles # Para dependencia de usuario\n\n# Importar Servicio\nfrom app.modules.menus.application.services.menu_service import MenuService\n\n# Importar Excepciones personalizadas (Asumimos CustomException es la estándar ahora)\nfrom app.core.exceptions import CustomException # Reemplaza ServiceError\n\n# Importar Depende",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\menus\\presentation\\endpoints.py",
    "line": 24,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "from app.modules.menus.presentation.schemas import (\n    MenuResponse, MenuCreate, MenuUpdate, MenuReadSingle, MenuItem\n)\nfrom app.modules.users.presentation.schemas import UsuarioReadWithRoles # Para dependencia de usuario\n\n# Importar Servicio\nfrom app.modules.menus.application.services.menu_service import MenuService\n\n# Importar Excepciones personalizadas (Asumimos CustomException es la estándar ahora)\nfrom app.core.exceptions import CustomException # Reemplaza ServiceError\n\n# Importar Depende",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\menus\\presentation\\endpoints.py",
    "line": 309,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": ")\nasync def update_menu_endpoint(\n    menu_id: UUID = Path(..., title=\"ID del Menú\", description=\"El ID del ítem de menú a actualizar\"),\n    menu_in: MenuUpdate = Body(...),\n    current_user: UsuarioReadWithRoles = Depends(get_current_active_user)\n):\n    \"\"\"\n    Endpoint para actualizar parcialmente un ítem de menú existente.\n\n    Args:\n        menu_id: Identificador único del ítem de menú a actualizar.\n        menu_in: Campos a actualizar (actualización parcial).",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\menus\\presentation\\endpoints.py",
    "line": 309,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": ")\nasync def update_menu_endpoint(\n    menu_id: UUID = Path(..., title=\"ID del Menú\", description=\"El ID del ítem de menú a actualizar\"),\n    menu_in: MenuUpdate = Body(...),\n    current_user: UsuarioReadWithRoles = Depends(get_current_active_user)\n):\n    \"\"\"\n    Endpoint para actualizar parcialmente un ítem de menú existente.\n\n    Args:\n        menu_id: Identificador único del ítem de menú a actualizar.\n        menu_in: Campos a actualizar (actualización parcial).",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\menus\\presentation\\endpoints.py",
    "line": 311,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "    menu_id: UUID = Path(..., title=\"ID del Menú\", description=\"El ID del ítem de menú a actualizar\"),\n    menu_in: MenuUpdate = Body(...),\n    current_user: UsuarioReadWithRoles = Depends(get_current_active_user)\n):\n    \"\"\"\n    Endpoint para actualizar parcialmente un ítem de menú existente.\n\n    Args:\n        menu_id: Identificador único del ítem de menú a actualizar.\n        menu_in: Campos a actualizar (actualización parcial).\n        current_user: Usuario autenticado y activo (inyectado por",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\menus\\presentation\\endpoints.py",
    "line": 311,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "    menu_id: UUID = Path(..., title=\"ID del Menú\", description=\"El ID del ítem de menú a actualizar\"),\n    menu_in: MenuUpdate = Body(...),\n    current_user: UsuarioReadWithRoles = Depends(get_current_active_user)\n):\n    \"\"\"\n    Endpoint para actualizar parcialmente un ítem de menú existente.\n\n    Args:\n        menu_id: Identificador único del ítem de menú a actualizar.\n        menu_in: Campos a actualizar (actualización parcial).\n        current_user: Usuario autenticado y activo (inyectado por",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\menus\\presentation\\endpoints.py",
    "line": 360,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "# ----------------------------------------------------------------------\n@router.delete(\n    \"/{menu_id}/\",\n    status_code=status.HTTP_200_OK,\n    response_model=Dict[str, Any],\n    summary=\"Desactivar un ítem de menú (Borrado Lógico) (Admin)\",\n    description=\"\"\"\n    Desactiva un ítem de menú estableciendo su estado 'es_activo' a False (borrado lógico).\n\n    **Permisos requeridos:**\n    - Rol 'Administrador'\n",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\menus\\presentation\\endpoints_areas.py",
    "line": 23,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "# Schemas para áreas\nfrom app.modules.menus.presentation.schemas import AreaCreate, AreaUpdate, AreaRead, PaginatedAreaResponse, AreaSimpleList\n\n# Servicio de áreas con manejo de errores mejorado\nfrom app.modules.menus.application.services.area_service import AreaService\n\n# Sistema de excepciones personalizado\nfrom app.core.exceptions import CustomException  # Importar CustomException\n\n# Dependencias de autorización\nfrom app.api.deps import get_current_active_user, RoleChecker\n",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\menus\\presentation\\endpoints_areas.py",
    "line": 213,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "    description=\"\"\"\n    Devuelve una lista simplificada de áreas activas **del cliente actual** para uso en selectores o listas desplegables.\n    \n    **Permisos requeridos:**\n    - Rol 'Administrador'\n    \n    **Respuestas:**\n    - 200: Lista simple recuperada exitosamente\n    - 500: Error interno del servidor\n    \"\"\",\n    dependencies=[Depends(require_admin)]\n)",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\menus\\presentation\\endpoints_areas.py",
    "line": 230,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "    \n    Ideal para componentes UI que necesitan solo ID y nombre (selectores, combobox, etc.).\n    \n    Args:\n        current_user: Usuario autenticado y activo (inyectado por dependencia).\n        \n    Returns:\n        List[AreaSimpleList]: Lista de áreas activas con ID y nombre\n        \n    Raises:\n        HTTPException: En caso de error interno del servidor\n    \"\"\"",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\menus\\presentation\\endpoints_areas.py",
    "line": 362,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "    area_id: UUID = Path(..., description=\"ID del área\"),\n    area_in: AreaUpdate = Body(...),\n    current_user: Any = Depends(get_current_active_user)\n):\n    \"\"\"\n    Endpoint para actualizar parcialmente un área existente **del cliente del usuario**.\n    \n    Args:\n        area_id: Identificador único del área a actualizar\n        area_in: Campos a actualizar (actualización parcial)\n        current_user: Usuario autenticado y activo (inyectado por dependencia).\n        ",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\menus\\presentation\\endpoints_areas.py",
    "line": 419,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "\n@router.delete(\n    \"/{area_id}/\",\n    response_model=AreaRead,\n    status_code=status.HTTP_200_OK,\n    summary=\"Desactivar un área (Borrado Lógico)\",\n    description=\"\"\"\n    Desactiva un área estableciendo su estado 'es_activo' a False (borrado lógico).\n    **Solo puede desactivar áreas de su mismo cliente**.\n    \n    **Permisos requeridos:**\n    - Rol 'Administrador'",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\modulos\\presentation\\endpoints_cliente_modulo.py",
    "line": 24,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "from app.modules.modulos.presentation.schemas import (\n    ClienteModuloRead, ClienteModuloCreate, ClienteModuloUpdate\n)\nfrom app.modules.modulos.application.services.cliente_modulo_service import ClienteModuloService\nfrom app.core.exceptions import CustomException\nfrom app.api.deps import get_current_active_user\nfrom app.core.authorization.lbac import require_super_admin\nfrom app.modules.users.presentation.schemas import UsuarioReadWithRoles\n\nlogger = logging.getLogger(__name__)\n\nrouter = APIRo",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\modulos\\presentation\\endpoints_cliente_modulo.py",
    "line": 24,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "from app.modules.modulos.presentation.schemas import (\n    ClienteModuloRead, ClienteModuloCreate, ClienteModuloUpdate\n)\nfrom app.modules.modulos.application.services.cliente_modulo_service import ClienteModuloService\nfrom app.core.exceptions import CustomException\nfrom app.api.deps import get_current_active_user\nfrom app.core.authorization.lbac import require_super_admin\nfrom app.modules.users.presentation.schemas import UsuarioReadWithRoles\n\nlogger = logging.getLogger(__name__)\n\nrouter = APIRo",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\modulos\\presentation\\endpoints_menus.py",
    "line": 11,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "from app.modules.modulos.presentation.schemas import (\n    ModuloMenuRead, ModuloMenuCreate, ModuloMenuUpdate, MenuUsuarioResponse\n)\nfrom app.modules.modulos.application.services.modulo_menu_service import ModuloMenuService\nfrom app.core.exceptions import CustomException\nfrom app.api.deps import get_current_active_user\nfrom app.core.authorization.lbac import require_super_admin\nfrom app.modules.users.presentation.schemas import UsuarioReadWithRoles\n\nlogger = logging.getLogger(__name__)\n\nrouter =",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\modulos\\presentation\\endpoints_menus.py",
    "line": 11,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "from app.modules.modulos.presentation.schemas import (\n    ModuloMenuRead, ModuloMenuCreate, ModuloMenuUpdate, MenuUsuarioResponse\n)\nfrom app.modules.modulos.application.services.modulo_menu_service import ModuloMenuService\nfrom app.core.exceptions import CustomException\nfrom app.api.deps import get_current_active_user\nfrom app.core.authorization.lbac import require_super_admin\nfrom app.modules.users.presentation.schemas import UsuarioReadWithRoles\n\nlogger = logging.getLogger(__name__)\n\nrouter =",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\modulos\\presentation\\endpoints_menus.py",
    "line": 152,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "    menu_id: UUID = Path(..., description=\"ID del menú\"),\n    menu_data: ModuloMenuUpdate = Body(...),\n    current_user: UsuarioReadWithRoles = Depends(get_current_active_user)\n):\n    \"\"\"Actualiza un menú existente.\"\"\"\n    try:\n        menu = await ModuloMenuService.actualizar_menu(menu_id, menu_data)\n        return {\n            \"success\": True,\n            \"message\": f\"Menú '{menu.nombre}' actualizado exitosamente.\",\n            \"data\": menu\n        }",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\modulos\\presentation\\endpoints_menus.py",
    "line": 152,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "    menu_id: UUID = Path(..., description=\"ID del menú\"),\n    menu_data: ModuloMenuUpdate = Body(...),\n    current_user: UsuarioReadWithRoles = Depends(get_current_active_user)\n):\n    \"\"\"Actualiza un menú existente.\"\"\"\n    try:\n        menu = await ModuloMenuService.actualizar_menu(menu_id, menu_data)\n        return {\n            \"success\": True,\n            \"message\": f\"Menú '{menu.nombre}' actualizado exitosamente.\",\n            \"data\": menu\n        }",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\modulos\\presentation\\endpoints_menus.py",
    "line": 167,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "\n@router.delete(\n    \"/{menu_id}/\",\n    status_code=status.HTTP_200_OK,\n    summary=\"Eliminar menú\"\n)\n@require_super_admin()\nasync def eliminar_menu(\n    menu_id: UUID = Path(..., description=\"ID del menú\"),\n    current_user: UsuarioReadWithRoles = Depends(get_current_active_user)\n):\n    \"\"\"Elimina un menú.\"\"\"",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\modulos\\presentation\\endpoints_menus.py",
    "line": 167,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "\n@router.delete(\n    \"/{menu_id}/\",\n    status_code=status.HTTP_200_OK,\n    summary=\"Eliminar menú\"\n)\n@require_super_admin()\nasync def eliminar_menu(\n    menu_id: UUID = Path(..., description=\"ID del menú\"),\n    current_user: UsuarioReadWithRoles = Depends(get_current_active_user)\n):\n    \"\"\"Elimina un menú.\"\"\"",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\modulos\\presentation\\endpoints_modulos.py",
    "line": 21,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "from app.modules.modulos.presentation.schemas import (\n    ModuloRead, ModuloCreate, ModuloUpdate, ModuloResponse, PaginatedModuloResponse\n)\nfrom app.modules.modulos.application.services.modulo_service import ModuloService\nfrom app.core.exceptions import CustomException\nfrom app.api.deps import get_current_active_user\nfrom app.core.authorization.lbac import require_super_admin\nfrom app.modules.users.presentation.schemas import UsuarioReadWithRoles\n\nlogger = logging.getLogger(__name__)\n\nrouter = ",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\modulos\\presentation\\endpoints_modulos.py",
    "line": 21,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "from app.modules.modulos.presentation.schemas import (\n    ModuloRead, ModuloCreate, ModuloUpdate, ModuloResponse, PaginatedModuloResponse\n)\nfrom app.modules.modulos.application.services.modulo_service import ModuloService\nfrom app.core.exceptions import CustomException\nfrom app.api.deps import get_current_active_user\nfrom app.core.authorization.lbac import require_super_admin\nfrom app.modules.users.presentation.schemas import UsuarioReadWithRoles\n\nlogger = logging.getLogger(__name__)\n\nrouter = ",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\modulos\\presentation\\endpoints_modulos.py",
    "line": 293,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "    modulo_id: UUID = Path(..., description=\"ID del módulo\"),\n    modulo_data: ModuloUpdate = Body(...),\n    current_user: UsuarioReadWithRoles = Depends(get_current_active_user)\n):\n    \"\"\"Actualiza un módulo existente en el catálogo del sistema. Solo accesible para super administradores.\"\"\"\n    logger.info(f\"Solicitud PUT /modulos/{modulo_id}/ recibida\")\n    \n    try:\n        modulo = await ModuloService.actualizar_modulo(modulo_id, modulo_data)\n        \n        logger.info(f\"Módulo {modulo_id}",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\modulos\\presentation\\endpoints_modulos.py",
    "line": 293,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "    modulo_id: UUID = Path(..., description=\"ID del módulo\"),\n    modulo_data: ModuloUpdate = Body(...),\n    current_user: UsuarioReadWithRoles = Depends(get_current_active_user)\n):\n    \"\"\"Actualiza un módulo existente en el catálogo del sistema. Solo accesible para super administradores.\"\"\"\n    logger.info(f\"Solicitud PUT /modulos/{modulo_id}/ recibida\")\n    \n    try:\n        modulo = await ModuloService.actualizar_modulo(modulo_id, modulo_data)\n        \n        logger.info(f\"Módulo {modulo_id}",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\modulos\\presentation\\endpoints_plantillas.py",
    "line": 11,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "from app.modules.modulos.presentation.schemas import (\n    ModuloRolPlantillaRead, ModuloRolPlantillaCreate, ModuloRolPlantillaUpdate\n)\nfrom app.modules.modulos.application.services.modulo_rol_plantilla_service import ModuloRolPlantillaService\nfrom app.core.exceptions import CustomException\nfrom app.api.deps import get_current_active_user\nfrom app.core.authorization.lbac import require_super_admin\nfrom app.modules.users.presentation.schemas import UsuarioReadWithRoles\n\nlogger = logging.getLogger",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\modulos\\presentation\\endpoints_plantillas.py",
    "line": 11,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "from app.modules.modulos.presentation.schemas import (\n    ModuloRolPlantillaRead, ModuloRolPlantillaCreate, ModuloRolPlantillaUpdate\n)\nfrom app.modules.modulos.application.services.modulo_rol_plantilla_service import ModuloRolPlantillaService\nfrom app.core.exceptions import CustomException\nfrom app.api.deps import get_current_active_user\nfrom app.core.authorization.lbac import require_super_admin\nfrom app.modules.users.presentation.schemas import UsuarioReadWithRoles\n\nlogger = logging.getLogger",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\modulos\\presentation\\endpoints_plantillas.py",
    "line": 102,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "    plantilla_id: UUID = Path(..., description=\"ID de la plantilla\"),\n    plantilla_data: ModuloRolPlantillaUpdate = Body(...),\n    current_user: UsuarioReadWithRoles = Depends(get_current_active_user)\n):\n    \"\"\"Actualiza una plantilla existente.\"\"\"\n    try:\n        plantilla = await ModuloRolPlantillaService.actualizar_plantilla(plantilla_id, plantilla_data)\n        return {\n            \"success\": True,\n            \"message\": f\"Plantilla '{plantilla.nombre_rol}' actualizada exitosamente.\",\n    ",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\modulos\\presentation\\endpoints_plantillas.py",
    "line": 102,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "    plantilla_id: UUID = Path(..., description=\"ID de la plantilla\"),\n    plantilla_data: ModuloRolPlantillaUpdate = Body(...),\n    current_user: UsuarioReadWithRoles = Depends(get_current_active_user)\n):\n    \"\"\"Actualiza una plantilla existente.\"\"\"\n    try:\n        plantilla = await ModuloRolPlantillaService.actualizar_plantilla(plantilla_id, plantilla_data)\n        return {\n            \"success\": True,\n            \"message\": f\"Plantilla '{plantilla.nombre_rol}' actualizada exitosamente.\",\n    ",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\modulos\\presentation\\endpoints_plantillas.py",
    "line": 117,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "\n@router.delete(\n    \"/{plantilla_id}/\",\n    status_code=status.HTTP_200_OK,\n    summary=\"Eliminar plantilla\"\n)\n@require_super_admin()\nasync def eliminar_plantilla(\n    plantilla_id: UUID = Path(..., description=\"ID de la plantilla\"),\n    current_user: UsuarioReadWithRoles = Depends(get_current_active_user)\n):\n    \"\"\"Elimina una plantilla.\"\"\"",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\modulos\\presentation\\endpoints_plantillas.py",
    "line": 117,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "\n@router.delete(\n    \"/{plantilla_id}/\",\n    status_code=status.HTTP_200_OK,\n    summary=\"Eliminar plantilla\"\n)\n@require_super_admin()\nasync def eliminar_plantilla(\n    plantilla_id: UUID = Path(..., description=\"ID de la plantilla\"),\n    current_user: UsuarioReadWithRoles = Depends(get_current_active_user)\n):\n    \"\"\"Elimina una plantilla.\"\"\"",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\modulos\\presentation\\endpoints_secciones.py",
    "line": 10,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "\nfrom app.modules.modulos.presentation.schemas import ModuloSeccionRead, ModuloSeccionCreate, ModuloSeccionUpdate\nfrom app.modules.modulos.application.services.modulo_seccion_service import ModuloSeccionService\nfrom app.core.exceptions import CustomException\nfrom app.api.deps import get_current_active_user\nfrom app.core.authorization.lbac import require_super_admin\nfrom app.modules.users.presentation.schemas import UsuarioReadWithRoles\n\nlogger = logging.getLogger(__name__)\n\nrouter = APIRouter()\n",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\modulos\\presentation\\endpoints_secciones.py",
    "line": 10,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "\nfrom app.modules.modulos.presentation.schemas import ModuloSeccionRead, ModuloSeccionCreate, ModuloSeccionUpdate\nfrom app.modules.modulos.application.services.modulo_seccion_service import ModuloSeccionService\nfrom app.core.exceptions import CustomException\nfrom app.api.deps import get_current_active_user\nfrom app.core.authorization.lbac import require_super_admin\nfrom app.modules.users.presentation.schemas import UsuarioReadWithRoles\n\nlogger = logging.getLogger(__name__)\n\nrouter = APIRouter()\n",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\modulos\\presentation\\endpoints_secciones.py",
    "line": 100,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "    seccion_id: UUID = Path(..., description=\"ID de la sección\"),\n    seccion_data: ModuloSeccionUpdate = Body(...),\n    current_user: UsuarioReadWithRoles = Depends(get_current_active_user)\n):\n    \"\"\"Actualiza una sección existente.\"\"\"\n    try:\n        seccion = await ModuloSeccionService.actualizar_seccion(seccion_id, seccion_data)\n        return {\n            \"success\": True,\n            \"message\": f\"Sección '{seccion.nombre}' actualizada exitosamente.\",\n            \"data\": seccion\n        }",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\modulos\\presentation\\endpoints_secciones.py",
    "line": 100,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "    seccion_id: UUID = Path(..., description=\"ID de la sección\"),\n    seccion_data: ModuloSeccionUpdate = Body(...),\n    current_user: UsuarioReadWithRoles = Depends(get_current_active_user)\n):\n    \"\"\"Actualiza una sección existente.\"\"\"\n    try:\n        seccion = await ModuloSeccionService.actualizar_seccion(seccion_id, seccion_data)\n        return {\n            \"success\": True,\n            \"message\": f\"Sección '{seccion.nombre}' actualizada exitosamente.\",\n            \"data\": seccion\n        }",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\modulos\\presentation\\endpoints_secciones.py",
    "line": 115,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "\n@router.delete(\n    \"/{seccion_id}/\",\n    status_code=status.HTTP_200_OK,\n    summary=\"Eliminar sección\"\n)\n@require_super_admin()\nasync def eliminar_seccion(\n    seccion_id: UUID = Path(..., description=\"ID de la sección\"),\n    current_user: UsuarioReadWithRoles = Depends(get_current_active_user)\n):\n    \"\"\"Elimina una sección.\"\"\"",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\modulos\\presentation\\endpoints_secciones.py",
    "line": 115,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "\n@router.delete(\n    \"/{seccion_id}/\",\n    status_code=status.HTTP_200_OK,\n    summary=\"Eliminar sección\"\n)\n@require_super_admin()\nasync def eliminar_seccion(\n    seccion_id: UUID = Path(..., description=\"ID de la sección\"),\n    current_user: UsuarioReadWithRoles = Depends(get_current_active_user)\n):\n    \"\"\"Elimina una sección.\"\"\"",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\modulos\\presentation\\schemas.py",
    "line": 326,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "\nclass ClienteModuloUpdate(BaseModel):\n    \"\"\"Schema para actualizar configuración de módulo activo.\"\"\"\n    esta_activo: Optional[bool] = None\n    fecha_vencimiento: Optional[datetime] = None\n    modo_prueba: Optional[bool] = None\n    fecha_fin_prueba: Optional[datetime] = None\n    configuracion_json: Optional[Dict[str, Any]] = None\n    limite_usuarios: Optional[int] = Field(None, ge=0)\n    limite_registros: Optional[int] = Field(None, ge=0)\n    limite_transacciones_mes: Optional[int] = Field(No",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\modulos\\presentation\\schemas.py",
    "line": 430,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "\nclass ModuloRolPlantillaUpdate(BaseModel):\n    \"\"\"Schema para actualizar una plantilla.\"\"\"\n    nombre_rol: Optional[str] = Field(None, max_length=50)\n    descripcion: Optional[str] = Field(None, max_length=255)\n    nivel_acceso: Optional[int] = Field(None, ge=1, le=5)\n    permisos_json: Optional[str] = None\n    es_activo: Optional[bool] = None\n    orden: Optional[int] = Field(None, ge=0)\n\n\nclass ModuloRolPlantillaRead(ModuloRolPlantillaBase):",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\modulos\\application\\services\\cliente_modulo_service.py",
    "line": 36,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "from app.modules.modulos.presentation.schemas import (\n    ClienteModuloCreate, ClienteModuloUpdate, ClienteModuloRead\n)\nfrom app.modules.modulos.application.helpers.rol_plantilla_applier import aplicar_plantillas_roles\nfrom app.infrastructure.database.connection_async import DatabaseConnection\n\nlogger = logging.getLogger(__name__)\n\n\nclass ClienteModuloService(BaseService):\n    \"\"\"\n    Servicio central para la administración de activación de módulos por cliente.",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\modulos\\application\\services\\cliente_modulo_service.py",
    "line": 336,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "            stmt = (\n                update(ClienteModuloTable)\n                .where(ClienteModuloTable.c.cliente_modulo_id == cliente_modulo_id)\n                .values(\n                    esta_activo=True,\n                    fecha_vencimiento=modulo_data.fecha_vencimiento,\n                    modo_prueba=modulo_data.modo_prueba,\n                    fecha_fin_prueba=modulo_data.fecha_fin_prueba,\n                    configuracion_json=configuracion_json_str,\n                    limite_usuari",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\modulos\\application\\services\\cliente_modulo_service.py",
    "line": 564,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "        \n        update_dict = {}\n        if limite_usuarios is not None:\n            update_dict['limite_usuarios'] = limite_usuarios\n        if limite_registros is not None:\n            update_dict['limite_registros'] = limite_registros\n        if limite_transacciones_mes is not None:\n            update_dict['limite_transacciones_mes'] = limite_transacciones_mes\n        \n        if not update_dict:\n            raise ValidationError(\n                detail=\"Debe proporcionar al menos un límite ",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\modulos\\application\\services\\cliente_modulo_service.py",
    "line": 566,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "        if limite_usuarios is not None:\n            update_dict['limite_usuarios'] = limite_usuarios\n        if limite_registros is not None:\n            update_dict['limite_registros'] = limite_registros\n        if limite_transacciones_mes is not None:\n            update_dict['limite_transacciones_mes'] = limite_transacciones_mes\n        \n        if not update_dict:\n            raise ValidationError(\n                detail=\"Debe proporcionar al menos un límite para actualizar.\",\n               ",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\modulos\\application\\services\\modulo_menu_service.py",
    "line": 17,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "import logging\nfrom sqlalchemy import select, update, delete, and_, or_, func as sql_func, Integer, case\nfrom uuid import UUID\n\nfrom app.infrastructure.database.tables_modulos import ModuloMenuTable, ModuloTable, ModuloSeccionTable, ClienteModuloTable\nfrom app.infrastructure.database.tables import RolMenuPermisoTable, UsuarioRolTable\nfrom app.infrastructure.database.queries_async import execute_query, execute_insert, execute_update, execute_procedure_params\nfrom app.core.exceptions import (\n    ",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\modulos\\application\\services\\modulo_menu_service.py",
    "line": 17,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "import logging\nfrom sqlalchemy import select, update, delete, and_, or_, func as sql_func, Integer, case\nfrom uuid import UUID\n\nfrom app.infrastructure.database.tables_modulos import ModuloMenuTable, ModuloTable, ModuloSeccionTable, ClienteModuloTable\nfrom app.infrastructure.database.tables import RolMenuPermisoTable, UsuarioRolTable\nfrom app.infrastructure.database.queries_async import execute_query, execute_insert, execute_update, execute_procedure_params\nfrom app.core.exceptions import (\n    ",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\modulos\\application\\services\\modulo_menu_service.py",
    "line": 22,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "from app.infrastructure.database.tables import RolMenuPermisoTable, UsuarioRolTable\nfrom app.infrastructure.database.queries_async import execute_query, execute_insert, execute_update, execute_procedure_params\nfrom app.core.exceptions import (\n    ValidationError,\n    ConflictError,\n    NotFoundError,\n    ServiceError,\n    DatabaseError\n)\nfrom app.core.application.base_service import BaseService\nfrom app.modules.modulos.presentation.schemas import (\n    ModuloMenuCreate, ModuloMenuUpdate, Modulo",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\modulos\\application\\services\\modulo_menu_service.py",
    "line": 22,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "from app.infrastructure.database.tables import RolMenuPermisoTable, UsuarioRolTable\nfrom app.infrastructure.database.queries_async import execute_query, execute_insert, execute_update, execute_procedure_params\nfrom app.core.exceptions import (\n    ValidationError,\n    ConflictError,\n    NotFoundError,\n    ServiceError,\n    DatabaseError\n)\nfrom app.core.application.base_service import BaseService\nfrom app.modules.modulos.presentation.schemas import (\n    ModuloMenuCreate, ModuloMenuUpdate, Modulo",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\modulos\\application\\services\\modulo_menu_service.py",
    "line": 32,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "from app.modules.modulos.presentation.schemas import (\n    ModuloMenuCreate, ModuloMenuUpdate, ModuloMenuRead, MenuUsuarioResponse\n)\nfrom app.modules.modulos.application.helpers.menu_transformer import transformar_sp_menu_usuario\nfrom app.infrastructure.database.connection_async import DatabaseConnection\n\nlogger = logging.getLogger(__name__)\n\n\nclass ModuloMenuService(BaseService):\n    \"\"\"\n    Servicio central para la administración de menús de módulos.",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\modulos\\application\\services\\modulo_menu_service.py",
    "line": 927,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "                query_raw = f\"\"\"\n                SELECT p.menu_id,\n                       MAX(CAST(p.puede_ver AS INT)) AS puede_ver,\n                       MAX(CAST(p.puede_crear AS INT)) AS puede_crear,\n                       MAX(CAST(p.puede_editar AS INT)) AS puede_editar,\n                       MAX(CAST(p.puede_eliminar AS INT)) AS puede_eliminar,\n                       MAX(CAST(p.puede_exportar AS INT)) AS puede_exportar,\n                       MAX(CAST(p.puede_imprimir AS INT)) AS puede_i",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\modulos\\application\\services\\modulo_menu_service.py",
    "line": 927,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "                query_raw = f\"\"\"\n                SELECT p.menu_id,\n                       MAX(CAST(p.puede_ver AS INT)) AS puede_ver,\n                       MAX(CAST(p.puede_crear AS INT)) AS puede_crear,\n                       MAX(CAST(p.puede_editar AS INT)) AS puede_editar,\n                       MAX(CAST(p.puede_eliminar AS INT)) AS puede_eliminar,\n                       MAX(CAST(p.puede_exportar AS INT)) AS puede_exportar,\n                       MAX(CAST(p.puede_imprimir AS INT)) AS puede_i",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\modulos\\application\\services\\modulo_menu_service.py",
    "line": 927,
    "issue": "Query SQL directa toca tabla rol_menu_permiso sin cliente_id visible",
    "severity": "high",
    "tabla": "rol_menu_permiso",
    "context": "                query_raw = f\"\"\"\n                SELECT p.menu_id,\n                       MAX(CAST(p.puede_ver AS INT)) AS puede_ver,\n                       MAX(CAST(p.puede_crear AS INT)) AS puede_crear,\n                       MAX(CAST(p.puede_editar AS INT)) AS puede_editar,\n                       MAX(CAST(p.puede_eliminar AS INT)) AS puede_eliminar,\n                       MAX(CAST(p.puede_exportar AS INT)) AS puede_exportar,\n                       MAX(CAST(p.puede_imprimir AS INT)) AS puede_i",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\modulos\\application\\services\\modulo_menu_service.py",
    "line": 927,
    "issue": "Query SQL directa toca tabla usuario_rol sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario_rol",
    "context": "                query_raw = f\"\"\"\n                SELECT p.menu_id,\n                       MAX(CAST(p.puede_ver AS INT)) AS puede_ver,\n                       MAX(CAST(p.puede_crear AS INT)) AS puede_crear,\n                       MAX(CAST(p.puede_editar AS INT)) AS puede_editar,\n                       MAX(CAST(p.puede_eliminar AS INT)) AS puede_eliminar,\n                       MAX(CAST(p.puede_exportar AS INT)) AS puede_exportar,\n                       MAX(CAST(p.puede_imprimir AS INT)) AS puede_i",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\modulos\\application\\services\\modulo_rol_plantilla_service.py",
    "line": 17,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "import json\nfrom sqlalchemy import select, update, delete, and_, func as sql_func\nfrom uuid import UUID\n\nfrom app.infrastructure.database.tables_modulos import ModuloRolPlantillaTable, ModuloTable\nfrom app.infrastructure.database.queries_async import execute_query, execute_insert, execute_update\nfrom app.core.exceptions import (\n    ValidationError,\n    ConflictError,\n    NotFoundError,\n    ServiceError,\n    DatabaseError",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\modulos\\application\\services\\modulo_rol_plantilla_service.py",
    "line": 21,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "from app.infrastructure.database.tables_modulos import ModuloRolPlantillaTable, ModuloTable\nfrom app.infrastructure.database.queries_async import execute_query, execute_insert, execute_update\nfrom app.core.exceptions import (\n    ValidationError,\n    ConflictError,\n    NotFoundError,\n    ServiceError,\n    DatabaseError\n)\nfrom app.core.application.base_service import BaseService\nfrom app.modules.modulos.presentation.schemas import (\n    ModuloRolPlantillaCreate, ModuloRolPlantillaUpdate, ModuloRo",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\modulos\\application\\services\\modulo_rol_plantilla_service.py",
    "line": 31,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "from app.modules.modulos.presentation.schemas import (\n    ModuloRolPlantillaCreate, ModuloRolPlantillaUpdate, ModuloRolPlantillaRead\n)\nfrom app.infrastructure.database.connection_async import DatabaseConnection\n\nlogger = logging.getLogger(__name__)\n\n\nclass ModuloRolPlantillaService(BaseService):\n    \"\"\"\n    Servicio central para la administración de plantillas de roles de módulos.\n    \"\"\"",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\modulos\\application\\services\\modulo_rol_plantilla_service.py",
    "line": 66,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "        # Preparar datos para inserción\n        insert_data = {\n            'modulo_id': plantilla_data.modulo_id,\n            'nombre_rol': plantilla_data.nombre_rol,\n            'descripcion': plantilla_data.descripcion,\n            'nivel_acceso': plantilla_data.nivel_acceso,\n            'permisos_json': plantilla_data.permisos_json,\n            'es_activo': plantilla_data.es_activo,\n            'orden': plantilla_data.orden,\n        }\n\n        from sqlalchemy import insert",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\modulos\\application\\services\\modulo_rol_plantilla_service.py",
    "line": 136,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "    @BaseService.handle_service_errors\n    async def actualizar_plantilla(plantilla_id: UUID, plantilla_data: ModuloRolPlantillaUpdate) -> ModuloRolPlantillaRead:\n        \"\"\"\n        Actualiza una plantilla existente.\n        Solo accesible para SUPER ADMIN.\n        \"\"\"\n        logger.info(f\"Actualizando plantilla ID: {plantilla_id}\")\n\n        # Verificar que la plantilla existe\n        plantilla_existente = await ModuloRolPlantillaService.obtener_plantilla_por_id(plantilla_id)\n        if not pl",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\modulos\\application\\services\\modulo_rol_plantilla_service.py",
    "line": 151,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "\n        update_dict = plantilla_data.model_dump(exclude_unset=True)\n        \n        # Validar JSON de permisos si se está actualizando\n        if 'permisos_json' in update_dict and update_dict['permisos_json']:\n            await ModuloRolPlantillaService.validar_json_permisos(\n                update_dict['permisos_json'],\n                plantilla_existente.modulo_id\n            )\n\n        if not update_dict:\n            raise ValidationError(",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\modulos\\application\\services\\modulo_rol_plantilla_service.py",
    "line": 154,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "        # Validar JSON de permisos si se está actualizando\n        if 'permisos_json' in update_dict and update_dict['permisos_json']:\n            await ModuloRolPlantillaService.validar_json_permisos(\n                update_dict['permisos_json'],\n                plantilla_existente.modulo_id\n            )\n\n        if not update_dict:\n            raise ValidationError(\n                detail=\"No se proporcionaron campos para actualizar.\",\n                internal_code=\"NO_UPDATE_FIELDS\"\n        ",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\modulos\\application\\services\\modulo_rol_plantilla_service.py",
    "line": 156,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "            await ModuloRolPlantillaService.validar_json_permisos(\n                update_dict['permisos_json'],\n                plantilla_existente.modulo_id\n            )\n\n        if not update_dict:\n            raise ValidationError(\n                detail=\"No se proporcionaron campos para actualizar.\",\n                internal_code=\"NO_UPDATE_FIELDS\"\n            )\n\n        stmt = (",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\modulos\\application\\services\\modulo_rol_plantilla_service.py",
    "line": 160,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "\n        if not update_dict:\n            raise ValidationError(\n                detail=\"No se proporcionaron campos para actualizar.\",\n                internal_code=\"NO_UPDATE_FIELDS\"\n            )\n\n        stmt = (\n            update(ModuloRolPlantillaTable)\n            .where(ModuloRolPlantillaTable.c.plantilla_id == plantilla_id)\n            .values(**update_dict)\n            .returning(ModuloRolPlantillaTable)",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\modulos\\application\\services\\modulo_rol_plantilla_service.py",
    "line": 163,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "                detail=\"No se proporcionaron campos para actualizar.\",\n                internal_code=\"NO_UPDATE_FIELDS\"\n            )\n\n        stmt = (\n            update(ModuloRolPlantillaTable)\n            .where(ModuloRolPlantillaTable.c.plantilla_id == plantilla_id)\n            .values(**update_dict)\n            .returning(ModuloRolPlantillaTable)\n        )\n\n        resultado = await execute_update(",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\modulos\\application\\services\\modulo_rol_plantilla_service.py",
    "line": 182,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "                detail=\"No se pudo actualizar la plantilla.\",\n                internal_code=\"PLANTILLA_UPDATE_FAILED\"\n            )\n\n        logger.info(f\"Plantilla ID {plantilla_id} actualizada exitosamente.\")\n        return ModuloRolPlantillaRead(**resultado)\n\n    @staticmethod\n    @BaseService.handle_service_errors\n    async def eliminar_plantilla(plantilla_id: UUID) -> bool:\n        \"\"\"\n        Elimina una plantilla.",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\rbac\\presentation\\endpoints.py",
    "line": 24,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "# Importar Schemas\nfrom app.modules.rbac.presentation.schemas import RolCreate, RolUpdate, RolRead, PaginatedRolResponse, PermisoRead, PermisoUpdatePayload\n\n# Importar Servicio\nfrom app.modules.rbac.application.services.rol_service import RolService\n\n# Importar Excepciones personalizadas\nfrom app.core.exceptions import CustomException\n\n# Importar Dependencias de Autorización\nfrom app.api.deps import get_current_active_user, RoleChecker\n",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\rbac\\presentation\\endpoints.py",
    "line": 236,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "    Devuelve una lista de todos los roles activos **del cliente actual y roles del sistema**.\n    Ideal para selectores y listas desplegables en interfaces de usuario.\n\n    **Permisos requeridos:**\n    - Rol 'Administrador'\n\n    **Respuestas:**\n    - 200: Lista simple recuperada exitosamente\n    - 500: Error interno del servidor\n    \"\"\",\n    dependencies=[Depends(require_admin)]\n)",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\rbac\\presentation\\endpoints.py",
    "line": 236,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "    Devuelve una lista de todos los roles activos **del cliente actual y roles del sistema**.\n    Ideal para selectores y listas desplegables en interfaces de usuario.\n\n    **Permisos requeridos:**\n    - Rol 'Administrador'\n\n    **Respuestas:**\n    - 200: Lista simple recuperada exitosamente\n    - 500: Error interno del servidor\n    \"\"\",\n    dependencies=[Depends(require_admin)]\n)",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\rbac\\presentation\\endpoints.py",
    "line": 377,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": ")\nasync def update_rol(\n    rol_id: UUID = Path(..., description=\"ID del rol\"),\n    rol_in: RolUpdate = Body(...),\n    current_user: Any = Depends(get_current_active_user)\n):\n    \"\"\"\n    Endpoint para actualizar parcialmente un rol existente **del cliente del usuario**.\n\n    Args:\n        rol_id: Identificador único del rol a actualizar.\n        rol_in: Campos a actualizar (actualización parcial).",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\rbac\\presentation\\endpoints.py",
    "line": 377,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": ")\nasync def update_rol(\n    rol_id: UUID = Path(..., description=\"ID del rol\"),\n    rol_in: RolUpdate = Body(...),\n    current_user: Any = Depends(get_current_active_user)\n):\n    \"\"\"\n    Endpoint para actualizar parcialmente un rol existente **del cliente del usuario**.\n\n    Args:\n        rol_id: Identificador único del rol a actualizar.\n        rol_in: Campos a actualizar (actualización parcial).",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\rbac\\presentation\\endpoints.py",
    "line": 379,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "    rol_id: UUID = Path(..., description=\"ID del rol\"),\n    rol_in: RolUpdate = Body(...),\n    current_user: Any = Depends(get_current_active_user)\n):\n    \"\"\"\n    Endpoint para actualizar parcialmente un rol existente **del cliente del usuario**.\n\n    Args:\n        rol_id: Identificador único del rol a actualizar.\n        rol_in: Campos a actualizar (actualización parcial).\n        current_user: Usuario autenticado y activo (inyectado por dependencia).\n",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\rbac\\presentation\\endpoints.py",
    "line": 379,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "    rol_id: UUID = Path(..., description=\"ID del rol\"),\n    rol_in: RolUpdate = Body(...),\n    current_user: Any = Depends(get_current_active_user)\n):\n    \"\"\"\n    Endpoint para actualizar parcialmente un rol existente **del cliente del usuario**.\n\n    Args:\n        rol_id: Identificador único del rol a actualizar.\n        rol_in: Campos a actualizar (actualización parcial).\n        current_user: Usuario autenticado y activo (inyectado por dependencia).\n",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\rbac\\presentation\\endpoints.py",
    "line": 398,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "    \n    update_data = rol_in.model_dump(exclude_unset=True)\n    if not update_data:\n         logger.warning(f\"Intento de actualizar rol {rol_id} sin datos\")\n         raise HTTPException(\n             status_code=status.HTTP_400_BAD_REQUEST,\n             detail=\"Se debe proporcionar al menos un campo para actualizar el rol.\"\n         )\n\n    try:\n        # ✅ VALIDAR: El rol debe pertenecer al cliente o ser del sistema (y tener permiso)\n        rol_existente = await RolService.obtener_rol_por_id(r",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\rbac\\presentation\\endpoints.py",
    "line": 399,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "    update_data = rol_in.model_dump(exclude_unset=True)\n    if not update_data:\n         logger.warning(f\"Intento de actualizar rol {rol_id} sin datos\")\n         raise HTTPException(\n             status_code=status.HTTP_400_BAD_REQUEST,\n             detail=\"Se debe proporcionar al menos un campo para actualizar el rol.\"\n         )\n\n    try:\n        # ✅ VALIDAR: El rol debe pertenecer al cliente o ser del sistema (y tener permiso)\n        rol_existente = await RolService.obtener_rol_por_id(rol_id",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\rbac\\presentation\\endpoints.py",
    "line": 433,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "# ----------------------------------------------------------------------\n@router.delete(\n    \"/{rol_id}/\",\n    response_model=RolRead,\n    summary=\"Desactivar un rol (Borrado Lógico)\",\n    description=\"\"\"\n    Desactiva un rol estableciendo su estado 'es_activo' a False (borrado lógico).\n\n    **Permisos requeridos:**\n    - Rol 'Administrador'\n\n    **Notas:**",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\rbac\\presentation\\endpoints.py",
    "line": 495,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "    except Exception as e:\n        logger.exception(f\"Error inesperado en endpoint DELETE /roles/{rol_id}/\")\n        raise HTTPException(status_code=status.HTTP_500_INTERNAL_SERVER_ERROR, detail=\"Error interno del servidor al desactivar el rol.\")\n\n\n# ----------------------------------------------------------------------\n# --- Endpoint para Reactivar un Rol ---\n# ----------------------------------------------------------------------\n@router.post(\n    \"/{rol_id}/reactivate/\",\n    response_model=Ro",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\rbac\\presentation\\endpoints.py",
    "line": 653,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": ")\nasync def update_permisos_rol(\n    rol_id: UUID = Path(..., title=\"ID del Rol\", description=\"El ID del rol cuyos permisos se actualizarán\"),\n    payload: PermisoUpdatePayload = Body(..., description=\"Objeto que contiene la lista completa de los nuevos permisos para el rol\"),\n    current_user: Any = Depends(get_current_active_user)\n):\n    \"\"\"\n    Endpoint para sobrescribir la lista de permisos de un rol.\n\n    Args:\n        rol_id: Identificador único del rol a actualizar.\n        payload: Objet",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\rbac\\presentation\\endpoints.py",
    "line": 655,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "    rol_id: UUID = Path(..., title=\"ID del Rol\", description=\"El ID del rol cuyos permisos se actualizarán\"),\n    payload: PermisoUpdatePayload = Body(..., description=\"Objeto que contiene la lista completa de los nuevos permisos para el rol\"),\n    current_user: Any = Depends(get_current_active_user)\n):\n    \"\"\"\n    Endpoint para sobrescribir la lista de permisos de un rol.\n\n    Args:\n        rol_id: Identificador único del rol a actualizar.\n        payload: Objeto que contiene la lista completa ",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\rbac\\presentation\\endpoints.py",
    "line": 655,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "    rol_id: UUID = Path(..., title=\"ID del Rol\", description=\"El ID del rol cuyos permisos se actualizarán\"),\n    payload: PermisoUpdatePayload = Body(..., description=\"Objeto que contiene la lista completa de los nuevos permisos para el rol\"),\n    current_user: Any = Depends(get_current_active_user)\n):\n    \"\"\"\n    Endpoint para sobrescribir la lista de permisos de un rol.\n\n    Args:\n        rol_id: Identificador único del rol a actualizar.\n        payload: Objeto que contiene la lista completa ",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\rbac\\presentation\\endpoints_permisos.py",
    "line": 24,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "# ✅ Importar Schemas actualizados desde schemas.py\nfrom app.modules.rbac.presentation.schemas import PermisoRead, PermisoBase, RolMenuPermisoRead, RolMenuPermisoUpdate\n\n# ✅ Schema para crear/actualizar permisos sin menu_id (viene de la URL)\nclass PermisoCreateUpdate(BaseModel):\n    \"\"\"\n    Schema para crear/actualizar permisos en endpoint PUT.\n    No incluye menu_id porque viene de la URL.\n    \"\"\"\n    puede_ver: Optional[bool] = Field(None, description=\"Permiso para ver el menú\")\n    puede_crear",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\rbac\\presentation\\endpoints_permisos.py",
    "line": 98,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "    menu_id: UUID = Path(..., description=\"ID del menú\"),\n    permisos_in: PermisoCreateUpdate = Body(...),\n    current_user: Any = Depends(get_current_active_user)\n):\n    \"\"\"\n    Asigna o actualiza los permisos `puede_ver`, `puede_editar`, `puede_eliminar`\n    para el `rol_id` sobre el `menu_id`.\n\n    Args:\n        rol_id: ID del rol al que se le asigna el permiso.\n        menu_id: ID del menú sobre el que se asigna el permiso.\n        permisos_in: Objeto con los flags booleanos (puede_ver, pue",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\rbac\\presentation\\endpoints_permisos.py",
    "line": 292,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "# ----------------------------------------------------------------------\n@router.delete(\n    \"/roles/{rol_id}/menus/{menu_id}/\",\n    response_model=Dict[str, str],\n    summary=\"Revocar el permiso de un rol sobre un menú\",\n    description=\"\"\"\n    Elimina (revoca) la asignación de permisos entre un rol y un menú.\n\n    **Permisos requeridos:**\n    - Rol 'Administrador'\n\n    **Respuestas:**",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\rbac\\presentation\\endpoints_permisos.py",
    "line": 343,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "    except Exception as e:\n        logger.exception(f\"Error inesperado en endpoint DELETE /permisos/roles/{rol_id}/menus/{menu_id}/\")\n        raise HTTPException(status_code=status.HTTP_500_INTERNAL_SERVER_ERROR, detail=\"Error interno del servidor al revocar el permiso.\")",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\rbac\\presentation\\schemas.py",
    "line": 255,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "\nclass RolUpdate(BaseModel):\n    \"\"\"\n    Schema para actualización parcial de roles.\n    \n    Todos los campos son opcionales.\n    \"\"\"\n    \n    nombre: Optional[str] = Field(\n        None,\n        min_length=3,\n        max_length=50,",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\rbac\\presentation\\schemas.py",
    "line": 473,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "\nclass PermisoUpdatePayload(BaseModel):\n    \"\"\"\n    Schema para actualización masiva de permisos de un rol.\n    \"\"\"\n    \n    permisos: List[PermisoBase] = Field(\n        ...,\n        description=\"Lista completa de permisos para asignar al rol\",\n        examples=[[\n            {\"menu_id\": 1, \"puede_ver\": True, \"puede_editar\": False, \"puede_eliminar\": False},\n            {\"menu_id\": 2, \"puede_ver\": True, \"puede_editar\": True, \"puede_eliminar\": False}",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\rbac\\presentation\\schemas.py",
    "line": 648,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "\nclass RolMenuPermisoUpdate(BaseModel):\n    \"\"\"\n    Schema para actualización parcial de permisos rol-menú.\n    \n    ✅ ACTUALIZADO: Incluye todos los permisos extendidos de la tabla rol_menu_permiso.\n    \n    Todos los campos son opcionales y solo se validan los que se proporcionen.\n    Diseñado específicamente para operaciones PATCH que actualizan solo\n    algunos permisos específicos.\n    \"\"\"\n    ",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\rbac\\presentation\\schemas.py",
    "line": 648,
    "issue": "Query SQL directa toca tabla rol_menu_permiso sin cliente_id visible",
    "severity": "high",
    "tabla": "rol_menu_permiso",
    "context": "\nclass RolMenuPermisoUpdate(BaseModel):\n    \"\"\"\n    Schema para actualización parcial de permisos rol-menú.\n    \n    ✅ ACTUALIZADO: Incluye todos los permisos extendidos de la tabla rol_menu_permiso.\n    \n    Todos los campos son opcionales y solo se validan los que se proporcionen.\n    Diseñado específicamente para operaciones PATCH que actualizan solo\n    algunos permisos específicos.\n    \"\"\"\n    ",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\rbac\\presentation\\schemas.py",
    "line": 714,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "    @model_validator(mode='after')\n    def validar_consistencia_permisos_parciales(self) -> 'RolMenuPermisoUpdate':\n        \"\"\"\n        Valida consistencias en actualizaciones parciales de permisos.\n        \n        Aplica las mismas reglas de negocio que el validador base, pero\n        considerando que algunos campos pueden ser None (no actualizados).\n        \"\"\"\n        # Solo validar si todos los campos relevantes están presentes\n        puede_ver = self.puede_ver\n        puede_crear = self.p",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\rbac\\presentation\\schemas.py",
    "line": 835,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "\nclass RolMenuPermisoBulkUpdate(BaseModel):\n    \"\"\"\n    Schema para actualización masiva de permisos rol-menú.\n    \n    Utilizado en operaciones que actualizan múltiples permisos\n    simultáneamente para un rol específico.\n    \"\"\"\n    \n    permisos: dict[UUID, Dict[str, bool]] = Field(\n        ...,\n        description=\"Diccionario donde las claves son menu_id (UUID) y los valores son diccionarios de permisos\",",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\rbac\\application\\services\\rol_service.py",
    "line": 12,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "from app.infrastructure.database.queries_async import (\n    execute_query, execute_insert, execute_update\n)\nfrom app.infrastructure.database.sql_constants import (\n    COUNT_ROLES_PAGINATED, SELECT_ROLES_PAGINATED,\n    DEACTIVATE_ROL, REACTIVATE_ROL,\n    SELECT_PERMISOS_POR_ROL, DELETE_PERMISOS_POR_ROL, INSERT_PERMISO_ROL\n)\n\n# 📋 SCHEMAS\nfrom app.modules.rbac.presentation.schemas import (\n    RolRead, PaginatedRolResponse, PermisoRead, PermisoUpdatePayload, PermisoBase",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\rbac\\application\\services\\rol_service.py",
    "line": 15,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "from app.infrastructure.database.sql_constants import (\n    COUNT_ROLES_PAGINATED, SELECT_ROLES_PAGINATED,\n    DEACTIVATE_ROL, REACTIVATE_ROL,\n    SELECT_PERMISOS_POR_ROL, DELETE_PERMISOS_POR_ROL, INSERT_PERMISO_ROL\n)\n\n# 📋 SCHEMAS\nfrom app.modules.rbac.presentation.schemas import (\n    RolRead, PaginatedRolResponse, PermisoRead, PermisoUpdatePayload, PermisoBase\n)\n\n# 🚨 EXCEPCIONES - Nuevo sistema de manejo de errores",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\rbac\\application\\services\\rol_service.py",
    "line": 17,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "    DEACTIVATE_ROL, REACTIVATE_ROL,\n    SELECT_PERMISOS_POR_ROL, DELETE_PERMISOS_POR_ROL, INSERT_PERMISO_ROL\n)\n\n# 📋 SCHEMAS\nfrom app.modules.rbac.presentation.schemas import (\n    RolRead, PaginatedRolResponse, PermisoRead, PermisoUpdatePayload, PermisoBase\n)\n\n# 🚨 EXCEPCIONES - Nuevo sistema de manejo de errores\nfrom app.core.exceptions import (\n    ValidationError, NotFoundError, ConflictError, ServiceError, DatabaseError",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\rbac\\application\\services\\rol_service.py",
    "line": 22,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "from app.modules.rbac.presentation.schemas import (\n    RolRead, PaginatedRolResponse, PermisoRead, PermisoUpdatePayload, PermisoBase\n)\n\n# 🚨 EXCEPCIONES - Nuevo sistema de manejo de errores\nfrom app.core.exceptions import (\n    ValidationError, NotFoundError, ConflictError, ServiceError, DatabaseError\n)\n\n# 🏗️ BASE SERVICE - Clase base para manejo consistente de errores\nfrom app.core.application.base_service import BaseService\n",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\rbac\\application\\services\\rol_service.py",
    "line": 149,
    "issue": "Query con text() toca tabla rol (verificar uso de cliente_id)",
    "severity": "medium",
    "tabla": "rol",
    "context": "        \n        tenant_context = try_get_tenant_context()\n        database_type = tenant_context.database_type if tenant_context else \"single\"\n        \n        # ✅ CORRECCIÓN: Para BD dedicadas, no filtrar por cliente_id (todos los roles pertenecen al mismo tenant)\n        if database_type == \"multi\":\n            # BD dedicada: buscar roles sin filtrar por cliente_id\n            QUERY = f\"\"\"\n            SELECT MIN(nivel_acceso) AS min_level\n            FROM rol\n            WHERE nombre IN ({pla",
    "type": "text() - tiene cliente_id"
  },
  {
    "file": "app\\modules\\rbac\\application\\services\\rol_service.py",
    "line": 222,
    "issue": "Query con text() toca tabla rol (verificar uso de cliente_id)",
    "severity": "medium",
    "tabla": "rol",
    "context": "        \n        tenant_context = try_get_tenant_context()\n        database_type = tenant_context.database_type if tenant_context else \"single\"\n        \n        try:\n            # ✅ Para BD dedicadas, no filtrar por cliente_id (todos los roles pertenecen al mismo tenant)\n            if database_type == \"multi\":\n                query = \"\"\"\n                SELECT ISNULL(MAX(r.nivel_acceso), 1) as max_level\n                FROM usuario_rol ur\n                INNER JOIN rol r ON ur.rol_id = r.rol_id",
    "type": "text() - tiene cliente_id"
  },
  {
    "file": "app\\modules\\rbac\\application\\services\\rol_service.py",
    "line": 222,
    "issue": "Query con text() toca tabla usuario (verificar uso de cliente_id)",
    "severity": "medium",
    "tabla": "usuario",
    "context": "        \n        tenant_context = try_get_tenant_context()\n        database_type = tenant_context.database_type if tenant_context else \"single\"\n        \n        try:\n            # ✅ Para BD dedicadas, no filtrar por cliente_id (todos los roles pertenecen al mismo tenant)\n            if database_type == \"multi\":\n                query = \"\"\"\n                SELECT ISNULL(MAX(r.nivel_acceso), 1) as max_level\n                FROM usuario_rol ur\n                INNER JOIN rol r ON ur.rol_id = r.rol_id",
    "type": "text() - tiene cliente_id"
  },
  {
    "file": "app\\modules\\rbac\\application\\services\\rol_service.py",
    "line": 222,
    "issue": "Query con text() toca tabla usuario_rol (verificar uso de cliente_id)",
    "severity": "medium",
    "tabla": "usuario_rol",
    "context": "        \n        tenant_context = try_get_tenant_context()\n        database_type = tenant_context.database_type if tenant_context else \"single\"\n        \n        try:\n            # ✅ Para BD dedicadas, no filtrar por cliente_id (todos los roles pertenecen al mismo tenant)\n            if database_type == \"multi\":\n                query = \"\"\"\n                SELECT ISNULL(MAX(r.nivel_acceso), 1) as max_level\n                FROM usuario_rol ur\n                INNER JOIN rol r ON ur.rol_id = r.rol_id",
    "type": "text() - tiene cliente_id"
  },
  {
    "file": "app\\modules\\rbac\\application\\services\\rol_service.py",
    "line": 242,
    "issue": "Query con text() toca tabla rol (verificar uso de cliente_id)",
    "severity": "medium",
    "tabla": "rol",
    "context": "                from sqlalchemy import text\n                # ✅ FASE 4B: Usar text().bindparams() con parámetros nombrados\n                result = await execute_query(\n                    text(GET_USER_MAX_ACCESS_LEVEL).bindparams(\n                        usuario_id=usuario_id,\n                        cliente_id=cliente_id\n                    ),\n                    client_id=cliente_id\n                )\n            \n            if result and result[0]['max_level'] is not None:\n                #",
    "type": "text() - tiene cliente_id"
  },
  {
    "file": "app\\modules\\rbac\\application\\services\\rol_service.py",
    "line": 242,
    "issue": "Query con text() toca tabla usuario (verificar uso de cliente_id)",
    "severity": "medium",
    "tabla": "usuario",
    "context": "                from sqlalchemy import text\n                # ✅ FASE 4B: Usar text().bindparams() con parámetros nombrados\n                result = await execute_query(\n                    text(GET_USER_MAX_ACCESS_LEVEL).bindparams(\n                        usuario_id=usuario_id,\n                        cliente_id=cliente_id\n                    ),\n                    client_id=cliente_id\n                )\n            \n            if result and result[0]['max_level'] is not None:\n                #",
    "type": "text() - tiene cliente_id"
  },
  {
    "file": "app\\modules\\rbac\\application\\services\\rol_service.py",
    "line": 244,
    "issue": "Query con text() toca tabla rol (verificar uso de cliente_id)",
    "severity": "medium",
    "tabla": "rol",
    "context": "                result = await execute_query(\n                    text(GET_USER_MAX_ACCESS_LEVEL).bindparams(\n                        usuario_id=usuario_id,\n                        cliente_id=cliente_id\n                    ),\n                    client_id=cliente_id\n                )\n            \n            if result and result[0]['max_level'] is not None:\n                # El valor de max_level no es NULL\n                return int(result[0]['max_level'])\n            \n            # Si no tiene",
    "type": "text() - tiene cliente_id"
  },
  {
    "file": "app\\modules\\rbac\\application\\services\\rol_service.py",
    "line": 244,
    "issue": "Query con text() toca tabla usuario (verificar uso de cliente_id)",
    "severity": "medium",
    "tabla": "usuario",
    "context": "                result = await execute_query(\n                    text(GET_USER_MAX_ACCESS_LEVEL).bindparams(\n                        usuario_id=usuario_id,\n                        cliente_id=cliente_id\n                    ),\n                    client_id=cliente_id\n                )\n            \n            if result and result[0]['max_level'] is not None:\n                # El valor de max_level no es NULL\n                return int(result[0]['max_level'])\n            \n            # Si no tiene",
    "type": "text() - tiene cliente_id"
  },
  {
    "file": "app\\modules\\rbac\\application\\services\\rol_service.py",
    "line": 525,
    "issue": "Query con text() toca tabla rol (verificar uso de cliente_id)",
    "severity": "medium",
    "tabla": "rol",
    "context": "        \n        tenant_context = try_get_tenant_context()\n        database_type = tenant_context.database_type if tenant_context else \"single\"\n\n        try:\n            # 📊 CONTAR TOTAL DE ROLES\n            # ✅ Para BD dedicadas, no filtrar por cliente_id (todos los roles pertenecen al mismo tenant)\n            # ✅ Para BD compartidas, filtrar SOLO por cliente_id (NO incluir roles del sistema)\n            if database_type == \"multi\":\n                COUNT_QUERY = \"\"\"\n                SELECT COUN",
    "type": "text() - tiene cliente_id"
  },
  {
    "file": "app\\modules\\rbac\\application\\services\\rol_service.py",
    "line": 545,
    "issue": "Query con text() toca tabla rol (verificar uso de cliente_id)",
    "severity": "medium",
    "tabla": "rol",
    "context": "            else:\n                # ✅ FASE 4B: Usar parámetros nombrados con text().bindparams()\n                from sqlalchemy import text\n                COUNT_QUERY = text(COUNT_ROLES_PAGINATED).bindparams(\n                    cliente_id=cliente_id,\n                    buscar=search_param,\n                    buscar_pattern=f\"%{search_param}%\" if search_param else None\n                )\n                logger.debug(f\"[ROLES-PAGINADOS] BD compartida: Contando roles SOLO del cliente_id {client",
    "type": "text() - tiene cliente_id"
  },
  {
    "file": "app\\modules\\rbac\\application\\services\\rol_service.py",
    "line": 547,
    "issue": "Query con text() toca tabla rol (verificar uso de cliente_id)",
    "severity": "medium",
    "tabla": "rol",
    "context": "                from sqlalchemy import text\n                COUNT_QUERY = text(COUNT_ROLES_PAGINATED).bindparams(\n                    cliente_id=cliente_id,\n                    buscar=search_param,\n                    buscar_pattern=f\"%{search_param}%\" if search_param else None\n                )\n                logger.debug(f\"[ROLES-PAGINADOS] BD compartida: Contando roles SOLO del cliente_id {cliente_id} (sin roles del sistema)\")\n            \n            logger.info(f\"[ROLES-PAGINADOS] Iniciand",
    "type": "text() - tiene cliente_id"
  },
  {
    "file": "app\\modules\\rbac\\application\\services\\rol_service.py",
    "line": 590,
    "issue": "Query con text() toca tabla rol (verificar uso de cliente_id)",
    "severity": "medium",
    "tabla": "rol",
    "context": "            else:\n                # ✅ FASE 4B: Usar parámetros nombrados con text().bindparams()\n                from sqlalchemy import text\n                SELECT_QUERY = text(SELECT_ROLES_PAGINATED).bindparams(\n                    cliente_id=cliente_id,\n                    buscar=search_param,\n                    buscar_pattern=f\"%{search_param}%\" if search_param else None,\n                    offset=offset,\n                    limit=limit\n                )\n                logger.debug(f\"[ROLE",
    "type": "text() - tiene cliente_id"
  },
  {
    "file": "app\\modules\\rbac\\application\\services\\rol_service.py",
    "line": 592,
    "issue": "Query con text() toca tabla rol (verificar uso de cliente_id)",
    "severity": "medium",
    "tabla": "rol",
    "context": "                from sqlalchemy import text\n                SELECT_QUERY = text(SELECT_ROLES_PAGINATED).bindparams(\n                    cliente_id=cliente_id,\n                    buscar=search_param,\n                    buscar_pattern=f\"%{search_param}%\" if search_param else None,\n                    offset=offset,\n                    limit=limit\n                )\n                logger.debug(f\"[ROLES-PAGINADOS] BD compartida: Obteniendo roles SOLO del cliente_id {cliente_id} (sin roles del sist",
    "type": "text() - tiene cliente_id"
  },
  {
    "file": "app\\modules\\rbac\\application\\services\\rol_service.py",
    "line": 718,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "                    if field != 'es_activo' or rol_data[field] != rol_actual.get(field):\n                        update_parts.append(f\"{db_field} = ?\")\n                        params.append(rol_data[field])\n                        campos_actualizados = True\n\n            if not campos_actualizados:\n                logger.info(f\"No hay cambios detectados para el rol ID {rol_id}\")\n                return rol_actual\n\n            params.append(rol_id)\n\n            # 💾 EJECUTAR ACTUALIZACIÓN",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\rbac\\application\\services\\rol_service.py",
    "line": 738,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "            # ✅ FASE 2: Usar await\n            result = await execute_update(update_query, tuple(params))\n\n            if not result:\n                logger.error(f\"La actualización del rol ID {rol_id} no devolvió resultados\")\n                raise ServiceError(\n                    status_code=500,\n                    detail=\"Error al actualizar el rol\",\n                    internal_code=\"ROLE_UPDATE_FAILED\"\n                )\n\n            # 🔄 CONVERTIR TIPOS DE DATOS",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\rbac\\application\\services\\rol_service.py",
    "line": 745,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "                    detail=\"Error al actualizar el rol\",\n                    internal_code=\"ROLE_UPDATE_FAILED\"\n                )\n\n            # 🔄 CONVERTIR TIPOS DE DATOS\n            if 'es_activo' in result and isinstance(result['es_activo'], int):\n                result['es_activo'] = bool(result['es_activo'])\n                \n            logger.info(f\"Rol '{result.get('nombre')}' actualizado exitosamente\")\n            return result\n\n        except (ValidationError, NotFoundError, ConflictErr",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\rbac\\application\\services\\rol_service.py",
    "line": 762,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "                detail=\"Error de base de datos al actualizar rol\",\n                internal_code=\"ROLE_UPDATE_DB_ERROR\"\n            )\n        except Exception as e:\n            logger.exception(f\"Error inesperado actualizando rol {rol_id}: {str(e)}\")\n            raise ServiceError(\n                status_code=500,\n                detail=\"Error interno al actualizar rol\",\n                internal_code=\"ROLE_UPDATE_UNEXPECTED_ERROR\"\n            )\n\n    @staticmethod",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\rbac\\application\\services\\rol_service.py",
    "line": 769,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "                detail=\"Error interno al actualizar rol\",\n                internal_code=\"ROLE_UPDATE_UNEXPECTED_ERROR\"\n            )\n\n    @staticmethod\n    @BaseService.handle_service_errors\n    async def desactivar_rol(rol_id: UUID) -> Dict:\n        \"\"\"\n        Desactiva un rol (borrado lógico).\n        \n        🚫 DESACTIVACIÓN SEGURA:\n        - Verifica que el rol exista y esté activo",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\rbac\\application\\services\\rol_service.py",
    "line": 810,
    "issue": "Query con text() toca tabla rol (verificar uso de cliente_id)",
    "severity": "medium",
    "tabla": "rol",
    "context": "            # 💾 EJECUTAR DESACTIVACIÓN\n            # ✅ FASE 4B: Usar parámetros nombrados con text().bindparams()\n            from sqlalchemy import text\n            from app.core.tenant.context import get_current_client_id\n            current_client_id = get_current_client_id()\n            \n            result = await execute_update(\n                text(DEACTIVATE_ROL).bindparams(\n                    rol_id=rol_id,\n                    cliente_id=current_client_id\n                ),\n            ",
    "type": "text() - tiene cliente_id"
  },
  {
    "file": "app\\modules\\rbac\\application\\services\\rol_service.py",
    "line": 816,
    "issue": "Query con text() toca tabla rol (verificar uso de cliente_id)",
    "severity": "medium",
    "tabla": "rol",
    "context": "            result = await execute_update(\n                text(DEACTIVATE_ROL).bindparams(\n                    rol_id=rol_id,\n                    cliente_id=current_client_id\n                ),\n                client_id=current_client_id\n            )\n\n            if not result:\n                logger.warning(f\"No se pudo desactivar el rol ID {rol_id}\")\n                # 🔄 VERIFICAR ESTADO ACTUAL\n                rol_revisado = await RolService.obtener_rol_por_id(rol_id, incluir_inactivos=True)\n",
    "type": "text() - tiene cliente_id"
  },
  {
    "file": "app\\modules\\rbac\\application\\services\\rol_service.py",
    "line": 897,
    "issue": "Query con text() toca tabla rol (verificar uso de cliente_id)",
    "severity": "medium",
    "tabla": "rol",
    "context": "            # 💾 EJECUTAR REACTIVACIÓN\n            # ✅ FASE 4B: Usar parámetros nombrados con text().bindparams()\n            from sqlalchemy import text\n            from app.core.tenant.context import get_current_client_id\n            current_client_id = get_current_client_id()\n            \n            result = await execute_update(\n                text(REACTIVATE_ROL).bindparams(\n                    rol_id=rol_id,\n                    cliente_id=current_client_id\n                ),\n             ",
    "type": "text() - tiene cliente_id"
  },
  {
    "file": "app\\modules\\rbac\\application\\services\\rol_service.py",
    "line": 903,
    "issue": "Query con text() toca tabla rol (verificar uso de cliente_id)",
    "severity": "medium",
    "tabla": "rol",
    "context": "            result = await execute_update(\n                text(REACTIVATE_ROL).bindparams(\n                    rol_id=rol_id,\n                    cliente_id=current_client_id\n                ),\n                client_id=current_client_id\n            )\n\n            if not result:\n                logger.warning(f\"No se pudo reactivar el rol ID {rol_id}\")\n                # 🔄 VERIFICAR ESTADO ACTUAL\n                rol_revisado = await RolService.obtener_rol_por_id(rol_id, incluir_inactivos=True)\n ",
    "type": "text() - tiene cliente_id"
  },
  {
    "file": "app\\modules\\rbac\\application\\services\\rol_service.py",
    "line": 968,
    "issue": "Query con text() toca tabla rol (verificar uso de cliente_id)",
    "severity": "medium",
    "tabla": "rol",
    "context": "        \n        tenant_context = try_get_tenant_context()\n        database_type = tenant_context.database_type if tenant_context else \"single\"\n        \n        # ✅ Para BD dedicadas, no filtrar por cliente_id (todos los roles pertenecen al mismo tenant)\n        if database_type == \"multi\":\n            query = \"\"\"\n                SELECT rol_id, cliente_id, nombre, descripcion, es_activo, fecha_creacion\n                FROM rol\n                WHERE es_activo = 1\n                ORDER BY nombre A",
    "type": "text() - tiene cliente_id"
  },
  {
    "file": "app\\modules\\rbac\\application\\services\\rol_service.py",
    "line": 1051,
    "issue": "Query con text() toca tabla rol (verificar uso de cliente_id)",
    "severity": "medium",
    "tabla": "rol",
    "context": "            # ✅ FASE 2: Usar await\n            # ✅ FASE 4B: Usar parámetros nombrados con text().bindparams()\n            from sqlalchemy import text\n            from app.core.tenant.context import get_current_client_id\n            current_client_id = get_current_client_id()\n            \n            resultados = await execute_query(\n                text(SELECT_PERMISOS_POR_ROL).bindparams(\n                    rol_id=rol_id,\n                    cliente_id=current_client_id\n                ),\n    ",
    "type": "text() - tiene cliente_id"
  },
  {
    "file": "app\\modules\\rbac\\application\\services\\rol_service.py",
    "line": 1057,
    "issue": "Query con text() toca tabla rol (verificar uso de cliente_id)",
    "severity": "medium",
    "tabla": "rol",
    "context": "            resultados = await execute_query(\n                text(SELECT_PERMISOS_POR_ROL).bindparams(\n                    rol_id=rol_id,\n                    cliente_id=current_client_id\n                ),\n                client_id=current_client_id\n            )\n            \n            if not resultados:\n                logger.info(f\"El rol ID {rol_id} no tiene permisos asignados\")\n                return []\n\n            permisos = [PermisoRead(**dict(row)) for row in resultados]\n            l",
    "type": "text() - tiene cliente_id"
  },
  {
    "file": "app\\modules\\rbac\\application\\services\\rol_service.py",
    "line": 1090,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "    @BaseService.handle_service_errors\n    async def actualizar_permisos_rol(rol_id: UUID, permisos_payload: PermisoUpdatePayload) -> None:\n        \"\"\"\n        Actualiza TODOS los permisos de un rol en una transacción atómica.\n        \n        🔄 ACTUALIZACIÓN ATÓMICA:\n        - Elimina permisos existentes\n        - Inserta nuevos permisos\n        - Transacción para garantizar consistencia\n        \n        Args:\n            rol_id: ID del rol a actualizar",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\rbac\\application\\services\\rol_service.py",
    "line": 1096,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "        - Elimina permisos existentes\n        - Inserta nuevos permisos\n        - Transacción para garantizar consistencia\n        \n        Args:\n            rol_id: ID del rol a actualizar\n            permisos_payload: Payload con la nueva lista de permisos\n            \n        Raises:\n            NotFoundError: Si el rol no existe\n            ServiceError: Si la transacción falla\n        \"\"\"",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\rbac\\application\\services\\rol_service.py",
    "line": 1174,
    "issue": "Query con text() toca tabla rol (verificar uso de cliente_id)",
    "severity": "medium",
    "tabla": "rol",
    "context": "                    await session.execute(\n                        text(delete_query), \n                        {\"rol_id\": rol_id, \"cliente_id\": rol_existente['cliente_id']}\n                    )\n                    logger.debug(f\"Permisos existentes eliminados para rol {rol_id}\")\n\n                    # ➕ INSERTAR NUEVOS PERMISOS\n                    if nuevos_permisos:\n                        # ✅ FASE 2: Query con cliente_id incluido y parámetros nombrados\n                        insert_query = ",
    "type": "text() - tiene cliente_id"
  },
  {
    "file": "app\\modules\\rbac\\application\\services\\rol_service.py",
    "line": 1174,
    "issue": "Query con text() toca tabla rol_menu_permiso (verificar uso de cliente_id)",
    "severity": "medium",
    "tabla": "rol_menu_permiso",
    "context": "                    await session.execute(\n                        text(delete_query), \n                        {\"rol_id\": rol_id, \"cliente_id\": rol_existente['cliente_id']}\n                    )\n                    logger.debug(f\"Permisos existentes eliminados para rol {rol_id}\")\n\n                    # ➕ INSERTAR NUEVOS PERMISOS\n                    if nuevos_permisos:\n                        # ✅ FASE 2: Query con cliente_id incluido y parámetros nombrados\n                        insert_query = ",
    "type": "text() - tiene cliente_id"
  },
  {
    "file": "app\\modules\\rbac\\application\\services\\rol_service.py",
    "line": 1200,
    "issue": "Query con text() toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "                            }\n                            await session.execute(text(insert_query), params)\n                            insert_count += 1\n                        logger.debug(f\"Insertados {insert_count} permisos para rol {rol_id}\")\n                    else:\n                        logger.debug(f\"No hay nuevos permisos para insertar para rol {rol_id}\")\n                    \n                    # Commit de la transacción\n                    await session.commit()\n                   ",
    "type": "text()"
  },
  {
    "file": "app\\modules\\rbac\\application\\services\\rol_service.py",
    "line": 1200,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "                            }\n                            await session.execute(text(insert_query), params)\n                            insert_count += 1\n                        logger.debug(f\"Insertados {insert_count} permisos para rol {rol_id}\")\n                    else:\n                        logger.debug(f\"No hay nuevos permisos para insertar para rol {rol_id}\")\n                    \n                    # Commit de la transacción\n                    await session.commit()\n                   ",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\rbac\\application\\services\\rol_service.py",
    "line": 1201,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "                            await session.execute(text(insert_query), params)\n                            insert_count += 1\n                        logger.debug(f\"Insertados {insert_count} permisos para rol {rol_id}\")\n                    else:\n                        logger.debug(f\"No hay nuevos permisos para insertar para rol {rol_id}\")\n                    \n                    # Commit de la transacción\n                    await session.commit()\n                    logger.info(f\"Permisos actual",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\rbac\\application\\services\\rol_service.py",
    "line": 1202,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "                            insert_count += 1\n                        logger.debug(f\"Insertados {insert_count} permisos para rol {rol_id}\")\n                    else:\n                        logger.debug(f\"No hay nuevos permisos para insertar para rol {rol_id}\")\n                    \n                    # Commit de la transacción\n                    await session.commit()\n                    logger.info(f\"Permisos actualizados exitosamente para el rol ID: {rol_id}\")\n                    \n          ",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\rbac\\application\\services\\rol_service.py",
    "line": 1204,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "                    else:\n                        logger.debug(f\"No hay nuevos permisos para insertar para rol {rol_id}\")\n                    \n                    # Commit de la transacción\n                    await session.commit()\n                    logger.info(f\"Permisos actualizados exitosamente para el rol ID: {rol_id}\")\n                    \n                except Exception as e:\n                    await session.rollback()\n                    raise\n\n        except (ValidationError, Servic",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\rbac\\application\\services\\rol_service.py",
    "line": 1222,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "                detail=\"Error de base de datos al actualizar permisos\",\n                internal_code=\"ROLE_PERMISSIONS_UPDATE_DB_ERROR\"\n            )\n        except Exception as e:\n            logger.exception(f\"Error inesperado en actualizar_permisos_rol: {e}\")\n            raise ServiceError(\n                status_code=500,\n                detail=\"Error interno al actualizar permisos\",\n                internal_code=\"ROLE_PERMISSIONS_UPDATE_UNEXPECTED_ERROR\"\n            )",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\rbac\\application\\services\\rol_service.py",
    "line": 1229,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "                detail=\"Error interno al actualizar permisos\",\n                internal_code=\"ROLE_PERMISSIONS_UPDATE_UNEXPECTED_ERROR\"\n            )",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\rbac\\infrastructure\\repositories\\permiso_repository.py",
    "line": 67,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "        query = \"\"\"\n            SELECT \n                p.*,\n                rp.es_activo as asignacion_activa\n            FROM permiso p\n            INNER JOIN rol_permiso rp ON p.permiso_id = rp.permiso_id\n            WHERE rp.rol_id = :rol_id\n            AND rp.es_activo = 1\n            AND p.es_activo = 1\n            ORDER BY p.nombre ASC\n        \"\"\"\n        ",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\rbac\\infrastructure\\repositories\\permiso_repository.py",
    "line": 80,
    "issue": "Query con text() toca tabla rol (verificar uso de cliente_id)",
    "severity": "medium",
    "tabla": "rol",
    "context": "            return await execute_query(\n                text(query).bindparams(rol_id=rol_id),\n                connection_type=self.connection_type\n            )\n        except Exception as e:\n            logger.error(f\"Error en find_permisos_by_rol: {str(e)}\")\n            raise\n    \n    async def find_permisos_by_usuario(\n        self,\n        usuario_id: int,\n        client_id: Optional[int] = None\n    ) -> List[Dict[str, Any]]:\n        \"\"\"\n        Busca todos los permisos de un usuario (a tra",
    "type": "text() - tiene cliente_id"
  },
  {
    "file": "app\\modules\\rbac\\infrastructure\\repositories\\permiso_repository.py",
    "line": 80,
    "issue": "Query con text() toca tabla usuario (verificar uso de cliente_id)",
    "severity": "medium",
    "tabla": "usuario",
    "context": "            return await execute_query(\n                text(query).bindparams(rol_id=rol_id),\n                connection_type=self.connection_type\n            )\n        except Exception as e:\n            logger.error(f\"Error en find_permisos_by_rol: {str(e)}\")\n            raise\n    \n    async def find_permisos_by_usuario(\n        self,\n        usuario_id: int,\n        client_id: Optional[int] = None\n    ) -> List[Dict[str, Any]]:\n        \"\"\"\n        Busca todos los permisos de un usuario (a tra",
    "type": "text() - tiene cliente_id"
  },
  {
    "file": "app\\modules\\rbac\\infrastructure\\repositories\\permiso_repository.py",
    "line": 103,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "        query = \"\"\"\n            SELECT DISTINCT\n                p.*\n            FROM permiso p\n            INNER JOIN rol_permiso rp ON p.permiso_id = rp.permiso_id\n            INNER JOIN rol r ON rp.rol_id = r.rol_id\n            INNER JOIN usuario_rol ur ON r.rol_id = ur.rol_id\n            WHERE ur.usuario_id = :usuario_id\n            AND ur.es_activo = 1\n            AND r.es_activo = 1\n            AND rp.es_activo = 1\n            AND p.es_activo = 1",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\rbac\\infrastructure\\repositories\\permiso_repository.py",
    "line": 103,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "        query = \"\"\"\n            SELECT DISTINCT\n                p.*\n            FROM permiso p\n            INNER JOIN rol_permiso rp ON p.permiso_id = rp.permiso_id\n            INNER JOIN rol r ON rp.rol_id = r.rol_id\n            INNER JOIN usuario_rol ur ON r.rol_id = ur.rol_id\n            WHERE ur.usuario_id = :usuario_id\n            AND ur.es_activo = 1\n            AND r.es_activo = 1\n            AND rp.es_activo = 1\n            AND p.es_activo = 1",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\rbac\\infrastructure\\repositories\\permiso_repository.py",
    "line": 103,
    "issue": "Query SQL directa toca tabla usuario_rol sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario_rol",
    "context": "        query = \"\"\"\n            SELECT DISTINCT\n                p.*\n            FROM permiso p\n            INNER JOIN rol_permiso rp ON p.permiso_id = rp.permiso_id\n            INNER JOIN rol r ON rp.rol_id = r.rol_id\n            INNER JOIN usuario_rol ur ON r.rol_id = ur.rol_id\n            WHERE ur.usuario_id = :usuario_id\n            AND ur.es_activo = 1\n            AND r.es_activo = 1\n            AND rp.es_activo = 1\n            AND p.es_activo = 1",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\rbac\\infrastructure\\repositories\\permiso_repository.py",
    "line": 123,
    "issue": "Query con text() toca tabla usuario (verificar uso de cliente_id)",
    "severity": "medium",
    "tabla": "usuario",
    "context": "            return await execute_query(\n                text(query).bindparams(**bind_params),\n                connection_type=self.connection_type,\n                client_id=client_id\n            )\n        except Exception as e:\n            logger.error(f\"Error en find_permisos_by_usuario: {str(e)}\")\n            raise\n\n",
    "type": "text() - tiene cliente_id"
  },
  {
    "file": "app\\modules\\rbac\\infrastructure\\repositories\\rol_repository.py",
    "line": 99,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "        query_permisos = \"\"\"\n            SELECT \n                p.permiso_id,\n                p.codigo_permiso,\n                p.nombre as nombre_permiso,\n                p.descripcion as descripcion_permiso,\n                p.es_activo as permiso_activo,\n                rp.es_activo as asignacion_activa\n            FROM permiso p\n            INNER JOIN rol_permiso rp ON p.permiso_id = rp.permiso_id\n            WHERE rp.rol_id = :rol_id\n            AND rp.es_activo = 1",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\rbac\\infrastructure\\repositories\\rol_repository.py",
    "line": 115,
    "issue": "Query con text() toca tabla rol (verificar uso de cliente_id)",
    "severity": "medium",
    "tabla": "rol",
    "context": "            permisos = await execute_query(\n                text(query_permisos).bindparams(rol_id=rol_id),\n                connection_type=self.connection_type,\n                client_id=client_id\n            )\n            rol['permisos'] = permisos\n            return rol\n        except Exception as e:\n            logger.error(f\"Error en find_with_permisos: {str(e)}\")\n            rol['permisos'] = []\n            return rol\n    \n    async def find_roles_by_usuario(\n        self,\n        usuario_",
    "type": "text() - tiene cliente_id"
  },
  {
    "file": "app\\modules\\rbac\\infrastructure\\repositories\\rol_repository.py",
    "line": 115,
    "issue": "Query con text() toca tabla usuario (verificar uso de cliente_id)",
    "severity": "medium",
    "tabla": "usuario",
    "context": "            permisos = await execute_query(\n                text(query_permisos).bindparams(rol_id=rol_id),\n                connection_type=self.connection_type,\n                client_id=client_id\n            )\n            rol['permisos'] = permisos\n            return rol\n        except Exception as e:\n            logger.error(f\"Error en find_with_permisos: {str(e)}\")\n            rol['permisos'] = []\n            return rol\n    \n    async def find_roles_by_usuario(\n        self,\n        usuario_",
    "type": "text() - tiene cliente_id"
  },
  {
    "file": "app\\modules\\rbac\\infrastructure\\repositories\\rol_repository.py",
    "line": 144,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "        query = f\"\"\"\n            SELECT \n                r.*,\n                ur.fecha_asignacion,\n                ur.es_activo as asignacion_activa\n            FROM {self.table_name} r\n            INNER JOIN usuario_rol ur ON r.rol_id = ur.rol_id\n            WHERE ur.usuario_id = :usuario_id\n            AND ur.es_activo = 1\n            AND r.es_activo = 1\n            {tenant_filter}\n            ORDER BY r.nombre ASC",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\rbac\\infrastructure\\repositories\\rol_repository.py",
    "line": 144,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "        query = f\"\"\"\n            SELECT \n                r.*,\n                ur.fecha_asignacion,\n                ur.es_activo as asignacion_activa\n            FROM {self.table_name} r\n            INNER JOIN usuario_rol ur ON r.rol_id = ur.rol_id\n            WHERE ur.usuario_id = :usuario_id\n            AND ur.es_activo = 1\n            AND r.es_activo = 1\n            {tenant_filter}\n            ORDER BY r.nombre ASC",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\rbac\\infrastructure\\repositories\\rol_repository.py",
    "line": 144,
    "issue": "Query SQL directa toca tabla usuario_rol sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario_rol",
    "context": "        query = f\"\"\"\n            SELECT \n                r.*,\n                ur.fecha_asignacion,\n                ur.es_activo as asignacion_activa\n            FROM {self.table_name} r\n            INNER JOIN usuario_rol ur ON r.rol_id = ur.rol_id\n            WHERE ur.usuario_id = :usuario_id\n            AND ur.es_activo = 1\n            AND r.es_activo = 1\n            {tenant_filter}\n            ORDER BY r.nombre ASC",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\rbac\\infrastructure\\repositories\\rol_repository.py",
    "line": 161,
    "issue": "Query con text() toca tabla rol (verificar uso de cliente_id)",
    "severity": "medium",
    "tabla": "rol",
    "context": "            return await execute_query(\n                text(query).bindparams(**bind_params),\n                connection_type=self.connection_type,\n                client_id=client_id\n            )\n        except Exception as e:\n            logger.error(f\"Error en find_roles_by_usuario: {str(e)}\")\n            raise\n\n",
    "type": "text() - tiene cliente_id"
  },
  {
    "file": "app\\modules\\rbac\\infrastructure\\repositories\\rol_repository.py",
    "line": 161,
    "issue": "Query con text() toca tabla usuario (verificar uso de cliente_id)",
    "severity": "medium",
    "tabla": "usuario",
    "context": "            return await execute_query(\n                text(query).bindparams(**bind_params),\n                connection_type=self.connection_type,\n                client_id=client_id\n            )\n        except Exception as e:\n            logger.error(f\"Error en find_roles_by_usuario: {str(e)}\")\n            raise\n\n",
    "type": "text() - tiene cliente_id"
  },
  {
    "file": "app\\modules\\superadmin\\presentation\\schemas.py",
    "line": 261,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "    direccion: str = Field(..., description=\"Dirección (push/pull/bidireccional)\")\n    operacion: str = Field(..., description=\"Operación (create/update/delete)\")\n    estado: str = Field(..., description=\"Estado (exitoso/fallido/parcial/pendiente)\")\n    mensaje_error: Optional[str] = Field(None, description=\"Mensaje de error si falló\")\n    campos_sincronizados: Optional[List[str]] = Field(None, description=\"Campos sincronizados (JSON parseado)\")\n    cambios_detectados: Optional[Dict[str, Any]] =",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\superadmin\\application\\services\\audit_service.py",
    "line": 8,
    "issue": "Query SQL directa toca tabla auth_audit_log sin cliente_id visible",
    "severity": "high",
    "tabla": "auth_audit_log",
    "context": "# ✅ FASE 2: Migrar a queries_async\nfrom app.infrastructure.database.queries_async import execute_insert\nfrom app.infrastructure.database.sql_constants import (\n    INSERT_AUTH_AUDIT_LOG,\n    INSERT_LOG_SINCRONIZACION_USUARIO,\n)\nfrom app.infrastructure.database.connection_async import DatabaseConnection\nfrom app.core.exceptions import DatabaseError\nfrom app.core.application.base_service import BaseService\nfrom sqlalchemy import text\n\nlogger = logging.getLogger(__name__)",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\superadmin\\application\\services\\audit_service.py",
    "line": 8,
    "issue": "Query SQL directa toca tabla log_sincronizacion_usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "log_sincronizacion_usuario",
    "context": "# ✅ FASE 2: Migrar a queries_async\nfrom app.infrastructure.database.queries_async import execute_insert\nfrom app.infrastructure.database.sql_constants import (\n    INSERT_AUTH_AUDIT_LOG,\n    INSERT_LOG_SINCRONIZACION_USUARIO,\n)\nfrom app.infrastructure.database.connection_async import DatabaseConnection\nfrom app.core.exceptions import DatabaseError\nfrom app.core.application.base_service import BaseService\nfrom sqlalchemy import text\n\nlogger = logging.getLogger(__name__)",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\superadmin\\application\\services\\audit_service.py",
    "line": 8,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "# ✅ FASE 2: Migrar a queries_async\nfrom app.infrastructure.database.queries_async import execute_insert\nfrom app.infrastructure.database.sql_constants import (\n    INSERT_AUTH_AUDIT_LOG,\n    INSERT_LOG_SINCRONIZACION_USUARIO,\n)\nfrom app.infrastructure.database.connection_async import DatabaseConnection\nfrom app.core.exceptions import DatabaseError\nfrom app.core.application.base_service import BaseService\nfrom sqlalchemy import text\n\nlogger = logging.getLogger(__name__)",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\superadmin\\application\\services\\audit_service.py",
    "line": 10,
    "issue": "Query SQL directa toca tabla auth_audit_log sin cliente_id visible",
    "severity": "high",
    "tabla": "auth_audit_log",
    "context": "from app.infrastructure.database.sql_constants import (\n    INSERT_AUTH_AUDIT_LOG,\n    INSERT_LOG_SINCRONIZACION_USUARIO,\n)\nfrom app.infrastructure.database.connection_async import DatabaseConnection\nfrom app.core.exceptions import DatabaseError\nfrom app.core.application.base_service import BaseService\nfrom sqlalchemy import text\n\nlogger = logging.getLogger(__name__)\n\n",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\superadmin\\application\\services\\audit_service.py",
    "line": 10,
    "issue": "Query SQL directa toca tabla log_sincronizacion_usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "log_sincronizacion_usuario",
    "context": "from app.infrastructure.database.sql_constants import (\n    INSERT_AUTH_AUDIT_LOG,\n    INSERT_LOG_SINCRONIZACION_USUARIO,\n)\nfrom app.infrastructure.database.connection_async import DatabaseConnection\nfrom app.core.exceptions import DatabaseError\nfrom app.core.application.base_service import BaseService\nfrom sqlalchemy import text\n\nlogger = logging.getLogger(__name__)\n\n",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\superadmin\\application\\services\\audit_service.py",
    "line": 10,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "from app.infrastructure.database.sql_constants import (\n    INSERT_AUTH_AUDIT_LOG,\n    INSERT_LOG_SINCRONIZACION_USUARIO,\n)\nfrom app.infrastructure.database.connection_async import DatabaseConnection\nfrom app.core.exceptions import DatabaseError\nfrom app.core.application.base_service import BaseService\nfrom sqlalchemy import text\n\nlogger = logging.getLogger(__name__)\n\n",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\superadmin\\application\\services\\audit_service.py",
    "line": 11,
    "issue": "Query SQL directa toca tabla auth_audit_log sin cliente_id visible",
    "severity": "high",
    "tabla": "auth_audit_log",
    "context": "    INSERT_AUTH_AUDIT_LOG,\n    INSERT_LOG_SINCRONIZACION_USUARIO,\n)\nfrom app.infrastructure.database.connection_async import DatabaseConnection\nfrom app.core.exceptions import DatabaseError\nfrom app.core.application.base_service import BaseService\nfrom sqlalchemy import text\n\nlogger = logging.getLogger(__name__)\n\n\nclass AuditService(BaseService):",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\superadmin\\application\\services\\audit_service.py",
    "line": 11,
    "issue": "Query SQL directa toca tabla log_sincronizacion_usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "log_sincronizacion_usuario",
    "context": "    INSERT_AUTH_AUDIT_LOG,\n    INSERT_LOG_SINCRONIZACION_USUARIO,\n)\nfrom app.infrastructure.database.connection_async import DatabaseConnection\nfrom app.core.exceptions import DatabaseError\nfrom app.core.application.base_service import BaseService\nfrom sqlalchemy import text\n\nlogger = logging.getLogger(__name__)\n\n\nclass AuditService(BaseService):",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\superadmin\\application\\services\\audit_service.py",
    "line": 11,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "    INSERT_AUTH_AUDIT_LOG,\n    INSERT_LOG_SINCRONIZACION_USUARIO,\n)\nfrom app.infrastructure.database.connection_async import DatabaseConnection\nfrom app.core.exceptions import DatabaseError\nfrom app.core.application.base_service import BaseService\nfrom sqlalchemy import text\n\nlogger = logging.getLogger(__name__)\n\n\nclass AuditService(BaseService):",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\superadmin\\application\\services\\audit_service.py",
    "line": 120,
    "issue": "Query SQL directa toca tabla auth_audit_log sin cliente_id visible",
    "severity": "high",
    "tabla": "auth_audit_log",
    "context": "            # ✅ FASE 4B: Usar parámetros nombrados directamente (ya están en la constante)\n            query = INSERT_AUTH_AUDIT_LOG\n\n            # ✅ FASE 2: Usar await con text().bindparams()\n            # ✅ CORRECCIÓN: auth_audit_log existe tanto en BD central como en BD dedicada\n            # Para clientes dedicated, usar la BD del tenant (donde está el usuario)\n            # Para clientes shared, usar la BD ADMIN (central)\n            try:\n                from app.core.tenant.context import ",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\superadmin\\application\\services\\audit_service.py",
    "line": 120,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "            # ✅ FASE 4B: Usar parámetros nombrados directamente (ya están en la constante)\n            query = INSERT_AUTH_AUDIT_LOG\n\n            # ✅ FASE 2: Usar await con text().bindparams()\n            # ✅ CORRECCIÓN: auth_audit_log existe tanto en BD central como en BD dedicada\n            # Para clientes dedicated, usar la BD del tenant (donde está el usuario)\n            # Para clientes shared, usar la BD ADMIN (central)\n            try:\n                from app.core.tenant.context import ",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\superadmin\\application\\services\\audit_service.py",
    "line": 122,
    "issue": "Query con text() toca tabla auth_audit_log (verificar uso de cliente_id)",
    "severity": "medium",
    "tabla": "auth_audit_log",
    "context": "\n            # ✅ FASE 2: Usar await con text().bindparams()\n            # ✅ CORRECCIÓN: auth_audit_log existe tanto en BD central como en BD dedicada\n            # Para clientes dedicated, usar la BD del tenant (donde está el usuario)\n            # Para clientes shared, usar la BD ADMIN (central)\n            try:\n                from app.core.tenant.context import try_get_tenant_context\n                tenant_context = try_get_tenant_context()\n                \n                if tenant_context a",
    "type": "text() - tiene cliente_id"
  },
  {
    "file": "app\\modules\\superadmin\\application\\services\\audit_service.py",
    "line": 122,
    "issue": "Query con text() toca tabla usuario (verificar uso de cliente_id)",
    "severity": "medium",
    "tabla": "usuario",
    "context": "\n            # ✅ FASE 2: Usar await con text().bindparams()\n            # ✅ CORRECCIÓN: auth_audit_log existe tanto en BD central como en BD dedicada\n            # Para clientes dedicated, usar la BD del tenant (donde está el usuario)\n            # Para clientes shared, usar la BD ADMIN (central)\n            try:\n                from app.core.tenant.context import try_get_tenant_context\n                tenant_context = try_get_tenant_context()\n                \n                if tenant_context a",
    "type": "text() - tiene cliente_id"
  },
  {
    "file": "app\\modules\\superadmin\\application\\services\\audit_service.py",
    "line": 128,
    "issue": "Query con text() toca tabla auth_audit_log (verificar uso de cliente_id)",
    "severity": "medium",
    "tabla": "auth_audit_log",
    "context": "                from app.core.tenant.context import try_get_tenant_context\n                tenant_context = try_get_tenant_context()\n                \n                if tenant_context and tenant_context.database_type == \"multi\":\n                    # BD dedicada: insertar en la BD del tenant (donde está el usuario)\n                    connection_type = DatabaseConnection.DEFAULT\n                    logger.debug(\n                        f\"[AUDIT] Cliente {cliente_id_uuid} es BD dedicada, \"\n      ",
    "type": "text() - tiene cliente_id"
  },
  {
    "file": "app\\modules\\superadmin\\application\\services\\audit_service.py",
    "line": 128,
    "issue": "Query con text() toca tabla usuario (verificar uso de cliente_id)",
    "severity": "medium",
    "tabla": "usuario",
    "context": "                from app.core.tenant.context import try_get_tenant_context\n                tenant_context = try_get_tenant_context()\n                \n                if tenant_context and tenant_context.database_type == \"multi\":\n                    # BD dedicada: insertar en la BD del tenant (donde está el usuario)\n                    connection_type = DatabaseConnection.DEFAULT\n                    logger.debug(\n                        f\"[AUDIT] Cliente {cliente_id_uuid} es BD dedicada, \"\n      ",
    "type": "text() - tiene cliente_id"
  },
  {
    "file": "app\\modules\\superadmin\\application\\services\\audit_service.py",
    "line": 152,
    "issue": "Query con text() toca tabla auth_audit_log (verificar uso de cliente_id)",
    "severity": "medium",
    "tabla": "auth_audit_log",
    "context": "            result = await execute_insert(\n                text(query).bindparams(\n                    cliente_id=cliente_id_uuid,\n                    usuario_id=usuario_id_uuid,\n                    evento=evento,\n                    nombre_usuario_intento=nombre_usuario_intento,\n                    descripcion=descripcion,\n                    exito=1 if exito else 0,\n                    codigo_error=codigo_error,\n                    ip_address=ip_address,\n                    user_agent=user_age",
    "type": "text() - tiene cliente_id"
  },
  {
    "file": "app\\modules\\superadmin\\application\\services\\audit_service.py",
    "line": 152,
    "issue": "Query con text() toca tabla usuario (verificar uso de cliente_id)",
    "severity": "medium",
    "tabla": "usuario",
    "context": "            result = await execute_insert(\n                text(query).bindparams(\n                    cliente_id=cliente_id_uuid,\n                    usuario_id=usuario_id_uuid,\n                    evento=evento,\n                    nombre_usuario_intento=nombre_usuario_intento,\n                    descripcion=descripcion,\n                    exito=1 if exito else 0,\n                    codigo_error=codigo_error,\n                    ip_address=ip_address,\n                    user_agent=user_age",
    "type": "text() - tiene cliente_id"
  },
  {
    "file": "app\\modules\\superadmin\\application\\services\\audit_service.py",
    "line": 232,
    "issue": "Query con text() toca tabla log_sincronizacion_usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "log_sincronizacion_usuario",
    "context": "\n            # ✅ FASE 4B: Usar parámetros nombrados con text().bindparams()\n            result = await execute_insert(\n                text(INSERT_LOG_SINCRONIZACION_USUARIO).bindparams(\n                    cliente_origen_id=cliente_origen_id,\n                    cliente_destino_id=cliente_destino_id,\n                    usuario_id=usuario_id,\n                    tipo_sincronizacion=tipo_sincronizacion,\n                    direccion=direccion,\n                    operacion=operacion,\n           ",
    "type": "text()"
  },
  {
    "file": "app\\modules\\superadmin\\application\\services\\audit_service.py",
    "line": 232,
    "issue": "Query con text() toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "\n            # ✅ FASE 4B: Usar parámetros nombrados con text().bindparams()\n            result = await execute_insert(\n                text(INSERT_LOG_SINCRONIZACION_USUARIO).bindparams(\n                    cliente_origen_id=cliente_origen_id,\n                    cliente_destino_id=cliente_destino_id,\n                    usuario_id=usuario_id,\n                    tipo_sincronizacion=tipo_sincronizacion,\n                    direccion=direccion,\n                    operacion=operacion,\n           ",
    "type": "text()"
  },
  {
    "file": "app\\modules\\superadmin\\application\\services\\audit_service.py",
    "line": 233,
    "issue": "Query SQL directa toca tabla log_sincronizacion_usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "log_sincronizacion_usuario",
    "context": "            # ✅ FASE 4B: Usar parámetros nombrados con text().bindparams()\n            result = await execute_insert(\n                text(INSERT_LOG_SINCRONIZACION_USUARIO).bindparams(\n                    cliente_origen_id=cliente_origen_id,\n                    cliente_destino_id=cliente_destino_id,\n                    usuario_id=usuario_id,\n                    tipo_sincronizacion=tipo_sincronizacion,\n                    direccion=direccion,\n                    operacion=operacion,\n            ",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\superadmin\\application\\services\\audit_service.py",
    "line": 233,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "            # ✅ FASE 4B: Usar parámetros nombrados con text().bindparams()\n            result = await execute_insert(\n                text(INSERT_LOG_SINCRONIZACION_USUARIO).bindparams(\n                    cliente_origen_id=cliente_origen_id,\n                    cliente_destino_id=cliente_destino_id,\n                    usuario_id=usuario_id,\n                    tipo_sincronizacion=tipo_sincronizacion,\n                    direccion=direccion,\n                    operacion=operacion,\n            ",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\superadmin\\application\\services\\audit_service.py",
    "line": 234,
    "issue": "Query con text() toca tabla log_sincronizacion_usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "log_sincronizacion_usuario",
    "context": "            result = await execute_insert(\n                text(INSERT_LOG_SINCRONIZACION_USUARIO).bindparams(\n                    cliente_origen_id=cliente_origen_id,\n                    cliente_destino_id=cliente_destino_id,\n                    usuario_id=usuario_id,\n                    tipo_sincronizacion=tipo_sincronizacion,\n                    direccion=direccion,\n                    operacion=operacion,\n                    estado=estado,\n                    mensaje_error=mensaje_error,\n   ",
    "type": "text()"
  },
  {
    "file": "app\\modules\\superadmin\\application\\services\\audit_service.py",
    "line": 234,
    "issue": "Query con text() toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "            result = await execute_insert(\n                text(INSERT_LOG_SINCRONIZACION_USUARIO).bindparams(\n                    cliente_origen_id=cliente_origen_id,\n                    cliente_destino_id=cliente_destino_id,\n                    usuario_id=usuario_id,\n                    tipo_sincronizacion=tipo_sincronizacion,\n                    direccion=direccion,\n                    operacion=operacion,\n                    estado=estado,\n                    mensaje_error=mensaje_error,\n   ",
    "type": "text()"
  },
  {
    "file": "app\\modules\\superadmin\\application\\services\\audit_service.py",
    "line": 234,
    "issue": "Query SQL directa toca tabla log_sincronizacion_usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "log_sincronizacion_usuario",
    "context": "            result = await execute_insert(\n                text(INSERT_LOG_SINCRONIZACION_USUARIO).bindparams(\n                    cliente_origen_id=cliente_origen_id,\n                    cliente_destino_id=cliente_destino_id,\n                    usuario_id=usuario_id,\n                    tipo_sincronizacion=tipo_sincronizacion,\n                    direccion=direccion,\n                    operacion=operacion,\n                    estado=estado,\n                    mensaje_error=mensaje_error,\n   ",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\superadmin\\application\\services\\audit_service.py",
    "line": 234,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "            result = await execute_insert(\n                text(INSERT_LOG_SINCRONIZACION_USUARIO).bindparams(\n                    cliente_origen_id=cliente_origen_id,\n                    cliente_destino_id=cliente_destino_id,\n                    usuario_id=usuario_id,\n                    tipo_sincronizacion=tipo_sincronizacion,\n                    direccion=direccion,\n                    operacion=operacion,\n                    estado=estado,\n                    mensaje_error=mensaje_error,\n   ",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\superadmin\\application\\services\\superadmin_auditoria_service.py",
    "line": 228,
    "issue": "Query con text() toca tabla usuario (verificar uso de cliente_id)",
    "severity": "medium",
    "tabla": "usuario",
    "context": "                    cliente_raw = await execute_query(\n                        text(query_cliente).bindparams(cliente_id=log_row['cliente_id']),\n                        connection_type=DatabaseConnection.ADMIN,\n                        client_id=None\n                    )\n                    if cliente_raw:\n                        cliente_row = cliente_raw[0]\n                        cliente_info = ClienteInfo(\n                            cliente_id=cliente_row['cliente_id'],\n                     ",
    "type": "text() - tiene cliente_id"
  },
  {
    "file": "app\\modules\\superadmin\\application\\services\\superadmin_auditoria_service.py",
    "line": 308,
    "issue": "Query SQL directa toca tabla auth_audit_log sin cliente_id visible",
    "severity": "high",
    "tabla": "auth_audit_log",
    "context": "        query = \"\"\"\n        SELECT \n            a.*,\n            u.nombre_usuario,\n            u.correo\n        FROM dbo.auth_audit_log a\n        LEFT JOIN dbo.usuario u ON a.usuario_id = u.usuario_id\n        WHERE a.log_id = :log_id\n        \"\"\"\n        \n        # ✅ CORRECCIÓN: Lógica optimizada para SuperAdmin - Identificar tenant y consultar BD correcta\n        # PATRÓN CORRECTO (igual que get_logs_autenticacion):",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\superadmin\\application\\services\\superadmin_auditoria_service.py",
    "line": 308,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "        query = \"\"\"\n        SELECT \n            a.*,\n            u.nombre_usuario,\n            u.correo\n        FROM dbo.auth_audit_log a\n        LEFT JOIN dbo.usuario u ON a.usuario_id = u.usuario_id\n        WHERE a.log_id = :log_id\n        \"\"\"\n        \n        # ✅ CORRECCIÓN: Lógica optimizada para SuperAdmin - Identificar tenant y consultar BD correcta\n        # PATRÓN CORRECTO (igual que get_logs_autenticacion):",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\superadmin\\application\\services\\superadmin_auditoria_service.py",
    "line": 387,
    "issue": "Query con text() toca tabla auth_audit_log (verificar uso de cliente_id)",
    "severity": "medium",
    "tabla": "auth_audit_log",
    "context": "                log_raw = await execute_query(\n                    text(query).bindparams(log_id=str(log_id)),\n                    client_id=context_cliente_id\n                )\n                if log_raw:\n                    log_row = log_raw[0]\n                    log_cliente_id = log_row.get('cliente_id')\n                    logger.info(f\"[AUDIT] Log {log_id} encontrado en BD del tenant {context_cliente_id} (cliente_id del log: {log_cliente_id})\")\n            except Exception as e:\n          ",
    "type": "text() - tiene cliente_id"
  },
  {
    "file": "app\\modules\\superadmin\\application\\services\\superadmin_auditoria_service.py",
    "line": 586,
    "issue": "Query con text() toca tabla usuario (verificar uso de cliente_id)",
    "severity": "medium",
    "tabla": "usuario",
    "context": "            cliente_raw = await execute_query(\n                text(query_cliente_info).bindparams(cliente_id=log_row['cliente_id']),\n                connection_type=DatabaseConnection.ADMIN,\n                client_id=None\n            )\n            \n            if cliente_raw:\n                cliente_row = cliente_raw[0]\n                cliente_info = ClienteInfo(\n                    cliente_id=cliente_row['cliente_id'],\n                    razon_social=cliente_row.get('razon_social', ''),\n     ",
    "type": "text() - tiene cliente_id"
  },
  {
    "file": "app\\modules\\superadmin\\application\\services\\superadmin_auditoria_service.py",
    "line": 767,
    "issue": "Query SQL directa toca tabla log_sincronizacion_usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "log_sincronizacion_usuario",
    "context": "        data_query = f\"\"\"\n        SELECT \n            l.*,\n            u.nombre_usuario,\n            u.correo,\n            ue.nombre_usuario as ejecutor_nombre_usuario,\n            ue.correo as ejecutor_correo\n        FROM dbo.log_sincronizacion_usuario l\n        LEFT JOIN dbo.usuario u ON l.usuario_id = u.usuario_id\n        LEFT JOIN dbo.usuario ue ON l.usuario_ejecutor_id = ue.usuario_id\n        WHERE {where_clause}\n        ORDER BY {order_field} {order_dir}",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\superadmin\\application\\services\\superadmin_auditoria_service.py",
    "line": 767,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "        data_query = f\"\"\"\n        SELECT \n            l.*,\n            u.nombre_usuario,\n            u.correo,\n            ue.nombre_usuario as ejecutor_nombre_usuario,\n            ue.correo as ejecutor_correo\n        FROM dbo.log_sincronizacion_usuario l\n        LEFT JOIN dbo.usuario u ON l.usuario_id = u.usuario_id\n        LEFT JOIN dbo.usuario ue ON l.usuario_ejecutor_id = ue.usuario_id\n        WHERE {where_clause}\n        ORDER BY {order_field} {order_dir}",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\superadmin\\application\\services\\superadmin_usuario_service.py",
    "line": 335,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "            query = \"\"\"\n            SELECT \n                r.rol_id,\n                r.nombre,\n                r.codigo_rol,\n                r.nivel_acceso,\n                r.es_rol_sistema,\n                ur.fecha_asignacion,\n                ur.es_activo\n            FROM dbo.rol r\n            INNER JOIN dbo.usuario_rol ur ON r.rol_id = ur.rol_id\n            WHERE ur.usuario_id = ? ",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\superadmin\\application\\services\\superadmin_usuario_service.py",
    "line": 335,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "            query = \"\"\"\n            SELECT \n                r.rol_id,\n                r.nombre,\n                r.codigo_rol,\n                r.nivel_acceso,\n                r.es_rol_sistema,\n                ur.fecha_asignacion,\n                ur.es_activo\n            FROM dbo.rol r\n            INNER JOIN dbo.usuario_rol ur ON r.rol_id = ur.rol_id\n            WHERE ur.usuario_id = ? ",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\superadmin\\application\\services\\superadmin_usuario_service.py",
    "line": 335,
    "issue": "Query SQL directa toca tabla usuario_rol sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario_rol",
    "context": "            query = \"\"\"\n            SELECT \n                r.rol_id,\n                r.nombre,\n                r.codigo_rol,\n                r.nivel_acceso,\n                r.es_rol_sistema,\n                ur.fecha_asignacion,\n                ur.es_activo\n            FROM dbo.rol r\n            INNER JOIN dbo.usuario_rol ur ON r.rol_id = ur.rol_id\n            WHERE ur.usuario_id = ? ",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\tenant\\presentation\\schemas.py",
    "line": 938,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "\nclass ConexionUpdate(BaseModel):\n    \"\"\"\n    Esquema para la actualización parcial de una conexión.\n    Todos los campos son opcionales, incluyendo credenciales.\n    \"\"\"\n    servidor: Optional[str] = Field(None, max_length=255)\n    puerto: Optional[int] = None\n    nombre_bd: Optional[str] = Field(None, max_length=100)\n    usuario: Optional[str] = Field(None, description=\"Nuevo usuario de BD (se encriptará).\")\n    password: Optional[str] = Field(None, description=\"Nuevo password de BD (se encrip",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\tenant\\presentation\\schemas.py",
    "line": 1121,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "\nclass ModuloActivoUpdate(BaseModel):\n    \"\"\"\n    Esquema para la actualización parcial de un módulo activo.\n    Permite modificar configuraciones y límites sin cambiar el estado de activación.\n    \"\"\"\n    configuracion_json: Optional[Dict[str, Any]] = None\n    limite_usuarios: Optional[int] = None\n    limite_registros: Optional[int] = None\n    fecha_vencimiento: Optional[datetime] = Field(\n        None, \n        description=\"Nueva fecha de vencimiento de la licencia.\"",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\tenant\\application\\services\\cliente_service.py",
    "line": 615,
    "issue": "Query con text() toca tabla usuario (verificar uso de cliente_id)",
    "severity": "medium",
    "tabla": "usuario",
    "context": "        usuarios_result = await execute_query(\n            text(usuarios_query).bindparams(cliente_id=cliente_id),\n            connection_type=DatabaseConnection.ADMIN,\n            client_id=None\n        )\n        usuarios_stats = usuarios_result[0] if usuarios_result else {'total_activos': 0, 'total_inactivos': 0}\n        \n        # Estadísticas de módulos\n        # ✅ REFACTORIZACIÓN: Usar tabla cliente_modulo en lugar de cliente_modulo_activo\n        modulos_query = \"\"\"\n        SELECT \n       ",
    "type": "text() - tiene cliente_id"
  },
  {
    "file": "app\\modules\\tenant\\application\\services\\cliente_service.py",
    "line": 646,
    "issue": "Query con text() toca tabla usuario (verificar uso de cliente_id)",
    "severity": "medium",
    "tabla": "usuario",
    "context": "        conexiones_result = await execute_query(\n            text(conexiones_query).bindparams(cliente_id=cliente_id),\n            connection_type=DatabaseConnection.ADMIN,\n            client_id=None\n        )\n        conexiones_count = conexiones_result[0]['total_conexiones'] if conexiones_result else 0\n        \n        # Calcular días activo\n        dias_activo = 0\n        if cliente.fecha_creacion:\n            delta = datetime.now() - cliente.fecha_creacion\n            dias_activo = delta.day",
    "type": "text() - tiene cliente_id"
  },
  {
    "file": "app\\modules\\tenant\\application\\services\\conexion_service.py",
    "line": 63,
    "issue": "Query con text() toca tabla usuario (verificar uso de cliente_id)",
    "severity": "medium",
    "tabla": "usuario",
    "context": "        resultados = await execute_query(\n            text(query).bindparams(cliente_id=cliente_id),\n            connection_type=DatabaseConnection.ADMIN,\n            client_id=None\n        )\n        return [ConexionRead(**conexion) for conexion in resultados]\n\n    @staticmethod\n    @BaseService.handle_service_errors\n    async def obtener_conexion_por_id(conexion_id: UUID) -> Optional[ConexionRead]:\n        \"\"\"\n        Obtiene una conexión específica por su ID.\n        \"\"\"\n        query = \"\"\"\n  ",
    "type": "text() - tiene cliente_id"
  },
  {
    "file": "app\\modules\\tenant\\application\\services\\conexion_service.py",
    "line": 89,
    "issue": "Query con text() toca tabla usuario (verificar uso de cliente_id)",
    "severity": "medium",
    "tabla": "usuario",
    "context": "        resultado = await execute_query(\n            text(query).bindparams(conexion_id=conexion_id),\n            connection_type=DatabaseConnection.ADMIN,\n            client_id=None\n        )\n        if not resultado:\n            return None\n        return ConexionRead(**resultado[0])\n\n    @staticmethod\n    @BaseService.handle_service_errors\n    async def obtener_conexion_principal(cliente_id: UUID) -> Optional[ConexionRead]:\n        \"\"\"\n        Obtiene la conexión principal para un cliente esp",
    "type": "text() - tiene cliente_id"
  },
  {
    "file": "app\\modules\\tenant\\application\\services\\conexion_service.py",
    "line": 143,
    "issue": "Query con text() toca tabla usuario (verificar uso de cliente_id)",
    "severity": "medium",
    "tabla": "usuario",
    "context": "        resultado = await execute_query(\n            text(query).bindparams(**bind_params),\n            connection_type=DatabaseConnection.ADMIN,\n            client_id=None\n        )\n        if resultado:\n            raise ConflictError(\n                detail=\"Ya existe una conexión principal activa para este cliente.\",\n                internal_code=\"PRIMARY_CONNECTION_CONFLICT\"\n            )\n\n    @staticmethod\n    @BaseService.handle_service_errors\n    async def _encriptar_credenciales(usuario",
    "type": "text() - tiene cliente_id"
  },
  {
    "file": "app\\modules\\tenant\\application\\services\\conexion_service.py",
    "line": 227,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "            INSERTED.servidor,\n            INSERTED.puerto,\n            INSERTED.nombre_bd,\n            INSERTED.usuario_encriptado,\n            INSERTED.password_encriptado,\n            INSERTED.connection_string_encriptado,\n            INSERTED.tipo_bd,\n            INSERTED.usa_ssl,\n            INSERTED.timeout_segundos,\n            INSERTED.max_pool_size,\n            INSERTED.es_solo_lectura,\n            INSERTED.es_conexion_principal,",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\tenant\\application\\services\\conexion_service.py",
    "line": 228,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "            INSERTED.puerto,\n            INSERTED.nombre_bd,\n            INSERTED.usuario_encriptado,\n            INSERTED.password_encriptado,\n            INSERTED.connection_string_encriptado,\n            INSERTED.tipo_bd,\n            INSERTED.usa_ssl,\n            INSERTED.timeout_segundos,\n            INSERTED.max_pool_size,\n            INSERTED.es_solo_lectura,\n            INSERTED.es_conexion_principal,\n            INSERTED.es_activo,",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\tenant\\application\\services\\conexion_service.py",
    "line": 229,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "            INSERTED.nombre_bd,\n            INSERTED.usuario_encriptado,\n            INSERTED.password_encriptado,\n            INSERTED.connection_string_encriptado,\n            INSERTED.tipo_bd,\n            INSERTED.usa_ssl,\n            INSERTED.timeout_segundos,\n            INSERTED.max_pool_size,\n            INSERTED.es_solo_lectura,\n            INSERTED.es_conexion_principal,\n            INSERTED.es_activo,\n            INSERTED.ultima_conexion_exitosa,",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\tenant\\application\\services\\conexion_service.py",
    "line": 230,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "            INSERTED.usuario_encriptado,\n            INSERTED.password_encriptado,\n            INSERTED.connection_string_encriptado,\n            INSERTED.tipo_bd,\n            INSERTED.usa_ssl,\n            INSERTED.timeout_segundos,\n            INSERTED.max_pool_size,\n            INSERTED.es_solo_lectura,\n            INSERTED.es_conexion_principal,\n            INSERTED.es_activo,\n            INSERTED.ultima_conexion_exitosa,\n            INSERTED.ultimo_error,",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\tenant\\application\\services\\conexion_service.py",
    "line": 234,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "            INSERTED.usa_ssl,\n            INSERTED.timeout_segundos,\n            INSERTED.max_pool_size,\n            INSERTED.es_solo_lectura,\n            INSERTED.es_conexion_principal,\n            INSERTED.es_activo,\n            INSERTED.ultima_conexion_exitosa,\n            INSERTED.ultimo_error,\n            INSERTED.fecha_ultimo_error,\n            INSERTED.fecha_creacion,\n            INSERTED.fecha_actualizacion,\n            INSERTED.creado_por_usuario_id",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\tenant\\application\\services\\conexion_service.py",
    "line": 235,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "            INSERTED.timeout_segundos,\n            INSERTED.max_pool_size,\n            INSERTED.es_solo_lectura,\n            INSERTED.es_conexion_principal,\n            INSERTED.es_activo,\n            INSERTED.ultima_conexion_exitosa,\n            INSERTED.ultimo_error,\n            INSERTED.fecha_ultimo_error,\n            INSERTED.fecha_creacion,\n            INSERTED.fecha_actualizacion,\n            INSERTED.creado_por_usuario_id\n        VALUES ({', '.join(['?'] * len(fields))})",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\tenant\\application\\services\\conexion_service.py",
    "line": 236,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "            INSERTED.max_pool_size,\n            INSERTED.es_solo_lectura,\n            INSERTED.es_conexion_principal,\n            INSERTED.es_activo,\n            INSERTED.ultima_conexion_exitosa,\n            INSERTED.ultimo_error,\n            INSERTED.fecha_ultimo_error,\n            INSERTED.fecha_creacion,\n            INSERTED.fecha_actualizacion,\n            INSERTED.creado_por_usuario_id\n        VALUES ({', '.join(['?'] * len(fields))})\n        \"\"\"",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\tenant\\application\\services\\conexion_service.py",
    "line": 237,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "            INSERTED.es_solo_lectura,\n            INSERTED.es_conexion_principal,\n            INSERTED.es_activo,\n            INSERTED.ultima_conexion_exitosa,\n            INSERTED.ultimo_error,\n            INSERTED.fecha_ultimo_error,\n            INSERTED.fecha_creacion,\n            INSERTED.fecha_actualizacion,\n            INSERTED.creado_por_usuario_id\n        VALUES ({', '.join(['?'] * len(fields))})\n        \"\"\"\n",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\tenant\\application\\services\\conexion_service.py",
    "line": 238,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "            INSERTED.es_conexion_principal,\n            INSERTED.es_activo,\n            INSERTED.ultima_conexion_exitosa,\n            INSERTED.ultimo_error,\n            INSERTED.fecha_ultimo_error,\n            INSERTED.fecha_creacion,\n            INSERTED.fecha_actualizacion,\n            INSERTED.creado_por_usuario_id\n        VALUES ({', '.join(['?'] * len(fields))})\n        \"\"\"\n\n        # ✅ FASE 2: Usar await",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\tenant\\application\\services\\conexion_service.py",
    "line": 239,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "            INSERTED.es_activo,\n            INSERTED.ultima_conexion_exitosa,\n            INSERTED.ultimo_error,\n            INSERTED.fecha_ultimo_error,\n            INSERTED.fecha_creacion,\n            INSERTED.fecha_actualizacion,\n            INSERTED.creado_por_usuario_id\n        VALUES ({', '.join(['?'] * len(fields))})\n        \"\"\"\n\n        # ✅ FASE 2: Usar await\n        resultado = await execute_insert(query, tuple(params), connection_type=DatabaseConnection.ADMIN)",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\tenant\\application\\services\\conexion_service.py",
    "line": 240,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "            INSERTED.ultima_conexion_exitosa,\n            INSERTED.ultimo_error,\n            INSERTED.fecha_ultimo_error,\n            INSERTED.fecha_creacion,\n            INSERTED.fecha_actualizacion,\n            INSERTED.creado_por_usuario_id\n        VALUES ({', '.join(['?'] * len(fields))})\n        \"\"\"\n\n        # ✅ FASE 2: Usar await\n        resultado = await execute_insert(query, tuple(params), connection_type=DatabaseConnection.ADMIN)\n        if not resultado:",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\tenant\\application\\services\\conexion_service.py",
    "line": 241,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "            INSERTED.ultimo_error,\n            INSERTED.fecha_ultimo_error,\n            INSERTED.fecha_creacion,\n            INSERTED.fecha_actualizacion,\n            INSERTED.creado_por_usuario_id\n        VALUES ({', '.join(['?'] * len(fields))})\n        \"\"\"\n\n        # ✅ FASE 2: Usar await\n        resultado = await execute_insert(query, tuple(params), connection_type=DatabaseConnection.ADMIN)\n        if not resultado:\n            raise ServiceError(",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\tenant\\application\\services\\conexion_service.py",
    "line": 242,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "            INSERTED.fecha_ultimo_error,\n            INSERTED.fecha_creacion,\n            INSERTED.fecha_actualizacion,\n            INSERTED.creado_por_usuario_id\n        VALUES ({', '.join(['?'] * len(fields))})\n        \"\"\"\n\n        # ✅ FASE 2: Usar await\n        resultado = await execute_insert(query, tuple(params), connection_type=DatabaseConnection.ADMIN)\n        if not resultado:\n            raise ServiceError(\n                status_code=500,",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\tenant\\application\\services\\conexion_service.py",
    "line": 243,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "            INSERTED.fecha_creacion,\n            INSERTED.fecha_actualizacion,\n            INSERTED.creado_por_usuario_id\n        VALUES ({', '.join(['?'] * len(fields))})\n        \"\"\"\n\n        # ✅ FASE 2: Usar await\n        resultado = await execute_insert(query, tuple(params), connection_type=DatabaseConnection.ADMIN)\n        if not resultado:\n            raise ServiceError(\n                status_code=500,\n                detail=\"No se pudo crear la conexión en la base de datos.\",",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\tenant\\application\\services\\conexion_service.py",
    "line": 244,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "            INSERTED.fecha_actualizacion,\n            INSERTED.creado_por_usuario_id\n        VALUES ({', '.join(['?'] * len(fields))})\n        \"\"\"\n\n        # ✅ FASE 2: Usar await\n        resultado = await execute_insert(query, tuple(params), connection_type=DatabaseConnection.ADMIN)\n        if not resultado:\n            raise ServiceError(\n                status_code=500,\n                detail=\"No se pudo crear la conexión en la base de datos.\",\n                internal_code=\"CONNECTION_CREATIO",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\tenant\\application\\services\\conexion_service.py",
    "line": 284,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "        # Construir query dinámica\n        update_fields = []\n        params = []\n        \n        for field, value in conexion_data.dict(exclude_unset=True).items():\n            if value is not None and field not in ['usuario', 'password']:\n                update_fields.append(f\"{field} = ?\")\n                params.append(value)\n                \n        # Manejar actualización de credenciales\n        if conexion_data.usuario or conexion_data.password:\n            credenciales_encriptadas = awai",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\tenant\\application\\services\\conexion_service.py",
    "line": 289,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "            if value is not None and field not in ['usuario', 'password']:\n                update_fields.append(f\"{field} = ?\")\n                params.append(value)\n                \n        # Manejar actualización de credenciales\n        if conexion_data.usuario or conexion_data.password:\n            credenciales_encriptadas = await ConexionService._encriptar_credenciales(\n                conexion_data.usuario or \"\",\n                conexion_data.password or \"\"\n            )\n            update_f",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\tenant\\application\\services\\conexion_service.py",
    "line": 298,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "            )\n            update_fields.append(\"usuario_encriptado = ?\")\n            params.append(credenciales_encriptadas[\"usuario_encriptado\"])\n            update_fields.append(\"password_encriptado = ?\")\n            params.append(credenciales_encriptadas[\"password_encriptado\"])\n                \n        if not update_fields:\n            raise ValidationError(\n                detail=\"No se proporcionaron campos para actualizar.\",\n                internal_code=\"NO_UPDATE_FIELDS\"\n            )\n  ",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\tenant\\application\\services\\conexion_service.py",
    "line": 300,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "            params.append(credenciales_encriptadas[\"usuario_encriptado\"])\n            update_fields.append(\"password_encriptado = ?\")\n            params.append(credenciales_encriptadas[\"password_encriptado\"])\n                \n        if not update_fields:\n            raise ValidationError(\n                detail=\"No se proporcionaron campos para actualizar.\",\n                internal_code=\"NO_UPDATE_FIELDS\"\n            )\n            \n        params.append(conexion_id)\n",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\tenant\\application\\services\\conexion_service.py",
    "line": 318,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "            INSERTED.servidor,\n            INSERTED.puerto,\n            INSERTED.nombre_bd,\n            INSERTED.usuario_encriptado,\n            INSERTED.password_encriptado,\n            INSERTED.connection_string_encriptado,\n            INSERTED.tipo_bd,\n            INSERTED.usa_ssl,\n            INSERTED.timeout_segundos,\n            INSERTED.max_pool_size,\n            INSERTED.es_solo_lectura,\n            INSERTED.es_conexion_principal,",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\tenant\\application\\services\\conexion_service.py",
    "line": 319,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "            INSERTED.puerto,\n            INSERTED.nombre_bd,\n            INSERTED.usuario_encriptado,\n            INSERTED.password_encriptado,\n            INSERTED.connection_string_encriptado,\n            INSERTED.tipo_bd,\n            INSERTED.usa_ssl,\n            INSERTED.timeout_segundos,\n            INSERTED.max_pool_size,\n            INSERTED.es_solo_lectura,\n            INSERTED.es_conexion_principal,\n            INSERTED.es_activo,",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\tenant\\application\\services\\conexion_service.py",
    "line": 320,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "            INSERTED.nombre_bd,\n            INSERTED.usuario_encriptado,\n            INSERTED.password_encriptado,\n            INSERTED.connection_string_encriptado,\n            INSERTED.tipo_bd,\n            INSERTED.usa_ssl,\n            INSERTED.timeout_segundos,\n            INSERTED.max_pool_size,\n            INSERTED.es_solo_lectura,\n            INSERTED.es_conexion_principal,\n            INSERTED.es_activo,\n            INSERTED.ultima_conexion_exitosa,",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\tenant\\application\\services\\conexion_service.py",
    "line": 321,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "            INSERTED.usuario_encriptado,\n            INSERTED.password_encriptado,\n            INSERTED.connection_string_encriptado,\n            INSERTED.tipo_bd,\n            INSERTED.usa_ssl,\n            INSERTED.timeout_segundos,\n            INSERTED.max_pool_size,\n            INSERTED.es_solo_lectura,\n            INSERTED.es_conexion_principal,\n            INSERTED.es_activo,\n            INSERTED.ultima_conexion_exitosa,\n            INSERTED.ultimo_error,",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\tenant\\application\\services\\conexion_service.py",
    "line": 325,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "            INSERTED.usa_ssl,\n            INSERTED.timeout_segundos,\n            INSERTED.max_pool_size,\n            INSERTED.es_solo_lectura,\n            INSERTED.es_conexion_principal,\n            INSERTED.es_activo,\n            INSERTED.ultima_conexion_exitosa,\n            INSERTED.ultimo_error,\n            INSERTED.fecha_ultimo_error,\n            INSERTED.fecha_creacion,\n            INSERTED.fecha_actualizacion,\n            INSERTED.creado_por_usuario_id",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\tenant\\application\\services\\conexion_service.py",
    "line": 326,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "            INSERTED.timeout_segundos,\n            INSERTED.max_pool_size,\n            INSERTED.es_solo_lectura,\n            INSERTED.es_conexion_principal,\n            INSERTED.es_activo,\n            INSERTED.ultima_conexion_exitosa,\n            INSERTED.ultimo_error,\n            INSERTED.fecha_ultimo_error,\n            INSERTED.fecha_creacion,\n            INSERTED.fecha_actualizacion,\n            INSERTED.creado_por_usuario_id\n        WHERE conexion_id = ?",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\tenant\\application\\services\\conexion_service.py",
    "line": 327,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "            INSERTED.max_pool_size,\n            INSERTED.es_solo_lectura,\n            INSERTED.es_conexion_principal,\n            INSERTED.es_activo,\n            INSERTED.ultima_conexion_exitosa,\n            INSERTED.ultimo_error,\n            INSERTED.fecha_ultimo_error,\n            INSERTED.fecha_creacion,\n            INSERTED.fecha_actualizacion,\n            INSERTED.creado_por_usuario_id\n        WHERE conexion_id = ?\n        \"\"\"",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\tenant\\application\\services\\conexion_service.py",
    "line": 328,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "            INSERTED.es_solo_lectura,\n            INSERTED.es_conexion_principal,\n            INSERTED.es_activo,\n            INSERTED.ultima_conexion_exitosa,\n            INSERTED.ultimo_error,\n            INSERTED.fecha_ultimo_error,\n            INSERTED.fecha_creacion,\n            INSERTED.fecha_actualizacion,\n            INSERTED.creado_por_usuario_id\n        WHERE conexion_id = ?\n        \"\"\"\n",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\tenant\\application\\services\\conexion_service.py",
    "line": 329,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "            INSERTED.es_conexion_principal,\n            INSERTED.es_activo,\n            INSERTED.ultima_conexion_exitosa,\n            INSERTED.ultimo_error,\n            INSERTED.fecha_ultimo_error,\n            INSERTED.fecha_creacion,\n            INSERTED.fecha_actualizacion,\n            INSERTED.creado_por_usuario_id\n        WHERE conexion_id = ?\n        \"\"\"\n\n        # ✅ FASE 2: Usar await",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\tenant\\application\\services\\conexion_service.py",
    "line": 330,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "            INSERTED.es_activo,\n            INSERTED.ultima_conexion_exitosa,\n            INSERTED.ultimo_error,\n            INSERTED.fecha_ultimo_error,\n            INSERTED.fecha_creacion,\n            INSERTED.fecha_actualizacion,\n            INSERTED.creado_por_usuario_id\n        WHERE conexion_id = ?\n        \"\"\"\n\n        # ✅ FASE 2: Usar await\n        resultado = await execute_update(query, tuple(params), connection_type=DatabaseConnection.ADMIN)",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\tenant\\application\\services\\conexion_service.py",
    "line": 331,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "            INSERTED.ultima_conexion_exitosa,\n            INSERTED.ultimo_error,\n            INSERTED.fecha_ultimo_error,\n            INSERTED.fecha_creacion,\n            INSERTED.fecha_actualizacion,\n            INSERTED.creado_por_usuario_id\n        WHERE conexion_id = ?\n        \"\"\"\n\n        # ✅ FASE 2: Usar await\n        resultado = await execute_update(query, tuple(params), connection_type=DatabaseConnection.ADMIN)\n        if not resultado:",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\tenant\\application\\services\\conexion_service.py",
    "line": 332,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "            INSERTED.ultimo_error,\n            INSERTED.fecha_ultimo_error,\n            INSERTED.fecha_creacion,\n            INSERTED.fecha_actualizacion,\n            INSERTED.creado_por_usuario_id\n        WHERE conexion_id = ?\n        \"\"\"\n\n        # ✅ FASE 2: Usar await\n        resultado = await execute_update(query, tuple(params), connection_type=DatabaseConnection.ADMIN)\n        if not resultado:\n            raise ServiceError(",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\tenant\\application\\services\\conexion_service.py",
    "line": 333,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "            INSERTED.fecha_ultimo_error,\n            INSERTED.fecha_creacion,\n            INSERTED.fecha_actualizacion,\n            INSERTED.creado_por_usuario_id\n        WHERE conexion_id = ?\n        \"\"\"\n\n        # ✅ FASE 2: Usar await\n        resultado = await execute_update(query, tuple(params), connection_type=DatabaseConnection.ADMIN)\n        if not resultado:\n            raise ServiceError(\n                status_code=500,",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\tenant\\application\\services\\conexion_service.py",
    "line": 334,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "            INSERTED.fecha_creacion,\n            INSERTED.fecha_actualizacion,\n            INSERTED.creado_por_usuario_id\n        WHERE conexion_id = ?\n        \"\"\"\n\n        # ✅ FASE 2: Usar await\n        resultado = await execute_update(query, tuple(params), connection_type=DatabaseConnection.ADMIN)\n        if not resultado:\n            raise ServiceError(\n                status_code=500,\n                detail=\"No se pudo actualizar la conexión.\",",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\tenant\\application\\services\\conexion_service.py",
    "line": 335,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "            INSERTED.fecha_actualizacion,\n            INSERTED.creado_por_usuario_id\n        WHERE conexion_id = ?\n        \"\"\"\n\n        # ✅ FASE 2: Usar await\n        resultado = await execute_update(query, tuple(params), connection_type=DatabaseConnection.ADMIN)\n        if not resultado:\n            raise ServiceError(\n                status_code=500,\n                detail=\"No se pudo actualizar la conexión.\",\n                internal_code=\"CONNECTION_UPDATE_FAILED\"",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\tenant\\application\\services\\conexion_service.py",
    "line": 417,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "            INSERTED.servidor,\n            INSERTED.puerto,\n            INSERTED.nombre_bd,\n            INSERTED.usuario_encriptado,\n            INSERTED.password_encriptado,\n            INSERTED.connection_string_encriptado,\n            INSERTED.tipo_bd,\n            INSERTED.usa_ssl,\n            INSERTED.timeout_segundos,\n            INSERTED.max_pool_size,\n            INSERTED.es_solo_lectura,\n            INSERTED.es_conexion_principal,",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\tenant\\application\\services\\conexion_service.py",
    "line": 418,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "            INSERTED.puerto,\n            INSERTED.nombre_bd,\n            INSERTED.usuario_encriptado,\n            INSERTED.password_encriptado,\n            INSERTED.connection_string_encriptado,\n            INSERTED.tipo_bd,\n            INSERTED.usa_ssl,\n            INSERTED.timeout_segundos,\n            INSERTED.max_pool_size,\n            INSERTED.es_solo_lectura,\n            INSERTED.es_conexion_principal,\n            INSERTED.es_activo,",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\tenant\\application\\services\\conexion_service.py",
    "line": 419,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "            INSERTED.nombre_bd,\n            INSERTED.usuario_encriptado,\n            INSERTED.password_encriptado,\n            INSERTED.connection_string_encriptado,\n            INSERTED.tipo_bd,\n            INSERTED.usa_ssl,\n            INSERTED.timeout_segundos,\n            INSERTED.max_pool_size,\n            INSERTED.es_solo_lectura,\n            INSERTED.es_conexion_principal,\n            INSERTED.es_activo,\n            INSERTED.ultima_conexion_exitosa,",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\tenant\\application\\services\\conexion_service.py",
    "line": 420,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "            INSERTED.usuario_encriptado,\n            INSERTED.password_encriptado,\n            INSERTED.connection_string_encriptado,\n            INSERTED.tipo_bd,\n            INSERTED.usa_ssl,\n            INSERTED.timeout_segundos,\n            INSERTED.max_pool_size,\n            INSERTED.es_solo_lectura,\n            INSERTED.es_conexion_principal,\n            INSERTED.es_activo,\n            INSERTED.ultima_conexion_exitosa,\n            INSERTED.ultimo_error,",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\tenant\\application\\services\\conexion_service.py",
    "line": 424,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "            INSERTED.usa_ssl,\n            INSERTED.timeout_segundos,\n            INSERTED.max_pool_size,\n            INSERTED.es_solo_lectura,\n            INSERTED.es_conexion_principal,\n            INSERTED.es_activo,\n            INSERTED.ultima_conexion_exitosa,\n            INSERTED.ultimo_error,\n            INSERTED.fecha_ultimo_error,\n            INSERTED.fecha_creacion,\n            INSERTED.fecha_actualizacion,\n            INSERTED.creado_por_usuario_id",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\tenant\\application\\services\\conexion_service.py",
    "line": 425,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "            INSERTED.timeout_segundos,\n            INSERTED.max_pool_size,\n            INSERTED.es_solo_lectura,\n            INSERTED.es_conexion_principal,\n            INSERTED.es_activo,\n            INSERTED.ultima_conexion_exitosa,\n            INSERTED.ultimo_error,\n            INSERTED.fecha_ultimo_error,\n            INSERTED.fecha_creacion,\n            INSERTED.fecha_actualizacion,\n            INSERTED.creado_por_usuario_id\n        WHERE conexion_id = ?",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\tenant\\application\\services\\conexion_service.py",
    "line": 426,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "            INSERTED.max_pool_size,\n            INSERTED.es_solo_lectura,\n            INSERTED.es_conexion_principal,\n            INSERTED.es_activo,\n            INSERTED.ultima_conexion_exitosa,\n            INSERTED.ultimo_error,\n            INSERTED.fecha_ultimo_error,\n            INSERTED.fecha_creacion,\n            INSERTED.fecha_actualizacion,\n            INSERTED.creado_por_usuario_id\n        WHERE conexion_id = ?\n        \"\"\"",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\tenant\\application\\services\\conexion_service.py",
    "line": 427,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "            INSERTED.es_solo_lectura,\n            INSERTED.es_conexion_principal,\n            INSERTED.es_activo,\n            INSERTED.ultima_conexion_exitosa,\n            INSERTED.ultimo_error,\n            INSERTED.fecha_ultimo_error,\n            INSERTED.fecha_creacion,\n            INSERTED.fecha_actualizacion,\n            INSERTED.creado_por_usuario_id\n        WHERE conexion_id = ?\n        \"\"\"\n",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\tenant\\application\\services\\conexion_service.py",
    "line": 428,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "            INSERTED.es_conexion_principal,\n            INSERTED.es_activo,\n            INSERTED.ultima_conexion_exitosa,\n            INSERTED.ultimo_error,\n            INSERTED.fecha_ultimo_error,\n            INSERTED.fecha_creacion,\n            INSERTED.fecha_actualizacion,\n            INSERTED.creado_por_usuario_id\n        WHERE conexion_id = ?\n        \"\"\"\n\n        # ✅ FASE 2: Usar await",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\tenant\\application\\services\\conexion_service.py",
    "line": 429,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "            INSERTED.es_activo,\n            INSERTED.ultima_conexion_exitosa,\n            INSERTED.ultimo_error,\n            INSERTED.fecha_ultimo_error,\n            INSERTED.fecha_creacion,\n            INSERTED.fecha_actualizacion,\n            INSERTED.creado_por_usuario_id\n        WHERE conexion_id = ?\n        \"\"\"\n\n        # ✅ FASE 2: Usar await\n        resultado = await execute_update(query, (conexion_id,), connection_type=DatabaseConnection.ADMIN)",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\tenant\\application\\services\\conexion_service.py",
    "line": 430,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "            INSERTED.ultima_conexion_exitosa,\n            INSERTED.ultimo_error,\n            INSERTED.fecha_ultimo_error,\n            INSERTED.fecha_creacion,\n            INSERTED.fecha_actualizacion,\n            INSERTED.creado_por_usuario_id\n        WHERE conexion_id = ?\n        \"\"\"\n\n        # ✅ FASE 2: Usar await\n        resultado = await execute_update(query, (conexion_id,), connection_type=DatabaseConnection.ADMIN)\n        if not resultado:",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\tenant\\application\\services\\conexion_service.py",
    "line": 431,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "            INSERTED.ultimo_error,\n            INSERTED.fecha_ultimo_error,\n            INSERTED.fecha_creacion,\n            INSERTED.fecha_actualizacion,\n            INSERTED.creado_por_usuario_id\n        WHERE conexion_id = ?\n        \"\"\"\n\n        # ✅ FASE 2: Usar await\n        resultado = await execute_update(query, (conexion_id,), connection_type=DatabaseConnection.ADMIN)\n        if not resultado:\n            raise ServiceError(",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\tenant\\application\\services\\conexion_service.py",
    "line": 432,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "            INSERTED.fecha_ultimo_error,\n            INSERTED.fecha_creacion,\n            INSERTED.fecha_actualizacion,\n            INSERTED.creado_por_usuario_id\n        WHERE conexion_id = ?\n        \"\"\"\n\n        # ✅ FASE 2: Usar await\n        resultado = await execute_update(query, (conexion_id,), connection_type=DatabaseConnection.ADMIN)\n        if not resultado:\n            raise ServiceError(\n                status_code=500,",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\tenant\\application\\services\\conexion_service.py",
    "line": 433,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "            INSERTED.fecha_creacion,\n            INSERTED.fecha_actualizacion,\n            INSERTED.creado_por_usuario_id\n        WHERE conexion_id = ?\n        \"\"\"\n\n        # ✅ FASE 2: Usar await\n        resultado = await execute_update(query, (conexion_id,), connection_type=DatabaseConnection.ADMIN)\n        if not resultado:\n            raise ServiceError(\n                status_code=500,\n                detail=\"No se pudo desactivar la conexión.\",",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\tenant\\application\\services\\conexion_service.py",
    "line": 434,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "            INSERTED.fecha_actualizacion,\n            INSERTED.creado_por_usuario_id\n        WHERE conexion_id = ?\n        \"\"\"\n\n        # ✅ FASE 2: Usar await\n        resultado = await execute_update(query, (conexion_id,), connection_type=DatabaseConnection.ADMIN)\n        if not resultado:\n            raise ServiceError(\n                status_code=500,\n                detail=\"No se pudo desactivar la conexión.\",\n                internal_code=\"CONNECTION_DEACTIVATION_FAILED\"",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\tenant\\application\\services\\modulo_activo_service.py",
    "line": 255,
    "issue": "Query con text() toca tabla usuario (verificar uso de cliente_id)",
    "severity": "medium",
    "tabla": "usuario",
    "context": "        existe_raw = await execute_query(\n            text(query_existe).bindparams(cliente_id=modulo_data.cliente_id, modulo_id=modulo_data.modulo_id),\n            connection_type=DatabaseConnection.ADMIN,\n            client_id=None\n        )\n        \n        # Preparar datos\n        configuracion_json = json.dumps(modulo_data.configuracion_json) if modulo_data.configuracion_json else None\n\n        if existe_raw:\n            # ✅ El registro ya existe: hacer UPDATE\n            modulo_activo_id =",
    "type": "text() - tiene cliente_id"
  },
  {
    "file": "app\\modules\\tenant\\application\\services\\modulo_activo_service.py",
    "line": 268,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "            \n            query_update = \"\"\"\n            UPDATE cliente_modulo_activo\n            SET esta_activo = 1,\n                fecha_vencimiento = :fecha_vencimiento,\n                configuracion_json = :configuracion_json,\n                limite_usuarios = :limite_usuarios,\n                limite_registros = :limite_registros\n            WHERE cliente_modulo_activo_id = :modulo_activo_id\n            \"\"\"\n            \n            bind_params = {",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\tenant\\application\\services\\modulo_activo_service.py",
    "line": 269,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "            query_update = \"\"\"\n            UPDATE cliente_modulo_activo\n            SET esta_activo = 1,\n                fecha_vencimiento = :fecha_vencimiento,\n                configuracion_json = :configuracion_json,\n                limite_usuarios = :limite_usuarios,\n                limite_registros = :limite_registros\n            WHERE cliente_modulo_activo_id = :modulo_activo_id\n            \"\"\"\n            \n            bind_params = {\n                \"fecha_vencimiento\": modulo_data.fecha_v",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\tenant\\application\\services\\modulo_activo_service.py",
    "line": 288,
    "issue": "Query con text() toca tabla usuario (verificar uso de cliente_id)",
    "severity": "medium",
    "tabla": "usuario",
    "context": "            resultado_update = await execute_update(\n                text(query_update).bindparams(**bind_params),\n                connection_type=DatabaseConnection.ADMIN,\n                client_id=None\n            )\n            \n            if resultado_update.get('rows_affected', 0) == 0:\n                raise ServiceError(\n                    status_code=500,\n                    detail=\"No se pudo activar el módulo para el cliente.\",\n                    internal_code=\"MODULE_ACTIVATION_FAILE",
    "type": "text() - tiene cliente_id"
  },
  {
    "file": "app\\modules\\tenant\\application\\services\\modulo_activo_service.py",
    "line": 327,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "                INSERTED.modulo_id,\n                INSERTED.esta_activo,\n                INSERTED.fecha_activacion,\n                INSERTED.fecha_vencimiento,\n                INSERTED.configuracion_json,\n                INSERTED.limite_usuarios,\n                INSERTED.limite_registros\n            VALUES ({', '.join([f':param_{i}' for i in range(len(fields))])})\n            \"\"\"\n\n            bind_params = {f\"param_{i}\": value for i, value in enumerate(params)}\n            resultado = await exe",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\tenant\\application\\services\\modulo_activo_service.py",
    "line": 328,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "                INSERTED.esta_activo,\n                INSERTED.fecha_activacion,\n                INSERTED.fecha_vencimiento,\n                INSERTED.configuracion_json,\n                INSERTED.limite_usuarios,\n                INSERTED.limite_registros\n            VALUES ({', '.join([f':param_{i}' for i in range(len(fields))])})\n            \"\"\"\n\n            bind_params = {f\"param_{i}\": value for i, value in enumerate(params)}\n            resultado = await execute_insert(\n                text(qu",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\tenant\\application\\services\\modulo_activo_service.py",
    "line": 329,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "                INSERTED.fecha_activacion,\n                INSERTED.fecha_vencimiento,\n                INSERTED.configuracion_json,\n                INSERTED.limite_usuarios,\n                INSERTED.limite_registros\n            VALUES ({', '.join([f':param_{i}' for i in range(len(fields))])})\n            \"\"\"\n\n            bind_params = {f\"param_{i}\": value for i, value in enumerate(params)}\n            resultado = await execute_insert(\n                text(query).bindparams(**bind_params),\n      ",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\tenant\\application\\services\\modulo_activo_service.py",
    "line": 411,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "            INSERTED.modulo_id,\n            INSERTED.esta_activo,\n            INSERTED.fecha_activacion,\n            INSERTED.fecha_vencimiento,\n            INSERTED.configuracion_json,\n            INSERTED.limite_usuarios,\n            INSERTED.limite_registros\n        WHERE cliente_modulo_activo_id = :modulo_activo_id\n        \"\"\"\n\n        resultado = await execute_update(\n            text(query).bindparams(**bind_params),",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\tenant\\application\\services\\modulo_activo_service.py",
    "line": 412,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "            INSERTED.esta_activo,\n            INSERTED.fecha_activacion,\n            INSERTED.fecha_vencimiento,\n            INSERTED.configuracion_json,\n            INSERTED.limite_usuarios,\n            INSERTED.limite_registros\n        WHERE cliente_modulo_activo_id = :modulo_activo_id\n        \"\"\"\n\n        resultado = await execute_update(\n            text(query).bindparams(**bind_params),\n            connection_type=DatabaseConnection.ADMIN,",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\tenant\\application\\services\\tenant_service.py",
    "line": 88,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "        query = \"\"\"\n        SELECT \n            cma.cliente_modulo_activo_id,\n            cm.modulo_id,\n            cm.codigo_modulo,\n            cm.nombre,\n            cm.descripcion,\n            cma.esta_activo,\n            cma.fecha_activacion,\n            cma.fecha_vencimiento,\n            cma.configuracion_json,\n            cma.limite_usuarios,",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\users\\presentation\\endpoints.py",
    "line": 28,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "    UsuarioCreate,\n    UsuarioUpdate,\n    UsuarioRead,\n    UsuarioReadWithRoles,\n    PaginatedUsuarioResponse,\n    UsuarioRolRead\n)\nfrom app.modules.rbac.presentation.schemas import RolRead\n\n# Importar Servicios\nfrom app.modules.users.application.services.user_service import UsuarioService\n",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\users\\presentation\\endpoints.py",
    "line": 28,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "    UsuarioCreate,\n    UsuarioUpdate,\n    UsuarioRead,\n    UsuarioReadWithRoles,\n    PaginatedUsuarioResponse,\n    UsuarioRolRead\n)\nfrom app.modules.rbac.presentation.schemas import RolRead\n\n# Importar Servicios\nfrom app.modules.users.application.services.user_service import UsuarioService\n",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\users\\presentation\\endpoints.py",
    "line": 310,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "    usuario_id: UUID = Path(..., description=\"ID del usuario\"),\n    usuario_in: UsuarioUpdate = Body(...),\n    current_user: UsuarioReadWithRoles = Depends(get_current_active_user)\n):\n    \"\"\"\n    Endpoint para actualizar parcialmente un usuario existente.\n    \n    Args:\n        usuario_id: Identificador único del usuario a actualizar\n        usuario_in: Campos a actualizar (actualización parcial)\n        current_user: Usuario autenticado y activo (inyectado por dependencia).\n        ",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\users\\presentation\\endpoints.py",
    "line": 310,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "    usuario_id: UUID = Path(..., description=\"ID del usuario\"),\n    usuario_in: UsuarioUpdate = Body(...),\n    current_user: UsuarioReadWithRoles = Depends(get_current_active_user)\n):\n    \"\"\"\n    Endpoint para actualizar parcialmente un usuario existente.\n    \n    Args:\n        usuario_id: Identificador único del usuario a actualizar\n        usuario_in: Campos a actualizar (actualización parcial)\n        current_user: Usuario autenticado y activo (inyectado por dependencia).\n        ",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\users\\presentation\\endpoints.py",
    "line": 361,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "\n@router.delete(\n    \"/{usuario_id}/\",\n    response_model=dict,\n    summary=\"Eliminar lógicamente un usuario\",\n    description=\"\"\"\n    Realiza un borrado lógico de un usuario estableciendo 'es_eliminado' a True y 'es_activo' a False.\n    \n    **Permisos requeridos:**\n    - Rol 'Administrador'\n    \n    **Parámetros de ruta:**",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\users\\presentation\\endpoints.py",
    "line": 361,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "\n@router.delete(\n    \"/{usuario_id}/\",\n    response_model=dict,\n    summary=\"Eliminar lógicamente un usuario\",\n    description=\"\"\"\n    Realiza un borrado lógico de un usuario estableciendo 'es_eliminado' a True y 'es_activo' a False.\n    \n    **Permisos requeridos:**\n    - Rol 'Administrador'\n    \n    **Parámetros de ruta:**",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\users\\presentation\\endpoints.py",
    "line": 422,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "    except Exception as e:\n        logger.exception(f\"Error inesperado en endpoint DELETE /usuarios/{usuario_id}/\")\n        raise HTTPException(\n            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,\n            detail=\"Error interno del servidor al eliminar el usuario.\"\n        )\n\n\n# --- ENDPOINTS PARA GESTIÓN DE ROLES DE USUARIO ---\n\n@router.post(\n    \"/{usuario_id}/roles/{rol_id}/\",",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\users\\presentation\\endpoints.py",
    "line": 422,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "    except Exception as e:\n        logger.exception(f\"Error inesperado en endpoint DELETE /usuarios/{usuario_id}/\")\n        raise HTTPException(\n            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,\n            detail=\"Error interno del servidor al eliminar el usuario.\"\n        )\n\n\n# --- ENDPOINTS PARA GESTIÓN DE ROLES DE USUARIO ---\n\n@router.post(\n    \"/{usuario_id}/roles/{rol_id}/\",",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\users\\presentation\\endpoints.py",
    "line": 503,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "\n@router.delete(\n    \"/{usuario_id}/roles/{rol_id}/\",\n    response_model=UsuarioRolRead,\n    summary=\"Revocar un rol de un usuario\",\n    description=\"\"\"\n    Revoca (desactiva) la asignación de un rol específico para un usuario.\n    \n    **Permisos requeridos:**\n    - Rol 'Administrador'\n    \n    **Parámetros de ruta:**",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\users\\presentation\\endpoints.py",
    "line": 503,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "\n@router.delete(\n    \"/{usuario_id}/roles/{rol_id}/\",\n    response_model=UsuarioRolRead,\n    summary=\"Revocar un rol de un usuario\",\n    description=\"\"\"\n    Revoca (desactiva) la asignación de un rol específico para un usuario.\n    \n    **Permisos requeridos:**\n    - Rol 'Administrador'\n    \n    **Parámetros de ruta:**",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\users\\presentation\\schemas.py",
    "line": 236,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "\nclass UsuarioUpdate(BaseModel):\n    \"\"\"\n    Schema para actualización parcial de usuarios (PATCH).\n    \n    Todos los campos son opcionales y solo se validan los que se proporcionen.\n    \"\"\"\n    \n    nombre_usuario: Optional[str] = Field(\n        None,\n        min_length=3,\n        max_length=100,",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\users\\presentation\\schemas.py",
    "line": 568,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "\nclass UsuarioRolUpdate(BaseModel):\n    \"\"\"\n    Schema para actualización del estado de asignaciones usuario-rol.\n    \n    Utilizado específicamente para activar/desactivar asignaciones\n    existentes sin modificar las relaciones fundamentales.\n    \"\"\"\n    \n    es_activo: bool = Field(\n        ...,\n        description=\"Nuevo estado activo/inactivo de la asignación\",",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\users\\presentation\\schemas.py",
    "line": 568,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "\nclass UsuarioRolUpdate(BaseModel):\n    \"\"\"\n    Schema para actualización del estado de asignaciones usuario-rol.\n    \n    Utilizado específicamente para activar/desactivar asignaciones\n    existentes sin modificar las relaciones fundamentales.\n    \"\"\"\n    \n    es_activo: bool = Field(\n        ...,\n        description=\"Nuevo estado activo/inactivo de la asignación\",",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\users\\application\\services\\user_service.py",
    "line": 11,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "from app.infrastructure.database.queries_async import (\n    execute_query, execute_insert, execute_update, execute_auth_query\n)\nfrom app.infrastructure.database.sql_constants import (\n    SELECT_USUARIOS_PAGINATED, COUNT_USUARIOS_PAGINATED\n)\n\n# 📋 SCHEMAS\nfrom app.modules.users.presentation.schemas import UsuarioReadWithRoles, PaginatedUsuarioResponse\nfrom app.modules.rbac.presentation.schemas import RolRead\n\n# 🔐 SEGURIDAD",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\users\\application\\services\\user_service.py",
    "line": 11,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "from app.infrastructure.database.queries_async import (\n    execute_query, execute_insert, execute_update, execute_auth_query\n)\nfrom app.infrastructure.database.sql_constants import (\n    SELECT_USUARIOS_PAGINATED, COUNT_USUARIOS_PAGINATED\n)\n\n# 📋 SCHEMAS\nfrom app.modules.users.presentation.schemas import UsuarioReadWithRoles, PaginatedUsuarioResponse\nfrom app.modules.rbac.presentation.schemas import RolRead\n\n# 🔐 SEGURIDAD",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\users\\application\\services\\user_service.py",
    "line": 14,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "from app.infrastructure.database.sql_constants import (\n    SELECT_USUARIOS_PAGINATED, COUNT_USUARIOS_PAGINATED\n)\n\n# 📋 SCHEMAS\nfrom app.modules.users.presentation.schemas import UsuarioReadWithRoles, PaginatedUsuarioResponse\nfrom app.modules.rbac.presentation.schemas import RolRead\n\n# 🔐 SEGURIDAD\nfrom app.core.security.password import get_password_hash\n\n# 🚨 EXCEPCIONES - Nuevo sistema de manejo de errores",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\users\\application\\services\\user_service.py",
    "line": 14,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "from app.infrastructure.database.sql_constants import (\n    SELECT_USUARIOS_PAGINATED, COUNT_USUARIOS_PAGINATED\n)\n\n# 📋 SCHEMAS\nfrom app.modules.users.presentation.schemas import UsuarioReadWithRoles, PaginatedUsuarioResponse\nfrom app.modules.rbac.presentation.schemas import RolRead\n\n# 🔐 SEGURIDAD\nfrom app.core.security.password import get_password_hash\n\n# 🚨 EXCEPCIONES - Nuevo sistema de manejo de errores",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\users\\application\\services\\user_service.py",
    "line": 110,
    "issue": "Query con text() toca tabla rol (verificar uso de cliente_id)",
    "severity": "medium",
    "tabla": "rol",
    "context": "            \n            tenant_context = try_get_tenant_context()\n            database_type = tenant_context.database_type if tenant_context else \"single\"\n            \n            # ✅ Para BD dedicadas, no filtrar por cliente_id (todos los roles pertenecen al mismo tenant)\n            if database_type == \"multi\":\n                query = \"\"\"\n                SELECT MAX(r.nivel_acceso) as max_level\n                FROM usuario_rol ur\n                INNER JOIN rol r ON ur.rol_id = r.rol_id\n       ",
    "type": "text() - tiene cliente_id"
  },
  {
    "file": "app\\modules\\users\\application\\services\\user_service.py",
    "line": 110,
    "issue": "Query con text() toca tabla usuario (verificar uso de cliente_id)",
    "severity": "medium",
    "tabla": "usuario",
    "context": "            \n            tenant_context = try_get_tenant_context()\n            database_type = tenant_context.database_type if tenant_context else \"single\"\n            \n            # ✅ Para BD dedicadas, no filtrar por cliente_id (todos los roles pertenecen al mismo tenant)\n            if database_type == \"multi\":\n                query = \"\"\"\n                SELECT MAX(r.nivel_acceso) as max_level\n                FROM usuario_rol ur\n                INNER JOIN rol r ON ur.rol_id = r.rol_id\n       ",
    "type": "text() - tiene cliente_id"
  },
  {
    "file": "app\\modules\\users\\application\\services\\user_service.py",
    "line": 110,
    "issue": "Query con text() toca tabla usuario_rol (verificar uso de cliente_id)",
    "severity": "medium",
    "tabla": "usuario_rol",
    "context": "            \n            tenant_context = try_get_tenant_context()\n            database_type = tenant_context.database_type if tenant_context else \"single\"\n            \n            # ✅ Para BD dedicadas, no filtrar por cliente_id (todos los roles pertenecen al mismo tenant)\n            if database_type == \"multi\":\n                query = \"\"\"\n                SELECT MAX(r.nivel_acceso) as max_level\n                FROM usuario_rol ur\n                INNER JOIN rol r ON ur.rol_id = r.rol_id\n       ",
    "type": "text() - tiene cliente_id"
  },
  {
    "file": "app\\modules\\users\\application\\services\\user_service.py",
    "line": 177,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "            query = \"\"\"\n            SELECT COUNT(*) as is_super_admin\n            FROM usuario_rol ur\n            INNER JOIN rol r ON ur.rol_id = r.rol_id\n            WHERE ur.usuario_id = ? \n              AND ur.es_activo = 1\n              AND r.es_activo = 1\n              AND r.codigo_rol = 'SUPER_ADMIN'\n              AND r.nivel_acceso = 5\n            \"\"\"\n            # ✅ FASE 2: Usar await\n            result = await execute_auth_query(query, (usuario_id,))",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\users\\application\\services\\user_service.py",
    "line": 177,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "            query = \"\"\"\n            SELECT COUNT(*) as is_super_admin\n            FROM usuario_rol ur\n            INNER JOIN rol r ON ur.rol_id = r.rol_id\n            WHERE ur.usuario_id = ? \n              AND ur.es_activo = 1\n              AND r.es_activo = 1\n              AND r.codigo_rol = 'SUPER_ADMIN'\n              AND r.nivel_acceso = 5\n            \"\"\"\n            # ✅ FASE 2: Usar await\n            result = await execute_auth_query(query, (usuario_id,))",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\users\\application\\services\\user_service.py",
    "line": 177,
    "issue": "Query SQL directa toca tabla usuario_rol sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario_rol",
    "context": "            query = \"\"\"\n            SELECT COUNT(*) as is_super_admin\n            FROM usuario_rol ur\n            INNER JOIN rol r ON ur.rol_id = r.rol_id\n            WHERE ur.usuario_id = ? \n              AND ur.es_activo = 1\n              AND r.es_activo = 1\n              AND r.codigo_rol = 'SUPER_ADMIN'\n              AND r.nivel_acceso = 5\n            \"\"\"\n            # ✅ FASE 2: Usar await\n            result = await execute_auth_query(query, (usuario_id,))",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\users\\application\\services\\user_service.py",
    "line": 298,
    "issue": "Query con text() toca tabla rol (verificar uso de cliente_id)",
    "severity": "medium",
    "tabla": "rol",
    "context": "            \n            tenant_context = try_get_tenant_context()\n            database_type = tenant_context.database_type if tenant_context else \"single\"\n            \n            # 🔍 CONSULTA UNIFICADA PARA USUARIO Y SUS ROLES\n            # ✅ Para BD dedicadas, no filtrar por cliente_id en WHERE (todos los usuarios pertenecen al mismo cliente)\n            if database_type == \"multi\":\n                # BD dedicada: buscar solo por usuario_id\n                query = \"\"\"\n                SELECT \n ",
    "type": "text() - tiene cliente_id"
  },
  {
    "file": "app\\modules\\users\\application\\services\\user_service.py",
    "line": 298,
    "issue": "Query con text() toca tabla usuario (verificar uso de cliente_id)",
    "severity": "medium",
    "tabla": "usuario",
    "context": "            \n            tenant_context = try_get_tenant_context()\n            database_type = tenant_context.database_type if tenant_context else \"single\"\n            \n            # 🔍 CONSULTA UNIFICADA PARA USUARIO Y SUS ROLES\n            # ✅ Para BD dedicadas, no filtrar por cliente_id en WHERE (todos los usuarios pertenecen al mismo cliente)\n            if database_type == \"multi\":\n                # BD dedicada: buscar solo por usuario_id\n                query = \"\"\"\n                SELECT \n ",
    "type": "text() - tiene cliente_id"
  },
  {
    "file": "app\\modules\\users\\application\\services\\user_service.py",
    "line": 485,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "                # Valores por defecto en caso de error\n                usuario_completo.update({\n                    'access_level': 1,\n                    'is_super_admin': False,\n                    'user_type': 'user'\n                })\n            \n            logger.info(f\"Usuario completo obtenido exitosamente: ID {usuario_id} con {len(usuario_completo['roles'])} roles activos\")\n            return usuario_completo\n            \n        except DatabaseError as db_err:\n            logger.erro",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\users\\application\\services\\user_service.py",
    "line": 485,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "                # Valores por defecto en caso de error\n                usuario_completo.update({\n                    'access_level': 1,\n                    'is_super_admin': False,\n                    'user_type': 'user'\n                })\n            \n            logger.info(f\"Usuario completo obtenido exitosamente: ID {usuario_id} con {len(usuario_completo['roles'])} roles activos\")\n            return usuario_completo\n            \n        except DatabaseError as db_err:\n            logger.erro",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\users\\application\\services\\user_service.py",
    "line": 850,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "            # 🛠️ CONSTRUIR ACTUALIZACIÓN DINÁMICA\n            update_parts = []\n            params_update = []\n            campos_permitidos = {\n                'nombre_usuario', 'correo', 'nombre', 'apellido', 'dni', 'telefono',\n                'proveedor_autenticacion', 'es_activo'\n            }\n\n            campos_actualizados = False\n            for field in campos_permitidos:\n                if field in usuario_data and usuario_data[field] is not None:\n                    update_parts.appen",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\users\\application\\services\\user_service.py",
    "line": 851,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "            update_parts = []\n            params_update = []\n            campos_permitidos = {\n                'nombre_usuario', 'correo', 'nombre', 'apellido', 'dni', 'telefono',\n                'proveedor_autenticacion', 'es_activo'\n            }\n\n            campos_actualizados = False\n            for field in campos_permitidos:\n                if field in usuario_data and usuario_data[field] is not None:\n                    update_parts.append(f\"{field} = ?\")\n                    params_updat",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\users\\application\\services\\user_service.py",
    "line": 860,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "                if field in usuario_data and usuario_data[field] is not None:\n                    update_parts.append(f\"{field} = ?\")\n                    params_update.append(usuario_data[field])\n                    campos_actualizados = True\n\n            if not campos_actualizados:\n                logger.info(f\"No hay campos válidos para actualizar para usuario ID {usuario_id}\")\n                raise ValidationError(\n                    detail=\"No hay campos válidos para actualizar\",\n          ",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\users\\application\\services\\user_service.py",
    "line": 861,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "                    update_parts.append(f\"{field} = ?\")\n                    params_update.append(usuario_data[field])\n                    campos_actualizados = True\n\n            if not campos_actualizados:\n                logger.info(f\"No hay campos válidos para actualizar para usuario ID {usuario_id}\")\n                raise ValidationError(\n                    detail=\"No hay campos válidos para actualizar\",\n                    internal_code=\"NO_UPDATE_DATA\"\n                )\n\n            update",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\users\\application\\services\\user_service.py",
    "line": 908,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "                detail=\"Error de base de datos al actualizar usuario\",\n                internal_code=\"USER_UPDATE_DB_ERROR\"\n            )\n        except Exception as e:\n            logger.exception(f\"Error inesperado al actualizar usuario {usuario_id}: {str(e)}\")\n            raise ServiceError(\n                status_code=500,\n                detail=\"Error interno al actualizar usuario\",\n                internal_code=\"USER_UPDATE_UNEXPECTED_ERROR\"\n            )\n\n    @staticmethod",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\users\\application\\services\\user_service.py",
    "line": 1081,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "                    get_assignment_query = \"\"\"\n                    SELECT usuario_rol_id, usuario_id, rol_id, fecha_asignacion, es_activo\n                    FROM dbo.usuario_rol WHERE usuario_rol_id = ?\n                    \"\"\"\n                    # ✅ FASE 2: Usar await\n                    final_result = await execute_query(get_assignment_query, (assignment['usuario_rol_id'],))\n                    if not final_result:\n                        raise ServiceError(\n                            status",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\users\\application\\services\\user_service.py",
    "line": 1081,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "                    get_assignment_query = \"\"\"\n                    SELECT usuario_rol_id, usuario_id, rol_id, fecha_asignacion, es_activo\n                    FROM dbo.usuario_rol WHERE usuario_rol_id = ?\n                    \"\"\"\n                    # ✅ FASE 2: Usar await\n                    final_result = await execute_query(get_assignment_query, (assignment['usuario_rol_id'],))\n                    if not final_result:\n                        raise ServiceError(\n                            status",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\users\\application\\services\\user_service.py",
    "line": 1081,
    "issue": "Query SQL directa toca tabla usuario_rol sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario_rol",
    "context": "                    get_assignment_query = \"\"\"\n                    SELECT usuario_rol_id, usuario_id, rol_id, fecha_asignacion, es_activo\n                    FROM dbo.usuario_rol WHERE usuario_rol_id = ?\n                    \"\"\"\n                    # ✅ FASE 2: Usar await\n                    final_result = await execute_query(get_assignment_query, (assignment['usuario_rol_id'],))\n                    if not final_result:\n                        raise ServiceError(\n                            status",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\users\\application\\services\\user_service.py",
    "line": 1096,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "                    logger.info(f\"Reactivando asignación existente para usuario {usuario_id}, rol {rol_id}\")\n                    update_query = \"\"\"\n                    UPDATE dbo.usuario_rol\n                    SET es_activo = 1, fecha_asignacion = GETDATE()\n                    OUTPUT INSERTED.usuario_rol_id, INSERTED.usuario_id, INSERTED.rol_id,\n                           INSERTED.fecha_asignacion, INSERTED.es_activo\n                    WHERE usuario_rol_id = ?\n                    \"\"\"\n         ",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\users\\application\\services\\user_service.py",
    "line": 1096,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "                    logger.info(f\"Reactivando asignación existente para usuario {usuario_id}, rol {rol_id}\")\n                    update_query = \"\"\"\n                    UPDATE dbo.usuario_rol\n                    SET es_activo = 1, fecha_asignacion = GETDATE()\n                    OUTPUT INSERTED.usuario_rol_id, INSERTED.usuario_id, INSERTED.rol_id,\n                           INSERTED.fecha_asignacion, INSERTED.es_activo\n                    WHERE usuario_rol_id = ?\n                    \"\"\"\n         ",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\users\\application\\services\\user_service.py",
    "line": 1096,
    "issue": "Query SQL directa toca tabla usuario_rol sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario_rol",
    "context": "                    logger.info(f\"Reactivando asignación existente para usuario {usuario_id}, rol {rol_id}\")\n                    update_query = \"\"\"\n                    UPDATE dbo.usuario_rol\n                    SET es_activo = 1, fecha_asignacion = GETDATE()\n                    OUTPUT INSERTED.usuario_rol_id, INSERTED.usuario_id, INSERTED.rol_id,\n                           INSERTED.fecha_asignacion, INSERTED.es_activo\n                    WHERE usuario_rol_id = ?\n                    \"\"\"\n         ",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\users\\application\\services\\user_service.py",
    "line": 1097,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "                    update_query = \"\"\"\n                    UPDATE dbo.usuario_rol\n                    SET es_activo = 1, fecha_asignacion = GETDATE()\n                    OUTPUT INSERTED.usuario_rol_id, INSERTED.usuario_id, INSERTED.rol_id,\n                           INSERTED.fecha_asignacion, INSERTED.es_activo\n                    WHERE usuario_rol_id = ?\n                    \"\"\"\n                    result = execute_update(update_query, (assignment['usuario_rol_id'],))\n                    if not ",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\users\\application\\services\\user_service.py",
    "line": 1097,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "                    update_query = \"\"\"\n                    UPDATE dbo.usuario_rol\n                    SET es_activo = 1, fecha_asignacion = GETDATE()\n                    OUTPUT INSERTED.usuario_rol_id, INSERTED.usuario_id, INSERTED.rol_id,\n                           INSERTED.fecha_asignacion, INSERTED.es_activo\n                    WHERE usuario_rol_id = ?\n                    \"\"\"\n                    result = execute_update(update_query, (assignment['usuario_rol_id'],))\n                    if not ",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\users\\application\\services\\user_service.py",
    "line": 1097,
    "issue": "Query SQL directa toca tabla usuario_rol sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario_rol",
    "context": "                    update_query = \"\"\"\n                    UPDATE dbo.usuario_rol\n                    SET es_activo = 1, fecha_asignacion = GETDATE()\n                    OUTPUT INSERTED.usuario_rol_id, INSERTED.usuario_id, INSERTED.rol_id,\n                           INSERTED.fecha_asignacion, INSERTED.es_activo\n                    WHERE usuario_rol_id = ?\n                    \"\"\"\n                    result = execute_update(update_query, (assignment['usuario_rol_id'],))\n                    if not ",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\users\\application\\services\\user_service.py",
    "line": 1099,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "                    SET es_activo = 1, fecha_asignacion = GETDATE()\n                    OUTPUT INSERTED.usuario_rol_id, INSERTED.usuario_id, INSERTED.rol_id,\n                           INSERTED.fecha_asignacion, INSERTED.es_activo\n                    WHERE usuario_rol_id = ?\n                    \"\"\"\n                    result = execute_update(update_query, (assignment['usuario_rol_id'],))\n                    if not result:\n                        raise ServiceError(\n                            st",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\users\\application\\services\\user_service.py",
    "line": 1099,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "                    SET es_activo = 1, fecha_asignacion = GETDATE()\n                    OUTPUT INSERTED.usuario_rol_id, INSERTED.usuario_id, INSERTED.rol_id,\n                           INSERTED.fecha_asignacion, INSERTED.es_activo\n                    WHERE usuario_rol_id = ?\n                    \"\"\"\n                    result = execute_update(update_query, (assignment['usuario_rol_id'],))\n                    if not result:\n                        raise ServiceError(\n                            st",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\users\\application\\services\\user_service.py",
    "line": 1099,
    "issue": "Query SQL directa toca tabla usuario_rol sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario_rol",
    "context": "                    SET es_activo = 1, fecha_asignacion = GETDATE()\n                    OUTPUT INSERTED.usuario_rol_id, INSERTED.usuario_id, INSERTED.rol_id,\n                           INSERTED.fecha_asignacion, INSERTED.es_activo\n                    WHERE usuario_rol_id = ?\n                    \"\"\"\n                    result = execute_update(update_query, (assignment['usuario_rol_id'],))\n                    if not result:\n                        raise ServiceError(\n                            st",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\users\\application\\services\\user_service.py",
    "line": 1100,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "                    OUTPUT INSERTED.usuario_rol_id, INSERTED.usuario_id, INSERTED.rol_id,\n                           INSERTED.fecha_asignacion, INSERTED.es_activo\n                    WHERE usuario_rol_id = ?\n                    \"\"\"\n                    result = execute_update(update_query, (assignment['usuario_rol_id'],))\n                    if not result:\n                        raise ServiceError(\n                            status_code=500,\n                            detail=\"Error reactivando",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\users\\application\\services\\user_service.py",
    "line": 1100,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "                    OUTPUT INSERTED.usuario_rol_id, INSERTED.usuario_id, INSERTED.rol_id,\n                           INSERTED.fecha_asignacion, INSERTED.es_activo\n                    WHERE usuario_rol_id = ?\n                    \"\"\"\n                    result = execute_update(update_query, (assignment['usuario_rol_id'],))\n                    if not result:\n                        raise ServiceError(\n                            status_code=500,\n                            detail=\"Error reactivando",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\users\\application\\services\\user_service.py",
    "line": 1100,
    "issue": "Query SQL directa toca tabla usuario_rol sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario_rol",
    "context": "                    OUTPUT INSERTED.usuario_rol_id, INSERTED.usuario_id, INSERTED.rol_id,\n                           INSERTED.fecha_asignacion, INSERTED.es_activo\n                    WHERE usuario_rol_id = ?\n                    \"\"\"\n                    result = execute_update(update_query, (assignment['usuario_rol_id'],))\n                    if not result:\n                        raise ServiceError(\n                            status_code=500,\n                            detail=\"Error reactivando",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\users\\application\\services\\user_service.py",
    "line": 1103,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "                    \"\"\"\n                    result = execute_update(update_query, (assignment['usuario_rol_id'],))\n                    if not result:\n                        raise ServiceError(\n                            status_code=500,\n                            detail=\"Error reactivando la asignación de rol\",\n                            internal_code=\"ROLE_REACTIVATION_ERROR\"\n                        )\n                    logger.info(f\"Asignación reactivada exitosamente\")\n                   ",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\users\\application\\services\\user_service.py",
    "line": 1103,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "                    \"\"\"\n                    result = execute_update(update_query, (assignment['usuario_rol_id'],))\n                    if not result:\n                        raise ServiceError(\n                            status_code=500,\n                            detail=\"Error reactivando la asignación de rol\",\n                            internal_code=\"ROLE_REACTIVATION_ERROR\"\n                        )\n                    logger.info(f\"Asignación reactivada exitosamente\")\n                   ",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\users\\application\\services\\user_service.py",
    "line": 1103,
    "issue": "Query SQL directa toca tabla usuario_rol sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario_rol",
    "context": "                    \"\"\"\n                    result = execute_update(update_query, (assignment['usuario_rol_id'],))\n                    if not result:\n                        raise ServiceError(\n                            status_code=500,\n                            detail=\"Error reactivando la asignación de rol\",\n                            internal_code=\"ROLE_REACTIVATION_ERROR\"\n                        )\n                    logger.info(f\"Asignación reactivada exitosamente\")\n                   ",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\users\\application\\services\\user_service.py",
    "line": 1195,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "                get_assignment_query = \"\"\"\n                SELECT usuario_rol_id, usuario_id, rol_id, fecha_asignacion, es_activo\n                FROM dbo.usuario_rol WHERE usuario_rol_id = ?\n                \"\"\"\n                final_result = execute_query(get_assignment_query, (assignment['usuario_rol_id'],))\n                return final_result[0] if final_result else {\"message\": \"Asignación ya inactiva\"}\n\n            # 🗑️ DESACTIVAR LA ASIGNACIÓN\n            logger.info(f\"Desactivando asignaci",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\users\\application\\services\\user_service.py",
    "line": 1195,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "                get_assignment_query = \"\"\"\n                SELECT usuario_rol_id, usuario_id, rol_id, fecha_asignacion, es_activo\n                FROM dbo.usuario_rol WHERE usuario_rol_id = ?\n                \"\"\"\n                final_result = execute_query(get_assignment_query, (assignment['usuario_rol_id'],))\n                return final_result[0] if final_result else {\"message\": \"Asignación ya inactiva\"}\n\n            # 🗑️ DESACTIVAR LA ASIGNACIÓN\n            logger.info(f\"Desactivando asignaci",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\users\\application\\services\\user_service.py",
    "line": 1195,
    "issue": "Query SQL directa toca tabla usuario_rol sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario_rol",
    "context": "                get_assignment_query = \"\"\"\n                SELECT usuario_rol_id, usuario_id, rol_id, fecha_asignacion, es_activo\n                FROM dbo.usuario_rol WHERE usuario_rol_id = ?\n                \"\"\"\n                final_result = execute_query(get_assignment_query, (assignment['usuario_rol_id'],))\n                return final_result[0] if final_result else {\"message\": \"Asignación ya inactiva\"}\n\n            # 🗑️ DESACTIVAR LA ASIGNACIÓN\n            logger.info(f\"Desactivando asignaci",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\users\\application\\services\\user_service.py",
    "line": 1203,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "            logger.info(f\"Desactivando asignación para usuario {usuario_id}, rol {rol_id}\")\n            update_query = \"\"\"\n            UPDATE dbo.usuario_rol\n            SET es_activo = 0\n            OUTPUT INSERTED.usuario_rol_id, INSERTED.usuario_id, INSERTED.rol_id,\n                   INSERTED.fecha_asignacion, INSERTED.es_activo\n            WHERE usuario_rol_id = ? AND es_activo = 1\n            \"\"\"\n            \n            result = execute_update(update_query, (assignment['usuario_rol_id'],)",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\users\\application\\services\\user_service.py",
    "line": 1203,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "            logger.info(f\"Desactivando asignación para usuario {usuario_id}, rol {rol_id}\")\n            update_query = \"\"\"\n            UPDATE dbo.usuario_rol\n            SET es_activo = 0\n            OUTPUT INSERTED.usuario_rol_id, INSERTED.usuario_id, INSERTED.rol_id,\n                   INSERTED.fecha_asignacion, INSERTED.es_activo\n            WHERE usuario_rol_id = ? AND es_activo = 1\n            \"\"\"\n            \n            result = execute_update(update_query, (assignment['usuario_rol_id'],)",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\users\\application\\services\\user_service.py",
    "line": 1203,
    "issue": "Query SQL directa toca tabla usuario_rol sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario_rol",
    "context": "            logger.info(f\"Desactivando asignación para usuario {usuario_id}, rol {rol_id}\")\n            update_query = \"\"\"\n            UPDATE dbo.usuario_rol\n            SET es_activo = 0\n            OUTPUT INSERTED.usuario_rol_id, INSERTED.usuario_id, INSERTED.rol_id,\n                   INSERTED.fecha_asignacion, INSERTED.es_activo\n            WHERE usuario_rol_id = ? AND es_activo = 1\n            \"\"\"\n            \n            result = execute_update(update_query, (assignment['usuario_rol_id'],)",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\users\\application\\services\\user_service.py",
    "line": 1204,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "            update_query = \"\"\"\n            UPDATE dbo.usuario_rol\n            SET es_activo = 0\n            OUTPUT INSERTED.usuario_rol_id, INSERTED.usuario_id, INSERTED.rol_id,\n                   INSERTED.fecha_asignacion, INSERTED.es_activo\n            WHERE usuario_rol_id = ? AND es_activo = 1\n            \"\"\"\n            \n            result = execute_update(update_query, (assignment['usuario_rol_id'],))\n\n            if not result:\n                logger.warning(f\"No se pudo desactivar la asig",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\users\\application\\services\\user_service.py",
    "line": 1204,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "            update_query = \"\"\"\n            UPDATE dbo.usuario_rol\n            SET es_activo = 0\n            OUTPUT INSERTED.usuario_rol_id, INSERTED.usuario_id, INSERTED.rol_id,\n                   INSERTED.fecha_asignacion, INSERTED.es_activo\n            WHERE usuario_rol_id = ? AND es_activo = 1\n            \"\"\"\n            \n            result = execute_update(update_query, (assignment['usuario_rol_id'],))\n\n            if not result:\n                logger.warning(f\"No se pudo desactivar la asig",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\users\\application\\services\\user_service.py",
    "line": 1204,
    "issue": "Query SQL directa toca tabla usuario_rol sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario_rol",
    "context": "            update_query = \"\"\"\n            UPDATE dbo.usuario_rol\n            SET es_activo = 0\n            OUTPUT INSERTED.usuario_rol_id, INSERTED.usuario_id, INSERTED.rol_id,\n                   INSERTED.fecha_asignacion, INSERTED.es_activo\n            WHERE usuario_rol_id = ? AND es_activo = 1\n            \"\"\"\n            \n            result = execute_update(update_query, (assignment['usuario_rol_id'],))\n\n            if not result:\n                logger.warning(f\"No se pudo desactivar la asig",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\users\\application\\services\\user_service.py",
    "line": 1206,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "            SET es_activo = 0\n            OUTPUT INSERTED.usuario_rol_id, INSERTED.usuario_id, INSERTED.rol_id,\n                   INSERTED.fecha_asignacion, INSERTED.es_activo\n            WHERE usuario_rol_id = ? AND es_activo = 1\n            \"\"\"\n            \n            result = execute_update(update_query, (assignment['usuario_rol_id'],))\n\n            if not result:\n                logger.warning(f\"No se pudo desactivar la asignación ID {assignment['usuario_rol_id']}\")\n                get_ass",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\users\\application\\services\\user_service.py",
    "line": 1206,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "            SET es_activo = 0\n            OUTPUT INSERTED.usuario_rol_id, INSERTED.usuario_id, INSERTED.rol_id,\n                   INSERTED.fecha_asignacion, INSERTED.es_activo\n            WHERE usuario_rol_id = ? AND es_activo = 1\n            \"\"\"\n            \n            result = execute_update(update_query, (assignment['usuario_rol_id'],))\n\n            if not result:\n                logger.warning(f\"No se pudo desactivar la asignación ID {assignment['usuario_rol_id']}\")\n                get_ass",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\users\\application\\services\\user_service.py",
    "line": 1206,
    "issue": "Query SQL directa toca tabla usuario_rol sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario_rol",
    "context": "            SET es_activo = 0\n            OUTPUT INSERTED.usuario_rol_id, INSERTED.usuario_id, INSERTED.rol_id,\n                   INSERTED.fecha_asignacion, INSERTED.es_activo\n            WHERE usuario_rol_id = ? AND es_activo = 1\n            \"\"\"\n            \n            result = execute_update(update_query, (assignment['usuario_rol_id'],))\n\n            if not result:\n                logger.warning(f\"No se pudo desactivar la asignación ID {assignment['usuario_rol_id']}\")\n                get_ass",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\users\\application\\services\\user_service.py",
    "line": 1207,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "            OUTPUT INSERTED.usuario_rol_id, INSERTED.usuario_id, INSERTED.rol_id,\n                   INSERTED.fecha_asignacion, INSERTED.es_activo\n            WHERE usuario_rol_id = ? AND es_activo = 1\n            \"\"\"\n            \n            result = execute_update(update_query, (assignment['usuario_rol_id'],))\n\n            if not result:\n                logger.warning(f\"No se pudo desactivar la asignación ID {assignment['usuario_rol_id']}\")\n                get_assignment_query = \"\"\"\n          ",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\users\\application\\services\\user_service.py",
    "line": 1207,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "            OUTPUT INSERTED.usuario_rol_id, INSERTED.usuario_id, INSERTED.rol_id,\n                   INSERTED.fecha_asignacion, INSERTED.es_activo\n            WHERE usuario_rol_id = ? AND es_activo = 1\n            \"\"\"\n            \n            result = execute_update(update_query, (assignment['usuario_rol_id'],))\n\n            if not result:\n                logger.warning(f\"No se pudo desactivar la asignación ID {assignment['usuario_rol_id']}\")\n                get_assignment_query = \"\"\"\n          ",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\users\\application\\services\\user_service.py",
    "line": 1207,
    "issue": "Query SQL directa toca tabla usuario_rol sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario_rol",
    "context": "            OUTPUT INSERTED.usuario_rol_id, INSERTED.usuario_id, INSERTED.rol_id,\n                   INSERTED.fecha_asignacion, INSERTED.es_activo\n            WHERE usuario_rol_id = ? AND es_activo = 1\n            \"\"\"\n            \n            result = execute_update(update_query, (assignment['usuario_rol_id'],))\n\n            if not result:\n                logger.warning(f\"No se pudo desactivar la asignación ID {assignment['usuario_rol_id']}\")\n                get_assignment_query = \"\"\"\n          ",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\users\\application\\services\\user_service.py",
    "line": 1211,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "            \n            result = execute_update(update_query, (assignment['usuario_rol_id'],))\n\n            if not result:\n                logger.warning(f\"No se pudo desactivar la asignación ID {assignment['usuario_rol_id']}\")\n                get_assignment_query = \"\"\"\n                SELECT usuario_rol_id, usuario_id, rol_id, fecha_asignacion, es_activo\n                FROM dbo.usuario_rol WHERE usuario_rol_id = ?\n                \"\"\"\n                final_result = execute_query(get_assignment",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\users\\application\\services\\user_service.py",
    "line": 1211,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "            \n            result = execute_update(update_query, (assignment['usuario_rol_id'],))\n\n            if not result:\n                logger.warning(f\"No se pudo desactivar la asignación ID {assignment['usuario_rol_id']}\")\n                get_assignment_query = \"\"\"\n                SELECT usuario_rol_id, usuario_id, rol_id, fecha_asignacion, es_activo\n                FROM dbo.usuario_rol WHERE usuario_rol_id = ?\n                \"\"\"\n                final_result = execute_query(get_assignment",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\users\\application\\services\\user_service.py",
    "line": 1211,
    "issue": "Query SQL directa toca tabla usuario_rol sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario_rol",
    "context": "            \n            result = execute_update(update_query, (assignment['usuario_rol_id'],))\n\n            if not result:\n                logger.warning(f\"No se pudo desactivar la asignación ID {assignment['usuario_rol_id']}\")\n                get_assignment_query = \"\"\"\n                SELECT usuario_rol_id, usuario_id, rol_id, fecha_asignacion, es_activo\n                FROM dbo.usuario_rol WHERE usuario_rol_id = ?\n                \"\"\"\n                final_result = execute_query(get_assignment",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\users\\application\\services\\user_service.py",
    "line": 1216,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "                get_assignment_query = \"\"\"\n                SELECT usuario_rol_id, usuario_id, rol_id, fecha_asignacion, es_activo\n                FROM dbo.usuario_rol WHERE usuario_rol_id = ?\n                \"\"\"\n                final_result = execute_query(get_assignment_query, (assignment['usuario_rol_id'],))\n                return final_result[0] if final_result else {\"message\": \"No se pudo desactivar la asignación\"}\n\n            logger.info(f\"Asignación desactivada exitosamente\")\n            ",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\users\\application\\services\\user_service.py",
    "line": 1216,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "                get_assignment_query = \"\"\"\n                SELECT usuario_rol_id, usuario_id, rol_id, fecha_asignacion, es_activo\n                FROM dbo.usuario_rol WHERE usuario_rol_id = ?\n                \"\"\"\n                final_result = execute_query(get_assignment_query, (assignment['usuario_rol_id'],))\n                return final_result[0] if final_result else {\"message\": \"No se pudo desactivar la asignación\"}\n\n            logger.info(f\"Asignación desactivada exitosamente\")\n            ",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\users\\application\\services\\user_service.py",
    "line": 1216,
    "issue": "Query SQL directa toca tabla usuario_rol sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario_rol",
    "context": "                get_assignment_query = \"\"\"\n                SELECT usuario_rol_id, usuario_id, rol_id, fecha_asignacion, es_activo\n                FROM dbo.usuario_rol WHERE usuario_rol_id = ?\n                \"\"\"\n                final_result = execute_query(get_assignment_query, (assignment['usuario_rol_id'],))\n                return final_result[0] if final_result else {\"message\": \"No se pudo desactivar la asignación\"}\n\n            logger.info(f\"Asignación desactivada exitosamente\")\n            ",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\users\\application\\services\\user_service.py",
    "line": 1342,
    "issue": "Query con text() toca tabla usuario (verificar uso de cliente_id)",
    "severity": "medium",
    "tabla": "usuario",
    "context": "        \n        tenant_context = try_get_tenant_context()\n        database_type = tenant_context.database_type if tenant_context else \"single\"\n\n        try:\n            # 📊 CONTAR TOTAL DE USUARIOS\n            # ✅ Para BD dedicadas, no filtrar por cliente_id\n            if database_type == \"multi\":\n                # ✅ FASE 4B: Usar constante desde sql_constants con parámetros nombrados\n                from app.infrastructure.database.sql_constants import COUNT_USUARIOS_PAGINATED_MULTI_DB\n      ",
    "type": "text() - tiene cliente_id"
  },
  {
    "file": "app\\modules\\users\\application\\services\\user_service.py",
    "line": 1352,
    "issue": "Query con text() toca tabla usuario (verificar uso de cliente_id)",
    "severity": "medium",
    "tabla": "usuario",
    "context": "                from sqlalchemy import text\n                COUNT_QUERY = text(COUNT_USUARIOS_PAGINATED_MULTI_DB).bindparams(\n                    buscar=search_param,\n                    buscar_pattern=f\"%{search_param}%\" if search_param else None\n                )\n                logger.debug(f\"[USUARIOS-PAGINADOS] BD dedicada: Contando usuarios sin filtrar por cliente_id\")\n            else:\n                # ✅ FASE 4B: Usar parámetros nombrados con text().bindparams()\n                from sqla",
    "type": "text() - tiene cliente_id"
  },
  {
    "file": "app\\modules\\users\\application\\services\\user_service.py",
    "line": 1358,
    "issue": "Query con text() toca tabla usuario (verificar uso de cliente_id)",
    "severity": "medium",
    "tabla": "usuario",
    "context": "            else:\n                # ✅ FASE 4B: Usar parámetros nombrados con text().bindparams()\n                from sqlalchemy import text\n                COUNT_QUERY = text(COUNT_USUARIOS_PAGINATED).bindparams(\n                    cliente_id=cliente_id,\n                    buscar=search_param,\n                    buscar_pattern=f\"%{search_param}%\" if search_param else None\n                )\n                logger.debug(f\"[USUARIOS-PAGINADOS] BD compartida: Contando usuarios con cliente_id {cl",
    "type": "text() - tiene cliente_id"
  },
  {
    "file": "app\\modules\\users\\application\\services\\user_service.py",
    "line": 1360,
    "issue": "Query con text() toca tabla usuario (verificar uso de cliente_id)",
    "severity": "medium",
    "tabla": "usuario",
    "context": "                from sqlalchemy import text\n                COUNT_QUERY = text(COUNT_USUARIOS_PAGINATED).bindparams(\n                    cliente_id=cliente_id,\n                    buscar=search_param,\n                    buscar_pattern=f\"%{search_param}%\" if search_param else None\n                )\n                logger.debug(f\"[USUARIOS-PAGINADOS] BD compartida: Contando usuarios con cliente_id {cliente_id}\")\n            \n            # ✅ FASE 4B: Usar await con query con parámetros nombrados\n ",
    "type": "text() - tiene cliente_id"
  },
  {
    "file": "app\\modules\\users\\application\\services\\user_service.py",
    "line": 1399,
    "issue": "Query con text() toca tabla usuario (verificar uso de cliente_id)",
    "severity": "medium",
    "tabla": "usuario",
    "context": "                from sqlalchemy import text\n                SELECT_QUERY = text(SELECT_USUARIOS_PAGINATED_MULTI_DB).bindparams(\n                    buscar=search_param,\n                    buscar_pattern=f\"%{search_param}%\" if search_param else None,\n                    offset=offset,\n                    limit=limit\n                )\n                logger.debug(f\"[USUARIOS-PAGINADOS] BD dedicada: Obteniendo usuarios sin filtrar por cliente_id\")\n            else:\n                # ✅ FASE 4B: Usa",
    "type": "text() - tiene cliente_id"
  },
  {
    "file": "app\\modules\\users\\application\\services\\user_service.py",
    "line": 1407,
    "issue": "Query con text() toca tabla rol (verificar uso de cliente_id)",
    "severity": "medium",
    "tabla": "rol",
    "context": "            else:\n                # ✅ FASE 4B: Usar parámetros nombrados con text().bindparams()\n                from sqlalchemy import text\n                SELECT_QUERY = text(SELECT_USUARIOS_PAGINATED).bindparams(\n                    cliente_id=cliente_id,\n                    buscar=search_param,\n                    buscar_pattern=f\"%{search_param}%\" if search_param else None,\n                    offset=offset,\n                    limit=limit\n                )\n                logger.debug(f\"[U",
    "type": "text() - tiene cliente_id"
  },
  {
    "file": "app\\modules\\users\\application\\services\\user_service.py",
    "line": 1407,
    "issue": "Query con text() toca tabla usuario (verificar uso de cliente_id)",
    "severity": "medium",
    "tabla": "usuario",
    "context": "            else:\n                # ✅ FASE 4B: Usar parámetros nombrados con text().bindparams()\n                from sqlalchemy import text\n                SELECT_QUERY = text(SELECT_USUARIOS_PAGINATED).bindparams(\n                    cliente_id=cliente_id,\n                    buscar=search_param,\n                    buscar_pattern=f\"%{search_param}%\" if search_param else None,\n                    offset=offset,\n                    limit=limit\n                )\n                logger.debug(f\"[U",
    "type": "text() - tiene cliente_id"
  },
  {
    "file": "app\\modules\\users\\application\\services\\user_service.py",
    "line": 1409,
    "issue": "Query con text() toca tabla rol (verificar uso de cliente_id)",
    "severity": "medium",
    "tabla": "rol",
    "context": "                from sqlalchemy import text\n                SELECT_QUERY = text(SELECT_USUARIOS_PAGINATED).bindparams(\n                    cliente_id=cliente_id,\n                    buscar=search_param,\n                    buscar_pattern=f\"%{search_param}%\" if search_param else None,\n                    offset=offset,\n                    limit=limit\n                )\n                logger.debug(f\"[USUARIOS-PAGINADOS] BD compartida: Obteniendo usuarios con cliente_id {cliente_id}\")\n            \n",
    "type": "text() - tiene cliente_id"
  },
  {
    "file": "app\\modules\\users\\application\\services\\user_service.py",
    "line": 1409,
    "issue": "Query con text() toca tabla usuario (verificar uso de cliente_id)",
    "severity": "medium",
    "tabla": "usuario",
    "context": "                from sqlalchemy import text\n                SELECT_QUERY = text(SELECT_USUARIOS_PAGINATED).bindparams(\n                    cliente_id=cliente_id,\n                    buscar=search_param,\n                    buscar_pattern=f\"%{search_param}%\" if search_param else None,\n                    offset=offset,\n                    limit=limit\n                )\n                logger.debug(f\"[USUARIOS-PAGINADOS] BD compartida: Obteniendo usuarios con cliente_id {cliente_id}\")\n            \n",
    "type": "text() - tiene cliente_id"
  },
  {
    "file": "app\\modules\\users\\infrastructure\\repositories\\user_repository.py",
    "line": 102,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "        query_roles = \"\"\"\n            SELECT \n                r.rol_id,\n                r.codigo_rol,\n                r.nombre as nombre_rol,\n                r.descripcion as descripcion_rol,\n                r.nivel_acceso,\n                r.es_activo as rol_activo,\n                ur.fecha_asignacion,\n                ur.es_activo as asignacion_activa\n            FROM rol r\n            INNER JOIN usuario_rol ur ON r.rol_id = ur.rol_id",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\users\\infrastructure\\repositories\\user_repository.py",
    "line": 102,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "        query_roles = \"\"\"\n            SELECT \n                r.rol_id,\n                r.codigo_rol,\n                r.nombre as nombre_rol,\n                r.descripcion as descripcion_rol,\n                r.nivel_acceso,\n                r.es_activo as rol_activo,\n                ur.fecha_asignacion,\n                ur.es_activo as asignacion_activa\n            FROM rol r\n            INNER JOIN usuario_rol ur ON r.rol_id = ur.rol_id",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\users\\infrastructure\\repositories\\user_repository.py",
    "line": 102,
    "issue": "Query SQL directa toca tabla usuario_rol sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario_rol",
    "context": "        query_roles = \"\"\"\n            SELECT \n                r.rol_id,\n                r.codigo_rol,\n                r.nombre as nombre_rol,\n                r.descripcion as descripcion_rol,\n                r.nivel_acceso,\n                r.es_activo as rol_activo,\n                ur.fecha_asignacion,\n                ur.es_activo as asignacion_activa\n            FROM rol r\n            INNER JOIN usuario_rol ur ON r.rol_id = ur.rol_id",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\users\\infrastructure\\repositories\\user_repository.py",
    "line": 125,
    "issue": "Query con text() toca tabla rol (verificar uso de cliente_id)",
    "severity": "medium",
    "tabla": "rol",
    "context": "            roles = await execute_query(\n                text(query_roles).bindparams(**bind_params_roles),\n                connection_type=self.connection_type,\n                client_id=client_id\n            )\n            \n            # Obtener permisos de cada rol\n            for rol in roles:\n                query_permisos = \"\"\"\n                    SELECT \n                        p.permiso_id,\n                        p.codigo_permiso,\n                        p.nombre as nombre_permiso,\n     ",
    "type": "text() - tiene cliente_id"
  },
  {
    "file": "app\\modules\\users\\infrastructure\\repositories\\user_repository.py",
    "line": 133,
    "issue": "Query SQL directa toca tabla rol sin cliente_id visible",
    "severity": "high",
    "tabla": "rol",
    "context": "                query_permisos = \"\"\"\n                    SELECT \n                        p.permiso_id,\n                        p.codigo_permiso,\n                        p.nombre as nombre_permiso,\n                        p.descripcion as descripcion_permiso,\n                        p.es_activo as permiso_activo\n                    FROM permiso p\n                    INNER JOIN rol_permiso rp ON p.permiso_id = rp.permiso_id\n                    WHERE rp.rol_id = :rol_id\n                    AND rp.e",
    "type": "sql_string"
  },
  {
    "file": "app\\modules\\users\\infrastructure\\repositories\\user_repository.py",
    "line": 146,
    "issue": "Query con text() toca tabla rol (verificar uso de cliente_id)",
    "severity": "medium",
    "tabla": "rol",
    "context": "                permisos = await execute_query(\n                    text(query_permisos).bindparams(rol_id=rol['rol_id']),\n                    connection_type=self.connection_type,\n                    client_id=client_id\n                )\n                rol['permisos'] = permisos\n            \n            usuario['roles'] = roles\n            return usuario\n        except Exception as e:\n            logger.error(f\"Error en find_with_roles_and_permissions: {str(e)}\")\n            usuario['roles'] =",
    "type": "text() - tiene cliente_id"
  },
  {
    "file": "app\\modules\\users\\infrastructure\\repositories\\user_repository.py",
    "line": 146,
    "issue": "Query con text() toca tabla usuario (verificar uso de cliente_id)",
    "severity": "medium",
    "tabla": "usuario",
    "context": "                permisos = await execute_query(\n                    text(query_permisos).bindparams(rol_id=rol['rol_id']),\n                    connection_type=self.connection_type,\n                    client_id=client_id\n                )\n                rol['permisos'] = permisos\n            \n            usuario['roles'] = roles\n            return usuario\n        except Exception as e:\n            logger.error(f\"Error en find_with_roles_and_permissions: {str(e)}\")\n            usuario['roles'] =",
    "type": "text() - tiene cliente_id"
  },
  {
    "file": "app\\modules\\users\\infrastructure\\repositories\\user_repository.py",
    "line": 183,
    "issue": "Query SQL directa toca tabla usuario sin cliente_id visible",
    "severity": "high",
    "tabla": "usuario",
    "context": "        query = f\"\"\"\n            SELECT * FROM {self.table_name}\n            WHERE es_eliminado = 0\n            AND (\n                nombre_usuario LIKE :search_pattern OR\n                correo LIKE :search_pattern OR\n                nombre LIKE :search_pattern OR\n                apellido LIKE :search_pattern\n            )\n            {tenant_filter}\n            ORDER BY nombre_usuario ASC\n        \"\"\"",
    "type": "sql_string"
  }
]